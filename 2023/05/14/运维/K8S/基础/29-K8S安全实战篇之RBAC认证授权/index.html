<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>29-K8S安全实战篇之RBAC认证授权 | 董勉 | 技术博客 | 成功的秘诀在于耐心和求胜心.</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
    <meta name="description" content="桑弧蓬矢">
  
  
  
    <link rel="alternate" href="/atom.xml" title="董勉 | 技术博客 | 成功的秘诀在于耐心和求胜心." type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
    
<link rel="stylesheet" href="/localshare/css/share.css">

  
  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">董勉 | 技术博客 | 成功的秘诀在于耐心和求胜心.</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">此生当克己勤免，自强不息 .</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/."><i class="fa fa-home"></i> 首页</a>
        
          <a class="main-nav-link" href="/archives/"><i class="fa fa-archive"></i> 归档</a>
        
          <a class="main-nav-link" href="/about/"><i class="fa fa-user"></i> 关于</a>
        
      </nav>
    </div>
    <div id="search-form">
      <div id="result-mask" class="hide"></div>
      <label><input id="search-key" type="text" autocomplete="off" placeholder="搜索"></label>
      <div id="result-wrap" class="hide">
        <div id="search-result"></div>
      </div>
      <div class="hide">
        <template id="search-tpl">
          <div class="item">
            <a href="/{path}" title="{title}">
              <div class="title">{title}</div>
              <div class="time">{date}</div>
              <div class="tags">{tags}</div>
            </a>
          </div>
        </template>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-运维/K8S/基础/29-K8S安全实战篇之RBAC认证授权" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      29-K8S安全实战篇之RBAC认证授权
    </h1>
  


      </header>
    
    <div class="article-meta">
      
      <span class="article-date">
  <i class="fa fa-date"></i>
  <time class="dt-published" datetime="2023-05-14T12:00:00.000Z" itemprop="datePublished">2023年05月14日</time>
</span>
      
  <div class="article-category">
    <i class="fa fa-classify"></i>
    <a class="article-category-link" href="/categories/%E8%BF%90%E7%BB%B4/">运维</a> > <a class="article-category-link" href="/categories/%E8%BF%90%E7%BB%B4/K8S/">K8S</a> > <a class="article-category-link" href="/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/">基础</a>
  </div>

      
        <span class="article-views">
  <i class="fa fa-views"></i>
  <i id="busuanzi_container_page_pv">
      <i id="busuanzi_value_page_pv"></i>
  </i>
</span>

      
      
<a href="/2023/05/14/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/29-K8S%E5%AE%89%E5%85%A8%E5%AE%9E%E6%88%98%E7%AF%87%E4%B9%8BRBAC%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83/#comments" class="article-comment-link">
  
    
    
    
    
    
  
<!--   <i class="fa fa-commt"></i> -->
<!--   留言 -->
</a>


    </div>
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="1-k8s安全管理：认证、授权、准入控制概述"><a href="#1-k8s安全管理：认证、授权、准入控制概述" class="headerlink" title="1 k8s安全管理：认证、授权、准入控制概述"></a>1 k8s安全管理：认证、授权、准入控制概述</h3><h4 id="1-1-认证"><a href="#1-1-认证" class="headerlink" title="1.1 认证"></a>1.1 认证</h4><p>认证基本介绍<br>kubernetes主要通过APIserver对外提供服务，那么就需要对访问apiserver的用户做认证，如果任何人都能访问apiserver，那么就可以随意在k8s集群部署资源，这是非常危险的，也容易被黑客攻击渗透，所以需要我们对访问k8s系统的apiserver的用户进行认证，确保是合法的符合要求的用户。</p>
<span id="more"></span>
<p>授权基本介绍：<br>认证通过后仅代表它是一个被apiserver信任的用户，能访问apiserver，但是用户是否拥有删除资源的权限， 需要进行授权操作，常见的授权方式有rbac授权。</p>
<p>准入控制基本介绍：<br>当用户经过认证和授权之后，最后一步就是准入控制了，k8s提供了多种准入控制机制，它有点类似”插件”，为apiserver提供了很好的”可扩展性”。请求apiserver时，通过认证、鉴权后、持久化(“api对象”保存到etcd)前，会经过”准入控制器”，让它可以做”变更和验证”。<br>为什么需要准入控制器呢？<br>如果我们创建pod时定义了资源上下限，但不满足LimitRange规则中定义的资源上下限，此时LimitRanger就会拒绝我们创建此pod</p>
<p>假如我们定义了一个名称空间叫做test-aa，这个名称空间做下资源限制：限制最多可以使用10vCPU、10Gi内存，在这个名称空间test-aa下创建的所有pod，定义limit的时候，所有pod的limit值不能超过test-aa这个名称空间设置的limit上线。</p>
<p>k8s客户端访问apiserver的几种认证方式<br>1）客户端认证：<br>客户端认证也称为双向TLS认证， kubectl在访问apiserver的时候，apiserver也要认证kubectl是否是合法的，他们都会通过ca根证书来进行验证，如下图：<br><img src="/../../../../images/k8s/jc29/img.png" alt="img.png"><br>2）Bearertoken<br>Bearertoken的方式，可以理解为apiserver将一个密码通过了非对称加密的方式告诉了kubectl，然后通过该密码进行相互访问，如下图：<br><img src="/../../../../images/k8s/jc29/img_1.png" alt="img_1.png"><br>Kubectl访问k8s集群，要找一个kubeconfig文件，基于kubeconfig文件里的用户访问apiserver<br>3）Serviceaccount<br>上面客户端证书认证和Bearertoken的两种认证方式，都是外部访问apiserver的时候使用的方式，那么我们这次说的Serviceaccount是内部访问pod和apiserver交互时候采用的一种方式。Serviceaccount包括了，namespace、token、ca，且通过目录挂载的方式给予pod，当pod运行起来的时候，就会读取到这些信息，从而使用该方式和apiserver进行通信。如下图：<br><img src="/../../../../images/k8s/jc29/img_2.png" alt="img_2.png"></p>
<p>kubeconfig文件<br>官方地址： <a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/configuration/organize-cluster-access-kubeconfig/">https://kubernetes.io/zh-cn/docs/concepts/configuration/organize-cluster-access-kubeconfig/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 ~]# vim /root/.kube/config</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 ~]# kubectl config view</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: DATA+OMITTED</span><br><span class="line">    server: https://192.168.1.12:6443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: kubernetes-admin</span><br><span class="line">  name: kubernetes-admin@kubernetes</span><br><span class="line">current-context: kubernetes-admin@kubernetes</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: kubernetes-admin</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: DATA+OMITTED</span><br><span class="line">    client-key-data: DATA+OMITTED</span><br></pre></td></tr></table></figure>
<p>在K8S集群当中，当我们使用kubectl操作k8s资源时候，需要确定我们用哪个用户访问哪个k8s集群，kubectl操作k8s集群资源会去&#x2F;root&#x2F;.kube目录下找config文件，可以通过kubectl config查看config文件配置，如下：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">kubectl config view</span><br><span class="line"></span><br><span class="line">显示如下：</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: DATA+OMITTED</span><br><span class="line">    server: https://192.168.40.180:6443     #apiserver的地址</span><br><span class="line">  name: kubernetes                         #集群的名字</span><br><span class="line">contexts:  # 上下文，环境</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes                     </span><br><span class="line">    user: kubernetes-admin   </span><br><span class="line">  name: kubernetes-admin@kubernetes     #上下文的名字</span><br><span class="line">current-context: kubernetes-admin@kubernetes       #当前上下文的名字</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: kubernetes-admin</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: REDACTED   # 证书</span><br><span class="line">    client-key-data: REDACTED   # 私钥</span><br></pre></td></tr></table></figure>
<p>在上面的配置文件当中，定义了集群、上下文以及用户。其中Config也是K8S的标准资源之一，在该配置文件当中定义了一个集群列表，指定的集群可以有多个；用户列表也可以有多个，指明集群中的用户；而在上下文列表当中，是进行定义可以使用哪个用户对哪个集群进行访问，以及当前使用的上下文是什么。</p>
<p>针对配置信息，kubectl 在 $HOME&#x2F;.kube 目录中查找一个名为 config 的配置文件。 你可以通过设置 KUBECONFIG 环境变量或设置 –kubeconfig 参数来指定其它 kubeconfig 文件。<br>kubectl get pods –kubeconfig&#x3D;&#x2F;root&#x2F;.kube&#x2F;config</p>
<h4 id="1-2-授权"><a href="#1-2-授权" class="headerlink" title="1.2 授权"></a>1.2 授权</h4><p>用户通过认证之后，什么权限都没有，需要一些后续的授权操作，如对资源的增删该查等，kubernetes1.6之后开始有RBAC（基于角色的访问控制机制）授权检查机制。<br>Kubernetes的授权是基于插件形成的，其常用的授权插件有以下几种：<br>1）Node（节点认证）<br>2）ABAC(基于属性的访问控制)<br>3）RBAC（基于角色的访问控制）***<br>4）Webhook（基于http回调机制的访问控制）</p>
<p>什么是RBAC（基于角色的授权）？<br>让一个用户（Users）扮演一个角色（Role），角色拥有权限，从而让用户拥有这样的权限，随后在授权机制当中，只需要将权限授予某个角色，此时用户将获取对应角色的权限，从而实现角色的访问控制。如图：<br><img src="/../../../../images/k8s/jc29/img_3.png" alt="img_3.png"></p>
<p>在k8s的授权机制当中，采用RBAC的方式进行授权，其工作逻辑是，把对对象的操作权限定义到一个角色当中，再将用户绑定到该角色，从而使用户得到对应角色的权限。如果通过rolebinding绑定role，只能对rolebingding所在的名称空间的资源有权限，上图user1这个用户绑定到role1上，只对role1这个名称空间的资源有权限，对其他名称空间资源没有权限，属于名称空间级别的；</p>
<p>另外，k8s为此还有一种集群级别的授权机制，就是定义一个集群角色（ClusterRole），对集群内的所有资源都有可操作的权限，从而将User2通过ClusterRoleBinding到ClusterRole，从而使User2拥有集群的操作权限。</p>
<p>Role、RoleBinding、ClusterRole和ClusterRoleBinding的关系如下：<br>1、用户基于rolebinding绑定到role<br>限定在rolebinding所在的名称空间<br><img src="/../../../../images/k8s/jc29/img_4.png" alt="img_4.png"></p>
<p>2、用户基于rolebinding绑定到clusterrole<br><img src="/../../../../images/k8s/jc29/img_5.png" alt="img_5.png"><br>上面我们说了两个角色绑定：<br>（1）用户通过rolebinding绑定role<br>（2）用户通过rolebinding绑定clusterrole</p>
<p>rolebinding绑定clusterrole的好处：<br>假如有6个名称空间，每个名称空间的用户都需要对自己的名称空间有管理员权限，那么需要定义6个role和rolebinding，然后依次绑定，如果名称空间更多，我们需要定义更多的role，这个是很麻烦的，所以我们引入clusterrole，定义一个clusterrole，对clusterrole授予所有权限，然后用户通过rolebinding绑定到clusterrole，就会拥有自己名称空间的管理员权限了</p>
<p>注：RoleBinding仅仅对当前名称空间有对应的权限。</p>
<p>3、用户基于clusterrolebinding绑定到clusterrole<br><img src="/../../../../images/k8s/jc29/img_6.png" alt="img_6.png"><br>用户基于rbac授权有几种方案：<br>基于rolebinding绑定到role上<br>基于rolebinding绑定到clusterrole上<br>基于clusterrolebinding绑定到clusterrole上</p>
<h4 id="1-3-准入控制"><a href="#1-3-准入控制" class="headerlink" title="1.3 准入控制"></a>1.3 准入控制</h4><p>在k8s上准入控制器的模块有很多，其中比较常用的有LimitRanger、ResourceQuota、ServiceAccount、PodSecurityPolicy(k8s1.25废弃了)等等，对于前面三种准入控制器系统默认是启用的，我们只需要定义对应的规则即可；对于PodSecurityPolicy(k8s1.25废弃了)这种准入控制器，系统默认没有启用，如果我们要使用，就必需启用以后，对应规则才会正常生效；这里需要注意一点，对应psp准入控制器，一定要先写好对应的规则，把规则和权限绑定好以后，在启用对应的准入控制器，否则先启用准入控制器，没有对应的规则，默认情况它是拒绝操作，这可能导致现有的k8s系统跑的系统级pod无法正常工作；所以对于psp准入控制器要慎用，如果规则和权限做的足够精细，它会给我们的k8s系统安全带来大幅度的提升，反之，可能导致整个k8s系统不可用。</p>
<p>查看apiserver启用的准入控制器有哪些？</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/manifests/kube-apiserver.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubeadm.kubernetes.io/kube-apiserver.advertise-address.endpoint:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.12</span><span class="string">:6443</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">kube-apiserver</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">control-plane</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-apiserver</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kube-apiserver</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--advertise-address=192.168.1.12</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--allow-privileged=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--authorization-mode=Node,RBAC</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--client-ca-file=/etc/kubernetes/pki/ca.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--enable-admission-plugins=NodeRestriction</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--enable-bootstrap-token-auth=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--etcd-cafile=/etc/kubernetes/pki/etcd/ca.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--etcd-certfile=/etc/kubernetes/pki/apiserver-etcd-client.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--etcd-keyfile=/etc/kubernetes/pki/apiserver-etcd-client.key</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--etcd-servers=https://127.0.0.1:2379</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--kubelet-client-certificate=/etc/kubernetes/pki/apiserver-kubelet-client.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--kubelet-client-key=/etc/kubernetes/pki/apiserver-kubelet-client.key</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client.key</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--requestheader-allowed-names=front-proxy-client</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--requestheader-extra-headers-prefix=X-Remote-Extra-</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--requestheader-group-headers=X-Remote-Group</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--requestheader-username-headers=X-Remote-User</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--secure-port=6443</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--service-account-issuer=https://kubernetes.default.svc.cluster.local</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--service-account-key-file=/etc/kubernetes/pki/sa.pub</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--service-account-signing-key-file=/etc/kubernetes/pki/sa.key</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--service-cluster-ip-range=10.96.0.0/12</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--tls-cert-file=/etc/kubernetes/pki/apiserver.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--tls-private-key-file=/etc/kubernetes/pki/apiserver.key</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.27.0</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">8</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.12</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/livez</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">6443</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">15</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">kube-apiserver</span></span><br><span class="line">    <span class="attr">readinessProbe:</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.12</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/readyz</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">6443</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">15</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">    <span class="attr">startupProbe:</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">24</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.12</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/livez</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">6443</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">15</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/ssl/certs</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">ca-certs</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/pki</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">etc-pki</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">k8s-certs</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">priority:</span> <span class="number">2000001000</span></span><br><span class="line">  <span class="attr">priorityClassName:</span> <span class="string">system-node-critical</span></span><br><span class="line">  <span class="attr">securityContext:</span></span><br><span class="line">    <span class="attr">seccompProfile:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">RuntimeDefault</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/etc/ssl/certs</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">ca-certs</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/etc/pki</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">etc-pki</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">k8s-certs</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>提示：<br>apiserver启用准入控制插件需要使用–enable-admission-plugins选项来指定，该选项可以使用多个值，用逗号隔开表示启用指定的准入控制插件；这里配置文件中显式启用了NodeRestrication这个插件；默认没有写在这上面的内置准入控制器，它也是启用了的，比如LimitRanger、ResourceQuota、ServiceAccount等等；对于不同的k8s版本，内置的准入控制器和启用与否请查看相关版本的官方文档；对于那些没有启动的准入控制器，我们可以在上面选项中直接启用，分别用逗号隔开即可。</p>
<p>对应的官网地址： <a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/admission-controllers/">https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/admission-controllers/</a></p>
<h3 id="2-Useraccount和ServiceAccount介绍"><a href="#2-Useraccount和ServiceAccount介绍" class="headerlink" title="2 Useraccount和ServiceAccount介绍"></a>2 Useraccount和ServiceAccount介绍</h3><p>kubernetes中账户分为：UserAccounts（用户账户） 和 ServiceAccounts（服务账户） 两种：<br>UserAccount是给kubernetes集群外部用户使用的，如kubectl访问k8s集群要用useraccount用户， kubeadm安装的k8s，默认的useraccount用户是kubernetes-admin；</p>
<p>k8s客户端(一般用:kubectl) ——&gt;API Server</p>
<p>APIServer需要对客户端做认证，使用kubeadm安装的K8s，会在用户家目录下创建一个认证配置文件 .kube&#x2F;config 这里面保存了客户端访问API Server的密钥相关信息，这样当用kubectl访问k8s时，它就会自动读取该配置文件，向API Server发起认证，然后完成操作请求。</p>
<p>用户名称可以在kubeconfig中查看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 ~]# cd ~/.kube/</span><br><span class="line"></span><br><span class="line">[root@centos07-12 .kube]# ls</span><br><span class="line">cache  config</span><br><span class="line"></span><br><span class="line">[root@centos07-12 .kube]# cat config</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJek1USXdNekE0TVRZME5sb1hEVE16TVRFek1EQTRNVFkwTmxvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBT0tjClFValdBODhpbndzd1Y1bWRaMlVHZ3BwUklwN0lSb3VxWVZSVDdXbmtIdUlEWTllYXdNQW9IWjlIS0QwVVhneFoKOEhQVlBPQmkxTzRnMDNybkZaSDg2blF4cUgvbkpJcXBNNEtjeFJTR0xvTHhCMGVITVVMamhZVHZCektpQXVFZwpSNUlFYWw2YldXcnRCS2JpN2JLVHpzU3ZsTGR6NUVPSzB2Rk5yeTlWUUYxNkpETUF5SGtaZzU5SjRKeFQySGVoCjIwTTViamRGbEVsOUJrakQ5SkJQRlVqbHQyU0dlWDJqYTNpOVNseDAyUURCMTNsRWw5ZDIyUVFxVFlHRk8yQ3oKSE5TTEsxMk5qdHBCcysvUXRTZWxDZER0T0xhak5wNnJpZVExK1dNQldQSU9sOU5TNk9OcXhJNWE0U3lMWmtHMgpEU3hGYXI2NjJTNHZabDV4bjFFQ0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZIbW8zeDhsRkZXTkVmRUs4MCs0OVlOMlBRK2FNQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBSFp3NWNJU0NSb1NZc3RWcllRVAp4MnBoaldwYXRKWm96R2VzQ0JTNTNsYktKQW9DaThrcWxQMWpVNVZxaEZSMEVDRlBYcG5xc3FUcmFHS2oyaVIrCjhkRHIxZi9SQ01xKzA1SjZ6S1dRbkdzdXdBWUhndlZVYnI1eGhtR2llZWlsVm42WHFzUlRlSXkrMWZTbk90cFEKZVRkNkhiZDBFYzhQajYwRmp2K1kvbTd5ODVnNHoxZ2diRlkrWmV1YUowcFQzUjc5eEFhakVmSXlrTlFVeGpjcwpnNGdMM1FLRG8rS3lycXhvR2hUQVJ6OUJ4THdvZGtTTFJwSE1RbU5BdGFRaVkxemR2MXVPMThac2szQmpnYWNjCmJvdm5GdlZ2cG12L1lIYThrZlMzaUJ0b0xaYmNlTTUycVZnc3M2OE10U0Y0T2ltbk5zbGZqa2srdnp5M2xMZi8KNXBBPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span><br><span class="line">    server: https://192.168.1.12:6443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: kubernetes-admin</span><br><span class="line">  name: kubernetes-admin@kubernetes</span><br><span class="line">current-context: kubernetes-admin@kubernetes</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: kubernetes-admin   # 用户</span><br><span class="line">  user:</span><br></pre></td></tr></table></figure>
<p>ServiceAccount是Pod使用的账号，Pod容器的进程需要访问API Server时用的就是ServiceAccount账户；ServiceAccount仅局限它所在的namespace，每个namespace创建时都会自动创建一个default service account；创建Pod时，如果没有指定Service Account，Pod则会使用default Service Account。</p>
<h3 id="3-ServiceAccount使用案例介绍-创建sa，并绑定到pod"><a href="#3-ServiceAccount使用案例介绍-创建sa，并绑定到pod" class="headerlink" title="3 ServiceAccount使用案例介绍: 创建sa，并绑定到pod"></a>3 ServiceAccount使用案例介绍: 创建sa，并绑定到pod</h3><h4 id="3-1-创建sa"><a href="#3-1-创建sa" class="headerlink" title="3.1 创建sa"></a>3.1 创建sa</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 .kube]# kubectl create sa sa-test</span><br><span class="line">serviceaccount/sa-test created</span><br><span class="line"></span><br><span class="line">[root@centos07-12 .kube]# kubectl get sa</span><br><span class="line">NAME              SECRETS   AGE</span><br><span class="line">default           0         17d</span><br><span class="line">nfs-provisioner   0         6d2h</span><br><span class="line">sa-test           0         3s</span><br></pre></td></tr></table></figure>
<h4 id="3-2-创建pod"><a href="#3-2-创建pod" class="headerlink" title="3.2 创建pod"></a>3.2 创建pod</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat pod.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sa-test</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">sa</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">sa-test</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span>  <span class="string">sa-tomcat</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl apply -f pod.yaml</span><br><span class="line">pod/sa-test created</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl get pods</span><br><span class="line">NAME                               READY   STATUS      RESTARTS   AGE</span><br><span class="line">sa-test                            1/1     Running     0          8s</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl exec -it sa-test -- /bin/bash</span><br><span class="line">root@sa-test:/# cd /var/run/secrets/kubernetes.io/serviceaccount/</span><br><span class="line">root@sa-test:/var/run/secrets/kubernetes.io/serviceaccount# curl --cacert ./ca.crt  -H &quot;Authorization: Bearer $(cat ./token)&quot;  https://kubernetes/api/v1/namespaces/kube-system</span><br><span class="line">&#123;</span><br><span class="line">  &quot;kind&quot;: &quot;Status&quot;,</span><br><span class="line">  &quot;apiVersion&quot;: &quot;v1&quot;,</span><br><span class="line">  &quot;metadata&quot;: &#123;&#125;,</span><br><span class="line">  &quot;status&quot;: &quot;Failure&quot;,</span><br><span class="line">  &quot;message&quot;: &quot;namespaces \&quot;kube-system\&quot; is forbidden: User \&quot;system:serviceaccount:default:sa-test\&quot; cannot get resource \&quot;namespaces\&quot; in API group \&quot;\&quot; in the namespace \&quot;kube-system\&quot;&quot;,</span><br><span class="line">  &quot;reason&quot;: &quot;Forbidden&quot;,</span><br><span class="line">  &quot;details&quot;: &#123;</span><br><span class="line">    &quot;name&quot;: &quot;kube-system&quot;,</span><br><span class="line">    &quot;kind&quot;: &quot;namespaces&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;code&quot;: 403</span><br></pre></td></tr></table></figure>
<p>上面结果能看到sa能通过https方式成功认证API，但是没有权限访问k8s资源，所以code状态码是403，表示没有权限操作k8s资源</p>
<h4 id="3-3-对sa做授权"><a href="#3-3-对sa做授权" class="headerlink" title="3.3 对sa做授权"></a>3.3 对sa做授权</h4><blockquote>
<p>kubectl create clusterrolebinding sa-test-admin –clusterrole&#x3D;cluster-admin  –serviceaccount&#x3D;default:sa-test<br>绑定前</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl create clusterrolebinding sa-test-admin --clusterrole=cluster-admin  --serviceaccount=default:sa-test</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/sa-test-admin created</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl get clusterrolebinding |grep admin</span><br><span class="line">sa-test-admin                                          ClusterRole/cluster-admin                                                          2s</span><br></pre></td></tr></table></figure>
<h4 id="3-4-再次请求"><a href="#3-4-再次请求" class="headerlink" title="3.4 再次请求"></a>3.4 再次请求</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl exec -it sa-test -- /bin/bash</span><br><span class="line">root@sa-test:/# cd /var/run/secrets/kubernetes.io/serviceaccount/</span><br><span class="line">root@sa-test:/var/run/secrets/kubernetes.io/serviceaccount# curl --cacert ./ca.crt  -H &quot;Authorization: Bearer $(cat ./token)&quot;  https://kubernetes/api/v1/namespaces/kube-system</span><br><span class="line">&#123;</span><br><span class="line">  &quot;kind&quot;: &quot;Namespace&quot;,</span><br><span class="line">  &quot;apiVersion&quot;: &quot;v1&quot;,</span><br><span class="line">  &quot;metadata&quot;: &#123;</span><br><span class="line">    &quot;name&quot;: &quot;kube-system&quot;,</span><br><span class="line">    &quot;uid&quot;: &quot;5891aa5c-4e4e-42e3-b772-679c4bc85315&quot;,</span><br><span class="line">    &quot;resourceVersion&quot;: &quot;10&quot;,</span><br><span class="line">    &quot;creationTimestamp&quot;: &quot;2023-12-03T08:16:58Z&quot;,</span><br><span class="line">    &quot;labels&quot;: &#123;</span><br><span class="line">      &quot;kubernetes.io/metadata.name&quot;: &quot;kube-system&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;managedFields&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;manager&quot;: &quot;kube-apiserver&quot;,</span><br><span class="line">        &quot;operation&quot;: &quot;Update&quot;,</span><br><span class="line">        &quot;apiVersion&quot;: &quot;v1&quot;,</span><br><span class="line">        &quot;time&quot;: &quot;2023-12-03T08:16:58Z&quot;,</span><br><span class="line">        &quot;fieldsType&quot;: &quot;FieldsV1&quot;,</span><br><span class="line">        &quot;fieldsV1&quot;: &#123;</span><br><span class="line">          &quot;f:metadata&quot;: &#123;</span><br><span class="line">            &quot;f:labels&quot;: &#123;</span><br><span class="line">              &quot;.&quot;: &#123;&#125;,</span><br><span class="line">              &quot;f:kubernetes.io/metadata.name&quot;: &#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;spec&quot;: &#123;</span><br><span class="line">    &quot;finalizers&quot;: [</span><br><span class="line">      &quot;kubernetes&quot;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;status&quot;: &#123;</span><br><span class="line">    &quot;phase&quot;: &quot;Active&quot;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>通过上面可以看到，对sa做授权之后就有权限访问k8s资源了<br>cd &#x2F;var&#x2F;run&#x2F;secrets&#x2F;kubernetes.io&#x2F;serviceaccount<br>curl –cacert .&#x2F;ca.crt  -H “Authorization: Bearer $(cat .&#x2F;token)”  <a target="_blank" rel="noopener" href="https://kubernetes/api/v1/pod">https://kubernetes/api/v1/pod</a></p>
<h3 id="4-RBAC认证授权策略"><a href="#4-RBAC认证授权策略" class="headerlink" title="4 RBAC认证授权策略"></a>4 RBAC认证授权策略</h3><p>RBAC介绍<br>在Kubernetes中，所有资源对象都是通过API进行操作，他们保存在etcd里。而对etcd的操作我们需要通过访问 kube-apiserver 来实现，上面的Service Account其实就是APIServer的认证过程，而授权的机制是通过RBAC：基于角色的访问控制实现。</p>
<p>RBAC有四个资源对象，分别是Role、ClusterRole、RoleBinding、ClusterRoleBinding</p>
<h4 id="4-1-Role：角色"><a href="#4-1-Role：角色" class="headerlink" title="4.1  Role：角色"></a>4.1  Role：角色</h4><p>一组权限的集合，在一个命名空间中，可以用其来定义一个角色，只能对命名空间内的资源进行授权。如果是集群级别的资源，则需要使用ClusterRole。<br>例如：定义一个角色用来读取Pod的权限</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  namespace: rbac </span><br><span class="line">  name: pod-read</span><br><span class="line">rules:  # 指定什么样的规则和权限</span><br><span class="line">- apiGroups: [&quot;&quot;]</span><br><span class="line">  resources: [&quot;pods&quot;]   # 对pod类型</span><br><span class="line">  resourceNames: []   # 如果有多个pod时，想指定授权的pod，这里写pod的名字</span><br><span class="line">verbs: [&quot;get&quot;,&quot;watch&quot;,&quot;list&quot;]   # 权限</span><br><span class="line"></span><br><span class="line">rules中的参数说明：</span><br><span class="line">1、apiGroups：支持的API组列表，例如：&quot;apiVersion: apps/v1&quot;等</span><br><span class="line">2、resources：支持的资源对象列表，例如pods、deployments、jobs等</span><br><span class="line">3、resourceNames: 指定resource的名称</span><br><span class="line">4、verbs：对资源对象的操作方法列表。  https://kubernetes.io/zh-cn/docs/reference/kubernetes-api/authorization-resources/role-v1/</span><br></pre></td></tr></table></figure>
<h4 id="4-2-ClusterRole：集群角色"><a href="#4-2-ClusterRole：集群角色" class="headerlink" title="4.2 ClusterRole：集群角色"></a>4.2 ClusterRole：集群角色</h4><p>具有和角色一致的命名空间资源的管理能力，还可用于以下特殊元素的授权<br>1、集群范围的资源，例如Node<br>2、非资源型的路径，例如：&#x2F;healthz<br>3、包含全部命名空间的资源，例如Pods</p>
<p>例如：定义一个集群角色可让用户访问任意secrets</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: secrets-clusterrole</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;&quot;]</span><br><span class="line">  resources: [&quot;secrets&quot;]</span><br><span class="line">verbs: [&quot;get&quot;,&quot;watch&quot;,&quot;list&quot;]</span><br></pre></td></tr></table></figure>
<h4 id="4-3-RoleBinding：角色绑定、ClusterRolebinding：集群角色绑定"><a href="#4-3-RoleBinding：角色绑定、ClusterRolebinding：集群角色绑定" class="headerlink" title="4.3  RoleBinding：角色绑定、ClusterRolebinding：集群角色绑定"></a>4.3  RoleBinding：角色绑定、ClusterRolebinding：集群角色绑定</h4><p>角色绑定和集群角色绑定用于把一个角色绑定在一个目标上，可以是User，Group，Service Account，使用RoleBinding为某个命名空间授权，使用ClusterRoleBinding为集群范围内授权。<br>例如：将在rbac命名空间中把pod-read角色授予用户es</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-read-bind</span><br><span class="line">  namespace: rbac</span><br><span class="line">subjects:</span><br><span class="line">- kind: User</span><br><span class="line">  name: es</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">roleRef:</span><br><span class="line">- kind: Role</span><br><span class="line">  name: pod-read</span><br><span class="line">  apiGroup: rbac.authorizatioin.k8s.io</span><br></pre></td></tr></table></figure>
<p>RoleBinding也可以引用ClusterRole，对属于同一命名空间内的ClusterRole定义的资源主体进行授权，<br>例如：es能获取到集群中所有的资源信息</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: es-allresource</span><br><span class="line">  namespace: rbac</span><br><span class="line">subjects:</span><br><span class="line">- kind: User</span><br><span class="line">  name: es</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br></pre></td></tr></table></figure>
<h3 id="5-资源的引用方式"><a href="#5-资源的引用方式" class="headerlink" title="5 资源的引用方式"></a>5 资源的引用方式</h3><p>多数资源可以用其名称的字符串表示，也就是Endpoint中的URL相对路径，例如pod中的日志是GET &#x2F;api&#x2F;v1&#x2F;namaspaces&#x2F;{namespace}&#x2F;pods&#x2F;{podname}&#x2F;log<br>如果需要在一个RBAC对象中体现上下级资源，就需要使用“&#x2F;”分割资源和下级资源。<br>例如：若想授权让某个主体同时能够读取Pod和Pod log，则可以配置 resources为一个数组</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 .kube]# kubectl create  ns test</span><br><span class="line">namespace/test created</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 .kube]# kubectl get ns</span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   17d</span><br><span class="line">kube-node-lease   Active   17d</span><br><span class="line">kube-public       Active   17d</span><br><span class="line">kube-system       Active   17d</span><br><span class="line">test              Active   17m</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim role-test.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">logs-reader</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>,<span class="string">&quot;pods/log&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl apply -f role-test.yaml</span><br><span class="line">role.rbac.authorization.k8s.io/logs-reader created</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl get roles -n test</span><br><span class="line">NAME          CREATED AT</span><br><span class="line">logs-reader   2023-12-20T15:30:15Z</span><br></pre></td></tr></table></figure>
<p>创建sa账号：sa-test</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl create sa sa-test -n test</span><br><span class="line">serviceaccount/sa-test created</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl get sa</span><br><span class="line">NAME              SECRETS   AGE</span><br><span class="line">default           0         17d</span><br><span class="line">nfs-provisioner   0         6d3h</span><br><span class="line">sa-test           0         63m</span><br></pre></td></tr></table></figure>
<p>将账号sa-test绑定到logs-reader角色<br>创建一个rolebinding: 名称：sa-test-1 ，指定在test命名空间下，绑定test命名空间下的sa-test账号；说明test的命名空间下账号sa-test,只能查test命名空间下的pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl create rolebinding sa-test-1 -n test  --role=logs-reader --serviceaccount=test:sa-test</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/sa-test-1 created</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim pod-test.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sa-test-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">sa</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">sa-test</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span>  <span class="string">sa-tomcat</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl apply -f pod-test.yaml</span><br><span class="line">pod/sa-test-pod created</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl get pod -n test</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE</span><br><span class="line">sa-test-pod   1/1     Running   0          69s</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl exec -it sa-test-pod -n test -- /bin/bash</span><br><span class="line">root@sa-test-pod:/# cd /var/run/secrets/kubernetes.io/serviceaccount</span><br><span class="line">root@sa-test-pod:/var/run/secrets/kubernetes.io/serviceaccount# curl --cacert ./ca.crt  -H &quot;Authorization: Bearer $(cat ./token)&quot;  https://kubernetes.default/api/v1/namespaces/test/pods/sa-test-pod/logs</span><br><span class="line">&#123;</span><br><span class="line">  &quot;kind&quot;: &quot;Status&quot;,</span><br><span class="line">  &quot;apiVersion&quot;: &quot;v1&quot;,</span><br><span class="line">  &quot;metadata&quot;: &#123;&#125;,</span><br><span class="line">  &quot;status&quot;: &quot;Failure&quot;,</span><br><span class="line">  &quot;message&quot;: &quot;pods \&quot;sa-test-pod\&quot; is forbidden: User \&quot;system:serviceaccount:test:sa-test\&quot; cannot get resource \&quot;pods/logs\&quot; in API group \&quot;\&quot; in the namespace \&quot;test\&quot;&quot;,</span><br><span class="line">  &quot;reason&quot;: &quot;Forbidden&quot;,</span><br><span class="line">  &quot;details&quot;: &#123;</span><br><span class="line">    &quot;name&quot;: &quot;sa-test-pod&quot;,</span><br><span class="line">    &quot;kind&quot;: &quot;pods&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;code&quot;: 403</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解决上述报错需要做授权：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl create rolebinding sa-test-2 -n test  --role=logs-reader --user=system:serviceaccount:test:sa-test</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/sa-test-2 created</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl exec -it sa-test-pod -n test -- /bin/bash</span><br><span class="line">root@sa-test-pod:/# cd /var/run/secrets/kubernetes.io/serviceaccount</span><br><span class="line">root@sa-test-pod:/var/run/secrets/kubernetes.io/serviceaccount# curl --cacert ./ca.crt  -H &quot;Authorization: Bearer $(cat ./token)&quot;  https://kubernetes.default/api/v1/namespaces/test/pods/sa-test-pod/log</span><br><span class="line">/docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration</span><br><span class="line">/docker-entrypoint.sh: Looking for shell scripts in /docker-entrypoint.d/</span><br><span class="line">/docker-entrypoint.sh: Launching /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh</span><br><span class="line">10-listen-on-ipv6-by-default.sh: info: Getting the checksum of /etc/nginx/conf.d/default.conf</span><br><span class="line">10-listen-on-ipv6-by-default.sh: info: Enabled listen on IPv6 in /etc/nginx/conf.d/default.conf</span><br><span class="line">/docker-entrypoint.sh: Sourcing /docker-entrypoint.d/15-local-resolvers.envsh</span><br><span class="line">/docker-entrypoint.sh: Launching /docker-entrypoint.d/20-envsubst-on-templates.sh</span><br><span class="line">/docker-entrypoint.sh: Launching /docker-entrypoint.d/30-tune-worker-processes.sh</span><br><span class="line">/docker-entrypoint.sh: Configuration complete; ready for start up</span><br><span class="line">2023/12/20 15:32:55 [notice] 1#1: using the &quot;epoll&quot; event method</span><br><span class="line">2023/12/20 15:32:55 [notice] 1#1: nginx/1.25.3</span><br><span class="line">2023/12/20 15:32:55 [notice] 1#1: built by gcc 12.2.0 (Debian 12.2.0-14)</span><br><span class="line">2023/12/20 15:32:55 [notice] 1#1: OS: Linux 3.10.0-1160.102.1.el7.x86_64</span><br><span class="line">2023/12/20 15:32:55 [notice] 1#1: getrlimit(RLIMIT_NOFILE): 1048576:1048576</span><br><span class="line">2023/12/20 15:32:55 [notice] 1#1: start worker processes</span><br><span class="line">2023/12/20 15:32:55 [notice] 1#1: start worker process 28</span><br><span class="line">2023/12/20 15:32:55 [notice] 1#1: start worker process 29</span><br><span class="line">2023/12/20 15:32:55 [notice] 1#1: start worker process 30</span><br><span class="line">2023/12/20 15:32:55 [notice] 1#1: start worker process 31</span><br></pre></td></tr></table></figure>

<p>资源还可以通过名称（ResourceName）进行引用，在指定ResourceName后，使用get、delete、update、patch请求，就会被限制在这个资源实例范围内<br>例如，下面的声明让一个主体只能对名为my-configmap的Configmap进行get和update操作：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: rabc.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  namaspace: default</span><br><span class="line">  name: configmap-update</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;&quot;]</span><br><span class="line">  resources: [&quot;configmaps&quot;]</span><br><span class="line">  resourceNames: [&quot;my-configmap&quot;]</span><br><span class="line">  verbs: [&quot;get&quot;,&quot;update&quot;]</span><br></pre></td></tr></table></figure>
<p>查看role信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl get roles -n test</span><br><span class="line">NAME          CREATED AT</span><br><span class="line">logs-reader   2023-12-20T15:30:15Z</span><br><span class="line"></span><br><span class="line">[root@centos07-12 rbactest]# kubectl describe roles -n test logs-reader</span><br><span class="line">Name:         logs-reader</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line">PolicyRule:</span><br><span class="line">  Resources  Non-Resource URLs  Resource Names  Verbs</span><br><span class="line">  ---------  -----------------  --------------  -----</span><br><span class="line">  pods/log   []                 []              [get list watch]</span><br><span class="line">  pods       []                 []              [get list watch]</span><br></pre></td></tr></table></figure>
<p>查看rolebinding信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl get rolebindings -n test</span><br><span class="line">NAME        ROLE               AGE</span><br><span class="line">sa-test-1   Role/logs-reader   12h</span><br><span class="line">sa-test-2   Role/logs-reader   11h</span><br><span class="line"></span><br><span class="line">[root@centos07-12 rbactest]# kubectl describe rolebindings sa-test-1 -n test</span><br><span class="line">Name:         sa-test-1</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line">Role:</span><br><span class="line">  Kind:  Role</span><br><span class="line">  Name:  logs-reader</span><br><span class="line">Subjects:</span><br><span class="line">  Kind            Name     Namespace</span><br><span class="line">  ----            ----     ---------</span><br><span class="line">  ServiceAccount  sa-test  test</span><br></pre></td></tr></table></figure>
<h3 id="6-常见角色-role-授权的案例"><a href="#6-常见角色-role-授权的案例" class="headerlink" title="6 常见角色(role)授权的案例"></a>6 常见角色(role)授权的案例</h3><p>（1）允许读取核心API组的Pod资源</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;&quot;]   # 空着就是所有的组</span><br><span class="line">  resources: [&quot;pods&quot;]  # 所有的pod读取</span><br><span class="line">  verbs: [&quot;get&quot;,&quot;list&quot;,&quot;watch&quot;]</span><br></pre></td></tr></table></figure>
<p>（2）允许读写apps API组中的deployment资源</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;apps&quot;]  # 只能对apps组下的，deployment操作</span><br><span class="line">  resources: [&quot;deployments&quot;]</span><br><span class="line">  verbs: [&quot;get&quot;,&quot;list&quot;,&quot;watch&quot;,&quot;create&quot;,&quot;update&quot;,&quot;patch&quot;,&quot;delete&quot;]</span><br></pre></td></tr></table></figure>
<p>（3）允许读取Pod以及读写job信息</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;&quot;]</span><br><span class="line">  resources: [&quot;pods&quot;]</span><br><span class="line">  verbs: [&quot;get&quot;,&quot;list&quot;,&quot;watch&quot;]</span><br><span class="line">- apiGroups: [&quot;&quot;]</span><br><span class="line">  resources: [&quot;jobs&quot;]</span><br><span class="line">  verbs: [&quot;get&quot;,&quot;list&quot;,&quot;watch&quot;,&quot;create&quot;,&quot;update&quot;,&quot;patch&quot;,&quot;delete&quot;]</span><br></pre></td></tr></table></figure>
<p>（4）允许读取一个名为my-config的ConfigMap（必须绑定到一个RoleBinding来限制到一个Namespace下的ConfigMap）：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;&quot;]</span><br><span class="line">  resources: [&quot;configmaps&quot;]</span><br><span class="line">  resourceNames: [&quot;my-configmap&quot;]</span><br><span class="line">  verbs: [&quot;get&quot;]</span><br></pre></td></tr></table></figure>
<p>（5）读取核心组的Node资源（Node属于集群级的资源，所以必须存在于ClusterRole中，并使用ClusterRoleBinding进行绑定）：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;&quot;]</span><br><span class="line">  resources: [&quot;nodes&quot;]</span><br><span class="line">  verbs: [&quot;get&quot;,&quot;list&quot;,&quot;watch&quot;]</span><br></pre></td></tr></table></figure>
<p>（6）允许对非资源端点“&#x2F;healthz”及其所有子路径进行GET和POST操作（必须使用ClusterRole和ClusterRoleBinding）：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rules:</span><br><span class="line">- nonResourceURLs: [&quot;/healthz&quot;,&quot;/healthz/*&quot;]</span><br><span class="line">  verbs: [&quot;get&quot;,&quot;post&quot;]</span><br></pre></td></tr></table></figure>
<h3 id="7-常见的角色绑定示例"><a href="#7-常见的角色绑定示例" class="headerlink" title="7 常见的角色绑定示例"></a>7 常见的角色绑定示例</h3><p>（1）用户名alice	</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">subjects:</span><br><span class="line">- kind: User</span><br><span class="line">  name: alice</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br></pre></td></tr></table></figure>
<p>（2）组名alice	</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">subjects:</span><br><span class="line">- kind: Group</span><br><span class="line">  name: alice</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br></pre></td></tr></table></figure>
<p>（3）kube-system命名空间中默认Service Account	</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: default</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure>
<h3 id="8-对Service-Account的授权管理"><a href="#8-对Service-Account的授权管理" class="headerlink" title="8 对Service Account的授权管理"></a>8 对Service Account的授权管理</h3><p>Service Account也是一种账号，是给运行在Pod里的进程提供了必要的身份证明。需要在Pod定义中指明引用的Service Account，这样就可以对Pod的进行赋权操作。<br>例如：pod内可获取rbac命名空间的所有Pod资源，pod-reader-sc的Service Account是绑定了名为pod-read的Role</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl create ns rbac</span><br><span class="line">namespace/rbac created</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl create sa pod-reader-sc -n rbac</span><br><span class="line">serviceaccount/pod-reader-sc created</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl get sa -n rbac</span><br><span class="line">NAME            SECRETS   AGE</span><br><span class="line">default         0         17s</span><br><span class="line">pod-reader-sc   0         9s</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cat pod-rbac.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">rbac</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">pod-reader-sc</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl apply -f pod-rbac.yaml</span><br><span class="line">pod/nginx created</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl get pods  -n rbac</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx   1/1     Running   0          16s</span><br></pre></td></tr></table></figure>

<p>（1）my-namespace中的my-sa Service Account授予只读权限, clusterrole：view是系统自动的<br>kubectl create rolebinding my-sa-view –clusterrole&#x3D;view –serviceaccount&#x3D;my-namespace:my-sa –namespace&#x3D;my-namespace</p>
<p>（2）为一个命名空间中名为default的Service Account授权<br>如果一个应用没有指定 serviceAccountName，则会使用名为default的Service Account。注意，赋予Service Account “default”的权限会让所有没有指定serviceAccountName的Pod都具有这些权限</p>
<p>例如，在my-namespace命名空间中为Service Account“default”授予只读权限：<br>kubectl create rolebinding default-view –clusterrole&#x3D;view –serviceaccount&#x3D;my-namespace:default –namespace&#x3D;my-namespace</p>
<p>（3）为命名空间中所有Service Account都授予一个角色<br>如果希望在一个命名空间中，任何Service Account应用都具有一个角色，则可以为这一命名空间的Service Account群组进行授权</p>
<p>kubectl create rolebinding serviceaccounts-view –clusterrole&#x3D;view –group&#x3D;system:serviceaccounts:my-namespace –namespace&#x3D;my-namespace</p>
<p>（4）为集群范围内所有Service Account都授予一个低权限角色<br>如果不想为每个命名空间管理授权，则可以把一个集群级别的角色赋给所有Service Account。</p>
<p>kubectl create clusterrolebinding serviceaccounts-view –clusterrole&#x3D;view –group&#x3D;system:serviceaccounts</p>
<p>（5）为所有Service Account授予超级用户权限<br>kubectl create clusterrolebinding serviceaccounts-view –clusterrole&#x3D;cluster-admin –group&#x3D;system:serviceaccounts</p>
<h3 id="9-使用kubectl命令行工具创建资源对象"><a href="#9-使用kubectl命令行工具创建资源对象" class="headerlink" title="9 使用kubectl命令行工具创建资源对象"></a>9 使用kubectl命令行工具创建资源对象</h3><p>（1）在命名空间rbac中为用户es授权admin ClusterRole：<br>kubectl create rolebinding bob-admin-binding –clusterrole&#x3D;admin –user&#x3D;es –namespace&#x3D;rbac<br>　　<br>（2）在命名空间rbac中为名为myapp的Service Account授予view ClusterRole：<br>kubctl create rolebinding myapp-role-binding –clusterrole&#x3D;view –serviceaccount&#x3D;rbac:myapp –namespace&#x3D;rbac</p>
<p>　　<br>（3）在全集群范围内为用户root授予cluster-admin ClusterRole：<br>kubectl create clusterrolebinding cluster-binding –clusterrole&#x3D;cluster-admin –user&#x3D;root</p>
<p>　　<br>（4）在全集群范围内为名为myapp的Service Account授予view ClusterRole：<br>kubectl create clusterrolebinding service-account-binding –clusterrole&#x3D;view –serviceaccount&#x3D;myapp</p>
<p>yaml文件进行rbac授权：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/">https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/</a></p>
<h3 id="10-限制不同的用户操作k8s集群"><a href="#10-限制不同的用户操作k8s集群" class="headerlink" title="10 限制不同的用户操作k8s集群"></a>10 限制不同的用户操作k8s集群</h3><p>查看下k8s当前用户环境</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl config  current-context</span><br><span class="line">kubernetes-admin@kubernetes</span><br></pre></td></tr></table></figure>
<h4 id="10-1-ssl认证"><a href="#10-1-ssl认证" class="headerlink" title="10.1 ssl认证"></a>10.1 ssl认证</h4><p>生成一个证书<br>（1）生成一个私钥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 pki]# cd /etc/kubernetes/pki/</span><br><span class="line"></span><br><span class="line">[root@centos07-12 pki]# (umask 077; openssl genrsa -out dbbruce.key 2048)</span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">...+++</span><br><span class="line">...................+++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line"></span><br><span class="line">[root@centos07-12 pki]# ls |grep dbbruce</span><br><span class="line">dbbruce.key</span><br></pre></td></tr></table></figure>
<p>（2）生成一个证书请求</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 pki]# openssl req -new -key dbbruce.key -out dbbruce.csr -subj &quot;/CN=dbbruce&quot;</span><br><span class="line">[root@centos07-12 pki]# ls |grep dbbruce</span><br><span class="line">dbbruce.csr</span><br><span class="line">dbbruce.key</span><br></pre></td></tr></table></figure>
<p>（3）生成一个证书，表示dbbruce用户被apiserver信任了，可以访问apiserver，但是没有权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 pki]# openssl x509 -req -in dbbruce.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out dbbruce.crt -days 3650</span><br><span class="line">Signature ok</span><br><span class="line">subject=/CN=dbbruce</span><br><span class="line">Getting CA Private Key</span><br><span class="line"></span><br><span class="line">[root@centos07-12 pki]# ls |grep dbbruce</span><br><span class="line">dbbruce.crt</span><br><span class="line">dbbruce.csr</span><br><span class="line">dbbruce.key</span><br></pre></td></tr></table></figure>
<h4 id="10-2-在kubeconfig下新增加一个dbbruce这个用户"><a href="#10-2-在kubeconfig下新增加一个dbbruce这个用户" class="headerlink" title="10.2 在kubeconfig下新增加一个dbbruce这个用户"></a>10.2 在kubeconfig下新增加一个dbbruce这个用户</h4><p>（0）先备份下文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 pki]# cp /root/.kube/config /root/.kube/configbak</span><br><span class="line"></span><br><span class="line">[root@centos07-12 pki]# ll /root/.kube/</span><br><span class="line">总用量 24</span><br><span class="line">drwxr-x--- 4 root root   35 12月  3 16:28 cache</span><br><span class="line">-rw------- 1 root root 9172 12月 21 12:27 config</span><br><span class="line">-rw------- 1 root root 9172 12月 21 12:31 configbak</span><br></pre></td></tr></table></figure>
<p>（1）把dbbruce这个用户添加到kubernetes集群中，可以用来认证apiserver的连接<br>先查看下用户信息，只有一个kubernetes-admin</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 .kube]# kubectl config view</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: DATA+OMITTED</span><br><span class="line">    server: https://192.168.1.12:6443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: kubernetes-admin</span><br><span class="line">  name: kubernetes-admin@kubernetes</span><br><span class="line">current-context: kubernetes-admin@kubernetes</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">- name: kubernetes-admin   # 只有个用户</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: DATA+OMITTED</span><br><span class="line">    client-key-data: DATA+OMITTED</span><br></pre></td></tr></table></figure>
<p>新增用户dbbruce</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 pki]# kubectl config set-credentials dbbruce --client-certificate=./dbbruce.crt --client-key=./dbbruce.key --embed-certs=true</span><br><span class="line">User &quot;dbbruce&quot; set.</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 .kube]# kubectl config view</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: DATA+OMITTED</span><br><span class="line">    server: https://192.168.1.12:6443</span><br><span class="line">  name: kubernetes   # 集群名称下面会用到</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: kubernetes-admin</span><br><span class="line">  name: kubernetes-admin@kubernetes</span><br><span class="line">current-context: kubernetes-admin@kubernetes</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: dbbruce   # 新增用户dbbruce</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: DATA+OMITTED</span><br><span class="line">    client-key-data: DATA+OMITTED</span><br><span class="line">- name: kubernetes-admin</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: DATA+OMITTED  ###证书</span><br><span class="line">    client-key-data: DATA+OMITTED   ###key</span><br></pre></td></tr></table></figure>
<p>（2）在kubeconfig下新增加一个dbbruce这个账号</p>
<blockquote>
<p>kubectl config set-context dbbruce@kubernetes –cluster&#x3D;集群名称，（config view能看到 ）–user&#x3D;dbbruce</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 .kube]# kubectl config set-context dbbruce@kubernetes --cluster=kubernetes --user=dbbruce</span><br><span class="line">Context &quot;dbbruce@kubernetes&quot; created.</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 .kube]# kubectl config view</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: DATA+OMITTED</span><br><span class="line">    server: https://192.168.1.12:6443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">- context:                    # 多了个上下文，环境</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: dbbruce</span><br><span class="line">  name: dbbruce@kubernetes    # 多了</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: kubernetes-admin</span><br><span class="line">  name: kubernetes-admin@kubernetes</span><br><span class="line">current-context: kubernetes-admin@kubernetes</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: dbbruce</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: DATA+OMITTED</span><br><span class="line">    client-key-data: DATA+OMITTED</span><br><span class="line">- name: kubernetes-admin</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: DATA+OMITTED</span><br><span class="line">    client-key-data: DATA+OMITTED</span><br></pre></td></tr></table></figure>
<p>（3）切换账号到dbbruce，默认没有任何权限</p>
<blockquote>
<p>kubectl config view &gt;&gt;&gt;&gt;&gt; current-context: kubernetes-admin@kubernetes</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 .kube]# kubectl config use-context dbbruce@kubernetes</span><br><span class="line">Switched to context &quot;dbbruce@kubernetes&quot;.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos07-12 .kube]# kubectl config view</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: DATA+OMITTED</span><br><span class="line">    server: https://192.168.1.12:6443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: dbbruce</span><br><span class="line">  name: dbbruce@kubernetes</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: kubernetes-admin</span><br><span class="line">  name: kubernetes-admin@kubernetes</span><br><span class="line">current-context: dbbruce@kubernetes   ### 当前用户变为dbbruce</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: dbbruce</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: DATA+OMITTED</span><br><span class="line">    client-key-data: DATA+OMITTED</span><br><span class="line">- name: kubernetes-admin</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: DATA+OMITTED</span><br><span class="line">    client-key-data: DATA+OMITTED</span><br></pre></td></tr></table></figure>
<p>没有权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 .kube]# kubectl get pods</span><br><span class="line">Error from server (Forbidden): pods is forbidden: User &quot;dbbruce&quot; cannot list resource &quot;pods&quot; in API group &quot;&quot; in the namespace &quot;default&quot;</span><br></pre></td></tr></table></figure>
<p>（4）切换账号到admin</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 .kube]# kubectl config use-context kubernetes-admin@kubernetes</span><br><span class="line">Switched to context &quot;kubernetes-admin@kubernetes&quot;.</span><br><span class="line"></span><br><span class="line">[root@centos07-12 .kube]# kubectl get pods</span><br><span class="line">NAME                               READY   STATUS      RESTARTS   AGE</span><br><span class="line">mysql-pod                          0/1     Completed   0          23h</span><br><span class="line">mysql-pod-envfrom                  0/1     Completed   0          22h</span><br><span class="line">mysql-pod-volume                   0/1     Completed   0          22h</span><br><span class="line">nfs-provisioner-77467f5d6d-lmprs   1/1     Running     0          6d16h</span><br><span class="line">pod-secret                         1/1     Running     0          17h</span><br><span class="line">pod-secret-volume                  1/1     Running     0          17h</span><br><span class="line">sa-test                            1/1     Running     0          14h</span><br></pre></td></tr></table></figure>

<h4 id="10-3-把user这个用户通过rolebinding绑定到clusterrole上，授予权限-权限只是在dbbruce这个名称空间有效"><a href="#10-3-把user这个用户通过rolebinding绑定到clusterrole上，授予权限-权限只是在dbbruce这个名称空间有效" class="headerlink" title="10.3 把user这个用户通过rolebinding绑定到clusterrole上，授予权限,权限只是在dbbruce这个名称空间有效"></a>10.3 把user这个用户通过rolebinding绑定到clusterrole上，授予权限,权限只是在dbbruce这个名称空间有效</h4><p>（1）把dbbruce这个用户通过rolebinding绑定到clusterrole上，命名空间为test</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 .kube]# kubectl get ns</span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   17d</span><br><span class="line">kube-node-lease   Active   17d</span><br><span class="line">kube-public       Active   17d</span><br><span class="line">kube-system       Active   17d</span><br><span class="line">test              Active   13h</span><br><span class="line"></span><br><span class="line">[root@centos07-12 .kube]# kubectl get pods -n test</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE</span><br><span class="line">sa-test-pod   1/1     Running   0          13h</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 .kube]# kubectl create rolebinding dbbruce -n test --clusterrole=cluster-admin --user=dbbruce</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/dbbruce created</span><br></pre></td></tr></table></figure>
<p>（2）切换到dbbruce这个用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 .kube]# kubectl config use-context dbbruce@kubernetes</span><br><span class="line">Switched to context &quot;dbbruce@kubernetes&quot;.</span><br></pre></td></tr></table></figure>
<p>（3）测试是否有权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 .kube]# kubectl get pods -n test   ### test命名空间有权限</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE</span><br><span class="line">sa-test-pod   1/1     Running   0          13h</span><br><span class="line">[root@centos07-12 .kube]# kubectl get pods    ### default命名空间没有权限</span><br><span class="line">Error from server (Forbidden): pods is forbidden: User &quot;dbbruce&quot; cannot list resource &quot;pods&quot; in API group &quot;&quot; in the namespace &quot;default&quot;</span><br><span class="line">[root@centos07-12 .kube]# kubectl get pods -n test</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE</span><br><span class="line">sa-test-pod   1/1     Running   0          13h</span><br></pre></td></tr></table></figure>
<p>有权限操作test这个名称空间</p>
<h4 id="10-4-添加一个test的普通用户"><a href="#10-4-添加一个test的普通用户" class="headerlink" title="10.4 添加一个test的普通用户"></a>10.4 添加一个test的普通用户</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 .kube]# cp -ar /root/.kube/ /tmp/</span><br><span class="line"></span><br><span class="line">[root@centos07-12 .kube]# ll -al /tmp/</span><br><span class="line">总用量 0</span><br><span class="line">drwxrwxrwt.  8 root root 106 12月 21 12:50 .</span><br><span class="line">dr-xr-xr-x. 19 root root 268 12月 13 13:48 ..</span><br><span class="line">drwxrwxrwt.  2 root root   6 8月  14 14:59 .font-unix</span><br><span class="line">drwxrwxrwt.  2 root root   6 8月  14 14:59 .ICE-unix</span><br><span class="line">drwxr-xr-x   3 root root  50 12月 21 12:47 .kube</span><br><span class="line">drwxrwxrwt.  2 root root   6 8月  14 14:59 .Test-unix</span><br><span class="line">drwxrwxrwt.  2 root root   6 8月  14 14:59 .X11-unix</span><br><span class="line">drwxrwxrwt.  2 root root   6 8月  14 14:59 .XIM-unix</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 .kube]# useradd test</span><br></pre></td></tr></table></figure>
<p>修改&#x2F;tmp&#x2F;.kube&#x2F;config文件，把kubernetes-admin相关的删除，只留dbbruce用户</p>
<blockquote>
<p>注意千万不要修改&#x2F;root&#x2F;.kube&#x2F;config</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 pki]# vim /tmp/.kube/config</span><br></pre></td></tr></table></figure>
<p><img src="/../../../../images/k8s/jc29/img_8.png" alt="img_8.png"></p>
<p>修改后的k8s配置文件，给test用户使用，只允许操作test命名空间pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 test]# cp -ar /tmp/.kube/ /home/test/</span><br><span class="line"></span><br><span class="line">[root@centos07-12 test]# ls -al</span><br><span class="line">总用量 12</span><br><span class="line">drwx------  3 test test  75 12月 21 13:01 .</span><br><span class="line">drwxr-xr-x. 4 root root  30 12月 21 12:55 ..</span><br><span class="line">-rw-r--r--  1 test test  18 11月 25 2021 .bash_logout</span><br><span class="line">-rw-r--r--  1 test test 193 11月 25 2021 .bash_profile</span><br><span class="line">-rw-r--r--  1 test test 231 11月 25 2021 .bashrc</span><br><span class="line">drwxr-xr-x  3 root root  50 12月 21 12:59 .kube</span><br><span class="line"></span><br><span class="line">[root@centos07-12 test]# chown -R test.test /home/test/</span><br><span class="line"></span><br><span class="line">[root@centos07-12 test]# su - test  # 这间有个杠</span><br></pre></td></tr></table></figure>
<p>测试test用户权限，default命名空间无权限，test命名空间有权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[test@centos07-12 ~]$ kubectl get pods</span><br><span class="line">Error from server (Forbidden): pods is forbidden: User &quot;dbbruce&quot; cannot list resource &quot;pods&quot; in API group &quot;&quot; in the namespace &quot;default&quot;</span><br><span class="line"></span><br><span class="line">[test@centos07-12 ~]$ kubectl get pods -n test</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE</span><br><span class="line">sa-test-pod   1/1     Running   0          13h</span><br></pre></td></tr></table></figure>
<p>退出test用户，需要在把集群环境切换成管理员权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 ~]# kubectl config use-context kubernetes-admin@kubernetes</span><br><span class="line">Switched to context &quot;kubernetes-admin@kubernetes&quot;.</span><br><span class="line"></span><br><span class="line">[root@centos07-12 ~]# kubectl config view</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: DATA+OMITTED</span><br><span class="line">    server: https://192.168.1.12:6443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: dbbruce</span><br><span class="line">  name: dbbruce@kubernetes</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: kubernetes-admin</span><br><span class="line">  name: kubernetes-admin@kubernetes</span><br><span class="line">current-context: kubernetes-admin@kubernetes</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: dbbruce</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: DATA+OMITTED</span><br><span class="line">    client-key-data: DATA+OMITTED</span><br><span class="line">- name: kubernetes-admin</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: DATA+OMITTED</span><br><span class="line">    client-key-data: DATA+OMITTED</span><br></pre></td></tr></table></figure>
<h4 id="10-5-授权kubectl用户能查看所有名称空间的pod的权限"><a href="#10-5-授权kubectl用户能查看所有名称空间的pod的权限" class="headerlink" title="10.5 授权kubectl用户能查看所有名称空间的pod的权限"></a>10.5 授权kubectl用户能查看所有名称空间的pod的权限</h4><p>ssl认证<br>生成一个证书<br>（1）生成一个私钥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 ~]# cd /etc/kubernetes/pki/</span><br><span class="line"></span><br><span class="line">[root@centos07-12 pki]# (umask 077; openssl genrsa -out dbbruce1.key 2048)</span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">......................................................................................................+++</span><br><span class="line">..............................................................................+++</span><br><span class="line">e is 65537 (0x10001)</span><br></pre></td></tr></table></figure>
<p>（2）生成一个证书请求</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 pki]# openssl req -new -key dbbruce1.key -out dbbruce1.csr -subj &quot;/CN=dbbruce66&quot;</span><br></pre></td></tr></table></figure>
<p>（3）生成一个证书</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 pki]# openssl x509 -req -in dbbruce1.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out dbbruce1.crt -days 3650</span><br><span class="line">Signature ok</span><br><span class="line">subject=/CN=dbbruce66</span><br><span class="line">Getting CA Private Key</span><br></pre></td></tr></table></figure>
<p>在kubeconfig下新增加一个dbbruce66这个用户<br>（1）把dbbruce66这个用户添加到kubernetes集群中，可以用来认证apiserver的连接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 pki]# kubectl config set-credentials dbbruce66 --client-certificate=./dbbruce1.crt --client-key=./dbbruce1.key --embed-certs=true</span><br><span class="line">User &quot;dbbruce66&quot; set.</span><br></pre></td></tr></table></figure>
<p>（2）在kubeconfig下新增加一个dbbruce66这个账号</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 pki]# kubectl config set-context dbbruce66@kubernetes --cluster=kubernetes --user=dbbruce66</span><br><span class="line">Context &quot;dbbruce66@kubernetes&quot; created.</span><br></pre></td></tr></table></figure>
<p>(3)创建一个clusterrole</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim dbbruce66-clusterrole.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dbbruce66-get-pod</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@centos07-12</span> <span class="string">rbactest</span>]<span class="comment"># kubectl apply -f dbbruce66-clusterrole.yaml</span></span><br><span class="line"><span class="string">clusterrole.rbac.authorization.k8s.io/dbbruce66-get-pod</span> <span class="string">created</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl get clusterrole |grep dbbruce66</span><br><span class="line">dbbruce66-get-pod                                                      2023-12-21T05:19:26Z</span><br></pre></td></tr></table></figure>
<p>（4）创建一个clusterrolebinding，所有命名空间有读的权限，不加指定命名空间，就是全部命名空间</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl create clusterrolebinding dbbruce66-get-pods --clusterrole=dbbruce66-get-pod  --user=dbbruce66</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/dbbruce66-get-pods created</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl config view</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: DATA+OMITTED</span><br><span class="line">    server: https://192.168.1.12:6443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">- context:       #### 新增dbbruce66 的上下文</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: dbbruce66</span><br><span class="line">  name: dbbruce66@kubernetes</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: dbbruce</span><br><span class="line">  name: dbbruce@kubernetes</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: kubernetes-admin</span><br><span class="line">  name: kubernetes-admin@kubernetes</span><br><span class="line">current-context: kubernetes-admin@kubernetes</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: dbbruce</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: DATA+OMITTED</span><br><span class="line">    client-key-data: DATA+OMITTED</span><br><span class="line">- name: dbbruce66    #### 新增dbbruce66的用户</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: DATA+OMITTED</span><br><span class="line">    client-key-data: DATA+OMITTED</span><br><span class="line">- name: kubernetes-admin</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: DATA+OMITTED</span><br><span class="line">    client-key-data: DATA+OMITTED</span><br></pre></td></tr></table></figure>
<p>添加一个test66的普通用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# useradd test66</span><br><span class="line"></span><br><span class="line">[root@centos07-12 rbactest]# rm -rf /tmp/.kube</span><br><span class="line"></span><br><span class="line">[root@centos07-12 rbactest]# cp -ar /root/.kube /tmp/</span><br></pre></td></tr></table></figure>
<p>修改&#x2F;tmp&#x2F;.kube&#x2F;config文件，把kubernetes-admin和dbbruce相关的删除，只留dbbruce66用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# vim /tmp/.kube/config</span><br></pre></td></tr></table></figure>
<p><img src="/../../../../images/k8s/jc29/img_9.png" alt="img_9.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# cp -ar /tmp/.kube/ /home/test66/</span><br><span class="line"></span><br><span class="line">[root@centos07-12 rbactest]# chown -R test66.test66 /home/test66/</span><br><span class="line"></span><br><span class="line">[root@centos07-12 rbactest]# su  - test66</span><br><span class="line"></span><br><span class="line">[test66@centos07-12 ~]$ kubectl get pods</span><br><span class="line">NAME                               READY   STATUS      RESTARTS   AGE</span><br><span class="line">mysql-pod                          0/1     Completed   0          23h</span><br><span class="line">mysql-pod-envfrom                  0/1     Completed   0          23h</span><br><span class="line">mysql-pod-volume                   0/1     Completed   0          23h</span><br><span class="line">nfs-provisioner-77467f5d6d-lmprs   1/1     Running     0          6d17h</span><br><span class="line">pod-secret                         1/1     Running     0          18h</span><br><span class="line">pod-secret-volume                  1/1     Running     0          18h</span><br><span class="line">sa-test                            1/1     Running     0          14h</span><br><span class="line"></span><br><span class="line">[test66@centos07-12 ~]$ kubectl get pods  -n test</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE</span><br><span class="line">sa-test-pod   1/1     Running   0          14h</span><br></pre></td></tr></table></figure>
<p>无法删除，dbbruce66只有全部命名空间的读权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[test66@centos07-12 ~]$ kubectl delete pods sa-test</span><br><span class="line">Error from server (Forbidden): pods &quot;sa-test&quot; is forbidden: User &quot;dbbruce66&quot; cannot delete resource &quot;pods&quot; in API group &quot;&quot; in the namespace &quot;default&quot;</span><br><span class="line">[test66@centos07-12 ~]$</span><br></pre></td></tr></table></figure>
<h3 id="11-准入控制"><a href="#11-准入控制" class="headerlink" title="11 准入控制"></a>11 准入控制</h3><h4 id="11-1-ResourceQuota准入控制器"><a href="#11-1-ResourceQuota准入控制器" class="headerlink" title="11.1 ResourceQuota准入控制器"></a>11.1 ResourceQuota准入控制器</h4><p>ResourceQuota准入控制器是k8s上内置的准入控制器，默认该控制器是启用的状态，它主要作用是用来限制一个名称空间下的资源的使用，它能防止在一个名称空间下的pod被过多创建时，导致过多占用k8s资源，简单讲它是用来在名称空间级别限制用户的资源使用。</p>
<ul>
<li>1、限制cpu、内存、pod、deployment数量</li>
<li>1.1、创建resourcequota资源<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl create ns quota</span><br><span class="line">namespace/quota created</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat resourcequota-1.yaml </span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">quota-test</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">quota</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hard:</span></span><br><span class="line">    <span class="attr">pods:</span> <span class="string">&quot;6&quot;</span>    <span class="comment"># 最多创建6个pod</span></span><br><span class="line">    <span class="attr">requests.cpu:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">    <span class="attr">requests.memory:</span> <span class="string">2Gi</span></span><br><span class="line">    <span class="attr">limits.cpu:</span> <span class="string">&quot;4&quot;</span></span><br><span class="line">    <span class="attr">limits.memory:</span> <span class="string">10Gi</span></span><br><span class="line">    <span class="attr">count/deployments.apps:</span> <span class="string">&quot;6&quot;</span></span><br><span class="line">    <span class="attr">persistentvolumeclaims:</span> <span class="string">&quot;6&quot;</span></span><br></pre></td></tr></table></figure>
以上配置清单表示，在quota名称空间下运行的pod数量不能超过6个，所有pod的cpu资源下限总和不能大于2个核心，内存资源下限总和不能大于2G，cpu上限资源总和不能大于4个核心，内存上限总和不能超过10G，apps群组下的deployments控制器不能超过6个， pvc个数不能超过6个；以上条件中任意一个条目不满足，都将无法在对应名称空间创建对应的资源。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl apply -f resourcequota-1.yaml</span><br><span class="line">resourcequota/quota-test created</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl get resourcequota -n quota -owide</span><br><span class="line">NAME         AGE   REQUEST                                                                                                          LIMIT</span><br><span class="line">quota-test   66m   count/deployments.apps: 0/6, persistentvolumeclaims: 0/6, pods: 0/6, requests.cpu: 0/2, requests.memory: 0/2Gi   limits.cpu: 0/4, limits.memory: 0/10Gi</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl describe quota -n quota</span><br><span class="line">Name:                   quota-test</span><br><span class="line">Namespace:              quota</span><br><span class="line">Resource                Used  Hard</span><br><span class="line">--------                ----  ----</span><br><span class="line">count/deployments.apps  1     6   # deployments限制6个</span><br><span class="line">limits.cpu              0     4   # 4核cpu</span><br><span class="line">limits.memory           0     10Gi  # 内存10G</span><br><span class="line">persistentvolumeclaims  0     6     # pvc 6个</span><br><span class="line">pods                    0     6     # pods6个</span><br><span class="line">requests.cpu            0     2      # request cpu 2</span><br><span class="line">requests.memory         0     2Gi   # request memory 2G</span><br></pre></td></tr></table></figure>
<ul>
<li>1.2、创建pod进行测试<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># vim deploy-demo.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: quota</span><br><span class="line">  namespace: quota</span><br><span class="line">spec:</span><br><span class="line">  replicas: 7 # 创建7个，超出quota的限制6</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: quota</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: quota</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: myapp</span><br><span class="line">        image: docker.io/ikubernetes/myapp:v2</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 1</span><br><span class="line">            memory: 1Gi</span><br><span class="line">          limits:</span><br><span class="line">           cpu: 2</span><br><span class="line">           memory: 2Gi</span><br><span class="line">           </span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl apply -f deploy-demo.yaml</span><br><span class="line">deployment.apps/quota configured</span><br></pre></td></tr></table></figure>
这里为什么创建2个pods，因为quota现在最多2个requets，pod每个设置1个request，只能创建2个pod<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl get pods -n quota</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">quota-5b5dddd5bb-lnr4h   1/1     Running   0          16s</span><br><span class="line">quota-5b5dddd5bb-v72xl   1/1     Running   0          16s</span><br></pre></td></tr></table></figure>
<img src="/../../../../images/k8s/jc29/img_10.png" alt="img_10.png"></li>
<li>2、限制存储空间大小<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim resourcequota-2.yaml </span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">quota-storage-test</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">quota</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hard:</span></span><br><span class="line">    <span class="attr">requests.storage:</span> <span class="string">&quot;5Gi&quot;</span></span><br><span class="line">    <span class="attr">persistentvolumeclaims:</span> <span class="string">&quot;5&quot;</span></span><br><span class="line">    <span class="attr">requests.ephemeral-storage:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">    <span class="attr">limits.ephemeral-storage:</span> <span class="string">&quot;2Gi&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl apply -f resourcequota-2.yaml</span><br><span class="line">resourcequota/quota-storage-test created</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl get ResourceQuota -n quota</span><br><span class="line">NAME                 AGE    REQUEST                                                                                                            LIMIT</span><br><span class="line">quota-storage-test   4s     persistentvolumeclaims: 0/5, requests.ephemeral-storage: 0/1Gi, requests.storage: 0/5Gi                            limits.ephemeral-storage: 0/2Gi</span><br><span class="line">quota-test           6h2m   count/deployments.apps: 1/6, persistentvolumeclaims: 0/6, pods: 2/6, requests.cpu: 2/2, requests.memory: 2Gi/2Gi   limits.cpu: 4/4, limits.memory: 4Gi/10Gi</span><br></pre></td></tr></table></figure>
简写resourcequota &#x3D; quota<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl get quota -n quota</span><br><span class="line">NAME                 AGE    REQUEST                                                                                                            LIMIT</span><br><span class="line">quota-storage-test   6s     persistentvolumeclaims: 0/5, requests.ephemeral-storage: 0/1Gi, requests.storage: 0/5Gi                            limits.ephemeral-storage: 0/2Gi</span><br><span class="line">quota-test           6h2m   count/deployments.apps: 1/6, persistentvolumeclaims: 0/6, pods: 2/6, requests.cpu: 2/2, requests.memory: 2Gi/2Gi   limits.cpu: 4/4, limits.memory: 4Gi/10Gi</span><br><span class="line">[root@centos07-12 rbactest]#</span><br></pre></td></tr></table></figure>
<blockquote>
<p>备注：<br>requests.storage用来限制对应名称空间下的存储下限总和<br>persistenvolumeclaims用来限制pvc总数量<br>requests.ephemeral-storage用来现在使用本地临时存储的下限总容量<br>limits.ephemeral-storage用来限制使用本地临时存储上限总容量；<br>以上配置表示在default名称空间下非停止状态的容器存储下限总容量不能超过5G，pvc的数量不能超过5个，本地临时存储下限容量不能超过1G，上限不能超过2G。</p>
</blockquote>
</li>
</ul>
<h4 id="11-2-LimitRanger准入控制器"><a href="#11-2-LimitRanger准入控制器" class="headerlink" title="11.2 LimitRanger准入控制器"></a>11.2 LimitRanger准入控制器</h4><p>LimitRanger准入控制器是k8s上一个内置的准入控制器，LimitRange是k8s上的一个标准资源，它主要用来定义在某个名称空间下限制pod或pod里的容器对k8s上的cpu和内存资源使用；它能够定义我们在某个名称空间下创建pod时使用的cpu和内存的上限和下限以及默认cpu、内存的上下限。</p>
<p>如果我们创建pod时定义了资源上下限，但不满足LimitRange规则中定义的资源上下限，此时LimitRanger就会拒绝我们创建此pod；如果我们在LimitRange规则中定义了默认的资源上下限制，我们创建资源没有指定其资源限制，它默认会使用LimitRange规则中的默认资源限制；同样的逻辑LimitRanger可以限制一个pod使用资源的上下限，它还可以限制pod中的容器的资源上下限，比限制pod更加精准；不管是针对pod还是pod里的容器，它始终只是限制单个pod资源使用。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat limitrange.yaml </span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">limit</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">LimitRange</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cpu-memory</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">limit</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">default:</span>            <span class="comment"># 不指定pod的limits资源时，默认就是default的值，现在limits</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">1000m</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">1000Mi</span></span><br><span class="line">    <span class="attr">defaultRequest:</span>   <span class="comment"># 不指定pod的requests资源时, 默认使用 defaultRequest</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">500Mi</span></span><br><span class="line">    <span class="attr">min:</span>                 <span class="comment">#  pod定义了limits，最小值</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">500Mi</span></span><br><span class="line">    <span class="attr">max:</span>                <span class="comment">#  pod定义了limits，最大值</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">2000m</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">2000Mi</span></span><br><span class="line">    <span class="attr">maxLimitRequestRatio:</span>   <span class="comment"># 比例，创建pod时，cpu上限是下限的4倍， memory上限是下限的4倍</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="number">4</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="number">4</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Container</span></span><br></pre></td></tr></table></figure>
<p>备注：<br>以上清单主要定义了两个资源，一个创建limit名称空间，一个是在对应limit名称空间下定义了LimitRange资源；<br>其中LimitRange资源的名称为cpu-memory，default字段用来指定默认容器资源上限值；<br>defaultRequest用来指定默认容器资源下限值；<br>min字段用来指定限制用户指定的资源下限不能小于对应资源的值；<br>max是用来限制用户指定资源上限值不能大于该值；<br>maxLimitRequestRatio字段用来指定资源的上限和下限的比值；即上限是下限的多少倍；<br>type是用来描述对应资源限制的级别，该字段有两个值pod和container。<br>上述资源清单表示在该名称空间下创建pod时，默认不指定其容器的资源限制，就限制对应容器最少要有0.5个核心的cpu和500M的内存；最大为1个核心cpu,1g内存；如果我们手动定义了容器的资源限制，那么对应资源限制最小不能小于cpu为0.5个核心，内存为500M，最大不能超过cpu为2个核心，内存为2000M；<br>如果我们在创建pod时，只指定了容器的资源上限或下限，那么上限最大是下限的的4倍，如果指定cpu上限为2000m那么下限一定不会小于500m，如果只指定了cpu下限为500m那么上限最大不会超过2000m，对于内存也是同样的逻辑。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl apply -f limitrange.yaml</span><br><span class="line">namespace/limit created</span><br><span class="line">limitrange/cpu-memory created</span><br></pre></td></tr></table></figure>
<ul>
<li><p>1 在limit名称空间创建pod，不指定资源，看看是否会被limitrange规则自动附加其资源限制？</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim limitpods-demo.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-pod-demo</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">limit</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span>  </span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.io/library/nginx:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl apply -f limitpods-demo.yaml</span><br><span class="line">pod/nginx-pod-demo created</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl get pods -n limit</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-pod-demo   1/1     Running   0          2m20s</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl describe pods nginx-pod-demo -n limit</span><br><span class="line">Name:             nginx-pod-demo</span><br><span class="line">Namespace:        limit</span><br><span class="line">Priority:         0</span><br><span class="line">Service Account:  default</span><br><span class="line">Node:             centos07-62/192.168.1.62</span><br><span class="line">Start Time:       Thu, 21 Dec 2023 20:01:06 +0800</span><br><span class="line">Labels:           &lt;none&gt;</span><br><span class="line">Annotations:      cni.projectcalico.org/podIP: 10.244.250.231/32</span><br><span class="line">                  cni.projectcalico.org/podIPs: 10.244.250.231/32</span><br><span class="line">                  kubernetes.io/limit-ranger: LimitRanger plugin set: cpu, memory request for container nginx; cpu, memory limit for container nginx</span><br><span class="line">Status:           Running</span><br><span class="line">IP:               10.244.250.231</span><br><span class="line">IPs:</span><br><span class="line">  IP:  10.244.250.231</span><br><span class="line">Containers:</span><br><span class="line">  nginx:</span><br><span class="line">    Container ID:   containerd://cee2451d0fa1dc99a5172dbe6566fb84284a9932955a39283d582d76fe041193</span><br><span class="line">    Image:          docker.io/library/nginx:latest</span><br><span class="line">    Image ID:       sha256:f6d0b4767a6c466c178bf718f99bea0d3742b26679081e52dbf8e0c7c4c42d74</span><br><span class="line">    Port:           80/TCP</span><br><span class="line">    Host Port:      0/TCP</span><br><span class="line">    State:          Running</span><br><span class="line">      Started:      Thu, 21 Dec 2023 20:01:07 +0800</span><br><span class="line">    Ready:          True</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Limits:</span><br><span class="line">      cpu:     1</span><br><span class="line">      memory:  1000Mi</span><br><span class="line">    Requests:</span><br><span class="line">      cpu:        500m</span><br><span class="line">      memory:     500Mi</span><br><span class="line">    Environment:  &lt;none&gt;</span><br><span class="line">    Mounts:</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-wx84d (ro)</span><br><span class="line">Conditions:</span><br><span class="line">  Type              Status</span><br><span class="line">  Initialized       True</span><br><span class="line">  Ready             True</span><br><span class="line">  ContainersReady   True</span><br><span class="line">  PodScheduled      True</span><br><span class="line">Volumes:</span><br><span class="line">  kube-api-access-wx84d:</span><br><span class="line">    Type:                    Projected (a volume that contains injected data from multiple sources)</span><br><span class="line">    TokenExpirationSeconds:  3607</span><br><span class="line">    ConfigMapName:           kube-root-ca.crt</span><br><span class="line">    ConfigMapOptional:       &lt;nil&gt;</span><br><span class="line">    DownwardAPI:             true</span><br><span class="line">QoS Class:                   Burstable</span><br><span class="line">Node-Selectors:              &lt;none&gt;</span><br><span class="line">Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s</span><br><span class="line">                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age   From               Message</span><br><span class="line">  ----    ------     ----  ----               -------</span><br><span class="line">  Normal  Scheduled  3m1s  default-scheduler  Successfully assigned limit/nginx-pod-demo to centos07-62</span><br><span class="line">  Normal  Pulled     3m    kubelet            Container image &quot;docker.io/library/nginx:latest&quot; already present on machine</span><br><span class="line">  Normal  Created    3m    kubelet            Created container nginx</span><br><span class="line">  Normal  Started    3m    kubelet            Started container nginx</span><br></pre></td></tr></table></figure>
<p>显示如下：<br><img src="/../../../../images/k8s/jc29/img_7.png" alt="img_7.png"><br>通过上面结果可以看到我们在limit名称空间下创建的pod没有指定其容器资源限制，创建pod后，其内部容器自动就有了默认的资源限制；其大小就是我们在定义LimitRange规则中的default和defaultRequest字段中指定的资源限制。</p>
</li>
<li><p>2 创建pod，指定cpu请求是100m，看看是否允许创建</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim pod-request.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-request</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">limit</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">100m</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 rbactest]# kubectl apply -f pod-request.yaml</span><br><span class="line">Error from server (Forbidden): error when creating &quot;pod-request.yaml&quot;: pods &quot;pod-request&quot; is forbidden: [minimum cpu usage per Container is 500m, but request is 100m, cpu max limit to request ratio per Container is 4, but provided ratio is 10.000000]</span><br></pre></td></tr></table></figure>
<p>创建的pod cpu 100m,限制是pod最少500m，不符合限制，所有报错</p>
</li>
</ul>

        
            <div id="toc-article">
                
  <div class="widget-wrap" id="toc-wrap">
    <h3 class="widget-title"><i class="fa fa-toc"></i> 文章目录</h3>
    <div class="widget">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-k8s%E5%AE%89%E5%85%A8%E7%AE%A1%E7%90%86%EF%BC%9A%E8%AE%A4%E8%AF%81%E3%80%81%E6%8E%88%E6%9D%83%E3%80%81%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6%E6%A6%82%E8%BF%B0"><span class="toc-text">1 k8s安全管理：认证、授权、准入控制概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E8%AE%A4%E8%AF%81"><span class="toc-text">1.1 认证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-%E6%8E%88%E6%9D%83"><span class="toc-text">1.2 授权</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6"><span class="toc-text">1.3 准入控制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Useraccount%E5%92%8CServiceAccount%E4%BB%8B%E7%BB%8D"><span class="toc-text">2 Useraccount和ServiceAccount介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-ServiceAccount%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B%E4%BB%8B%E7%BB%8D-%E5%88%9B%E5%BB%BAsa%EF%BC%8C%E5%B9%B6%E7%BB%91%E5%AE%9A%E5%88%B0pod"><span class="toc-text">3 ServiceAccount使用案例介绍: 创建sa，并绑定到pod</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E5%88%9B%E5%BB%BAsa"><span class="toc-text">3.1 创建sa</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E5%88%9B%E5%BB%BApod"><span class="toc-text">3.2 创建pod</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-%E5%AF%B9sa%E5%81%9A%E6%8E%88%E6%9D%83"><span class="toc-text">3.3 对sa做授权</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-%E5%86%8D%E6%AC%A1%E8%AF%B7%E6%B1%82"><span class="toc-text">3.4 再次请求</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-RBAC%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83%E7%AD%96%E7%95%A5"><span class="toc-text">4 RBAC认证授权策略</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-Role%EF%BC%9A%E8%A7%92%E8%89%B2"><span class="toc-text">4.1  Role：角色</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-ClusterRole%EF%BC%9A%E9%9B%86%E7%BE%A4%E8%A7%92%E8%89%B2"><span class="toc-text">4.2 ClusterRole：集群角色</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-RoleBinding%EF%BC%9A%E8%A7%92%E8%89%B2%E7%BB%91%E5%AE%9A%E3%80%81ClusterRolebinding%EF%BC%9A%E9%9B%86%E7%BE%A4%E8%A7%92%E8%89%B2%E7%BB%91%E5%AE%9A"><span class="toc-text">4.3  RoleBinding：角色绑定、ClusterRolebinding：集群角色绑定</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E8%B5%84%E6%BA%90%E7%9A%84%E5%BC%95%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">5 资源的引用方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E5%B8%B8%E8%A7%81%E8%A7%92%E8%89%B2-role-%E6%8E%88%E6%9D%83%E7%9A%84%E6%A1%88%E4%BE%8B"><span class="toc-text">6 常见角色(role)授权的案例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A7%92%E8%89%B2%E7%BB%91%E5%AE%9A%E7%A4%BA%E4%BE%8B"><span class="toc-text">7 常见的角色绑定示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-%E5%AF%B9Service-Account%E7%9A%84%E6%8E%88%E6%9D%83%E7%AE%A1%E7%90%86"><span class="toc-text">8 对Service Account的授权管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-%E4%BD%BF%E7%94%A8kubectl%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7%E5%88%9B%E5%BB%BA%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1"><span class="toc-text">9 使用kubectl命令行工具创建资源对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-%E9%99%90%E5%88%B6%E4%B8%8D%E5%90%8C%E7%9A%84%E7%94%A8%E6%88%B7%E6%93%8D%E4%BD%9Ck8s%E9%9B%86%E7%BE%A4"><span class="toc-text">10 限制不同的用户操作k8s集群</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#10-1-ssl%E8%AE%A4%E8%AF%81"><span class="toc-text">10.1 ssl认证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-2-%E5%9C%A8kubeconfig%E4%B8%8B%E6%96%B0%E5%A2%9E%E5%8A%A0%E4%B8%80%E4%B8%AAdbbruce%E8%BF%99%E4%B8%AA%E7%94%A8%E6%88%B7"><span class="toc-text">10.2 在kubeconfig下新增加一个dbbruce这个用户</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-3-%E6%8A%8Auser%E8%BF%99%E4%B8%AA%E7%94%A8%E6%88%B7%E9%80%9A%E8%BF%87rolebinding%E7%BB%91%E5%AE%9A%E5%88%B0clusterrole%E4%B8%8A%EF%BC%8C%E6%8E%88%E4%BA%88%E6%9D%83%E9%99%90-%E6%9D%83%E9%99%90%E5%8F%AA%E6%98%AF%E5%9C%A8dbbruce%E8%BF%99%E4%B8%AA%E5%90%8D%E7%A7%B0%E7%A9%BA%E9%97%B4%E6%9C%89%E6%95%88"><span class="toc-text">10.3 把user这个用户通过rolebinding绑定到clusterrole上，授予权限,权限只是在dbbruce这个名称空间有效</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-4-%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%B8%AAtest%E7%9A%84%E6%99%AE%E9%80%9A%E7%94%A8%E6%88%B7"><span class="toc-text">10.4 添加一个test的普通用户</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-5-%E6%8E%88%E6%9D%83kubectl%E7%94%A8%E6%88%B7%E8%83%BD%E6%9F%A5%E7%9C%8B%E6%89%80%E6%9C%89%E5%90%8D%E7%A7%B0%E7%A9%BA%E9%97%B4%E7%9A%84pod%E7%9A%84%E6%9D%83%E9%99%90"><span class="toc-text">10.5 授权kubectl用户能查看所有名称空间的pod的权限</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6"><span class="toc-text">11 准入控制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#11-1-ResourceQuota%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-text">11.1 ResourceQuota准入控制器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-2-LimitRanger%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-text">11.2 LimitRanger准入控制器</span></a></li></ol></li></ol>
    </div>
  </div>


            </div>
        
<!--          -->
<!--           <blockquote id="copyright"> -->
<!--               <p>原文链接: <a href="https://dbbruce.github.io/2023/05/14/运维/K8S/基础/29-K8S安全实战篇之RBAC认证授权/">https://dbbruce.github.io/2023/05/14/运维/K8S/基础/29-K8S安全实战篇之RBAC认证授权/</a></p> -->
<!--               <p>版权声明: 转载请注明出处.</p> -->
<!--           </blockquote> -->
<!--          -->
      
    </div>
    <footer class="article-footer">
      
        <div class="article-tag-wrap">
          

          
          <!--  -->
<!--     <div class="social-share"> -->
<!--       <span>分享到:</span> -->
<!--     </div> -->
<!--  -->
<!--  -->

        </div>
      
      
        
<nav id="article-nav">
  
    <a href="/2023/05/14/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/28-K8S%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E4%B8%AD%E5%BF%83Secret%E5%AE%9E%E7%8E%B0%E5%8A%A0%E5%AF%86%E6%95%B0%E6%8D%AE%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">
        
          28-K8S配置管理中心Secret实现加密数据配置管理
        
      </div>
    </a>
  
  
    <a href="/2023/05/15/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/30-Ingress-Controller%E9%AB%98%E5%8F%AF%E7%94%A8%E6%96%B9%E6%A1%88%E5%8F%8A%E5%A4%9A%E7%A7%9F%E6%88%B7%E5%9C%BA%E6%99%AF/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">
        
          30-Ingress-Controller高可用方案及多租户场景
        
      </div>
    </a>
  
</nav>

      
      
        








      
    </footer>
  </div>
</article>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title"><i class="fa fa-posts"></i> 最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/06/29/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/059-%E6%8C%89%E9%92%AE%E7%82%B9%E5%87%BB%E5%BC%B9%E7%AA%97/">059-按钮点击弹窗</a>
          </li>
        
          <li>
            <a href="/2025/06/29/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/060-entry_condition%E8%BF%9B%E5%85%A5%E6%9D%A1%E4%BB%B6/">060-entry_condition进入条件</a>
          </li>
        
          <li>
            <a href="/2025/06/28/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/058-model%E6%A0%A1%E9%AA%8C%E5%99%A8/">058-model校验器</a>
          </li>
        
          <li>
            <a href="/2025/06/27/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/057-%E5%85%83%E6%95%B0%E6%8D%AE%E4%BD%93%E7%B3%BB/">057-元数据体系</a>
          </li>
        
          <li>
            <a href="/2025/06/26/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/056-%E8%BF%90%E8%90%A5%E8%80%85%E6%A8%A1%E5%BC%8F/">056-运营者模式</a>
          </li>
        
      </ul>
    </div>
  </div>


  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title"><i class="fa fa-classify"></i> 分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/GO%E8%AF%AD%E8%A8%80/">GO语言</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/GO%E8%AF%AD%E8%A8%80/%E5%9F%BA%E7%A1%80/">基础</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python%E5%9F%BA%E7%A1%80/">Python基础</a><span class="category-list-count">21</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Python%E5%9F%BA%E7%A1%80/Django/">Django</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python%E5%9F%BA%E7%A1%80/%E5%8C%85%E6%96%B9%E6%B3%95/">包方法</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python%E5%9F%BA%E7%A1%80/%E5%9F%BA%E7%A1%80/">基础</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python%E5%9F%BA%E7%A1%80/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/">异步编程</a><span class="category-list-count">12</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/git/%E5%9F%BA%E7%A1%80/">基础</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a><span class="category-list-count">24</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/odoo/">odoo</a><span class="category-list-count">11</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/odoo/%E5%9F%BA%E7%A1%80/">基础</a><span class="category-list-count">11</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AF%8F%E6%9C%88%E6%A6%82%E8%A6%81/">每月概要</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AF%8F%E6%9C%88%E6%A6%82%E8%A6%81/2023/">2023</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AF%8F%E6%9C%88%E6%A6%82%E8%A6%81/2025/">2025</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/">爬虫类</a><span class="category-list-count">28</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E5%8F%8D%E7%88%AC/">反爬</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E5%9F%BA%E7%A1%80/">基础</a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E7%BC%96%E7%A0%81/">编码</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BD%91%E7%BB%9C/%E5%BC%82%E5%B8%B8/">异常</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/">运维</a><span class="category-list-count">197</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/Git/">Git</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/Java%E7%94%9F%E6%80%81/">Java生态</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/K8S/">K8S</a><span class="category-list-count">48</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/">基础</a><span class="category-list-count">45</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/K8S/%E9%94%99%E8%AF%AF/">错误</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/K8S/%E9%A1%B9%E7%9B%AE%E6%B1%87%E6%80%BB/">项目汇总</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/docker/">docker</a><span class="category-list-count">22</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/">基础</a><span class="category-list-count">20</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/docker/%E9%94%99%E8%AF%AF%E9%9B%86%E9%94%A6/">错误集锦</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/grafana/">grafana</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/">linux云计算基础教程</a><span class="category-list-count">63</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/memcached/">memcached</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/nginx/">nginx</a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/zabbix/">zabbix</a><span class="category-list-count">19</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/zabbix/5-0LTS/">5.0LTS</a><span class="category-list-count">19</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/">常用工具</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/%E6%8A%93%E5%8C%85%E5%B7%A5%E5%85%B7/">抓包工具</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E4%B8%80%E4%BA%9B%E6%8A%80%E5%B7%A7%E5%92%8C%E5%B8%B8%E8%AF%86/">运维一些技巧和常识</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/">问题处理</a><span class="category-list-count">5</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%A2%E8%AF%95/">面试</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%A2%E8%AF%95/%E9%A2%98/">题</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%A1%B9%E7%9B%AE/">项目</a><span class="category-list-count">86</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/">HCM教程</a><span class="category-list-count">61</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/">医药公司ERP</a><span class="category-list-count">25</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/%E4%B8%9A%E5%8A%A1/">业务</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/%E5%9F%BA%E7%A1%80/">基础</a><span class="category-list-count">3</span></li></ul></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title"><i class="fa fa-archive"></i> 归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/">2025年</a><span class="archive-list-count">65</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/">2023年</a><span class="archive-list-count">135</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/">2022年</a><span class="archive-list-count">40</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/">2021年</a><span class="archive-list-count">107</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020年</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/">2018年</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/">2017年</a><span class="archive-list-count">23</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2000/">2000年</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>


  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title"><i class="fa fa-link"></i> 友情链接</h3>
    <div class="widget">
      <ul>
      
        <li>
          <a href="https://dbbruce.github.io/">董迟钝的Blog</a>
        </li>
      
      </ul>
    </div>
  </div>


  
</aside>
        
      </div>
      <a id="totop" href="#top"></a>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
<!--       <p> -->
<!--         <a href="/sitemap.xml">网站地图</a> -->
<!--         <span> | </span><a href="/atom.xml">订阅本站</a> -->
<!--         <span> | </span><a href="/about/">联系博主</a> -->
<!--       </p> -->
<!--        -->
<!--         <p> -->
<!--           <i class="fa fa-visitors"></i> -->
<!--           <i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i> -->
<!--           ， -->
<!--           <i class="fa fa-views"></i> -->
<!--           <i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i> -->
<!--         </p> -->
<!--        -->
<!--       <p> -->
        <span>Copyright &copy; 2025 DB Bruce. 董勉的技术博客  https://dbbruce.github.io</span>
<!--         <span>Theme by <a href="https://github.com/chaooo/hexo-theme-BlueLake/" target="_blank">BlueLake.</a></span> -->
<!--         <span>Powered by <a href="https://hexo.io/" target="_blank">Hexo.</a></span> -->
<!--       </p> -->
    </div>
  </div>
</footer>

    </div>
  </div>
  
<script src="/js/jquery-3.4.1.min.js"></script>


<script src="/js/search.json.js"></script>


  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>






  
<script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<!--  -->
<!--    -->
<!--     
<script src="/localshare/js/social-share.js"></script>
 -->
<!--     
<script src="/localshare/js/qrcode.js"></script>
 -->
<!--    -->
<!--    -->
<!--  -->


  

  

  

  

  

  

  

  
  





</body>
</html>