<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>21-Deployment资源基本介绍 | 董勉 | 技术博客 | 成功的秘诀在于耐心和求胜心.</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
    <meta name="description" content="桑弧蓬矢">
  
  
  
    <link rel="alternate" href="/atom.xml" title="董勉 | 技术博客 | 成功的秘诀在于耐心和求胜心." type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
    
<link rel="stylesheet" href="/localshare/css/share.css">

  
  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">董勉 | 技术博客 | 成功的秘诀在于耐心和求胜心.</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">此生当克己勤免，自强不息 .</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/."><i class="fa fa-home"></i> 首页</a>
        
          <a class="main-nav-link" href="/archives/"><i class="fa fa-archive"></i> 归档</a>
        
          <a class="main-nav-link" href="/about/"><i class="fa fa-user"></i> 关于</a>
        
      </nav>
    </div>
    <div id="search-form">
      <div id="result-mask" class="hide"></div>
      <label><input id="search-key" type="text" autocomplete="off" placeholder="搜索"></label>
      <div id="result-wrap" class="hide">
        <div id="search-result"></div>
      </div>
      <div class="hide">
        <template id="search-tpl">
          <div class="item">
            <a href="/{path}" title="{title}">
              <div class="title">{title}</div>
              <div class="time">{date}</div>
              <div class="tags">{tags}</div>
            </a>
          </div>
        </template>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-运维/K8S/基础/21-Deployment资源基本介绍" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      21-Deployment资源基本介绍
    </h1>
  


      </header>
    
    <div class="article-meta">
      
      <span class="article-date">
  <i class="fa fa-date"></i>
  <time class="dt-published" datetime="2023-05-10T12:00:00.000Z" itemprop="datePublished">2023年05月10日</time>
</span>
      
  <div class="article-category">
    <i class="fa fa-classify"></i>
    <a class="article-category-link" href="/categories/%E8%BF%90%E7%BB%B4/">运维</a> > <a class="article-category-link" href="/categories/%E8%BF%90%E7%BB%B4/K8S/">K8S</a> > <a class="article-category-link" href="/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/">基础</a>
  </div>

      
        <span class="article-views">
  <i class="fa fa-views"></i>
  <i id="busuanzi_container_page_pv">
      <i id="busuanzi_value_page_pv"></i>
  </i>
</span>

      
      
<a href="/2023/05/10/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/21-Deployment%E8%B5%84%E6%BA%90%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D/#comments" class="article-comment-link">
  
    
    
    
    
    
  
<!--   <i class="fa fa-commt"></i> -->
<!--   留言 -->
</a>


    </div>
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="Deployment控制器：概念、原理解读"><a href="#Deployment控制器：概念、原理解读" class="headerlink" title="Deployment控制器：概念、原理解读"></a>Deployment控制器：概念、原理解读</h3><p>Deployment官方文档：<br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/</a></p>
<h4 id="1、Deployment概述"><a href="#1、Deployment概述" class="headerlink" title="1、Deployment概述"></a>1、Deployment概述</h4><p>Deployment是kubernetes中最常用的资源对象，为ReplicaSet和Pod的创建提供了一种声明式的定义方法，在Deployment对象中描述一个期望的状态，Deployment控制器就会按照一定的控制速率把实际状态改成期望状态，通过定义一个Deployment控制器会创建一个新的ReplicaSet控制器，通过ReplicaSet创建pod，删除Deployment控制器，也会删除Deployment控制器下对应的ReplicaSet控制器和pod资源.<br>使用Deployment而不直接创建ReplicaSet是因为Deployment对象拥有许多ReplicaSet没有的特性，例如滚动升级、金丝雀发布、蓝绿部署和回滚。</p>
<blockquote>
<p>扩展：声明式定义是指直接修改资源清单yaml文件，然后通过kubectl apply -f 资源清单yaml文件，就可以更改资源</p>
</blockquote>
<span id="more"></span>
<p>Deployment控制器是建立在rs之上的一个控制器，可以管理多个rs，每次更新镜像版本，都会生成一个新的rs，把旧的rs替换掉，多个rs同时存在，但是只有一个rs运行。<br><img src="/../../../../images/k8s/js21/img.png" alt="img.png"><br>rs v1控制三个pod，删除一个pod，在rs v2上重新建立一个，依次类推，直到全部都是由rs v2控制，如果rs v2有问题，还可以回滚，Deployment是建构在rs之上的，多个rs组成一个Deployment，但是只有一个rs处于活跃状态.</p>
<h4 id="2、Deployment工作原理：如何管理rs和Pod？"><a href="#2、Deployment工作原理：如何管理rs和Pod？" class="headerlink" title="2、Deployment工作原理：如何管理rs和Pod？"></a>2、Deployment工作原理：如何管理rs和Pod？</h4><p>Deployment可以使用声明式定义，直接在命令行通过纯命令的方式完成对应资源版本的内容的修改，也就是通过打补丁的方式进行修改；Deployment能提供滚动式自定义自控制的更新；对Deployment来讲，我们在实现更新时还可以实现控制更新节奏和更新逻辑。</p>
<ul>
<li>互动：什么叫做更新节奏和更新逻辑呢？<br>比如说Deployment控制5个pod副本，pod的期望值是5个，但是升级的时候需要额外多几个pod，那我们控制器可以控制在5个pod副本之外还能再增加几个pod副本；比方说能多一个，但是不能少，那么升级的时候就是先增加一个，再删除一个，增加一个删除一个，始终保持pod副本数是5个；还有一种情况，最多允许多一个，最少允许少一个，也就是最多6个，最少4个，第一次加一个，删除两个，第二次加两个，删除两个，依次类推，可以自己控制更新方式，这种滚动更新需要加<font color=red>readinessProbe和livenessProbe探测</font>，确保pod中容器里的应用都正常启动了才删除之前的pod。<br>启动第一步，刚更新第一批就暂停了也可以；假如目标是5个，允许一个也不能少，允许最多可以10个，那一次加5个即可；这就是我们可以自己控制节奏来控制更新的方法。<br><img src="/../../../../images/k8s/js21/img_1.png" alt="img_1.png"><br>通过Deployment对象，你可以轻松的做到以下事情：<br>1、创建ReplicaSet和Pod<br>2、滚动升级（不停止旧服务的状态下升级）和回滚应用（将应用回滚到之前的版本）<br>3、平滑地扩容和缩容<br>4、暂停和继续Deployment</li>
</ul>
<h3 id="Deployment资源清单文件编写技巧"><a href="#Deployment资源清单文件编写技巧" class="headerlink" title="Deployment资源清单文件编写技巧"></a>Deployment资源清单文件编写技巧</h3><ul>
<li>查看Deployment资源对象由哪几部分组成<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># kubectl explain deployment</span><br><span class="line"></span><br><span class="line">KIND:     Deployment</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line">DESCRIPTION:</span><br><span class="line">     Deployment enables declarative updates for Pods and ReplicaSets.</span><br><span class="line">FIELDS:</span><br><span class="line">   apiVersion	&lt;string&gt;  #该资源使用的api版本</span><br><span class="line">   kind	&lt;string&gt;            #创建的资源是什么？</span><br><span class="line">   metadata	&lt;Object&gt;       #元数据，包括资源的名字和名称空间</span><br><span class="line">   spec	&lt;Object&gt;           #定义容器的</span><br><span class="line">   status	&lt;Object&gt;       #状态，不可以修改</span><br></pre></td></tr></table></figure></li>
<li>查看Deployment下的spec字段<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># kubectl explain deployment.spec</span><br><span class="line"></span><br><span class="line">KIND:     Deployment</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line">RESOURCE: spec &lt;Object&gt;</span><br><span class="line">DESCRIPTION:</span><br><span class="line">     Specification of the desired behavior of the Deployment.</span><br><span class="line">     DeploymentSpec is the specification of the desired behavior of the</span><br><span class="line">     Deployment.</span><br><span class="line">FIELDS:</span><br><span class="line">    minReadySeconds	&lt;integer&gt;</span><br><span class="line">    #Kubernetes在等待设置的时间后才进行升级</span><br><span class="line">    #如果没有设置该值，Kubernetes会假设该容器启动起来后就提供服务了</span><br><span class="line">    paused	&lt;boolean&gt;  #暂停，当我们更新的时候创建pod先暂停，不是立即更新</span><br><span class="line">    progressDeadlineSeconds	&lt;integer&gt;</span><br><span class="line">    # k8s 在升级过程中有可能由于各种原因升级卡住（这个时候还没有明确的升级失败），比如在拉取被墙的镜像，权限不够等错误。那么这个时候就需要有个 deadline ，在 deadline 之内如果还卡着，那么就上报这个情况，这个时候这个 Deployment 状态就被标记为 False，并且注明原因。但是它并不会阻止 Deployment 继续进行卡住后面的操作。完全由用户进行控制。</span><br><span class="line">    replicas	&lt;integer&gt;  #副本数</span><br><span class="line">    revisionHistoryLimit	&lt;integer&gt; #保留的历史版本，默认是10</span><br><span class="line">    selector	&lt;Object&gt; -required- #标签选择器，选择它关联的pod</span><br><span class="line">    strategy	&lt;Object&gt;     #更新策略</span><br><span class="line">    template	&lt;Object&gt; -required  #定义的pod模板    </span><br></pre></td></tr></table></figure></li>
<li>查看Deployment下的spec.strategy字段<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># kubectl explain deploy.spec.strategy</span><br><span class="line">KIND:     Deployment</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line">RESOURCE: strategy &lt;Object&gt;</span><br><span class="line">DESCRIPTION:</span><br><span class="line">     The deployment strategy to use to replace existing pods with new ones.</span><br><span class="line">     DeploymentStrategy describes how to replace existing pods with new ones.</span><br><span class="line">FIELDS:</span><br><span class="line">   rollingUpdate	&lt;Object&gt;</span><br><span class="line">   type	&lt;string&gt;</span><br><span class="line">     Type of deployment. Can be &quot;Recreate&quot; or &quot;RollingUpdate&quot;. Default is</span><br><span class="line">     RollingUpdate.</span><br><span class="line">#支持两种更新，Recreate和RollingUpdate</span><br><span class="line">#Recreate是重建式更新，删除一个更新一个</span><br><span class="line">#RollingUpdate滚动更新，定义滚动更新方式，也就是pod能多几个，少几个</span><br></pre></td></tr></table></figure></li>
<li>查看Deployment下的spec.strategy.rollingUpdate字段<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># kubectl explain deploy.spec.strategy.rollingUpdate</span><br><span class="line"></span><br><span class="line">KIND:     Deployment</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line">RESOURCE: rollingUpdate &lt;Object&gt;</span><br><span class="line">DESCRIPTION:</span><br><span class="line">     Rolling update config params. Present only if DeploymentStrategyType =</span><br><span class="line">     RollingUpdate.</span><br><span class="line">     Spec to control the desired behavior of rolling update.</span><br><span class="line">FIELDS:</span><br><span class="line">    maxSurge	&lt;string&gt;</span><br><span class="line">    #我们更新的过程当中最多允许超出的指定的目标副本数有几个； </span><br><span class="line">    它有两种取值方式，第一种直接给定数量，第二种根据百分比，百分比表示原本是5个，最多可以超出20%，那就允许多一个，最多可以超过40%，那就允许多两个</span><br><span class="line">    maxUnavailable	&lt;string&gt;</span><br><span class="line">    #最多允许几个不可用</span><br></pre></td></tr></table></figure>
假设有5个副本，最多一个不可用，就表示最少有4个可用</li>
</ul>
<p>replicas： 5<br>maxSurge: 25%         5*25%&#x3D;1.25  -&gt;5+2&#x3D;7   &#x3D;&gt; 向上取<br>maxUnavailable: 25%    5%25%&#x3D;1.25  -&gt; 5-1&#x3D;4 &#x3D;&gt; 向下取</p>
<ul>
<li>查看Deployment下的spec.template字段<blockquote>
<p>#template为定义Pod的模板，Deployment通过模板创建Pod</p>
</blockquote>
</li>
</ul>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># kubectl explain deploy.spec.template</span><br><span class="line">KIND:     Deployment</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line">RESOURCE: template &lt;Object&gt;</span><br><span class="line">DESCRIPTION:</span><br><span class="line">     Template describes the pods that will be created.</span><br><span class="line">     PodTemplateSpec describes the data a pod should have when created from a template</span><br><span class="line">FIELDS:</span><br><span class="line">   metadata	&lt;Object&gt;  #定义模板的名字</span><br><span class="line">   spec	&lt;Object&gt;   </span><br></pre></td></tr></table></figure>
<blockquote>
<p>deployment.spec.template为Pod定义的模板，和Pod定义不太一样，template中不包含apiVersion和Kind属性，要求必须有metadata。deployment.spec.template.spec为容器的属性信息，其他定义内容和Pod一致。</p>
</blockquote>
<h3 id="Deployment使用案例：创建一个web站点"><a href="#Deployment使用案例：创建一个web站点" class="headerlink" title="Deployment使用案例：创建一个web站点"></a>Deployment使用案例：创建一个web站点</h3><blockquote>
<p><font color=red>deployment是一个三级结构，deployment管理replicaset，replicaset管理pod</font></p>
</blockquote>
<h4 id="1、用deployment创建一个pod"><a href="#1、用deployment创建一个pod" class="headerlink" title="1、用deployment创建一个pod"></a>1、用deployment创建一个pod</h4><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-22 ~]# ctr -n=k8s.io images import  myapp-blue-v1.tar.gz</span><br><span class="line">[root@centos07-22 ~]# ctr -n=k8s.io images import  myapp-blue-v2.tar.gz</span><br><span class="line">[root@centos07-62 ~]# ctr -n=k8s.io images import  myapp-blue-v1.tar.gz</span><br><span class="line">[root@centos07-62 ~]# ctr -n=k8s.io images import  myapp-blue-v2.tar.gz</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat deploy-demo.yaml </span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">         <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">         <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">docker.io/janakiramm/myapp:v1</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">startupProbe:</span></span><br><span class="line">           <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">           <span class="attr">initialDelaySeconds:</span> <span class="number">20</span></span><br><span class="line">           <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br><span class="line">           <span class="attr">httpGet:</span></span><br><span class="line">             <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">             <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">             <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">           <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">           <span class="attr">initialDelaySeconds:</span> <span class="number">20</span></span><br><span class="line">           <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br><span class="line">           <span class="attr">httpGet:</span></span><br><span class="line">             <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">             <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">             <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">           <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">           <span class="attr">initialDelaySeconds:</span> <span class="number">20</span></span><br><span class="line">           <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br><span class="line">           <span class="attr">httpGet:</span></span><br><span class="line">             <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">             <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">             <span class="attr">path:</span> <span class="string">/</span></span><br></pre></td></tr></table></figure>
<h4 id="2、更新资源清单文件："><a href="#2、更新资源清单文件：" class="headerlink" title="2、更新资源清单文件："></a>2、更新资源清单文件：</h4><blockquote>
<p>#kubectl apply：表示声明式的定义，既可以创建资源，也可以动态更新资源</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 replicasettest]# kubectl apply -f deploy-demo.yaml</span><br><span class="line">deployment.apps/myapp-v1 created</span><br></pre></td></tr></table></figure>
<h4 id="3、查看deploy状态："><a href="#3、查看deploy状态：" class="headerlink" title="3、查看deploy状态："></a>3、查看deploy状态：</h4><p>1.NAME：列出名称空间中deployment的名称。<br>2.READY：显示deployment有多少副本数。它遵循ready&#x2F;desired的模式。<br>3.UP-TO-DATE：显示已更新到所需状态的副本数。<br>4.AVAILABLE：显示你的可以使用多少个应用程序副本。<br>5.AGE：显示应用程序已运行的时间。</p>
<blockquote>
<p>kubectl get deploy </p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 replicasettest]# kubectl get deployment</span><br><span class="line">NAME       READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">myapp-v1   2/2     2            2           62s</span><br></pre></td></tr></table></figure>
<h4 id="4、创建deploy的时候也会创建一个rs（replicaset），67fd9fc9c8-这个随机数字是我们引用pod的模板template的名字的hash值"><a href="#4、创建deploy的时候也会创建一个rs（replicaset），67fd9fc9c8-这个随机数字是我们引用pod的模板template的名字的hash值" class="headerlink" title="4、创建deploy的时候也会创建一个rs（replicaset），67fd9fc9c8 这个随机数字是我们引用pod的模板template的名字的hash值"></a>4、创建deploy的时候也会创建一个rs（replicaset），67fd9fc9c8 这个随机数字是我们引用pod的模板template的名字的hash值</h4><ul>
<li>kubectl get rs<br>1.NAME：列出名称空间中ReplicaSet资源<br>2.DESIRED：显示应用程序的所需副本数，这些副本数是在创建时定义的。这是所需的状态。<br>3.CURRENT：显示当前正在运行多少个副本。<br>4.READY：显示你的用户可以使用多少个应用程序副本。<br>5.AGE：显示应用程序已运行的时间。</li>
</ul>
<h4 id="5、请注意，ReplicaSet的名称始终设置为-DEPLOYMENT-NAME-RANDOM-STRING-。RANDOM-STRING是随机生成的"><a href="#5、请注意，ReplicaSet的名称始终设置为-DEPLOYMENT-NAME-RANDOM-STRING-。RANDOM-STRING是随机生成的" class="headerlink" title="5、请注意，ReplicaSet的名称始终设置为[DEPLOYMENT-NAME]-[RANDOM-STRING]。RANDOM-STRING是随机生成的"></a>5、请注意，ReplicaSet的名称始终设置为[DEPLOYMENT-NAME]-[RANDOM-STRING]。RANDOM-STRING是随机生成的</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 replicasettest]# kubectl get replicaset</span><br><span class="line">NAME                  DESIRED   CURRENT   READY   AGE</span><br><span class="line">myapp-v1-86b9dddd9b   2         2         2       67s</span><br></pre></td></tr></table></figure>
<h4 id="6、查看pod详情"><a href="#6、查看pod详情" class="headerlink" title="6、查看pod详情"></a>6、查看pod详情</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 replicasettest]# kubectl get pods -owide</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE    IP               NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">myapp-v1-86b9dddd9b-njc5w   1/1     Running   0          5m6s   10.244.250.235   centos07-62   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">myapp-v1-86b9dddd9b-w9ks7   1/1     Running   0          5m6s   10.244.193.158   centos07-22   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<h4 id="7、验证访问"><a href="#7、验证访问" class="headerlink" title="7、验证访问"></a>7、验证访问</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 replicasettest]# curl 10.244.250.235</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">  &lt;title&gt;Sample Deployment&lt;/title&gt;</span><br><span class="line">  &lt;style&gt;</span><br><span class="line">    body &#123;</span><br><span class="line">      color: #ffffff;</span><br><span class="line">      background-color: blue;</span><br><span class="line">      font-family: Arial, sans-serif;</span><br><span class="line">      font-size: 14px;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    h1 &#123;</span><br><span class="line">      font-size: 500%;</span><br><span class="line">      font-weight: normal;</span><br><span class="line">      margin-bottom: 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    h2 &#123;</span><br><span class="line">      font-size: 200%;</span><br><span class="line">      font-weight: normal;</span><br><span class="line">      margin-bottom: 0;</span><br><span class="line">    &#125;</span><br><span class="line">  &lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;div align=&quot;center&quot;&gt;</span><br><span class="line">    &lt;h1&gt;Welcome to V1 of the web application&lt;/h1&gt;</span><br><span class="line">    &lt;h2&gt;This application will be deployed on Kubernetes.&lt;/h2&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<h3 id="Deployment资源清单文件详细解读"><a href="#Deployment资源清单文件详细解读" class="headerlink" title="Deployment资源清单文件详细解读"></a>Deployment资源清单文件详细解读</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>  <span class="comment">#deployment对应的api版本</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span>    <span class="comment">#创建的资源是deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-v1</span>   <span class="comment">#deployment的名字</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span>     <span class="comment">#deployment管理的pod副本数</span></span><br><span class="line">  <span class="attr">selector:</span>       <span class="comment">#标签选择器</span></span><br><span class="line">   <span class="attr">matchLabels:</span>  <span class="comment"># matchLabels下定义的标签需要跟template.metadata.labels定义的标签一致</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">   <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">     <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">     <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">   <span class="attr">spec:</span>   <span class="comment">#定义容器的属性</span></span><br><span class="line">    <span class="attr">containers:</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">janakiramm/myapp:v1</span> <span class="comment">#容器使用的镜像</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span>  <span class="comment">#镜像拉取策略</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span>     <span class="comment">#容器里的应用的端口</span></span><br></pre></td></tr></table></figure>
<h3 id="Deployment管理pod：扩容"><a href="#Deployment管理pod：扩容" class="headerlink" title="Deployment管理pod：扩容"></a>Deployment管理pod：扩容</h3><h4 id="1、通过deployment管理应用，实现扩容，把副本数变成3"><a href="#1、通过deployment管理应用，实现扩容，把副本数变成3" class="headerlink" title="1、通过deployment管理应用，实现扩容，把副本数变成3"></a>1、通过deployment管理应用，实现扩容，把副本数变成3</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>
<h4 id="2、查看pod的情况，新增myapp-v1-86b9dddd9b-2r6mk"><a href="#2、查看pod的情况，新增myapp-v1-86b9dddd9b-2r6mk" class="headerlink" title="2、查看pod的情况，新增myapp-v1-86b9dddd9b-2r6mk"></a>2、查看pod的情况，新增myapp-v1-86b9dddd9b-2r6mk</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 probe1test]# kubectl get pods -owide -w</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE    IP               NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">myapp-v1-86b9dddd9b-njc5w   1/1     Running   0          178m   10.244.250.235   centos07-62   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">myapp-v1-86b9dddd9b-w9ks7   1/1     Running   0          178m   10.244.193.158   centos07-22   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">myapp-v1-86b9dddd9b-2r6mk   0/1     Pending   0          0s     &lt;none&gt;           &lt;none&gt;        &lt;none&gt;           &lt;none&gt;</span><br><span class="line">myapp-v1-86b9dddd9b-2r6mk   0/1     Pending   0          0s     &lt;none&gt;           centos07-62   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">myapp-v1-86b9dddd9b-2r6mk   0/1     ContainerCreating   0          0s     &lt;none&gt;           centos07-62   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">myapp-v1-86b9dddd9b-2r6mk   0/1     ContainerCreating   0          1s     &lt;none&gt;           centos07-62   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">myapp-v1-86b9dddd9b-2r6mk   0/1     Running             0          2s     10.244.250.236   centos07-62   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">myapp-v1-86b9dddd9b-2r6mk   0/1     Running             0          26s    10.244.250.236   centos07-62   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">myapp-v1-86b9dddd9b-2r6mk   1/1     Running             0          26s    10.244.250.236   centos07-62   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<h4 id="3、注意：apply不同于create，apply可以执行多次；create执行一次，再执行就会报错复。"><a href="#3、注意：apply不同于create，apply可以执行多次；create执行一次，再执行就会报错复。" class="headerlink" title="3、注意：apply不同于create，apply可以执行多次；create执行一次，再执行就会报错复。"></a>3、注意：apply不同于create，apply可以执行多次；create执行一次，再执行就会报错复。</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 replicasettest]# kubectl apply -f deploy-demo.yaml</span><br><span class="line">deployment.apps/myapp-v1 configured</span><br></pre></td></tr></table></figure>
<h4 id="4、可以看到pod副本数变成了3个"><a href="#4、可以看到pod副本数变成了3个" class="headerlink" title="4、可以看到pod副本数变成了3个"></a>4、可以看到pod副本数变成了3个</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 replicasettest]# kubectl get pods -owide</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE    IP               NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">myapp-v1-86b9dddd9b-2r6mk   1/1     Running   0          2m8s   10.244.250.236   centos07-62   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">myapp-v1-86b9dddd9b-njc5w   1/1     Running   0          3h4m   10.244.250.235   centos07-62   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">myapp-v1-86b9dddd9b-w9ks7   1/1     Running   0          3h4m   10.244.193.158   centos07-22   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<h4 id="5、查看myapp-v1这个控制器的详细信息"><a href="#5、查看myapp-v1这个控制器的详细信息" class="headerlink" title="5、查看myapp-v1这个控制器的详细信息"></a>5、查看myapp-v1这个控制器的详细信息</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 replicasettest]# kubectl get deploy myapp-v1</span><br><span class="line">NAME       READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">myapp-v1   3/3     3            3           3h5m</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 replicasettest]# kubectl describe deploy myapp-v1</span><br><span class="line">Name:                   myapp-v1</span><br><span class="line">Namespace:              default</span><br><span class="line">CreationTimestamp:      Sat, 09 Dec 2023 15:59:51 +0800</span><br><span class="line">Labels:                 &lt;none&gt;</span><br><span class="line">Annotations:            deployment.kubernetes.io/revision: 1</span><br><span class="line">Selector:               app=myapp,version=v1</span><br><span class="line">Replicas:               3 desired | 3 updated | 3 total | 3 available | 0 unavailable</span><br><span class="line">StrategyType:           RollingUpdate</span><br><span class="line">MinReadySeconds:        0</span><br><span class="line">RollingUpdateStrategy:  25% max unavailable, 25% max surge</span><br><span class="line">Pod Template:</span><br><span class="line">  Labels:  app=myapp</span><br><span class="line">           version=v1</span><br><span class="line">  Containers:</span><br><span class="line">   myapp:</span><br><span class="line">    Image:        docker.io/janakiramm/myapp:v1</span><br><span class="line">    Port:         80/TCP</span><br><span class="line">    Host Port:    0/TCP</span><br><span class="line">    Liveness:     http-get http://:80/ delay=20s timeout=10s period=5s #success=1 #failure=3</span><br><span class="line">    Readiness:    http-get http://:80/ delay=20s timeout=10s period=5s #success=1 #failure=3</span><br><span class="line">    Startup:      http-get http://:80/ delay=20s timeout=10s period=5s #success=1 #failure=3</span><br><span class="line">    Environment:  &lt;none&gt;</span><br><span class="line">    Mounts:       &lt;none&gt;</span><br><span class="line">  Volumes:        &lt;none&gt;</span><br><span class="line">Conditions:</span><br><span class="line">  Type           Status  Reason</span><br><span class="line">  ----           ------  ------</span><br><span class="line">  Progressing    True    NewReplicaSetAvailable</span><br><span class="line">  Available      True    MinimumReplicasAvailable</span><br><span class="line">OldReplicaSets:  &lt;none&gt;</span><br><span class="line">NewReplicaSet:   myapp-v1-86b9dddd9b (3/3 replicas created)</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason             Age    From                   Message</span><br><span class="line">  ----    ------             ----   ----                   -------</span><br><span class="line">  Normal  ScalingReplicaSet  3h6m   deployment-controller  Scaled up replica set myapp-v1-86b9dddd9b to 2</span><br><span class="line">  Normal  ScalingReplicaSet  3m53s  deployment-controller  Scaled up replica set myapp-v1-86b9dddd9b to 3 from 2</span><br></pre></td></tr></table></figure>
<h3 id="Deployment管理pod：缩容"><a href="#Deployment管理pod：缩容" class="headerlink" title="Deployment管理pod：缩容"></a>Deployment管理pod：缩容</h3><h4 id="1、通过deployment管理应用，实现缩容，把副本数变成2"><a href="#1、通过deployment管理应用，实现缩容，把副本数变成2" class="headerlink" title="1、通过deployment管理应用，实现缩容，把副本数变成2"></a>1、通过deployment管理应用，实现缩容，把副本数变成2</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat  deploy-demo.yaml </span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span>  </span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 replicasettest]# kubectl apply -f deploy-demo.yaml</span><br><span class="line">deployment.apps/myapp-v1 configured</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 replicasettest]# kubectl get pods -owide</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE    IP               NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">myapp-v1-86b9dddd9b-njc5w   1/1     Running   0          3h9m   10.244.250.235   centos07-62   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">myapp-v1-86b9dddd9b-w9ks7   1/1     Running   0          3h9m   10.244.193.158   centos07-22   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<h3 id="通过k8s实现滚动更新"><a href="#通过k8s实现滚动更新" class="headerlink" title="通过k8s实现滚动更新"></a>通过k8s实现滚动更新</h3><h4 id="1、滚动更新简介"><a href="#1、滚动更新简介" class="headerlink" title="1、滚动更新简介"></a>1、滚动更新简介</h4><p>滚动更新是一种自动化程度较高的发布方式，用户体验比较平滑，是目前成熟型技术组织所采用的主流发布方式，一次滚动发布一般由若干个发布批次组成，每批的数量一般是可以配置的（可以通过发布模板定义），例如第一批1台，第二批10%，第三批50%，第四批100%。每个批次之间留观察间隔，通过手工验证或监控反馈确保没有问题再发下一批次，所以总体上滚动式发布过程是比较缓慢的 </p>
<p>10个pod：<br>第一我更新1个pod：<br>第二次更新：1个<br>第三次更新：5个<br>第四次：3个</p>
<h4 id="2、首先看下Deployment资源对象的组成："><a href="#2、首先看下Deployment资源对象的组成：" class="headerlink" title="2、首先看下Deployment资源对象的组成："></a>2、首先看下Deployment资源对象的组成：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 replicasettest]# kubectl explain deployment</span><br></pre></td></tr></table></figure>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 replicasettest]# kubectl explain deployment.spec</span><br><span class="line"></span><br><span class="line">KIND:     Deployment</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line">RESOURCE: spec &lt;Object&gt;</span><br><span class="line">DESCRIPTION:</span><br><span class="line">     Specification of the desired behavior of the Deployment.</span><br><span class="line">     DeploymentSpec is the specification of the desired behavior of the</span><br><span class="line">     Deployment.</span><br><span class="line">FIELDS:</span><br><span class="line">   minReadySeconds	&lt;integer&gt;</span><br><span class="line">     Minimum number of seconds for which a newly created pod should be ready</span><br><span class="line">     without any of its container crashing, for it to be considered available.</span><br><span class="line">     Defaults to 0 (pod will be considered available as soon as it is ready)</span><br><span class="line">   paused	&lt;boolean&gt;</span><br><span class="line">     Indicates that the deployment is paused.</span><br><span class="line">#暂停，当我们更新的时候创建pod先暂停，不是立即更新</span><br><span class="line">   progressDeadlineSeconds	&lt;integer&gt;</span><br><span class="line">     The maximum time in seconds for a deployment to make progress before it is</span><br><span class="line">     considered to be failed. The deployment controller will continue to process</span><br><span class="line">     failed deployments and a condition with a ProgressDeadlineExceeded reason</span><br><span class="line">     will be surfaced in the deployment status. Note that progress will not be</span><br><span class="line">     estimated during the time a deployment is paused. Defaults to 600s.</span><br><span class="line">   replicas	&lt;integer&gt;</span><br><span class="line">     Number of desired pods. This is a pointer to distinguish between explicit</span><br><span class="line">     zero and not specified. Defaults to 1.</span><br><span class="line">   revisionHistoryLimit	&lt;integer&gt;</span><br><span class="line">#保留的历史版本数，默认是10个</span><br><span class="line">     The number of old ReplicaSets to retain to allow rollback. This is a</span><br><span class="line">     pointer to distinguish between explicit zero and not specified. Defaults to</span><br><span class="line">     10.</span><br><span class="line">   selector	&lt;Object&gt; -required-</span><br><span class="line">     Label selector for pods. Existing ReplicaSets whose pods are selected by</span><br><span class="line">     this will be the ones affected by this deployment. It must match the pod</span><br><span class="line">     template&#x27;s labels.</span><br><span class="line">   strategy	&lt;Object&gt;</span><br><span class="line">#更新策略，支持的滚动更新策略</span><br><span class="line">     The deployment strategy to use to replace existing pods with new ones.</span><br><span class="line">   template	&lt;Object&gt; -required-</span><br><span class="line">     Template describes the pods that will be created.</span><br><span class="line"></span><br><span class="line">kubectl explain deploy.spec.strategy</span><br><span class="line">KIND:     Deployment</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line">RESOURCE: strategy &lt;Object&gt;</span><br><span class="line">DESCRIPTION:</span><br><span class="line">     The deployment strategy to use to replace existing pods with new ones.</span><br><span class="line">     DeploymentStrategy describes how to replace existing pods with new ones.</span><br><span class="line">FIELDS:</span><br><span class="line">   rollingUpdate	&lt;Object&gt;</span><br><span class="line">     Rolling update config params. Present only if DeploymentStrategyType =</span><br><span class="line">     RollingUpdate.</span><br><span class="line">   type	&lt;string&gt;</span><br><span class="line">     Type of deployment. Can be &quot;Recreate&quot; or &quot;RollingUpdate&quot;. Default is</span><br><span class="line">     RollingUpdate.</span><br><span class="line">#支持两种更新，Recreate和RollingUpdate </span><br><span class="line">#Recreate是重建式更新，删除一个更新一个 </span><br><span class="line">#RollingUpdate 滚动更新，定义滚动更新的更新方式的，也就是pod能多几个，少几个，控制更新力度的</span><br><span class="line"></span><br><span class="line">kubectl explain deploy.spec.strategy.rollingUpdate</span><br><span class="line">KIND:     Deployment</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line">RESOURCE: rollingUpdate &lt;Object&gt;</span><br><span class="line">DESCRIPTION:</span><br><span class="line">     Rolling update config params. Present only if DeploymentStrategyType =</span><br><span class="line">     RollingUpdate.</span><br><span class="line">     Spec to control the desired behavior of rolling update.</span><br><span class="line">FIELDS:</span><br><span class="line">   maxSurge	&lt;string&gt;</span><br><span class="line">     The maximum number of pods that can be scheduled above the desired number</span><br><span class="line">     of pods. Value can be an absolute number (ex: 5) or a percentage of desired</span><br><span class="line">     pods (ex: 10%). This can not be 0 if MaxUnavailable is 0. Absolute number</span><br><span class="line">     is calculated from percentage by rounding up. Defaults to 25%. Example:</span><br><span class="line">     when this is set to 30%, the new ReplicaSet can be scaled up immediately</span><br><span class="line">     when the rolling update starts, such that the total number of old and new</span><br><span class="line">     pods do not exceed 130% of desired pods. Once old pods have been killed,</span><br><span class="line">     new ReplicaSet can be scaled up further, ensuring that total number of pods</span><br><span class="line">     running at any time during the update is at most 130% of desired pods.</span><br><span class="line"></span><br><span class="line">#我们更新的过程当中最多允许超出的指定的目标副本数有几个； </span><br><span class="line">它有两种取值方式，第一种直接给定数量，第二种根据百分比，百分比表示原本是5个，最多可以超出20%，那就允许多一个，最多可以超过40%，那就允许多两个</span><br><span class="line">   maxUnavailable	&lt;string&gt;</span><br><span class="line">     The maximum number of pods that can be unavailable during the update. Value</span><br><span class="line">     can be an absolute number (ex: 5) or a percentage of desired pods (ex:</span><br><span class="line">     10%). Absolute number is calculated from percentage by rounding down. This</span><br><span class="line">     can not be 0 if MaxSurge is 0. Defaults to 25%. Example: when this is set</span><br><span class="line">     to 30%, the old ReplicaSet can be scaled down to 70% of desired pods</span><br><span class="line">     immediately when the rolling update starts. Once new pods are ready, old</span><br><span class="line">     ReplicaSet can be scaled down further, followed by scaling up the new</span><br><span class="line">     ReplicaSet, ensuring that the total number of pods available at all times</span><br><span class="line">     during the update is at least 70% of desired pods.</span><br><span class="line">#最多允许几个不可用</span><br><span class="line">假设有5个副本，最多一个不可用，就表示最少有4个可用</span><br></pre></td></tr></table></figure>
<blockquote>
<p>deployment是一个三级结构，deployment控制replicaset，replicaset控制pod</p>
</blockquote>
<h4 id="3、"><a href="#3、" class="headerlink" title="3、"></a>3、</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 replicasettest]# kubectl apply -f deploy-demo.yaml</span><br><span class="line">deployment.apps/myapp-v1 configured</span><br></pre></td></tr></table></figure>
<ul>
<li>可以看到pod副本数变成了3个 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 replicasettest]# kubectl get pods</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">myapp-v1-86b9dddd9b-njc5w   1/1     Running   0          3h15m</span><br><span class="line">myapp-v1-86b9dddd9b-qxs6n   1/1     Running   0          64s</span><br><span class="line">myapp-v1-86b9dddd9b-w9ks7   1/1     Running   0          3h15m</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：apply不同于create，apply可以执行多次；create执行一次，再执行就会报错有重复。  <br><br>[root@centos07-12 replicasettest]# kubectl create -f deploy-demo.yaml                                                       <br><br>Error from server (AlreadyExists): error when creating “deploy-demo.yaml”: deployments.apps “myapp-v1” already exists       <br><br>[root@centos07-12 replicasettest]# kubectl apply -f deploy-demo.yaml    <br><br>deployment.apps&#x2F;myapp-v1 configured    <br></p>
</blockquote>
</li>
<li>查看myapp-v1这个控制器的详细信息<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 replicasettest]# kubectl describe deploy myapp-v1</span><br><span class="line">Name:                   myapp-v1</span><br><span class="line">Namespace:              default</span><br><span class="line">CreationTimestamp:      Sat, 09 Dec 2023 15:59:51 +0800</span><br><span class="line">Labels:                 &lt;none&gt;</span><br><span class="line">Annotations:            deployment.kubernetes.io/revision: 1</span><br><span class="line">Selector:               app=myapp,version=v1</span><br><span class="line">Replicas:               4 desired | 4 updated | 4 total | 4 available | 0 unavailable</span><br><span class="line">StrategyType:           RollingUpdate</span><br><span class="line">MinReadySeconds:        0</span><br><span class="line">RollingUpdateStrategy:  25% max unavailable, 25% max surge</span><br><span class="line">Pod Template:</span><br><span class="line">  Labels:  app=myapp</span><br><span class="line">           version=v1</span><br><span class="line">  Containers:</span><br><span class="line">   myapp:</span><br><span class="line">    Image:        docker.io/janakiramm/myapp:v1</span><br><span class="line">    Port:         80/TCP</span><br><span class="line">    Host Port:    0/TCP</span><br><span class="line">    Liveness:     http-get http://:80/ delay=20s timeout=10s period=5s #success=1 #failure=3</span><br><span class="line">    Readiness:    http-get http://:80/ delay=20s timeout=10s period=5s #success=1 #failure=3</span><br><span class="line">    Startup:      http-get http://:80/ delay=20s timeout=10s period=5s #success=1 #failure=3</span><br><span class="line">    Environment:  &lt;none&gt;</span><br><span class="line">    Mounts:       &lt;none&gt;</span><br><span class="line">  Volumes:        &lt;none&gt;</span><br><span class="line">Conditions:</span><br><span class="line">  Type           Status  Reason</span><br><span class="line">  ----           ------  ------</span><br><span class="line">  Progressing    True    NewReplicaSetAvailable</span><br><span class="line">  Available      True    MinimumReplicasAvailable</span><br><span class="line">OldReplicaSets:  &lt;none&gt;</span><br><span class="line">NewReplicaSet:   myapp-v1-86b9dddd9b (4/4 replicas created)</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason             Age                From                   Message</span><br><span class="line">  ----    ------             ----               ----                   -------</span><br><span class="line">  Normal  ScalingReplicaSet  58m                deployment-controller  Scaled down replica set myapp-v1-86b9dddd9b to 2 from 3</span><br><span class="line">  Normal  ScalingReplicaSet  52m (x2 over 64m)  deployment-controller  Scaled up replica set myapp-v1-86b9dddd9b to 3 from 2</span><br><span class="line">  Normal  ScalingReplicaSet  46m                deployment-controller  Scaled down replica set myapp-v1-86b9dddd9b to 3 from 4</span><br><span class="line">  Normal  ScalingReplicaSet  45m (x2 over 47m)  deployment-controller  Scaled up replica set myapp-v1-86b9dddd9b to 4 from 3</span><br></pre></td></tr></table></figure></li>
<li>打开一个新的终端窗口更改镜像版本，按如下操作：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -l app=myapp -w</span><br></pre></td></tr></table></figure></li>
<li>把image: janakiramm&#x2F;myapp:v1 变成image: janakiramm&#x2F;myapp:v2 ，保存退出，执行 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: myapp-v1</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: myapp</span><br><span class="line">      version: v1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: myapp</span><br><span class="line">        version: v1</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: myapp</span><br><span class="line">        image: docker.io/janakiramm/myapp:v2</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 replicasettest]# kubectl apply -f deploy-demo.yaml</span><br><span class="line">deployment.apps/myapp-v1 configured</span><br></pre></td></tr></table></figure>
<blockquote>
<p>再回到刚才监测的那个窗口，可以看到信息如下：</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 probe1test]# kubectl get pods -l app=myapp -w</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">myapp-v1-86b9dddd9b-lwcxz   1/1     Running   0          47m</span><br><span class="line">myapp-v1-86b9dddd9b-njc5w   1/1     Running   0          4h8m</span><br><span class="line">myapp-v1-86b9dddd9b-qxs6n   1/1     Running   0          54m</span><br><span class="line">myapp-v1-86b9dddd9b-w9ks7   1/1     Running   0          4h8m</span><br><span class="line">myapp-v1-7d4c7ddb79-dwpq8   0/1     Pending   0          0s</span><br><span class="line">myapp-v1-7d4c7ddb79-dwpq8   0/1     Pending   0          0s</span><br><span class="line">myapp-v1-86b9dddd9b-qxs6n   1/1     Terminating   0          56m</span><br><span class="line">myapp-v1-7d4c7ddb79-dwpq8   0/1     ContainerCreating   0          0s</span><br><span class="line">myapp-v1-86b9dddd9b-qxs6n   1/1     Terminating         0          56m</span><br><span class="line">myapp-v1-7d4c7ddb79-dwpq8   0/1     ContainerCreating   0          1s</span><br><span class="line">myapp-v1-86b9dddd9b-qxs6n   0/1     Terminating         0          56m</span><br><span class="line">myapp-v1-86b9dddd9b-qxs6n   0/1     Terminating         0          56m</span><br><span class="line">myapp-v1-86b9dddd9b-qxs6n   0/1     Terminating         0          56m</span><br><span class="line">myapp-v1-86b9dddd9b-qxs6n   0/1     Terminating         0          56m</span><br><span class="line">myapp-v1-7d4c7ddb79-dwpq8   0/1     Running             0          3s</span><br><span class="line">myapp-v1-7d4c7ddb79-dwpq8   0/1     Running             0          26s</span><br><span class="line">myapp-v1-7d4c7ddb79-dwpq8   1/1     Running             0          26s</span><br><span class="line">myapp-v1-86b9dddd9b-lwcxz   1/1     Terminating         0          49m</span><br><span class="line">myapp-v1-7d4c7ddb79-mvrfh   0/1     Pending             0          0s</span><br><span class="line">myapp-v1-7d4c7ddb79-mvrfh   0/1     Pending             0          0s</span><br><span class="line">myapp-v1-7d4c7ddb79-mvrfh   0/1     ContainerCreating   0          0s</span><br><span class="line">myapp-v1-86b9dddd9b-lwcxz   1/1     Terminating         0          49m</span><br><span class="line">myapp-v1-7d4c7ddb79-mvrfh   0/1     ContainerCreating   0          1s</span><br><span class="line">myapp-v1-86b9dddd9b-lwcxz   0/1     Terminating         0          49m</span><br><span class="line">myapp-v1-86b9dddd9b-lwcxz   0/1     Terminating         0          49m</span><br><span class="line">myapp-v1-86b9dddd9b-lwcxz   0/1     Terminating         0          49m</span><br><span class="line">myapp-v1-86b9dddd9b-lwcxz   0/1     Terminating         0          49m</span><br><span class="line">myapp-v1-7d4c7ddb79-mvrfh   0/1     Running             0          2s</span><br><span class="line">myapp-v1-7d4c7ddb79-mvrfh   0/1     Running             0          25s</span><br><span class="line">myapp-v1-7d4c7ddb79-mvrfh   1/1     Running             0          25s</span><br><span class="line">myapp-v1-86b9dddd9b-njc5w   1/1     Terminating         0          4h11m</span><br><span class="line">myapp-v1-7d4c7ddb79-mdn79   0/1     Pending             0          0s</span><br><span class="line">myapp-v1-7d4c7ddb79-mdn79   0/1     Pending             0          0s</span><br><span class="line">myapp-v1-7d4c7ddb79-mdn79   0/1     ContainerCreating   0          0s</span><br><span class="line">myapp-v1-86b9dddd9b-njc5w   1/1     Terminating         0          4h11m</span><br><span class="line">myapp-v1-7d4c7ddb79-mdn79   0/1     ContainerCreating   0          1s</span><br><span class="line">myapp-v1-86b9dddd9b-njc5w   0/1     Terminating         0          4h11m</span><br><span class="line">myapp-v1-86b9dddd9b-njc5w   0/1     Terminating         0          4h11m</span><br><span class="line">myapp-v1-86b9dddd9b-njc5w   0/1     Terminating         0          4h11m</span><br><span class="line">myapp-v1-86b9dddd9b-njc5w   0/1     Terminating         0          4h11m</span><br><span class="line">myapp-v1-7d4c7ddb79-mdn79   0/1     Running             0          2s</span><br><span class="line">myapp-v1-7d4c7ddb79-mdn79   0/1     Running             0          25s</span><br><span class="line">myapp-v1-7d4c7ddb79-mdn79   1/1     Running             0          25s</span><br><span class="line">myapp-v1-86b9dddd9b-w9ks7   1/1     Terminating         0          4h11m</span><br><span class="line">myapp-v1-86b9dddd9b-w9ks7   1/1     Terminating         0          4h11m</span><br><span class="line">myapp-v1-86b9dddd9b-w9ks7   0/1     Terminating         0          4h11m</span><br><span class="line">myapp-v1-86b9dddd9b-w9ks7   0/1     Terminating         0          4h11m</span><br><span class="line">myapp-v1-86b9dddd9b-w9ks7   0/1     Terminating         0          4h11m</span><br><span class="line">myapp-v1-86b9dddd9b-w9ks7   0/1     Terminating         0          4h11m</span><br></pre></td></tr></table></figure>
<blockquote>
<p>pending表示正在进行调度，ContainerCreating表示正在创建一个pod，running表示运 行一个pod，running起来一个pod之后再Terminating（停掉）一个pod，以此类推，直 到所有pod完成滚动升级</p>
</blockquote>
</li>
<li>在另外一个窗口执行<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@centos07-12 replicasettest]# kubectl get rs</span><br><span class="line">NAME                  DESIRED   CURRENT   READY   AGE</span><br><span class="line">myapp-v1-7d4c7ddb79   3         3         3       3m23s</span><br><span class="line">myapp-v1-86b9dddd9b   0         0         0       4h13m</span><br></pre></td></tr></table></figure>
<blockquote>
<p>上面可以看到rs有两个，下面那个是升级之前的，已经被停掉，但是可以随时回滚 </p>
</blockquote>
</li>
<li>查看myapp-v1这个控制器的滚动历史，显示如下：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 replicasettest]# kubectl rollout history deployment myapp-v1</span><br><span class="line">deployment.apps/myapp-v1</span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">1         &lt;none&gt;</span><br><span class="line">2         &lt;none&gt;</span><br></pre></td></tr></table></figure></li>
<li>回滚操作如下： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 replicasettest]#  kubectl rollout undo deployment/myapp-v1 --to-revision=1</span><br><span class="line">deployment.apps/myapp-v1 rolled back</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="自定义滚动更新策略"><a href="#自定义滚动更新策略" class="headerlink" title="自定义滚动更新策略"></a>自定义滚动更新策略</h3><ul>
<li>maxSurge[更新的过程当中最多允许超出的指定的目标副本数有几个]和maxUnavailable[最多允许几个不可用]用来控制滚动更新的更新策略</li>
<li>取值范围<br>数值</li>
</ul>
<ol>
<li>maxUnavailable: [0, 副本数]</li>
<li>maxSurge: [0, 副本数]<br>注意：两者不能同时为0。</li>
</ol>
<ul>
<li>比例</li>
</ul>
<ol>
<li>maxUnavailable: [0%, 100%] 向下取整，比如10个副本，5%的话&#x3D;&#x3D;0.5个，但计算按照0个；</li>
<li>maxSurge: [0%, 100%] 向上取整，比如10个副本，5%的话&#x3D;&#x3D;0.5个，但计算按照1个；<br>注意：两者不能同时为0。</li>
</ol>
<ul>
<li>建议配置</li>
</ul>
<ol>
<li>maxUnavailable &#x3D;&#x3D; 0</li>
<li>maxSurge &#x3D;&#x3D; 1<br>这是我们生产环境提供给用户的默认配置。即“一上一下，先上后下”最平滑原则：<br>1个新版本pod ready（结合readiness）后，才销毁旧版本pod。此配置适用场景是平滑更新、保证服务平稳，但也有缺点，就是“太慢”了。<br>-总结：<br>maxUnavailable：和期望的副本数比，不可用副本数最大比例（或最大值），这个值越小，越能保证服务稳定，更新越平滑；<br>maxSurge：和期望的副本数比，超过期望副本数最大比例（或最大值），这个值调的越大，副本更新速度越快。</li>
</ol>
<h4 id="1、自定义策略："><a href="#1、自定义策略：" class="headerlink" title="1、自定义策略："></a>1、自定义策略：</h4><ul>
<li>修改更新策略：maxUnavailable&#x3D;1，maxSurge&#x3D;1 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 replicasettest]# kubectl patch deployment myapp-v1 -p &#x27;&#123;&quot;spec&quot;:&#123;&quot;strategy&quot;:&#123;&quot;rollingUpdate&quot;: &#123;&quot;maxSurge&quot;:1,&quot;maxUnavailable&quot;:1&#125;&#125;&#125;&#125;&#x27;</span><br><span class="line">deployment.apps/myapp-v1 patched</span><br></pre></td></tr></table></figure></li>
<li>查看myapp-v1这个控制器的详细信息<blockquote>
<p>[root@centos07-12 replicasettest]# kubectl describe deployment myapp-v1<br>RollingUpdateStrategy:  1 max unavailable, 1 max surge<br><img src="/../../../../images/k8s/js21/img_2.png" alt="img_2.png"></p>
</blockquote>
</li>
</ul>
<blockquote>
<p>上面可以看到RollingUpdateStrategy: 1 max unavailable, 1 max surge <br><br>这个rollingUpdate更新策略变成了刚才设定的，因为我们设定的pod副本数是3，1和1表示最少不能少于2个pod，最多不能超过4个pod <br><br>这个就是通过控制RollingUpdateStrategy这个字段来设置滚动更新策略的<br></p>
</blockquote>
<h4 id="2、把pod更新策略变成Recreate"><a href="#2、把pod更新策略变成Recreate" class="headerlink" title="2、把pod更新策略变成Recreate"></a>2、把pod更新策略变成Recreate</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat deploy-demo.yaml</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">docker.io/janakiramm/myapp:v2</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">startupProbe:</span></span><br><span class="line">           <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">           <span class="attr">initialDelaySeconds:</span> <span class="number">20</span></span><br><span class="line">           <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br><span class="line">           <span class="attr">httpGet:</span></span><br><span class="line">             <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">             <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">             <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">           <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">           <span class="attr">initialDelaySeconds:</span> <span class="number">20</span></span><br><span class="line">           <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br><span class="line">           <span class="attr">httpGet:</span></span><br><span class="line">             <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">             <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">             <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">           <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">           <span class="attr">initialDelaySeconds:</span> <span class="number">20</span></span><br><span class="line">           <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br><span class="line">           <span class="attr">httpGet:</span></span><br><span class="line">             <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">             <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">             <span class="attr">path:</span> <span class="string">/</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 replicasettest]# kubectl apply -f deploy-demo.yaml</span><br><span class="line">deployment.apps/myapp-v1 configured</span><br></pre></td></tr></table></figure>
<ul>
<li>打开新的终端，看pod更新过程<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 probe1test]# kubectl get pods -l app=myapp -w</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">myapp-v1-86b9dddd9b-k7rzf   1/1     Running   0          58s</span><br><span class="line">myapp-v1-86b9dddd9b-l44mj   1/1     Running   0          58s</span><br><span class="line">myapp-v1-86b9dddd9b-xcpfd   1/1     Running   0          58s</span><br><span class="line">############ recreate，直接把pod全部删除，在新建</span><br><span class="line">myapp-v1-86b9dddd9b-xcpfd   1/1     Terminating   0          64s</span><br><span class="line">myapp-v1-86b9dddd9b-k7rzf   1/1     Terminating   0          64s</span><br><span class="line">myapp-v1-86b9dddd9b-l44mj   1/1     Terminating   0          64s</span><br><span class="line">myapp-v1-86b9dddd9b-l44mj   1/1     Terminating   0          65s</span><br><span class="line">myapp-v1-86b9dddd9b-k7rzf   1/1     Terminating   0          65s</span><br><span class="line">myapp-v1-86b9dddd9b-xcpfd   1/1     Terminating   0          65s</span><br><span class="line">myapp-v1-86b9dddd9b-l44mj   0/1     Terminating   0          65s</span><br><span class="line">myapp-v1-86b9dddd9b-k7rzf   0/1     Terminating   0          65s</span><br><span class="line">myapp-v1-86b9dddd9b-xcpfd   0/1     Terminating   0          65s</span><br><span class="line">myapp-v1-7d4c7ddb79-l7g8t   0/1     Pending       0          0s</span><br><span class="line">myapp-v1-7d4c7ddb79-vzmzh   0/1     Pending       0          0s</span><br><span class="line">myapp-v1-7d4c7ddb79-l7g8t   0/1     Pending       0          0s</span><br><span class="line">myapp-v1-7d4c7ddb79-97fjd   0/1     Pending       0          0s</span><br><span class="line">myapp-v1-86b9dddd9b-l44mj   0/1     Terminating   0          66s</span><br><span class="line">myapp-v1-7d4c7ddb79-vzmzh   0/1     Pending       0          0s</span><br><span class="line">myapp-v1-7d4c7ddb79-97fjd   0/1     Pending       0          0s</span><br><span class="line">myapp-v1-86b9dddd9b-l44mj   0/1     Terminating   0          66s</span><br><span class="line">myapp-v1-7d4c7ddb79-l7g8t   0/1     ContainerCreating   0          0s</span><br><span class="line">myapp-v1-86b9dddd9b-l44mj   0/1     Terminating         0          66s</span><br><span class="line">myapp-v1-7d4c7ddb79-97fjd   0/1     ContainerCreating   0          0s</span><br><span class="line">myapp-v1-7d4c7ddb79-vzmzh   0/1     ContainerCreating   0          0s</span><br><span class="line">myapp-v1-86b9dddd9b-xcpfd   0/1     Terminating         0          66s</span><br><span class="line">myapp-v1-86b9dddd9b-xcpfd   0/1     Terminating         0          66s</span><br><span class="line">myapp-v1-86b9dddd9b-xcpfd   0/1     Terminating         0          66s</span><br><span class="line">myapp-v1-86b9dddd9b-k7rzf   0/1     Terminating         0          66s</span><br><span class="line">myapp-v1-86b9dddd9b-k7rzf   0/1     Terminating         0          67s</span><br><span class="line">myapp-v1-86b9dddd9b-k7rzf   0/1     Terminating         0          67s</span><br><span class="line">myapp-v1-7d4c7ddb79-l7g8t   0/1     ContainerCreating   0          1s</span><br><span class="line">myapp-v1-7d4c7ddb79-vzmzh   0/1     ContainerCreating   0          1s</span><br><span class="line">myapp-v1-7d4c7ddb79-97fjd   0/1     ContainerCreating   0          1s</span><br><span class="line">myapp-v1-7d4c7ddb79-97fjd   0/1     Running             0          2s</span><br><span class="line">myapp-v1-7d4c7ddb79-l7g8t   0/1     Running             0          2s</span><br><span class="line">myapp-v1-7d4c7ddb79-vzmzh   0/1     Running             0          3s</span><br><span class="line">myapp-v1-7d4c7ddb79-l7g8t   0/1     Running             0          25s</span><br><span class="line">myapp-v1-7d4c7ddb79-vzmzh   0/1     Running             0          25s</span><br><span class="line">myapp-v1-7d4c7ddb79-l7g8t   1/1     Running             0          25s</span><br><span class="line">myapp-v1-7d4c7ddb79-vzmzh   1/1     Running             0          25s</span><br><span class="line">myapp-v1-7d4c7ddb79-97fjd   1/1     Running             0          25s</span><br></pre></td></tr></table></figure>
<blockquote>
<p>总结：recreate这种更新策略，会把之前的所有pod都删除，再创建新的pod，风险很大</p>
</blockquote>
</li>
</ul>
<h3 id="生产环境如何实现蓝绿部署？"><a href="#生产环境如何实现蓝绿部署？" class="headerlink" title="生产环境如何实现蓝绿部署？"></a>生产环境如何实现蓝绿部署？</h3><h4 id="1、什么是蓝绿部署？"><a href="#1、什么是蓝绿部署？" class="headerlink" title="1、什么是蓝绿部署？"></a>1、什么是蓝绿部署？</h4><p>蓝绿部署中，一共有两套系统：一套是正在提供服务系统，标记为“绿色”；另一套是准备发布的系统，标记为“蓝色”。两套系统都是功能完善的、正在运行的系统，只是系统版本和对外服务情况不同。<br>开发新版本，要用新版本替换线上的旧版本，在线上的系统之外，搭建了一个使用新版本代码的全新系统。 这时候，一共有两套系统在运行，正在对外提供服务的老系统是绿色系统，新部署的系统是蓝色系统。<br><img src="/../../../../images/k8s/js21/img_3.png" alt="img_3.png"><br>蓝色系统不对外提供服务，用来做什么呢？<br>用来做发布前测试，测试过程中发现任何问题，可以直接在蓝色系统上修改，不干扰用户正在使用的系统。（注意，两套系统没有耦合的时候才能百分百保证不干扰）<br>蓝色系统经过反复的测试、修改、验证，确定达到上线标准之后，直接将用户切换到蓝色系统：<br><img src="/../../../../images/k8s/js21/img_4.png" alt="img_4.png"><br>切换后的一段时间内，依旧是蓝绿两套系统并存，但是用户访问的已经是蓝色系统。这段时间内观察蓝色系统（新系统）工作状态，如果出现问题，直接切换回绿色系统。</p>
<p>当确信对外提供服务的蓝色系统工作正常，不对外提供服务的绿色系统已经不再需要的时候，蓝色系统正式成为对外提供服务系统，成为新的绿色系统。 原先的绿色系统可以销毁，将资源释放出来，用于部署下一个蓝色系统。</p>
<h4 id="2、蓝绿部署的优势和缺点"><a href="#2、蓝绿部署的优势和缺点" class="headerlink" title="2、蓝绿部署的优势和缺点"></a>2、蓝绿部署的优势和缺点</h4><p>优点：<br>1、更新过程无需停机，风险较少<br>2、回滚方便，只需要更改路由或者切换DNS服务器，效率较高<br>缺点：<br>1、成本较高，需要部署两套环境。如果新版本中基础服务出现问题，会瞬间影响全网用户；如果新版本有问题也会影响全网用户。<br>2、需要部署两套机器，费用开销大<br>3、在非隔离的机器（Docker、VM）上操作时，可能会导致蓝绿环境被摧毁风险<br>4、负载均衡器&#x2F;反向代理&#x2F;路由&#x2F;DNS处理不当，将导致流量没有切换过来情况出现</p>
<h4 id="通过k8s实现线上业务的蓝绿部署"><a href="#通过k8s实现线上业务的蓝绿部署" class="headerlink" title="通过k8s实现线上业务的蓝绿部署"></a>通过k8s实现线上业务的蓝绿部署</h4><ul>
<li>下面实验需要的镜像包在课件，把镜像压缩包上传到k8s的各个工作节点，ctr -n&#x3D;k8s.io images import解压：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-22 ~]# ctr -n=k8s.io images import myapp-lan.tar.gz</span><br><span class="line">[root@centos07-22 ~]# ctr -n=k8s.io images import myapp-lv.tar.gz</span><br><span class="line">[root@centos07-62 ~]# ctr -n=k8s.io images import myapp-lan.tar.gz</span><br><span class="line">[root@centos07-62 ~]# ctr -n=k8s.io images import myapp-lv.tar.gz</span><br></pre></td></tr></table></figure></li>
<li>Kubernetes不支持内置的蓝绿部署。目前最好的方式是创建新的deployment，然后更新应用程序的service以指向新的deployment部署的应用</li>
</ul>
<h4 id="1-创建绿色部署环境（基于第一版代码做的镜像运行的pod）"><a href="#1-创建绿色部署环境（基于第一版代码做的镜像运行的pod）" class="headerlink" title="1.创建绿色部署环境（基于第一版代码做的镜像运行的pod）"></a>1.创建绿色部署环境（基于第一版代码做的镜像运行的pod）</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat  lv.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-v1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">blue-green</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">v2</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">janakiramm/myapp:v2</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<ul>
<li>可以使用kubectl命令创建部署<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 probe1test]# kubectl create ns blue-green</span><br><span class="line">namespace/blue-green created</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 replicasettest]# kubectl apply -f lv.yaml</span><br><span class="line">deployment.apps/myapp-v1 created</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 probe1test]# kubectl get pods -n blue-green</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">myapp-v1-7b77cfb74f-jj486   1/1     Running   0          20s</span><br><span class="line">myapp-v1-7b77cfb74f-kpxrj   1/1     Running   0          20s</span><br><span class="line">myapp-v1-7b77cfb74f-snxq7   1/1     Running   0          20s</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 probe1test]# kubectl get pods -n blue-green --show-labels</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">myapp-v1-7b77cfb74f-jj486   1/1     Running   0          42s   app=myapp,pod-template-hash=7b77cfb74f,version=v2</span><br><span class="line">myapp-v1-7b77cfb74f-kpxrj   1/1     Running   0          42s   app=myapp,pod-template-hash=7b77cfb74f,version=v2</span><br><span class="line">myapp-v1-7b77cfb74f-snxq7   1/1     Running   0          42s   app=myapp,pod-template-hash=7b77cfb74f,version=v2</span><br></pre></td></tr></table></figure></li>
<li>创建前端service<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat service_lanlv.yaml </span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-lan-lv</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">blue-green</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30062</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v2</span></span><br></pre></td></tr></table></figure></li>
<li>更新服务：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 probe1test]# kubectl apply -f service_lanlv.yaml</span><br><span class="line">service/myapp-lan-lv created</span><br></pre></td></tr></table></figure></li>
<li>前端服务<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 probe1test]# kubectl  get svc -n blue-green -owide</span><br><span class="line">NAME           TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE     SELECTOR</span><br><span class="line">myapp-lan-lv   NodePort   10.107.103.219   &lt;none&gt;        80:30062/TCP   3m31s   app=myapp,version=v2</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 probe1test]# kubectl describe  svc  myapp-lan-lv -n blue-green</span><br><span class="line">Name:                     myapp-lan-lv</span><br><span class="line">Namespace:                blue-green</span><br><span class="line">Labels:                   app=myapp</span><br><span class="line">Annotations:              &lt;none&gt;</span><br><span class="line">Selector:                 app=myapp,version=v2</span><br><span class="line">Type:                     NodePort</span><br><span class="line">IP Family Policy:         SingleStack</span><br><span class="line">IP Families:              IPv4</span><br><span class="line">IP:                       10.107.103.219</span><br><span class="line">IPs:                      10.107.103.219</span><br><span class="line">Port:                     http  80/TCP</span><br><span class="line">TargetPort:               80/TCP</span><br><span class="line">NodePort:                 http  30062/TCP</span><br><span class="line">Endpoints:                10.244.193.166:80,10.244.250.248:80,10.244.250.249:80</span><br><span class="line">Session Affinity:         None</span><br><span class="line">External Traffic Policy:  Cluster</span><br><span class="line">Events:                   &lt;none&gt;</span><br></pre></td></tr></table></figure></li>
<li>在浏览器访问<a target="_blank" rel="noopener" href="http://k8s-master节点ip:30062/">http://k8s-master节点ip:30062</a> 显示如下：<br><img src="/../../../../images/k8s/js21/img_5.png" alt="img_5.png"></li>
</ul>
<h4 id="2-创建蓝色部署环境（新上线的环境，要替代绿色环境）"><a href="#2-创建蓝色部署环境（新上线的环境，要替代绿色环境）" class="headerlink" title="2.创建蓝色部署环境（新上线的环境，要替代绿色环境）"></a>2.创建蓝色部署环境（新上线的环境，要替代绿色环境）</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat  lan.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-lan-lv</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">blue-green</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30062</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v1</span></span><br></pre></td></tr></table></figure>
<ul>
<li>然后可以使用kubectl命令创建部署。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 probe1test]# kubectl apply -f lan.yaml</span><br><span class="line">deployment.apps/myapp-v2 created</span><br></pre></td></tr></table></figure></li>
<li>service 从 v2 变 v1<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 replicasettest]# kubectl get svc -n blue-green -owide</span><br><span class="line">NAME           TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE   SELECTOR</span><br><span class="line">myapp-lan-lv   NodePort   10.107.103.219   &lt;none&gt;        80:30062/TCP   36m   app=myapp,version=v2</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 replicasettest]# kubectl get svc -n blue-green -owide</span><br><span class="line">NAME           TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE   SELECTOR</span><br><span class="line">myapp-lan-lv   NodePort   10.107.103.219   &lt;none&gt;        80:30062/TCP   36m   app=myapp,version=v1</span><br></pre></td></tr></table></figure></li>
<li>在浏览器访问<a target="_blank" rel="noopener" href="http://k8s-master节点ip:30062/">http://k8s-master节点ip:30062</a> 显示如下：<br><img src="/../../../../images/k8s/js21/img_6.png" alt="img_6.png"></li>
</ul>
<h4 id="3-实验完成之后，把资源先删除，以免影响后面实验"><a href="#3-实验完成之后，把资源先删除，以免影响后面实验" class="headerlink" title="3.实验完成之后，把资源先删除，以免影响后面实验"></a>3.实验完成之后，把资源先删除，以免影响后面实验</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 replicasettest]# kubectl delete -f lan.yaml</span><br><span class="line">deployment.apps &quot;myapp-v2&quot; deleted</span><br><span class="line"></span><br><span class="line">[root@centos07-12 replicasettest]# kubectl delete -f lv.yaml</span><br><span class="line">deployment.apps &quot;myapp-v1&quot; deleted</span><br><span class="line"></span><br><span class="line">[root@centos07-12 replicasettest]# kubectl delete -f service_lanlv.yaml</span><br><span class="line">service &quot;myapp-lan-lv&quot; deleted</span><br></pre></td></tr></table></figure>
<h3 id="通过k8s完成线上业务的金丝雀发布"><a href="#通过k8s完成线上业务的金丝雀发布" class="headerlink" title="通过k8s完成线上业务的金丝雀发布"></a>通过k8s完成线上业务的金丝雀发布</h3><h4 id="1、金丝雀发布简介"><a href="#1、金丝雀发布简介" class="headerlink" title="1、金丝雀发布简介"></a>1、金丝雀发布简介</h4><p>金丝雀发布的由来：17 世纪，英国矿井工人发现，金丝雀对瓦斯这种气体十分敏感。空气中哪怕有极其微量的瓦斯，金丝雀也会停止歌唱；当瓦斯含量超过一定限度时，虽然人类毫无察觉，金丝雀却早已毒发身亡。当时在采矿设备相对简陋的条件下，工人们每次下井都会带上一只金丝雀作为瓦斯检测指标，以便在危险状况下紧急撤离。<br>金丝雀发布（又称灰度发布、灰度更新）：金丝雀发布一般先发1台，或者一个小比例，例如2%的服务器，主要做流量验证用，也称为金丝雀 (Canary) 测试 （国内常称灰度测试）。</p>
<p>100个pod:<br>   更新了一个pod：用的新的代码做的镜像<br>    99个pod：没有更新</p>
<p>简单的金丝雀测试一般通过手工测试验证，复杂的金丝雀测试需要比较完善的监控基础设施配合，通过监控指标反馈，观察金丝雀的健康状况，作为后续发布或回退的依据。 如果金丝测试通过，则把剩余的V1版本全部升级为V2版本。如果金丝雀测试失败，则直接回退金丝雀，发布失败。<br><img src="/../../../../images/k8s/js21/img_7.png" alt="img_7.png"><br>优点：灵活，策略自定义，可以按照流量或具体的内容进行灰度(比如不同账号，不同参数)，出现问题不会影响全网用户<br>缺点：没有覆盖到所有的用户导致出现问题不好排查</p>
<h4 id="2、在k8s中实现金丝雀发布"><a href="#2、在k8s中实现金丝雀发布" class="headerlink" title="2、在k8s中实现金丝雀发布"></a>2、在k8s中实现金丝雀发布</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat lv.yaml</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-v1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">blue-green</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">v2</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">janakiramm/myapp:v2</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<ul>
<li>打开一个标签1监测更新过程 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 replicasettest]# kubectl apply -f lv.yaml</span><br><span class="line">deployment.apps/myapp-v1 created</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 ~]# kubectl get pods -l app=myapp -n blue-green -w -owide --show-labels</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE     IP               NODE          NOMINATED NODE   READINESS GATES   LABELS</span><br><span class="line">myapp-v1-7b77cfb74f-69pk6   1/1     Running   0          2m19s   10.244.193.170   centos07-22   &lt;none&gt;           &lt;none&gt;            app=myapp,pod-template-hash=7b77cfb74f,version=v2</span><br><span class="line">myapp-v1-7b77cfb74f-mbw6s   1/1     Running   0          2m19s   10.244.250.254   centos07-62   &lt;none&gt;           &lt;none&gt;            app=myapp,pod-template-hash=7b77cfb74f,version=v2</span><br><span class="line">myapp-v1-7b77cfb74f-p9pkk   1/1     Running   0          2m19s   10.244.250.253   centos07-62   &lt;none&gt;           &lt;none&gt;            app=myapp,pod-template-hash=7b77cfb74f,version=v2</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 ~]# kubectl get deploy -n blue-green -owide</span><br><span class="line">NAME       READY   UP-TO-DATE   AVAILABLE   AGE     CONTAINERS   IMAGES                SELECTOR</span><br><span class="line">myapp-v1   3/3     3            3           3m20s   myapp        janakiramm/myapp:v2   app=myapp,version=v2</span><br></pre></td></tr></table></figure></li>
<li>打开另一个标签2执行如下操作： <blockquote>
<p>kubectl set image deployment myapp-v1(deploy名称) myapp(container名)&#x3D;docker.io&#x2F;library&#x2F;nginx:latest -n blue-green &amp;&amp; kubectl rollout pause deployment myapp-v1 -n blue-green</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 replicasettest]# kubectl set image deployment myapp-v1 myapp=docker.io/library/nginx:latest -n blue-green &amp;&amp; kubectl rollout pause deployment myapp-v1 -n blue-green</span><br><span class="line">deployment.apps/myapp-v1 image updated</span><br><span class="line">deployment.apps/myapp-v1 paused</span><br></pre></td></tr></table></figure></li>
<li>回到标签1观察，显示如下：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 ~]# kubectl get pods  -n blue-green -w</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">myapp-v1-7b77cfb74f-69pk6   1/1     Running   0          6m22s</span><br><span class="line">myapp-v1-7b77cfb74f-mbw6s   1/1     Running   0          6m22s</span><br><span class="line">myapp-v1-7b77cfb74f-p9pkk   1/1     Running   0          6m22s</span><br><span class="line">######## 创建了一个pods，使用的是nginx镜像</span><br><span class="line">myapp-v1-6bb9cb95bd-n54f9   0/1     Pending   0          0s</span><br><span class="line">myapp-v1-6bb9cb95bd-n54f9   0/1     Pending   0          0s</span><br><span class="line">myapp-v1-6bb9cb95bd-n54f9   0/1     ContainerCreating   0          0s</span><br><span class="line">myapp-v1-6bb9cb95bd-n54f9   0/1     ContainerCreating   0          1s</span><br><span class="line">myapp-v1-6bb9cb95bd-n54f9   1/1     Running             0          2s</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注：上面的解释说明把myapp这个容器的镜像更新到docker.io&#x2F;xianchao&#x2F;nginx:v1版本 更新镜像之后，创建一个新的pod就立即暂停，这就是我们说的金丝雀发布；如果暂停几个小时之后没有问题，那么取消暂停，就会依次执行后面步骤，把所有pod都升级。</p>
</blockquote>
</li>
<li>回到标签1继续观察：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 ~]# kubectl get pods  -n blue-green -w</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">myapp-v1-6bb9cb95bd-n54f9   1/1     Running   0          4m7s</span><br><span class="line">myapp-v1-7b77cfb74f-69pk6   1/1     Running   0          11m</span><br><span class="line">myapp-v1-7b77cfb74f-mbw6s   1/1     Running   0          11m</span><br><span class="line">myapp-v1-7b77cfb74f-p9pkk   1/1     Running   0          11m</span><br></pre></td></tr></table></figure></li>
<li>解除暂停：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 replicasettest]# kubectl rollout resume deployment myapp-v1 -n blue-green</span><br><span class="line">deployment.apps/myapp-v1 resumed</span><br></pre></td></tr></table></figure></li>
<li>在标签1可以看到如下一些信息，下面过程是把余下的pod里的容器都更的版本：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 ~]# kubectl get pods  -n blue-green -w</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">myapp-v1-6bb9cb95bd-n54f9   1/1     Running   0          4m7s</span><br><span class="line">myapp-v1-7b77cfb74f-69pk6   1/1     Running   0          11m</span><br><span class="line">myapp-v1-7b77cfb74f-mbw6s   1/1     Running   0          11m</span><br><span class="line">myapp-v1-7b77cfb74f-p9pkk   1/1     Running   0          11m</span><br><span class="line"></span><br><span class="line">####### 有个细节就是：会先创建新pod，后删除老pod</span><br><span class="line">myapp-v1-7b77cfb74f-p9pkk   1/1     Terminating   0          12m</span><br><span class="line">myapp-v1-6bb9cb95bd-xlp9l   0/1     Pending       0          0s</span><br><span class="line">myapp-v1-6bb9cb95bd-xlp9l   0/1     Pending       0          0s</span><br><span class="line">myapp-v1-6bb9cb95bd-xlp9l   0/1     ContainerCreating   0          0s</span><br><span class="line">myapp-v1-7b77cfb74f-p9pkk   1/1     Terminating         0          12m</span><br><span class="line">myapp-v1-6bb9cb95bd-xlp9l   0/1     ContainerCreating   0          1s</span><br><span class="line">myapp-v1-7b77cfb74f-p9pkk   0/1     Terminating         0          12m</span><br><span class="line">myapp-v1-7b77cfb74f-p9pkk   0/1     Terminating         0          12m</span><br><span class="line">myapp-v1-7b77cfb74f-p9pkk   0/1     Terminating         0          12m</span><br><span class="line">myapp-v1-7b77cfb74f-p9pkk   0/1     Terminating         0          12m</span><br><span class="line">myapp-v1-6bb9cb95bd-xlp9l   1/1     Running             0          2s</span><br><span class="line">myapp-v1-7b77cfb74f-69pk6   1/1     Terminating         0          12m</span><br><span class="line">myapp-v1-6bb9cb95bd-vzdt5   0/1     Pending             0          0s</span><br><span class="line">myapp-v1-6bb9cb95bd-vzdt5   0/1     Pending             0          0s</span><br><span class="line">myapp-v1-6bb9cb95bd-vzdt5   0/1     ContainerCreating   0          0s</span><br><span class="line">myapp-v1-7b77cfb74f-69pk6   1/1     Terminating         0          12m</span><br><span class="line">myapp-v1-6bb9cb95bd-vzdt5   0/1     ContainerCreating   0          1s</span><br><span class="line">myapp-v1-7b77cfb74f-69pk6   0/1     Terminating         0          12m</span><br><span class="line">myapp-v1-7b77cfb74f-69pk6   0/1     Terminating         0          12m</span><br><span class="line">myapp-v1-7b77cfb74f-69pk6   0/1     Terminating         0          12m</span><br><span class="line">myapp-v1-7b77cfb74f-69pk6   0/1     Terminating         0          12m</span><br><span class="line">myapp-v1-6bb9cb95bd-vzdt5   1/1     Running             0          2s</span><br><span class="line">myapp-v1-7b77cfb74f-mbw6s   1/1     Terminating         0          12m</span><br><span class="line">myapp-v1-7b77cfb74f-mbw6s   1/1     Terminating         0          12m</span><br><span class="line">myapp-v1-7b77cfb74f-mbw6s   0/1     Terminating         0          12m</span><br><span class="line">myapp-v1-7b77cfb74f-mbw6s   0/1     Terminating         0          12m</span><br><span class="line">myapp-v1-7b77cfb74f-mbw6s   0/1     Terminating         0          12m</span><br><span class="line">myapp-v1-7b77cfb74f-mbw6s   0/1     Terminating         0          12m</span><br></pre></td></tr></table></figure></li>
<li>可以看到replicaset控制器有2个了<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 replicasettest]# kubectl get replicaset  -n blue-green</span><br><span class="line">NAME                  DESIRED   CURRENT   READY   AGE</span><br><span class="line">myapp-v1-6bb9cb95bd   3         3         3       7m50s</span><br><span class="line">myapp-v1-7b77cfb74f   0         0         0       15m</span><br></pre></td></tr></table></figure></li>
<li>3层结构<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@centos07-12 replicasettest]# kubectl get deploy -n blue-green</span><br><span class="line">NAME       READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">myapp-v1   3/3     3            3           17m</span><br><span class="line">[root@centos07-12 replicasettest]# kubectl get replicaset -n blue-green</span><br><span class="line">NAME                  DESIRED   CURRENT   READY   AGE</span><br><span class="line">myapp-v1-6bb9cb95bd   3         3         3       9m42s</span><br><span class="line">myapp-v1-7b77cfb74f   0         0         0       17m</span><br><span class="line">[root@centos07-12 replicasettest]# kubectl get pods -n blue-green</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">myapp-v1-6bb9cb95bd-n54f9   1/1     Running   0          9m49s</span><br><span class="line">myapp-v1-6bb9cb95bd-vzdt5   1/1     Running   0          5m6s</span><br><span class="line">myapp-v1-6bb9cb95bd-xlp9l   1/1     Running   0          5m8s</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="使用kubectl命令修改deployment"><a href="#使用kubectl命令修改deployment" class="headerlink" title="使用kubectl命令修改deployment"></a>使用kubectl命令修改deployment</h3><ul>
<li>kubectl scale deployment myapp-v1  –replicas&#x3D;3    修改副本数</li>
<li>kubectl create -f xxx.yaml 和 kubectl apply -f xxx.yaml    都是创建，create不能运行多次，多次出错；apply 可以运行多次</li>
<li>kubectl edit deployment myapp-v1  修改副本数，执行后弹出deployment的配置页面，修改配置页面，保存后，直接生效</li>
<li>版本回退： kubectl rollout：版本升级相关功能，支持下面的选项：<br>status：显示当前升级状态<br>history：显示升级历史记录<br>pause：暂停版本升级过程<br>resume：继续已经暂停的版本升级过程<br>restart：重启版本升级过程<br>undo：回滚到上一级版本（可以使用–to-revision回滚到指定版本）</li>
</ul>
<p>kubectl rollout status deploy myapp-v1<br>kubectl rollout history deploy myapp-v1 -n default<br>kubectl rollout undo deployment  myapp-v1  –to-revision&#x3D;1 -n default</p>
<ul>
<li>金丝雀发布(灰度发布): Deployment控制器支持控制更新过程中的控制，如暂停(pause)或继续(resume)更新操作。<br>kubectl set image deploy myapp-v1 nginx&#x3D;nginx:1.17.4 -n dev &amp;&amp; kubectl rollout pause deployment myapp-v1 -n dev</li>
<li>观察更新状态<br>kubectl rollout status deploy pc-deployment -n dev</li>
<li>监控更新的过程<br>kubectl get rs -n dev -o wide</li>
<li>继续更新<br>kubectl rollout resume deploy pc-deployment -n dev</li>
<li>删除 Deployment<br>kubectl delete -f pc-deployment.yml</li>
</ul>
<h3 id="Deployment和ReplicaSet的区别"><a href="#Deployment和ReplicaSet的区别" class="headerlink" title="Deployment和ReplicaSet的区别"></a>Deployment和ReplicaSet的区别</h3><h4 id="1-ReplicaSet"><a href="#1-ReplicaSet" class="headerlink" title="1 ReplicaSet"></a>1 ReplicaSet</h4><p>核心作用在于帮助用户创建指定数量的pod副本，并确保pod副本一直处于满足用户期望的数量，起到多退少补的作用，并且还具有自动扩容缩容等机制<br>主要由三个部分组成<br>用户期望的pod副本数：用来定义由这个控制器管控的pod副本有几个<br>标签选择器：当pod挂掉的时候，replicaset就通过标签选择器，选择指定标签的pod模板，再通过pod模板创建pod。<br>pod资源模板：定义一个Pod模板，且需要给pod模板设置标签。给标签选择器使用</p>
<h4 id="2-Deployment"><a href="#2-Deployment" class="headerlink" title="2 Deployment"></a>2 Deployment</h4><p>ReplicaSet并不是我们直接使用的控制器，kubernetes建议我们使用Deployment<br>Deployment控制器是工作在ReplicaSet之上的，Deployment通过控制ReplicaSet来控制pod，并不是直接控制pod。<br>Deployment有ReplicaSet的所有功能<br>Deployment支持自动扩容缩容，滚动更新和回滚等机制，并提供了一个声明式的定义功能，这种声明式定义使得我们将来创建资源时可以基于声明的逻辑来定义，我们那些所有定义的资源可以随时重新进行声明，随时改变我们在apiserver上的定义的目标期望状态，只要那些资源支持动态运行时修改，都能修改是帮我们管理无状态的应用的最好的控制器</p>

        
            <div id="toc-article">
                
  <div class="widget-wrap" id="toc-wrap">
    <h3 class="widget-title"><i class="fa fa-toc"></i> 文章目录</h3>
    <div class="widget">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Deployment%E6%8E%A7%E5%88%B6%E5%99%A8%EF%BC%9A%E6%A6%82%E5%BF%B5%E3%80%81%E5%8E%9F%E7%90%86%E8%A7%A3%E8%AF%BB"><span class="toc-text">Deployment控制器：概念、原理解读</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81Deployment%E6%A6%82%E8%BF%B0"><span class="toc-text">1、Deployment概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81Deployment%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%EF%BC%9A%E5%A6%82%E4%BD%95%E7%AE%A1%E7%90%86rs%E5%92%8CPod%EF%BC%9F"><span class="toc-text">2、Deployment工作原理：如何管理rs和Pod？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Deployment%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6%E7%BC%96%E5%86%99%E6%8A%80%E5%B7%A7"><span class="toc-text">Deployment资源清单文件编写技巧</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Deployment%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B%EF%BC%9A%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAweb%E7%AB%99%E7%82%B9"><span class="toc-text">Deployment使用案例：创建一个web站点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E7%94%A8deployment%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AApod"><span class="toc-text">1、用deployment创建一个pod</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E6%9B%B4%E6%96%B0%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6%EF%BC%9A"><span class="toc-text">2、更新资源清单文件：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81%E6%9F%A5%E7%9C%8Bdeploy%E7%8A%B6%E6%80%81%EF%BC%9A"><span class="toc-text">3、查看deploy状态：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81%E5%88%9B%E5%BB%BAdeploy%E7%9A%84%E6%97%B6%E5%80%99%E4%B9%9F%E4%BC%9A%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AArs%EF%BC%88replicaset%EF%BC%89%EF%BC%8C67fd9fc9c8-%E8%BF%99%E4%B8%AA%E9%9A%8F%E6%9C%BA%E6%95%B0%E5%AD%97%E6%98%AF%E6%88%91%E4%BB%AC%E5%BC%95%E7%94%A8pod%E7%9A%84%E6%A8%A1%E6%9D%BFtemplate%E7%9A%84%E5%90%8D%E5%AD%97%E7%9A%84hash%E5%80%BC"><span class="toc-text">4、创建deploy的时候也会创建一个rs（replicaset），67fd9fc9c8 这个随机数字是我们引用pod的模板template的名字的hash值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%E3%80%81%E8%AF%B7%E6%B3%A8%E6%84%8F%EF%BC%8CReplicaSet%E7%9A%84%E5%90%8D%E7%A7%B0%E5%A7%8B%E7%BB%88%E8%AE%BE%E7%BD%AE%E4%B8%BA-DEPLOYMENT-NAME-RANDOM-STRING-%E3%80%82RANDOM-STRING%E6%98%AF%E9%9A%8F%E6%9C%BA%E7%94%9F%E6%88%90%E7%9A%84"><span class="toc-text">5、请注意，ReplicaSet的名称始终设置为[DEPLOYMENT-NAME]-[RANDOM-STRING]。RANDOM-STRING是随机生成的</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6%E3%80%81%E6%9F%A5%E7%9C%8Bpod%E8%AF%A6%E6%83%85"><span class="toc-text">6、查看pod详情</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7%E3%80%81%E9%AA%8C%E8%AF%81%E8%AE%BF%E9%97%AE"><span class="toc-text">7、验证访问</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Deployment%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6%E8%AF%A6%E7%BB%86%E8%A7%A3%E8%AF%BB"><span class="toc-text">Deployment资源清单文件详细解读</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Deployment%E7%AE%A1%E7%90%86pod%EF%BC%9A%E6%89%A9%E5%AE%B9"><span class="toc-text">Deployment管理pod：扩容</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E9%80%9A%E8%BF%87deployment%E7%AE%A1%E7%90%86%E5%BA%94%E7%94%A8%EF%BC%8C%E5%AE%9E%E7%8E%B0%E6%89%A9%E5%AE%B9%EF%BC%8C%E6%8A%8A%E5%89%AF%E6%9C%AC%E6%95%B0%E5%8F%98%E6%88%903"><span class="toc-text">1、通过deployment管理应用，实现扩容，把副本数变成3</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E6%9F%A5%E7%9C%8Bpod%E7%9A%84%E6%83%85%E5%86%B5%EF%BC%8C%E6%96%B0%E5%A2%9Emyapp-v1-86b9dddd9b-2r6mk"><span class="toc-text">2、查看pod的情况，新增myapp-v1-86b9dddd9b-2r6mk</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81%E6%B3%A8%E6%84%8F%EF%BC%9Aapply%E4%B8%8D%E5%90%8C%E4%BA%8Ecreate%EF%BC%8Capply%E5%8F%AF%E4%BB%A5%E6%89%A7%E8%A1%8C%E5%A4%9A%E6%AC%A1%EF%BC%9Bcreate%E6%89%A7%E8%A1%8C%E4%B8%80%E6%AC%A1%EF%BC%8C%E5%86%8D%E6%89%A7%E8%A1%8C%E5%B0%B1%E4%BC%9A%E6%8A%A5%E9%94%99%E5%A4%8D%E3%80%82"><span class="toc-text">3、注意：apply不同于create，apply可以执行多次；create执行一次，再执行就会报错复。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0pod%E5%89%AF%E6%9C%AC%E6%95%B0%E5%8F%98%E6%88%90%E4%BA%863%E4%B8%AA"><span class="toc-text">4、可以看到pod副本数变成了3个</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%E3%80%81%E6%9F%A5%E7%9C%8Bmyapp-v1%E8%BF%99%E4%B8%AA%E6%8E%A7%E5%88%B6%E5%99%A8%E7%9A%84%E8%AF%A6%E7%BB%86%E4%BF%A1%E6%81%AF"><span class="toc-text">5、查看myapp-v1这个控制器的详细信息</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Deployment%E7%AE%A1%E7%90%86pod%EF%BC%9A%E7%BC%A9%E5%AE%B9"><span class="toc-text">Deployment管理pod：缩容</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E9%80%9A%E8%BF%87deployment%E7%AE%A1%E7%90%86%E5%BA%94%E7%94%A8%EF%BC%8C%E5%AE%9E%E7%8E%B0%E7%BC%A9%E5%AE%B9%EF%BC%8C%E6%8A%8A%E5%89%AF%E6%9C%AC%E6%95%B0%E5%8F%98%E6%88%902"><span class="toc-text">1、通过deployment管理应用，实现缩容，把副本数变成2</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87k8s%E5%AE%9E%E7%8E%B0%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B0"><span class="toc-text">通过k8s实现滚动更新</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B0%E7%AE%80%E4%BB%8B"><span class="toc-text">1、滚动更新简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E9%A6%96%E5%85%88%E7%9C%8B%E4%B8%8BDeployment%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1%E7%9A%84%E7%BB%84%E6%88%90%EF%BC%9A"><span class="toc-text">2、首先看下Deployment资源对象的组成：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81"><span class="toc-text">3、</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5"><span class="toc-text">自定义滚动更新策略</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AD%96%E7%95%A5%EF%BC%9A"><span class="toc-text">1、自定义策略：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E6%8A%8Apod%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5%E5%8F%98%E6%88%90Recreate"><span class="toc-text">2、把pod更新策略变成Recreate</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E8%93%9D%E7%BB%BF%E9%83%A8%E7%BD%B2%EF%BC%9F"><span class="toc-text">生产环境如何实现蓝绿部署？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AF%E8%93%9D%E7%BB%BF%E9%83%A8%E7%BD%B2%EF%BC%9F"><span class="toc-text">1、什么是蓝绿部署？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E8%93%9D%E7%BB%BF%E9%83%A8%E7%BD%B2%E7%9A%84%E4%BC%98%E5%8A%BF%E5%92%8C%E7%BC%BA%E7%82%B9"><span class="toc-text">2、蓝绿部署的优势和缺点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87k8s%E5%AE%9E%E7%8E%B0%E7%BA%BF%E4%B8%8A%E4%B8%9A%E5%8A%A1%E7%9A%84%E8%93%9D%E7%BB%BF%E9%83%A8%E7%BD%B2"><span class="toc-text">通过k8s实现线上业务的蓝绿部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%88%9B%E5%BB%BA%E7%BB%BF%E8%89%B2%E9%83%A8%E7%BD%B2%E7%8E%AF%E5%A2%83%EF%BC%88%E5%9F%BA%E4%BA%8E%E7%AC%AC%E4%B8%80%E7%89%88%E4%BB%A3%E7%A0%81%E5%81%9A%E7%9A%84%E9%95%9C%E5%83%8F%E8%BF%90%E8%A1%8C%E7%9A%84pod%EF%BC%89"><span class="toc-text">1.创建绿色部署环境（基于第一版代码做的镜像运行的pod）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%88%9B%E5%BB%BA%E8%93%9D%E8%89%B2%E9%83%A8%E7%BD%B2%E7%8E%AF%E5%A2%83%EF%BC%88%E6%96%B0%E4%B8%8A%E7%BA%BF%E7%9A%84%E7%8E%AF%E5%A2%83%EF%BC%8C%E8%A6%81%E6%9B%BF%E4%BB%A3%E7%BB%BF%E8%89%B2%E7%8E%AF%E5%A2%83%EF%BC%89"><span class="toc-text">2.创建蓝色部署环境（新上线的环境，要替代绿色环境）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%AE%9E%E9%AA%8C%E5%AE%8C%E6%88%90%E4%B9%8B%E5%90%8E%EF%BC%8C%E6%8A%8A%E8%B5%84%E6%BA%90%E5%85%88%E5%88%A0%E9%99%A4%EF%BC%8C%E4%BB%A5%E5%85%8D%E5%BD%B1%E5%93%8D%E5%90%8E%E9%9D%A2%E5%AE%9E%E9%AA%8C"><span class="toc-text">3.实验完成之后，把资源先删除，以免影响后面实验</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87k8s%E5%AE%8C%E6%88%90%E7%BA%BF%E4%B8%8A%E4%B8%9A%E5%8A%A1%E7%9A%84%E9%87%91%E4%B8%9D%E9%9B%80%E5%8F%91%E5%B8%83"><span class="toc-text">通过k8s完成线上业务的金丝雀发布</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E9%87%91%E4%B8%9D%E9%9B%80%E5%8F%91%E5%B8%83%E7%AE%80%E4%BB%8B"><span class="toc-text">1、金丝雀发布简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E5%9C%A8k8s%E4%B8%AD%E5%AE%9E%E7%8E%B0%E9%87%91%E4%B8%9D%E9%9B%80%E5%8F%91%E5%B8%83"><span class="toc-text">2、在k8s中实现金丝雀发布</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8kubectl%E5%91%BD%E4%BB%A4%E4%BF%AE%E6%94%B9deployment"><span class="toc-text">使用kubectl命令修改deployment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Deployment%E5%92%8CReplicaSet%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-text">Deployment和ReplicaSet的区别</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-ReplicaSet"><span class="toc-text">1 ReplicaSet</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-Deployment"><span class="toc-text">2 Deployment</span></a></li></ol></li></ol>
    </div>
  </div>


            </div>
        
<!--          -->
<!--           <blockquote id="copyright"> -->
<!--               <p>原文链接: <a href="https://dbbruce.github.io/2023/05/10/运维/K8S/基础/21-Deployment资源基本介绍/">https://dbbruce.github.io/2023/05/10/运维/K8S/基础/21-Deployment资源基本介绍/</a></p> -->
<!--               <p>版权声明: 转载请注明出处.</p> -->
<!--           </blockquote> -->
<!--          -->
      
    </div>
    <footer class="article-footer">
      
        <div class="article-tag-wrap">
          

          
          <!--  -->
<!--     <div class="social-share"> -->
<!--       <span>分享到:</span> -->
<!--     </div> -->
<!--  -->
<!--  -->

        </div>
      
      
        
<nav id="article-nav">
  
    <a href="/2023/05/10/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/20-replicaset%E8%B5%84%E6%BA%90/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">
        
          20-replicaset资源
        
      </div>
    </a>
  
  
    <a href="/2023/05/11/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/22-Service%E5%9B%9B%E5%B1%82%E4%BB%A3%E7%90%86%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">
        
          22-Service四层代理基本介绍
        
      </div>
    </a>
  
</nav>

      
      
        








      
    </footer>
  </div>
</article>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title"><i class="fa fa-posts"></i> 最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/06/28/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/058-model%E6%A0%A1%E9%AA%8C%E5%99%A8/">058-model校验器</a>
          </li>
        
          <li>
            <a href="/2025/06/27/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/057-%E5%85%83%E6%95%B0%E6%8D%AE%E4%BD%93%E7%B3%BB/">057-元数据体系</a>
          </li>
        
          <li>
            <a href="/2025/06/26/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/056-%E8%BF%90%E8%90%A5%E8%80%85%E6%A8%A1%E5%BC%8F/">056-运营者模式</a>
          </li>
        
          <li>
            <a href="/2025/06/24/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/055-%E5%BC%B9%E7%AA%97%E9%80%89%E6%8B%A9%E6%9D%A1%E4%BB%B6%E8%B0%83%E7%94%A8%E4%BA%91%E5%87%BD%E6%95%B0/">055-弹窗选择条件调用云函数</a>
          </li>
        
          <li>
            <a href="/2025/06/23/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/054-%E7%BB%84%E7%BB%87%E4%BA%BA%E4%BA%8B%E7%AC%94%E8%AE%B0/">054-组织人事笔记</a>
          </li>
        
      </ul>
    </div>
  </div>


  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title"><i class="fa fa-classify"></i> 分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/GO%E8%AF%AD%E8%A8%80/">GO语言</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/GO%E8%AF%AD%E8%A8%80/%E5%9F%BA%E7%A1%80/">基础</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python%E5%9F%BA%E7%A1%80/">Python基础</a><span class="category-list-count">21</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Python%E5%9F%BA%E7%A1%80/Django/">Django</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python%E5%9F%BA%E7%A1%80/%E5%8C%85%E6%96%B9%E6%B3%95/">包方法</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python%E5%9F%BA%E7%A1%80/%E5%9F%BA%E7%A1%80/">基础</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python%E5%9F%BA%E7%A1%80/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/">异步编程</a><span class="category-list-count">12</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/git/%E5%9F%BA%E7%A1%80/">基础</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a><span class="category-list-count">24</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/odoo/">odoo</a><span class="category-list-count">11</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/odoo/%E5%9F%BA%E7%A1%80/">基础</a><span class="category-list-count">11</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AF%8F%E6%9C%88%E6%A6%82%E8%A6%81/">每月概要</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AF%8F%E6%9C%88%E6%A6%82%E8%A6%81/2023/">2023</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AF%8F%E6%9C%88%E6%A6%82%E8%A6%81/2025/">2025</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/">爬虫类</a><span class="category-list-count">28</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E5%8F%8D%E7%88%AC/">反爬</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E5%9F%BA%E7%A1%80/">基础</a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E7%BC%96%E7%A0%81/">编码</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BD%91%E7%BB%9C/%E5%BC%82%E5%B8%B8/">异常</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/">运维</a><span class="category-list-count">197</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/Git/">Git</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/Java%E7%94%9F%E6%80%81/">Java生态</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/K8S/">K8S</a><span class="category-list-count">48</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/">基础</a><span class="category-list-count">45</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/K8S/%E9%94%99%E8%AF%AF/">错误</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/K8S/%E9%A1%B9%E7%9B%AE%E6%B1%87%E6%80%BB/">项目汇总</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/docker/">docker</a><span class="category-list-count">22</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/">基础</a><span class="category-list-count">20</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/docker/%E9%94%99%E8%AF%AF%E9%9B%86%E9%94%A6/">错误集锦</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/grafana/">grafana</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/">linux云计算基础教程</a><span class="category-list-count">63</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/memcached/">memcached</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/nginx/">nginx</a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/zabbix/">zabbix</a><span class="category-list-count">19</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/zabbix/5-0LTS/">5.0LTS</a><span class="category-list-count">19</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/">常用工具</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/%E6%8A%93%E5%8C%85%E5%B7%A5%E5%85%B7/">抓包工具</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E4%B8%80%E4%BA%9B%E6%8A%80%E5%B7%A7%E5%92%8C%E5%B8%B8%E8%AF%86/">运维一些技巧和常识</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/">问题处理</a><span class="category-list-count">5</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%A2%E8%AF%95/">面试</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%A2%E8%AF%95/%E9%A2%98/">题</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%A1%B9%E7%9B%AE/">项目</a><span class="category-list-count">84</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/">HCM教程</a><span class="category-list-count">59</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/">医药公司ERP</a><span class="category-list-count">25</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/%E4%B8%9A%E5%8A%A1/">业务</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/%E5%9F%BA%E7%A1%80/">基础</a><span class="category-list-count">3</span></li></ul></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title"><i class="fa fa-archive"></i> 归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/">2025年</a><span class="archive-list-count">63</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/">2023年</a><span class="archive-list-count">135</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/">2022年</a><span class="archive-list-count">40</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/">2021年</a><span class="archive-list-count">107</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020年</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/">2018年</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/">2017年</a><span class="archive-list-count">23</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2000/">2000年</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>


  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title"><i class="fa fa-link"></i> 友情链接</h3>
    <div class="widget">
      <ul>
      
        <li>
          <a href="https://dbbruce.github.io/">董迟钝的Blog</a>
        </li>
      
      </ul>
    </div>
  </div>


  
</aside>
        
      </div>
      <a id="totop" href="#top"></a>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
<!--       <p> -->
<!--         <a href="/sitemap.xml">网站地图</a> -->
<!--         <span> | </span><a href="/atom.xml">订阅本站</a> -->
<!--         <span> | </span><a href="/about/">联系博主</a> -->
<!--       </p> -->
<!--        -->
<!--         <p> -->
<!--           <i class="fa fa-visitors"></i> -->
<!--           <i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i> -->
<!--           ， -->
<!--           <i class="fa fa-views"></i> -->
<!--           <i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i> -->
<!--         </p> -->
<!--        -->
<!--       <p> -->
        <span>Copyright &copy; 2025 DB Bruce. 董勉的技术博客  https://dbbruce.github.io</span>
<!--         <span>Theme by <a href="https://github.com/chaooo/hexo-theme-BlueLake/" target="_blank">BlueLake.</a></span> -->
<!--         <span>Powered by <a href="https://hexo.io/" target="_blank">Hexo.</a></span> -->
<!--       </p> -->
    </div>
  </div>
</footer>

    </div>
  </div>
  
<script src="/js/jquery-3.4.1.min.js"></script>


<script src="/js/search.json.js"></script>


  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>






  
<script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<!--  -->
<!--    -->
<!--     
<script src="/localshare/js/social-share.js"></script>
 -->
<!--     
<script src="/localshare/js/qrcode.js"></script>
 -->
<!--    -->
<!--    -->
<!--  -->


  

  

  

  

  

  

  

  
  





</body>
</html>