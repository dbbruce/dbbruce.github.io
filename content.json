{"meta":{"title":"董勉 | 技术博客 | 成功的秘诀在于耐心和求胜心.","subtitle":"此生当克己勤免，自强不息 .","description":"桑弧蓬矢","author":"DB Bruce","url":"https://dbbruce.github.io","root":"/"},"pages":[{"title":"about","date":"2023-08-09T14:40:17.000Z","updated":"2023-08-09T14:40:17.000Z","comments":true,"path":"about/index.html","permalink":"https://dbbruce.github.io/about/index.html","excerpt":"","text":""}],"posts":[{"title":"069-弹窗-下拉列表","slug":"项目/HCM教程/069-弹窗-下拉列表","date":"2025-07-06T12:00:00.000Z","updated":"2025-09-28T01:20:47.837Z","comments":true,"path":"2025/07/06/项目/HCM教程/069-弹窗-下拉列表/","link":"","permalink":"https://dbbruce.github.io/2025/07/06/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/069-%E5%BC%B9%E7%AA%97-%E4%B8%8B%E6%8B%89%E5%88%97%E8%A1%A8/","excerpt":"1.弹窗样式","text":"1.弹窗样式 RES(‘ac0’)] 表示弹窗数据 SELECT_ITEM() 表示当前选中的项12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879&quot;actions&quot;: [ &#123; &quot;key&quot;: &quot;create_datas&quot;, &quot;label&quot;: &quot;生成数据2&quot;, &quot;condition&quot;: &quot;ITEM&quot;, &quot;hide&quot;: false, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;ac0&quot;, &quot;action&quot;: &quot;SIMPLE_FORM&quot;, &quot;options&quot;: &#123; &quot;title&quot;: &quot;生成数据&quot;, &quot;form_options&quot;: &#123; &quot;size&quot;: &quot;small&quot; &#125;, &quot;meta&quot;: [ &#123; &quot;key&quot;: &quot;c_data_type&quot;, &quot;label&quot;: &quot;操作类型&quot;, &quot;component&quot;: &quot;hc-input-radio&quot;, &quot;options&quot;: &#123; &quot;default&quot;: &quot;1-增量&quot;, &quot;singleLine&quot;: true, &quot;list&quot;: [ &#123; &quot;name&quot;: &quot;1-增量&quot;, &quot;value&quot;: &quot;1-增量&quot; &#125;, &#123; &quot;name&quot;: &quot;2-全量&quot;, &quot;value&quot;: &quot;2-全量&quot; &#125; ], &quot;items_inline&quot;: true &#125; &#125;, &#123; &quot;key&quot;: &quot;c_report_num&quot;, &quot;label&quot;: &quot;批次号&quot;, &quot;component&quot;: &quot;hc-super-selector&quot;, &quot;options&quot;: &#123; &quot;singleLine&quot;: true, &quot;readOnly&quot;: false, &quot;required&quot;: true, &quot;placeholder&quot;: &quot;批次号&quot;, &quot;selector&quot;: &quot;=function()&#123;item=ITEM();return dataService.callHcmOpenApi(&#x27;private.Get_HRKingbase_Batch_Number&#x27;,&#123;&#x27;item&#x27;:item&#125;);&#125;&quot;, &quot;selectorMapper&quot;: &quot;=function(id_)&#123;return dataService.callHcmOpenApi(&#x27;private.Get_HRKingbase_Batch_Number&#x27;,&#123;&#x27;cptnumid&#x27;: id_&#125;);&#125;&quot; &#125; &#125; ] &#125; &#125;, &#123; &quot;action&quot;: &quot;CALL_API&quot;, &quot;key&quot;: &quot;hrkbdata&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;private.Get_HRKBData_To_RptEmpIncomeData&quot;, &quot;params&quot;: &#123; &quot;formdata&quot;: &quot;expression[RES(&#x27;ac0&#x27;)]&quot;, &quot;itemdata&quot;: &quot;expression[SELECT_ITEM()]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;show_warning_msg&quot;, &quot;action&quot;: &quot;SHOW_WARNING&quot;, &quot;entry_condition&quot;: &quot;expression[RES(&#x27;hrkbdata&#x27;)]&quot;, &quot;options&quot;: &#123; &quot;content&quot;: &quot;expression[GET(RES(&#x27;hrkbdata&#x27;),[&#x27;msg&#x27;])]&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;ac4&quot;, &quot;action&quot;: &quot;REFRESH&quot; &#125; ], &quot;sequence&quot;: 10 &#125; ] 2.代码 Get_HRKingbase_Batch_Number 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136class PrivateAPIService(BasePrivateApiService): &quot;&quot;&quot; 表对应关系： 人资表 === hcm对应关系 unit： ==== 全称 zqyxydm ==== 统一社会信息代码 tjny： ==== 统计年月 &quot;&quot;&quot; def get_curr_yearmonthday(self): &quot;&quot;&quot; 获取当前年月 &quot;&quot;&quot; curr_ymd = datetime.datetime.now().strftime(&#x27;%Y-%m-%d&#x27;) return curr_ymd def _call_api(self, api_name, args_dict): &quot;&quot;&quot;封装API调用逻辑&quot;&quot;&quot; res_obj = CustomerUtil.call_open_api(api_name, args_dict) return res_obj.get(&quot;list&quot;, []), res_obj.get(&quot;count&quot;, 0) def get_orgunit_datas(self, ymd, depart_id): &quot;&quot;&quot; 获取单位数据 &quot;&quot;&quot; args_dict = &#123; &quot;model&quot;: &quot;OrgUnit&quot;, &quot;filter_dict&quot;:&#123; &quot;date_&quot;: ymd, &quot;id&quot;: depart_id &#125;, &quot;extra_property&quot;:&#123; &quot;state&quot;: &quot;all&quot;, &quot;fields&quot;:[ &#123;&quot;field&quot;:[&quot;org_full_name&quot;]&#125;, &#123;&quot;field&quot;:[&quot;credit_code&quot;]&#125; ] &#125; &#125; return self._call_api(&quot;hcm.model.list&quot;, args_dict) def _kb_execute_sql(self, sql): &quot;&quot;&quot; 连接人大金仓数据库 &quot;&quot;&quot; try: conn = psycopg2.connect( dbname=&quot;personnel&quot;, user=&quot;personnel_other&quot;, password=&quot;Maruyama_Aya@p*3&quot;, host=&quot;10.5.42.5&quot;, port=&quot;54321&quot; ) cur = conn.cursor() cur.execute(sql) rows = cur.fetchall() return rows except psycopg2.DatabaseError as e: self.log(f&#x27;查询人大金仓数据库Error: &#123;e&#125;&#x27;) finally: if cur: cur.close() if conn: conn.close() def execute(self, **kwargs): try: self.log(f&quot;kwargs-&#123;kwargs&#125;&quot;) # 选择的批次号 cptnumid = kwargs.get(&quot;cptnumid&quot;, &#x27;&#x27;) self.log(f&quot;cptnumid-&#123;cptnumid&#125;&quot;) if cptnumid: return &#123;&quot;name&quot;:cptnumid,&quot;id&quot;:cptnumid&#125; # 查询人资系统获取批次号 item_obj =kwargs.get(&#x27;item&#x27;, &#123;&#125;) # 月度信息 fmonth = item_obj.get(&#x27;u_fill_month&#x27;, &#x27;&#x27;) tjny = fmonth.replace(&#x27;-&#x27;, &#x27;&#x27;) # 部门信息 depart_obj = item_obj.get(&#x27;u_depart&#x27;, &#123;&#125;) depart_id = depart_obj.get(&#x27;id&#x27;, &#x27;&#x27;) # depart_name = depart_obj.get(&#x27;name&#x27;, &#x27;&#x27;) # depart_number = depart_obj.get(&#x27;u_organization_number&#x27;, &#x27;&#x27;) # 当前年月日 curr_ymd = self.get_curr_yearmonthday() # 获取全称和统一社会信息代码 orgunit_list, orgunit_count = self.get_orgunit_datas(curr_ymd, depart_id) if not orgunit_count: self.log(f&quot;获取单位全称和统一社会信息代码失败-&#123;orgunit_list&#125;&quot;) return [] unit = orgunit_list[0].get(&#x27;org_full_name&#x27;, &#x27;&#x27;) zqyxydm = orgunit_list[0].get(&#x27;credit_code&#x27;, &#x27;&#x27;) # SQL语句 # # 测试用 # # search_sql = &quot;&quot;&quot;SELECT tjny,unit,code,pcjls FROM personnel_xcgzeq_xcsbe WHERE tjny=&#x27;%s&#x27;;&quot;&quot;&quot; % (tjny) # unit = &#x27;中国电气装备集团有限公司&#x27; # zqyxydm = &#x27;12345&#x27; search_sql = &quot;&quot;&quot;SELECT DISTINCT pcjls FROM personnel_xcgzeq_xcsbe WHERE tjny=&#x27;%s&#x27; and unit=&#x27;%s&#x27; and zqyxydm=&#x27;%s&#x27;;&quot;&quot;&quot; % (tjny, unit, zqyxydm) self.log(f&#x27;查询语句-&#123;search_sql&#125;&#x27;) row_list = self._kb_execute_sql(search_sql) self.log(f&#x27;查询结果-&#123;row_list&#125;&#x27;) # 批次号列表 hk_list = list() for row_set in row_list: hk_list.append(row_set[0]) # 格式化数据成功 res_list = list() for hkstr in hk_list: res_list.append(&#123;&quot;name&quot;:hkstr,&quot;id&quot;:hkstr&#125;) return res_list except Exception: self.log(f&#x27;错误:&#123;traceback.format_exc()&#125;&#x27;) def log(self, log_content): log_info = &#123; &quot;log_type&quot;: str(&#x27;Get_HRKingbase_Batch_Number&#x27;), &quot;create_time&quot;: datetime.datetime.now().strftime(&#x27;%Y-%m-%d %H:%M:%S&#x27;), &quot;content&quot;: str(log_content) &#125; CustomerUtil.call_open_api(&quot;hcm.model.create&quot;, &#123;&quot;model&quot;: &quot;dynamic_log&quot;, &quot;info&quot;: log_info&#125;) Get_HRKBData_To_RptEmpIncomeData 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296class PrivateAPIService(BasePrivateApiService): &quot;&quot;&quot; 表对应关系： 人资表 === hcm对应关系 unit： ==== 全称 zqyxydm ==== 统一社会信息代码 tjny： ==== 统计年月 &quot;&quot;&quot; # SQL字段与表字段转换字典 KEY_MAP = &#123; &#x27;0&#x27;: [&#x27;u_uuid&#x27;], &#x27;1&#x27;: [&#x27;month&#x27;], &#x27;2&#x27;: [&#x27;sub_org_credit_code&#x27;], &#x27;3&#x27;: [&#x27;sub_org_name&#x27;], &#x27;4&#x27;: [&#x27;u_sjzt_org_code&#x27;], &#x27;5&#x27;: [&#x27;u_sjzt_people_code&#x27;], &#x27;6&#x27;: [&#x27;emp_name&#x27;], &#x27;7&#x27;: [&#x27;id_type&#x27;], &#x27;8&#x27;: [&#x27;id_card&#x27;], &#x27;9&#x27;: [&#x27;nationality&#x27;], &#x27;10&#x27;: [&#x27;department&#x27;], &#x27;11&#x27;: [&#x27;position&#x27;], &#x27;12&#x27;: [&#x27;position_level&#x27;], &#x27;13&#x27;: [&#x27;professiona_level&#x27;], &#x27;14&#x27;: [&#x27;vocational_skill_level&#x27;], &#x27;15&#x27;: [&#x27;birth_date&#x27;], &#x27;16&#x27;: [&#x27;gender&#x27;], &#x27;17&#x27;: [&#x27;labor_relationship_within_unit&#x27;], &#x27;18&#x27;: [&#x27;highest_education&#x27;], &#x27;19&#x27;: [&#x27;is_on_job&#x27;], &#x27;20&#x27;: [&#x27;is_head_emp&#x27;], &#x27;21&#x27;: [&#x27;enterprises_headquarters&#x27;], &#x27;22&#x27;: [&#x27;is_corporate_executive&#x27;], &#x27;23&#x27;: [&#x27;is_full_external_director&#x27;], &#x27;24&#x27;: [&#x27;is_professional_manager&#x27;], &#x27;25&#x27;: [&#x27;is_technology&#x27;], &#x27;26&#x27;: [&#x27;national_technology_type&#x27;], &#x27;27&#x27;: [&#x27;is_directly_research&#x27;], &#x27;28&#x27;: [&#x27;overseas_emp_type&#x27;], &#x27;29&#x27;: [&#x27;is_dispatched_or_stationed&#x27;], &#x27;30&#x27;: [&#x27;dispatched_enterprise_name&#x27;], &#x27;31&#x27;: [&#x27;is_fresh_graduate_career&#x27;], &#x27;32&#x27;: [&#x27;is_industrial_worker&#x27;], &#x27;33&#x27;: [&#x27;is_frontline_worker&#x27;], &#x27;34&#x27;: [&#x27;tax_before_income&#x27;], &#x27;35&#x27;: [&#x27;basic_salary&#x27;], &#x27;36&#x27;: [&#x27;achievement_bonus&#x27;], &#x27;37&#x27;: [&#x27;subsidy_income&#x27;], &#x27;38&#x27;: [&#x27;overseas_work_subsidy&#x27;], &#x27;39&#x27;: [&#x27;deferred_income&#x27;], &#x27;40&#x27;: [&#x27;one_time_reward&#x27;], &#x27;41&#x27;: [&#x27;other_special_rewards_name&#x27;], &#x27;42&#x27;: [&#x27;is_long_term_incentive&#x27;], &#x27;43&#x27;: [&#x27;long_term_incentive_tool&#x27;], &#x27;44&#x27;: [&#x27;long_term_incentive_income&#x27;], &#x27;45&#x27;: [&#x27;total_income&#x27;], &#x27;46&#x27;: [&#x27;welfare_expenses&#x27;], &#x27;47&#x27;: [&#x27;social_insurance_pers_pay&#x27;], &#x27;48&#x27;: [&#x27;house_accumu_fund_pers_pay&#x27;], &#x27;49&#x27;: [&#x27;supply_endow_insura_pers_pay&#x27;], &#x27;50&#x27;: [&#x27;supply_medical_insura_pers_pay&#x27;], &#x27;51&#x27;: [&#x27;other_insura_pers_pay&#x27;], &#x27;52&#x27;: [&#x27;other_deduct_and_pay&#x27;], &#x27;53&#x27;: [&#x27;individual_income_tax&#x27;], &#x27;54&#x27;: [&#x27;total_deduct_pay&#x27;], &#x27;55&#x27;: [&#x27;actual_pay&#x27;], &#x27;56&#x27;: [&#x27;pay_time&#x27;], &#x27;57&#x27;: [&#x27;is_completed&#x27;], &#x27;58&#x27;: [&#x27;description&#x27;] &#125; def get_curr_yearmonthday(self): &quot;&quot;&quot; 获取当前年月 &quot;&quot;&quot; curr_ymd = datetime.datetime.now().strftime(&#x27;%Y-%m-%d&#x27;) return curr_ymd def _call_api(self, api_name, args_dict): &quot;&quot;&quot;封装API调用逻辑&quot;&quot;&quot; res_obj = CustomerUtil.call_open_api(api_name, args_dict) return res_obj.get(&quot;list&quot;, []), res_obj.get(&quot;count&quot;, 0) def get_orgunit_datas(self, ymd, depart_id): &quot;&quot;&quot; 获取单位数据 &quot;&quot;&quot; args_dict = &#123; &quot;model&quot;: &quot;OrgUnit&quot;, &quot;filter_dict&quot;:&#123; &quot;date_&quot;: ymd, &quot;id&quot;: depart_id &#125;, &quot;extra_property&quot;:&#123; &quot;state&quot;: &quot;all&quot;, &quot;fields&quot;:[ &#123;&quot;field&quot;:[&quot;org_full_name&quot;]&#125;, &#123;&quot;field&quot;:[&quot;credit_code&quot;]&#125; ] &#125; &#125; return self._call_api(&quot;hcm.model.list&quot;, args_dict) def _kb_execute_sql(self, sql): &quot;&quot;&quot; 连接人大金仓数据库 &quot;&quot;&quot; try: conn = psycopg2.connect( dbname=&quot;personnel&quot;, user=&quot;personnel_other&quot;, password=&quot;Maruyama_Aya@p*3&quot;, host=&quot;10.5.42.5&quot;, port=&quot;54321&quot; ) cur = conn.cursor() cur.execute(sql) rows = cur.fetchall() return rows except psycopg2.DatabaseError as e: self.log(f&#x27;查询人大金仓数据库Error: &#123;e&#125;&#x27;) finally: if cur: cur.close() if conn: conn.close() def _generate_insert_data(self, key_map, datas, depart_id, u_secondaryunit_code, program_id, operate_type): &quot;&quot;&quot; 生成ReportEmpIncomeInfo表格式数据 &quot;&quot;&quot; create_list = [] for rpid, data in enumerate(datas): mapped_dict = &#123;i: v for k, v in enumerate(data) if str(k) in key_map for i in key_map[str(k)]&#125; mapped_dict.update(&#123;&quot;depart_id&quot;: depart_id&#125;) mapped_dict.update(&#123;&quot;u_secondaryunit_code&quot;: u_secondaryunit_code&#125;) # 校验状态默认：0 未校验 mapped_dict.update(&#123;&quot;check_status&quot;: 0&#125;) mapped_dict.update(&#123;&quot;program_id&quot;: program_id&#125;) mapped_dict.update(&#123;&quot;operate_type&quot;: operate_type&#125;) create_list.append(mapped_dict) return create_list def del_reportempincomedata_datas(self, sub_org_credit_code, sub_org_name, month, depart_id): &quot;&quot;&quot; 删除数据 &quot;&quot;&quot; model_name=&quot;ReportEmpIncomeData&quot; record_list = ModelUtil.list( model=model_name, filter_dict=&#123; &quot;sub_org_credit_code&quot;: sub_org_credit_code, &quot;sub_org_name&quot;: sub_org_name, &quot;month&quot;: month, &quot;depart_id&quot;: depart_id &#125;, extra_property=&#123;&quot;state&quot;: &quot;salary&quot;&#125;, page_size=99999, page_index=1 ) ids = [] for info in record_list: ids.append(info[&#x27;id&#x27;]) # 删除数据 if ids: api = &quot;hcm.model.remove.batch&quot; param = &#123;&quot;model&quot;: model_name, &quot;ids&quot;: ids&#125; result = CustomerUtil.call_open_api(api, param) return result self.log(f&quot;ids-&#123;ids&#125;&quot;) return ids def insert_reportempincomedata_data(self, insert_list): res_list = list() for i in range(0, len(insert_list), 2000): res = ModelUtil.create_batch(&quot;ReportEmpIncomeData&quot;, insert_list[i:i + 2000]) res_list.append(res) return res_list def execute(self, **kwargs): try: self.log(f&quot;kwargs-&#123;kwargs&#125;&quot;) # 表单信息 formdata_obj = kwargs.get(&quot;formdata&quot;, &#123;&#125;) # 操作类型 operate_type = formdata_obj.get(&#x27;c_data_type&#x27;, &#x27;&#x27;) # 批次号 pcjls = formdata_obj.get(&#x27;c_report_num&#x27;, &#x27;&#x27;) # 选择的数据信息 item_obj = kwargs.get(&quot;itemdata&quot;, &#123;&#125;) item_id = item_obj.get(&#x27;id&#x27;, &#x27;&#x27;) # 月度信息 fmonth[2025-09], tjny[202509] fmonth = item_obj.get(&#x27;u_fill_month&#x27;, &#x27;&#x27;) tjny = fmonth.replace(&#x27;-&#x27;, &#x27;&#x27;) # 部门信息 depart_obj = item_obj.get(&#x27;u_depart&#x27;, &#123;&#125;) depart_name = depart_obj.get(&#x27;name&#x27;, &#x27;&#x27;) depart_id = depart_obj.get(&#x27;id&#x27;, &#x27;&#x27;) # depart_number = depart_obj.get(&#x27;u_organization_number&#x27;, &#x27;&#x27;) us_code = item_obj.get(&#x27;u_code&#x27;, &#x27;&#x27;) # 当前年月日 curr_ymd = self.get_curr_yearmonthday() # 获取全称和统一社会信息代码 orgunit_list, orgunit_count = self.get_orgunit_datas(curr_ymd, depart_id) if not orgunit_count: self.log(f&quot;获取单位全称和统一社会信息代码失败-&#123;orgunit_list&#125;&quot;) return &#123;&quot;success&quot;: False, &quot;msg&quot;: &quot;获取单位全称和统一社会信息代码失败！&quot;&#125; unit = orgunit_list[0].get(&#x27;org_full_name&#x27;, &#x27;&#x27;) zqyxydm = orgunit_list[0].get(&#x27;credit_code&#x27;, &#x27;&#x27;) # SQL语句 # # 测试用 # unit = &#x27;中国电气装备集团有限公司&#x27; # zqyxydm = &#x27;12345&#x27; # 1、开始查询数据 self.log(&quot;开始查询数据&quot;) search_sql = &quot;&quot;&quot;SELECT uuid,tjny,zqyxydm,unit,CODE,employee_code,NAME,id_type,idcard,gj,dept,gw,gwcj,zcdj,zyjndj,csny,sex,ldgx,zgxl,sfzg,qyzbry,sfej,sfbqy,wbds,zyjlr,kjrc,gjjkjrc,yfgz,hwyglx,sfpcr,pzqymc,yjsby,sfcyg,sfyxg,sqgzxsr,jbxc,jxxcjjj,jbt,jwbt,yqzfdxbf,ycxzxjl,zxjlmc,cqjl,jlgj,zcqjlxqy,zsr,gzzzfl,wxgrjn,gjjgrjn,bcylbj,bcyl,qtbxgr,qtdkdj,grsds,ykhj,shifs,faxsj,gjqyfx,bz FROM personnel_xcgzeq_xcsbe WHERE tjny=&#x27;%s&#x27; and unit=&#x27;%s&#x27; and zqyxydm=&#x27;%s&#x27; and pcjls=&#x27;%s&#x27;;&quot;&quot;&quot; % (tjny, unit, zqyxydm, pcjls) self.log(f&#x27;查询语句-&#123;search_sql&#125;&#x27;) rows = self._kb_execute_sql(search_sql) self.log(f&#x27;查询结果-&#123;rows&#125;&#x27;) if rows: # program_id program_id = int(depart_id) + int(time.time()) # 生成数据 create_list = self._generate_insert_data(self.KEY_MAP, rows, depart_id, us_code, program_id, operate_type) self.log(f&#x27;create_list-&#123;create_list&#125;&#x27;) if not create_list: self.log(&#x27;从人资系统数据库中获取数据失败&#x27;, &quot;生成数据失败！！！&quot;) return &#123;&quot;success&quot;: False, &quot;msg&quot;: &#x27;生成数据失败！&#x27;&#125; # 2、删除数据 self.log(&quot;开始删除数据&quot;) if operate_type == &#x27;2-全量&#x27;: self.del_reportempincomedata_datas(zqyxydm, unit, tjny, depart_id) # 收入上报数 = 写入的数据量 emp_db_count = len(create_list) # 3、写入数据 # 将数据写入模型 self.log(&quot;开始将数据写入模型&quot;) self.insert_reportempincomedata_data(create_list) # 4、生成实时采集上报记录 # 获取部门名称 self.log(&quot;开始生成实时采集上报记录&quot;) # 创建1180上报记录 create_info = &#123; &quot;name&quot;: depart_name, &quot;sub_org_name&quot;: depart_name, &quot;month&quot;: fmonth, &quot;salary_month&quot;: fmonth, &quot;statistics_id&quot;: 1, # 默认写1 &quot;program_id&quot;: program_id, &quot;dsp_data_type&quot;: &quot;N&quot;, # 默认写Y, 测试写N &quot;org_db_count&quot;:1, &quot;emp_db_count&quot;:emp_db_count, &quot;u_depart_id&quot;: depart_id &#125; CustomerUtil.call_open_api(&quot;hcm.model.create&quot;, &#123;&quot;model&quot;:&quot;ReportIntegrate1180Instance&quot;, &quot;info&quot;: create_info&#125;) # create_res = CustomerUtil.call_open_api(&quot;hcm.model.create&quot;, &#123;&quot;model&quot;:&quot;ReportIntegrate1180Instance&quot;, &quot;info&quot;: create_info&#125;) # rpinst_id = create_res.get(&quot;id&quot;) # 5、修改状态：未校验；数据状态 、表2状态 self.log(&quot;开始修改状态&quot;) CustomerUtil.call_open_api(&quot;hcm.model.edit&quot;, &#123; &quot;model&quot;: &quot;U_View_real_time_data&quot;, &quot;id_&quot;: item_id, &quot;info&quot;: &#123; &quot;u_report_status&quot;: &quot;2&quot;, &quot;u_table_state2&quot;: &quot;2&quot; &#125; &#125;) return &#123;&quot;success&quot;: True, &quot;msg&quot;: &#x27;生成数据完成！&#x27;&#125; else: return &#123;&quot;success&quot;: False, &quot;msg&quot;: &quot;不生成数据，人资数据库没有查询到数据！&quot;&#125; except Exception: self.log(f&#x27;错误:&#123;traceback.format_exc()&#125;&#x27;) return &#123;&quot;success&quot;: False, &quot;msg&quot;: &quot;生成数据失败！&quot;&#125; def log(self, log_content): log_info = &#123; &quot;log_type&quot;: str(&#x27;Get_HRKBData_To_RptEmpIncomeData&#x27;), &quot;create_time&quot;: datetime.datetime.now().strftime(&#x27;%Y-%m-%d %H:%M:%S&#x27;), &quot;content&quot;: str(log_content) &#125; CustomerUtil.call_open_api(&quot;hcm.model.create&quot;, &#123;&quot;model&quot;: &quot;dynamic_log&quot;, &quot;info&quot;: log_info&#125;) 3.selector 返回下方可选择的数据列表，返回列表 4.selectorMapper 选择数据后，用于显示选择的内容， 返回字典","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"068-列表跳转","slug":"项目/HCM教程/068-列表跳转","date":"2025-07-05T15:00:00.000Z","updated":"2025-09-24T07:55:23.899Z","comments":true,"path":"2025/07/05/项目/HCM教程/068-列表跳转/","link":"","permalink":"https://dbbruce.github.io/2025/07/05/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/068-%E5%88%97%E8%A1%A8%E8%B7%B3%E8%BD%AC/","excerpt":"1.列表跳转点击跳转","text":"1.列表跳转点击跳转 点击后，跳转的页面 2.配置方法 配置func字段，func &#x3D;&#x3D; 点击事件1234567891011121314151617181920212223242526&quot;fields&quot;:[ &#123; &quot;label&quot;: &quot;表1状态&quot;, &quot;key&quot;: &quot;u_table_state1&quot;, &quot;field&quot;: [ &quot;u_table_state1&quot; ], &quot;data_type&quot;: &quot;string&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 50, &quot;sequence&quot;: 60, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: false, &quot;color&quot;: &quot;35baf6&quot;, &quot;func&quot;: &quot;=function(_row,col,value)&#123;return SCOPE.super_go(&#x27;common_model_tree_list&#x27;,&#123;&#x27;model&#x27;:&#x27;ReportOrgInfo&#x27;, &#x27;meta_state&#x27;: &#x27;manage_collect_headquarters&#x27;, &#x27;filter_dict&#x27;:&#123;&#x27;month&#x27;:SCOPE.advance_query.filter_dict.u_fill_month.split(&#x27;-&#x27;).join(&#x27;&#x27;)&#125;,&#x27;tree_id&#x27;:&#x27;18309808!&#x27;+_row.u_depart.id,&#x27;custom_params&#x27;:&#123;&#x27;month&#x27;:SCOPE.advance_query.filter_dict.u_fill_month.split(&#x27;-&#x27;).join(&#x27;&#x27;)&#125;&#125;)&#125;&quot;, &quot;mask&quot;: &#123; &quot;1&quot;: &quot;未生成&quot;, &quot;2&quot;: &quot;未校验&quot;, &quot;3&quot;: &quot;校验失败&quot;, &quot;4&quot;: &quot;校验成功&quot; &#125; &#125;]","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"文件下载","slug":"项目/HCM教程/067-文件下载","date":"2025-07-05T14:00:00.000Z","updated":"2025-09-22T07:37:40.292Z","comments":true,"path":"2025/07/05/项目/HCM教程/067-文件下载/","link":"","permalink":"https://dbbruce.github.io/2025/07/05/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/067-%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD/","excerpt":"1.文件下载配置按钮1234567&quot;actions&quot;: [ &#123; &quot;label&quot;: &quot;导出&quot;, &quot;key&quot;: &quot;test&quot;, &quot;func&quot;: &quot;=function()&#123;debugger;dataService.callHcmOpenApi(&#x27;private.export_bank_offer_data&#x27;, SCOPE.getAllFilterDict()).then(function(data)&#123;if(data)&#123;WINDOW.open(WINDOW.hcm_wengen+\\&quot;/document/get_file_by_type?index=\\&quot;+data+\\&quot;&amp;type=xlsx&amp;file_name=银行报盘.xlsx\\&quot;);&#125;&#125;)&#125;&quot; &#125;]","text":"1.文件下载配置按钮1234567&quot;actions&quot;: [ &#123; &quot;label&quot;: &quot;导出&quot;, &quot;key&quot;: &quot;test&quot;, &quot;func&quot;: &quot;=function()&#123;debugger;dataService.callHcmOpenApi(&#x27;private.export_bank_offer_data&#x27;, SCOPE.getAllFilterDict()).then(function(data)&#123;if(data)&#123;WINDOW.open(WINDOW.hcm_wengen+\\&quot;/document/get_file_by_type?index=\\&quot;+data+\\&quot;&amp;type=xlsx&amp;file_name=银行报盘.xlsx\\&quot;);&#125;&#125;)&#125;&quot; &#125;] 2.url方式下载http:&#x2F;&#x2F;域名&#x2F;hcm&#x2F;document&#x2F;get_file_by_type?index&#x3D;文件名&amp;type&#x3D;文件类型&amp;file_name&#x3D;下载后名称.zip 1http://10.5.42.89:8081/hcm/document/get_file_by_type?index=db&amp;type=xml&amp;file_name=上报文件.xml 3.文件保存路径 文件保存路径：&#x2F;var&#x2F;data&#x2F;hcm_core_document&#x2F; 123456789101112# 保存xml文件xml_fname = &#x27;/var/data/hcm_core_document/db.xml&#x27;xml_content = &#x27;&#x27;&#x27;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;log&gt; &lt;fileZips&gt; &lt;fileZipName&gt;11——22——33-44.zip&lt;/fileZipName&gt; &lt;/fileZips&gt;&lt;/log&gt;&#x27;&#x27;&#x27;# 写入文件with open(xml_fname, &#x27;w&#x27;) as xmlfile: xmlfile.write(xml_content)","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"066-套打实例和zip包套打","slug":"项目/HCM教程/066-套打实例和zip包套打","date":"2025-07-05T12:00:00.000Z","updated":"2025-09-22T07:29:37.179Z","comments":true,"path":"2025/07/05/项目/HCM教程/066-套打实例和zip包套打/","link":"","permalink":"https://dbbruce.github.io/2025/07/05/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/066-%E5%A5%97%E6%89%93%E5%AE%9E%E4%BE%8B%E5%92%8Czip%E5%8C%85%E5%A5%97%E6%89%93/","excerpt":"1.上传套打模板【系统管理】-【基础服务】-【套打管理】-【新建】 1.1 创建套打模板1标识：ReportOrgInfo:，带冒号【:】,这个标识会用于后面的云函数中；","text":"1.上传套打模板【系统管理】-【基础服务】-【套打管理】-【新建】 1.1 创建套打模板1标识：ReportOrgInfo:，带冒号【:】,这个标识会用于后面的云函数中； 1.2 上传套打模板 对应组织 所属集团统一社会信用代码 所属集团注册名称 {LIST:main:","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"065-编码规则","slug":"项目/HCM教程/065-编码规则","date":"2025-07-04T13:00:00.000Z","updated":"2025-09-11T02:28:04.860Z","comments":true,"path":"2025/07/04/项目/HCM教程/065-编码规则/","link":"","permalink":"https://dbbruce.github.io/2025/07/04/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/065-%E7%BC%96%E7%A0%81%E8%A7%84%E5%88%99/","excerpt":"1.新增编码规则【系统设置】-【扩展管理】-【编码规则】规则配置：DW{group_flag}{order}","text":"1.新增编码规则【系统设置】-【扩展管理】-【编码规则】规则配置：DW{group_flag}{order} 2.添加部门type：create &#x2F; save,使用save必须required设置为false，save是创建时触发生成编码； 12345678910111213141516171819202122232425262728&quot;fields&quot;:[ &#123; &quot;key&quot;: &quot;number&quot;, &quot;label&quot;: &quot;编号&quot;, &quot;component&quot;: &quot;hc-input&quot;, &quot;sequence&quot;: 20, &quot;options&quot;: &#123; &quot;data_type&quot;: &quot;string&quot;, &quot;required&quot;: false, &quot;width&quot;: &quot;col-6&quot;, &quot;singleLine&quot;: true, &quot;data_precision&quot;: null, &quot;hide&quot;: false, &quot;readOnly&quot;: false, &quot;placeholder&quot;: &quot;请输入编号&quot;, &quot;default&quot;: null, &quot;default_expression&quot;: null, &quot;tip&quot;: null, &quot;maxlength&quot;: 30, &quot;number_increment_rule&quot;: &#123; &quot;key&quot;: &quot;DepartmentNumberSerial&quot;, &quot;type&quot;: &quot;save&quot; &#125; &#125;, &quot;state&quot;: null &#125;]","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"064-首页设置","slug":"项目/HCM教程/064-首页设置","date":"2025-07-04T12:00:00.000Z","updated":"2025-09-11T02:14:38.983Z","comments":true,"path":"2025/07/04/项目/HCM教程/064-首页设置/","link":"","permalink":"https://dbbruce.github.io/2025/07/04/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/064-%E9%A6%96%E9%A1%B5%E8%AE%BE%E7%BD%AE/","excerpt":"1.配置自定义的首页配置2个首页工作台：【默认方案】、【工作台2】","text":"1.配置自定义的首页配置2个首页工作台：【默认方案】、【工作台2】 2.开启【首页工作台】【系统设置】-【企业设置】- 【服务器设置】- 搜【门户首页是否启用】- 设置为：是 开启成功后，刷新页面，才可以看见【首页工作台】的入口 3.新建【首页工作台】排序码：决定工作台顺序 4.新建【插件方案】所属工作台，一定是开启步骤2才会显示，选择对应的工作台 设置插件 5.设置【切换首页工作台方式】2种展示方式：【通过头部图标点击下拉切换】、【通过顶部tabs方式切换】 通过头部图标点击下拉切换通过顶部tabs方式切换","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"063-下载上报文件","slug":"项目/HCM教程/063-下载上报文件","date":"2025-07-03T12:00:00.000Z","updated":"2025-09-09T06:19:59.357Z","comments":true,"path":"2025/07/03/项目/HCM教程/063-下载上报文件/","link":"","permalink":"https://dbbruce.github.io/2025/07/03/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/063-%E4%B8%8B%E8%BD%BD%E4%B8%8A%E6%8A%A5%E6%96%87%E4%BB%B6/","excerpt":"功能描述 1.【ReportIntegrateInstance】 - 【下载上报文件】 - 【单位信息统计表】","text":"功能描述 1.【ReportIntegrateInstance】 - 【下载上报文件】 - 【单位信息统计表】 元数据配置 下载文件：window.open(window.hcm_wengen+”&#x2F;document&#x2F;loadsourcedocument&#x2F;“+”5FAF6CF63D984D93917C491C4D3D474”+window.hcm_env_pre); 12345678910111213141516171819202122232425262728293031323334353637383940414243444546actions:[ &#123; &quot;label&quot;: &quot;下载上报文件&quot;, &quot;key&quot;: &quot;Dsb&quot;, &quot;condition&quot;: &quot;ITEM&quot;, &quot;hide&quot;: &quot;=function()&#123;item=ITEM();if(item.report_status===&#x27;0&#x27;)&#123;return true&#125;else&#123;return false&#125;&#125;&quot;, &quot;actions&quot;: [&#123; &quot;label&quot;: &quot;单位信息统计表&quot;, &quot;key&quot;: &quot;dsb1&quot;, &quot;func&quot;: &quot;=function()&#123;dataService.callHcmOpenApi(&#x27;private.print_form1&#x27;, &#123;&#x27;month&#x27;:ITEM().month&#125;).then(function(data)&#123;if(data)&#123;WINDOW.open(WINDOW.hcm_wengen+\\&quot;/document/loadsourcedocument/\\&quot;+data+WINDOW.hcm_env_pre);&#125;&#125;)&#125;&quot; &#125;, &#123; &quot;label&quot;: &quot;人工成本情况统计表&quot;, &quot;key&quot;: &quot;dsb2&quot;, &quot;func&quot;: &quot;=function()&#123;dataService.callHcmOpenApi(&#x27;private.print_form2&#x27;, &#123;&#x27;month&#x27;:ITEM().month&#125;).then(function(data)&#123;if(data)&#123;WINDOW.open(WINDOW.hcm_wengen+\\&quot;/document/loadsourcedocument/\\&quot;+data+WINDOW.hcm_env_pre);&#125;&#125;)&#125;&quot; &#125;, &#123; &quot;label&quot;: &quot;企业职工收入情况统计表&quot;, &quot;key&quot;: &quot;dsb3&quot;, &quot;func&quot;: &quot;=function()&#123;dataService.callHcmOpenApi(&#x27;private.print_form3&#x27;, &#123;&#x27;month&#x27;:ITEM().month&#125;).then(function(data)&#123;if(data)&#123;WINDOW.open(WINDOW.hcm_wengen+\\&quot;/document/loadsourcedocument/\\&quot;+data+WINDOW.hcm_env_pre);&#125;&#125;)&#125;&quot; &#125; ] &#125;, &#123; &quot;label&quot;: &quot;下载汇总文件&quot;, &quot;key&quot;: &quot;Dsb4&quot;, &quot;condition&quot;: &quot;ITEM&quot;, &quot;hide&quot;: &quot;=function()&#123;item=ITEM();if(item.report_status===&#x27;0&#x27;)&#123;return true&#125;else&#123;return false&#125;&#125;&quot;, &quot;actions&quot;: [&#123; &quot;label&quot;: &quot;单位信息统计表汇总&quot;, &quot;key&quot;: &quot;dsb5&quot;, &quot;func&quot;: &quot;=function()&#123;dataService.callHcmOpenApi(&#x27;private.print_form1&#x27;, &#123;&#x27;month&#x27;:ITEM().month&#125;).then(function(data)&#123;if(data)&#123;WINDOW.open(WINDOW.hcm_wengen+\\&quot;/document/loadsourcedocument/\\&quot;+data+WINDOW.hcm_env_pre);&#125;&#125;)&#125;&quot; &#125;, &#123; &quot;label&quot;: &quot;人工成本情况统计表汇总&quot;, &quot;key&quot;: &quot;dsb6&quot;, &quot;func&quot;: &quot;=function()&#123;dataService.callHcmOpenApi(&#x27;private.print_form2&#x27;, &#123;&#x27;month&#x27;:ITEM().month&#125;).then(function(data)&#123;if(data)&#123;WINDOW.open(WINDOW.hcm_wengen+\\&quot;/document/loadsourcedocument/\\&quot;+data+WINDOW.hcm_env_pre);&#125;&#125;)&#125;&quot; &#125;, &#123; &quot;label&quot;: &quot;企业职工收入情况统计表汇总&quot;, &quot;key&quot;: &quot;dsb7&quot;, &quot;func&quot;: &quot;=function()&#123;dataService.callHcmOpenApi(&#x27;private.print_form3&#x27;, &#123;&#x27;month&#x27;:ITEM().month&#125;).then(function(data)&#123;if(data)&#123;WINDOW.open(WINDOW.hcm_wengen+\\&quot;/document/loadsourcedocument/\\&quot;+data+WINDOW.hcm_env_pre);&#125;&#125;)&#125;&quot; &#125; ] &#125; ] 套打设置 标识必须带有冒号&#x3D;&#x3D;&#x3D;&#x3D;【:】，例如：【ReportOrgInfo：】 模板取值：{LIST:main:","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"062-绩效活动获取执行人实例","slug":"项目/HCM教程/062-绩效活动获取执行人实例","date":"2025-07-02T12:00:00.000Z","updated":"2025-09-09T06:19:59.448Z","comments":true,"path":"2025/07/02/项目/HCM教程/062-绩效活动获取执行人实例/","link":"","permalink":"https://dbbruce.github.io/2025/07/02/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/062-%E7%BB%A9%E6%95%88%E6%B4%BB%E5%8A%A8%E8%8E%B7%E5%8F%96%E6%89%A7%E8%A1%8C%E4%BA%BA%E5%AE%9E%E4%BE%8B/","excerpt":"配置执行人-云函数 1.【绩效管理】 - 【绩效活动】 - 选取一个绩效活动","text":"配置执行人-云函数 1.【绩效管理】 - 【绩效活动】 - 选取一个绩效活动 2.更多操作 - 查看方案 - 考核流程 - 3.配置云函数，获取执行人12345678api名称：二开的云函数：private.GetPerfDeptEmpList，填写：GetPerfDeptEmpListapi入参：api入参为card_info 考核表信息，stage_info 阶段信息api返回值：要求api返回值为通过api找到的执行人的employee_id数组 注意：配置是后多人和单人，如果配置成单人，返回多人，也只显示1人。 云函数121.card_list多条情况：添加多个考核人时，card_list是多条；2.根据业务的不同，每次修改get_special_data中取人的逻辑； GetPerfDeptEmpList 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172&quot;&quot;&quot;author: Bruce Dongdate: 2025-09-03 10:38:16&quot;&quot;&quot;class PrivateAPIService(BasePrivateApiService): &quot;&quot;&quot; 动态私有OpenAPI 使用方法 &quot;&quot;&quot; def get_special_data(self, card_list): &quot;&quot;&quot; 取数逻辑 :param card_ids: :return: &quot;&quot;&quot; res_dict = dict() for card_info in card_list: # 每次修改的地方---开始 # 人员ID employee_id = card_info.get(&#x27;obj_id&#x27;, &#x27;&#x27;) emp_info=CustomerUtil.call_open_api(name=&#x27;hcm.model.get&#x27;,param=&#123;&quot;model&quot;:&quot;Employee&quot;,&quot;id_&quot;:employee_id&#125;) # self.record(&#x27;employee&#x27;+str(emp_info)[:2000]) emp_list = emp_info.get(&quot;u_superior_id&quot;, []) res_dict[str(card_info.get(&quot;id&quot;))] = emp_list # 每次修改的地方---结束 return res_dict def execute(self, **kwargs): try: card_info = kwargs.get(&quot;card_info&quot;) self.record(f&quot;kwargs-&#123;kwargs&#125;&quot;) card_id = card_info.get(&quot;id&quot;) exe_context = kwargs.get(&quot;exe_context&quot;) or &#123;&#125; _cache_key = &quot;get_executor_by_stage_cj4&quot; # 本次执行缓存的key _cache = exe_context.get(_cache_key) if exe_context else None if _cache is None: card_list = exe_context.get(&quot;card_list&quot;) or [card_info] result = self.get_special_data(card_list) _cache = result exe_context[_cache_key] = _cache _result = _cache.get(str(card_id)) or [] self.record(f&quot;_result-&#123;_result&#125;&quot;) return _result except Exception: self.record(f&quot;错误: &#123;traceback.format_exc()&#125;&quot;) def record(self, content, type_=3): &quot;&quot;&quot; 日志记录 :param content: 内容 :param type_: 2 异常 3 其他 :return: &quot;&quot;&quot; # employee_id=CustomerUtil.get_current_context().employee.id company_id = CustomerUtil.get_current_context().company.id # category = self.__class__.__name__ CustomerUtil.call_open_api( name=&quot;hcm.model.create&quot;, param=&#123; &quot;model&quot;: &quot;SyncOuterRecord&quot;, &quot;info&quot;: &#123; &quot;company_id&quot;: company_id, &quot;name&quot;: &quot;GetPerfDeptEmpList&quot;, &quot;category&quot;: &quot;GetPerfDeptEmpList&quot;, &quot;type&quot;: type_, &quot;content&quot;: &#123;&quot;msg&quot;: &quot;&#123;&#125;&quot;.format(content)&#125;, &quot;update_time&quot;: datetime.datetime.now().strftime(&quot;%Y-%m-%d %H:%M:%S&quot;) &#125; &#125; ) 参数 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344&#123; &#x27;card_info&#x27;: &#123; &#x27;company_id&#x27;: 3589, &#x27;name&#x27;: &#x27;测试2&#x27;, &#x27;obj_type&#x27;: 1, &#x27;cycle&#x27;: 1, &#x27;year&#x27;: &#x27;2025&#x27;, &#x27;assess_cycle&#x27;: &#x27;2025年一月&#x27;, &#x27;activity_id&#x27;: 81, &#x27;scheme_id&#x27;: 88, &#x27;current_stage_id&#x27;: 4467, &#x27;status&#x27;: 0, &#x27;card_status&#x27;: 1, &#x27;operate_time&#x27;: &#x27;2025-09-0414: 32: 12&#x27;, &#x27;operator_id&#x27;: 4827976, &#x27;create_date&#x27;: &#x27;2025-09-0414: 32: 12&#x27;, &#x27;creator_id&#x27;: 4827976, &#x27;result_status&#x27;: &#x27;no_calc&#x27;, &#x27;obj_id&#x27;: 4845716, &#x27;position_id&#x27;: 18691437, &#x27;dept_id&#x27;: 18687153, &#x27;job_id&#x27;: 13257203, &#x27;job_information_master_id&#x27;: 13257203, &#x27;ori_card_id&#x27;: None, &#x27;object_group_id&#x27;: None, &#x27;temporary_id&#x27;: &#x27;5bf515f0ee9e4f6fa9131831b597794c&#x27;, &#x27;id&#x27;: 5163 &#125;, &#x27;stage_info&#x27;: &#123; &#x27;id&#x27;: 4468, &#x27;company_id&#x27;: 3589, &#x27;number&#x27;: None, &#x27;name&#x27;: &#x27;中层互评&#x27;, &#x27;description&#x27;: None, &#x27;operate_time&#x27;: &#x27;2025-09-0410: 50: 01&#x27;, &#x27;operator_id&#x27;: 4827976, &#x27;scheme_id&#x27;: 88, &#x27;stage_type&#x27;: &#x27;multi_score&#x27;, &#x27;role&#x27;: None, &#x27;employee_id&#x27;: None, &#x27;position_id&#x27;: None, &#x27;order&#x27;: 2, &#x27;weight&#x27;: 10.0, &#x27;is_system&#x27;: None, &#x27;manager_team_role_id&#x27;: None, &#x27;level&#x27;: 0, &#x27;level_type&#x27;: &#x27;range&#x27;, &#x27;end_level&#x27;: -1, &#x27;customize_api&#x27;: None, &#x27;is_modify_score&#x27;: False, &#x27;is_default_score&#x27;: 1, &#x27;is_auto_jump&#x27;: False, &#x27;dept_type&#x27;: 1, &#x27;is_score&#x27;: True, &#x27;is_show_other_score&#x27;: False, &#x27;weight_check&#x27;: 2, &#x27;is_jump_and_score&#x27;: False, &#x27;is_receive_notice&#x27;: True, &#x27;approve_type&#x27;: 0, &#x27;is_enter_next_stage&#x27;: False, &#x27;is_auto_cal&#x27;: True, &#x27;is_auto_level&#x27;: False, &#x27;is_revoke&#x27;: False, &#x27;is_revoke_adjust&#x27;: False, &#x27;calc_type&#x27;: 3, &#x27;is_choose_next_executor&#x27;: False, &#x27;is_appeal&#x27;: False, &#x27;is_push_data&#x27;: True, &#x27;is_recover_stage_executor&#x27;: False, &#x27;is_adjust&#x27;: False, &#x27;is_calc_target&#x27;: False, &#x27;sign_file_id&#x27;: None, &#x27;automatic_task_api&#x27;: None, &#x27;begin_date&#x27;: None, &#x27;end_date&#x27;: None, &#x27;hide_stage&#x27;: False, &#x27;remove_self&#x27;: True, &#x27;custom_state_params&#x27;: None, &#x27;todo_rule&#x27;: None, &#x27;is_show_dimension_score_detail&#x27;: False, &#x27;score_scale_id&#x27;: 1, &#x27;score_mode&#x27;: 2, &#x27;is_level&#x27;: True, &#x27;info_layout_id&#x27;: None, &#x27;is_show_ai&#x27;: False, &#x27;is_show_process_detail&#x27;: False, &#x27;is_show_process_board&#x27;: True, &#x27;is_hand_over&#x27;: False, &#x27;is_co_organizer&#x27;: False, &#x27;is_show_last_score&#x27;: None, &#x27;stage_rule_id&#x27;: None, &#x27;is_approve_revoke&#x27;: None, &#x27;process_id&#x27;: None, &#x27;copy_id&#x27;: None, &#x27;employee&#x27;: None, &#x27;position&#x27;: None, &#x27;manager_team_role&#x27;: None, &#x27;score_scale&#x27;: &#123; &#x27;id&#x27;: 1, &#x27;company_id&#x27;: 3589, &#x27;dept_id&#x27;: 18687152, &#x27;number&#x27;: None, &#x27;name&#x27;: &#x27;分数匹配等级&#x27;, &#x27;description&#x27;: None, &#x27;score_type&#x27;: 2, &#x27;operate_time&#x27;: &#x27;2025-07-2416: 17: 53&#x27;, &#x27;operator_id&#x27;: 4827976, &#x27;status&#x27;: 1, &#x27;is_share&#x27;: True, &#x27;scheme_id&#x27;: None, &#x27;max_completion_value&#x27;: None, &#x27;min_completion_value&#x27;: None, &#x27;result_decimal&#x27;: None, &#x27;rule_type&#x27;: None, &#x27;max_score&#x27;: None, &#x27;min_score&#x27;: None &#125;, &#x27;info_layout&#x27;: None, &#x27;stage_rule&#x27;: None &#125;, &#x27;score_set_info&#x27;: [ &#123; &#x27;id&#x27;: 318, &#x27;company_id&#x27;: 3589, &#x27;number&#x27;: None, &#x27;description&#x27;: None, &#x27;operate_time&#x27;: &#x27;2025-09-0410: 50: 01&#x27;, &#x27;operator_id&#x27;: 4827976, &#x27;name&#x27;: &#x27;中层互评&#x27;, &#x27;role&#x27;: &#x27;customize&#x27;, &#x27;weight&#x27;: 0.0, &#x27;stage_id&#x27;: 4468, &#x27;employee_id&#x27;: None, &#x27;employee_ids&#x27;: None, &#x27;position_id&#x27;: None, &#x27;manager_team_role_id&#x27;: None, &#x27;level&#x27;: 0, &#x27;customize_api&#x27;: &#x27;GetHDeptChargeEmpList&#x27;, &#x27;level_type&#x27;: &#x27;range&#x27;, &#x27;end_level&#x27;: -1, &#x27;dept_type&#x27;: 1, &#x27;stage&#x27;: &#123; &#x27;id&#x27;: 4468, &#x27;company_id&#x27;: 3589, &#x27;number&#x27;: None, &#x27;name&#x27;: &#x27;中层互评&#x27;, &#x27;description&#x27;: None, &#x27;operate_time&#x27;: &#x27;2025-09-0410: 50: 01&#x27;, &#x27;operator_id&#x27;: 4827976, &#x27;scheme_id&#x27;: 88, &#x27;stage_type&#x27;: &#x27;multi_score&#x27;, &#x27;role&#x27;: None, &#x27;employee_id&#x27;: None, &#x27;position_id&#x27;: None, &#x27;order&#x27;: 2, &#x27;weight&#x27;: 10.0, &#x27;is_system&#x27;: None, &#x27;manager_team_role_id&#x27;: None, &#x27;level&#x27;: 0, &#x27;level_type&#x27;: &#x27;range&#x27;, &#x27;end_level&#x27;: -1, &#x27;customize_api&#x27;: None, &#x27;is_modify_score&#x27;: False, &#x27;is_default_score&#x27;: 1, &#x27;is_auto_jump&#x27;: False, &#x27;dept_type&#x27;: 1, &#x27;is_score&#x27;: True, &#x27;is_show_other_score&#x27;: False, &#x27;weight_check&#x27;: 2, &#x27;is_jump_and_score&#x27;: False, &#x27;is_receive_notice&#x27;: True, &#x27;approve_type&#x27;: 0, &#x27;is_enter_next_stage&#x27;: False, &#x27;is_auto_cal&#x27;: True, &#x27;is_auto_level&#x27;: False, &#x27;is_revoke&#x27;: False, &#x27;is_revoke_adjust&#x27;: False, &#x27;calc_type&#x27;: 3, &#x27;is_choose_next_executor&#x27;: False, &#x27;is_appeal&#x27;: False, &#x27;is_push_data&#x27;: True, &#x27;is_recover_stage_executor&#x27;: False, &#x27;is_adjust&#x27;: False, &#x27;is_calc_target&#x27;: False, &#x27;sign_file_id&#x27;: None, &#x27;automatic_task_api&#x27;: None, &#x27;begin_date&#x27;: None, &#x27;end_date&#x27;: None, &#x27;hide_stage&#x27;: False, &#x27;remove_self&#x27;: True, &#x27;custom_state_params&#x27;: None, &#x27;todo_rule&#x27;: None, &#x27;is_show_dimension_score_detail&#x27;: False, &#x27;score_scale_id&#x27;: 1, &#x27;score_mode&#x27;: 2, &#x27;is_level&#x27;: True, &#x27;info_layout_id&#x27;: None, &#x27;is_show_ai&#x27;: False, &#x27;is_show_process_detail&#x27;: False, &#x27;is_show_process_board&#x27;: True, &#x27;is_hand_over&#x27;: False, &#x27;is_co_organizer&#x27;: False, &#x27;is_show_last_score&#x27;: None, &#x27;stage_rule_id&#x27;: None, &#x27;is_approve_revoke&#x27;: None, &#x27;process_id&#x27;: None, &#x27;copy_id&#x27;: None &#125;, &#x27;employee&#x27;: None, &#x27;position&#x27;: None, &#x27;manager_team_role&#x27;: None &#125; ], &#x27;exe_context&#x27;: &#123; &#x27;card_list&#x27;: [ &#123; &#x27;company_id&#x27;: 3589, &#x27;name&#x27;: &#x27;测试2&#x27;, &#x27;obj_type&#x27;: 1, &#x27;cycle&#x27;: 1, &#x27;year&#x27;: &#x27;2025&#x27;, &#x27;assess_cycle&#x27;: &#x27;2025年一月&#x27;, &#x27;activity_id&#x27;: 81, &#x27;scheme_id&#x27;: 88, &#x27;current_stage_id&#x27;: 4467, &#x27;status&#x27;: 0, &#x27;card_status&#x27;: 1, &#x27;operate_time&#x27;: &#x27;2025-09-0414: 32: 12&#x27;, &#x27;operator_id&#x27;: 4827976, &#x27;create_date&#x27;: &#x27;2025-09-0414: 32: 12&#x27;, &#x27;creator_id&#x27;: 4827976, &#x27;result_status&#x27;: &#x27;no_calc&#x27;, &#x27;obj_id&#x27;: 4827976, &#x27;position_id&#x27;: 18691425, &#x27;dept_id&#x27;: 18687153, &#x27;job_id&#x27;: 13242729, &#x27;job_information_master_id&#x27;: 13242729, &#x27;ori_card_id&#x27;: None, &#x27;object_group_id&#x27;: None, &#x27;temporary_id&#x27;: &#x27;db23323158fb455abf048af446f50cde&#x27;, &#x27;id&#x27;: 5160 &#125;, &#123; &#x27;company_id&#x27;: 3589, &#x27;name&#x27;: &#x27;测试2&#x27;, &#x27;obj_type&#x27;: 1, &#x27;cycle&#x27;: 1, &#x27;year&#x27;: &#x27;2025&#x27;, &#x27;assess_cycle&#x27;: &#x27;2025年一月&#x27;, &#x27;activity_id&#x27;: 81, &#x27;scheme_id&#x27;: 88, &#x27;current_stage_id&#x27;: 4467, &#x27;status&#x27;: 0, &#x27;card_status&#x27;: 1, &#x27;operate_time&#x27;: &#x27;2025-09-0414: 32: 12&#x27;, &#x27;operator_id&#x27;: 4827976, &#x27;create_date&#x27;: &#x27;2025-09-0414: 32: 12&#x27;, &#x27;creator_id&#x27;: 4827976, &#x27;result_status&#x27;: &#x27;no_calc&#x27;, &#x27;obj_id&#x27;: 4855913, &#x27;position_id&#x27;: 18691425, &#x27;dept_id&#x27;: 18687153, &#x27;job_id&#x27;: 13262483, &#x27;job_information_master_id&#x27;: 13262483, &#x27;ori_card_id&#x27;: None, &#x27;object_group_id&#x27;: None, &#x27;temporary_id&#x27;: &#x27;d696e77986ac4bbdaf6ac2eeefd20c30&#x27;, &#x27;id&#x27;: 5161 &#125;, &#123; &#x27;company_id&#x27;: 3589, &#x27;name&#x27;: &#x27;测试2&#x27;, &#x27;obj_type&#x27;: 1, &#x27;cycle&#x27;: 1, &#x27;year&#x27;: &#x27;2025&#x27;, &#x27;assess_cycle&#x27;: &#x27;2025年一月&#x27;, &#x27;activity_id&#x27;: 81, &#x27;scheme_id&#x27;: 88, &#x27;current_stage_id&#x27;: 4467, &#x27;status&#x27;: 0, &#x27;card_status&#x27;: 1, &#x27;operate_time&#x27;: &#x27;2025-09-0414: 32: 12&#x27;, &#x27;operator_id&#x27;: 4827976, &#x27;create_date&#x27;: &#x27;2025-09-0414: 32: 12&#x27;, &#x27;creator_id&#x27;: 4827976, &#x27;result_status&#x27;: &#x27;no_calc&#x27;, &#x27;obj_id&#x27;: 4855914, &#x27;position_id&#x27;: 18691425, &#x27;dept_id&#x27;: 18687153, &#x27;job_id&#x27;: 13262484, &#x27;job_information_master_id&#x27;: 13262484, &#x27;ori_card_id&#x27;: None, &#x27;object_group_id&#x27;: None, &#x27;temporary_id&#x27;: &#x27;5b1ed4f54d0a4f2fa2bbc2692a99bafe&#x27;, &#x27;id&#x27;: 5162 &#125;, &#123; &#x27;company_id&#x27;: 3589, &#x27;name&#x27;: &#x27;测试2&#x27;, &#x27;obj_type&#x27;: 1, &#x27;cycle&#x27;: 1, &#x27;year&#x27;: &#x27;2025&#x27;, &#x27;assess_cycle&#x27;: &#x27;2025年一月&#x27;, &#x27;activity_id&#x27;: 81, &#x27;scheme_id&#x27;: 88, &#x27;current_stage_id&#x27;: 4467, &#x27;status&#x27;: 0, &#x27;card_status&#x27;: 1, &#x27;operate_time&#x27;: &#x27;2025-09-0414: 32: 12&#x27;, &#x27;operator_id&#x27;: 4827976, &#x27;create_date&#x27;: &#x27;2025-09-0414: 32: 12&#x27;, &#x27;creator_id&#x27;: 4827976, &#x27;result_status&#x27;: &#x27;no_calc&#x27;, &#x27;obj_id&#x27;: 4845716, &#x27;position_id&#x27;: 18691437, &#x27;dept_id&#x27;: 18687153, &#x27;job_id&#x27;: 13257203, &#x27;job_information_master_id&#x27;: 13257203, &#x27;ori_card_id&#x27;: None, &#x27;object_group_id&#x27;: None, &#x27;temporary_id&#x27;: &#x27;5bf515f0ee9e4f6fa9131831b597794c&#x27;, &#x27;id&#x27;: 5163 &#125; ], &#x27;get_executor_by_stage_cj4&#x27;: &#123; &#x27;5160&#x27;: [ 4855803, 4855802 ], &#x27;5161&#x27;: [ 4855806, 4855804 ], &#x27;5162&#x27;: [ 4855803, 4855802 ], &#x27;5163&#x27;: [ 4855821, 4854740 ] &#125; &#125;&#125; 返回值 1_result2-[4855803, 4855802] 触发云函数执行，添加人和组织或方案 添加考核人 自动生成多个执行人","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"061-薪酬上报DB文件实例","slug":"项目/HCM教程/061-薪酬上报DB文件实例","date":"2025-07-01T12:00:00.000Z","updated":"2025-09-09T06:19:59.349Z","comments":true,"path":"2025/07/01/项目/HCM教程/061-薪酬上报DB文件实例/","link":"","permalink":"https://dbbruce.github.io/2025/07/01/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/061-%E8%96%AA%E9%85%AC%E4%B8%8A%E6%8A%A5DB%E6%96%87%E4%BB%B6%E5%AE%9E%E4%BE%8B/","excerpt":"薪酬上报与DB文件常见实例","text":"薪酬上报与DB文件常见实例 按钮配置123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424&quot;actions&quot;: [ &#123; &quot;key&quot;: &quot;flex_field&quot;, &quot;label&quot;: &quot;弹性字段&quot;, &quot;action&quot;: &quot;FLEX_FIELD&quot;, &quot;left&quot;: true, &quot;target&quot;: [ &quot;pc&quot; ], &quot;data&quot;: &quot;ReportIntegrateInstance&quot; &#125;, &#123; &quot;key&quot;: &quot;setup&quot;, &quot;label&quot;: &quot;元数据配置&quot;, &quot;action&quot;: &quot;SETUP&quot;, &quot;left&quot;: true, &quot;target&quot;: [ &quot;pc&quot; ], &quot;data&quot;: &quot;ReportIntegrateInstance.meta.list.collect_inside.json&quot; &#125;, &#123; &quot;key&quot;: &quot;new&quot;, &quot;label&quot;: &quot;创建上报活动&quot;, &quot;action&quot;: &quot;NEW&quot;, &quot;icon&quot;: &quot;icon-hcm-add-circle&quot;, &quot;is_important&quot;: true &#125;, &#123; &quot;key&quot;: &quot;edit&quot;, &quot;label&quot;: &quot;编辑&quot;, &quot;default&quot;: false, &quot;action&quot;: &quot;EDIT&quot;, &quot;left&quot;: true, &quot;condition&quot;: &quot;ITEM&quot; &#125;, &#123; &quot;key&quot;: &quot;delete&quot;, &quot;label&quot;: &quot;删除&quot;, &quot;left&quot;: true, &quot;action&quot;: &quot;DELETE&quot;, &quot;condition&quot;: &quot;ITEM&quot; &#125;, &#123; &quot;key&quot;: &quot;print&quot;, &quot;label&quot;: &quot;打印&quot;, &quot;action&quot;: &quot;PRINT&quot;, &quot;left&quot;: true, &quot;hide&quot;: true, &quot;condition&quot;: &quot;ITEM&quot; &#125;, &#123; &quot;label&quot;: &quot;业务仓库&quot;, &quot;key&quot;: &quot;bizStore&quot;, &quot;left&quot;: true, &quot;action&quot;: &quot;BIZ_STORE&quot;, &quot;hide&quot;: true, &quot;params&quot;: &#123; &quot;add_info&quot;: null &#125; &#125;, &#123; &quot;key&quot;: &quot;view&quot;, &quot;label&quot;: &quot;查看&quot;, &quot;action&quot;: &quot;VIEW&quot;, &quot;condition&quot;: &quot;ITEM&quot;, &quot;default&quot;: true &#125;, &#123; &quot;key&quot;: &quot;validate&quot;, &quot;label&quot;: &quot;数据校验&quot;, &quot;condition&quot;: &quot;ITEM&quot;, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;ac1&quot;, &quot;action&quot;: &quot;OPEN_WEBSOCKET&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.inst.operate&quot;, &quot;params&quot;: &#123; &quot;inst_id&quot;: &quot;expression[GET(SELECT_ITEM(),[&#x27;id&#x27;])]&quot;, &quot;command&quot;: &quot;up_data_validate&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;ac2&quot;, &quot;action&quot;: &quot;REFRESH&quot; &#125; ] &#125;, &#123; &quot;label&quot;: &quot;校验报告&quot;, &quot;key&quot;: &quot;validate_report&quot;, &quot;condition&quot;: &quot;ITEM&quot;, &quot;actions&quot;: [ &#123; &quot;label&quot;: &quot;查看&quot;, &quot;key&quot;: &quot;view&quot;, &quot;condition&quot;: &quot;ITEM&quot;, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;ac1&quot;, &quot;action&quot;: &quot;OPEN_WEBSOCKET&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.validate.report&quot;, &quot;begin_tip&quot;: &quot;开始生成文件&quot;, &quot;params&quot;: &#123; &quot;inst_id&quot;: &quot;expression[GET(SELECT_ITEM(),[&#x27;id&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;ac2&quot;, &quot;action&quot;: &quot;DIALOG_CUSTOMER_HTML&quot;, &quot;options&quot;: &#123; &quot;bind_html&quot;: &quot;expression[RES(&#x27;ac1&#x27;)]&quot;, &quot;title&quot;: &quot;校验报告&quot;, &quot;size&quot;: &quot;super-max&quot; &#125; &#125; ] &#125;, &#123; &quot;label&quot;: &quot;下载&quot;, &quot;key&quot;: &quot;download&quot;, &quot;condition&quot;: &quot;ITEM&quot;, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;ac1&quot;, &quot;action&quot;: &quot;OPEN_WEBSOCKET&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.validate.report&quot;, &quot;begin_tip&quot;: &quot;开始生成文件&quot;, &quot;params&quot;: &#123; &quot;inst_id&quot;: &quot;expression[GET(SELECT_ITEM(),[&#x27;id&#x27;])]&quot;, &quot;file_type&quot;: &quot;xlsx&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;ac2&quot;, &quot;action&quot;: &quot;COMMON_DOWNLOAD&quot;, &quot;options&quot;: &#123; &quot;index&quot;: &quot;expression[RES(&#x27;ac1&#x27;)]&quot; &#125; &#125; ] &#125; ] &#125;, &#123; &quot;key&quot;: &quot;db_make&quot;, &quot;label&quot;: &quot;生成DB文件&quot;, &quot;condition&quot;: &quot;ITEM&quot;, &quot;hide&quot;: false, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;ac0&quot;, &quot;action&quot;: &quot;SIMPLE_FORM&quot;, &quot;options&quot;: &#123; &quot;title&quot;: &quot;文件类型&quot;, &quot;form_options&quot;: &#123; &quot;size&quot;: &quot;small&quot; &#125;, &quot;meta&quot;: [ &#123; &quot;key&quot;: &quot;dsp_data_type&quot;, &quot;label&quot;: &quot;类型&quot;, &quot;component&quot;: &quot;hc-input-radio&quot;, &quot;options&quot;: &#123; &quot;default&quot;: &quot;Y&quot;, &quot;singleLine&quot;: true, &quot;list&quot;: [ &#123; &quot;name&quot;: &quot;正式&quot;, &quot;value&quot;: &quot;Y&quot; &#125;, &#123; &quot;name&quot;: &quot;测试&quot;, &quot;value&quot;: &quot;N&quot; &#125; ], &quot;items_inline&quot;: true &#125; &#125; ] &#125; &#125;, &#123; &quot;key&quot;: &quot;ac1&quot;, &quot;action&quot;: &quot;OPEN_WEBSOCKET&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.inst.operate&quot;, &quot;params&quot;: &#123; &quot;inst_id&quot;: &quot;expression[GET(SELECT_ITEM(),[&#x27;id&#x27;])]&quot;, &quot;command&quot;: &quot;sqlite_file&quot;, &quot;extra_params&quot;: &#123; &quot;dsp_data_type&quot;: &quot;expression[GET(RES(&#x27;ac0&#x27;),[&#x27;dsp_data_type&#x27;])]&quot; &#125; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;ac2&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.db.make.summary.parse&quot;, &quot;params&quot;: &#123; &quot;inst_id&quot;: &quot;expression[GET(SELECT_ITEM(),[&#x27;id&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;ac3&quot;, &quot;action&quot;: &quot;DIALOG_CUSTOMER_HTML&quot;, &quot;options&quot;: &#123; &quot;bind_html&quot;: &quot;expression[RES(&#x27;ac2&#x27;)]&quot;, &quot;title&quot;: &quot;DB描述&quot;, &quot;size&quot;: &quot;small-middle&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;ac4&quot;, &quot;action&quot;: &quot;REFRESH&quot; &#125; ] &#125;, &#123; &quot;key&quot;: &quot;reply_report&quot;, &quot;label&quot;: &quot;查看上报结果&quot;, &quot;condition&quot;: &quot;ITEM&quot;, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;ac1&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.reply.report&quot;, &quot;params&quot;: &#123; &quot;inst_id&quot;: &quot;expression[GET(SELECT_ITEM(),[&#x27;id&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;ac2&quot;, &quot;action&quot;: &quot;DIALOG_CUSTOMER_HTML&quot;, &quot;options&quot;: &#123; &quot;bind_html&quot;: &quot;expression[RES(&#x27;ac1&#x27;)]&quot;, &quot;title&quot;: &quot;校验报告&quot;, &quot;size&quot;: &quot;super-max&quot; &#125; &#125; ] &#125;, &#123; &quot;key&quot;: &quot;download_updata&quot;, &quot;label&quot;: &quot;下载已上报数据&quot;, &quot;condition&quot;: &quot;ITEM&quot;, &quot;validators&quot;: [ &#123; &quot;validator&quot;: &quot;expression[NOT(GET(SELECT_ITEM(),[&#x27;db_package_index&#x27;]))]&quot;, &quot;tips&quot;: &quot;该月份数据尚未生成上报DB文件信息，请确认是否已完成【生成DB文件】操作!&quot;, &quot;tips_type&quot;: &quot;confirm&quot; &#125; ], &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;options&quot;, &quot;action&quot;: &quot;SIMPLE_FORM&quot;, &quot;options&quot;: &#123; &quot;title&quot;: &quot;文件保护密码&quot;, &quot;form_options&quot;: &#123; &quot;size&quot;: &quot;small&quot;, &quot;tip&quot;: &quot;该密码信息用于加/解密文档数据，保障文件由操作人持有，其他人无法下载查看！请牢记该密码信息&quot; &#125;, &quot;meta&quot;: [ &#123; &quot;key&quot;: &quot;pwd&quot;, &quot;label&quot;: &quot;密码&quot;, &quot;component&quot;: &quot;hc-input&quot;, &quot;options&quot;: &#123; &quot;singleLine&quot;: true, &quot;required&quot;: true, &quot;width&quot;: &quot;col-12&quot;, &quot;type&quot;: &quot;password&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;reset&quot;, &quot;label&quot;: &quot;重设密码&quot;, &quot;component&quot;: &quot;hc-input-radio&quot;, &quot;options&quot;: &#123; &quot;required&quot;: true, &quot;default&quot;: false, &quot;items_inline&quot;: true, &quot;singleLine&quot;: true, &quot;tip&quot;: &quot;当忘记密码时，可进行重设，并重新生成加密文档！&quot;, &quot;list&quot;: [ &#123; &quot;name&quot;: &quot;否&quot;, &quot;value&quot;: 0 &#125;, &#123; &quot;name&quot;: &quot;是&quot;, &quot;value&quot;: 1 &#125; ] &#125; &#125; ] &#125; &#125;, &#123; &quot;key&quot;: &quot;exec&quot;, &quot;action&quot;: &quot;OPEN_WEBSOCKET&quot;, &quot;label&quot;: &quot;执行下载&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.inst.operate&quot;, &quot;params&quot;: &#123; &quot;inst_id&quot;: &quot;expression[GET(SELECT_ITEM(),[&#x27;id&#x27;])]&quot;, &quot;command&quot;: &quot;export_up_data&quot;, &quot;extra_params&quot;: &#123; &quot;pwd&quot;: &quot;expression[GET(RES(&#x27;options&#x27;),[&#x27;pwd&#x27;])]&quot;, &quot;reset&quot;: &quot;expression[GET(RES(&#x27;options&#x27;),[&#x27;reset&#x27;])]&quot; &#125; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;download&quot;, &quot;action&quot;: &quot;COMMON_DOWNLOAD&quot;, &quot;options&quot;: &#123; &quot;index&quot;: &quot;expression[GET(RES(&#x27;exec&#x27;),[&#x27;index&#x27;])]&quot;, &quot;encrypt_type&quot;: &quot;aes&quot;, &quot;export_name&quot;: &quot;expression[GET(RES(&#x27;exec&#x27;),[&#x27;export_name&#x27;])]&quot;, &quot;file_type&quot;: &quot;expression[GET(RES(&#x27;exec&#x27;),[&#x27;file_type&#x27;])]&quot; &#125; &#125; ] &#125;, &#123; &quot;key&quot;: &quot;view_operate_log&quot;, &quot;label&quot;: &quot;操作记录&quot;, &quot;condition&quot;: &quot;ITEM&quot;, &quot;action&quot;: &quot;COMMON_LIST_DIALOG&quot;, &quot;options&quot;: &#123; &quot;component&quot;: &quot;hc-category-list-selector&quot;, &quot;title&quot;: &quot;操作记录&quot;, &quot;selectorModel&quot;: &quot;ReportOperateLog&quot;, &quot;selectorType&quot;: 0, &quot;filter_dict&quot;: &#123; &quot;source_model&quot;: &#123; &quot;neq&quot;: &quot;ReportIntegrate1180Instance&quot; &#125;, &quot;inst_id&quot;: &quot;expression[GET(SELECT_ITEM(),[&#x27;id&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;download_report&quot;, &quot;label&quot;: &quot;下载报告&quot;, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;ac0&quot;, &quot;action&quot;: &quot;OPEN_WEBSOCKET&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;private.build_report&quot;, &quot;params&quot;: &#123; &quot;inst_id&quot;: &quot;expression[GET(SELECT_ITEM(),[&#x27;id&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;ac1&quot;, &quot;action&quot;: &quot;COMMON_DOWNLOAD&quot;, &quot;options&quot;: &#123; &quot;index&quot;: &quot;expression[RES(&#x27;ac0&#x27;)]&quot; &#125; &#125; ] &#125;, &#123; &quot;key&quot;: &quot;upload_zb_file&quot;, &quot;label&quot;: &quot;上传指标文件&quot;, &quot;action&quot;: &quot;COMMON_UPLOAD&quot;, &quot;options&quot;: &#123; &quot;mode&quot;: &quot;document&quot;, &quot;params&quot;: &#123; &quot;file_type&quot;: [ &quot;db&quot; ] &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;db_push&quot;, &quot;condition&quot;: &quot;ITEM&quot;, &quot;label&quot;: &quot;推送db文件&quot;, &quot;func&quot;: &quot;=function()&#123;dataService.callHcmOpenApi(&#x27;private.db_push&#x27;,&#123;&#x27;id&#x27;:ITEM().id,&#x27;month&#x27;:ITEM().month&#125;).then(function(res)&#123;if(res == &#x27;报送成功&#x27;) &#123;SCOPE.show_warning(&#x27;推送成功&#x27;)&#125; else &#123;SCOPE.show_warning(&#x27;推送失败&#x27;)&#125;&#125;)&#125;&quot;, &quot;hide&quot;: false &#125;, &#123; &quot;key&quot;: &quot;download_db&quot;, &quot;label&quot;: &quot;下载DB文件&quot;, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;ac1&quot;, &quot;action&quot;: &quot;OPEN_WEBSOCKET&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;private.download_db&quot;, &quot;params&quot;: &#123; &quot;inst_id&quot;: &quot;expression[GET(SELECT_ITEM(),&#x27;id&#x27;)]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;ac2&quot;, &quot;action&quot;: &quot;COMMON_DOWNLOAD&quot;, &quot;options&quot;: &#123; &quot;index&quot;: &quot;expression[RES(&#x27;ac1&#x27;)]&quot; &#125; &#125; ] &#125; ] 【推送db文件】按钮 - 云函123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172class HandlePackDb(BasePrivateApiService): def execute(self, **kwargs): try: # 获取报告id report_id = kwargs.get(&quot;id&quot;) month=kwargs.get(&quot;month&quot;) # 获取报告的数据库文件 body_name_dict = CustomerUtil.call_open_api(&quot;hcm.model.action.params&quot;, &#123;&quot;model&quot;: &quot;ReportIntegrateInstance&quot;, &quot;action&quot;: &quot;get_db_file&quot;, &quot;params&quot;: &#123;&quot;id_&quot;: report_id&#125;&#125;) # 获取数据库文件内容 document_body = base64.b64decode(body_name_dict.get(&quot;document_body&quot;)) # 保存数据库文件 file_name = body_name_dict.get(&quot;file_name&quot;) # 保存数据库文件 with open(file_name, &#x27;wb&#x27;) as file: file.write(document_body) zip_name=self.create_zip_file(file_name) self.log(zip_name) self.log(month) res=self.upload_data(zip_name) return res except Exception as e: self.log(traceback.format_exc()) raise e def create_zip_file(self,db_file_path): uuid_str = uuid.uuid4().hex zip_filename = f&quot;file_&#123;uuid_str&#125;.zip&quot; with zipfile.ZipFile(zip_filename, &#x27;w&#x27;, zipfile.ZIP_DEFLATED) as zipf: zipf.write(db_file_path, db_file_path) return zip_filename def upload_data(self,zip_file_path): url = &quot;http://10.1.17.17:8098/dmp-datafactory/api/temp/reportTempFile&quot; headers = &#123;&#125; with open(zip_file_path, &#x27;rb&#x27;) as zip_file_binary: files = [( &#x27;file&#x27;,(zip_file_path, zip_file_binary, &#x27;application/octet-stream&#x27;)) ] data = &#123; &quot;TEMPINFOID&quot;: &quot;e673a659-9ce1-4346-b28b-29714d9d32ce&quot;, &quot;BUSTYPE&quot;: &#x27;1164&#x27; &#125; response = requests.post(url, headers=headers, files=files, data=data) if response.status_code == 200: self.log(&quot;请求成功&quot;) self.log(response.json()) # 打印响应内容 res=response.json() if res.get(&#x27;serviceFlag&#x27;) == &#x27;1&#x27;: return &#x27;报送成功&#x27; else: return &#x27;报送失败&#x27; def log(self, log_content): log_info = &#123;&quot;log_type&quot;: str(&#x27;db_push&#x27;), &quot;create_time&quot;: datetime.datetime.now().strftime(&#x27;%Y-%m-%d %H:%M:%S&#x27;), &quot;content&quot;: str(log_content)&#125; CustomerUtil.call_open_api(&quot;hcm.model.create&quot;, &#123;&quot;model&quot;: &quot;dynamic_log&quot;, &quot;info&quot;: log_info&#125;) 【下载DB文件】按钮1234567891011121314151617181920212223242526class PrivateAPIService(BasePrivateApiService): &quot;&quot;&quot; 动态私有OpenAPI 使用方法 &quot;&quot;&quot; def execute(self, **kwargs): def logger(p, m): if kwargs.get(&#x27;notify&#x27;): kwargs[&#x27;notify&#x27;](dict( progress=int(p), message=m )) logger(10, &#x27;正在解密db文件...&#x27;) file_data = self.call_open_api(&#x27;hcm.model.action.params&#x27;, &#123; &quot;model&quot;: &quot;ReportIntegrateInstance&quot;, &quot;action&quot;: &quot;get_db_file&quot;, &quot;params&quot;: &#123; &quot;id_&quot;: kwargs[&#x27;inst_id&#x27;] &#125; &#125;) logger(80, &#x27;转存文件中...&#x27;) with open(os.path.join(self.env.get_work_space_dir(), file_data[&#x27;file_name&#x27;]), &#x27;wb&#x27;) as f: f.write(base64.b64decode(file_data[&#x27;document_body&#x27;])) logger(100, &#x27;构建成功...&#x27;) return file_data[&#x27;file_name&#x27;]","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"060-entry_condition进入条件","slug":"项目/HCM教程/060-entry_condition进入条件","date":"2025-06-30T12:00:00.000Z","updated":"2025-09-03T05:59:30.253Z","comments":true,"path":"2025/06/30/项目/HCM教程/060-entry_condition进入条件/","link":"","permalink":"https://dbbruce.github.io/2025/06/30/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/060-entry_condition%E8%BF%9B%E5%85%A5%E6%9D%A1%E4%BB%B6/","excerpt":"entry_condition 进入条件 “expression[EQ(GET(RES(‘inst_data’),[‘count’]), 0)]” &#x3D; 数据等于0 “entry_condition”: “expression[RES(‘create_inst_data’)]” &#x3D; 有返回值 “entry_condition”: “expression[OR(RES(‘create_inst_data’), RES(‘inst_data’))]” &#x3D; 有返回值 或者 有返回值","text":"entry_condition 进入条件 “expression[EQ(GET(RES(‘inst_data’),[‘count’]), 0)]” &#x3D; 数据等于0 “entry_condition”: “expression[RES(‘create_inst_data’)]” &#x3D; 有返回值 “entry_condition”: “expression[OR(RES(‘create_inst_data’), RES(‘inst_data’))]” &#x3D; 有返回值 或者 有返回值 实例123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154&quot;actions&quot;: [ &#123; &quot;key&quot;: &quot;report_real_rpt&quot;, &quot;label&quot;: &quot;实时上报数据&quot;, &quot;hide&quot;: false, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;is_sealed_check&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.to.rpt.check.sealed.state&quot;, &quot;params&quot;: &#123; &quot;program_id&quot;: &quot;expression[parseInt(GET(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;provide_id&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;provide_id&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;inst_data&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;validators&quot;: [ &#123; &quot;validator&quot;: &quot;expression[RES(&#x27;is_sealed_check&#x27;)]&quot;, &quot;tips&quot;: &quot;当前方案下，存在未封存数据，不可上报！&quot; &#125; ], &quot;options&quot;: &#123; &quot;api&quot;: &quot;hcm.model.list&quot;, &quot;params&quot;: &#123; &quot;model&quot;: &quot;ReportIntegrate1180Instance&quot;, &quot;filter_dict&quot;: &#123; &quot;salary_month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;program_id&quot;: &quot;expression[GET(ENV(), [&#x27;program_id&#x27;])]&quot;, &quot;provide_id&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;provide_id&#x27;])]&quot; &#125;, &quot;extra_property&quot;: &#123; &quot;state&quot;: &quot;salaryRpt&quot; &#125;, &quot;page_size&quot;: 1, &quot;page_index&quot;: 1 &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;call_api&quot;, &quot;entry_condition&quot;: &quot;expression[EQ(GET(RES(&#x27;inst_data&#x27;),[&#x27;count&#x27;]), 0)]&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;hcm.model.list&quot;, &quot;params&quot;: &#123; &quot;model&quot;: &quot;SalaryRptProgramItemRelation&quot;, &quot;filter_dict&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(ENV(), [&#x27;program_id&#x27;])]&quot; &#125; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;sta_program&quot;, &quot;entry_condition&quot;: &quot;expression[EQ(GET(RES(&#x27;call_api&#x27;),[&#x27;count&#x27;]), 0)]&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;hcm.model.list&quot;, &quot;params&quot;: &#123; &quot;model&quot;: &quot;SalaryStatisticsProgram&quot;, &quot;extra_property&quot;: &#123; &quot;state&quot;: &quot;rptCollect&quot; &#125; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;create_inst_data&quot;, &quot;action&quot;: &quot;COMMON_INFO_DIALOG&quot;, &quot;entry_condition&quot;: &quot;expression[EQ(GET(RES(&#x27;inst_data&#x27;),[&#x27;count&#x27;]), 0)]&quot;, &quot;options&quot;: &#123; &quot;model&quot;: &quot;ReportIntegrate1180Instance&quot;, &quot;mode&quot;: &quot;new&quot;, &quot;state&quot;: &quot;salaryRpt&quot;, &quot;data&quot;: &#123; &quot;salary_month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;program_id&quot;: &quot;expression[parseInt(GET(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;provide_id&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;provide_id&#x27;])]&quot;, &quot;statistics_id&quot;: &quot;expression[IF(GT(GET(RES(&#x27;call_api&#x27;),[&#x27;count&#x27;]),0) ,GET(RES(&#x27;call_api&#x27;), [&#x27;list&#x27;,0,&#x27;statistics_program_id&#x27;]),IF(EQ(GET(RES(&#x27;sta_program&#x27;),[&#x27;count&#x27;]), 1),GET(RES(&#x27;sta_program&#x27;),[&#x27;list&#x27;,0,&#x27;id&#x27;]), null))]&quot;, &quot;dsp_data_type&quot;: &quot;Y&quot;, &quot;package_filter_dict&quot;: &quot;expression[IF(GET(FILTER_DICT(), [&#x27;provide_id&#x27;]),[&#123;&#x27;program_id&#x27;: parseInt(GET(ENV(), [&#x27;program_id&#x27;])),&#x27;provide_id&#x27;: GET(FILTER_DICT(), [&#x27;provide_id&#x27;])&#125;],[&#123;&#x27;program_id&#x27;: parseInt(GET(ENV(), [&#x27;program_id&#x27;]))&#125;])]&quot;, &quot;rpt_params&quot;: &#123; &quot;statistics_id&quot;: &quot;expression[IF(GT(GET(RES(&#x27;call_api&#x27;),[&#x27;count&#x27;]),0) ,GET(RES(&#x27;call_api&#x27;), [&#x27;list&#x27;,0,&#x27;statistics_program_id&#x27;]),IF(EQ(GET(RES(&#x27;sta_program&#x27;),[&#x27;count&#x27;]), 1),GET(RES(&#x27;sta_program&#x27;),[&#x27;list&#x27;,0,&#x27;id&#x27;]), null))]&quot; &#125; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;init_rpt_data&quot;, &quot;entry_condition&quot;: &quot;expression[RES(&#x27;create_inst_data&#x27;)]&quot;, &quot;action&quot;: &quot;WEBSOCKET_ACTION&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;calc.rpt.program.data.notify&quot;, &quot;beginTip&quot;: &quot;准备开始生成上报数据···&quot;, &quot;params&quot;: &#123; &quot;program_id&quot;: &quot;expression[parseInt(GET(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;inst_id&quot;: null, &quot;model_name&quot;: &quot;ReportEmpIncomeData&quot;, &quot;month&quot;: &quot;expression[GET(RES(&#x27;create_inst_data&#x27;),[&#x27;month&#x27;])]&quot;, &quot;provide_id&quot;: &quot;expression[GET(RES(&#x27;create_inst_data&#x27;),[&#x27;provide_id&#x27;])]&quot;, &quot;statistics_program_id&quot;: &quot;expression[GET(RES(&#x27;create_inst_data&#x27;),[&#x27;statistics_id&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;add_paytime_data&quot;, &quot;label&quot;: &quot;添加发薪时&quot;, &quot;action&quot;: &quot;OPEN_WEBSOCKET&quot;, &quot;entry_condition&quot;: &quot;expression[RES(&#x27;create_inst_data&#x27;)]&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;private.AddReportEmpIncomePayTime&quot;, &quot;beginTip&quot;: &quot;准备添加发薪时间...&quot;, &quot;params&quot;: &#123; &quot;program_id&quot;: &quot;expression[parseInt(GET(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;paytime&quot;: &quot;expression[GET(RES(&#x27;create_inst_data&#x27;),[&#x27;u_payday&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;super_go&quot;, &quot;entry_condition&quot;: &quot;expression[OR(RES(&#x27;create_inst_data&#x27;), RES(&#x27;inst_data&#x27;))]&quot;, &quot;action&quot;: &quot;GO_STATE&quot;, &quot;options&quot;: &#123; &quot;state&quot;: &quot;common_model_list&quot;, &quot;open_new_page&quot;: true, &quot;params&quot;: &#123; &quot;model&quot;: &quot;ReportIntegrate1180Instance&quot;, &quot;filter_str&quot;: &quot;&quot;, &quot;filter_dict&quot;: &#123; &quot;month&quot;: &quot;expression[IF(GT(GET(RES(&#x27;inst_data&#x27;), [&#x27;count&#x27;]), 0), GET(RES(&#x27;inst_data&#x27;), [&#x27;list&#x27;,0,&#x27;month&#x27;]), GET(RES(&#x27;create_inst_data&#x27;), [&#x27;month&#x27;]))]&quot; &#125;, &quot;meta_state&quot;: &quot;salaryView&quot;, &quot;advance_filter_dict&quot;: &#123; &quot;month&quot;: &#123; &quot;eq&quot;: &quot;expression[IF(GT(GET(RES(&#x27;inst_data&#x27;), [&#x27;count&#x27;]), 0), GET(RES(&#x27;inst_data&#x27;), [&#x27;list&#x27;,0,&#x27;month&#x27;]), GET(RES(&#x27;create_inst_data&#x27;), [&#x27;month&#x27;]))]&quot; &#125;, &quot;statistics_id&quot;: &quot;expression[IF(GT(GET(RES(&#x27;inst_data&#x27;), [&#x27;count&#x27;]), 0), GET(RES(&#x27;inst_data&#x27;), [&#x27;list&#x27;,0,&#x27;statistics_id&#x27;]), GET(RES(&#x27;create_inst_data&#x27;), [&#x27;statistics_id&#x27;]))]&quot;, &quot;program_id&quot;: &quot;expression[IF(GT(GET(RES(&#x27;inst_data&#x27;), [&#x27;count&#x27;]), 0), GET(RES(&#x27;inst_data&#x27;), [&#x27;list&#x27;,0,&#x27;program_id&#x27;]), GET(RES(&#x27;create_inst_data&#x27;), [&#x27;program_id&#x27;]))]&quot;, &quot;provide_id&quot;: &quot;expression[IF(GT(GET(RES(&#x27;inst_data&#x27;), [&#x27;count&#x27;]), 0), GET(RES(&#x27;inst_data&#x27;), [&#x27;list&#x27;,0,&#x27;provide_id&#x27;]), GET(RES(&#x27;create_inst_data&#x27;), [&#x27;provide_id&#x27;]))]&quot;, &quot;salary_month&quot;: &quot;expression[IF(GT(GET(RES(&#x27;inst_data&#x27;), [&#x27;count&#x27;]), 0), GET(RES(&#x27;inst_data&#x27;), [&#x27;list&#x27;,0,&#x27;salary_month&#x27;]), GET(RES(&#x27;create_inst_data&#x27;), [&#x27;salary_month&#x27;]))]&quot; &#125; &#125; &#125; &#125; ] &#125; ]","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"059-按钮点击弹窗","slug":"项目/HCM教程/059-按钮点击弹窗","date":"2025-06-29T12:00:00.000Z","updated":"2025-09-09T06:19:59.407Z","comments":true,"path":"2025/06/29/项目/HCM教程/059-按钮点击弹窗/","link":"","permalink":"https://dbbruce.github.io/2025/06/29/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/059-%E6%8C%89%E9%92%AE%E7%82%B9%E5%87%BB%E5%BC%B9%E7%AA%97/","excerpt":"点击【实时上报数据】弹窗 COMMON_INFO_DIALOG123456789101112131415161718192021&#123; &quot;key&quot;: &quot;create_inst_data&quot;, &quot;action&quot;: &quot;COMMON_INFO_DIALOG&quot;, &quot;entry_condition&quot;: &quot;expression[EQ(GET(RES(&#x27;inst_data&#x27;),[&#x27;count&#x27;]), 0)]&quot;, &quot;options&quot;: &#123; &quot;model&quot;: &quot;ReportIntegrate1180Instance&quot;, &quot;mode&quot;: &quot;new&quot;, &quot;state&quot;: &quot;salaryRpt&quot;, &quot;data&quot;: &#123; &quot;salary_month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;program_id&quot;: &quot;expression[parseInt(GET(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;provide_id&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;provide_id&#x27;])]&quot;, &quot;statistics_id&quot;: &quot;expression[IF(GT(GET(RES(&#x27;call_api&#x27;),[&#x27;count&#x27;]),0) ,GET(RES(&#x27;call_api&#x27;), [&#x27;list&#x27;,0,&#x27;statistics_program_id&#x27;]),IF(EQ(GET(RES(&#x27;sta_program&#x27;),[&#x27;count&#x27;]), 1),GET(RES(&#x27;sta_program&#x27;),[&#x27;list&#x27;,0,&#x27;id&#x27;]), null))]&quot;, &quot;dsp_data_type&quot;: &quot;Y&quot;, &quot;package_filter_dict&quot;: &quot;expression[IF(GET(FILTER_DICT(), [&#x27;provide_id&#x27;]),[&#123;&#x27;program_id&#x27;: parseInt(GET(ENV(), [&#x27;program_id&#x27;])),&#x27;provide_id&#x27;: GET(FILTER_DICT(), [&#x27;provide_id&#x27;])&#125;],[&#123;&#x27;program_id&#x27;: parseInt(GET(ENV(), [&#x27;program_id&#x27;]))&#125;])]&quot;, &quot;rpt_params&quot;: &#123; &quot;statistics_id&quot;: &quot;expression[IF(GT(GET(RES(&#x27;call_api&#x27;),[&#x27;count&#x27;]),0) ,GET(RES(&#x27;call_api&#x27;), [&#x27;list&#x27;,0,&#x27;statistics_program_id&#x27;]),IF(EQ(GET(RES(&#x27;sta_program&#x27;),[&#x27;count&#x27;]), 1),GET(RES(&#x27;sta_program&#x27;),[&#x27;list&#x27;,0,&#x27;id&#x27;]), null))]&quot; &#125; &#125; &#125;&#125;","text":"点击【实时上报数据】弹窗 COMMON_INFO_DIALOG123456789101112131415161718192021&#123; &quot;key&quot;: &quot;create_inst_data&quot;, &quot;action&quot;: &quot;COMMON_INFO_DIALOG&quot;, &quot;entry_condition&quot;: &quot;expression[EQ(GET(RES(&#x27;inst_data&#x27;),[&#x27;count&#x27;]), 0)]&quot;, &quot;options&quot;: &#123; &quot;model&quot;: &quot;ReportIntegrate1180Instance&quot;, &quot;mode&quot;: &quot;new&quot;, &quot;state&quot;: &quot;salaryRpt&quot;, &quot;data&quot;: &#123; &quot;salary_month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;program_id&quot;: &quot;expression[parseInt(GET(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;provide_id&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;provide_id&#x27;])]&quot;, &quot;statistics_id&quot;: &quot;expression[IF(GT(GET(RES(&#x27;call_api&#x27;),[&#x27;count&#x27;]),0) ,GET(RES(&#x27;call_api&#x27;), [&#x27;list&#x27;,0,&#x27;statistics_program_id&#x27;]),IF(EQ(GET(RES(&#x27;sta_program&#x27;),[&#x27;count&#x27;]), 1),GET(RES(&#x27;sta_program&#x27;),[&#x27;list&#x27;,0,&#x27;id&#x27;]), null))]&quot;, &quot;dsp_data_type&quot;: &quot;Y&quot;, &quot;package_filter_dict&quot;: &quot;expression[IF(GET(FILTER_DICT(), [&#x27;provide_id&#x27;]),[&#123;&#x27;program_id&#x27;: parseInt(GET(ENV(), [&#x27;program_id&#x27;])),&#x27;provide_id&#x27;: GET(FILTER_DICT(), [&#x27;provide_id&#x27;])&#125;],[&#123;&#x27;program_id&#x27;: parseInt(GET(ENV(), [&#x27;program_id&#x27;]))&#125;])]&quot;, &quot;rpt_params&quot;: &#123; &quot;statistics_id&quot;: &quot;expression[IF(GT(GET(RES(&#x27;call_api&#x27;),[&#x27;count&#x27;]),0) ,GET(RES(&#x27;call_api&#x27;), [&#x27;list&#x27;,0,&#x27;statistics_program_id&#x27;]),IF(EQ(GET(RES(&#x27;sta_program&#x27;),[&#x27;count&#x27;]), 1),GET(RES(&#x27;sta_program&#x27;),[&#x27;list&#x27;,0,&#x27;id&#x27;]), null))]&quot; &#125; &#125; &#125;&#125; 实例123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154&quot;actions&quot;: [ &#123; &quot;key&quot;: &quot;report_real_rpt&quot;, &quot;label&quot;: &quot;实时上报数据&quot;, &quot;hide&quot;: false, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;is_sealed_check&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.to.rpt.check.sealed.state&quot;, &quot;params&quot;: &#123; &quot;program_id&quot;: &quot;expression[parseInt(GET(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;provide_id&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;provide_id&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;inst_data&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;validators&quot;: [ &#123; &quot;validator&quot;: &quot;expression[RES(&#x27;is_sealed_check&#x27;)]&quot;, &quot;tips&quot;: &quot;当前方案下，存在未封存数据，不可上报！&quot; &#125; ], &quot;options&quot;: &#123; &quot;api&quot;: &quot;hcm.model.list&quot;, &quot;params&quot;: &#123; &quot;model&quot;: &quot;ReportIntegrate1180Instance&quot;, &quot;filter_dict&quot;: &#123; &quot;salary_month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;program_id&quot;: &quot;expression[GET(ENV(), [&#x27;program_id&#x27;])]&quot;, &quot;provide_id&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;provide_id&#x27;])]&quot; &#125;, &quot;extra_property&quot;: &#123; &quot;state&quot;: &quot;salaryRpt&quot; &#125;, &quot;page_size&quot;: 1, &quot;page_index&quot;: 1 &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;call_api&quot;, &quot;entry_condition&quot;: &quot;expression[EQ(GET(RES(&#x27;inst_data&#x27;),[&#x27;count&#x27;]), 0)]&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;hcm.model.list&quot;, &quot;params&quot;: &#123; &quot;model&quot;: &quot;SalaryRptProgramItemRelation&quot;, &quot;filter_dict&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(ENV(), [&#x27;program_id&#x27;])]&quot; &#125; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;sta_program&quot;, &quot;entry_condition&quot;: &quot;expression[EQ(GET(RES(&#x27;call_api&#x27;),[&#x27;count&#x27;]), 0)]&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;hcm.model.list&quot;, &quot;params&quot;: &#123; &quot;model&quot;: &quot;SalaryStatisticsProgram&quot;, &quot;extra_property&quot;: &#123; &quot;state&quot;: &quot;rptCollect&quot; &#125; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;create_inst_data&quot;, &quot;action&quot;: &quot;COMMON_INFO_DIALOG&quot;, &quot;entry_condition&quot;: &quot;expression[EQ(GET(RES(&#x27;inst_data&#x27;),[&#x27;count&#x27;]), 0)]&quot;, &quot;options&quot;: &#123; &quot;model&quot;: &quot;ReportIntegrate1180Instance&quot;, &quot;mode&quot;: &quot;new&quot;, &quot;state&quot;: &quot;salaryRpt&quot;, &quot;data&quot;: &#123; &quot;salary_month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;program_id&quot;: &quot;expression[parseInt(GET(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;provide_id&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;provide_id&#x27;])]&quot;, &quot;statistics_id&quot;: &quot;expression[IF(GT(GET(RES(&#x27;call_api&#x27;),[&#x27;count&#x27;]),0) ,GET(RES(&#x27;call_api&#x27;), [&#x27;list&#x27;,0,&#x27;statistics_program_id&#x27;]),IF(EQ(GET(RES(&#x27;sta_program&#x27;),[&#x27;count&#x27;]), 1),GET(RES(&#x27;sta_program&#x27;),[&#x27;list&#x27;,0,&#x27;id&#x27;]), null))]&quot;, &quot;dsp_data_type&quot;: &quot;Y&quot;, &quot;package_filter_dict&quot;: &quot;expression[IF(GET(FILTER_DICT(), [&#x27;provide_id&#x27;]),[&#123;&#x27;program_id&#x27;: parseInt(GET(ENV(), [&#x27;program_id&#x27;])),&#x27;provide_id&#x27;: GET(FILTER_DICT(), [&#x27;provide_id&#x27;])&#125;],[&#123;&#x27;program_id&#x27;: parseInt(GET(ENV(), [&#x27;program_id&#x27;]))&#125;])]&quot;, &quot;rpt_params&quot;: &#123; &quot;statistics_id&quot;: &quot;expression[IF(GT(GET(RES(&#x27;call_api&#x27;),[&#x27;count&#x27;]),0) ,GET(RES(&#x27;call_api&#x27;), [&#x27;list&#x27;,0,&#x27;statistics_program_id&#x27;]),IF(EQ(GET(RES(&#x27;sta_program&#x27;),[&#x27;count&#x27;]), 1),GET(RES(&#x27;sta_program&#x27;),[&#x27;list&#x27;,0,&#x27;id&#x27;]), null))]&quot; &#125; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;init_rpt_data&quot;, &quot;entry_condition&quot;: &quot;expression[RES(&#x27;create_inst_data&#x27;)]&quot;, &quot;action&quot;: &quot;WEBSOCKET_ACTION&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;calc.rpt.program.data.notify&quot;, &quot;beginTip&quot;: &quot;准备开始生成上报数据···&quot;, &quot;params&quot;: &#123; &quot;program_id&quot;: &quot;expression[parseInt(GET(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;inst_id&quot;: null, &quot;model_name&quot;: &quot;ReportEmpIncomeData&quot;, &quot;month&quot;: &quot;expression[GET(RES(&#x27;create_inst_data&#x27;),[&#x27;month&#x27;])]&quot;, &quot;provide_id&quot;: &quot;expression[GET(RES(&#x27;create_inst_data&#x27;),[&#x27;provide_id&#x27;])]&quot;, &quot;statistics_program_id&quot;: &quot;expression[GET(RES(&#x27;create_inst_data&#x27;),[&#x27;statistics_id&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;add_paytime_data&quot;, &quot;label&quot;: &quot;添加发薪时&quot;, &quot;action&quot;: &quot;OPEN_WEBSOCKET&quot;, &quot;entry_condition&quot;: &quot;expression[RES(&#x27;create_inst_data&#x27;)]&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;private.AddReportEmpIncomePayTime&quot;, &quot;beginTip&quot;: &quot;准备添加发薪时间...&quot;, &quot;params&quot;: &#123; &quot;program_id&quot;: &quot;expression[parseInt(GET(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;paytime&quot;: &quot;expression[GET(RES(&#x27;create_inst_data&#x27;),[&#x27;u_payday&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;super_go&quot;, &quot;entry_condition&quot;: &quot;expression[OR(RES(&#x27;create_inst_data&#x27;), RES(&#x27;inst_data&#x27;))]&quot;, &quot;action&quot;: &quot;GO_STATE&quot;, &quot;options&quot;: &#123; &quot;state&quot;: &quot;common_model_list&quot;, &quot;open_new_page&quot;: true, &quot;params&quot;: &#123; &quot;model&quot;: &quot;ReportIntegrate1180Instance&quot;, &quot;filter_str&quot;: &quot;&quot;, &quot;filter_dict&quot;: &#123; &quot;month&quot;: &quot;expression[IF(GT(GET(RES(&#x27;inst_data&#x27;), [&#x27;count&#x27;]), 0), GET(RES(&#x27;inst_data&#x27;), [&#x27;list&#x27;,0,&#x27;month&#x27;]), GET(RES(&#x27;create_inst_data&#x27;), [&#x27;month&#x27;]))]&quot; &#125;, &quot;meta_state&quot;: &quot;salaryView&quot;, &quot;advance_filter_dict&quot;: &#123; &quot;month&quot;: &#123; &quot;eq&quot;: &quot;expression[IF(GT(GET(RES(&#x27;inst_data&#x27;), [&#x27;count&#x27;]), 0), GET(RES(&#x27;inst_data&#x27;), [&#x27;list&#x27;,0,&#x27;month&#x27;]), GET(RES(&#x27;create_inst_data&#x27;), [&#x27;month&#x27;]))]&quot; &#125;, &quot;statistics_id&quot;: &quot;expression[IF(GT(GET(RES(&#x27;inst_data&#x27;), [&#x27;count&#x27;]), 0), GET(RES(&#x27;inst_data&#x27;), [&#x27;list&#x27;,0,&#x27;statistics_id&#x27;]), GET(RES(&#x27;create_inst_data&#x27;), [&#x27;statistics_id&#x27;]))]&quot;, &quot;program_id&quot;: &quot;expression[IF(GT(GET(RES(&#x27;inst_data&#x27;), [&#x27;count&#x27;]), 0), GET(RES(&#x27;inst_data&#x27;), [&#x27;list&#x27;,0,&#x27;program_id&#x27;]), GET(RES(&#x27;create_inst_data&#x27;), [&#x27;program_id&#x27;]))]&quot;, &quot;provide_id&quot;: &quot;expression[IF(GT(GET(RES(&#x27;inst_data&#x27;), [&#x27;count&#x27;]), 0), GET(RES(&#x27;inst_data&#x27;), [&#x27;list&#x27;,0,&#x27;provide_id&#x27;]), GET(RES(&#x27;create_inst_data&#x27;), [&#x27;provide_id&#x27;]))]&quot;, &quot;salary_month&quot;: &quot;expression[IF(GT(GET(RES(&#x27;inst_data&#x27;), [&#x27;count&#x27;]), 0), GET(RES(&#x27;inst_data&#x27;), [&#x27;list&#x27;,0,&#x27;salary_month&#x27;]), GET(RES(&#x27;create_inst_data&#x27;), [&#x27;salary_month&#x27;]))]&quot; &#125; &#125; &#125; &#125; ] &#125; ]","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"058-model校验器","slug":"项目/HCM教程/058-model校验器","date":"2025-06-28T12:00:00.000Z","updated":"2025-09-09T06:19:59.421Z","comments":true,"path":"2025/06/28/项目/HCM教程/058-model校验器/","link":"","permalink":"https://dbbruce.github.io/2025/06/28/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/058-model%E6%A0%A1%E9%AA%8C%E5%99%A8/","excerpt":"功能：工作说明内容必须填写5个长度以上","text":"功能：工作说明内容必须填写5个长度以上 配置model校验器 注意：必须配置在model上，【元数据编辑】→【切换元数据】→【JobInformationMaster.json 】 validators 配置 “checker”: “DynamicChecker” 12345678&quot;validators&quot;: [ &#123; &quot;checker&quot;: &quot;DynamicChecker&quot;, &quot;name&quot;: &quot;PositionDescChecker&quot;, &quot;tips&quot;: &quot;工作说明过短，最少5个长度！&quot;, &quot;key&quot;: &quot;PositionDesc_Checker&quot; &#125; ] 自定义云函数 类型：校验器 云函数名：DataChecker_xxxx ，例如：DataChecker_PositionDescChecker 云函数中info，包含了当前验证的记录全部内容 123456789101112131415161718192021class EndBeginTimeChecker(DynamicCheckBase): &quot;&quot;&quot; 云函数校验器示例，在对象新增，修改时会校验 &quot;&quot;&quot; def check(self, info): result = &#123;&#125; self.log(info) pdinfo = info.get(&#x27;position_desc&#x27;, &#x27;&#x27;) if pdinfo and len(pdinfo) &gt; 5: result[&#x27;success&#x27;] = True else: result[&#x27;success&#x27;] = False return result def log(self, log_content): log_info = &#123; &quot;log_type&quot;: str(&#x27;DataChecker_PositionDescChecker&#x27;), &quot;create_time&quot;: datetime.datetime.now().strftime(&#x27;%Y-%m-%d %H:%M:%S&#x27;), &quot;content&quot;: str(log_content) &#125; CustomerUtil.call_open_api(&quot;hcm.model.create&quot;, &#123;&quot;model&quot;: &quot;dynamic_log&quot;, &quot;info&quot;: log_info&#125;)","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"057-元数据体系","slug":"项目/HCM教程/057-元数据体系","date":"2025-06-27T12:00:00.000Z","updated":"2025-09-09T06:19:59.309Z","comments":true,"path":"2025/06/27/项目/HCM教程/057-元数据体系/","link":"","permalink":"https://dbbruce.github.io/2025/06/27/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/057-%E5%85%83%E6%95%B0%E6%8D%AE%E4%BD%93%E7%B3%BB/","excerpt":"元数据类型 1.Model 元数据 &#x3D;&#x3D; 基础的模型 &#x3D;&#x3D; xxxx.json 比如： Employee.json","text":"元数据类型 1.Model 元数据 &#x3D;&#x3D; 基础的模型 &#x3D;&#x3D; xxxx.json 比如： Employee.json 2.Base 元数据 &#x3D;&#x3D;&#x3D; Employee.meta.base.json 3.View 元数据 &#x3D;&#x3D;&#x3D; 没有修改功能的 &#x3D;&#x3D;&#x3D; Employee.meta.view.json 4.Info 元数据 &#x3D;&#x3D;&#x3D; 新增，修改窗口 &#x3D;&#x3D;&#x3D; JobInformationMaster.meta.info.json 5.List 元数据 &#x3D;&#x3D;&#x3D; 列表窗口，hcm叫台账 &#x3D;&#x3D;&#x3D; JobInformationMaster.meta.list.json Model 元数据 模型插件:plugin pre&#x2F;post creat_data,remove_data… 校验器 :validator Base 元数据 base.hooks 配置 导航步骤条 瀑布流主子集页面配置 Info 元数据 conditions: 过滤条件，限定取数范围1234567&#123; &quot;conditions&quot;: &#123; &quot;id&quot;: &#123; &quot;notin&quot;: [ 1, 2] &#125; &#125;&#125; data_plugins: list台账，对数据进行二次渲染，处理原始数据1.新建云函数 类型选择插件 会自动生成一个模版，然后打开云函数改写里面的post方法 12345678910class ListPlugInXXX(BaseListPlugIn): &quot;&quot;&quot; 模型data list插件 应用范围：对list接口返回的数据进行二次处理 &quot;&quot;&quot; def post(self, context, _list, _count, plugin_config, **kwargs): for _l in _list: _id = _l.get(&#x27;id&#x27;) logging.info(_id) return _list, _count 2.在list元数据中定义data_plugins1234&quot;data_plugins&quot;: [&#123; &quot;key&quot;: &quot;Employee_post_org_full_path&quot;, //唯一标识 &quot;name&quot;: &quot;emp_data_plugins&quot; //云函数名称&#125;] filter 台账上的查询功能，过滤部门，月份都是在这配置12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667&quot;filters&quot;: [ &#123; &quot;label&quot;: &quot;范围&quot;, &quot;key&quot;: &quot;show_all&quot;, &quot;component&quot;: &quot;hc-super-selector&quot;, &quot;sequence&quot;: 1, &quot;options&quot;: &#123; &quot;default&quot;: &quot;child_include&quot;, &quot;change&quot;: &quot;=function(_scope, value, old_value)&#123;SCOPE.tree_model.$setFilterMode(value);&#125;&quot;, &quot;list&quot;: [ &#123; &quot;id&quot;: &quot;self&quot;, &quot;name&quot;: &quot;仅查看本级&quot; &#125;, &#123; &quot;id&quot;: &quot;child_include&quot;, &quot;name&quot;: &quot;查看所有下级&quot; &#125; ], &quot;multi&quot;: false, &quot;hasNull&quot;: false &#125; &#125;, &#123; &quot;key&quot;: &quot;program_id&quot;, &quot;label&quot;: &quot;薪酬方案&quot;, &quot;component&quot;: &quot;hc-super-selector&quot;, &quot;options&quot;: &#123; &quot;width&quot;: &quot;col-4&quot;, &quot;singleLine&quot;: true, &quot;selectorModel&quot;: &quot;SalaryProgram&quot;, &quot;includeAll&quot;: false, &quot;multi&quot;: false, &quot;hasNull&quot;: false, &quot;no_delete&quot;: false, &quot;placeholder&quot;: &quot;薪酬方案&quot;, &quot;extra_property&quot;: &#123; &quot;state&quot;: &quot;profile&quot;, &quot;sorts&quot;: [ &#123; &quot;key&quot;: &quot;number&quot;, &quot;type&quot;: &quot;asc&quot; &#125; ] &#125;, &quot;force_assign&quot;: true, &quot;default&quot;: &quot;=function()&#123;let defer=$q.defer();dataService.callHcmOpenApi(&#x27;hcm.model.list&#x27;,&#123;model:&#x27;SalaryProgram&#x27;,filter_str:null,filter_dict:null,page_index:1,page_size:1,extra_property:&#123;state: &#x27;profile&#x27;,sorts:[&#123;key: &#x27;number&#x27;, type: &#x27;asc&#x27;&#125;]&#125;&#125;).then(function(data)&#123;var _id = null;if(data.list.length &gt; 0)&#123;_id = data.list[0].id;&#125;;defer.resolve(_id);&#125;); return defer.promise;&#125;&quot; &#125;, &quot;sequence&quot;: 10, &quot;plan_exclude&quot;: true &#125;, &#123; &quot;key&quot;: &quot;month&quot;, &quot;label&quot;: &quot;月份&quot;, &quot;component&quot;: &quot;hc-input-datetime&quot;, &quot;options&quot;: &#123; &quot;default&quot;: true, &quot;width&quot;: &quot;col-4&quot;, &quot;singleLine&quot;: true, &quot;inputLock&quot;: true, &quot;format&quot;: &quot;yyyy-MM&quot;, &quot;placeholder&quot;: &quot;月份&quot;, &quot;required&quot;: false, &quot;no_trans_query&quot;: true &#125; &#125;] hooks配置：","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"056-运营者模式","slug":"项目/HCM教程/056-运营者模式","date":"2025-06-26T12:00:00.000Z","updated":"2025-09-09T06:19:59.498Z","comments":true,"path":"2025/06/26/项目/HCM教程/056-运营者模式/","link":"","permalink":"https://dbbruce.github.io/2025/06/26/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/056-%E8%BF%90%E8%90%A5%E8%80%85%E6%A8%A1%E5%BC%8F/","excerpt":"运营者模式按钮设置原始模板是：header_menu_button.json，无法直接编辑，新增一个与原模板同名，名称为：header_menu_button_operation.json，就可以修改了","text":"运营者模式按钮设置原始模板是：header_menu_button.json，无法直接编辑，新增一个与原模板同名，名称为：header_menu_button_operation.json，就可以修改了 运营者模式 12345678910111213&#123; &quot;label&quot;: &quot;运营者模式&quot;, &quot;hide&quot;: &quot;=function()&#123;return !((SCOPE.is_onlyoneowner || SCOPE.auth[&#x27;privileged&#x27;])&amp;&amp;!SCOPE.auth[&#x27;operation_mode&#x27;])&#125;&quot;, &quot;func&quot;: &quot;=function()&#123;return SCOPE.change_operation_mode()&#125;&quot;, &quot;translation_key&quot;: &quot;common_header_menu_operation_mode&quot; &#125;, &#123; &quot;label&quot;: &quot;退出运营者模式&quot;, &quot;hide&quot;: &quot;=function()&#123;return !SCOPE.auth[&#x27;operation_mode&#x27;]&#125;&quot;, &quot;func&quot;: &quot;=SCOPE.cancel_operation_mode&quot;, &quot;translation_key&quot;: &quot;common_header_menu_exit_operation_mode&quot; &#125; 完整配置 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384&#123; &quot;service&quot;: [&#123; &quot;label&quot;: &quot;我的资料&quot;, &quot;func&quot;: &quot;=SCOPE.go_my_profile&quot;, &quot;translation_key&quot;: &quot;common_header_menu_my_profile&quot; &#125;, &#123; &quot;label&quot;: &quot;远程协助&quot;, &quot;func&quot;: &quot;=SCOPE.remote_help&quot;, &quot;hide&quot;: &quot;=!SCOPE.is_remote_url&quot;, &quot;translation_key&quot;: &quot;common_header_menu_remote_assistance&quot; &#125;, &#123; &quot;label&quot;: &quot;后台任务&quot;, &quot;func&quot;: &quot;=SCOPE.backgroundTask&quot;, &quot;translation_key&quot;: &quot;common_header_menu_background_task&quot; &#125;, &#123; &quot;label&quot;: &quot;即时代理&quot;, &quot;hide&quot;: &quot;=function()&#123;return SCOPE.hide_immediate_agency||!(SCOPE.is_onlyoneowner&amp;&amp;!SCOPE.auth[&#x27;privileged&#x27;])&#125;&quot;, &quot;func&quot;: &quot;=SCOPE.change_behalf&quot;, &quot;translation_key&quot;: &quot;common_header_menu_proxy&quot; &#125;, &#123; &quot;label&quot;: &quot;恢复本人登录&quot;, &quot;hide&quot;: &quot;=function()&#123;return !SCOPE.auth[&#x27;privileged&#x27;]&#125;&quot;, &quot;func&quot;: &quot;=SCOPE.cancel_behalf&quot;, &quot;translation_key&quot;: &quot;common_header_menu_cancel_proxy&quot; &#125;, &#123; &quot;label&quot;: &quot;开发者模式&quot;, &quot;hide&quot;: &quot;=function()&#123;return !((SCOPE.is_onlyoneowner||SCOPE.is_hcm_sys_manager)&amp;&amp;!SCOPE.auth[&#x27;developer_mode&#x27;]&amp;&amp;!SCOPE.auth[&#x27;company_setting&#x27;][&#x27;IS_DISABLE_DEVELOPER_MODE&#x27;])&#125;&quot;, &quot;func&quot;: &quot;=SCOPE.change_developer_mode&quot;, &quot;translation_key&quot;: &quot;common_header_menu_developer_mode&quot; &#125;, &#123; &quot;label&quot;: &quot;开发者模式-暂存模式&quot;, &quot;hide&quot;: &quot;=function()&#123;return !((SCOPE.is_onlyoneowner||SCOPE.is_hcm_sys_manager)&amp;&amp;!SCOPE.auth[&#x27;developer_mode&#x27;])&#125;&quot;, &quot;translation_key&quot;: &quot;common_header_menu_developer_mode_temp&quot;, &quot;type&quot;: &quot;show_sub&quot;, &quot;key&quot;: &quot;common_header_menu_developer_mode_temp&quot;, &quot;sub_list_api&quot;: &quot;meta.temp.working.space&quot;, &quot;sub_resolve_func&quot;: &quot;=function(sub)&#123;SCOPE.change_developer_mode(sub)&#125;&quot; &#125;, &#123; &quot;label&quot;: &quot;退出开发者模式&quot;, &quot;hide&quot;: &quot;=function()&#123;return !SCOPE.auth[&#x27;developer_mode&#x27;]&#125;&quot;, &quot;translation_key&quot;: &quot;common_header_menu_exit_developer_mode&quot;, &quot;key&quot;: &quot;common_header_menu_exit_developer_mode&quot;, &quot;type&quot;: &quot;show_sub&quot;, &quot;sub_list_api&quot;: &quot;meta.temp.working.space.select&quot;, &quot;sub_resolve_func&quot;: &quot;=SCOPE.cancel_developer_mode&quot; &#125;, &#123; &quot;label&quot;: &quot;运营者模式&quot;, &quot;hide&quot;: &quot;=function()&#123;return !((SCOPE.is_onlyoneowner || SCOPE.auth[&#x27;privileged&#x27;])&amp;&amp;!SCOPE.auth[&#x27;operation_mode&#x27;])&#125;&quot;, &quot;func&quot;: &quot;=function()&#123;return SCOPE.change_operation_mode()&#125;&quot;, &quot;translation_key&quot;: &quot;common_header_menu_operation_mode&quot; &#125;, &#123; &quot;label&quot;: &quot;退出运营者模式&quot;, &quot;hide&quot;: &quot;=function()&#123;return !SCOPE.auth[&#x27;operation_mode&#x27;]&#125;&quot;, &quot;func&quot;: &quot;=SCOPE.cancel_operation_mode&quot;, &quot;translation_key&quot;: &quot;common_header_menu_exit_operation_mode&quot; &#125;, &#123; &quot;func&quot;: &quot;=SCOPE.go_pre_emp_enter&quot;, &quot;hide&quot;: &quot;=!SCOPE.open_pre_emp_enter&quot;, &quot;label&quot;: &quot;采集系统&quot;, &quot;translation_key&quot;: &quot;common_header_menu_acquisition_system&quot; &#125;, &#123; &quot;label&quot;: &quot;个人设置&quot;, &quot;func&quot;: &quot;=SCOPE.set_message&quot;, &quot;translation_key&quot;: &quot;common_personal_setting&quot; &#125;, &#123; &quot;label&quot;: &quot;系统设置&quot;, &quot;func&quot;: &quot;=SCOPE.go_setting&quot;, &quot;hide&quot;: &quot;=!SCOPE.is_manager&quot;, &quot;translation_key&quot;: &quot;common_header_menu_system_setting&quot; &#125;, &#123; &quot;label&quot;: &quot;切换公司&quot;, &quot;key&quot;: &quot;change_company&quot;, &quot;hide&quot;: &quot;=!SCOPE.show_change_company&quot;, &quot;translation_key&quot;: &quot;common_header_menu_switch_company&quot; &#125;, &#123; &quot;label&quot;: &quot;全屏模式&quot;, &quot;func&quot;: &quot;=SCOPE.enter_full_screen&quot;, &quot;translation_key&quot;: &quot;common_header_menu_full_screen&quot; &#125;, &#123; &quot;label&quot;: &quot;退出&quot;, &quot;func&quot;: &quot;=SCOPE.logout&quot;, &quot;translation_key&quot;: &quot;common_header_menu_sign_out&quot; &#125;]&#125; profile_index121、 profile日志，下载链接为：http://127.0.0.1:3000/document/temp/download?index=日志index,将链接中的http://127.0.0.1:3000替换成本环境的域名，日志index为接口返回参数中profile_index的值2、 sql日志，复制返回参数中sql_trace的全部信息即可，单位毫秒 profile日志格式类似下面","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"055-弹窗选择条件调用云函数","slug":"项目/HCM教程/055-弹窗选择条件调用云函数","date":"2025-06-24T12:00:00.000Z","updated":"2025-09-09T06:19:59.417Z","comments":true,"path":"2025/06/24/项目/HCM教程/055-弹窗选择条件调用云函数/","link":"","permalink":"https://dbbruce.github.io/2025/06/24/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/055-%E5%BC%B9%E7%AA%97%E9%80%89%E6%8B%A9%E6%9D%A1%E4%BB%B6%E8%B0%83%E7%94%A8%E4%BA%91%E5%87%BD%E6%95%B0/","excerpt":"弹窗","text":"弹窗 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394&quot;action&quot;: [ &#123; &quot;label&quot;: &quot;获取分摊数据&quot;, &quot;key&quot;: &quot;getsalarydata&quot;, &quot;action&quot;: [&#123; &quot;action&quot;: &quot;SIMPLE_FORM&quot;, &quot;key&quot;: &quot;simple_form&quot;, &quot;options&quot;: &#123; &quot;title&quot;: &quot;请选择薪酬方案和月份&quot;, &quot;meta&quot;: [&#123; &quot;key&quot;: &quot;program_id&quot;, &quot;label&quot;: &quot;薪酬方案&quot;, &quot;component&quot;: &quot;hc-super-selector&quot;, &quot;options&quot;: &#123; &quot;data_type&quot;: &quot;integer&quot;, &quot;required&quot;: true, &quot;width&quot;: &quot;col-12&quot;, &quot;singleLine&quot;: true, &quot;data_precision&quot;: null, &quot;hide&quot;: false, &quot;readOnly&quot;: false, &quot;placeholder&quot;: &quot;请输入薪酬方案&quot;, &quot;selectorModel&quot;: &quot;SalaryProgram&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;salary_month&quot;, &quot;label&quot;: &quot;薪酬月份&quot;, &quot;component&quot;: &quot;hc-input-datetime&quot;, &quot;options&quot;: &#123; &quot;data_type&quot;: &quot;date&quot;, &quot;required&quot;: true, &quot;width&quot;: &quot;col-12&quot;, &quot;singleLine&quot;: true, &quot;data_precision&quot;: null, &quot;hide&quot;: false, &quot;readOnly&quot;: false, &quot;placeholder&quot;: &quot;请输入薪酬月份&quot;, &quot;format&quot;: &quot;yyyy-MM&quot; &#125;, &quot;state&quot;: null &#125;, &#123; &quot;key&quot;: &quot;department_id&quot;, &quot;label&quot;: &quot;部门&quot;, &quot;component&quot;: &quot;hc-tree-list-selector&quot;, &quot;sequence&quot;: null, &quot;options&quot;: &#123; &quot;data_type&quot;: &quot;integer&quot;, &quot;required&quot;: false, &quot;width&quot;: &quot;col-12&quot;, &quot;singleLine&quot;: true, &quot;data_precision&quot;: null, &quot;hide&quot;: false, &quot;readOnly&quot;: false, &quot;placeholder&quot;: &quot;请输入部门&quot;, &quot;default&quot;: null, &quot;default_expression&quot;: null, &quot;tip&quot;: null, &quot;selectorModel&quot;: &quot;OrgDepartment&quot;, &quot;role&quot;: null &#125;, &quot;state&quot;: null &#125; ] &#125; &#125;, &#123; &quot;action&quot;: &quot;CALL_API&quot;, &quot;key&quot;: &quot;call_api&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;private.ShareTableSalarySocial&quot;, &quot;params&quot;: &#123; &quot;depart_id&quot;: &quot;expression[GET(RES(&#x27;simple_form&#x27;), [&#x27;department_id&#x27;])]&quot;, &quot;program_id&quot;: &quot;expression[GET(RES(&#x27;simple_form&#x27;), [&#x27;program_id&#x27;])]&quot;, &quot;month&quot;: &quot;expression[GET(RES(&#x27;simple_form&#x27;), [&#x27;salary_month&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;show_warning&quot;, &quot;action&quot;: &quot;SHOW_WARNING&quot;, &quot;options&quot;: &#123; &quot;content&quot;: &quot;expression[RES(&#x27;call_api&#x27;)]&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;refresh&quot;, &quot;action&quot;: &quot;REFRESH&quot; &#125; ] &#125;]","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"054-组织人事笔记","slug":"项目/HCM教程/054-组织人事笔记","date":"2025-06-23T12:00:00.000Z","updated":"2025-09-09T06:19:59.538Z","comments":true,"path":"2025/06/23/项目/HCM教程/054-组织人事笔记/","link":"","permalink":"https://dbbruce.github.io/2025/06/23/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/054-%E7%BB%84%E7%BB%87%E4%BA%BA%E4%BA%8B%E7%AC%94%E8%AE%B0/","excerpt":"组织管理 单位：独立法人、独立的人事职能、公司要求 可以定为单位，单位下不能挂岗位； 部门：部门下才能设置岗位 虚拟部门 - 属性：是否虚拟 - 是作用：便于行政授权，便于管理","text":"组织管理 单位：独立法人、独立的人事职能、公司要求 可以定为单位，单位下不能挂岗位； 部门：部门下才能设置岗位 虚拟部门 - 属性：是否虚拟 - 是作用：便于行政授权，便于管理 启用多级排序码 组织人事 - 人事设置 - 人事基础设置 设置组织的编码规则 系统设置 - 扩展管理 - 编码规则 部门编码规则-固定的：DepartmentNumberSerial岗位编码规则-固定的：PositionNumberSerial人员编码规则-固定的：EmployeeNumberSerial 配在info层，不要配在场景里，配在场景里无法生效 create会有问题，每次显示时生产一个新的编码，不使用也会自增；post的问题是创建时不显示，保存后自动生成一个编码； 1234567891011&quot;fields&quot;: [&#123; &quot;key&quot;: &quot;number&quot;, &quot;options&quot;: &#123; &quot;required&quot;: false, &quot;readOnly&quot;: true, &quot;number_increment_rule&quot;: &#123; &quot;key&quot;: &quot;DepartmentNumberSerial&quot;, //编码规则名 &quot;type&quot;: &quot;create&quot; //编码生成时机，create-新增页面上获取编码， save-保存数据时获取编码 &#125; &#125; &#125;] 多维度组织管理“组织管理”的功能定位是行政维度的组织管理类型 &#x3D; 多维度组织弹性模型key &#x3D; org_master_dynamic.tradeunion，必须【org_master_dynamic.】开头，注意有个点自动生成的模型：org_his_dynamic.tradeunion，自动生成一个历史模型 应用配置参数: 1234&#123; &quot;model&quot;: &quot;org_master_dynamic.tradeunion&quot;, //对象管理器中新增的模型名 &quot;meta_state&quot;: &quot;all&quot; //场景可自行定义&#125; 场景 1common_model_tree_list 开通应用 组织树，默认是行政组织，可以切换为组织树行政组织 1234567891011121314151617&quot;tree&quot;: &#123; &quot;description&quot;: &quot;行政组织&quot;, &quot;model&quot;: &quot;Department&quot;, &quot;tree_key&quot;: &#123; &quot;org&quot;: &quot;depart_id&quot; &#125;, &quot;params&quot;: &#123; &quot;filter_dict&quot;: &#123; &quot;org_type&quot;: [ 10 ] &#125;, &quot;extra_property&quot;: &#123; &quot;role&quot;: &quot;cm-org-emp.emp&quot; &#125; &#125;&#125; 工会树 123456789101112131415161718192021&quot;tree&quot;: &#123; &quot;description&quot;: &quot;工会组织&quot;, &quot;future_business&quot;: false, &quot;model&quot;: &quot;org_master_dynamic.tradeunion&quot;, &quot;tree_key&quot;: &#123; &quot;tree_node_key&quot;: &quot;id&quot; &#125;, &quot;filter_mode&quot;: &quot;fm:dynamic_child_include&quot;, &quot;params&quot;: &#123; &quot;filter_dict&quot;: &#123; &quot;org_type&quot;: [ 10 ] &#125;, &quot;extra_property&quot;: &#123; &quot;role&quot;: &quot;cm-org-emp.org&quot; &#125; &#125;&#125; 配置完成后，会发现左侧树为空，因为此时系统内并没有设立工会组织，可通过新增按钮来设立工会组织 因为新增时，是根据新建模型来取上级组织，行政管理组织是按照行政组织来获取，所以新增按钮中参数需要调整下 12345678910&#123; &quot;key&quot;: &quot;new&quot;, &quot;label&quot;: &quot;新增&quot;, &quot;action&quot;: &quot;NEW&quot;, &quot;icon&quot;: &quot;icon-hcm-add-circle&quot;, &quot;is_important&quot;: true, &quot;options&quot;: &#123; &quot;init_data&quot;: &quot;=function() &#123;return &#123;&#x27;enabled&#x27;: true,&#x27;begin_date&#x27;:SCOPE.tree_model.selectedNode.begin_date,&#x27;parent_id&#x27;:SCOPE.tree_model.selectedNode.id&#125;&#125;&quot; &#125;&#125;, 应用介绍应用类别，应用二级，应用 切换tab的配置方法 - 定义在布局里对象管理器 - 模型【OrgDepartment 】 - Base布局 - 配置【childs】 1234567891011121314151617181920212223242526272829303132333435363738394041424344&quot;childs&quot;: [ &#123; &quot;key&quot;: &quot;plan&quot;, &quot;model&quot;: &quot;OrgDepartmentPlan&quot;, &quot;label&quot;: &quot;编制数&quot;, &quot;icon&quot;: &quot;icon-hcm-mark&quot;, &quot;parent_id&quot;: &quot;department_id&quot;, &quot;view&quot;: &quot;multi&quot; &#125;, &#123; &quot;key&quot;: &quot;business_charger&quot;, &quot;model&quot;: &quot;DepartmentBusinessTeam&quot;, &quot;label&quot;: &quot;管理团队&quot;, &quot;icon&quot;: &quot;icon-hcm-relationship&quot;, &quot;parent_id&quot;: &quot;department_id&quot;, &quot;view&quot;: &quot;multi&quot; &#125;, &#123; &quot;icon&quot;: &quot;icon-hcm-organization&quot;, &quot;key&quot;: &quot;chart&quot;, &quot;label&quot;: &quot;组织架构图&quot;, &quot;model&quot;: &quot;Chart&quot;, &quot;hide&quot;: true, &quot;func&quot;: &quot;=function(item)&#123;SCOPE.super_go(&#x27;org_details.chart&#x27;,&#123;model:&#x27;OrgDepartment&#x27;,id:STATE.params.id&#125;)&#125;&quot; &#125;, &#123; &quot;key&quot;: &quot;org&quot;, &quot;model&quot;: &quot;OrgDepartment&quot;, &quot;label&quot;: &quot;行政组织&quot;, &quot;icon&quot;: &quot;icon-hcm-mark&quot;, &quot;parent_id&quot;: &quot;department_id&quot;, &quot;view&quot;: &quot;multi&quot;, &quot;meta_state&quot;: &quot;multi&quot; &#125;, &#123; &quot;key&quot;: &quot;tradeunion&quot;, &quot;model&quot;: &quot;org_master_dynamic.tradeunion&quot;, &quot;label&quot;: &quot;党群组织&quot;, &quot;icon&quot;: &quot;icon-hcm-mark&quot;, &quot;parent_id&quot;: &quot;department_id&quot;, &quot;view&quot;: &quot;multi&quot;, &quot;meta_state&quot;: &quot;multi&quot; &#125;] 列表配置颜色12345&quot;list_config&quot;: &#123; &quot;operate_default&quot;: &quot;=function(_item)&#123;return SCOPE.super_go(&#x27;common_model_view_base&#x27;,&#123;&#x27;model&#x27;:&#x27;org_master_dynamic.tradeunion&#x27;,&#x27;id&#x27;:_item.id,&#x27;custom_params&#x27;:&#123;&#x27;date_&#x27;:SCOPE.tree_model.effect_date,&#x27;id&#x27;:_item.id&#125;,&#x27;meta_state&#x27;:&#x27;all&#x27;, &#x27;nav_state&#x27;:&#x27;all&#x27;&#125;)&#125;&quot;, &quot;customCellClass&quot;: &quot;=function(_row,_col)&#123;if(_col.key==&#x27;name&#x27;)&#123;return &#x27;bg-blue&#x27;&#125;;&#125;&quot;, &quot;customRowClass&quot;: &quot;=function(_row, index)&#123;return index%2 === 1 ? &#x27;bg-blue&#x27; : &#x27;bg-red&#x27;;&#125;&quot;&#125;,","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"053-perf.assess.card.new.finalized的post插件","slug":"项目/HCM教程/053-perf.assess.card.new.finalized的post插件","date":"2025-06-21T12:00:00.000Z","updated":"2025-09-09T06:19:59.373Z","comments":true,"path":"2025/06/21/项目/HCM教程/053-perf.assess.card.new.finalized的post插件/","link":"","permalink":"https://dbbruce.github.io/2025/06/21/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/053-perf.assess.card.new.finalized%E7%9A%84post%E6%8F%92%E4%BB%B6/","excerpt":"perf.assess.card.new.finalized的post插件 post插件：post_finalized 12345&quot;plugins&quot;: [&#123; &quot;key&quot;: &quot;post_create_perfresult_score&quot;, &quot;type&quot;: &quot;post_finalized&quot;, &quot;name&quot;: &quot;PostPluginPerfResultScore&quot;&#125;]","text":"perf.assess.card.new.finalized的post插件 post插件：post_finalized 12345&quot;plugins&quot;: [&#123; &quot;key&quot;: &quot;post_create_perfresult_score&quot;, &quot;type&quot;: &quot;post_finalized&quot;, &quot;name&quot;: &quot;PostPluginPerfResultScore&quot;&#125;] 云函数 ：名称：PostPluginPerfResultScore - 类型：模型插件 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889class ModelPlugInXXX(BaseModelPlugIn): &quot;&quot;&quot; 模型插件 应用范围：create_data,edit_data,remove_data,remove_datas 如果类型为pre，调用pre方法，类型为post，调用post方法 &quot;&quot;&quot; # 月度 MONTH_SCORE_MAP = &#123; &quot;S&quot;:&quot;0.5&quot;, &quot;A&quot;:&quot;0.2&quot;, &quot;B&quot;:&quot;0&quot;, &quot;C&quot;:&quot;-0.2&quot;, &quot;D&quot;:&quot;-0.5&quot;, &quot;F&quot;:&quot;-1&quot; &#125; # 年度 YEAE_SCORE_MAP = &#123; &quot;S&quot;:&quot;2&quot;, &quot;A&quot;:&quot;1&quot;, &quot;B&quot;:&quot;0&quot;, &quot;C&quot;:&quot;-1&quot;, &quot;D&quot;:&quot;-2&quot;, &quot;F&quot;:&quot;降级/调岗/培训&quot; &#125; # def _call_api(self, api_name, args_dict): # &quot;&quot;&quot;封装API调用逻辑&quot;&quot;&quot; # return CustomerUtil.call_open_api(api_name, args_dict).get(&quot;list&quot;, []) def _get_perfresult_datas(self, cardids_list): &quot;&quot;&quot; 获取员工绩效结果数据 &quot;&quot;&quot; result_list = ModelUtil.list(model=&quot;PerfResult&quot;,filter_dict=&#123;&quot;assess_card_id&quot;: cardids_list&#125;, extra_property=&#123;&quot;state&quot;: &quot;emp&quot;,&quot;fields&quot;:[&#123;&quot;field&quot;:[&quot;id&quot;]&#125;,&#123;&quot;field&quot;:[&quot;assess_cycle&quot;]&#125;,&#123;&quot;field&quot;:[&quot;level&quot;]&#125;]&#125;) return result_list def pre(self, company_id, **kwargs): &quot;&quot;&quot; Pre插件 kwargs:经过转换的原函数调用参数，经过干预后，返回kwargs继续调用原函数 &quot;&quot;&quot; # self.log(f&#x27;kwargs-&#123;kwargs&#125;&#x27;) return kwargs def post(self, company_id, result,**kwargs): &quot;&quot;&quot; Post插件 result：原函数调用返回的结果，经过干预后，返回 kwargs：原函数调用参数 &quot;&quot;&quot; try: # 考核量表ID列表 cardids_list = kwargs.get(&#x27;card_ids&#x27;, []) # 获取员工绩效结果数据 parfresult_list = self._get_perfresult_datas(cardids_list) elist = list() for perfsesult_dict in parfresult_list: pid = perfsesult_dict.get(&#x27;id&#x27;, &#x27;&#x27;) assess_cycle = perfsesult_dict.get(&#x27;assess_cycle&#x27;, &#x27;&#x27;) level = perfsesult_dict.get(&#x27;level&#x27;, &#x27;&#x27;) # 计算得分 # 季度得分 if &quot;季度&quot; in assess_cycle: score = self.MONTH_SCORE_MAP.get(level, &#x27;&#x27;) # 年度得分 else: score = self.YEAE_SCORE_MAP.get(level, &#x27;&#x27;) edict = &#123;&quot;id&quot;: pid, &quot;u_score&quot;: score&#125; elist.append(edict) # 修改得分 ModelUtil.edit_batch(model=&quot;PerfResult&quot;, edit_list=elist) except Exception: self.log(traceback.format_exc()) return result def log(self, log_content): log_entry = &#123; &quot;log_type&quot;: &quot;PostPluginPerfResultScore&quot;, &quot;create_time&quot;: datetime.datetime.now().strftime(&#x27;%Y-%m-%d %H:%M:%S&#x27;), &quot;content&quot;: str(log_content) &#125; CustomerUtil.call_open_api(&quot;hcm.model.create&quot;, &#123;&quot;model&quot;: &quot;dynamic_log&quot;, &quot;info&quot;: log_entry&#125;) 注意点： 1.必须用双引号，单引号会报错1result_list = ModelUtil.list(model=&quot;PerfResult&quot;,filter_dict=&#123;&quot;assess_card_id&quot;: cardids_list&#125;, extra_property=&#123;&quot;state&quot;: &quot;emp&quot;,&quot;fields&quot;:[&#123;&quot;field&quot;:[&quot;id&quot;]&#125;,&#123;&quot;field&quot;:[&quot;assess_cycle&quot;]&#125;,&#123;&quot;field&quot;:[&quot;level&quot;]&#125;]&#125;) 2.模型插件，给edit返回赋值，执行时会报错 12报错： res = ModelUtil.edit_batch(model=&quot;PerfResult&quot;, edit_list=elist)不报错：ModelUtil.edit_batch(model=&quot;PerfResult&quot;, edit_list=elist)","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"052-云函数互相调用","slug":"项目/HCM教程/052-云函数互相调用","date":"2025-06-20T12:00:00.000Z","updated":"2025-08-13T03:05:11.853Z","comments":true,"path":"2025/06/20/项目/HCM教程/052-云函数互相调用/","link":"","permalink":"https://dbbruce.github.io/2025/06/20/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/052-%E4%BA%91%E5%87%BD%E6%95%B0%E4%BA%92%E7%9B%B8%E8%B0%83%E7%94%A8/","excerpt":"云函数互相调用 接口1CustomerUtil.call_open_api(api, params)","text":"云函数互相调用 接口1CustomerUtil.call_open_api(api, params) 代码实例123456789101112131415161718192021222324252627282930class PrivateAPIService(BasePrivateApiService): &quot;&quot;&quot; 动态私有OpenAPI 使用方法 &quot;&quot;&quot; def execute(self, **kwargs): try: self.log(kwargs) month=kwargs.get(&quot;month&quot;,&quot;&quot;) org_code = kwargs.get(&quot;org_code&quot;, &quot;&quot;) #单位人工成本情况上报 result3=CustomerUtil.call_open_api(&quot;private.CollectReportReportsRGCB&quot;, &#123; &quot;filter_month&quot;: month, &quot;org_code&quot;: org_code &#125;) if not result3[&quot;success&quot;]: raise errors.DATA_RULE_ERROR.description(f&quot;单位人工成本情况上报:&#123;result3[&#x27;msg&#x27;]&#125;&quot;) # 同步人资数据库数据 result5=CustomerUtil.call_open_api(&quot;private.Get_Companies_Data_From_HRKingbase&quot;, &#123; &quot;month&quot;: month, &quot;org_code&quot;: org_code &#125;) if not result5[&quot;success&quot;]: raise errors.DATA_RULE_ERROR.description(f&quot;同步人资数据库数据:&#123;result3[&#x27;msg&#x27;]&#125;&quot;) return &quot;success&quot; except Exception as e: self.log(traceback.format_exc()) raise e","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"051-常用relation配置","slug":"项目/HCM教程/051-常用relation配置","date":"2025-06-08T12:44:25.000Z","updated":"2025-08-13T03:02:03.324Z","comments":true,"path":"2025/06/08/项目/HCM教程/051-常用relation配置/","link":"","permalink":"https://dbbruce.github.io/2025/06/08/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/051-%E5%B8%B8%E7%94%A8relation%E9%85%8D%E7%BD%AE/","excerpt":"常用relation配置","text":"常用relation配置 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106&quot;relations&quot;: [ &#123; &quot;filter&quot;: &#123; &quot;employee.id&quot;: &quot;:employee_id&quot; &#125;, &quot;blur&quot;: [ &quot;number&quot;, &quot;name&quot;, &quot;mobile&quot; ], &quot;model&quot;: &quot;Employee&quot;, &quot;key&quot;: &quot;employee&quot; &#125;, &#123; &quot;filter&quot;: &#123; &quot;position_id&quot;: &quot;:position.origin_id&quot;, &quot;position.begin_date&quot;: &#123; &quot;lte&quot;: &quot;=date_&quot; &#125;, &quot;position.end_date&quot;: &#123; &quot;gt&quot;: &quot;=date_&quot; &#125; &#125;, &quot;model&quot;: &quot;OrgPositionHistory&quot;, &quot;type&quot;: &quot;outer&quot;, &quot;key&quot;: &quot;position&quot;, &quot;blur&quot;: [ &quot;name&quot; ] &#125;, &#123; &quot;filter&quot;: &#123; &quot;position.parent_id&quot;: &quot;:department.origin_id&quot;, &quot;department.begin_date&quot;: &#123; &quot;lte&quot;: &quot;=date_&quot; &#125;, &quot;department.end_date&quot;: &#123; &quot;gt&quot;: &quot;=date_&quot; &#125; &#125;, &quot;model&quot;: &quot;OrgDepartmentHistory&quot;, &quot;type&quot;: &quot;outer&quot;, &quot;key&quot;: &quot;department&quot; &#125;, &#123; &quot;filter&quot;: &#123; &quot;department.subordinate_unit_id&quot;: &quot;:unit.origin_id&quot;, &quot;unit.begin_date&quot;: &#123; &quot;lte&quot;: &quot;=date_&quot; &#125;, &quot;unit.end_date&quot;: &#123; &quot;gt&quot;: &quot;=date_&quot; &#125; &#125;, &quot;model&quot;: &quot;OrgDepartmentHistory&quot;, &quot;type&quot;: &quot;outer&quot;, &quot;key&quot;: &quot;unit&quot; &#125;, &#123; &quot;filter&quot;: &#123; &quot;report_position.end_date&quot;: &#123; &quot;gt&quot;: &quot;=date_&quot; &#125;, &quot;report_position.begin_date&quot;: &#123; &quot;lte&quot;: &quot;=date_&quot; &#125;, &quot;report_position_id&quot;: &quot;:report_position.origin_id&quot; &#125;, &quot;model&quot;: &quot;OrgPositionHistory&quot;, &quot;type&quot;: &quot;outer&quot;, &quot;key&quot;: &quot;report_position&quot; &#125;, &#123; &quot;filter&quot;: &#123; &quot;job_step.id&quot;: &quot;:job_step_id&quot; &#125;, &quot;model&quot;: &quot;JobStep&quot;, &quot;type&quot;: &quot;outer&quot;, &quot;name&quot;: &quot;职级&quot;, &quot;key&quot;: &quot;job_step&quot; &#125;, &#123; &quot;filter&quot;: &#123; &quot;position_sequence.id&quot;: &quot;:job_step.step_type_id&quot; &#125;, &quot;model&quot;: &quot;JobStepType&quot;, &quot;type&quot;: &quot;outer&quot;, &quot;name&quot;: &quot;序列&quot;, &quot;key&quot;: &quot;position_sequence&quot; &#125;, &#123; &quot;filter&quot;: &#123; &quot;position.parent_id&quot;: &quot;:department_level.department_id&quot;, &quot;department_level.begin_date&quot;: &#123; &quot;lte&quot;: &quot;=date_&quot; &#125;, &quot;department_level.end_date&quot;: &#123; &quot;gt&quot;: &quot;=date_&quot; &#125; &#125;, &quot;model&quot;: &quot;DepartmentHierarchy&quot;, &quot;type&quot;: &quot;outer&quot;, &quot;name&quot;: &quot;部门层级&quot;, &quot;key&quot;: &quot;department_level&quot; &#125;] relations12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970&quot;relations&quot;: [ &#123; &quot;filter&quot;: &#123; &quot;employee.id&quot;: &quot;:employee_id&quot; &#125;, &quot;model&quot;: &quot;Employee&quot;, &quot;name&quot;: &quot;人员信息&quot;, &quot;key&quot;: &quot;employee&quot; &#125;, &#123; &quot;filter&quot;: &#123; &quot;depart_info.origin_id&quot;: &quot;:depart_id&quot;, &quot;depart_info.begin_date&quot;: &#123; &quot;lte&quot;: &quot;:begin_date&quot; &#125;, &quot;depart_info.end_date&quot;: &#123; &quot;gt&quot;: &quot;:begin_date&quot; &#125; &#125;, &quot;model&quot;: &quot;OrgDepartmentHistory&quot;, &quot;type&quot;: &quot;outer&quot;, &quot;name&quot;: &quot;考勤部门信息&quot;, &quot;key&quot;: &quot;depart_info&quot; &#125;, &#123; &quot;filter&quot;: &#123; &quot;position_info.origin_id&quot;: &quot;:position_id&quot;, &quot;position_info.begin_date&quot;: &#123; &quot;lte&quot;: &quot;:begin_date&quot; &#125;, &quot;position_info.end_date&quot;: &#123; &quot;gt&quot;: &quot;:begin_date&quot; &#125; &#125;, &quot;model&quot;: &quot;OrgPositionHistory&quot;, &quot;type&quot;: &quot;outer&quot;, &quot;name&quot;: &quot;考勤岗位信息&quot;, &quot;key&quot;: &quot;position_info&quot; &#125;, &#123; &quot;filter&quot;: &#123; &quot;standard.employee_id&quot;: &quot;:employee_id&quot;, &quot;standard.start_date&quot;: &#123; &quot;lte&quot;: &quot;=date_&quot; &#125;, &quot;standard.end_date&quot;: &#123; &quot;gte&quot;: &quot;=date_&quot; &#125; &#125;, &quot;model&quot;: &quot;TimeLeaveStandard&quot;, &quot;name&quot;: &quot;休假标准&quot;, &quot;key&quot;: &quot;standard&quot;, &quot;type&quot;: &quot;outer&quot; &#125;, &#123; &quot;filter&quot;: &#123; &quot;position_info.parent_id&quot;: &quot;:department_level.department_id&quot;, &quot;department_level.begin_date&quot;: &#123; &quot;lte&quot;: &quot;=date_&quot; &#125;, &quot;department_level.end_date&quot;: &#123; &quot;gt&quot;: &quot;=date_&quot; &#125; &#125;, &quot;model&quot;: &quot;DepartmentHierarchy&quot;, &quot;type&quot;: &quot;outer&quot;, &quot;name&quot;: &quot;部门层级&quot;, &quot;key&quot;: &quot;department_level&quot; &#125;]","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"050-流程中跳转别的流程","slug":"项目/HCM教程/050-流程中跳转别的流程","date":"2025-06-07T15:44:25.000Z","updated":"2025-09-09T06:19:59.325Z","comments":true,"path":"2025/06/07/项目/HCM教程/050-流程中跳转别的流程/","link":"","permalink":"https://dbbruce.github.io/2025/06/07/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/050-%E6%B5%81%E7%A8%8B%E4%B8%AD%E8%B7%B3%E8%BD%AC%E5%88%AB%E7%9A%84%E6%B5%81%E7%A8%8B/","excerpt":"配置跳转连接 相同的流程跳转，需要加继承false，{‘inherit’: false} SCOPE.super_go(‘workflow_bill_v3’,{‘wf_inst_id’:inst_id,’business_id’:business_id},{‘inherit’: false})","text":"配置跳转连接 相同的流程跳转，需要加继承false，{‘inherit’: false} SCOPE.super_go(‘workflow_bill_v3’,{‘wf_inst_id’:inst_id,’business_id’:business_id},{‘inherit’: false}) 123456789101112131415161718192021222324252627&quot;fields&quot;: [ &#123; &quot;key&quot;: &quot;abroad_link&quot;, &quot;label&quot;: &quot;出国（境）审批流程&quot;, &quot;component&quot;: &quot;hc-sys-link&quot;, &quot;options&quot;: &#123; &quot;hide&quot;: false, &quot;target&quot;: [ &quot;pc&quot;, &quot;mobile&quot; ], &quot;force_assign&quot;: false, &quot;singleLine&quot;: true, &quot;data_type&quot;: &quot;link&quot;, &quot;default&quot;: &#123; &quot;label&quot;: &quot;查看流程明细&quot; &#125;, &quot;onClick&quot;: &quot;=function()&#123;dataService.callHcmOpenApi(&#x27;private.HeadSecDepartment&#x27;, &#123;&#x27;employee_id&#x27;: SCOPE.employee.id&#125;).then(function(data)&#123;debugger;var inst_id=data.wf_inst_id;var business_id=data.business_id;SCOPE.super_go(&#x27;workflow_bill_v3&#x27;,&#123;&#x27;wf_inst_id&#x27;:inst_id,&#x27;business_id&#x27;:business_id&#125;,&#123;&#x27;inherit&#x27;: false&#125;)&#125;)&#125;&quot;, &quot;required&quot;: false, &quot;default_expression&quot;: null, &quot;width&quot;: &quot;col-6&quot;, &quot;readOnly&quot;: false, &quot;data_precision&quot;: 0 &#125;, &quot;sequence&quot;: 240 &#125;]","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"049-流程子表单填充数据","slug":"项目/HCM教程/049-流程子表单填充数据","date":"2025-06-06T15:44:25.000Z","updated":"2025-09-09T06:19:59.534Z","comments":true,"path":"2025/06/06/项目/HCM教程/049-流程子表单填充数据/","link":"","permalink":"https://dbbruce.github.io/2025/06/06/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/049-%E6%B5%81%E7%A8%8B%E5%AD%90%E8%A1%A8%E5%8D%95%E5%A1%AB%E5%85%85%E6%95%B0%E6%8D%AE/","excerpt":"流程子表单填充数据","text":"流程子表单填充数据 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172&#123; &quot;fields&quot;: [ &#123; &quot;key&quot;: &quot;department_id&quot;, &quot;label&quot;: &quot;部门&quot;, &quot;component&quot;: &quot;hc-tree-list-selector&quot;, &quot;sequence&quot;: 10, &quot;options&quot;: &#123; &quot;data_type&quot;: &quot;string&quot;, &quot;required&quot;: false, &quot;width&quot;: &quot;col-6&quot;, &quot;singleLine&quot;: true, &quot;data_precision&quot;: null, &quot;hide&quot;: false, &quot;readOnly&quot;: false, &quot;placeholder&quot;: &quot;请输入部门&quot;, &quot;default&quot;: null, &quot;default_expression&quot;: null, &quot;tip&quot;: null, &quot;selectorModel&quot;: &quot;OrgDepartment&quot;, &quot;role&quot;: &quot;manager&quot;, &quot;selectorType&quot;: 1 &#125; &#125;, &#123; &quot;key&quot;: &quot;quarter_id&quot;, &quot;label&quot;: &quot;季度&quot;, &quot;component&quot;: &quot;hc-super-selector&quot;, &quot;sequence&quot;: 20, &quot;options&quot;: &#123; &quot;data_type&quot;: &quot;string&quot;, &quot;required&quot;: false, &quot;width&quot;: &quot;col-6&quot;, &quot;singleLine&quot;: true, &quot;data_precision&quot;: null, &quot;hide&quot;: false, &quot;readOnly&quot;: false, &quot;placeholder&quot;: &quot;请输入季度&quot;, &quot;default&quot;: null, &quot;default_expression&quot;: null, &quot;tip&quot;: null, &quot;selectorModel&quot;: &quot;common_basic_item_data.季度&quot;, &quot;returnFormat&quot;: &quot;id&quot;, &quot;useSearch&quot;: true, &quot;includeAll&quot;: false &#125; &#125;, &#123; &quot;key&quot;: &quot;day_off&quot;, &quot;label&quot;: &quot;加班时长调休情况表&quot;, &quot;component&quot;: &quot;hc-field-list&quot;, &quot;options&quot;: &#123; &quot;singleLine&quot;: false, &quot;mode_type&quot;: &quot;wf&quot;, &quot;width&quot;: &quot;col-12&quot;, &quot;data_type&quot;: &quot;JSON&quot;, &quot;placeholder&quot;: &quot;请输入加班时长调休情况表&quot; &#125;, &quot;sequence&quot;: 40 &#125; ], &quot;childrens&quot;: [ &#123; &quot;key&quot;: &quot;day_off&quot;, &quot;model&quot;: &quot;wf_form_data_flex_data_child.2062231#day_off&quot;, &quot;is_form&quot;: true, &quot;parent_id&quot;: &quot;origin_id&quot;, &quot;name&quot;: &quot;加班时长调休情况表&quot; &#125; ], &quot;form_relations&quot;: [],&#125; 新增一条数据查看子表数据格式 数据格式-云函数返回列表，列表中的字段格式如下 1234567891011121314151617181920212223242526272829&#123; &quot;srv_begin&quot;: 1753779459241, &quot;result&quot;: [ &#123; &quot;employee_id&quot;: 4656151, &quot;number&quot;: &quot;00001&quot;, &quot;first_month&quot;: &quot;1&quot;, &quot;second_month&quot;: &quot;2&quot;, &quot;third_month&quot;: &quot;3&quot;, &quot;overtime_total&quot;: &quot;4&quot;, &quot;rest_first_month&quot;: &quot;5&quot;, &quot;rest_second_month&quot;: &quot;6&quot;, &quot;rest_third_month&quot;: &quot;7&quot;, &quot;rest_total&quot;: &quot;8&quot;, &quot;total&quot;: &quot;9&quot;, &quot;employee&quot;: &#123; &quot;name&quot;: &quot;测试1&quot; &#125;, &quot;source_entry_id&quot;: null, &quot;approve_state&quot;: null, &quot;approve_process_detail&quot;: null, &quot;disagree_count&quot;: null, &quot;agree_count&quot;: null, &quot;id&quot;: null &#125; ], &quot;srv_end&quot;: 1753779459249, &quot;srv_all&quot;: 1753779459250&#125; 云函数返回数据 12345678910111213141516171819202122232425262728293031323334[ &#123; &#x27;employee_id&#x27;: 4667096, &#x27;total&#x27;: 21.5, &#x27;first_month&#x27;: 8.5, &#x27;employee&#x27;: &#123; &#x27;name&#x27;: &#x27;张扬&#x27; &#125;, &#x27;number&#x27;: &#x27;2248&#x27;, &#x27;overtime_total&#x27;: 21.5, &#x27;rest_total&#x27;: 0, &#x27;rest_first_month&#x27;: 0, &#x27;second_month&#x27;: 8.5, &#x27;third_month&#x27;: 4.5, &#x27;rest_second_month&#x27;: 0, &#x27;rest_third_month&#x27;: 0 &#125;, &#123; &#x27;employee_id&#x27;: 4667216, &#x27;total&#x27;: 53.5, &#x27;first_month&#x27;: 19.0, &#x27;employee&#x27;: &#123; &#x27;name&#x27;: &#x27;赵钧里&#x27; &#125;, &#x27;number&#x27;: &#x27;2855&#x27;, &#x27;overtime_total&#x27;: 53.5, &#x27;rest_total&#x27;: 0, &#x27;rest_first_month&#x27;: 0, &#x27;second_month&#x27;: 21.0, &#x27;third_month&#x27;: 13.5, &#x27;rest_second_month&#x27;: 0, &#x27;rest_third_month&#x27;: 0 &#125;] 配置-form_relations “expression”: “[dict(**info) for info in API(‘private.ProcessDataPublicHolidays’, {‘department_id’: department_id,’quarter_id’:quarter_id})]” 12345678910111213141516171819202122&quot;form_relations&quot;: [ &#123; &quot;key&quot;: &quot;department_id&quot;, &quot;default&quot;: &#123; &quot;expression&quot;: &quot;&quot; &#125;, &quot;value_onchange&quot;: [&#123; &quot;key&quot;: &quot;day_off&quot;, &quot;expression&quot;: &quot;[dict(**info) for info in API(&#x27;private.ProcessDataPublicHolidays&#x27;, &#123;&#x27;department_id&#x27;: department_id,&#x27;quarter_id&#x27;:quarter_id&#125;)]&quot; &#125;] &#125;, &#123; &quot;key&quot;: &quot;quarter_id&quot;, &quot;default&quot;: &#123; &quot;expression&quot;: &quot;&quot; &#125;, &quot;value_onchange&quot;: [&#123; &quot;key&quot;: &quot;day_off&quot;, &quot;expression&quot;: &quot;[dict(**info) for info in API(&#x27;private.ProcessDataPublicHolidays&#x27;, &#123;&#x27;department_id&#x27;: department_id,&#x27;quarter_id&#x27;:quarter_id&#125;)]&quot; &#125;] &#125;]","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"048-application","slug":"项目/HCM教程/048-application","date":"2025-06-06T12:44:25.000Z","updated":"2025-07-22T06:26:27.069Z","comments":true,"path":"2025/06/06/项目/HCM教程/048-application/","link":"","permalink":"https://dbbruce.github.io/2025/06/06/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/048-application/","excerpt":"后台应用启动（start_app）1from environment import environment environment的实例化 1sys.path.append(os.path.dirname(__file__))","text":"后台应用启动（start_app）1from environment import environment environment的实例化 1sys.path.append(os.path.dirname(__file__)) 设置编译器编码方式为utf8，将当前文件所属的目录添加到系统模块目录下（项目根目录），便于在打包镜像后启动时可以正常加载其他模块 123456789101112environment.initialize(sys.argv[1:])def initialize(self, args=None): if self.__is_inited__: return self.__is_inited__ = True self._init_logging_() self._init_config_(args) self._init_db_() self._init_redis_() self.import_all_models() self._add_event() self.db.remove() environment实例初始化操作，设置日志级别、配置文件（config.d、configmap、hcm_default.conf等）、DB、Redis、导入模块（conf.d下的apps.conf下的指定的模块）、sql日志跟踪 app_celery.config_from_object(‘apps.task.celery_config’)实例化Celery（非初始化） 123456789def start_app(): app = Application() http_server = tornado.httpserver.HTTPServer(app, xheaders=True) port = environment.get_conf(&#x27;hcm_cloud&#x27;, &#x27;port&#x27;, default=8000) http_server.listen(port) logging.info(&quot;server started on port：&#123;&#125;&quot;.format(port)) logging.getLogger().setLevel(environment.get_conf(&#x27;hcm_cloud&#x27;, &#x27;logging&#x27;, &#x27;INFO&#x27;)) tornado.ioloop.IOLoop.instance().start() return 12345678910class Application(tornado.web.Application):def __init__(self): environment.register_services() environment.init_file_cache() self.system_launch = int(time.time()) settings = environment.get_tornado_settings() m_handlers, s_handlers = environment.get_handlers() tornado.web.Application.__init__(self, m_handlers, **settings) for sub_handler in s_handlers: self.add_handlers(sub_handler[0], sub_handler[1]) 启动服务（后端框架使用的为tornado，启动方式为Application类继承自tornado.web.Application，在类的初始化方法中通过environment.register_services()完成所有api的注册（即加到cls_service_中），environment.init_file_cache()完成模版文件的缓存制造，m_handlers, s_handlers &#x3D; environment.get_handlers()获取所有handler并通过tornado.web.Application.init(self, m_handlers, **settings)将handler注册到Application中（handler的查找为从admin、apps、core模块中查找文件名以handler开头的模块中的open_handler装饰器装饰的类），然后获取服务启动的端口号启动服务） open_api注册机制查找conf.d下的apps.conf和config下的hcm_customer.conf下的指定的模块下的BaseOpenApiService的子类中被装饰器open_api修饰的方法（装饰器open_api会将修饰的方法和装饰器open_service会将修饰的类中的方法添加api_name属性），此类方法会被认为是API对应的方法，register_service方法会将此类方法都注册为API（包含方法对应的模块、类、方法以及描述等信息注册进cls.services中） open_service注册机制OpenServiceDecorator装饰器会将修饰的类中所有不是以‘_’开头的方法名和装饰器的name拼装成apiName，然后和api走一样的注册方式 CeleryBeat启动CeleryWorker启动","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"047-综合实例","slug":"项目/HCM教程/047-综合实例","date":"2025-06-05T15:44:25.000Z","updated":"2025-07-21T01:45:13.885Z","comments":true,"path":"2025/06/05/项目/HCM教程/047-综合实例/","link":"","permalink":"https://dbbruce.github.io/2025/06/05/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/047-%E7%BB%BC%E5%90%88%E5%AE%9E%E4%BE%8B/","excerpt":"自定义登录页面一个综合实例包含，action链，按钮，字段的配置等","text":"自定义登录页面一个综合实例包含，action链，按钮，字段的配置等 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591601611621631641651661671681691701711721731741751761771781791801811821831841851861871881891901911921931941951961971981992002012022032042052062072082092102112122132142152162172182192202212222232242252262272282292302312322332342352362372382392402412422432442452462472482492502512522532542552562572582592602612622632642652662672682692702712722732742752762772782792802812822832842852862872882892902912922932942952962972982993003013023033043053063073083093103113123133143153163173183193203213223233243253263273283293303313323333343353363373383393403413423433443453463473483493503513523533543553563573583593603613623633643653663673683693703713723733743753763773783793803813823833843853863873883893903913923933943953963973983994004014024034044054064074084094104114124134144154164174184194204214224234244254264274284294304314324334344354364374384394404414424434444454464474484494504514524534544554564574584594604614624634644654664674684694704714724734744754764774784794804814824834844854864874884894904914924934944954964974984995005015025035045055065075085095105115125135145155165175185195205215225235245255265275285295305315325335345355365375385395405415425435445455465475485495505515525535545555565575585595605615625635645655665675685695705715725735745755765775785795805815825835845855865875885895905915925935945955965975985996006016026036046056066076086096106116126136146156166176186196206216226236246256266276286296306316326336346356366376386396406416426436446456466476486496506516526536546556566576586596606616626636646656666676686696706716726736746756766776786796806816826836846856866876886896906916926936946956966976986997007017027037047057067077087097107117127137147157167177187197207217227237247257267277287297307317327337347357367377387397407417427437447457467477487497507517527537547557567577587597607617627637647657667677687697707717727737747757767777787797807817827837847857867877887897907917927937947957967977987998008018028038048058068078088098108118128138148158168178188198208218228238248258268278288298308318328338348358368378388398408418428438448458468478488498508518528538548558568578588598608618628638648658668678688698708718728738748758768778788798808818828838848858868878888898908918928938948958968978988999009019029039049059069079089099109119129139149159169179189199209219229239249259269279289299309319329339349359369379389399409419429439449459469479489499509519529539549559569579589599609619629639649659669679689699709719729739749759769779789799809819829839849859869879889899909919929939949959969979989991000100110021003100410051006100710081009101010111012101310141015101610171018101910201021102210231024102510261027102810291030103110321033103410351036103710381039104010411042104310441045104610471048104910501051105210531054105510561057105810591060106110621063106410651066106710681069107010711072107310741075107610771078107910801081108210831084108510861087108810891090109110921093109410951096109710981099110011011102110311041105110611071108110911101111111211131114111511161117111811191120112111221123112411251126112711281129113011311132113311341135113611371138113911401141114211431144114511461147114811491150115111521153115411551156115711581159116011611162116311641165116611671168116911701171117211731174117511761177117811791180118111821183118411851186118711881189119011911192119311941195119611971198119912001201120212031204120512061207120812091210121112121213121412151216121712181219122012211222122312241225122612271228122912301231123212331234123512361237123812391240124112421243124412451246124712481249125012511252125312541255125612571258125912601261126212631264126512661267126812691270127112721273127412751276127712781279128012811282128312841285128612871288128912901291129212931294129512961297129812991300130113021303130413051306130713081309131013111312131313141315131613171318131913201321132213231324132513261327132813291330133113321333133413351336133713381339134013411342134313441345134613471348134913501351135213531354135513561357135813591360136113621363136413651366136713681369137013711372137313741375137613771378137913801381138213831384138513861387138813891390139113921393139413951396139713981399140014011402140314041405140614071408140914101411141214131414141514161417141814191420142114221423142414251426142714281429143014311432143314341435143614371438143914401441144214431444144514461447144814491450145114521453145414551456145714581459146014611462146314641465146614671468146914701471147214731474147514761477147814791480148114821483148414851486148714881489149014911492149314941495149614971498149915001501150215031504150515061507150815091510151115121513151415151516151715181519152015211522152315241525152615271528152915301531153215331534153515361537153815391540154115421543154415451546154715481549155015511552155315541555155615571558155915601561156215631564156515661567156815691570157115721573157415751576157715781579158015811582158315841585158615871588158915901591159215931594159515961597159815991600160116021603160416051606160716081609161016111612161316141615161616171618161916201621162216231624162516261627162816291630163116321633163416351636163716381639164016411642164316441645164616471648164916501651165216531654165516561657165816591660166116621663166416651666166716681669167016711672167316741675167616771678167916801681168216831684168516861687168816891690169116921693169416951696169716981699170017011702170317041705170617071708170917101711171217131714171517161717171817191720172117221723172417251726172717281729173017311732173317341735173617371738173917401741174217431744174517461747174817491750175117521753175417551756175717581759176017611762176317641765176617671768176917701771177217731774177517761777177817791780178117821783178417851786178717881789179017911792179317941795179617971798179918001801180218031804180518061807180818091810181118121813181418151816181718181819182018211822182318241825182618271828182918301831183218331834183518361837183818391840184118421843184418451846184718481849185018511852185318541855185618571858185918601861186218631864186518661867186818691870187118721873187418751876187718781879188018811882188318841885188618871888188918901891189218931894189518961897189818991900190119021903190419051906190719081909191019111912191319141915191619171918191919201921192219231924192519261927192819291930193119321933193419351936193719381939194019411942194319441945194619471948194919501951195219531954195519561957195819591960196119621963196419651966196719681969197019711972197319741975197619771978197919801981198219831984198519861987198819891990199119921993199419951996199719981999200020012002200320042005200620072008200920102011201220132014201520162017201820192020202120222023202420252026202720282029203020312032203320342035203620372038203920402041204220432044204520462047204820492050205120522053205420552056205720582059206020612062206320642065206620672068206920702071207220732074207520762077207820792080208120822083208420852086208720882089209020912092209320942095209620972098209921002101210221032104210521062107210821092110211121122113211421152116211721182119212021212122212321242125212621272128212921302131213221332134213521362137213821392140214121422143214421452146214721482149215021512152215321542155215621572158215921602161216221632164216521662167216821692170217121722173217421752176217721782179218021812182218321842185218621872188218921902191219221932194219521962197219821992200220122022203220422052206220722082209221022112212221322142215221622172218221922202221222222232224222522262227222822292230223122322233223422352236223722382239224022412242224322442245224622472248224922502251225222532254225522562257225822592260226122622263226422652266226722682269227022712272227322742275227622772278227922802281228222832284228522862287228822892290229122922293229422952296229722982299230023012302230323042305230623072308230923102311231223132314231523162317231823192320232123222323232423252326232723282329233023312332233323342335233623372338233923402341234223432344234523462347234823492350235123522353235423552356235723582359236023612362236323642365236623672368236923702371237223732374237523762377237823792380238123822383238423852386238723882389239023912392239323942395239623972398239924002401240224032404240524062407240824092410241124122413241424152416241724182419242024212422242324242425242624272428242924302431243224332434243524362437243824392440244124422443244424452446244724482449245024512452245324542455245624572458245924602461246224632464246524662467246824692470247124722473247424752476247724782479248024812482248324842485248624872488248924902491249224932494249524962497249824992500250125022503250425052506250725082509251025112512251325142515251625172518251925202521252225232524252525262527252825292530253125322533253425352536253725382539254025412542254325442545254625472548254925502551255225532554255525562557255825592560256125622563256425652566256725682569257025712572257325742575257625772578257925802581258225832584258525862587258825892590259125922593259425952596259725982599260026012602260326042605260626072608260926102611261226132614261526162617261826192620262126222623262426252626262726282629263026312632263326342635263626372638263926402641264226432644264526462647264826492650265126522653265426552656265726582659266026612662266326642665266626672668266926702671267226732674267526762677267826792680268126822683268426852686268726882689269026912692269326942695269626972698269927002701270227032704270527062707270827092710271127122713271427152716271727182719272027212722272327242725272627272728272927302731273227332734273527362737273827392740274127422743274427452746274727482749275027512752275327542755275627572758275927602761276227632764276527662767276827692770277127722773277427752776277727782779278027812782278327842785278627872788278927902791279227932794279527962797279827992800280128022803280428052806280728082809281028112812281328142815281628172818281928202821282228232824282528262827282828292830283128322833283428352836283728382839284028412842284328442845284628472848284928502851285228532854285528562857285828592860286128622863286428652866286728682869287028712872287328742875287628772878287928802881288228832884288528862887288828892890289128922893289428952896289728982899290029012902290329042905290629072908290929102911291229132914291529162917291829192920292129222923292429252926292729282929293029312932293329342935293629372938293929402941294229432944294529462947294829492950295129522953295429552956295729582959296029612962296329642965296629672968296929702971297229732974297529762977297829792980298129822983298429852986298729882989299029912992299329942995299629972998299930003001300230033004300530063007300830093010301130123013301430153016301730183019302030213022302330243025302630273028302930303031303230333034303530363037303830393040304130423043304430453046304730483049305030513052305330543055305630573058305930603061306230633064306530663067306830693070307130723073307430753076307730783079308030813082308330843085308630873088308930903091309230933094309530963097309830993100310131023103310431053106310731083109311031113112311331143115311631173118311931203121312231233124312531263127312831293130313131323133313431353136313731383139314031413142314331443145314631473148314931503151315231533154315531563157315831593160316131623163316431653166316731683169317031713172317331743175317631773178317931803181318231833184318531863187318831893190319131923193319431953196319731983199320032013202320332043205320632073208320932103211321232133214321532163217321832193220322132223223322432253226322732283229323032313232323332343235323632373238323932403241324232433244324532463247324832493250325132523253325432553256325732583259326032613262326332643265326632673268326932703271327232733274327532763277327832793280328132823283328432853286328732883289329032913292329332943295329632973298329933003301330233033304330533063307330833093310331133123313331433153316331733183319332033213322332333243325332633273328332933303331333233333334333533363337333833393340334133423343334433453346334733483349335033513352335333543355335633573358335933603361336233633364336533663367336833693370337133723373337433753376337733783379338033813382338333843385338633873388338933903391339233933394339533963397339833993400340134023403340434053406340734083409341034113412341334143415341634173418341934203421342234233424342534263427342834293430343134323433343434353436343734383439344034413442344334443445344634473448344934503451345234533454345534563457345834593460346134623463346434653466346734683469347034713472347334743475347634773478347934803481348234833484348534863487348834893490349134923493349434953496349734983499350035013502350335043505350635073508350935103511351235133514351535163517351835193520352135223523352435253526352735283529353035313532353335343535353635373538353935403541354235433544354535463547354835493550355135523553355435553556355735583559356035613562356335643565356635673568356935703571357235733574357535763577357835793580358135823583358435853586358735883589359035913592359335943595359635973598359936003601360236033604360536063607360836093610361136123613361436153616361736183619362036213622362336243625362636273628362936303631363236333634363536363637363836393640364136423643364436453646364736483649365036513652365336543655365636573658365936603661366236633664366536663667366836693670367136723673367436753676367736783679368036813682368336843685368636873688368936903691369236933694369536963697369836993700370137023703370437053706370737083709371037113712371337143715371637173718371937203721372237233724372537263727372837293730373137323733373437353736373737383739374037413742374337443745374637473748374937503751375237533754375537563757375837593760376137623763376437653766376737683769377037713772377337743775377637773778377937803781378237833784378537863787378837893790379137923793379437953796379737983799380038013802380338043805380638073808380938103811381238133814381538163817381838193820382138223823382438253826382738283829383038313832383338343835383638373838383938403841384238433844384538463847384838493850385138523853385438553856385738583859386038613862386338643865386638673868386938703871387238733874387538763877387838793880388138823883388438853886388738883889389038913892389338943895389638973898389939003901390239033904390539063907390839093910391139123913391439153916391739183919392039213922392339243925392639273928392939303931393239333934393539363937393839393940394139423943394439453946394739483949395039513952395339543955395639573958395939603961396239633964396539663967396839693970397139723973397439753976397739783979398039813982398339843985398639873988398939903991399239933994399539963997399839994000400140024003400440054006400740084009401040114012401340144015401640174018401940204021402240234024402540264027402840294030403140324033403440354036403740384039404040414042404340444045404640474048404940504051405240534054405540564057405840594060406140624063406440654066406740684069407040714072407340744075407640774078407940804081408240834084408540864087408840894090409140924093409440954096409740984099410041014102410341044105410641074108410941104111411241134114411541164117411841194120412141224123412441254126412741284129413041314132413341344135413641374138413941404141414241434144414541464147414841494150415141524153415441554156415741584159416041614162416341644165416641674168416941704171417241734174417541764177417841794180418141824183418441854186418741884189419041914192419341944195419641974198419942004201420242034204420542064207420842094210421142124213421442154216421742184219422042214222422342244225422642274228422942304231423242334234423542364237423842394240424142424243424442454246424742484249425042514252425342544255425642574258425942604261426242634264426542664267426842694270427142724273427442754276427742784279428042814282428342844285428642874288428942904291429242934294429542964297429842994300430143024303430443054306430743084309431043114312431343144315431643174318431943204321432243234324432543264327432843294330433143324333433443354336433743384339434043414342434343444345434643474348434943504351435243534354435543564357435843594360436143624363436443654366436743684369437043714372437343744375437643774378437943804381438243834384438543864387438843894390439143924393439443954396439743984399440044014402440344044405440644074408440944104411441244134414441544164417441844194420442144224423442444254426442744284429443044314432443344344435443644374438443944404441444244434444444544464447444844494450445144524453445444554456445744584459446044614462446344644465446644674468446944704471447244734474447544764477447844794480448144824483448444854486448744884489449044914492449344944495449644974498449945004501450245034504450545064507450845094510451145124513451445154516451745184519452045214522452345244525452645274528452945304531453245334534453545364537453845394540454145424543454445454546454745484549455045514552455345544555455645574558455945604561456245634564456545664567456845694570457145724573457445754576457745784579458045814582458345844585458645874588458945904591459245934594459545964597459845994600460146024603460446054606460746084609461046114612461346144615461646174618461946204621462246234624462546264627462846294630463146324633463446354636463746384639464046414642464346444645464646474648464946504651465246534654465546564657465846594660466146624663466446654666466746684669467046714672467346744675467646774678467946804681468246834684468546864687468846894690469146924693469446954696469746984699470047014702470347044705470647074708470947104711471247134714471547164717471847194720472147224723472447254726472747284729473047314732473347344735473647374738473947404741474247434744474547464747474847494750475147524753475447554756475747584759476047614762476347644765476647674768476947704771477247734774477547764777477847794780478147824783478447854786478747884789479047914792479347944795479647974798479948004801480248034804480548064807480848094810481148124813481448154816481748184819482048214822482348244825482648274828482948304831483248334834483548364837483848394840484148424843484448454846484748484849485048514852485348544855485648574858485948604861486248634864486548664867486848694870487148724873487448754876487748784879488048814882488348844885488648874888488948904891489248934894489548964897489848994900490149024903490449054906490749084909491049114912491349144915491649174918491949204921492249234924492549264927492849294930493149324933493449354936493749384939494049414942494349444945&#123; &quot;fields&quot;: [ &#123; &quot;field&quot;: [ &quot;employee&quot;, &quot;number&quot; ], &quot;key&quot;: &quot;employee_number&quot;, &quot;hide&quot;: false, &quot;sequence&quot;: 10, &quot;fixed&quot;: true, &quot;data_type&quot;: &quot;string&quot;, &quot;align&quot;: &quot;center&quot;, &quot;label&quot;: &quot;员工编号&quot;, &quot;width&quot;: 120, &quot;origin&quot;: &quot;profile&quot;, &quot;type&quot;: &quot;string&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: false &#125; &#125;, &#123; &quot;field&quot;: [ &quot;employee&quot;, &quot;id_type&quot; ], &quot;sequence&quot;: 10, &quot;key&quot;: &quot;idtype&quot;, &quot;data_type&quot;: &quot;string&quot;, &quot;label&quot;: &quot;证件类型&quot;, &quot;hide&quot;: true, &quot;origin&quot;: &quot;profile&quot;, &quot;type&quot;: &quot;string&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: true &#125; &#125;, &#123; &quot;label&quot;: &quot;姓名&quot;, &quot;key&quot;: &quot;employee_id&quot;, &quot;field&quot;: [ &quot;employee&quot;, &quot;name&quot; ], &quot;data_type&quot;: &quot;integer&quot;, &quot;object&quot;: &quot;Employee&quot;, &quot;align&quot;: &quot;left&quot;, &quot;width&quot;: 100, &quot;sequence&quot;: 20, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: true, &quot;fixed&quot;: true, &quot;origin&quot;: &quot;profile&quot;, &quot;type&quot;: &quot;integer&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;上级成本中心&quot;, &quot;key&quot;: &quot;depart_id_id&quot;, &quot;field&quot;: [ &quot;department&quot;, &quot;parent&quot;, &quot;name&quot; ], &quot;align&quot;: &quot;left&quot;, &quot;width&quot;: 160, &quot;sequence&quot;: 40, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: false, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;成本中心&quot;, &quot;key&quot;: &quot;depart_id&quot;, &quot;field&quot;: [ &quot;depart&quot;, &quot;name&quot; ], &quot;data_type&quot;: &quot;integer&quot;, &quot;object&quot;: &quot;Department&quot;, &quot;align&quot;: &quot;left&quot;, &quot;width&quot;: 160, &quot;sequence&quot;: 50, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: false, &quot;origin&quot;: &quot;profile&quot;, &quot;type&quot;: &quot;integer&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;职位&quot;, &quot;key&quot;: &quot;position_id&quot;, &quot;field&quot;: [ &quot;position&quot;, &quot;name&quot; ], &quot;data_type&quot;: &quot;integer&quot;, &quot;object&quot;: &quot;Department&quot;, &quot;align&quot;: &quot;left&quot;, &quot;width&quot;: 160, &quot;sequence&quot;: 60, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: false, &quot;origin&quot;: &quot;profile&quot;, &quot;type&quot;: &quot;integer&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;年终一次性奖金&quot;, &quot;key&quot;: &quot;01&quot;, &quot;field&quot;: [ &quot;data&quot;, &quot;01&quot;, &quot;value&quot; ], &quot;data_type&quot;: &quot;float&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: 200, &quot;fieldFunc&quot;: &quot;=function(_row,col,value)&#123;if(value === null || value === undefined)&#123;return 0;&#125;else&#123;return value;&#125;&#125;&quot;, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: null, &quot;origin&quot;: &#123; &quot;id&quot;: 509956, &quot;number&quot;: &quot;01&quot;, &quot;name&quot;: &quot;年终一次性奖金&quot;, &quot;is_formula&quot;: 1, &quot;is_used&quot;: 1, &quot;end_month&quot;: &quot;2199-12&quot; &#125;, &quot;style&quot;: &quot;cell-select&quot;, &quot;func&quot;: &quot;=function(_row, _col, _event)&#123;return SCOPE.viewDetail(_row, _col.origin);&#125;&quot;, &quot;precision&quot;: 2, &quot;hide&quot;: false, &quot;type&quot;: &quot;numeric&quot;, &quot;formatter&quot;: &quot;numberFormat&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: 2, &quot;description&quot;: null, &quot;hide&quot;: false &#125; &#125;, &#123; &quot;label&quot;: &quot;年终奖税金&quot;, &quot;key&quot;: &quot;02&quot;, &quot;field&quot;: [ &quot;data&quot;, &quot;02&quot;, &quot;value&quot; ], &quot;data_type&quot;: &quot;float&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: 250, &quot;fieldFunc&quot;: &quot;=function(_row,col,value)&#123;if(value === null || value === undefined)&#123;return 0;&#125;else&#123;return value;&#125;&#125;&quot;, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: null, &quot;origin&quot;: &#123; &quot;id&quot;: 509957, &quot;number&quot;: &quot;02&quot;, &quot;name&quot;: &quot;年终奖税金&quot;, &quot;is_formula&quot;: 1, &quot;is_used&quot;: 1, &quot;end_month&quot;: &quot;2199-12&quot; &#125;, &quot;style&quot;: &quot;cell-select&quot;, &quot;func&quot;: &quot;=function(_row, _col, _event)&#123;return SCOPE.viewDetail(_row, _col.origin);&#125;&quot;, &quot;precision&quot;: 2, &quot;hide&quot;: false, &quot;type&quot;: &quot;numeric&quot;, &quot;formatter&quot;: &quot;numberFormat&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: 2, &quot;description&quot;: null, &quot;hide&quot;: false &#125; &#125;, &#123; &quot;label&quot;: &quot;年终奖扣款&quot;, &quot;key&quot;: &quot;03&quot;, &quot;field&quot;: [ &quot;data&quot;, &quot;03&quot;, &quot;value&quot; ], &quot;data_type&quot;: &quot;float&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: 300, &quot;fieldFunc&quot;: &quot;=function(_row,col,value)&#123;if(value === null || value === undefined)&#123;return 0;&#125;else&#123;return value;&#125;&#125;&quot;, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: null, &quot;origin&quot;: &#123; &quot;id&quot;: 509958, &quot;number&quot;: &quot;03&quot;, &quot;name&quot;: &quot;年终奖扣款&quot;, &quot;is_formula&quot;: 0, &quot;is_used&quot;: 0, &quot;end_month&quot;: &quot;2199-12&quot; &#125;, &quot;style&quot;: &quot;cell-select&quot;, &quot;func&quot;: &quot;=function(_row, _col, _event)&#123;return SCOPE.viewDetail(_row, _col.origin);&#125;&quot;, &quot;modi&quot;: &#123; &quot;component&quot;: &quot;hc-input&quot;, &quot;disabled&quot;: &quot;=function(_row,_col)&#123;if(_row.is_locked||_row.status.is_sealed)&#123;return true&#125;&#125;&quot;, &quot;options&quot;: &#123; &quot;data_type&quot;: &quot;float&quot;, &quot;required&quot;: true, &quot;width&quot;: &quot;col-6&quot;, &quot;singleLine&quot;: true, &quot;data_precision&quot;: 2, &quot;hide&quot;: false, &quot;readOnly&quot;: false, &quot;placeholder&quot;: &quot;请输入数值&quot;, &quot;default&quot;: null, &quot;default_expression&quot;: null, &quot;maxlength&quot;: 40 &#125; &#125;, &quot;precision&quot;: 2, &quot;hide&quot;: false, &quot;type&quot;: &quot;numeric&quot;, &quot;formatter&quot;: &quot;numberFormat&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: 2, &quot;description&quot;: null, &quot;hide&quot;: false &#125; &#125;, &#123; &quot;label&quot;: &quot;年终一次性奖金（合并计税）&quot;, &quot;key&quot;: &quot;04&quot;, &quot;field&quot;: [ &quot;data&quot;, &quot;04&quot;, &quot;value&quot; ], &quot;data_type&quot;: &quot;float&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: 350, &quot;fieldFunc&quot;: &quot;=function(_row,col,value)&#123;if(value === null || value === undefined)&#123;return 0;&#125;else&#123;return value;&#125;&#125;&quot;, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: null, &quot;origin&quot;: &#123; &quot;id&quot;: 1510405, &quot;number&quot;: &quot;04&quot;, &quot;name&quot;: &quot;年终一次性奖金（合并计税）&quot;, &quot;is_formula&quot;: 1, &quot;is_used&quot;: 1, &quot;end_month&quot;: &quot;2199-12&quot; &#125;, &quot;style&quot;: &quot;cell-select&quot;, &quot;func&quot;: &quot;=function(_row, _col, _event)&#123;return SCOPE.viewDetail(_row, _col.origin);&#125;&quot;, &quot;precision&quot;: 2, &quot;hide&quot;: false, &quot;type&quot;: &quot;numeric&quot;, &quot;formatter&quot;: &quot;numberFormat&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: 2, &quot;description&quot;: null, &quot;hide&quot;: false &#125; &#125;, &#123; &quot;label&quot;: &quot;本期收入&quot;, &quot;key&quot;: &quot;curincome&quot;, &quot;field&quot;: [ &quot;tax_return&quot;, &quot;curincome&quot; ], &quot;width&quot;: 100, &quot;align&quot;: &quot;center&quot;, &quot;sequence&quot;: 9000, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;本期免税收入&quot;, &quot;key&quot;: &quot;curdutyfreeincome&quot;, &quot;field&quot;: [ &quot;tax_return&quot;, &quot;curdutyfreeincome&quot; ], &quot;width&quot;: 100, &quot;align&quot;: &quot;center&quot;, &quot;sequence&quot;: 9000, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;本期减免税额&quot;, &quot;key&quot;: &quot;curreduamount&quot;, &quot;field&quot;: [ &quot;tax_return&quot;, &quot;curreduamount&quot; ], &quot;width&quot;: 100, &quot;align&quot;: &quot;center&quot;, &quot;sequence&quot;: 9000, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;本期基本养老保险费&quot;, &quot;key&quot;: &quot;basicoldins&quot;, &quot;field&quot;: [ &quot;tax_return&quot;, &quot;basicoldins&quot; ], &quot;width&quot;: 100, &quot;align&quot;: &quot;center&quot;, &quot;sequence&quot;: 9000, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;本期基本医疗保险费&quot;, &quot;key&quot;: &quot;basicmedicalins&quot;, &quot;field&quot;: [ &quot;tax_return&quot;, &quot;basicmedicalins&quot; ], &quot;width&quot;: 100, &quot;align&quot;: &quot;center&quot;, &quot;sequence&quot;: 9000, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;本期失业保险费&quot;, &quot;key&quot;: &quot;unemploymentins&quot;, &quot;field&quot;: [ &quot;tax_return&quot;, &quot;unemploymentins&quot; ], &quot;width&quot;: 100, &quot;align&quot;: &quot;center&quot;, &quot;sequence&quot;: 9000, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;本期住房公积金&quot;, &quot;key&quot;: &quot;housingprovidentfund&quot;, &quot;field&quot;: [ &quot;tax_return&quot;, &quot;housingprovidentfund&quot; ], &quot;width&quot;: 100, &quot;align&quot;: &quot;center&quot;, &quot;sequence&quot;: 9000, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;本期其他扣除(其他)&quot;, &quot;key&quot;: &quot;otherded&quot;, &quot;field&quot;: [ &quot;tax_return&quot;, &quot;otherded&quot; ], &quot;width&quot;: 100, &quot;align&quot;: &quot;center&quot;, &quot;sequence&quot;: 9000, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;累计收入额&quot;, &quot;key&quot;: &quot;accincome&quot;, &quot;field&quot;: [ &quot;tax_return&quot;, &quot;accincome&quot; ], &quot;width&quot;: 100, &quot;align&quot;: &quot;center&quot;, &quot;sequence&quot;: 9000, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;累计免税收入&quot;, &quot;key&quot;: &quot;accdutyfreeincome&quot;, &quot;field&quot;: [ &quot;tax_return&quot;, &quot;accdutyfreeincome&quot; ], &quot;width&quot;: 100, &quot;align&quot;: &quot;center&quot;, &quot;sequence&quot;: 9000, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;累计减除费用&quot;, &quot;key&quot;: &quot;accded&quot;, &quot;field&quot;: [ &quot;tax_return&quot;, &quot;accded&quot; ], &quot;width&quot;: 100, &quot;align&quot;: &quot;center&quot;, &quot;sequence&quot;: 9000, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;累计专项扣除&quot;, &quot;key&quot;: &quot;accspecialded&quot;, &quot;field&quot;: [ &quot;tax_return&quot;, &quot;accspecialded&quot; ], &quot;width&quot;: 100, &quot;align&quot;: &quot;center&quot;, &quot;sequence&quot;: 9000, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;累计子女教育&quot;, &quot;key&quot;: &quot;accchildeduexpded&quot;, &quot;field&quot;: [ &quot;tax_return&quot;, &quot;accchildeduexpded&quot; ], &quot;width&quot;: 100, &quot;align&quot;: &quot;center&quot;, &quot;sequence&quot;: 9000, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;累计继续教育&quot;, &quot;key&quot;: &quot;acccontinuingeduded&quot;, &quot;field&quot;: [ &quot;tax_return&quot;, &quot;acccontinuingeduded&quot; ], &quot;width&quot;: 100, &quot;align&quot;: &quot;center&quot;, &quot;sequence&quot;: 9000, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;累计住房贷款利息&quot;, &quot;key&quot;: &quot;acchousingloaninterestded&quot;, &quot;field&quot;: [ &quot;tax_return&quot;, &quot;acchousingloaninterestded&quot; ], &quot;width&quot;: 100, &quot;align&quot;: &quot;center&quot;, &quot;sequence&quot;: 9000, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;累计住房租金&quot;, &quot;key&quot;: &quot;acchousingrentded&quot;, &quot;field&quot;: [ &quot;tax_return&quot;, &quot;acchousingrentded&quot; ], &quot;width&quot;: 100, &quot;align&quot;: &quot;center&quot;, &quot;sequence&quot;: 9000, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;累计赡养老人&quot;, &quot;key&quot;: &quot;accsupportelderlyded&quot;, &quot;field&quot;: [ &quot;tax_return&quot;, &quot;accsupportelderlyded&quot; ], &quot;width&quot;: 100, &quot;align&quot;: &quot;center&quot;, &quot;sequence&quot;: 9000, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;累计婴幼儿照护费用&quot;, &quot;key&quot;: &quot;accdedinfantcareded&quot;, &quot;field&quot;: [ &quot;tax_return&quot;, &quot;accdedinfantcareded&quot; ], &quot;width&quot;: 100, &quot;align&quot;: &quot;center&quot;, &quot;sequence&quot;: 9000, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;累计个人养老金&quot;, &quot;key&quot;: &quot;acc_personal_pensions_ded&quot;, &quot;field&quot;: [ &quot;tax_return&quot;, &quot;acc_personal_pensions_ded&quot; ], &quot;width&quot;: 100, &quot;align&quot;: &quot;center&quot;, &quot;sequence&quot;: 9000, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;累计其他扣除&quot;, &quot;key&quot;: &quot;accotherded&quot;, &quot;field&quot;: [ &quot;tax_return&quot;, &quot;accotherded&quot; ], &quot;width&quot;: 100, &quot;align&quot;: &quot;center&quot;, &quot;sequence&quot;: 9000, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;累计应纳税所得额&quot;, &quot;key&quot;: &quot;acctaxableincome&quot;, &quot;field&quot;: [ &quot;tax_return&quot;, &quot;acctaxableincome&quot; ], &quot;width&quot;: 100, &quot;align&quot;: &quot;center&quot;, &quot;sequence&quot;: 9000, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;税率&quot;, &quot;key&quot;: &quot;taxrate&quot;, &quot;field&quot;: [ &quot;tax_return&quot;, &quot;taxrate&quot; ], &quot;width&quot;: 100, &quot;align&quot;: &quot;center&quot;, &quot;sequence&quot;: 9000, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;速算扣除数&quot;, &quot;key&quot;: &quot;quickdednum&quot;, &quot;field&quot;: [ &quot;tax_return&quot;, &quot;quickdednum&quot; ], &quot;width&quot;: 100, &quot;align&quot;: &quot;center&quot;, &quot;sequence&quot;: 9000, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;累计应纳税额&quot;, &quot;key&quot;: &quot;acctaxableamount&quot;, &quot;field&quot;: [ &quot;tax_return&quot;, &quot;acctaxableamount&quot; ], &quot;width&quot;: 100, &quot;align&quot;: &quot;center&quot;, &quot;sequence&quot;: 9000, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;累计减免税额&quot;, &quot;key&quot;: &quot;accreduamount&quot;, &quot;field&quot;: [ &quot;tax_return&quot;, &quot;accreduamount&quot; ], &quot;width&quot;: 100, &quot;align&quot;: &quot;center&quot;, &quot;sequence&quot;: 9000, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;累计应扣缴税额&quot;, &quot;key&quot;: &quot;accwithholdingtax&quot;, &quot;field&quot;: [ &quot;tax_return&quot;, &quot;accwithholdingtax&quot; ], &quot;width&quot;: 100, &quot;align&quot;: &quot;center&quot;, &quot;sequence&quot;: 9000, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;累计已预缴税额&quot;, &quot;key&quot;: &quot;accprepaidtax&quot;, &quot;field&quot;: [ &quot;tax_return&quot;, &quot;accprepaidtax&quot; ], &quot;width&quot;: 100, &quot;align&quot;: &quot;center&quot;, &quot;sequence&quot;: 9000, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;累计应补(退)税额&quot;, &quot;key&quot;: &quot;accpayorrefundtax&quot;, &quot;field&quot;: [ &quot;tax_return&quot;, &quot;accpayorrefundtax&quot; ], &quot;width&quot;: 100, &quot;align&quot;: &quot;center&quot;, &quot;sequence&quot;: 9000, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;薪资表&quot;, &quot;key&quot;: &quot;u_salary_name&quot;, &quot;field&quot;: [ &quot;u_salary_n&quot;, &quot;name&quot; ], &quot;data_type&quot;: &quot;integer&quot;, &quot;object&quot;: &quot;SalaryStandardGlobal&quot;, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: null, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: false, &quot;style&quot;: null, &quot;func&quot;: null, &quot;hide&quot;: null, &quot;origin&quot;: null, &quot;fieldBackgroundColorFunc&quot;: null, &quot;mask&quot;: null, &quot;type&quot;: &quot;integer&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;薪档&quot;, &quot;key&quot;: &quot;u_salary_level&quot;, &quot;field&quot;: [ &quot;u_salary_level&quot; ], &quot;data_type&quot;: &quot;string&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: null, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: true, &quot;style&quot;: null, &quot;func&quot;: null, &quot;hide&quot;: null, &quot;origin&quot;: null, &quot;fieldBackgroundColorFunc&quot;: null, &quot;mask&quot;: null, &quot;type&quot;: &quot;string&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;发薪地&quot;, &quot;key&quot;: &quot;u_salary_place&quot;, &quot;field&quot;: [ &quot;u_salary_place&quot; ], &quot;data_type&quot;: &quot;string&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: null, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: false, &quot;style&quot;: null, &quot;func&quot;: null, &quot;hide&quot;: null, &quot;origin&quot;: null, &quot;fieldBackgroundColorFunc&quot;: null, &quot;mask&quot;: null, &quot;type&quot;: &quot;string&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;职位&quot;, &quot;key&quot;: &quot;u_position&quot;, &quot;field&quot;: [ &quot;u_posit&quot;, &quot;name&quot; ], &quot;data_type&quot;: &quot;integer&quot;, &quot;object&quot;: &quot;common_basic_item_data.职位&quot;, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: null, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: false, &quot;style&quot;: null, &quot;func&quot;: null, &quot;hide&quot;: null, &quot;origin&quot;: null, &quot;fieldBackgroundColorFunc&quot;: null, &quot;mask&quot;: null, &quot;type&quot;: &quot;integer&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;是否历史薪酬&quot;, &quot;key&quot;: &quot;u_history_salary&quot;, &quot;field&quot;: [ &quot;u_history_salary&quot; ], &quot;data_type&quot;: &quot;boolean&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: null, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: false, &quot;mask&quot;: [ &#123; &quot;key&quot;: true, &quot;name&quot;: &quot;是&quot; &#125;, &#123; &quot;key&quot;: false, &quot;name&quot;: &quot;否&quot; &#125; ], &quot;style&quot;: null, &quot;func&quot;: null, &quot;hide&quot;: null, &quot;origin&quot;: null, &quot;fieldBackgroundColorFunc&quot;: null, &quot;type&quot;: &quot;boolean&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;工作城市&quot;, &quot;key&quot;: &quot;u_work_city&quot;, &quot;field&quot;: [ &quot;u_work_c&quot;, &quot;name&quot; ], &quot;data_type&quot;: &quot;integer&quot;, &quot;object&quot;: &quot;common_basic_item_data.工作城市&quot;, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: null, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: false, &quot;style&quot;: null, &quot;func&quot;: null, &quot;hide&quot;: null, &quot;origin&quot;: null, &quot;fieldBackgroundColorFunc&quot;: null, &quot;mask&quot;: null, &quot;type&quot;: &quot;integer&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;地区系数&quot;, &quot;key&quot;: &quot;u_place_number&quot;, &quot;field&quot;: [ &quot;u_place_number&quot; ], &quot;data_type&quot;: &quot;string&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: null, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: false, &quot;style&quot;: null, &quot;func&quot;: null, &quot;hide&quot;: null, &quot;origin&quot;: null, &quot;fieldBackgroundColorFunc&quot;: null, &quot;mask&quot;: null, &quot;type&quot;: &quot;string&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;职等&quot;, &quot;key&quot;: &quot;u_grade&quot;, &quot;field&quot;: [ &quot;u_grade&quot; ], &quot;data_type&quot;: &quot;string&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: null, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: false, &quot;style&quot;: null, &quot;func&quot;: null, &quot;hide&quot;: null, &quot;origin&quot;: null, &quot;fieldBackgroundColorFunc&quot;: null, &quot;mask&quot;: null, &quot;type&quot;: &quot;string&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;薪档&quot;, &quot;key&quot;: &quot;u_salary_grade&quot;, &quot;field&quot;: [ &quot;u_salary_grade&quot; ], &quot;data_type&quot;: &quot;string&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: null, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: false, &quot;style&quot;: null, &quot;func&quot;: null, &quot;hide&quot;: null, &quot;origin&quot;: null, &quot;fieldBackgroundColorFunc&quot;: null, &quot;mask&quot;: null, &quot;type&quot;: &quot;string&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;开户地&quot;, &quot;key&quot;: &quot;u_account_place&quot;, &quot;field&quot;: [ &quot;u_account_pl&quot;, &quot;name&quot; ], &quot;data_type&quot;: &quot;integer&quot;, &quot;object&quot;: &quot;common_basic_item_data.开户地&quot;, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: null, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: false, &quot;style&quot;: null, &quot;func&quot;: null, &quot;hide&quot;: null, &quot;origin&quot;: null, &quot;fieldBackgroundColorFunc&quot;: null, &quot;mask&quot;: null, &quot;type&quot;: &quot;integer&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;应发合计&quot;, &quot;key&quot;: &quot;salary_count&quot;, &quot;field&quot;: [ &quot;balance&quot;, &quot;salary_count&quot; ], &quot;data_type&quot;: &quot;float&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: 10000, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: null, &quot;style&quot;: null, &quot;func&quot;: null, &quot;hide&quot;: null, &quot;action&quot;: null, &quot;type&quot;: &quot;numeric&quot;, &quot;formatter&quot;: &quot;numberFormat&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;成本合计&quot;, &quot;key&quot;: &quot;salary_cost&quot;, &quot;field&quot;: [ &quot;balance&quot;, &quot;salary_cost&quot; ], &quot;data_type&quot;: &quot;float&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: 10050, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: null, &quot;style&quot;: null, &quot;func&quot;: null, &quot;hide&quot;: null, &quot;action&quot;: null, &quot;type&quot;: &quot;numeric&quot;, &quot;formatter&quot;: &quot;numberFormat&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;应税合计&quot;, &quot;key&quot;: &quot;salary_tax_base&quot;, &quot;field&quot;: [ &quot;balance&quot;, &quot;salary_tax_base&quot; ], &quot;data_type&quot;: &quot;float&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: 10052, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: null, &quot;style&quot;: null, &quot;func&quot;: null, &quot;hide&quot;: true, &quot;origin&quot;: null, &quot;fieldBackgroundColorFunc&quot;: null, &quot;mask&quot;: null, &quot;type&quot;: &quot;numeric&quot;, &quot;formatter&quot;: &quot;numberFormat&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: true &#125; &#125;, &#123; &quot;label&quot;: &quot;外籍免税补贴&quot;, &quot;key&quot;: &quot;tax_free_subsidy&quot;, &quot;field&quot;: [ &quot;tax&quot;, &quot;tax_free_subsidy&quot; ], &quot;data_type&quot;: &quot;float&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: 10150, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: null, &quot;style&quot;: &quot;cell-select&quot;, &quot;func&quot;: &quot;=function (_row, _col) &#123;SCOPE.viewTaxDetail(_row, _col);&#125;&quot;, &quot;hide&quot;: true, &quot;origin&quot;: null, &quot;fieldBackgroundColorFunc&quot;: null, &quot;mask&quot;: null, &quot;type&quot;: &quot;numeric&quot;, &quot;formatter&quot;: &quot;numberFormat&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: true &#125; &#125;, &#123; &quot;label&quot;: &quot;本年累计应税合计（不含本月）&quot;, &quot;key&quot;: &quot;tax_base_already&quot;, &quot;field&quot;: [ &quot;tax&quot;, &quot;tax_base_already&quot; ], &quot;data_type&quot;: &quot;float&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: 10200, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: null, &quot;style&quot;: null, &quot;func&quot;: null, &quot;hide&quot;: true, &quot;origin&quot;: null, &quot;fieldBackgroundColorFunc&quot;: null, &quot;mask&quot;: null, &quot;type&quot;: &quot;numeric&quot;, &quot;formatter&quot;: &quot;numberFormat&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: true &#125; &#125;, &#123; &quot;label&quot;: &quot;本年累计子女教育&quot;, &quot;key&quot;: &quot;child_education&quot;, &quot;field&quot;: [ &quot;tax&quot;, &quot;child_education&quot; ], &quot;data_type&quot;: &quot;float&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: 10250, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: null, &quot;style&quot;: &quot;cell-select&quot;, &quot;func&quot;: &quot;=function (_row, _col) &#123;SCOPE.viewTaxDetail(_row, _col);&#125;&quot;, &quot;hide&quot;: true, &quot;origin&quot;: null, &quot;fieldBackgroundColorFunc&quot;: null, &quot;mask&quot;: null, &quot;type&quot;: &quot;numeric&quot;, &quot;formatter&quot;: &quot;numberFormat&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: true &#125; &#125;, &#123; &quot;label&quot;: &quot;本年累计继续教育&quot;, &quot;key&quot;: &quot;continuing_education&quot;, &quot;field&quot;: [ &quot;tax&quot;, &quot;continuing_education&quot; ], &quot;data_type&quot;: &quot;float&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: 10300, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: null, &quot;style&quot;: &quot;cell-select&quot;, &quot;func&quot;: &quot;=function (_row, _col) &#123;SCOPE.viewTaxDetail(_row, _col);&#125;&quot;, &quot;hide&quot;: true, &quot;origin&quot;: null, &quot;fieldBackgroundColorFunc&quot;: null, &quot;mask&quot;: null, &quot;type&quot;: &quot;numeric&quot;, &quot;formatter&quot;: &quot;numberFormat&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: true &#125; &#125;, &#123; &quot;label&quot;: &quot;本年累计住房贷款&quot;, &quot;key&quot;: &quot;housing_loan&quot;, &quot;field&quot;: [ &quot;tax&quot;, &quot;housing_loan&quot; ], &quot;data_type&quot;: &quot;float&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: 10350, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: null, &quot;style&quot;: &quot;cell-select&quot;, &quot;func&quot;: &quot;=function (_row, _col) &#123;SCOPE.viewTaxDetail(_row, _col);&#125;&quot;, &quot;hide&quot;: true, &quot;origin&quot;: null, &quot;fieldBackgroundColorFunc&quot;: null, &quot;mask&quot;: null, &quot;type&quot;: &quot;numeric&quot;, &quot;formatter&quot;: &quot;numberFormat&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: true &#125; &#125;, &#123; &quot;label&quot;: &quot;本年累计住房租金&quot;, &quot;key&quot;: &quot;housing_rent&quot;, &quot;field&quot;: [ &quot;tax&quot;, &quot;housing_rent&quot; ], &quot;data_type&quot;: &quot;float&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: 10400, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: null, &quot;style&quot;: &quot;cell-select&quot;, &quot;func&quot;: &quot;=function (_row, _col) &#123;SCOPE.viewTaxDetail(_row, _col);&#125;&quot;, &quot;hide&quot;: true, &quot;origin&quot;: null, &quot;fieldBackgroundColorFunc&quot;: null, &quot;mask&quot;: null, &quot;type&quot;: &quot;numeric&quot;, &quot;formatter&quot;: &quot;numberFormat&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: true &#125; &#125;, &#123; &quot;label&quot;: &quot;本年累计赡养老人&quot;, &quot;key&quot;: &quot;elderly_support&quot;, &quot;field&quot;: [ &quot;tax&quot;, &quot;elderly_support&quot; ], &quot;data_type&quot;: &quot;float&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: 10450, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: null, &quot;style&quot;: &quot;cell-select&quot;, &quot;func&quot;: &quot;=function (_row, _col) &#123;SCOPE.viewTaxDetail(_row, _col);&#125;&quot;, &quot;hide&quot;: true, &quot;origin&quot;: null, &quot;fieldBackgroundColorFunc&quot;: null, &quot;mask&quot;: null, &quot;type&quot;: &quot;numeric&quot;, &quot;formatter&quot;: &quot;numberFormat&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: true &#125; &#125;, &#123; &quot;label&quot;: &quot;本年累计婴幼儿照护费用&quot;, &quot;key&quot;: &quot;infant_care_deduct&quot;, &quot;field&quot;: [ &quot;tax&quot;, &quot;infant_care_deduct&quot; ], &quot;data_type&quot;: &quot;float&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: 10460, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: null, &quot;style&quot;: &quot;cell-select&quot;, &quot;func&quot;: &quot;=function (_row, _col) &#123;SCOPE.viewTaxDetail(_row, _col);&#125;&quot;, &quot;hide&quot;: true, &quot;origin&quot;: null, &quot;fieldBackgroundColorFunc&quot;: null, &quot;mask&quot;: null, &quot;type&quot;: &quot;numeric&quot;, &quot;formatter&quot;: &quot;numberFormat&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: true &#125; &#125;, &#123; &quot;label&quot;: &quot;本年累计个人养老金&quot;, &quot;key&quot;: &quot;personal_pensions&quot;, &quot;field&quot;: [ &quot;tax&quot;, &quot;personal_pensions&quot; ], &quot;data_type&quot;: &quot;float&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: 10460, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: null, &quot;style&quot;: &quot;cell-select&quot;, &quot;func&quot;: &quot;=function (_row, _col) &#123;SCOPE.viewTaxDetail(_row, _col);&#125;&quot;, &quot;hide&quot;: true, &quot;origin&quot;: null, &quot;fieldBackgroundColorFunc&quot;: null, &quot;mask&quot;: null, &quot;type&quot;: &quot;numeric&quot;, &quot;formatter&quot;: &quot;numberFormat&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: true &#125; &#125;, &#123; &quot;label&quot;: &quot;本年累计大病医疗&quot;, &quot;key&quot;: &quot;illness_insurance&quot;, &quot;field&quot;: [ &quot;tax&quot;, &quot;illness_insurance&quot; ], &quot;data_type&quot;: &quot;float&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: 10500, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: null, &quot;style&quot;: &quot;cell-select&quot;, &quot;func&quot;: &quot;=function (_row, _col) &#123;SCOPE.viewTaxDetail(_row, _col);&#125;&quot;, &quot;hide&quot;: true, &quot;origin&quot;: null, &quot;fieldBackgroundColorFunc&quot;: null, &quot;mask&quot;: null, &quot;type&quot;: &quot;numeric&quot;, &quot;formatter&quot;: &quot;numberFormat&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: true &#125; &#125;, &#123; &quot;label&quot;: &quot;本次扣税&quot;, &quot;key&quot;: &quot;salary_tax&quot;, &quot;field&quot;: [ &quot;balance&quot;, &quot;salary_tax&quot; ], &quot;data_type&quot;: &quot;float&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: 10550, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: null, &quot;style&quot;: null, &quot;func&quot;: null, &quot;hide&quot;: null, &quot;action&quot;: &quot;viewTax&quot;, &quot;type&quot;: &quot;numeric&quot;, &quot;formatter&quot;: &quot;numberFormat&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;label&quot;: &quot;本年累计专项附加扣除&quot;, &quot;key&quot;: &quot;special_addition&quot;, &quot;field&quot;: [ &quot;tax&quot;, &quot;special_addition&quot; ], &quot;data_type&quot;: &quot;float&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: 10550, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: null, &quot;style&quot;: null, &quot;func&quot;: null, &quot;hide&quot;: true, &quot;origin&quot;: null, &quot;fieldBackgroundColorFunc&quot;: null, &quot;mask&quot;: null, &quot;type&quot;: &quot;numeric&quot;, &quot;formatter&quot;: &quot;numberFormat&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: true &#125; &#125;, &#123; &quot;label&quot;: &quot;起征点&quot;, &quot;key&quot;: &quot;threshold_deduct&quot;, &quot;field&quot;: [ &quot;threshold_deduct&quot; ], &quot;data_type&quot;: &quot;string&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: 10600, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: null, &quot;style&quot;: null, &quot;func&quot;: null, &quot;hide&quot;: true, &quot;origin&quot;: null, &quot;fieldBackgroundColorFunc&quot;: null, &quot;mask&quot;: null, &quot;type&quot;: &quot;string&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: true &#125; &#125;, &#123; &quot;label&quot;: &quot;累计应纳税所得额&quot;, &quot;key&quot;: &quot;taxable_income&quot;, &quot;field&quot;: [ &quot;tax&quot;, &quot;taxable_income&quot; ], &quot;data_type&quot;: &quot;float&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: 10650, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: null, &quot;style&quot;: null, &quot;func&quot;: null, &quot;hide&quot;: true, &quot;origin&quot;: null, &quot;fieldBackgroundColorFunc&quot;: null, &quot;mask&quot;: null, &quot;type&quot;: &quot;numeric&quot;, &quot;formatter&quot;: &quot;numberFormat&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: true &#125; &#125;, &#123; &quot;label&quot;: &quot;本年累计已扣税额（不含本月）&quot;, &quot;key&quot;: &quot;tax_data_deducted&quot;, &quot;field&quot;: [ &quot;tax&quot;, &quot;tax_data_deducted&quot; ], &quot;data_type&quot;: &quot;float&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: 10700, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: null, &quot;style&quot;: null, &quot;func&quot;: null, &quot;hide&quot;: true, &quot;origin&quot;: null, &quot;fieldBackgroundColorFunc&quot;: null, &quot;mask&quot;: null, &quot;type&quot;: &quot;numeric&quot;, &quot;formatter&quot;: &quot;numberFormat&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: true &#125; &#125;, &#123; &quot;label&quot;: &quot;本月个税&quot;, &quot;key&quot;: &quot;tax_data_current&quot;, &quot;field&quot;: [ &quot;tax&quot;, &quot;tax_data_current&quot; ], &quot;data_type&quot;: &quot;float&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: 10750, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: null, &quot;style&quot;: null, &quot;func&quot;: null, &quot;hide&quot;: true, &quot;origin&quot;: null, &quot;fieldBackgroundColorFunc&quot;: null, &quot;mask&quot;: null, &quot;type&quot;: &quot;numeric&quot;, &quot;formatter&quot;: &quot;numberFormat&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: true &#125; &#125;, &#123; &quot;label&quot;: &quot;实发合计&quot;, &quot;key&quot;: &quot;salary_real&quot;, &quot;field&quot;: [ &quot;balance&quot;, &quot;salary_real&quot; ], &quot;data_type&quot;: &quot;float&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: 10800, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: null, &quot;style&quot;: null, &quot;func&quot;: null, &quot;hide&quot;: null, &quot;action&quot;: null, &quot;type&quot;: &quot;numeric&quot;, &quot;formatter&quot;: &quot;numberFormat&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;field&quot;: [ &quot;status&quot;, &quot;business_status&quot; ], &quot;sequence&quot;: 10950, &quot;key&quot;: &quot;business_status&quot;, &quot;align&quot;: &quot;center&quot;, &quot;label&quot;: &quot;业务状态&quot;, &quot;mask&quot;: [ &#123; &quot;key&quot;: null, &quot;name&quot;: &quot;未计算&quot; &#125;, &#123; &quot;key&quot;: 1, &quot;name&quot;: &quot;已计算&quot; &#125;, &#123; &quot;key&quot;: 2, &quot;name&quot;: &quot;已锁定&quot; &#125;, &#123; &quot;key&quot;: 3, &quot;name&quot;: &quot;已封存&quot; &#125;, &#123; &quot;key&quot;: 4, &quot;name&quot;: &quot;已报盘&quot; &#125;, &#123; &quot;key&quot;: 5, &quot;name&quot;: &quot;工资条已发送&quot; &#125;, &#123; &quot;key&quot;: 6, &quot;name&quot;: &quot;工资条已确认&quot; &#125; ], &quot;width&quot;: 120, &quot;hide&quot;: true, &quot;data_type&quot;: &quot;string&quot;, &quot;type&quot;: &quot;string&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: true &#125; &#125;, &#123; &quot;label&quot;: &quot;封存状态&quot;, &quot;key&quot;: &quot;is_sealed&quot;, &quot;field&quot;: [ &quot;status&quot;, &quot;is_sealed&quot; ], &quot;data_type&quot;: &quot;string&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: 10950, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: null, &quot;mask&quot;: [ &#123; &quot;key&quot;: null, &quot;name&quot;: &quot;未封存&quot; &#125;, &#123; &quot;key&quot;: 0, &quot;name&quot;: &quot;未封存&quot; &#125;, &#123; &quot;key&quot;: 1, &quot;name&quot;: &quot;已封存&quot; &#125; ], &quot;type&quot;: &quot;string&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125;, &#123; &quot;field&quot;: [ &quot;status&quot;, &quot;send_status&quot; ], &quot;sequence&quot;: 11050, &quot;key&quot;: &quot;send_status&quot;, &quot;align&quot;: &quot;center&quot;, &quot;hide&quot;: false, &quot;label&quot;: &quot;工资条发送状态&quot;, &quot;mask&quot;: [ &#123; &quot;key&quot;: null, &quot;name&quot;: &quot;未发送&quot; &#125;, &#123; &quot;key&quot;: 0, &quot;name&quot;: &quot;未发送&quot; &#125;, &#123; &quot;key&quot;: 1, &quot;name&quot;: &quot;已发送&quot; &#125; ], &quot;width&quot;: 120, &quot;data_type&quot;: &quot;string&quot;, &quot;type&quot;: &quot;string&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: false &#125; &#125;, &#123; &quot;label&quot;: &quot;锁定状态&quot;, &quot;key&quot;: &quot;is_locked&quot;, &quot;field&quot;: [ &quot;is_locked&quot; ], &quot;data_type&quot;: &quot;string&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 120, &quot;sequence&quot;: 12000, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: null, &quot;mask&quot;: &#123; &quot;0&quot;: &quot;未锁定&quot;, &quot;1&quot;: &quot;已锁定&quot; &#125;, &quot;type&quot;: &quot;string&quot;, &quot;options&quot;: &#123; &quot;data_precision&quot;: null, &quot;description&quot;: null, &quot;hide&quot;: null &#125; &#125; ], &quot;aggr&quot;: [], &quot;statistics&quot;: [ &#123; &quot;key&quot;: &quot;01&quot;, &quot;label&quot;: &quot;年终一次性奖金&quot;, &quot;field&quot;: &quot;01&quot;, &quot;decimal&quot;: 2, &quot;type&quot;: &quot;sum&quot;, &quot;end_month&quot;: &quot;2199-12&quot; &#125;, &#123; &quot;key&quot;: &quot;02&quot;, &quot;label&quot;: &quot;年终奖税金&quot;, &quot;field&quot;: &quot;02&quot;, &quot;decimal&quot;: 2, &quot;type&quot;: &quot;sum&quot;, &quot;end_month&quot;: &quot;2199-12&quot; &#125;, &#123; &quot;key&quot;: &quot;03&quot;, &quot;label&quot;: &quot;年终奖扣款&quot;, &quot;field&quot;: &quot;03&quot;, &quot;decimal&quot;: 2, &quot;type&quot;: &quot;sum&quot;, &quot;end_month&quot;: &quot;2199-12&quot; &#125;, &#123; &quot;key&quot;: &quot;04&quot;, &quot;label&quot;: &quot;年终一次性奖金（合并计税）&quot;, &quot;field&quot;: &quot;04&quot;, &quot;decimal&quot;: 2, &quot;type&quot;: &quot;sum&quot;, &quot;end_month&quot;: &quot;2199-12&quot; &#125;, &#123; &quot;key&quot;: &quot;salary_count&quot;, &quot;label&quot;: &quot;应发合计&quot;, &quot;field&quot;: &quot;salary_count&quot;, &quot;decimal&quot;: 2, &quot;type&quot;: &quot;sum&quot;, &quot;origin&quot;: &quot;balance&quot; &#125;, &#123; &quot;key&quot;: &quot;salary_cost&quot;, &quot;label&quot;: &quot;成本合计&quot;, &quot;field&quot;: &quot;salary_cost&quot;, &quot;decimal&quot;: 2, &quot;type&quot;: &quot;sum&quot;, &quot;origin&quot;: &quot;balance&quot; &#125;, &#123; &quot;key&quot;: &quot;salary_tax&quot;, &quot;label&quot;: &quot;本次扣税&quot;, &quot;field&quot;: &quot;salary_tax&quot;, &quot;decimal&quot;: 2, &quot;type&quot;: &quot;sum&quot;, &quot;origin&quot;: &quot;balance&quot; &#125;, &#123; &quot;key&quot;: &quot;salary_real&quot;, &quot;label&quot;: &quot;实发合计&quot;, &quot;field&quot;: &quot;salary_real&quot;, &quot;type&quot;: &quot;sum&quot;, &quot;decimal&quot;: 2, &quot;origin&quot;: &quot;balance&quot; &#125; ], &quot;actions&quot;: [ &#123; &quot;key&quot;: &quot;flex_field&quot;, &quot;label&quot;: &quot;弹性字段&quot;, &quot;action&quot;: &quot;FLEX_FIELD&quot;, &quot;left&quot;: true, &quot;target&quot;: [ &quot;pc&quot; ], &quot;data&quot;: &quot;salary_calculate_data.+21636+109&quot; &#125;, &#123; &quot;key&quot;: &quot;setup&quot;, &quot;label&quot;: &quot;元数据配置&quot;, &quot;action&quot;: &quot;SETUP&quot;, &quot;left&quot;: true, &quot;target&quot;: [ &quot;pc&quot; ], &quot;data&quot;: &quot;salary_calculate_data.+21636+109.meta.list.salary_calculate.json&quot; &#125;, &#123; &quot;action&quot;: &quot;DYNAMIC_INFO&quot;, &quot;key&quot;: &quot;viewTax&quot;, &quot;label&quot;: &quot;个税维护&quot;, &quot;hide&quot;: true, &quot;sequence&quot;: 1, &quot;params&quot;: &quot;=function(item,params)&#123;var flag = true;if((item.status&amp;&amp;item.status.is_sealed===1) || (item.inst &amp;&amp; (item.inst.approve_state===1 || item.inst.approve_state===2 || item.inst.approve_state===5)))&#123;flag = false;&#125; var t = flag &amp;&amp; item.is_calc_tax === false &amp;&amp; item.is_locked !== 1; if(item.balance.id!==undefined)&#123;return&#123;&#x27;model&#x27;:&#x27;SalaryDataBalance&#x27;,&#x27;state&#x27;: &#x27;tax&#x27;, &#x27;data&#x27;:item.balance, &#x27;mode&#x27;:&#x27;edit&#x27;, &#x27;meta_params&#x27;:&#123;&#x27;edit_flag&#x27;:t&#125;&#125;&#125;else&#123;return&#123;&#x27;model&#x27;:&#x27;SalaryDataBalance&#x27;,&#x27;state&#x27;:&#x27;tax&#x27;,&#x27;data&#x27;:&#123;&#x27;program_id&#x27;:SCOPE.advance_query.query_model.data.program_id,&#x27;month&#x27;:SCOPE.advance_query.query_model.data.month,&#x27;employee_id&#x27;:item.employee_id, &#x27;is_locked&#x27;:0&#125;,&#x27;mode&#x27;:&#x27;new&#x27;, &#x27;meta_params&#x27;:&#123;&#x27;edit_flag&#x27;:t&#125;&#125;&#125;&#125;&quot; &#125;, &#123; &quot;key&quot;: &quot;history_data_compare&quot;, &quot;meta_disabled&quot;: false, &quot;hide&quot;: &quot;=function()&#123;if(SCOPE.auth.company_setting[&#x27;disable_future_salary_calculate&#x27;])&#123;if(STATE.params.flag_state==&#x27;provide_work_plat&#x27; || (STATE.params.custom_params &amp;&amp; JSON.parse(STATE.params.custom_params).flag_state === &#x27;provide_work_plat&#x27;))&#123;if(STATE.params.provide_type == 1 || (STATE.params.custom_params &amp;&amp; JSON.parse(STATE.params.custom_params).provide_type === 1))&#123;return false;&#125;else&#123;return true;&#125;&#125;else&#123;return false;&#125;&#125;else&#123;return true;&#125;&#125;&quot;, &quot;label&quot;: &quot;历史数据比对&quot;, &quot;is_important&quot;: true, &quot;sequence&quot;: 1, &quot;actions&quot;: [ &#123; &quot;key&quot;: &quot;compare_item_setting&quot;, &quot;label&quot;: &quot;比对项目设置&quot;, &quot;action&quot;: &quot;COMMON_LIST_DIALOG&quot;, &quot;options&quot;: &#123; &quot;component&quot;: &quot;hc-category-list-selector&quot;, &quot;model&quot;: &quot;SalaryDataCompareItem&quot;, &quot;title&quot;: &quot;比对项目设置&quot;, &quot;state&quot;: &quot;salary_calculate_column&quot;, &quot;selectorType&quot;: 2, &quot;size&quot;: &quot;max&quot;, &quot;filter_dict&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;program_id&#x27;])]&quot;, &quot;program_provide_id&quot;: &quot;expression[GET(ENV(), [&#x27;source_provide_id&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;build&quot;, &quot;label&quot;: &quot;生成比对结果&quot;, &quot;hide&quot;: false, &quot;action&quot;: [ &#123; &quot;action&quot;: &quot;SIMPLE_FORM&quot;, &quot;key&quot;: &quot;simple_form&quot;, &quot;options&quot;: &#123; &quot;title&quot;: &quot;比对设置&quot;, &quot;meta&quot;: [ &#123; &quot;component&quot;: &quot;hc-input-datetime&quot;, &quot;label&quot;: &quot;当前月份&quot;, &quot;key&quot;: &quot;current_month&quot;, &quot;sequence&quot;: 1, &quot;options&quot;: &#123; &quot;default&quot;: &quot;expression[GET(FILTER_DICT(),[&#x27;month&#x27;])]&quot;, &quot;required&quot;: true, &quot;format&quot;: &quot;yyyy-MM&quot;, &quot;readOnly&quot;: true, &quot;singleLine&quot;: true &#125; &#125;, &#123; &quot;component&quot;: &quot;hc-input-datetime&quot;, &quot;label&quot;: &quot;历史月份&quot;, &quot;key&quot;: &quot;history_month&quot;, &quot;sequence&quot;: 1, &quot;options&quot;: &#123; &quot;required&quot;: true, &quot;default&quot;: &quot;=function()&#123;var history_month = &#x27;&#x27;;var month = SCOPE.advance_query.query_model.data.month.slice(5);var y =SCOPE.advance_query.query_model.data.month.slice(0,4); if(parseInt(month) == 1)&#123;history_month = &#x27;12&#x27;,y = (parseInt(y) -1).toString()&#125;else&#123;if(parseInt(month) &gt; 10)&#123;history_month = (parseInt(month) - 1).toString()&#125;else&#123;history_month = &#x27;0&#x27; + (parseInt(month)-1).toString()&#125;&#125;;return y.toString() + &#x27;-&#x27; + history_month.toString();&#125;&quot;, &quot;change&quot;: &quot;=function(_scope,_model)&#123;var history_year =parseInt(_model.slice(0,4));var history_month =parseInt(_model.slice(5));var month = parseInt(SCOPE.advance_query.query_model.data.month.slice(5));var y =parseInt(SCOPE.advance_query.query_model.data.month.slice(0,4));if(history_year &gt; y)&#123;SCOPE.show_warning(&#x27;请选择当前发薪月份之前的月份！&#x27;);_scope.model = SCOPE.advance_query.filter_dict.history_month&#125;else&#123;if(history_year == y)&#123;if(history_month &gt;= month)&#123;SCOPE.show_warning(&#x27;请选择当前发薪月份之前的月份！&#x27;);_scope.model = undefined&#125;&#125;&#125;&#125;&quot;, &quot;format&quot;: &quot;yyyy-MM&quot;, &quot;readOnly&quot;: false, &quot;singleLine&quot;: true &#125; &#125;, &#123; &quot;component&quot;: &quot;hc-select&quot;, &quot;label&quot;: &quot;比对类型&quot;, &quot;key&quot;: &quot;compare_type&quot;, &quot;sequence&quot;: 2, &quot;options&quot;: &#123; &quot;required&quot;: false, &quot;readOnly&quot;: false, &quot;singleLine&quot;: true, &quot;hide&quot;: true, &quot;list&quot;: [ &#123; &quot;label&quot;: &quot;新增&quot;, &quot;value&quot;: 1 &#125;, &#123; &quot;label&quot;: &quot;减少&quot;, &quot;value&quot;: 2 &#125;, &#123; &quot;label&quot;: &quot;变动&quot;, &quot;value&quot;: 3 &#125; ] &#125; &#125; ], &quot;form_options&quot;: &#123; &quot;size&quot;: &quot;small&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;build_data&quot;, &quot;action&quot;: &quot;WEBSOCKET_ACTION&quot;, &quot;entry_condition&quot;: &quot;expression[RES(&#x27;simple_form&#x27;)]&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.history.compare.data.build.notify&quot;, &quot;begin_tip&quot;: &quot;准备开始生成比对数据...&quot;, &quot;params&quot;: &#123; &quot;filter_dict&quot;: &quot;expression[FILTER_DICT()]&quot;, &quot;filter_str&quot;: &quot;expression[GET(ENV(), [&#x27;filter_str&#x27;])]&quot;, &quot;extra_property&quot;: &quot;expression[GET(ENV(), [&#x27;extra_property&#x27;])]&quot;, &quot;employee_ids&quot;: &quot;expression[IF(GET(SELECT_ITEMS(), [0]),LIST_GET(SELECT_ITEMS(), &#x27;employee_id&#x27;), null)]&quot;, &quot;history_month&quot;: &quot;expression[GET(RES(&#x27;simple_form&#x27;),[&#x27;history_month&#x27;])]&quot;, &quot;compare_type&quot;: &quot;expression[GET(RES(&#x27;simple_form&#x27;),[&#x27;compare_type&#x27;])]&quot; &#125; &#125; &#125; ] &#125;, &#123; &quot;key&quot;: &quot;view_compare_result&quot;, &quot;label&quot;: &quot;比对结果查看&quot;, &quot;action&quot;: [ &#123; &quot;action&quot;: &quot;SIMPLE_FORM&quot;, &quot;key&quot;: &quot;simple_form&quot;, &quot;options&quot;: &#123; &quot;title&quot;: &quot;比对设置&quot;, &quot;meta&quot;: [ &#123; &quot;component&quot;: &quot;hc-input-datetime&quot;, &quot;label&quot;: &quot;当前月份&quot;, &quot;key&quot;: &quot;current_month&quot;, &quot;sequence&quot;: 1, &quot;options&quot;: &#123; &quot;default&quot;: &quot;expression[GET(FILTER_DICT(),[&#x27;month&#x27;])]&quot;, &quot;required&quot;: true, &quot;format&quot;: &quot;yyyy-MM&quot;, &quot;readOnly&quot;: true, &quot;singleLine&quot;: true &#125; &#125;, &#123; &quot;component&quot;: &quot;hc-input-datetime&quot;, &quot;label&quot;: &quot;历史月份&quot;, &quot;key&quot;: &quot;history_month&quot;, &quot;sequence&quot;: 1, &quot;options&quot;: &#123; &quot;required&quot;: true, &quot;default&quot;: &quot;=function()&#123;var history_month = &#x27;&#x27;;var month = SCOPE.advance_query.query_model.data.month.slice(5);var y =SCOPE.advance_query.query_model.data.month.slice(0,4); if(parseInt(month) == 1)&#123;history_month = &#x27;12&#x27;,y = (parseInt(y) -1).toString()&#125;else&#123;if(parseInt(month) &gt; 10)&#123;history_month = (parseInt(month) - 1).toString()&#125;else&#123;history_month = &#x27;0&#x27; + (parseInt(month)-1).toString()&#125;&#125;;return y.toString() + &#x27;-&#x27; + history_month.toString();&#125;&quot;, &quot;change&quot;: &quot;=function(_scope,_model)&#123;var history_year =parseInt(_model.slice(0,4));var history_month =parseInt(_model.slice(5));var month = parseInt(SCOPE.advance_query.query_model.data.month.slice(5));var y =parseInt(SCOPE.advance_query.query_model.data.month.slice(0,4));if(history_year &gt; y)&#123;SCOPE.show_warning(&#x27;请选择当前发薪月份之前的月份！&#x27;);_scope.model = SCOPE.advance_query.filter_dict.history_month&#125;else&#123;if(history_year == y)&#123;if(history_month &gt;= month)&#123;SCOPE.show_warning(&#x27;请选择当前发薪月份之前的月份！&#x27;);_scope.model = undefined&#125;&#125;&#125;&#125;&quot;, &quot;format&quot;: &quot;yyyy-MM&quot;, &quot;readOnly&quot;: false, &quot;singleLine&quot;: true &#125; &#125;, &#123; &quot;component&quot;: &quot;hc-select&quot;, &quot;label&quot;: &quot;比对类型&quot;, &quot;key&quot;: &quot;compare_type&quot;, &quot;sequence&quot;: 2, &quot;options&quot;: &#123; &quot;required&quot;: true, &quot;readOnly&quot;: false, &quot;singleLine&quot;: true, &quot;hide&quot;: false, &quot;default&quot;: 3, &quot;list&quot;: [ &#123; &quot;label&quot;: &quot;新增&quot;, &quot;value&quot;: 1 &#125;, &#123; &quot;label&quot;: &quot;减少&quot;, &quot;value&quot;: 2 &#125;, &#123; &quot;label&quot;: &quot;变动&quot;, &quot;value&quot;: 3 &#125; ] &#125; &#125; ], &quot;form_options&quot;: &#123; &quot;size&quot;: &quot;small&quot;, &quot;tip&quot;: &quot;请注意，需要先操作生成比对结果按钮，待结果生成完成后再查看&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;open_list&quot;, &quot;action&quot;: &quot;COMMON_LIST_DIALOG&quot;, &quot;entry_condition&quot;: &quot;expression[RES(&#x27;simple_form&#x27;)]&quot;, &quot;options&quot;: &#123; &quot;component&quot;: &quot;hc-category-list-selector&quot;, &quot;model&quot;: &quot;expression[&#x27;salary_history_compare.+&#x27; + GET(FILTER_DICT(), [&#x27;program_id&#x27;])+ IF(GET(ENV(), [&#x27;source_provide_id&#x27;]), &#x27;+&#x27;+GET(ENV(), [&#x27;source_provide_id&#x27;]), &#x27;&#x27;)]&quot;, &quot;title&quot;: &quot;薪酬历史数据比对列表&quot;, &quot;state&quot;: &quot;expression[IF(GET(RES(&#x27;simple_form&#x27;),[&#x27;compare_type&#x27;]) == 3,&#x27;result_compare&#x27;, IF(GET(RES(&#x27;simple_form&#x27;),[&#x27;compare_type&#x27;]) == 1,&#x27;result_add&#x27;,&#x27;result_reduce&#x27;))]&quot;, &quot;selectorType&quot;: 2, &quot;size&quot;: &quot;super-max&quot;, &quot;filter_dict&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;program_id&#x27;])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;compare_type&quot;: &quot;expression[GET(RES(&#x27;simple_form&#x27;),[&#x27;compare_type&#x27;])]&quot;, &quot;pay_program_id&quot;: &quot;expression[IF(GET(ENV(), [&#x27;multiple_calc&#x27;]),GET(FILTER_DICT(), [&#x27;pay_program_id&#x27;]), null)]&quot;, &quot;history_month&quot;: &quot;expression[GET(RES(&#x27;simple_form&#x27;),[&#x27;history_month&#x27;])]&quot;, &quot;employee_ids&quot;: &quot;expression[IF(GET(SELECT_ITEMS(), [0]),LIST_GET(SELECT_ITEMS(), &#x27;employee_id&#x27;), null)]&quot;, &quot;source_provide_id&quot;: &quot;expression[GET(ENV(), [&#x27;source_provide_id&#x27;])]&quot; &#125; &#125; &#125; ] &#125; ] &#125;, &#123; &quot;key&quot;: &quot;print&quot;, &quot;label&quot;: &quot;打印&quot;, &quot;action&quot;: &quot;PRINT&quot;, &quot;left&quot;: true, &quot;hide&quot;: true, &quot;condition&quot;: &quot;ITEM&quot; &#125;, &#123; &quot;label&quot;: &quot;业务仓库&quot;, &quot;key&quot;: &quot;bizStore&quot;, &quot;left&quot;: true, &quot;action&quot;: &quot;BIZ_STORE&quot;, &quot;hide&quot;: true, &quot;params&quot;: &#123; &quot;add_info&quot;: null &#125; &#125;, &#123; &quot;key&quot;: &quot;add_delete_person&quot;, &quot;label&quot;: &quot;增减人员&quot;, &quot;is_important&quot;: true, &quot;action&quot;: &quot;C_ACTION&quot;, &quot;hide&quot;: &quot;=function()&#123;if(STATE.params.flag_state==&#x27;provide_work_plat&#x27; || (STATE.params.custom_params &amp;&amp; JSON.parse(STATE.params.custom_params).flag_state==&#x27;provide_work_plat&#x27;))&#123;if(SCOPE.hcm_navigation_items)&#123;SCOPE;let current_key=JSON.parse(STATE.params.custom_params).key; if(SCOPE.hcm_navigation_items.filter(v=&gt;v.key == current_key)[0].status == &#x27;finish&#x27;)&#123;return true;&#125;else&#123;if(SCOPE.hcm_navigation_items[SCOPE.hcm_navigation_items.findIndex(v=&gt;v.key==current_key)-1].status == &#x27;finish&#x27;)&#123;return false;&#125;else&#123;return true;&#125;&#125;&#125;else&#123;return false;&#125;&#125;else&#123;return true&#125;&#125;&quot;, &quot;actions&quot;: [ &#123; &quot;key&quot;: &quot;addPerson&quot;, &quot;label&quot;: &quot;新增人员&quot;, &quot;is_important&quot;: true, &quot;action&quot;: &quot;SHOW_SELECTOR_DIALOG&quot;, &quot;options&quot;: &#123; &quot;component&quot;: &quot;hc-tree-list-selector&quot;, &quot;component_options&quot;: &#123; &quot;selectorModel&quot;: &quot;SalaryProfile&quot;, &quot;state&quot;: &quot;normal_multi_provide&quot;, &quot;selectorType&quot;: 2, &quot;filter_dict&quot;: &quot;=function()&#123;return &#123;&#x27;program_id&#x27;:SCOPE.advance_query.query_model.data.program_id, &#x27;provide_id&#x27;:SCOPE.advance_query.query_model.data.provide_id, &#x27;month&#x27;:SCOPE.advance_query.query_model.data.month&#125;&#125;&quot; &#125;, &quot;process_result_api&quot;: &quot;salary.provide.add.person&quot;, &quot;process_result_params&quot;: &quot;=function(item, params, data)&#123;return &#123;&#x27;filter_dict&#x27;: SCOPE.advance_query.query_model.data, &#x27;employee_ids&#x27;:data.map(i =&gt; i.employee_id) &#125;&#125;&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;deleteEmployee&quot;, &quot;label&quot;: &quot;删除人员&quot;, &quot;confirm&quot;: true, &quot;is_important&quot;: true, &quot;confirm_tip&quot;: &quot;=function()&#123;if(SCOPE.list_model.selected_items.length ===0)&#123;return &#x27;当前未选择人员，本操作将会删除权限范围内所有人员，确认执行删除操作?&#x27;&#125;else&#123;return &#x27;本操作会删除所选人员, 确认执行删除操作?&#x27;&#125;&#125;&quot;, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;websocket_export&quot;, &quot;action&quot;: &quot;WEBSOCKET_ACTION&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.provide.delete.person&quot;, &quot;begin_tip&quot;: &quot;准备刪除人员...&quot;, &quot;params&quot;: &#123; &quot;filter_dict&quot;: &quot;expression[FILTER_DICT()]&quot;, &quot;extra_property&quot;: &quot;expression[GET(ENV(), [&#x27;extra_property&#x27;])]&quot;, &quot;employee_ids&quot;: &quot;expression[SELECT_ITEMS().map((item)=&gt;&#123;return item.employee_id&#125;)]&quot; &#125; &#125; &#125; ] &#125; ] &#125;, &#123; &quot;key&quot;: &quot;salary_calc_count&quot;, &quot;label&quot;: &quot;应发计算&quot;, &quot;hide&quot;: &quot;=SCOPE.auth.company_setting[&#x27;disable_future_salary_calculate&#x27;]&quot;, &quot;is_important&quot;: true, &quot;actions&quot;: [ &#123; &quot;key&quot;: &quot;salary_real_time_calc_count&quot;, &quot;label&quot;: &quot;应发实时计算&quot;, &quot;hide&quot;: &quot;=function()&#123; return SCOPE.list_model.selected_items.length &lt; 1&#125;&quot;, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;get_provide&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;entry_condition&quot;: &quot;expression[GET(FILTER_DICT(),[&#x27;provide_id&#x27;])]&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;hcm.model.get&quot;, &quot;params&quot;: &#123; &quot;model&quot;: &quot;SalaryProvide&quot;, &quot;id_&quot;: &quot;expression[GET(FILTER_DICT(),[&#x27;provide_id&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;get_rules&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;entry_condition&quot;: &quot;expression[GET(RES(&#x27;get_provide&#x27;), [&#x27;rule_id&#x27;])]&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;hcm.model.get&quot;, &quot;params&quot;: &#123; &quot;model&quot;: &quot;SalaryCalculationRules&quot;, &quot;id_&quot;: &quot;expression[GET(RES(&#x27;get_provide&#x27;),[&#x27;rule_id&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;open_list&quot;, &quot;action&quot;: &quot;COMMON_LIST_DIALOG&quot;, &quot;entry_condition&quot;: &quot;expression[AND(GET(RES(&#x27;get_provide&#x27;),[&#x27;rule_id&#x27;]), GET(RES(&#x27;get_rules&#x27;), [&#x27;formula_info&#x27;]))]&quot;, &quot;options&quot;: &#123; &quot;component&quot;: &quot;hc-category-list-selector&quot;, &quot;model&quot;: &quot;SalaryProgramFormula&quot;, &quot;state&quot;: &quot;expression[IF(GET(ENV(), [&#x27;multiple_calc&#x27;]), &#x27;multi&#x27;, &#x27;normal_two&#x27;)]&quot;, &quot;page_size&quot;: 200, &quot;title&quot;: &quot;薪酬公式&quot;, &quot;tip&quot;: &quot;&lt;span class=&#x27;icon-hcm-attention&#x27; style=\\&quot;color: red;\\&quot;&gt;&lt;span style=\\&quot;padding-left: 4px;\\&quot;&gt;请选择需要计算的公式，若不选择，则计算全部公式；&lt;/br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp请确保数据未锁定且未封存，否则无法参与计算；&lt;/br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp应发计算会清除实发合计数据，计算完成后请务必锁定数据重新进行实发计算；&lt;/span&gt;&lt;/span&gt;&quot;, &quot;selectorType&quot;: 2, &quot;filter_dict&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(ENV(), [&#x27;program_id&#x27;])]&quot;, &quot;provide_id&quot;: &quot;expression[GET(ENV(), [&#x27;provide_id&#x27;])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;pay_program_id&quot;: &quot;expression[IF(GET(ENV(), [&#x27;multiple_calc&#x27;]),GET(FILTER_DICT(), [&#x27;pay_program_id&#x27;]), null)]&quot;, &quot;id&quot;: &quot;expression[GET(RES(&#x27;get_rules&#x27;),[&#x27;formula_info&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;open_list1&quot;, &quot;action&quot;: &quot;COMMON_LIST_DIALOG&quot;, &quot;entry_condition&quot;: &quot;expression[!AND(GET(RES(&#x27;get_provide&#x27;),[&#x27;rule_id&#x27;]), GET(RES(&#x27;get_rules&#x27;), [&#x27;formula_info&#x27;]))]&quot;, &quot;options&quot;: &#123; &quot;component&quot;: &quot;hc-category-list-selector&quot;, &quot;model&quot;: &quot;SalaryProgramFormula&quot;, &quot;state&quot;: &quot;expression[IF(GET(ENV(), [&#x27;multiple_calc&#x27;]), &#x27;multi&#x27;, &#x27;normal_two&#x27;)]&quot;, &quot;page_size&quot;: 200, &quot;title&quot;: &quot;薪酬公式&quot;, &quot;tip&quot;: &quot;&lt;span class=&#x27;icon-hcm-attention&#x27; style=\\&quot;color: red;\\&quot;&gt;&lt;span style=\\&quot;padding-left: 4px;\\&quot;&gt;请选择需要计算的公式，若不选择，则计算全部公式；&lt;/br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp请确保数据未锁定且未封存，否则无法参与计算；&lt;/br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp应发计算会清除实发合计数据，计算完成后请务必锁定数据重新进行实发计算；&lt;/span&gt;&lt;/span&gt;&quot;, &quot;selectorType&quot;: 2, &quot;filter_dict&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(ENV(), [&#x27;program_id&#x27;])]&quot;, &quot;provide_id&quot;: &quot;expression[GET(ENV(), [&#x27;provide_id&#x27;])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;pay_program_id&quot;: &quot;expression[IF(GET(ENV(), [&#x27;multiple_calc&#x27;]),GET(FILTER_DICT(), [&#x27;pay_program_id&#x27;]), null)]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;can_calc&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.can.calc.employee&quot;, &quot;params&quot;: &#123; &quot;filter_dict&quot;: &quot;expression[OBJ_MERGE(FILTER_DICT(), OBJ_PICK(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;extra_property&quot;: &quot;expression[GET(ENV(), [&#x27;extra_property&#x27;])]&quot;, &quot;employee_ids&quot;: &quot;expression[IF(GET(SELECT_ITEMS(), [0]),LIST_GET(SELECT_ITEMS(), &#x27;employee_id&#x27;), null)]&quot;, &quot;calc_type&quot;: 2 &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;on_calc&quot;, &quot;validators&quot;: [ &#123; &quot;validator&quot;: &quot;expression[NEQ(GET(RES(&#x27;can_calc&#x27;), [&#x27;can_calc&#x27;]), true)]&quot;, &quot;tips&quot;: &quot;未找到可计算数据，数据已锁定或已封存!&quot; &#125; ], &quot;action&quot;: &quot;WEBSOCKET_ACTION&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.calc.count&quot;, &quot;begin_tip&quot;: &quot;准备开始薪酬计算...&quot;, &quot;params&quot;: &#123; &quot;filter_dict&quot;: &quot;expression[OBJ_MERGE(FILTER_DICT(), OBJ_PICK(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;extra_property&quot;: &quot;expression[GET(ENV(), [&#x27;extra_property&#x27;])]&quot;, &quot;employee_ids&quot;: &quot;expression[IF(GET(SELECT_ITEMS(), [0]),LIST_GET(SELECT_ITEMS(), &#x27;employee_id&#x27;), null)]&quot;, &quot;formula_ids&quot;: &quot;expression[IF(GET(RES(&#x27;open_list&#x27;), [0]),LIST_GET(RES(&#x27;open_list&#x27;), &#x27;id&#x27;), IF(GET(RES(&#x27;open_list1&#x27;), [0]),LIST_GET(RES(&#x27;open_list1&#x27;), &#x27;id&#x27;), null))]&quot; &#125; &#125; &#125; ] &#125;, &#123; &quot;key&quot;: &quot;salary_background_calc_count&quot;, &quot;label&quot;: &quot;应发后台计算&quot;, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;get_provide&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;entry_condition&quot;: &quot;expression[GET(FILTER_DICT(),[&#x27;provide_id&#x27;])]&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;hcm.model.get&quot;, &quot;params&quot;: &#123; &quot;model&quot;: &quot;SalaryProvide&quot;, &quot;id_&quot;: &quot;expression[GET(FILTER_DICT(),[&#x27;provide_id&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;get_rules&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;entry_condition&quot;: &quot;expression[GET(RES(&#x27;get_provide&#x27;), [&#x27;rule_id&#x27;])]&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;hcm.model.get&quot;, &quot;params&quot;: &#123; &quot;model&quot;: &quot;SalaryCalculationRules&quot;, &quot;id_&quot;: &quot;expression[GET(RES(&#x27;get_provide&#x27;),[&#x27;rule_id&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;open_list&quot;, &quot;action&quot;: &quot;COMMON_LIST_DIALOG&quot;, &quot;entry_condition&quot;: &quot;expression[AND(GET(RES(&#x27;get_provide&#x27;),[&#x27;rule_id&#x27;]), GET(RES(&#x27;get_rules&#x27;), [&#x27;formula_info&#x27;]))]&quot;, &quot;options&quot;: &#123; &quot;component&quot;: &quot;hc-category-list-selector&quot;, &quot;model&quot;: &quot;SalaryProgramFormula&quot;, &quot;state&quot;: &quot;expression[IF(GET(ENV(), [&#x27;multiple_calc&#x27;]), &#x27;multi&#x27;, &#x27;normal_two&#x27;)]&quot;, &quot;page_size&quot;: 200, &quot;title&quot;: &quot;薪酬公式&quot;, &quot;tip&quot;: &quot;&lt;span class=&#x27;icon-hcm-attention&#x27; style=\\&quot;color: red;\\&quot;&gt;&lt;span style=\\&quot;padding-left: 4px;\\&quot;&gt;请选择需要计算的公式，若不选择，则计算全部公式；&lt;/br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp请确保数据未锁定且未封存，否则无法参与计算；&lt;/br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp应发计算会清除实发合计数据，计算完成后请务必锁定数据重新进行实发计算；&lt;/span&gt;&lt;/span&gt;&quot;, &quot;selectorType&quot;: 2, &quot;filter_dict&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(ENV(), [&#x27;program_id&#x27;])]&quot;, &quot;provide_id&quot;: &quot;expression[GET(ENV(), [&#x27;provide_id&#x27;])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;pay_program_id&quot;: &quot;expression[IF(GET(ENV(), [&#x27;multiple_calc&#x27;]),GET(FILTER_DICT(), [&#x27;pay_program_id&#x27;]), null)]&quot;, &quot;id&quot;: &quot;expression[GET(RES(&#x27;get_rules&#x27;),[&#x27;formula_info&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;open_list&quot;, &quot;action&quot;: &quot;COMMON_LIST_DIALOG&quot;, &quot;entry_condition&quot;: &quot;expression[!AND(GET(RES(&#x27;get_provide&#x27;),[&#x27;rule_id&#x27;]), GET(RES(&#x27;get_rules&#x27;), [&#x27;formula_info&#x27;]))]&quot;, &quot;options&quot;: &#123; &quot;component&quot;: &quot;hc-category-list-selector&quot;, &quot;model&quot;: &quot;SalaryProgramFormula&quot;, &quot;state&quot;: &quot;expression[IF(GET(ENV(), [&#x27;multiple_calc&#x27;]), &#x27;multi&#x27;, &#x27;normal_two&#x27;)]&quot;, &quot;page_size&quot;: 200, &quot;title&quot;: &quot;薪酬公式&quot;, &quot;tip&quot;: &quot;&lt;span class=&#x27;icon-hcm-attention&#x27; style=\\&quot;color: red;\\&quot;&gt;&lt;span style=\\&quot;padding-left: 4px;\\&quot;&gt;请选择需要计算的公式，若不选择，则计算全部公式；&lt;/br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp请确保数据未锁定且未封存，否则无法参与计算；&lt;/br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp应发计算会清除实发合计数据，计算完成后请务必锁定数据重新进行实发计算；&lt;/span&gt;&lt;/span&gt;&quot;, &quot;selectorType&quot;: 2, &quot;filter_dict&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(ENV(), [&#x27;program_id&#x27;])]&quot;, &quot;provide_id&quot;: &quot;expression[GET(ENV(), [&#x27;provide_id&#x27;])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;pay_program_id&quot;: &quot;expression[IF(GET(ENV(), [&#x27;multiple_calc&#x27;]),GET(FILTER_DICT(), [&#x27;pay_program_id&#x27;]), null)]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;can_calc&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.can.calc.employee&quot;, &quot;params&quot;: &#123; &quot;filter_dict&quot;: &quot;expression[OBJ_MERGE(FILTER_DICT(), OBJ_PICK(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;extra_property&quot;: &quot;expression[GET(ENV(), [&#x27;extra_property&#x27;])]&quot;, &quot;employee_ids&quot;: &quot;expression[IF(GET(SELECT_ITEMS(), [0]),LIST_GET(SELECT_ITEMS(), &#x27;employee_id&#x27;), null)]&quot;, &quot;calc_type&quot;: 2 &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;on_calc&quot;, &quot;validators&quot;: [ &#123; &quot;validator&quot;: &quot;expression[NEQ(GET(RES(&#x27;can_calc&#x27;), [&#x27;can_calc&#x27;]), true)]&quot;, &quot;tips&quot;: &quot;未找到可计算数据，数据已锁定或已封存!&quot; &#125; ], &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.calc.background.count&quot;, &quot;params&quot;: &#123; &quot;filter_dict&quot;: &quot;expression[OBJ_MERGE(FILTER_DICT(), OBJ_PICK(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;extra_property&quot;: &quot;expression[GET(ENV(), [&#x27;extra_property&#x27;])]&quot;, &quot;employee_ids&quot;: &quot;expression[IF(GET(SELECT_ITEMS(), [0]),LIST_GET(SELECT_ITEMS(), &#x27;employee_id&#x27;), null)]&quot;, &quot;formula_ids&quot;: &quot;expression[IF(GET(RES(&#x27;open_list&#x27;), [0]),LIST_GET(RES(&#x27;open_list&#x27;), &#x27;id&#x27;), null)]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;confirm_background&quot;, &quot;action&quot;: &quot;CONFIRM&quot;, &quot;options&quot;: &#123; &quot;content&quot;: &quot;后台任务添加成功，是否开始监控任务状况&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;go_state&quot;, &quot;action&quot;: &quot;GO_STATE&quot;, &quot;options&quot;: &#123; &quot;state&quot;: &quot;common_model_list&quot;, &quot;params&quot;: &#123; &quot;model&quot;: &quot;BackgroundTaskInstance&quot;, &quot;advance_filter_dict&quot;: &#123; &quot;group_id&quot;: &quot;expression[GET(RES(&#x27;on_calc&#x27;), [&#x27;group_id&#x27;])]&quot; &#125; &#125; &#125; &#125; ] &#125;, &#123; &quot;key&quot;: &quot;background_lock_delete_count&quot;, &quot;label&quot;: &quot;清理后台计算缓存&quot;, &quot;hide&quot;: true, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;delete_lock&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.calc.background.delete.lock.default&quot;, &quot;params&quot;: &#123;&#125; &#125; &#125; ] &#125; ] &#125;, &#123; &quot;key&quot;: &quot;salary_calc_count_notify&quot;, &quot;label&quot;: &quot;应发计算&quot;, &quot;is_important&quot;: true, &quot;hide&quot;: &quot;=function()&#123;if(SCOPE.auth.company_setting[&#x27;disable_future_salary_calculate&#x27;])&#123;if(SCOPE.hcm_navigation_items)&#123;SCOPE;let current_key=JSON.parse(STATE.params.custom_params).key; if(SCOPE.hcm_navigation_items.filter(v=&gt;v.key == current_key)[0].status == &#x27;finish&#x27;)&#123;return true;&#125;else&#123;if(SCOPE.hcm_navigation_items[SCOPE.hcm_navigation_items.findIndex(v=&gt;v.key==current_key)-1].status == &#x27;finish&#x27;)&#123;return false;&#125;else&#123;return true;&#125;&#125;&#125;else&#123;return true;&#125;&#125;else&#123;return true;&#125;&#125;&quot;, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;get_provide&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;entry_condition&quot;: &quot;expression[GET(FILTER_DICT(),[&#x27;provide_id&#x27;])]&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;hcm.model.get&quot;, &quot;params&quot;: &#123; &quot;model&quot;: &quot;SalaryProvide&quot;, &quot;id_&quot;: &quot;expression[GET(FILTER_DICT(),[&#x27;provide_id&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;get_rules&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;entry_condition&quot;: &quot;expression[GET(RES(&#x27;get_provide&#x27;), [&#x27;rule_id&#x27;])]&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;hcm.model.get&quot;, &quot;params&quot;: &#123; &quot;model&quot;: &quot;SalaryCalculationRules&quot;, &quot;id_&quot;: &quot;expression[GET(RES(&#x27;get_provide&#x27;),[&#x27;rule_id&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;open_list&quot;, &quot;action&quot;: &quot;COMMON_LIST_DIALOG&quot;, &quot;entry_condition&quot;: &quot;expression[AND(GET(RES(&#x27;get_provide&#x27;),[&#x27;rule_id&#x27;]), GET(RES(&#x27;get_rules&#x27;), [&#x27;formula_info&#x27;]))]&quot;, &quot;options&quot;: &#123; &quot;component&quot;: &quot;hc-category-list-selector&quot;, &quot;model&quot;: &quot;SalaryProgramFormula&quot;, &quot;state&quot;: &quot;expression[IF(GET(ENV(), [&#x27;multiple_calc&#x27;]), &#x27;multi&#x27;, &#x27;normal_two&#x27;)]&quot;, &quot;page_size&quot;: 200, &quot;title&quot;: &quot;薪酬公式&quot;, &quot;tip&quot;: &quot;&lt;span class=&#x27;icon-hcm-attention&#x27; style=\\&quot;color: red;\\&quot;&gt;&lt;span style=\\&quot;padding-left: 4px;\\&quot;&gt;请选择需要计算的公式，若不选择，则计算全部公式；&lt;/br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp请确保数据未锁定且未封存，否则无法参与计算；&lt;/br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp应发计算会清除实发合计数据，计算完成后请务必锁定数据重新进行实发计算；&lt;/span&gt;&lt;/span&gt;&quot;, &quot;selectorType&quot;: 2, &quot;filter_dict&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(ENV(), [&#x27;program_id&#x27;])]&quot;, &quot;provide_id&quot;: &quot;expression[GET(ENV(), [&#x27;provide_id&#x27;])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;pay_program_id&quot;: &quot;expression[IF(GET(ENV(), [&#x27;multiple_calc&#x27;]),GET(FILTER_DICT(), [&#x27;pay_program_id&#x27;]), null)]&quot;, &quot;id&quot;: &quot;expression[GET(RES(&#x27;get_rules&#x27;),[&#x27;formula_info&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;open_list&quot;, &quot;action&quot;: &quot;COMMON_LIST_DIALOG&quot;, &quot;entry_condition&quot;: &quot;expression[!AND(GET(RES(&#x27;get_provide&#x27;),[&#x27;rule_id&#x27;]), GET(RES(&#x27;get_rules&#x27;), [&#x27;formula_info&#x27;]))]&quot;, &quot;options&quot;: &#123; &quot;component&quot;: &quot;hc-category-list-selector&quot;, &quot;model&quot;: &quot;SalaryProgramFormula&quot;, &quot;state&quot;: &quot;expression[IF(GET(ENV(), [&#x27;multiple_calc&#x27;]), &#x27;multi&#x27;, &#x27;normal_two&#x27;)]&quot;, &quot;page_size&quot;: 200, &quot;title&quot;: &quot;薪酬公式&quot;, &quot;tip&quot;: &quot;&lt;span class=&#x27;icon-hcm-attention&#x27; style=\\&quot;color: red;\\&quot;&gt;&lt;span style=\\&quot;padding-left: 4px;\\&quot;&gt;请选择需要计算的公式，若不选择，则计算全部公式；&lt;/br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp请确保数据未锁定且未封存，否则无法参与计算；&lt;/br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp应发计算会清除实发合计数据，计算完成后请务必锁定数据重新进行实发计算；&lt;/span&gt;&lt;/span&gt;&quot;, &quot;selectorType&quot;: 2, &quot;filter_dict&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(ENV(), [&#x27;program_id&#x27;])]&quot;, &quot;provide_id&quot;: &quot;expression[GET(ENV(), [&#x27;provide_id&#x27;])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;pay_program_id&quot;: &quot;expression[IF(GET(ENV(), [&#x27;multiple_calc&#x27;]),GET(FILTER_DICT(), [&#x27;pay_program_id&#x27;]), null)]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;can_calc&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.can.calc.employee&quot;, &quot;params&quot;: &#123; &quot;filter_dict&quot;: &quot;expression[OBJ_MERGE(FILTER_DICT(), OBJ_PICK(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;extra_property&quot;: &quot;expression[GET(ENV(), [&#x27;extra_property&#x27;])]&quot;, &quot;employee_ids&quot;: &quot;expression[IF(GET(SELECT_ITEMS(), [0]),LIST_GET(SELECT_ITEMS(), &#x27;employee_id&#x27;), null)]&quot;, &quot;calc_type&quot;: 2 &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;on_calc&quot;, &quot;validators&quot;: [ &#123; &quot;validator&quot;: &quot;expression[NEQ(GET(RES(&#x27;can_calc&#x27;), [&#x27;can_calc&#x27;]), true)]&quot;, &quot;tips&quot;: &quot;未找到可计算数据，数据已锁定或已封存!&quot; &#125; ], &quot;action&quot;: &quot;WEBSOCKET_ACTION&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.calc.sync.count.notify&quot;, &quot;params&quot;: &#123; &quot;filter_dict&quot;: &quot;expression[OBJ_MERGE(FILTER_DICT(), OBJ_PICK(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;extra_property&quot;: &quot;expression[GET(ENV(), [&#x27;extra_property&#x27;])]&quot;, &quot;employee_ids&quot;: &quot;expression[IF(GET(SELECT_ITEMS(), [0]),LIST_GET(SELECT_ITEMS(), &#x27;employee_id&#x27;), null)]&quot;, &quot;formula_ids&quot;: &quot;expression[IF(GET(RES(&#x27;open_list&#x27;), [0]),LIST_GET(RES(&#x27;open_list&#x27;), &#x27;id&#x27;), null)]&quot; &#125; &#125; &#125; ] &#125;, &#123; &quot;key&quot;: &quot;salary_calc_real&quot;, &quot;label&quot;: &quot;实发计算&quot;, &quot;is_important&quot;: true, &quot;command&quot;: &quot;salaryCalcReal&quot;, &quot;hide&quot;: &quot;=function()&#123;if(SCOPE.hcm_navigation_items)&#123;SCOPE;let current_key=JSON.parse(STATE.params.custom_params).key; if(SCOPE.hcm_navigation_items.filter(v=&gt;v.key == current_key)[0].status == &#x27;finish&#x27;)&#123;return true;&#125;else&#123;if(SCOPE.hcm_navigation_items[SCOPE.hcm_navigation_items.findIndex(v=&gt;v.key==current_key)-1].status == &#x27;finish&#x27;)&#123;return false;&#125;else&#123;return true;&#125;&#125;&#125;else&#123;return false;&#125;&#125;&quot;, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;conf&quot;, &quot;action&quot;: &quot;CONFIRM&quot;, &quot;options&quot;: &#123; &quot;options&quot;: [ &#123; &quot;caption&quot;: &quot;确定&quot; &#125; ], &quot;content&quot;: &quot;实发计算需保证数据已锁定且未封存！&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;can_calc&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.can.calc.employee&quot;, &quot;params&quot;: &#123; &quot;filter_dict&quot;: &quot;expression[OBJ_MERGE(FILTER_DICT(), OBJ_PICK(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;extra_property&quot;: &quot;expression[GET(ENV(), [&#x27;extra_property&#x27;])]&quot;, &quot;employee_ids&quot;: &quot;expression[IF(GET(SELECT_ITEMS(), [0]),LIST_GET(SELECT_ITEMS(), &#x27;employee_id&#x27;), null)]&quot;, &quot;calc_type&quot;: 1 &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;on_calc&quot;, &quot;validators&quot;: [ &#123; &quot;validator&quot;: &quot;expression[NEQ(GET(RES(&#x27;can_calc&#x27;), [&#x27;can_calc&#x27;]), true)]&quot;, &quot;tips&quot;: &quot;未找到可进行实发计算的数据，数据未锁定或审批中或已封存!&quot; &#125; ], &quot;action&quot;: &quot;WEBSOCKET_ACTION&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.calc.sync.real.background&quot;, &quot;begin_tip&quot;: &quot;准备开始薪酬计算...&quot;, &quot;params&quot;: &#123; &quot;filter_dict&quot;: &quot;expression[OBJ_MERGE(FILTER_DICT(), OBJ_PICK(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;extra_property&quot;: &quot;expression[GET(ENV(), [&#x27;extra_property&#x27;])]&quot;, &quot;employee_ids&quot;: &quot;expression[IF(GET(SELECT_ITEMS(), [0]),LIST_GET(SELECT_ITEMS(), &#x27;employee_id&#x27;), null)]&quot;, &quot;formula_ids&quot;: &quot;expression[GET(RES(&#x27;open_list&#x27;), [&#x27;formula_ids&#x27;])]&quot;, &quot;sync_flag&quot;: &quot;expression[IF(GET(GET(RES(&#x27;&gt;salary_calc_real_action&#x27;), [&#x27;data&#x27;]),[&#x27;sync&#x27;]),GET(GET(RES(&#x27;&gt;salary_calc_real_action&#x27;), [&#x27;data&#x27;]),[&#x27;sync&#x27;]), false)]&quot; &#125; &#125; &#125; ], &quot;data&quot;: &#123; &quot;sync&quot;: true &#125; &#125;, &#123; &quot;key&quot;: &quot;approve_operate&quot;, &quot;label&quot;: &quot;审批方案&quot;, &quot;hide&quot;: &quot;=function()&#123;if(!SCOPE.is_approve)&#123;return true;&#125;else&#123;return false&#125;&#125;&quot;, &quot;action&quot;: &quot;C_ACTION&quot;, &quot;command&quot;: &quot;getInstance&quot;, &quot;actions&quot;: [ &#123; &quot;key&quot;: &quot;show_instance&quot;, &quot;label&quot;: &quot;审批方案列表&quot;, &quot;action&quot;: &quot;DYNAMIC_LIST&quot;, &quot;hide&quot;: &quot;=function()&#123;if(SCOPE.is_approve)&#123;if(SCOPE.hcm_navigation_items)&#123;SCOPE;let current_key=JSON.parse(STATE.params.custom_params).key; if(SCOPE.hcm_navigation_items.filter(v=&gt;v.key == current_key)[0].status == &#x27;finish&#x27;)&#123;return true;&#125;else&#123;if(SCOPE.hcm_navigation_items[SCOPE.hcm_navigation_items.findIndex(v=&gt;v.key==current_key)-1].status == &#x27;finish&#x27;)&#123;return false;&#125;else&#123;return true;&#125;&#125;&#125;else&#123;return false;&#125;&#125;else&#123;return true;&#125;&#125;&quot;, &quot;options&quot;: &#123; &quot;dialog_title&quot;: &quot;审批方案列表&quot;, &quot;is_important&quot;: true, &quot;state&quot;: &quot;salary_calculate_nocode&quot;, &quot;selector_type&quot;: 2, &quot;filter_dict&quot;: &quot;=function(item, params)&#123;filter_dict = &#123;&#125;;filter_dict[&#x27;program_id&#x27;] = SCOPE.advance_query.filter_dict.program_id;filter_dict[&#x27;pay_program_id&#x27;] = SCOPE.advance_query.filter_dict.pay_program_id;filter_dict[&#x27;provide_id&#x27;] = SCOPE.advance_query.filter_dict.provide_id || SCOPE.advance_query.query_model.data.provide_id;filter_dict[&#x27;month&#x27;] = SCOPE.advance_query.query_model.data.month;filter_dict[&#x27;total_control_warn_type&#x27;] = &#x27;0&#x27;;filter_dict[&#x27;business_id&#x27;] = SCOPE.business_id;filter_dict[&#x27;wf_id&#x27;] = SCOPE.wf_id;return filter_dict&#125;&quot;, &quot;model&quot;: &quot;SalaryProgramApprove&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;show_instance_guide&quot;, &quot;label&quot;: &quot;审批方案列表&quot;, &quot;action&quot;: &quot;DYNAMIC_LIST&quot;, &quot;hide&quot;: &quot;=function()&#123;if(SCOPE.is_approve)&#123;if(SCOPE.hcm_navigation_items)&#123;SCOPE;let current_key=JSON.parse(STATE.params.custom_params).key; if(SCOPE.hcm_navigation_items.filter(v=&gt;v.key == current_key)[0].status == &#x27;finish&#x27;)&#123;return false;&#125;else&#123;return true;&#125;&#125;else&#123;return true;&#125;&#125;else&#123;return true;&#125;&#125;&quot;, &quot;options&quot;: &#123; &quot;dialog_title&quot;: &quot;审批方案列表&quot;, &quot;is_important&quot;: true, &quot;state&quot;: &quot;salary_calculate_nocode_guide&quot;, &quot;selector_type&quot;: 2, &quot;filter_dict&quot;: &quot;=function(item, params)&#123;filter_dict = &#123;&#125;;filter_dict[&#x27;program_id&#x27;] = SCOPE.advance_query.filter_dict.program_id;filter_dict[&#x27;pay_program_id&#x27;] = SCOPE.advance_query.filter_dict.pay_program_id;filter_dict[&#x27;provide_id&#x27;] = SCOPE.advance_query.filter_dict.provide_id || SCOPE.advance_query.query_model.data.provide_id;filter_dict[&#x27;month&#x27;] = SCOPE.advance_query.query_model.data.month;filter_dict[&#x27;total_control_warn_type&#x27;] = &#x27;0&#x27;;filter_dict[&#x27;business_id&#x27;] = SCOPE.business_id;filter_dict[&#x27;wf_id&#x27;] = SCOPE.wf_id;return filter_dict&#125;&quot;, &quot;model&quot;: &quot;SalaryProgramApprove&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;create_instance&quot;, &quot;label&quot;: &quot;添加至审批方案&quot;, &quot;hide&quot;: &quot;=function()&#123;if(SCOPE.is_approve)&#123;if(SCOPE.hcm_navigation_items)&#123;SCOPE;let current_key=JSON.parse(STATE.params.custom_params).key; if(SCOPE.hcm_navigation_items.filter(v=&gt;v.key == current_key)[0].status == &#x27;finish&#x27;)&#123;return true;&#125;else&#123;if(SCOPE.hcm_navigation_items[SCOPE.hcm_navigation_items.findIndex(v=&gt;v.key==current_key)-1].status == &#x27;finish&#x27;)&#123;return false;&#125;else&#123;return true;&#125;&#125;&#125;else&#123;return false;&#125;&#125;else&#123;return true;&#125;&#125;&quot;, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;create_instance&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.program.approve.create.from.view&quot;, &quot;params&quot;: &#123; &quot;filter_dict&quot;: &quot;expression[FILTER_DICT()]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;show_warning&quot;, &quot;action&quot;: &quot;SHOW_WARNING&quot;, &quot;options&quot;: &#123; &quot;content&quot;: &quot;审批方案生成成功!&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;refresh_status&quot;, &quot;label&quot;: &quot;刷新状态&quot;, &quot;action&quot;: &quot;REFRESH&quot; &#125; ] &#125; ] &#125;, &#123; &quot;key&quot;: &quot;import_history_data&quot;, &quot;label&quot;: &quot;引入历史数据&quot;, &quot;hide&quot;: &quot;=function()&#123;if(SCOPE.auth.company_setting[&#x27;disable_future_salary_calculate&#x27;])&#123;if(SCOPE.hcm_navigation_items)&#123;SCOPE;let current_key=JSON.parse(STATE.params.custom_params).key; if(SCOPE.hcm_navigation_items.filter(v=&gt;v.key == current_key)[0].status == &#x27;finish&#x27;)&#123;return true;&#125;else&#123;if(SCOPE.hcm_navigation_items[SCOPE.hcm_navigation_items.findIndex(v=&gt;v.key==current_key)-1].status == &#x27;finish&#x27;)&#123;if(STATE.params.custom_params &amp;&amp; JSON.parse(STATE.params.custom_params).flag_state==&#x27;provide_work_plat&#x27;)&#123;if(JSON.parse(STATE.params.custom_params).provide_type === 1)&#123;return false;&#125;else&#123;return true;&#125;&#125;else&#123;return false;&#125;&#125;else&#123;return true;&#125;&#125;&#125;&#125;else&#123;if(STATE.params.flag_state===&#x27;provide_work_plat&#x27; || (STATE.params.custom_params &amp;&amp; JSON.parse(STATE.params.custom_params).flag_state === &#x27;provide_work_plat&#x27;))&#123;if(STATE.params.provide_type == 1)&#123;return false;&#125;else&#123;return true;&#125;&#125;&#125;&#125;&quot;, &quot;action&quot;: &quot;DYNAMIC_LIST&quot;, &quot;options&quot;: &#123; &quot;dialog_title&quot;: &quot;请选择要引入的薪酬项目&quot;, &quot;is_important&quot;: true, &quot;state&quot;: &quot;=STATE.params.flag_state===&#x27;provide_work_plat&#x27;? &#x27;import_history_provide&#x27;: (SCOPE.multiple_calc ? &#x27;history_multi&#x27; : &#x27;import_history&#x27;)&quot;, &quot;selector_type&quot;: 2, &quot;filter_dict&quot;: &quot;=function(item, params)&#123;filter_dict = SCOPE.getAllFilterDict();filter_dict[&#x27;history_flag&#x27;]=&#x27;history&#x27;;filter_dict[&#x27;pay_program_id&#x27;]=SCOPE.multiple_calc ? SCOPE.advance_query.query_model.data.pay_program_id : null;filter_dict[&#x27;employee_ids&#x27;]=SCOPE.list_model.selected_items.length &gt; 0 ? SCOPE.list_model.selected_items.map(i =&gt; i.employee_id) : null;return filter_dict&#125;&quot;, &quot;model&quot;: &quot;SalaryProgramItem&quot;, &quot;alter&quot;: &quot;=function(item, env)&#123;filter_str = SCOPE.getFilterStr(); SCOPE;return &#123;modelMetaExtendParams:[&#123;filter_str: filter_str&#125;]&#125;&#125;&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;batch_setting&quot;, &quot;label&quot;: &quot;批量修改&quot;, &quot;hide&quot;: &quot;=function()&#123;if(SCOPE.hcm_navigation_items)&#123;SCOPE;let current_key=JSON.parse(STATE.params.custom_params).key; if(SCOPE.hcm_navigation_items.filter(v=&gt;v.key == current_key)[0].status == &#x27;finish&#x27;)&#123;return true;&#125;else&#123;if(SCOPE.hcm_navigation_items[SCOPE.hcm_navigation_items.findIndex(v=&gt;v.key==current_key)-1].status == &#x27;finish&#x27;)&#123;return false;&#125;else&#123;return true;&#125;&#125;&#125;else&#123;return false;&#125;&#125;&quot;, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;get_program&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;hcm.model.get&quot;, &quot;params&quot;: &#123; &quot;model&quot;: &quot;SalaryProgram&quot;, &quot;id_&quot;: &quot;expression[GET(ENV(),[&#x27;program_id&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;batch_setting_info_dialog&quot;, &quot;action&quot;: &quot;COMMON_INFO_DIALOG&quot;, &quot;options&quot;: &#123; &quot;mode&quot;: &quot;new&quot;, &quot;model&quot;: &quot;SalaryDataBatchSetting&quot;, &quot;state&quot;: &quot;expression[IF(GET(RES(&#x27;get_program&#x27;), [&#x27;is_multi&#x27;]), &#x27;history_multi&#x27;, &#x27;import_history&#x27;)]&quot;, &quot;data&quot;: &#123; &quot;state&quot;: &quot;expression[IF(GET(RES(&#x27;get_program&#x27;), [&#x27;is_multi&#x27;]), &#x27;history_multi&#x27;, &#x27;import_history&#x27;)]&quot;, &quot;program_id&quot;: &quot;expression[GET(ENV(), [&#x27;program_id&#x27;])]&quot;, &quot;provide_id&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;provide_id&#x27;])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;pay_program_id&quot;: &quot;expression[IF(GET(RES(&#x27;get_program&#x27;), [&#x27;is_multi&#x27;]),GET(FILTER_DICT(), [&#x27;pay_program_id&#x27;]), null)]&quot;, &quot;employee_ids&quot;: &quot;expression[IF(GET(SELECT_ITEMS(), [0]),LIST_GET(SELECT_ITEMS(), &#x27;employee_id&#x27;), null)]&quot;, &quot;extra_property&quot;: &quot;expression[GET(ENV(), [&#x27;extra_property&#x27;])]&quot;, &quot;filter_dict&quot;: &quot;expression[OBJ_MERGE(FILTER_DICT(), OBJ_PICK(ENV(), [&#x27;program_id&#x27;]))]&quot; &#125;, &quot;filter_dict&quot;: &quot;expression[OBJ_MERGE(FILTER_DICT(), OBJ_PICK(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;extra_property&quot;: &quot;expression[GET(ENV(), [&#x27;extra_property&#x27;])]&quot;, &quot;employee_ids&quot;: &quot;expression[IF(GET(SELECT_ITEMS(), [0]),LIST_GET(SELECT_ITEMS(), &#x27;employee_id&#x27;), null)]&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;salary_employee_count&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.employee.count&quot;, &quot;params&quot;: &#123; &quot;filter_dict&quot;: &quot;expression[OBJ_MERGE(FILTER_DICT(), OBJ_PICK(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;extra_property&quot;: &quot;expression[GET(ENV(), [&#x27;extra_property&#x27;])]&quot;, &quot;employee_ids&quot;: &quot;expression[IF(GET(SELECT_ITEMS(), [0]),LIST_GET(SELECT_ITEMS(), &#x27;employee_id&#x27;), null)]&quot;, &quot;filter_str&quot;: &quot;expression[GET(ENV(), [&#x27;filter_str&#x27;])]&quot;, &quot;other_filter&quot;: true &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;show_warning&quot;, &quot;action&quot;: &quot;SHOW_WARNING&quot;, &quot;entry_condition&quot;: &quot;expression[!RES(&#x27;salary_employee_count&#x27;)]&quot;, &quot;options&quot;: &#123; &quot;content&quot;: &quot;未找到可批量修改的人员！&quot; &#125; &#125;, &#123; &quot;action&quot;: &quot;CONFIRM&quot;, &quot;key&quot;: &quot;confirm&quot;, &quot;entry_condition&quot;: &quot;expression[RES(&#x27;salary_employee_count&#x27;)]&quot;, &quot;options&quot;: &#123; &quot;content&quot;: &quot;expression[&#x27;根据当前设置可批量修改 &#x27;+RES(&#x27;salary_employee_count&#x27;)+&#x27; 人的薪酬数据，确认修改？&#x27;]&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;salary_data_batch_update&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;entry_condition&quot;: &quot;expression[RES(&#x27;salary_employee_count&#x27;)]&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.batch.update&quot;, &quot;params&quot;: &#123; &quot;filter_dict&quot;: &quot;expression[OBJ_MERGE(FILTER_DICT(), OBJ_PICK(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;extra_property&quot;: &quot;expression[GET(ENV(), [&#x27;extra_property&#x27;])]&quot;, &quot;filter_str&quot;: &quot;expression[GET(ENV(), [&#x27;filter_str&#x27;])]&quot;, &quot;employee_ids&quot;: &quot;expression[IF(GET(SELECT_ITEMS(), [0]),LIST_GET(SELECT_ITEMS(), &#x27;employee_id&#x27;), null)]&quot;, &quot;batch_setting&quot;: &quot;expression[RES(&#x27;batch_setting_info_dialog&#x27;)]&quot;, &quot;other_filter&quot;: true &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;show_warning&quot;, &quot;action&quot;: &quot;SHOW_WARNING&quot;, &quot;entry_condition&quot;: &quot;expression[RES(&#x27;salary_data_batch_update&#x27;)]&quot;, &quot;options&quot;: &#123; &quot;content&quot;: &quot;批量修改成功!&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;show_warning&quot;, &quot;action&quot;: &quot;SHOW_WARNING&quot;, &quot;entry_condition&quot;: &quot;expression[AND(NEQ(RES(&#x27;salary_data_batch_update&#x27;), true),RES(&#x27;salary_employee_count&#x27;))]&quot;, &quot;options&quot;: &#123; &quot;content&quot;: &quot;批量修改失败&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;refresh_status&quot;, &quot;label&quot;: &quot;刷新状态&quot;, &quot;action&quot;: &quot;REFRESH&quot; &#125; ] &#125;, &#123; &quot;key&quot;: &quot;set_modi&quot;, &quot;label&quot;: &quot;批量编辑&quot;, &quot;left&quot;: true, &quot;action&quot;: &quot;EDIT_DIRTY&quot;, &quot;hide&quot;: &quot;=function()&#123;if(SCOPE.hcm_navigation_items)&#123;SCOPE;let current_key=JSON.parse(STATE.params.custom_params).key; if(SCOPE.hcm_navigation_items.filter(v=&gt;v.key == current_key)[0].status == &#x27;finish&#x27;)&#123;return true;&#125;else&#123;if(SCOPE.hcm_navigation_items[SCOPE.hcm_navigation_items.findIndex(v=&gt;v.key==current_key)-1].status == &#x27;finish&#x27;)&#123;return false;&#125;else&#123;return true;&#125;&#125;&#125;else&#123;return true;&#125;&#125;&quot;, &quot;options&quot;: &#123; &quot;caption&quot;: &quot;批量编辑&quot;, &quot;actions&quot;: [ &#123; &quot;label&quot;: &quot;保存数据&quot;, &quot;func&quot;: &quot;=function(data)&#123;dataService.callHcmOpenApi(&#x27;salary.data.balance.batch.edit&#x27;, &#123;&#x27;filter_dict&#x27;: SCOPE.advance_query.filter_dict, &#x27;data&#x27;:data&#125;).then(function(_d)&#123;SCOPE.show_warning(_d.msg);SCOPE.fetchData();&#125;)&#125;&quot; &#125;, &#123; &quot;label&quot;: &quot;取消编辑&quot;, &quot;func&quot;: &quot;=function(data)&#123;console.log(data)&#125;&quot; &#125; ] &#125;, &quot;target&quot;: [ &quot;pc&quot; ], &quot;data&quot;: &quot;Employee&quot; &#125;, &#123; &quot;key&quot;: &quot;clean_up&quot;, &quot;label&quot;: &quot;清除数据&quot;, &quot;hide&quot;: &quot;=function()&#123;if(SCOPE.hcm_navigation_items)&#123;SCOPE;let current_key=JSON.parse(STATE.params.custom_params).key; if(SCOPE.hcm_navigation_items.filter(v=&gt;v.key == current_key)[0].status == &#x27;finish&#x27;)&#123;return true;&#125;else&#123;if(SCOPE.hcm_navigation_items[SCOPE.hcm_navigation_items.findIndex(v=&gt;v.key==current_key)-1].status == &#x27;finish&#x27;)&#123;return false;&#125;else&#123;return true;&#125;&#125;&#125;else&#123;return false;&#125;&#125;&quot;, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;api&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;hcm.model.get&quot;, &quot;params&quot;: &#123; &quot;model&quot;: &quot;SalaryProgram&quot;, &quot;id_&quot;: &quot;expression[GET(ENV(),[&#x27;program_id&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;open_list&quot;, &quot;action&quot;: &quot;COMMON_LIST_DIALOG&quot;, &quot;options&quot;: &#123; &quot;component&quot;: &quot;hc-category-list-selector&quot;, &quot;model&quot;: &quot;SalaryProgramItem&quot;, &quot;state&quot;: &quot;expression[IF(GET(RES(&#x27;get_program&#x27;), [&#x27;is_multi&#x27;]), &#x27;pay_item&#x27;, &#x27;clean_up&#x27;)]&quot;, &quot;page_size&quot;: 200, &quot;selectorType&quot;: 2, &quot;mode&quot;: &quot;clean&quot;, &quot;title&quot;: &quot;薪酬项目选择&quot;, &quot;filter_dict&quot;: &#123; &quot;state&quot;: &quot;expression[IF(GET(RES(&#x27;get_program&#x27;), [&#x27;is_multi&#x27;]), &#x27;pay_item&#x27;, &#x27;clean_up&#x27;)]&quot;, &quot;program_id&quot;: &quot;expression[GET(ENV(), [&#x27;program_id&#x27;])]&quot;, &quot;provide_id&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;provide_id&#x27;])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;pay_program_id&quot;: &quot;expression[IF(GET(RES(&#x27;api&#x27;), [&#x27;is_multi&#x27;]),GET(FILTER_DICT(), [&#x27;pay_program_id&#x27;]), null)]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;on_calc&quot;, &quot;action&quot;: &quot;WEBSOCKET_ACTION&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.clean.up&quot;, &quot;begin_tip&quot;: &quot;准备开始清除数据...&quot;, &quot;params&quot;: &#123; &quot;filter_dict&quot;: &quot;expression[OBJ_MERGE(FILTER_DICT(), OBJ_PICK(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;extra_property&quot;: &quot;expression[GET(ENV(), [&#x27;extra_property&#x27;])]&quot;, &quot;filter_str&quot;: &quot;expression[GET(ENV(), [&#x27;filter_str&#x27;])]&quot;, &quot;employee_ids&quot;: &quot;expression[IF(GET(SELECT_ITEMS(), [0]),LIST_GET(SELECT_ITEMS(), &#x27;employee_id&#x27;), null)]&quot;, &quot;items&quot;: &quot;expression[RES(&#x27;open_list&#x27;)]&quot;, &quot;other_filter&quot;: true &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;show_warning&quot;, &quot;action&quot;: &quot;SHOW_WARNING&quot;, &quot;entry_condition&quot;: &quot;expression[EQ(GET(RES(&#x27;on_calc&#x27;), [&#x27;duration&#x27;]), null)]&quot;, &quot;options&quot;: &#123; &quot;content&quot;: &quot;未找到可清除的数据信息，请检查薪酬数据是否启封或解锁！&quot; &#125; &#125; ] &#125;, &#123; &quot;key&quot;: &quot;lock_or_unlock&quot;, &quot;label&quot;: &quot;锁定&amp;解锁&quot;, &quot;action&quot;: &quot;C_ACTION&quot;, &quot;hide&quot;: &quot;=function()&#123;if(SCOPE.hcm_navigation_items)&#123;SCOPE;let current_key=JSON.parse(STATE.params.custom_params).key; if(SCOPE.hcm_navigation_items.filter(v=&gt;v.key == current_key)[0].status == &#x27;finish&#x27;)&#123;return true;&#125;else&#123;if(SCOPE.hcm_navigation_items[SCOPE.hcm_navigation_items.findIndex(v=&gt;v.key==current_key)-1].status == &#x27;finish&#x27;)&#123;return false;&#125;else&#123;return true;&#125;&#125;&#125;else&#123;return false;&#125;&#125;&quot;, &quot;command&quot;: &quot;lock&quot;, &quot;actions&quot;: [ &#123; &quot;key&quot;: &quot;lock_data&quot;, &quot;label&quot;: &quot;锁定&quot;, &quot;options&quot;: &#123; &quot;set_debounce&quot;: true, &quot;debounce_time&quot;: 5 &#125;, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;api&quot;, &quot;action&quot;: &quot;WEBSOCKET_ACTION&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.confirm.lock.status&quot;, &quot;begin_tip&quot;: &quot;准备开始锁定数据...&quot;, &quot;params&quot;: &#123; &quot;filter_dict&quot;: &quot;expression[OBJ_MERGE(FILTER_DICT(), OBJ_PICK(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;filter_str&quot;: &quot;expression[GET(ENV(), [&#x27;filter_str&#x27;])]&quot;, &quot;status&quot;: 1, &quot;employee_ids&quot;: &quot;expression[IF(GET(SELECT_ITEMS(), [0]),LIST_GET(SELECT_ITEMS(), &#x27;employee_id&#x27;), null)]&quot;, &quot;items&quot;: null, &quot;extra_property&quot;: &quot;expression[GET(ENV(), [&#x27;extra_property&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;show_warning&quot;, &quot;action&quot;: &quot;SHOW_WARNING&quot;, &quot;entry_condition&quot;: &quot;expression[RES(&#x27;api&#x27;)]&quot;, &quot;options&quot;: &#123; &quot;content&quot;: &quot;锁定成功！&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;refresh&quot;, &quot;entry_condition&quot;: &quot;expression[RES(&#x27;api&#x27;)]&quot;, &quot;action&quot;: &quot;REFRESH&quot; &#125; ] &#125;, &#123; &quot;key&quot;: &quot;unlock_data&quot;, &quot;label&quot;: &quot;解锁&quot;, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;api&quot;, &quot;action&quot;: &quot;WEBSOCKET_ACTION&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.confirm.lock.status&quot;, &quot;begin_tip&quot;: &quot;准备开始解锁...&quot;, &quot;params&quot;: &#123; &quot;filter_dict&quot;: &quot;expression[OBJ_MERGE(FILTER_DICT(), OBJ_PICK(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;filter_str&quot;: &quot;expression[GET(ENV(), [&#x27;filter_str&#x27;])]&quot;, &quot;status&quot;: 0, &quot;employee_ids&quot;: &quot;expression[IF(GET(SELECT_ITEMS(), [0]),LIST_GET(SELECT_ITEMS(), &#x27;employee_id&#x27;), null)]&quot;, &quot;items&quot;: null, &quot;extra_property&quot;: &quot;expression[GET(ENV(), [&#x27;extra_property&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;show_warning&quot;, &quot;action&quot;: &quot;SHOW_WARNING&quot;, &quot;entry_condition&quot;: &quot;expression[RES(&#x27;api&#x27;)]&quot;, &quot;options&quot;: &#123; &quot;content&quot;: &quot;解锁成功！&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;refresh&quot;, &quot;entry_condition&quot;: &quot;expression[RES(&#x27;api&#x27;)]&quot;, &quot;action&quot;: &quot;REFRESH&quot; &#125; ] &#125; ] &#125;, &#123; &quot;key&quot;: &quot;only_export&quot;, &quot;hide&quot;: true, &quot;action&quot;: &quot;COMMON_EXPORT&quot;, &quot;label&quot;: &quot;导出&quot;, &quot;data&quot;: &quot;=function()&#123;let intersection_hide = [];for(let i=0;i&lt;SCOPE.list_model.columns.length;i++)&#123;if(!SCOPE.list_model.columns[i].hide)&#123;intersection_hide.push(SCOPE.list_model.columns[i])&#125;&#125;SCOPE.list_model.columns=intersection_hide;if (JSON.stringify(SCOPE.advance_query.current_plan) !== &#x27;&#123;&#125;&#x27;)&#123;let intersection = []; let dispalay_list = SCOPE.advance_query.current_plan ?SCOPE.advance_query.current_plan.config.display_setting.map(v=&gt; v.key) : null;for(let i=0;i&lt;SCOPE.list_model.columns.length;i++)&#123;if(dispalay_list)&#123;if(dispalay_list.indexOf(SCOPE.list_model.columns[i].key)&gt;-1)&#123;intersection.push(SCOPE.list_model.columns[i])&#125;&#125;&#125;SCOPE.list_model.columns = intersection&#125;return &#123;&#x27;select&#x27;: true,&#x27;is_column_defs&#x27;:true,&#x27;celery_mode&#x27;:false,&#x27;file_name&#x27;:SCOPE.advance_query.query_model.field_metas.program_id.options.originObject.name + &#x27;_&#x27; + SCOPE.advance_query.query_model.data.month,&#x27;export_class&#x27;:&#x27;apps.salary.data.services.SalaryDataCRUDExportServices&#x27;,&#x27;extend_property&#x27;:&#123;&#x27;three_digit_segmentation_method&#x27;:true, &#x27;merge_columns&#x27;:SCOPE.list_model.merge_columns,&#x27;display_setting&#x27;:SCOPE.advance_query.display_setting ? SCOPE.advance_query.display_setting : null,&#x27;employee_count&#x27;:SCOPE.paging.total_count,&#x27;filter_dict&#x27;:SCOPE.getAllFilterDict(),&#x27;model&#x27;:SCOPE.advance_query.model&#125;&#125;&#125;&quot; &#125;, &#123; &quot;key&quot;: &quot;imp_or_exp&quot;, &quot;label&quot;: &quot;导入&amp;导出&quot;, &quot;hide&quot;: &quot;=function()&#123;if(JSON.parse(STATE.params.custom_params).flag_state==&#x27;work_flow&#x27;)&#123;return true;&#125;else&#123;if(SCOPE.hcm_navigation_items)&#123;SCOPE;let current_key=JSON.parse(STATE.params.custom_params).key; if(SCOPE.hcm_navigation_items.filter(v=&gt;v.key == current_key)[0].status == &#x27;finish&#x27;)&#123;return true;&#125;else&#123;if(SCOPE.hcm_navigation_items[SCOPE.hcm_navigation_items.findIndex(v=&gt;v.key==current_key)-1].status == &#x27;finish&#x27;)&#123;return false;&#125;else&#123;return true;&#125;&#125;&#125;else&#123;return false;&#125;&#125;&#125;&quot;, &quot;action&quot;: &quot;C_ACTION&quot;, &quot;command&quot;: &quot;import&quot;, &quot;actions&quot;: [ &#123; &quot;key&quot;: &quot;custom_salary_data_import&quot;, &quot;label&quot;: &quot;薪酬项目数据导入&quot;, &quot;action&quot;: &quot;C_ACTION&quot;, &quot;command&quot;: &quot;import&quot;, &quot;hide&quot;: true, &quot;data&quot;: &#123; &quot;import_content&quot;: &quot;custom&quot;, &quot;title&quot;: &quot;薪酬项目数据&quot;, &quot;import_enroll&quot;: false &#125; &#125;, &#123; &quot;key&quot;: &quot;custom_salary_data_export&quot;, &quot;label&quot;: &quot;薪酬项目数据导出&quot;, &quot;action&quot;: &quot;C_ACTION&quot;, &quot;command&quot;: &quot;export&quot;, &quot;hide&quot;: true, &quot;data&quot;: &#123; &quot;import_content&quot;: &quot;custom&quot;, &quot;title&quot;: &quot;薪酬项目数据&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;sys_salary_data_import&quot;, &quot;label&quot;: &quot;系统项数据导入&quot;, &quot;action&quot;: &quot;C_ACTION&quot;, &quot;command&quot;: &quot;import&quot;, &quot;hide&quot;: true, &quot;data&quot;: &#123; &quot;import_content&quot;: &quot;sys&quot;, &quot;title&quot;: &quot;系统项数据&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;sys_salary_data_export&quot;, &quot;label&quot;: &quot;系统项数据导出&quot;, &quot;action&quot;: &quot;C_ACTION&quot;, &quot;command&quot;: &quot;export&quot;, &quot;hide&quot;: true, &quot;data&quot;: &#123; &quot;import_content&quot;: &quot;sys&quot;, &quot;title&quot;: &quot;系统项数据&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;salary_data_import&quot;, &quot;label&quot;: &quot;导入&quot;, &quot;hide&quot;: true, &quot;action&quot;: &quot;C_ACTION&quot;, &quot;command&quot;: &quot;import&quot; &#125;, &#123; &quot;key&quot;: &quot;salary_data_export&quot;, &quot;label&quot;: &quot;导出&quot;, &quot;hide&quot;: true, &quot;action&quot;: &quot;C_ACTION&quot;, &quot;command&quot;: &quot;export&quot; &#125;, &#123; &quot;key&quot;: &quot;entry_import&quot;, &quot;label&quot;: &quot;分段覆盖导入&quot;, &quot;hide&quot;: true, &quot;action&quot;: &quot;COMMON_IMPORT&quot;, &quot;data&quot;: &quot;=function()&#123;let is_depart_number = true;let exp_state = &#x27;result_imp_template&#x27;; if(is_depart_number)&#123;exp_state = &#x27;result_imp_template_number&#x27;&#125;return&#123;&#x27;empty_selector&#x27;: false, empty_mode:0,&#x27;title&#x27;: &#x27;薪酬数据导入&#x27;,&#x27;category&#x27;:&#x27;SalaryDataEntry&#x27;,&#x27;import_class&#x27;:&#x27;apps.salary.entry.services.SalaryDataEntryCRUDImportServices&#x27;,&#x27;impMethod&#x27;: 2,&#x27;imp_tips&#x27;: [&#x27;建议每次导入间隔2分钟。&#x27;],&#x27;choose_method&#x27;: false,&#x27;show_business_key&#x27;: false,&#x27;extend_property&#x27;:&#123;&#x27;is_clear&#x27;:1,&#x27;filter_dict&#x27;:SCOPE.advance_query.filter_dict,&#x27;model&#x27;:&#x27;SalaryDataEntry&#x27;,&#x27;month&#x27;:SCOPE.advance_query.query_model.data.month,&#x27;program_id&#x27;:SCOPE.advance_query.query_model.data.program_id,&#x27;extra_property&#x27;:&#123;&#x27;state&#x27;:exp_state,&#x27;fields&#x27;:[]&#125;&#125;&#125;&#125;&quot; &#125;, &#123; &quot;key&quot;: &quot;entry_import_append&quot;, &quot;label&quot;: &quot;分段追加导入&quot;, &quot;hide&quot;: true, &quot;action&quot;: &quot;COMMON_IMPORT&quot;, &quot;data&quot;: &quot;=function()&#123;let is_depart_number = true;let exp_state = &#x27;result_imp_template&#x27;; if(is_depart_number)&#123;exp_state = &#x27;result_imp_template_number&#x27;&#125;return &#123;&#x27;empty_selector&#x27;: false, empty_mode:0,&#x27;title&#x27;: &#x27;薪酬数据导入&#x27;,&#x27;category&#x27;:&#x27;SalaryDataEntry&#x27;,&#x27;import_class&#x27;:&#x27;apps.salary.entry.services.SalaryDataEntryCRUDImportServices&#x27;,&#x27;impMethod&#x27;: 2,&#x27;imp_tips&#x27;: [&#x27;建议每次导入间隔2分钟。&#x27;],&#x27;choose_method&#x27;: false,&#x27;show_business_key&#x27;: false,&#x27;extend_property&#x27;:&#123;&#x27;is_clear&#x27;:0,&#x27;filter_dict&#x27;:SCOPE.advance_query.filter_dict,&#x27;model&#x27;:&#x27;SalaryDataEntry&#x27;,&#x27;month&#x27;:SCOPE.advance_query.query_model.data.month,&#x27;program_id&#x27;:SCOPE.advance_query.query_model.data.program_id,&#x27;extra_property&#x27;:&#123;&#x27;state&#x27;:exp_state,&#x27;fields&#x27;:[]&#125;&#125;&#125;&#125;&quot; &#125;, &#123; &quot;key&quot;: &quot;entry_export&quot;, &quot;label&quot;: &quot;薪酬明细数据导出&quot;, &quot;hide&quot;: true, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;open_list&quot;, &quot;action&quot;: &quot;COMMON_LIST_DIALOG&quot;, &quot;options&quot;: &#123; &quot;component&quot;: &quot;hc-category-list-selector&quot;, &quot;model&quot;: &quot;SalaryProgramItem&quot;, &quot;page_size&quot;: 200, &quot;selectorType&quot;: 2, &quot;mode&quot;: &quot;clean&quot;, &quot;title&quot;: &quot;薪酬项目选择&quot;, &quot;filter_dict&quot;: &#123; &quot;state&quot;: &quot;expression[IF(GET(RES(&#x27;get_program&#x27;), [&#x27;is_multi&#x27;]), &#x27;pay_item&#x27;, &#x27;clean_up&#x27;)]&quot;, &quot;program_id&quot;: &quot;expression[GET(ENV(), [&#x27;program_id&#x27;])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;pay_program_id&quot;: &quot;expression[IF(GET(RES(&#x27;api&#x27;), [&#x27;is_multi&#x27;]),GET(FILTER_DICT(), [&#x27;pay_program_id&#x27;]), null)]&quot;, &quot;data_type&quot;: 4, &quot;history_flag&quot;: &quot;history&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;websocket_export&quot;, &quot;action&quot;: &quot;WEBSOCKET_ACTION&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.entry.export&quot;, &quot;begin_tip&quot;: &quot;准备开始导出薪酬明细数据...&quot;, &quot;params&quot;: &#123; &quot;filter_dict&quot;: &quot;expression[OBJ_MERGE(FILTER_DICT(), OBJ_PICK(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;filter_str&quot;: &quot;expression[GET(ENV(), [&#x27;extra_property&#x27;, &#x27;filter_str&#x27;])]&quot;, &quot;extra_property&quot;: &quot;expression[GET(ENV(), [&#x27;extra_property&#x27;])]&quot;, &quot;employee_ids&quot;: &quot;expression[IF(GET(SELECT_ITEMS(), [0]),LIST_GET(SELECT_ITEMS(), &#x27;employee_id&#x27;), null)]&quot;, &quot;employee_count&quot;: &quot;expression[GET(ENV(), [&#x27;paging&#x27;, &#x27;_total_count&#x27;])]&quot;, &quot;program_items&quot;: &quot;expression[RES(&#x27;open_list&#x27;)]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;hyper_link&quot;, &quot;action&quot;: &quot;HYPER_LINK&quot;, &quot;entry_condition&quot;: &quot;expression[RES(&#x27;websocket_export&#x27;)]&quot;, &quot;options&quot;: &#123; &quot;url&quot;: &quot;expression[&#x27;/document/temp/download?index=&#x27;+RES(&#x27;websocket_export&#x27;)+&#x27;&amp;name=薪酬明细数据.xlsx&#x27;]&quot; &#125; &#125; ] &#125;, &#123; &quot;key&quot;: &quot;export2&quot;, &quot;hide&quot;: false, &quot;action&quot;: &quot;COMMON_EXPORT&quot;, &quot;label&quot;: &quot;导出&quot;, &quot;data&quot;: &quot;=function()&#123;let intersection_hide = [];for(let i=0;i&lt;SCOPE.list_model.columns.length;i++)&#123;if(!SCOPE.list_model.columns[i].hide)&#123;intersection_hide.push(SCOPE.list_model.columns[i])&#125;&#125;SCOPE.list_model.columns=intersection_hide;if (JSON.stringify(SCOPE.advance_query.current_plan) !== &#x27;&#123;&#125;&#x27;)&#123;let intersection = []; let dispalay_list = SCOPE.advance_query.current_plan ?SCOPE.advance_query.current_plan.config.display_setting.map(v=&gt; v.key) : null;for(let i=0;i&lt;SCOPE.list_model.columns.length;i++)&#123;if(dispalay_list)&#123;if(dispalay_list.indexOf(SCOPE.list_model.columns[i].key)&gt;-1)&#123;intersection.push(SCOPE.list_model.columns[i])&#125;&#125;&#125;SCOPE.list_model.columns = intersection&#125;return &#123;&#x27;select&#x27;: true,&#x27;is_column_defs&#x27;:true,&#x27;celery_mode&#x27;:false,&#x27;file_name&#x27;:SCOPE.program_name+ &#x27;_&#x27; + SCOPE.getAllFilterDict().month,&#x27;export_class&#x27;:&#x27;apps.salary.data.services.SalaryDataCRUDExportServices&#x27;,&#x27;extend_property&#x27;:&#123;&#x27;three_digit_segmentation_method&#x27;:true, &#x27;merge_columns&#x27;:SCOPE.list_model.merge_columns,&#x27;display_setting&#x27;:SCOPE.advance_query.display_setting ? SCOPE.advance_query.display_setting : null,&#x27;employee_count&#x27;:SCOPE.paging.total_count,&#x27;filter_dict&#x27;:SCOPE.getAllFilterDict(),&#x27;model&#x27;:SCOPE.advance_query.model&#125;&#125;&#125;&quot; &#125;, &#123; &quot;action&quot;: &quot;COMMON_IMPORT&quot;, &quot;key&quot;: &quot;salary_data_import1&quot;, &quot;label&quot;: &quot;覆盖导入&quot;, &quot;hide&quot;: &quot;=function()&#123;if(JSON.parse(STATE.params.custom_params).flag_state==&#x27;work_flow&#x27;)&#123;return true;&#125;else&#123;return false&#125;&#125;&quot;, &quot;data&quot;: &quot;=function()&#123;let filter_dict = SCOPE.advance_query.filter_dict;if(SCOPE.advance_query.filter_dict.month == undefined)&#123;filter_dict = SCOPE.advance_query.default_filter_dict&#125;return &#123;&#x27;title&#x27;: &#x27;薪酬数据导入&#x27;,&#x27;category&#x27;:SCOPE.advance_query.model,&#x27;import_class&#x27;:&#x27;apps.salary.data.services.SalaryDataImportServices&#x27;,&#x27;impMethod&#x27;: 2,&#x27;imp_tips&#x27;: [&#x27;建议每次导入间隔2分钟。&#x27;],&#x27;choose_method&#x27;: false,&#x27;show_business_key&#x27;: false,&#x27;extend_property&#x27;:&#123;&#x27;empty_selector&#x27;: false, empty_mode:0,&#x27;is_clear&#x27;:1,&#x27;filter_dict&#x27;:filter_dict,&#x27;model&#x27;:SCOPE.advance_query.model,&#x27;month&#x27;:SCOPE.advance_query.query_model.data.month,&#x27;extra_property&#x27;:&#123;&#x27;state&#x27;:&#x27;result_imp_template&#x27;,&#x27;fields&#x27;:[]&#125;,&#x27;data_plugins&#x27;: [&#123;&#x27;key&#x27;: &#x27;before_imp_data_no_file_import&#x27;,&#x27;name&#x27;: &#x27;AddSalaryProfileRecord&#x27;&#125;]&#125;&#125;&#125;&quot; &#125;, &#123; &quot;action&quot;: &quot;COMMON_IMPORT&quot;, &quot;key&quot;: &quot;salary_data_import2&quot;, &quot;label&quot;: &quot;追加导入&quot;, &quot;hide&quot;: &quot;=function()&#123;if(JSON.parse(STATE.params.custom_params).flag_state==&#x27;work_flow&#x27;)&#123;return true;&#125;else&#123;return false&#125;&#125;&quot;, &quot;data&quot;: &quot;=function()&#123;return &#123;&#x27;title&#x27;: &#x27;薪酬数据导入&#x27;,&#x27;category&#x27;:SCOPE.advance_query.model,&#x27;import_class&#x27;:&#x27;apps.salary.data.services.SalaryDataImportServices&#x27;,&#x27;impMethod&#x27;: 2,&#x27;imp_tips&#x27;: [&#x27;建议每次导入间隔2分钟。&#x27;],&#x27;choose_method&#x27;: false,&#x27;show_business_key&#x27;: false,&#x27;extend_property&#x27;:&#123;&#x27;is_clear&#x27;:0,&#x27;filter_dict&#x27;:SCOPE.advance_query.filter_dict,&#x27;model&#x27;:SCOPE.advance_query.model,&#x27;month&#x27;:SCOPE.advance_query.query_model.data.month,&#x27;extra_property&#x27;:&#123;&#x27;state&#x27;:&#x27;result_imp_template&#x27;,&#x27;fields&#x27;:[]&#125;&#125;&#125;&#125;&quot; &#125; ] &#125;, &#123; &quot;key&quot;: &quot;data_check&quot;, &quot;label&quot;: &quot;数据校验&quot;, &quot;hide&quot;: &quot;=function()&#123;if(SCOPE.hcm_navigation_items)&#123;SCOPE;let current_key=JSON.parse(STATE.params.custom_params).key; if(SCOPE.hcm_navigation_items.filter(v=&gt;v.key == current_key)[0].status == &#x27;finish&#x27;)&#123;return true;&#125;else&#123;if(SCOPE.hcm_navigation_items[SCOPE.hcm_navigation_items.findIndex(v=&gt;v.key==current_key)-1].status == &#x27;finish&#x27;)&#123;if(JSON.parse(STATE.params.custom_params).data_check_type === 1)&#123;return false;&#125;else&#123;if(current_Key===&#x27;calc_real&#x27;)&#123;return false;&#125;else&#123;return true;&#125;&#125;&#125;else&#123;return true;&#125;&#125;&#125;else&#123;return false;&#125;&#125;&quot;, &quot;action&quot;: &quot;C_ACTION&quot;, &quot;command&quot;: &quot;data_check&quot;, &quot;actions&quot;: [ &#123; &quot;key&quot;: &quot;validate_data&quot;, &quot;label&quot;: &quot;数据检查&quot;, &quot;hide&quot;: &quot;=function()&#123;if(SCOPE.data_check_type == 2)&#123;return true&#125;&#125;&quot;, &quot;command&quot;: &quot;validate_data&quot;, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;open_list&quot;, &quot;action&quot;: &quot;COMMON_LIST_DIALOG&quot;, &quot;options&quot;: &#123; &quot;component&quot;: &quot;hc-category-list-selector&quot;, &quot;model&quot;: &quot;SalaryProgramExamine&quot;, &quot;state&quot;: &quot;salary_calculate&quot;, &quot;page_size&quot;: 200, &quot;title&quot;: &quot;数据检查公式&quot;, &quot;selectorType&quot;: 2, &quot;filter_dict&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(ENV(), [&#x27;program_id&#x27;])]&quot;, &quot;provide_id&quot;: &quot;expression[GET(ENV(), [&#x27;provide_id&#x27;])]&quot;, &quot;is_used&quot;: true &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;websocket_export&quot;, &quot;action&quot;: &quot;WEBSOCKET_ACTION&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.validate.data.notify&quot;, &quot;begin_tip&quot;: &quot;准备开始数据检查...&quot;, &quot;params&quot;: &#123; &quot;filter_dict&quot;: &quot;expression[OBJ_MERGE(FILTER_DICT(), OBJ_PICK(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;formula_ids&quot;: &quot;expression[IF(GET(RES(&#x27;open_list&#x27;), [0]),LIST_GET(RES(&#x27;open_list&#x27;), &#x27;id&#x27;), IF(GET(RES(&#x27;open_list1&#x27;), [0]),LIST_GET(RES(&#x27;open_list1&#x27;), &#x27;id&#x27;), null))]&quot;, &quot;extra_property&quot;: &quot;expression[GET(ENV(), [&#x27;extra_property&#x27;])]&quot;, &quot;employee_ids&quot;: &quot;expression[IF(GET(SELECT_ITEMS(), [0]),LIST_GET(SELECT_ITEMS(), &#x27;employee_id&#x27;), null)]&quot;, &quot;other_filter&quot;: true, &quot;three_digit_segmentation_method&quot;: true &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;hyper_link&quot;, &quot;action&quot;: &quot;HYPER_LINK&quot;, &quot;entry_condition&quot;: &quot;expression[GET(RES(&#x27;websocket_export&#x27;), [&#x27;index&#x27;])]&quot;, &quot;options&quot;: &#123; &quot;url&quot;: &quot;expression[&#x27;/document/temp/download?index=&#x27;+GET(RES(&#x27;websocket_export&#x27;), [&#x27;index&#x27;])+&#x27;&amp;name=&#x27;+GET(RES(&#x27;websocket_export&#x27;), [&#x27;file_name&#x27;])+&#x27;.xlsx&#x27;]&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;confirm_background_error&quot;, &quot;action&quot;: &quot;SHOW_WARNING&quot;, &quot;entry_condition&quot;: &quot;expression[AND(GET(RES(&#x27;websocket_export&#x27;), [&#x27;index&#x27;]),GET(RES(&#x27;websocket_export&#x27;), [&#x27;is_return&#x27;]))]&quot;, &quot;options&quot;: &#123; &quot;content&quot;: &quot;检查完成，存在异常数据，请查看异常结果!&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;confirm_background_no_error&quot;, &quot;action&quot;: &quot;SHOW_WARNING&quot;, &quot;entry_condition&quot;: &quot;expression[AND(!GET(RES(&#x27;websocket_export&#x27;), [&#x27;index&#x27;]),GET(RES(&#x27;websocket_export&#x27;), [&#x27;is_return&#x27;]))]&quot;, &quot;options&quot;: &#123; &quot;content&quot;: &quot;检查完成，无异常数据!&quot; &#125; &#125; ] &#125;, &#123; &quot;key&quot;: &quot;view_detail&quot;, &quot;label&quot;: &quot;查看异常结果&quot;, &quot;is_important&quot;: true, &quot;type&quot;: &quot;selector&quot;, &quot;action&quot;: &quot;GO_STATE&quot;, &quot;options&quot;: &#123; &quot;state&quot;: &quot;common_model_list&quot;, &quot;params&quot;: &#123; &quot;model&quot;: &quot;SalaryCalcCheckResult&quot;, &quot;advance_filter_dict&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;program_id&#x27;])]&quot;, &quot;provide_id&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;provide_id&#x27;])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot; &#125;, &quot;filter_dict&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;program_id&#x27;])]&quot;, &quot;provide_id&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;provide_id&#x27;])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot; &#125;, &quot;filter_str&quot;: &quot;&quot;, &quot;show_fields_key&quot;: [ &quot;program_id&quot;, &quot;provide_id&quot;, &quot;month&quot;, &quot;check_id&quot;, &quot;exception_info&quot; ], &quot;custom_params&quot;: &#123; &quot;flag_state&quot;: &quot;=STATE.params.flag_state&quot; &#125; &#125;, &quot;open_new_page&quot;: true &#125; &#125; ] &#125;, &#123; &quot;key&quot;: &quot;history_compare&quot;, &quot;label&quot;: &quot;历史数据比对&quot;, &quot;hide&quot;: &quot;=function()&#123;if(SCOPE.auth.company_setting[&#x27;disable_future_salary_calculate&#x27;])&#123;return true;&#125;else&#123;if(STATE.params.flag_state==&#x27;provide_work_plat&#x27; || (STATE.params.custom_params &amp;&amp; JSON.parse(STATE.params.custom_params).flag_state === &#x27;provide_work_plat&#x27;))&#123;if(STATE.params.provide_type == 1 || (STATE.params.custom_params &amp;&amp; JSON.parse(STATE.params.custom_params).provide_type === 1))&#123;return false;&#125;else&#123;return true;&#125;&#125;&#125;&#125;&quot;, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;open_list&quot;, &quot;action&quot;: &quot;COMMON_LIST_DIALOG&quot;, &quot;options&quot;: &#123; &quot;component&quot;: &quot;hc-category-list-selector&quot;, &quot;model&quot;: &quot;SalaryCompareStatistics&quot;, &quot;title&quot;: &quot;薪酬历史数据比对列表&quot;, &quot;state&quot;: &quot;expression[GET(ENV(), [&#x27;extra_property&#x27;,&#x27;state&#x27;])+&#x27;&amp;&#x27;+GET(FILTER_DICT(),[&#x27;program_id&#x27;]) + &#x27;_&#x27; + IF(GET(FILTER_DICT(),[&#x27;pay_program_id&#x27;]), GET(FILTER_DICT(),[&#x27;pay_program_id&#x27;]), &#x27;0&#x27;) + &#x27;_&#x27; + IF(GET(ENV(),[&#x27;source_provide_id&#x27;]), GET(ENV(),[&#x27;source_provide_id&#x27;]), &#x27;0&#x27;)]&quot;, &quot;selectorType&quot;: 2, &quot;size&quot;: &quot;super-max&quot;, &quot;filter_dict&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(ENV(), [&#x27;program_id&#x27;])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;pay_program_id&quot;: &quot;expression[IF(GET(ENV(), [&#x27;multiple_calc&#x27;]),GET(FILTER_DICT(), [&#x27;pay_program_id&#x27;]), null)]&quot;, &quot;history_month&quot;: &quot;expression[ADDMONTHS(GET(FILTER_DICT(), [&#x27;month&#x27;]), -1)]&quot;, &quot;employee_ids&quot;: &quot;expression[IF(GET(SELECT_ITEMS(), [0]),LIST_GET(SELECT_ITEMS(), &#x27;employee_id&#x27;), null)]&quot;, &quot;provide_id&quot;: &quot;expression[IF(GET(FILTER_DICT(), [&#x27;provide_id&#x27;]), GET(FILTER_DICT(), [&#x27;provide_id&#x27;]), null)]&quot;, &quot;source_provide_id&quot;: &quot;expression[GET(ENV(), [&#x27;source_provide_id&#x27;])]&quot; &#125; &#125; &#125; ] &#125;, &#123; &quot;key&quot;: &quot;seal_or_unseal&quot;, &quot;label&quot;: &quot;封存&amp;启封&quot;, &quot;hide&quot;: &quot;=function()&#123;if(SCOPE.auth.company_setting[&#x27;disable_future_salary_calculate&#x27;])&#123;if(SCOPE.is_approve)&#123;return true;&#125;else&#123;if(SCOPE.hcm_navigation_items)&#123;SCOPE;let current_key=JSON.parse(STATE.params.custom_params).key; if(SCOPE.hcm_navigation_items.filter(v=&gt;v.key == current_key)[0].status == &#x27;finish&#x27;)&#123;return true;&#125;else&#123;if(SCOPE.hcm_navigation_items[SCOPE.hcm_navigation_items.findIndex(v=&gt;v.key==current_key)-1].status == &#x27;finish&#x27;)&#123;return false;&#125;else&#123;return true;&#125;&#125;&#125;else&#123;return false;&#125;&#125;&#125;else&#123;if(STATE.params.flag_state==&#x27;program_work_plat&#x27;|| (STATE.params.custom_params &amp;&amp; JSON.parse(STATE.params.custom_params).flag_state === &#x27;program_work_plat&#x27;) || SCOPE.is_approve)&#123;return true;&#125;else&#123;return false;&#125;&#125;&#125;&quot;, &quot;actions&quot;: [ &#123; &quot;key&quot;: &quot;seal_data&quot;, &quot;label&quot;: &quot;封存&quot;, &quot;options&quot;: &#123; &quot;set_debounce&quot;: true, &quot;debounce_time&quot;: 5 &#125;, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;conf&quot;, &quot;action&quot;: &quot;CONFIRM&quot;, &quot;options&quot;: &#123; &quot;content&quot;: &quot;封存后数据无法修改，请确认是否封存！&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;get_program&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;hcm.model.get&quot;, &quot;params&quot;: &#123; &quot;model&quot;: &quot;SalaryProgram&quot;, &quot;id_&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;program_id&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;websocket_export&quot;, &quot;action&quot;: &quot;WEBSOCKET_ACTION&quot;, &quot;entry_condition&quot;: &quot;expression[EQ(GET(RES(&#x27;get_program&#x27;), [&#x27;data_check_type&#x27;]),2)]&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.validate.data.notify&quot;, &quot;begin_tip&quot;: &quot;准备开始数据检查...&quot;, &quot;params&quot;: &#123; &quot;filter_dict&quot;: &quot;expression[OBJ_MERGE(FILTER_DICT(), OBJ_PICK(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;formula_ids&quot;: null, &quot;extra_property&quot;: &quot;expression[GET(ENV(), [&#x27;extra_property&#x27;])]&quot;, &quot;employee_ids&quot;: &quot;expression[IF(GET(SELECT_ITEMS(), [0]),LIST_GET(SELECT_ITEMS(), &#x27;employee_id&#x27;), null)]&quot;, &quot;filter_str&quot;: &quot;expression[GET(ENV(), [&#x27;filter_str&#x27;])]&quot;, &quot;other_filter&quot;: true &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;hyper_link&quot;, &quot;action&quot;: &quot;SHOW_WARNING&quot;, &quot;entry_condition&quot;: &quot;expression[AND(GET(RES(&#x27;websocket_export&#x27;), [&#x27;is_error&#x27;]),GET(RES(&#x27;websocket_export&#x27;), [&#x27;is_return&#x27;]))]&quot;, &quot;options&quot;: &#123; &quot;content&quot;: &quot;封存失败，数据检查未通过，存在错误数据，请查看异常结果！&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;task_confirm&quot;, &quot;action&quot;: &quot;CONFIRM&quot;, &quot;entry_condition&quot;: &quot;expression[AND(GET(RES(&#x27;websocket_export&#x27;), [&#x27;is_return&#x27;]),!GET(RES(&#x27;websocket_export&#x27;), [&#x27;is_error&#x27;]),GET(RES(&#x27;websocket_export&#x27;), [&#x27;index&#x27;]))]&quot;, &quot;options&quot;: &#123; &quot;content&quot;: &quot;数据检查完成，存在警告类型公式检测异常数据，请确认是否继续封存？&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;check_bonus&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;entry_condition&quot;: &quot;expression[OR(NEQ(GET(RES(&#x27;get_program&#x27;), [&#x27;data_check_type&#x27;]),2),AND(!GET(RES(&#x27;websocket_export&#x27;), [&#x27;is_error&#x27;]),GET(RES(&#x27;websocket_export&#x27;), [&#x27;is_return&#x27;])))]&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;private.check_bonus&quot;, &quot;begin_tip&quot;: &quot;准备检查奖金预算...&quot;, &quot;params&quot;: &#123; &quot;program_id&quot;: &quot;expression[OBJ_MERGE(FILTER_DICT(),OBJ_PICK(ENV(),[&#x27;program_id&#x27;]))]&quot;, &quot;employee_ids&quot;: &quot;expression[IF(GET(SELECT_ITEMS(),[0]),LIST_GET(SELECT_ITEMS(),&#x27;employee_id&#x27;),null)]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;check_error&quot;, &quot;action&quot;: &quot;SHOW_WARNING&quot;, &quot;entry_condition&quot;: &quot;expression[(EQ(GET(RES(&#x27;check_bonus&#x27;), [&#x27;state&#x27;]),1))]&quot;, &quot;options&quot;: &#123; &quot;content&quot;: &quot;封存失败，奖金预算超额！&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;get_confrim&quot;, &quot;action&quot;: &quot;WEBSOCKET_ACTION&quot;, &quot;entry_condition&quot;: &quot;expression[(EQ(GET(RES(&#x27;check_bonus&#x27;), [&#x27;state&#x27;]),0))]&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.confirm.seal.status&quot;, &quot;begin_tip&quot;: &quot;准备开始封存数据...&quot;, &quot;params&quot;: &#123; &quot;filter_dict&quot;: &quot;expression[OBJ_MERGE(FILTER_DICT(),OBJ_PICK(ENV(),[&#x27;program_id&#x27;]))]&quot;, &quot;status&quot;: 1, &quot;extra_property&quot;: &quot;expression[GET(ENV(),[&#x27;extra_property&#x27;])]&quot;, &quot;employee_ids&quot;: &quot;expression[GET(RES(&#x27;check_bonus&#x27;), [&#x27;employee_ids&#x27;])]&quot;, &quot;display_columns&quot;: &quot;expression[IF(GET(ENV(),[&#x27;advance&#x27;]),IF(GET(ENV(),[&#x27;advance&#x27;,&#x27;current_plan&#x27;]),GET(ENV(),[&#x27;advance&#x27;,&#x27;merged_meta&#x27;]),null),null)]&quot;, &quot;_model_history&quot;: &quot;expression[IF(GET(GET(RES(&#x27;&gt;seal_or_unseal_action&#x27;),[&#x27;data&#x27;]),[&#x27;model&#x27;]),GET(GET(RES(&#x27;&gt;seal_or_unseal&gt;seal_data2_action&#x27;),[&#x27;data&#x27;]),[&#x27;model&#x27;]),false)]&quot;, &quot;filter_str&quot;: &quot;expression[GET(ENV(), [&#x27;filter_str&#x27;])]&quot;, &quot;other_filter&quot;: true &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;confirm_background&quot;, &quot;action&quot;: &quot;SHOW_WARNING&quot;, &quot;entry_condition&quot;: &quot;expression[(EQ(GET(RES(&#x27;check_bonus&#x27;), [&#x27;state&#x27;]),0))]&quot;, &quot;options&quot;: &#123; &quot;content&quot;: &quot;封存成功,正在后台同步统计数据,请留意消息!&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;get_rules&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;entry_condition&quot;: &quot;expression[(EQ(GET(RES(&#x27;check_bonus&#x27;), [&#x27;state&#x27;]),0))]&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.summary.seal.sync.data&quot;, &quot;params&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(FILTER_DICT(),[&#x27;program_id&#x27;])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(),[&#x27;month&#x27;])]&quot;, &quot;provide_id&quot;: &quot;expression[GET(FILTER_DICT(),[&#x27;provide_id&#x27;])]&quot;, &quot;employee_ids&quot;: &quot;expression[IF(GET(SELECT_ITEMS(),[0]),LIST_GET(SELECT_ITEMS(),&#x27;employee_id&#x27;),IF(GET(RES(&#x27;get_confrim&#x27;),[&#x27;employee_id&#x27;]),GET(RES(&#x27;get_confrim&#x27;),[&#x27;employee_id&#x27;]), null))]&quot;, &quot;is_result&quot;: &quot;expression[GET(GET(RES(&#x27;&gt;seal_or_unseal&gt;seal_data_action&#x27;),[&#x27;data&#x27;]),[&#x27;summary&#x27;])]&quot;, &quot;is_base&quot;: &quot;expression[GET(GET(RES(&#x27;&gt;seal_or_unseal&gt;seal_data_action&#x27;),[&#x27;data&#x27;]),[&#x27;base&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;confirm_background2&quot;, &quot;action&quot;: &quot;SHOW_WARNING&quot;, &quot;entry_condition&quot;: &quot;expression[(EQ(GET(RES(&#x27;check_bonus&#x27;), [&#x27;state&#x27;]),0))]&quot;, &quot;options&quot;: &#123; &quot;content&quot;: &quot;封存成功!&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;sealdatamfycalc&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;private.YearEndBonusSealDataMfyCalc&quot;, &quot;begin_tip&quot;: &quot;准备修改发放状态和实际发放额度...&quot;, &quot;params&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(FILTER_DICT(),[&#x27;program_id&#x27;])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(),[&#x27;month&#x27;])]&quot;, &quot;status&quot;: 1, &quot;employee_ids&quot;: &quot;expression[IF(GET(SELECT_ITEMS(),[0]),LIST_GET(SELECT_ITEMS(),&#x27;employee_id&#x27;),IF(GET(RES(&#x27;get_confrim&#x27;),[&#x27;employee_id&#x27;]),GET(RES(&#x27;get_confrim&#x27;),[&#x27;employee_id&#x27;]), null))]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;refresh_status&quot;, &quot;label&quot;: &quot;刷新状态&quot;, &quot;action&quot;: &quot;REFRESH&quot; &#125; ], &quot;data&quot;: &#123; &quot;summary&quot;: true, &quot;base&quot;: true &#125; &#125;, &#123; &quot;key&quot;: &quot;unseal_data&quot;, &quot;label&quot;: &quot;启封&quot;, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;unsealdatamfycalc&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;private.YearEndBonusSealDataMfyCalc&quot;, &quot;begin_tip&quot;: &quot;准备修改发放状态和实际发放额度...&quot;, &quot;params&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(FILTER_DICT(),[&#x27;program_id&#x27;])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(),[&#x27;month&#x27;])]&quot;, &quot;status&quot;: 0, &quot;employee_ids&quot;: &quot;expression[IF(GET(SELECT_ITEMS(),[0]),LIST_GET(SELECT_ITEMS(),&#x27;employee_id&#x27;),null)]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;get_confrim&quot;, &quot;action&quot;: &quot;WEBSOCKET_ACTION&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.confirm.seal.status&quot;, &quot;begin_tip&quot;: &quot;准备开始启封数据...&quot;, &quot;params&quot;: &#123; &quot;filter_dict&quot;: &quot;expression[OBJ_MERGE(FILTER_DICT(),OBJ_PICK(ENV(),[&#x27;program_id&#x27;]))]&quot;, &quot;status&quot;: 0, &quot;extra_property&quot;: &quot;expression[GET(ENV(),[&#x27;extra_property&#x27;])]&quot;, &quot;employee_ids&quot;: &quot;expression[IF(GET(SELECT_ITEMS(),[0]),LIST_GET(SELECT_ITEMS(),&#x27;employee_id&#x27;),null)]&quot;, &quot;display_columns&quot;: &quot;expression[IF(GET(ENV(),[&#x27;advance&#x27;]),IF(GET(ENV(),[&#x27;advance&#x27;,&#x27;current_plan&#x27;]),GET(ENV(),[&#x27;advance&#x27;,&#x27;merged_meta&#x27;]),null),null)]&quot;, &quot;_model_history&quot;: &quot;expression[IF(GET(GET(RES(&#x27;&gt;seal_data_action&#x27;),[&#x27;data&#x27;]),[&#x27;model&#x27;]),GET(GET(RES(&#x27;&gt;seal_data_action&#x27;),[&#x27;data&#x27;]),[&#x27;model&#x27;]),false)]&quot;, &quot;filter_str&quot;: &quot;expression[GET(ENV(), [&#x27;filter_str&#x27;])]&quot;, &quot;other_filter&quot;: true &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;confirm_background2&quot;, &quot;action&quot;: &quot;SHOW_WARNING&quot;, &quot;entry_condition&quot;: &quot;expression[RES(&#x27;get_confrim&#x27;)]&quot;, &quot;options&quot;: &#123; &quot;content&quot;: &quot;启封成功!&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;refresh_status&quot;, &quot;label&quot;: &quot;刷新状态&quot;, &quot;action&quot;: &quot;REFRESH&quot; &#125; ] &#125; ] &#125;, &#123; &quot;key&quot;: &quot;report_rpt&quot;, &quot;label&quot;: &quot;上报数据&quot;, &quot;hide&quot;: true, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;is_sealed_check&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.to.rpt.check.sealed.state&quot;, &quot;params&quot;: &#123; &quot;program_id&quot;: &quot;expression[parseInt(GET(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;rpt_obj&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;validators&quot;: [ &#123; &quot;validator&quot;: &quot;expression[RES(&#x27;is_sealed_check&#x27;)]&quot;, &quot;tips&quot;: &quot;当前方案下，存在未封存数据，不可上报！&quot; &#125; ], &quot;options&quot;: &#123; &quot;api&quot;: &quot;hcm.model.list&quot;, &quot;params&quot;: &#123; &quot;model&quot;: &quot;SalaryRptObj&quot;, &quot;filter_dict&quot;: &#123; &quot;obj_type&quot;: &quot;1&quot;, &quot;status&quot;: [ &quot;active&quot;, &quot;disabling&quot; ], &quot;program_id&quot;: &quot;expression[GET(ENV(), [&#x27;program_id&#x27;])]&quot; &#125; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;validate_obj&quot;, &quot;validators&quot;: [ &#123; &quot;validator&quot;: &quot;expression[EQ(GET(RES(&#x27;rpt_obj&#x27;),[&#x27;count&#x27;]), 0)]&quot;, &quot;tips&quot;: &quot;当前方案不存在上报对象，无需上报！&quot; &#125; ] &#125;, &#123; &quot;action&quot;: &quot;COMMON_LIST_DIALOG&quot;, &quot;entry_condition&quot;: &quot;expression[GT(GET(RES(&#x27;rpt_obj&#x27;),[&#x27;count&#x27;]), 1)]&quot;, &quot;key&quot;: &quot;select_target&quot;, &quot;options&quot;: &#123; &quot;component&quot;: &quot;hc-category-list-selector&quot;, &quot;selectorType&quot;: 1, &quot;title&quot;: &quot;上报对象&quot;, &quot;selectorModel&quot;: &quot;SalaryRptObj&quot;, &quot;state&quot;: &quot;report_program&quot;, &quot;advance_filter_dict&quot;: &#123; &quot;obj_type&quot;: &quot;1&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;status&quot;: &quot;active&quot;, &quot;program_id&quot;: &quot;expression[GET(ENV(), [&#x27;program_id&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;validate_data&quot;, &quot;entry_condition&quot;: &quot;expression[GT(GET(RES(&#x27;rpt_obj&#x27;),[&#x27;count&#x27;]), 0)]&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;hcm.model.list&quot;, &quot;params&quot;: &#123; &quot;model&quot;: &quot;SalaryRptInstance&quot;, &quot;filter_dict&quot;: &#123; &quot;salary_month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;rpt_obj_id&quot;: &quot;expression[IF(RES(&#x27;select_target&#x27;), GET(RES(&#x27;select_target&#x27;), [&#x27;id&#x27;]), GET(RES(&#x27;rpt_obj&#x27;),[&#x27;list&#x27;,0,&#x27;id&#x27;]))]&quot; &#125;, &quot;page_size&quot;: 1, &quot;page_index&quot;: 1 &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;select_salary_month&quot;, &quot;entry_condition&quot;: &quot;expression[EQ(GET(RES(&#x27;validate_data&#x27;),[&#x27;count&#x27;]), 0)]&quot;, &quot;action&quot;: &quot;SIMPLE_FORM&quot;, &quot;form_options&quot;: &#123; &quot;size&quot;: &quot;middle&quot; &#125;, &quot;options&quot;: &#123; &quot;title&quot;: &quot;请选择上报月份&quot;, &quot;meta&quot;: [ &#123; &quot;key&quot;: &quot;month&quot;, &quot;label&quot;: &quot;上报月份&quot;, &quot;component&quot;: &quot;hc-input-datetime&quot;, &quot;options&quot;: &#123; &quot;data_type&quot;: &quot;string&quot;, &quot;required&quot;: true, &quot;width&quot;: &quot;col-12&quot;, &quot;singleLine&quot;: true, &quot;hide&quot;: false, &quot;readOnly&quot;: false, &quot;placeholder&quot;: &quot;请输入上报月份&quot;, &quot;default&quot;: null, &quot;maxlength&quot;: 10, &quot;format&quot;: &quot;yyyy-MM&quot; &#125; &#125; ] &#125; &#125;, &#123; &quot;key&quot;: &quot;validate_data_1&quot;, &quot;entry_condition&quot;: &quot;expression[RES(&#x27;select_salary_month&#x27;)]&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;hcm.model.list&quot;, &quot;params&quot;: &#123; &quot;model&quot;: &quot;SalaryRptInstance&quot;, &quot;filter_dict&quot;: &#123; &quot;month&quot;: &quot;expression[GET(RES(&#x27;select_salary_month&#x27;), [&#x27;month&#x27;])]&quot;, &quot;rpt_obj_id&quot;: &quot;expression[IF(RES(&#x27;select_target&#x27;), GET(RES(&#x27;select_target&#x27;), [&#x27;id&#x27;]), GET(RES(&#x27;rpt_obj&#x27;),[&#x27;list&#x27;,0,&#x27;id&#x27;]))]&quot; &#125;, &quot;page_size&quot;: 1, &quot;page_index&quot;: 1 &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;show_warning&quot;, &quot;action&quot;: &quot;SHOW_WARNING&quot;, &quot;entry_condition&quot;: &quot;expression[AND(RES(&#x27;validate_data_1&#x27;), GT(GET(RES(&#x27;validate_data_1&#x27;),[&#x27;count&#x27;]), 0))]&quot;, &quot;options&quot;: &#123; &quot;content&quot;: &quot;当前选择上报月份下已指定其他月份！&quot; &#125; &#125;, &#123; &quot;action&quot;: &quot;CALL_API&quot;, &quot;entry_condition&quot;: &quot;expression[OR(GT(GET(RES(&#x27;validate_data&#x27;),[&#x27;count&#x27;]), 0), EQ(GET(RES(&#x27;validate_data_1&#x27;),[&#x27;count&#x27;]), 0))]&quot;, &quot;key&quot;: &quot;move_talent&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.rpt.instance.create.instance&quot;, &quot;params&quot;: &#123; &quot;rpt_obj_id&quot;: &quot;expression[IF(RES(&#x27;select_target&#x27;), GET(RES(&#x27;select_target&#x27;), [&#x27;id&#x27;]), GET(RES(&#x27;rpt_obj&#x27;),[&#x27;list&#x27;,0,&#x27;id&#x27;]))]&quot;, &quot;month&quot;: &quot;expression[IF(GET(RES(&#x27;select_salary_month&#x27;), [&#x27;month&#x27;]),GET(RES(&#x27;select_salary_month&#x27;), [&#x27;month&#x27;]),GET(RES(&#x27;validate_data&#x27;),[&#x27;list&#x27;,0,&#x27;month&#x27;]))]&quot;, &quot;salary_month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;super_go&quot;, &quot;entry_condition&quot;: &quot;expression[RES(&#x27;move_talent&#x27;)]&quot;, &quot;action&quot;: &quot;GO_STATE&quot;, &quot;options&quot;: &#123; &quot;state&quot;: &quot;common_model_list&quot;, &quot;open_new_page&quot;: true, &quot;params&quot;: &#123; &quot;model&quot;: &quot;expression[&#x27;salary_to_rpt_data.&#x27;+GET(RES(&#x27;move_talent&#x27;),[&#x27;id&#x27;])]&quot;, &quot;filter_str&quot;: &quot;&quot;, &quot;filter_dict&quot;: &quot;&quot;, &quot;meta_state&quot;: &quot;&quot;, &quot;advance_filter_dict&quot;: &#123; &quot;month&quot;: &quot;expression[IF(GET(RES(&#x27;select_salary_month&#x27;), [&#x27;month&#x27;]),GET(RES(&#x27;select_salary_month&#x27;), [&#x27;month&#x27;]),GET(RES(&#x27;validate_data&#x27;),[&#x27;list&#x27;,0,&#x27;month&#x27;]))]&quot; &#125; &#125; &#125; &#125; ] &#125;, &#123; &quot;key&quot;: &quot;report_rpt_new&quot;, &quot;label&quot;: &quot;上报数据&quot;, &quot;hide&quot;: &quot;=function()&#123;if(SCOPE.auth.company_setting[&#x27;disable_future_salary_calculate&#x27;])&#123;if(SCOPE.auth.company_setting.is_use_salary_rpt_data)&#123;if(SCOPE.hcm_navigation_items)&#123;let current_key=JSON.parse(STATE.params.custom_params).key;if(SCOPE.is_approve)&#123;if(current_key == &#x27;approve_view&#x27;)&#123;if(SCOPE.hcm_navigation_items.filter(v=&gt;v.key == current_key)[0].status == &#x27;finish&#x27;)&#123;return true;&#125;else&#123;if(SCOPE.hcm_navigation_items[SCOPE.hcm_navigation_items.findIndex(v=&gt;v.key==current_key)-1].status == &#x27;finish&#x27;)&#123;return false;&#125;else&#123;return true;&#125;&#125;&#125;else&#123;return true;&#125;&#125;else&#123;if(current_key == &#x27;calc_real&#x27;)&#123;if(SCOPE.hcm_navigation_items.filter(v=&gt;v.key == current_key)[0].status == &#x27;finish&#x27;)&#123;return true;&#125;else&#123;if(SCOPE.hcm_navigation_items[SCOPE.hcm_navigation_items.findIndex(v=&gt;v.key==current_key)-1].status == &#x27;finish&#x27;)&#123;return false;&#125;else&#123;return true;&#125;&#125;&#125;else&#123;return true;&#125;&#125;&#125;else&#123;return !SCOPE.auth.company_setting.is_use_salary_rpt_data;&#125;&#125;else&#123;return true;&#125;&#125;else&#123;return !SCOPE.auth.company_setting.is_use_salary_rpt_data;&#125;&#125;&quot;, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;is_sealed_check&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.to.rpt.check.sealed.state&quot;, &quot;params&quot;: &#123; &quot;program_id&quot;: &quot;expression[parseInt(GET(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;rpt_obj&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;validators&quot;: [ &#123; &quot;validator&quot;: &quot;expression[RES(&#x27;is_sealed_check&#x27;)]&quot;, &quot;tips&quot;: &quot;当前方案下，存在未封存数据，不可上报！&quot; &#125; ], &quot;options&quot;: &#123; &quot;api&quot;: &quot;hcm.model.list&quot;, &quot;params&quot;: &#123; &quot;model&quot;: &quot;SalaryRptObj&quot;, &quot;filter_dict&quot;: &#123; &quot;obj_type&quot;: &quot;1&quot;, &quot;status&quot;: [ &quot;active&quot;, &quot;disabling&quot; ], &quot;program_id&quot;: &quot;expression[GET(ENV(), [&#x27;program_id&#x27;])]&quot; &#125; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;validate_obj&quot;, &quot;validators&quot;: [ &#123; &quot;validator&quot;: &quot;expression[EQ(GET(RES(&#x27;rpt_obj&#x27;),[&#x27;count&#x27;]), 0)]&quot;, &quot;tips&quot;: &quot;当前方案不存在上报对象，无需上报！&quot; &#125; ] &#125;, &#123; &quot;action&quot;: &quot;COMMON_LIST_DIALOG&quot;, &quot;entry_condition&quot;: &quot;expression[GT(GET(RES(&#x27;rpt_obj&#x27;),[&#x27;count&#x27;]), 1)]&quot;, &quot;key&quot;: &quot;select_target&quot;, &quot;options&quot;: &#123; &quot;component&quot;: &quot;hc-category-list-selector&quot;, &quot;selectorType&quot;: 1, &quot;title&quot;: &quot;上报对象&quot;, &quot;selectorModel&quot;: &quot;SalaryRptObj&quot;, &quot;state&quot;: &quot;report_program&quot;, &quot;advance_filter_dict&quot;: &#123; &quot;obj_type&quot;: &quot;1&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;status&quot;: &quot;active&quot;, &quot;program_id&quot;: &quot;expression[GET(ENV(), [&#x27;program_id&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;validate_data&quot;, &quot;entry_condition&quot;: &quot;expression[GT(GET(RES(&#x27;rpt_obj&#x27;),[&#x27;count&#x27;]), 0)]&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;hcm.model.list&quot;, &quot;params&quot;: &#123; &quot;model&quot;: &quot;SalaryRptInstance&quot;, &quot;filter_dict&quot;: &#123; &quot;salary_month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;rpt_obj_id&quot;: &quot;expression[IF(RES(&#x27;select_target&#x27;), GET(RES(&#x27;select_target&#x27;), [&#x27;id&#x27;]), GET(RES(&#x27;rpt_obj&#x27;),[&#x27;list&#x27;,0,&#x27;id&#x27;]))]&quot; &#125;, &quot;page_size&quot;: 1, &quot;page_index&quot;: 1 &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;obj_info&quot;, &quot;entry_condition&quot;: &quot;expression[OR(RES(&#x27;select_target&#x27;), RES(&#x27;rpt_obj&#x27;))]&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;hcm.model.get&quot;, &quot;params&quot;: &#123; &quot;model&quot;: &quot;SalaryRptObj&quot;, &quot;id_&quot;: &quot;expression[IF(RES(&#x27;select_target&#x27;), GET(RES(&#x27;select_target&#x27;), [&#x27;id&#x27;]), GET(RES(&#x27;rpt_obj&#x27;),[&#x27;list&#x27;,0,&#x27;id&#x27;]))]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;select_salary_month&quot;, &quot;entry_condition&quot;: &quot;expression[EQ(GET(RES(&#x27;validate_data&#x27;),[&#x27;count&#x27;]), 0)]&quot;, &quot;action&quot;: &quot;SIMPLE_FORM&quot;, &quot;form_options&quot;: &#123; &quot;size&quot;: &quot;middle&quot; &#125;, &quot;options&quot;: &#123; &quot;title&quot;: &quot;请选择上报月份&quot;, &quot;meta&quot;: [ &#123; &quot;key&quot;: &quot;month&quot;, &quot;label&quot;: &quot;上报月份&quot;, &quot;component&quot;: &quot;hc-input-datetime&quot;, &quot;options&quot;: &#123; &quot;data_type&quot;: &quot;string&quot;, &quot;required&quot;: true, &quot;width&quot;: &quot;col-12&quot;, &quot;singleLine&quot;: true, &quot;hide&quot;: false, &quot;readOnly&quot;: false, &quot;placeholder&quot;: &quot;请输入上报月份&quot;, &quot;default&quot;: &quot;expression[IF(OR(GET(RES(&#x27;obj_info&#x27;), [&#x27;collect_month&#x27;]), EQ(GET(RES(&#x27;obj_info&#x27;), [&#x27;collect_month&#x27;]),0)), ADDMONTHS(GET(FILTER_DICT(), [&#x27;month&#x27;]), GET(RES(&#x27;obj_info&#x27;), [&#x27;collect_month&#x27;])), null)]&quot;, &quot;maxlength&quot;: 10, &quot;format&quot;: &quot;yyyy-MM&quot; &#125; &#125; ] &#125; &#125;, &#123; &quot;key&quot;: &quot;validate_data_1&quot;, &quot;entry_condition&quot;: &quot;expression[RES(&#x27;select_salary_month&#x27;)]&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;hcm.model.list&quot;, &quot;params&quot;: &#123; &quot;model&quot;: &quot;SalaryRptInstance&quot;, &quot;filter_dict&quot;: &#123; &quot;month&quot;: &quot;expression[GET(RES(&#x27;select_salary_month&#x27;), [&#x27;month&#x27;])]&quot;, &quot;rpt_obj_id&quot;: &quot;expression[IF(RES(&#x27;select_target&#x27;), GET(RES(&#x27;select_target&#x27;), [&#x27;id&#x27;]), GET(RES(&#x27;rpt_obj&#x27;),[&#x27;list&#x27;,0,&#x27;id&#x27;]))]&quot; &#125;, &quot;page_size&quot;: 1, &quot;page_index&quot;: 1 &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;show_warning&quot;, &quot;action&quot;: &quot;SHOW_WARNING&quot;, &quot;entry_condition&quot;: &quot;expression[AND(RES(&#x27;validate_data_1&#x27;), GT(GET(RES(&#x27;validate_data_1&#x27;),[&#x27;count&#x27;]), 0))]&quot;, &quot;options&quot;: &#123; &quot;content&quot;: &quot;当前选择上报月份下已指定其他月份！&quot; &#125; &#125;, &#123; &quot;action&quot;: &quot;CALL_API&quot;, &quot;entry_condition&quot;: &quot;expression[OR(GT(GET(RES(&#x27;validate_data&#x27;),[&#x27;count&#x27;]), 0), EQ(GET(RES(&#x27;validate_data_1&#x27;),[&#x27;count&#x27;]), 0))]&quot;, &quot;key&quot;: &quot;move_talent&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.rpt.instance.create.instance&quot;, &quot;params&quot;: &#123; &quot;rpt_obj_id&quot;: &quot;expression[IF(RES(&#x27;select_target&#x27;), GET(RES(&#x27;select_target&#x27;), [&#x27;id&#x27;]), GET(RES(&#x27;rpt_obj&#x27;),[&#x27;list&#x27;,0,&#x27;id&#x27;]))]&quot;, &quot;month&quot;: &quot;expression[IF(GET(RES(&#x27;select_salary_month&#x27;), [&#x27;month&#x27;]),GET(RES(&#x27;select_salary_month&#x27;), [&#x27;month&#x27;]),GET(RES(&#x27;validate_data&#x27;),[&#x27;list&#x27;,0,&#x27;month&#x27;]))]&quot;, &quot;salary_month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;super_go&quot;, &quot;entry_condition&quot;: &quot;expression[RES(&#x27;move_talent&#x27;)]&quot;, &quot;action&quot;: &quot;GO_STATE&quot;, &quot;options&quot;: &#123; &quot;state&quot;: &quot;common_model_list&quot;, &quot;open_new_page&quot;: true, &quot;params&quot;: &#123; &quot;model&quot;: &quot;expression[&#x27;salary_to_rpt_data.&#x27;+GET(RES(&#x27;move_talent&#x27;),[&#x27;id&#x27;])]&quot;, &quot;filter_str&quot;: &quot;&quot;, &quot;filter_dict&quot;: &quot;&quot;, &quot;meta_state&quot;: &quot;report_ultra&quot;, &quot;advance_filter_dict&quot;: &#123; &quot;month&quot;: &quot;expression[IF(GET(RES(&#x27;select_salary_month&#x27;), [&#x27;month&#x27;]),GET(RES(&#x27;select_salary_month&#x27;), [&#x27;month&#x27;]),GET(RES(&#x27;validate_data&#x27;),[&#x27;list&#x27;,0,&#x27;month&#x27;]))]&quot; &#125; &#125; &#125; &#125; ] &#125;, &#123; &quot;key&quot;: &quot;adjust_inst_data&quot;, &quot;label&quot;: &quot;调整上报月份&quot;, &quot;hide&quot;: true, &quot;action&quot;: [ &#123; &quot;action&quot;: &quot;COMMON_LIST_DIALOG&quot;, &quot;key&quot;: &quot;select_target&quot;, &quot;options&quot;: &#123; &quot;component&quot;: &quot;hc-category-list-selector&quot;, &quot;selectorType&quot;: 0, &quot;title&quot;: &quot;上报实例&quot;, &quot;selectorModel&quot;: &quot;SalaryRptInstance&quot;, &quot;state&quot;: &quot;adjust_data&quot;, &quot;advance_filter_dict&quot;: &#123; &quot;obj_type&quot;: &quot;1&quot;, &quot;sal_month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;program_id&quot;: &quot;expression[GET(ENV(), [&#x27;program_id&#x27;])]&quot; &#125; &#125; &#125; ] &#125;, &#123; &quot;key&quot;: &quot;salary_bill&quot;, &quot;label&quot;: &quot;工资条管理&quot;, &quot;hide&quot;: &quot;=function()&#123;if(SCOPE.hcm_navigation_items)&#123;SCOPE;let current_key=JSON.parse(STATE.params.custom_params).key; if(SCOPE.hcm_navigation_items.filter(v=&gt;v.key == current_key)[0].status == &#x27;finish&#x27;)&#123;return true;&#125;else&#123;if(SCOPE.hcm_navigation_items[SCOPE.hcm_navigation_items.findIndex(v=&gt;v.key==current_key)-1].status == &#x27;finish&#x27;)&#123;return false;&#125;else&#123;return true;&#125;&#125;&#125;else&#123;if(STATE.params.flag_state==&#x27;program_work_plat&#x27; || (STATE.params.custom_params &amp;&amp; JSON.parse(STATE.params.custom_params).flag_state === &#x27;program_work_plat&#x27;) || !SCOPE.auth.company_setting.IS_USE_SALARY_SEND_BILL)&#123;return true;&#125;else&#123;return false&#125;&#125;&#125;&quot;, &quot;action&quot;: &quot;C_ACTION&quot;, &quot;actions&quot;: [ &#123; &quot;key&quot;: &quot;send_salary_bill&quot;, &quot;label&quot;: &quot;工资条发送&quot;, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;is_send_bill_message&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.status.is.send.bill.message&quot;, &quot;params&quot;: &#123; &quot;filter_dict&quot;: &quot;expression[FILTER_DICT()]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;send_salary_bill_message&quot;, &quot;entry_condition&quot;: &quot;expression[AND(GET(AUTH(), [&#x27;company_setting&#x27;, &#x27;is_send_salary_bill_message&#x27;]),RES(&#x27;is_send_bill_message&#x27;))]&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;pay.roll.send.setting.info&quot;, &quot;params&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(ENV(), [&#x27;program_id&#x27;])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;simple_form_dialog&quot;, &quot;action&quot;: &quot;SIMPLE_FORM&quot;, &quot;entry_condition&quot;: &quot;expression[GET(AUTH(), [&#x27;company_setting&#x27;, &#x27;is_send_salary_bill_message&#x27;])]&quot;, &quot;options&quot;: &#123; &quot;title&quot;: &quot;工资条通知消息&quot;, &quot;meta&quot;: [ &#123; &quot;key&quot;: &quot;content&quot;, &quot;component&quot;: &quot;hc-text-area&quot;, &quot;label&quot;: &quot;发送通知内容&quot;, &quot;options&quot;: &#123; &quot;maxlength&quot;: 1000, &quot;default&quot;: &quot;expression[GET(RES(&#x27;send_salary_bill_message&#x27;), [&#x27;mobile_notice&#x27;])]&quot;, &quot;readOnly&quot;: &quot;expression[GET(AUTH(), [&#x27;company_setting&#x27;, &#x27;is_use_my_salary_bill&#x27;])]&quot; &#125; &#125; ], &quot;form_options&quot;: &#123; &quot;size&quot;: &quot;small&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;salary_send_bill&quot;, &quot;action&quot;: &quot;WEBSOCKET_ACTION&quot;, &quot;asyncHandle&quot;: true, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.status.send.bill&quot;, &quot;params&quot;: &#123; &quot;employee_ids&quot;: &quot;expression[IF(GET(SELECT_ITEMS(), [0]),LIST_GET(SELECT_ITEMS(), &#x27;employee_id&#x27;), null)]&quot;, &quot;filter_dict&quot;: &quot;expression[OBJ_MERGE(FILTER_DICT(), OBJ_PICK(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;content&quot;: &quot;expression[GET(RES(&#x27;simple_form_dialog&#x27;), [&#x27;content&#x27;])]&quot;, &quot;type&quot;: &quot;expression[GET(ENV(),[&#x27;extra_property&#x27;,&#x27;filter_params&#x27;,&#x27;flag_state&#x27;])]&quot;, &quot;extra_property&quot;: &quot;expression[GET(ENV(),[&#x27;extra_property&#x27;])]&quot;, &quot;filter_str&quot;: &quot;expression[GET(ENV(),[&#x27;filter_str&#x27;])]&quot;, &quot;other_filter&quot;: true &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;show_warning&quot;, &quot;action&quot;: &quot;SHOW_WARNING&quot;, &quot;entry_condition&quot;: &quot;expression[AND(RES(&#x27;salary_send_bill&#x27;), STR_INCLUDES(RES(&#x27;salary_send_bill&#x27;), &#x27;本薪酬方案未找到对应月份的工资条设置&#x27;))]&quot;, &quot;options&quot;: &#123; &quot;content&quot;: &quot;本薪酬方案未找到对应月份的工资条设置，不能下发&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;resolve_api&quot;, &quot;action&quot;: &quot;REFRESH&quot;, &quot;entry_condition&quot;: &quot;expression[AND(GET(AUTH(), [&#x27;company_setting&#x27;, &#x27;is_send_salary_bill_message&#x27;]),RES(&#x27;salary_send_bill&#x27;))]&quot; &#125; ] &#125;, &#123; &quot;key&quot;: &quot;recover_salary_bill&quot;, &quot;label&quot;: &quot;工资条收回&quot;, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;recover_bill&quot;, &quot;action&quot;: &quot;WEBSOCKET_ACTION&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.status.recover.bill&quot;, &quot;params&quot;: &#123; &quot;employee_ids&quot;: &quot;expression[IF(GET(SELECT_ITEMS(), [0]),LIST_GET(SELECT_ITEMS(), &#x27;employee_id&#x27;), null)]&quot;, &quot;filter_dict&quot;: &quot;expression[OBJ_MERGE(FILTER_DICT(), OBJ_PICK(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;type&quot;: &quot;expression[GET(ENV(),[&#x27;extra_property&#x27;,&#x27;filter_params&#x27;,&#x27;flag_state&#x27;])]&quot;, &quot;extra_property&quot;: &quot;expression[GET(ENV(),[&#x27;extra_property&#x27;])]&quot;, &quot;filter_str&quot;: &quot;expression[GET(ENV(),[&#x27;filter_str&#x27;])]&quot;, &quot;other_filter&quot;: true &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;show_warning&quot;, &quot;action&quot;: &quot;SHOW_WARNING&quot;, &quot;entry_condition&quot;: &quot;expression[RES(&#x27;recover_bill&#x27;)]&quot;, &quot;options&quot;: &#123; &quot;content&quot;: &quot;工资条收回成功&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;refresh&quot;, &quot;action&quot;: &quot;REFRESH&quot; &#125; ] &#125;, &#123; &quot;key&quot;: &quot;monitor_salary_bill&quot;, &quot;label&quot;: &quot;工资条监控&quot;, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;dialog_multi_items&quot;, &quot;action&quot;: &quot;COMMON_LIST_DIALOG&quot;, &quot;entry_condition&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;depart_id&#x27;])]&quot;, &quot;options&quot;: &#123; &quot;component&quot;: &quot;hc-category-list-selector&quot;, &quot;filter_dict&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(ENV(), &#x27;program_id&#x27;)]&quot;, &quot;provide_id&quot;: &quot;expression[GET(ENV(), &#x27;provide_id&#x27;)]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;pay_program_id&quot;: &quot;expression[IF(GET(ENV(), [&#x27;multiple_calc&#x27;]),GET(FILTER_DICT(), [&#x27;pay_program_id&#x27;]), null)]&quot;, &quot;depart_id&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;depart_id&#x27;])]&quot; &#125;, &quot;model&quot;: &quot;SalaryBillMonitor&quot;, &quot;state&quot;: &quot;bill&quot;, &quot;selector_type&quot;: 2, &quot;title&quot;: &quot;工资条监控&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;dialog_multi_items&quot;, &quot;action&quot;: &quot;COMMON_LIST_DIALOG&quot;, &quot;entry_condition&quot;: &quot;expression[!GET(FILTER_DICT(), [&#x27;depart_id&#x27;])]&quot;, &quot;options&quot;: &#123; &quot;component&quot;: &quot;hc-category-list-selector&quot;, &quot;filter_dict&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(ENV(), &#x27;program_id&#x27;)]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot; &#125;, &quot;model&quot;: &quot;SalaryBillMonitor&quot;, &quot;state&quot;: &quot;bill&quot;, &quot;selector_type&quot;: 2, &quot;title&quot;: &quot;工资条监控&quot; &#125; &#125; ], &quot;command&quot;: &quot;monitor_bill_status&quot; &#125; ] &#125;, &#123; &quot;key&quot;: &quot;salary_compare&quot;, &quot;label&quot;: &quot;薪酬比对&quot;, &quot;hide&quot;: true, &quot;actions&quot;: [ &#123; &quot;key&quot;: &quot;salary_compare_setting&quot;, &quot;label&quot;: &quot;比对设置&quot;, &quot;func&quot;: &quot;=function()&#123;dataService.callHcmOpenApi(&#x27;salary.compare.setting.get&#x27;, &#123;program_id: SCOPE.advance_query.query_model.data.program_id&#125;).then(function (_data) &#123;SCOPE.openDynamicDialog(null,&#123;model:&#x27;SalaryDataCompareRange&#x27;,state:&#x27;setting&#x27;,mode:&#x27;edit&#x27;,data:_data&#125;,&#123;&#125;)&#125;)&#125;&quot; &#125;, &#123; &quot;key&quot;: &quot;salary_compare_dashboard&quot;, &quot;label&quot;: &quot;薪酬比对仪表盘&quot;, &quot;func&quot;: &quot;=function()&#123;$hcDialog.getDialog(HCMBoardReportDialog).size(&#x27;super-max&#x27;).show(&#123;id:3925, &#x27;data&#x27;: &#123;&#x27;program_id&#x27;:SCOPE.advance_query.query_model.data.program_id,&#x27;current_month&#x27;:SCOPE.advance_query.query_model.data.month&#125;&#125;)&#125;&quot; &#125; ] &#125;, &#123; &quot;key&quot;: &quot;cost_write&quot;, &quot;label&quot;: &quot;生成成本&quot;, &quot;action&quot;: &quot;C_ACTION&quot;, &quot;hide&quot;: true, &quot;command&quot;: &quot;cost_write&quot; &#125;, &#123; &quot;key&quot;: &quot;new_enroll&quot;, &quot;label&quot;: &quot;新增附加数据&quot;, &quot;hide&quot;: true, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;save_enroll&quot;, &quot;action&quot;: &quot;COMMON_INFO_DIALOG&quot;, &quot;options&quot;: &#123; &quot;model&quot;: &quot;SalaryEnroll&quot;, &quot;state&quot;: &quot;salary_calculate_filter&quot;, &quot;action_chain&quot;: true, &quot;mode&quot;: &quot;new&quot;, &quot;data&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(ENV(), [&#x27;program_id&#x27;])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;config_value&quot;: &quot;expression[GET(ENV(), [&#x27;display_meta&#x27;])]&quot;, &quot;pay_program_id&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;pay_program_id&#x27;])]&quot;, &quot;filter_dict&quot;: &quot;expression[FILTER_DICT()]&quot;, &quot;filter_str&quot;: &quot;expression[GET(ENV(), [&#x27;extra_property&#x27;, &#x27;filter_str&#x27;])]&quot;, &quot;select_items&quot;: &quot;expression[SELECT_ITEM()]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;batchEditEmp&quot;, &quot;action&quot;: &quot;CUSTOM_DIALOG&quot;, &quot;options&quot;: &#123; &quot;size&quot;: &quot;super-max&quot;, &quot;action_chain&quot;: true, &quot;data&quot;: &#123; &quot;mode&quot;: &quot;new&quot;, &quot;meta_state&quot;: &quot;salary_calculate_select&quot;, &quot;config_value&quot;: &quot;expression[GET(ENV(), [&#x27;display_meta&#x27;])]&quot;, &quot;program_id&quot;: &quot;expression[GET(ENV(), [&#x27;program_id&#x27;])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;pay_program_id&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;pay_program_id&#x27;])]&quot;, &quot;filter_dict&quot;: &quot;expression[FILTER_DICT()]&quot;, &quot;filter_str&quot;: &quot;expression[GET(ENV(), [&#x27;extra_property&#x27;, &#x27;filter_str&#x27;])]&quot;, &quot;select_items&quot;: &quot;expression[SELECT_ITEM()]&quot;, &quot;enroll_id&quot;: &quot;expression[GET(RES(&#x27;save_enroll&#x27;), [&#x27;id&#x27;])]&quot;, &quot;type&quot;: &quot;expression[GET(RES(&#x27;save_enroll&#x27;), [&#x27;type&#x27;])]&quot;, &quot;data&quot;: &quot;expression[GET(RES(&#x27;save_enroll&#x27;))]&quot; &#125;, &quot;ctrl&quot;: &quot;SalaryAssistEntryBatchInputCtrl&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;refresh_status&quot;, &quot;label&quot;: &quot;刷新状态&quot;, &quot;action&quot;: &quot;REFRESH&quot; &#125; ] &#125;, &#123; &quot;key&quot;: &quot;view_enroll&quot;, &quot;label&quot;: &quot;查看附加数据&quot;, &quot;hide&quot;: true, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;api&quot;, &quot;action&quot;: &quot;SET_ENV&quot;, &quot;entry_condition&quot;: &quot;expression[!EQ(GET(ENV(), [&#x27;display_meta&#x27;]), null)]&quot;, &quot;options&quot;: &#123; &quot;params&quot;: &#123; &quot;config_value&quot;: &quot;expression[GET(ENV(), [&#x27;display_meta&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;api&quot;, &quot;action&quot;: &quot;SET_ENV&quot;, &quot;entry_condition&quot;: &quot;expression[EQ(GET(ENV(), [&#x27;display_meta&#x27;]), undefined)]&quot;, &quot;options&quot;: &#123; &quot;params&quot;: &#123; &quot;config_value&quot;: [] &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;get_program&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;hcm.model.get&quot;, &quot;params&quot;: &#123; &quot;model&quot;: &quot;SalaryProgram&quot;, &quot;id_&quot;: &quot;expression[GET(ENV(), [&#x27;program_id&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;open_list&quot;, &quot;action&quot;: &quot;COMMON_LIST_DIALOG&quot;, &quot;entry_condition&quot;: &quot;expression[EQ(GET(RES(&#x27;get_program&#x27;), [&#x27;is_multi&#x27;]), true)]&quot;, &quot;options&quot;: &#123; &quot;component&quot;: &quot;hc-category-list-selector&quot;, &quot;model&quot;: &quot;SalaryDataEnroll&quot;, &quot;selectorType&quot;: 0, &quot;state&quot;: &quot;salary_calculate&quot;, &quot;title&quot;: &quot;expression[GET(RES(&#x27;get_program&#x27;), [&#x27;name&#x27;])+&#x27;:&#x27; + GET(RES(&#x27;get_program&#x27;), [&#x27;name&#x27;])+&#x27;附加数据&#x27;]&quot;, &quot;filter_dict&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(ENV(), [&#x27;program_id&#x27;])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;pay_program_id&quot;: &quot;expression[IF(GET(RES(&#x27;api&#x27;), [&#x27;is_multi&#x27;]),GET(FILTER_DICT(), [&#x27;pay_program_id&#x27;]), null)]&quot; &#125;, &quot;advance_filter_dict&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(ENV(), [&#x27;program_id&#x27;])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;pay_program_id&quot;: &quot;expression[IF(GET(RES(&#x27;api&#x27;), [&#x27;is_multi&#x27;]),GET(FILTER_DICT(), [&#x27;pay_program_id&#x27;]), null)]&quot; &#125;, &quot;config_value&quot;: &quot;expression[GET(ENV(), [&#x27;display_meta&#x27;])]&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;open_list&quot;, &quot;action&quot;: &quot;COMMON_LIST_DIALOG&quot;, &quot;entry_condition&quot;: &quot;expression[!EQ(GET(RES(&#x27;get_program&#x27;), [&#x27;is_multi&#x27;]), true)]&quot;, &quot;options&quot;: &#123; &quot;component&quot;: &quot;hc-category-list-selector&quot;, &quot;model&quot;: &quot;SalaryEnroll&quot;, &quot;selectorType&quot;: 0, &quot;state&quot;: &quot;salary_calculate&quot;, &quot;title&quot;: &quot;expression[GET(RES(&#x27;get_program&#x27;), [&#x27;name&#x27;])+&#x27;:&#x27; + GET(FILTER_DICT(), [&#x27;month&#x27;])+&#x27;附加数据&#x27;]&quot;, &quot;filter_dict&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(ENV(), [&#x27;program_id&#x27;])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;pay_program_id&quot;: &quot;expression[IF(GET(RES(&#x27;api&#x27;), [&#x27;is_multi&#x27;]),GET(FILTER_DICT(), [&#x27;pay_program_id&#x27;]), null)]&quot; &#125;, &quot;advance_filter_dict&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(ENV(), [&#x27;program_id&#x27;])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;pay_program_id&quot;: &quot;expression[IF(GET(RES(&#x27;api&#x27;), [&#x27;is_multi&#x27;]),GET(FILTER_DICT(), [&#x27;pay_program_id&#x27;]), null)]&quot; &#125;, &quot;config_value&quot;: &quot;expression[GET(ENV(), [&#x27;display_meta&#x27;])]&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;refresh_status&quot;, &quot;label&quot;: &quot;刷新状态&quot;, &quot;action&quot;: &quot;REFRESH&quot; &#125; ] &#125;, &#123; &quot;key&quot;: &quot;writeBackBudget&quot;, &quot;label&quot;: &quot;回写预算数据&quot;, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;api&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;budget.result.data.budget.result.write.back&quot;, &quot;params&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(ENV(),[&#x27;program_id&#x27;])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(),[&#x27;month&#x27;])]&quot;, &quot;provide_id&quot;: &quot;expression[GET(FILTER_DICT(),[&#x27;provide_id&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;show_warning&quot;, &quot;action&quot;: &quot;SHOW_WARNING&quot;, &quot;options&quot;: &#123; &quot;content&quot;: &quot;回写成功!&quot; &#125; &#125; ], &quot;hide&quot;: &quot;=function()&#123;if(SCOPE.auth.company_setting[&#x27;is_use_budget_control&#x27;])&#123;if(SCOPE.hcm_navigation_items)&#123;SCOPE;let current_key=JSON.parse(STATE.params.custom_params).key; if(SCOPE.hcm_navigation_items.filter(v=&gt;v.key == current_key)[0].status == &#x27;finish&#x27;)&#123;return true;&#125;else&#123;if(SCOPE.hcm_navigation_items[SCOPE.hcm_navigation_items.findIndex(v=&gt;v.key==current_key)-1].status == &#x27;finish&#x27;)&#123;return false;&#125;else&#123;return true;&#125;&#125;&#125;else&#123;return false;&#125;&#125;else&#123;return true;&#125;&#125;&quot; &#125;, &#123; &quot;key&quot;: &quot;budgetResultWarning&quot;, &quot;label&quot;: &quot;预算总额控制&quot;, &quot;hide&quot;: &quot;=function()&#123;if(SCOPE.auth.company_setting[&#x27;is_use_budget_control&#x27;])&#123;if(SCOPE.hcm_navigation_items)&#123;SCOPE;let current_key=JSON.parse(STATE.params.custom_params).key; if(SCOPE.hcm_navigation_items.filter(v=&gt;v.key == current_key)[0].status == &#x27;finish&#x27;)&#123;return true;&#125;else&#123;if(SCOPE.hcm_navigation_items[SCOPE.hcm_navigation_items.findIndex(v=&gt;v.key==current_key)-1].status == &#x27;finish&#x27;)&#123;return false;&#125;else&#123;return true;&#125;&#125;&#125;else&#123;return false;&#125;&#125;else&#123;return true;&#125;&#125;&quot;, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;back_api&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;budget.result.data.budget.result.warning.back&quot;, &quot;params&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(ENV(),[&#x27;program_id&#x27;])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(),[&#x27;month&#x27;])]&quot;, &quot;provide_id&quot;: &quot;expression[GET(FILTER_DICT(),[&#x27;provide_id&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;show_warning&quot;, &quot;action&quot;: &quot;SHOW_WARNING&quot;, &quot;entry_condition&quot;: &quot;expression[EQ(GET(RES(&#x27;back_api&#x27;), [&#x27;success&#x27;]), false)]&quot;, &quot;options&quot;: &#123; &quot;content&quot;: &quot;expression[GET(RES(&#x27;back_api&#x27;), [&#x27;msg&#x27;])]&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;detail_api_single&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;entry_condition&quot;: &quot;expression[EQ(GET(RES(&#x27;back_api&#x27;),[&#x27;length&#x27;]),1)]&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;budget.result.data.budget.result.warning.detail&quot;, &quot;params&quot;: &#123; &quot;plan_id&quot;: &quot;expression[GET(FINDBYINDEX(RES(&#x27;back_api&#x27;),0),[&#x27;id&#x27;])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(),[&#x27;month&#x27;])]&quot;, &quot;program_id&quot;: &quot;expression[GET(FILTER_DICT(),[&#x27;program_id&#x27;])]&quot;, &quot;provide_id&quot;: &quot;expression[GET(FILTER_DICT(),[&#x27;provide_id&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;show_warning&quot;, &quot;action&quot;: &quot;SHOW_WARNING&quot;, &quot;entry_condition&quot;: &quot;expression[EQ(GET(RES(&#x27;detail_api_single&#x27;), [&#x27;success&#x27;]), false)]&quot;, &quot;options&quot;: &#123; &quot;content&quot;: &quot;expression[GET(RES(&#x27;detail_api_single&#x27;), [&#x27;msg&#x27;])]&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;open_dialog_single&quot;, &quot;action&quot;: &quot;COMMON_LIST_DIALOG&quot;, &quot;entry_condition&quot;: &quot;expression[EQ(GET(RES(&#x27;back_api&#x27;),[&#x27;length&#x27;]),1)]&quot;, &quot;options&quot;: &#123; &quot;component&quot;: &quot;hc-category-list-selector&quot;, &quot;filter_dict&quot;: &#123; &quot;result.month&quot;: &quot;expression[GET(FILTER_DICT(),[&#x27;month&#x27;])]&quot;, &quot;plan_id&quot;: &quot;expression[GET(FINDBYINDEX(RES(&#x27;back_api&#x27;),0),[&#x27;id&#x27;])]&quot;, &quot;budget_program_id&quot;: &quot;expression[GET(FINDBYINDEX(RES(&#x27;back_api&#x27;),0),[&#x27;budget_program_id&#x27;])]&quot;, &quot;id&quot;: &quot;expression[LIST_GET(RES(&#x27;detail_api_single&#x27;),&#x27;budget_detail_id&#x27;)]&quot; &#125;, &quot;size&quot;: &quot;max&quot;, &quot;model&quot;: &quot;expression[&#x27;budget_detail.&#x27;+GET(FINDBYINDEX(RES(&#x27;back_api&#x27;),0),[&#x27;budget_program_id&#x27;])]&quot;, &quot;state&quot;: &quot;warning_result&quot;, &quot;selector_type&quot;: 0, &quot;title&quot;: &quot;expression[&#x27;【&#x27;+GET(FINDBYINDEX(RES(&#x27;back_api&#x27;),0),[&#x27;name&#x27;])+&#x27;】&#x27;+&#x27;超预警预算执行情况&#x27;]&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;dialog_multi_items&quot;, &quot;entry_condition&quot;: &quot;expression[NEQ(GET(RES(&#x27;back_api&#x27;),[&#x27;length&#x27;]),1)]&quot;, &quot;action&quot;: &quot;COMMON_LIST_DIALOG&quot;, &quot;options&quot;: &#123; &quot;component&quot;: &quot;hc-category-list-selector&quot;, &quot;filter_dict&quot;: &#123; &quot;id&quot;: &quot;expression[LIST_GET(RES(&#x27;back_api&#x27;),&#x27;id&#x27;)]&quot; &#125;, &quot;size&quot;: &quot;max&quot;, &quot;model&quot;: &quot;BudgetPlan&quot;, &quot;state&quot;: &quot;warning_data&quot;, &quot;selector_type&quot;: 0, &quot;title&quot;: &quot;超预警预算计划&quot; &#125; &#125; ] &#125;, &#123; &quot;key&quot;: &quot;special_import&quot;, &quot;action&quot;: &quot;COMMON_IMPORT&quot;, &quot;label&quot;: &quot;累计附加扣除项目导入&quot;, &quot;hide&quot;: &quot;=!(!SCOPE.auth.company_setting.is_third_service_by_tax_return_calculate &amp;&amp; SCOPE.auth.company_setting.disable_salary_multi_calculate)&quot;, &quot;meta_disabled&quot;: false, &quot;data&quot;: &#123; &quot;category&quot;: &quot;TaxSalaryRealSpecial&quot;, &quot;import_class&quot;: &quot;apps.salary.tax.tax_return.services.TaxSalaryRealSpecialImportServices&quot;, &quot;title&quot;: &quot;累计附加扣除项目导入&quot;, &quot;category_name&quot;: &quot;累计附加扣除项目导入&quot;, &quot;is_from_config&quot;: true, &quot;impMethod&quot;: 2, &quot;imp_tips&quot;: [ &quot;建议每次导入间隔2分钟。&quot; ], &quot;choose_method&quot;: false, &quot;show_business_key&quot;: false, &quot;extend_property&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(ENV(), [&#x27;program_id&#x27;])]&quot;, &quot;salary_month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;calculate_print&quot;, &quot;label&quot;: &quot;打印&quot;, &quot;hide&quot;: true, &quot;actions&quot;: [ &#123; &quot;key&quot;: &quot;format_setting&quot;, &quot;label&quot;: &quot;格式设置&quot;, &quot;action&quot;: &quot;DYNAMIC_INFO&quot;, &quot;params&quot;: &#123; &quot;async&quot;: true, &quot;model&quot;: &quot;SalaryCalcPrintFormat&quot;, &quot;data&quot;: &quot;=function()&#123;SCOPE;return dataService.callHcmOpenApi(&#x27;salary.calculate.data.print.format&#x27;,&#123;&#x27;program_id&#x27;:SCOPE.customEnvironmentParams.program_id&#125;)&#125;&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;print&quot;, &quot;label&quot;: &quot;打印&quot;, &quot;func&quot;: &quot;=function()&#123; let config_value = [];if (SCOPE.advance_query.current_plan) &#123; if (SCOPE.advance_query.current_plan.config) &#123;if (SCOPE.advance_query.current_plan.config.display_setting) &#123;config_value = SCOPE.advance_query.current_plan.config.display_setting;&#125;&#125;&#125;dataService.callHcmOpenApi(&#x27;salary.calculate.data.print.by.html&#x27;,&#123;&#x27;filter_dict&#x27;:SCOPE.getAllFilterDict(),&#x27;print_setting&#x27;:config_value,&#x27;_meta&#x27;:SCOPE.list_model.columns.filter(x =&gt; !x.hide &amp;&amp; x.key!==&#x27;is_sealed&#x27; &amp;&amp; x.key!==&#x27;send_status&#x27; &amp;&amp; x.key!==&#x27;is_locked&#x27; ),&#x27;employee_ids&#x27;:SCOPE.list_model.selected_items.map(v=&gt;&#123;return v.employee_id;&#125;),&#x27;filter_str&#x27;:SCOPE.advance_query.filter_str,&#x27;extra_property&#x27;: SCOPE.getExtraProperty()&#125;).then(function(data)&#123;const printWindow = WINDOW.open(&#x27; &#x27;);printWindow.document.write(data);printWindow.document.close();printWindow.print();printWindow.close();&#125;)&#125;&quot; &#125; ] &#125;, &#123; &quot;key&quot;: &quot;todo&quot;, &quot;hide&quot;: true &#125;, &#123; &quot;key&quot;: &quot;is_include&quot;, &quot;hide&quot;: true &#125;, &#123; &quot;key&quot;: &quot;no_profile&quot;, &quot;hide&quot;: true &#125;, &#123; &quot;key&quot;: &quot;batch_modify&quot;, &quot;hide&quot;: true &#125;, &#123; &quot;key&quot;: &quot;import&quot;, &quot;hide&quot;: true &#125;, &#123; &quot;key&quot;: &quot;export&quot;, &quot;hide&quot;: true &#125;, &#123; &quot;key&quot;: &quot;import_standard&quot;, &quot;hide&quot;: true &#125;, &#123; &quot;key&quot;: &quot;import_cost&quot;, &quot;hide&quot;: true &#125;, &#123; &quot;key&quot;: &quot;import_periodic&quot;, &quot;hide&quot;: true &#125;, &#123; &quot;key&quot;: &quot;viewDetail&quot;, &quot;hide&quot;: true, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;get_program_item&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;hcm.model.get&quot;, &quot;params&quot;: &#123; &quot;model&quot;: &quot;SalaryProgramItem&quot;, &quot;id_&quot;: &quot;expression[GET(RES(&#x27;clicked_field&#x27;), [&#x27;origin&#x27;,&#x27;id&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;open_list&quot;, &quot;action&quot;: &quot;COMMON_LIST_DIALOG&quot;, &quot;options&quot;: &#123; &quot;component&quot;: &quot;hc-category-list-selector&quot;, &quot;model&quot;: &quot;SalaryDataEntry&quot;, &quot;state&quot;: &quot;salary_calculate&quot;, &quot;page_size&quot;: 200, &quot;title&quot;: &quot;expression[IF(OR(EQ(GET(SELECT_ITEM(), [&#x27;data&#x27;,GET(RES(&#x27;clicked_field&#x27;), [&#x27;origin&#x27;,&#x27;number&#x27;]), &#x27;is_locked&#x27;]), 1),EQ(GET(SELECT_ITEM(), [&#x27;is_locked&#x27;]), 1)),GET(SELECT_ITEM(), [&#x27;employee&#x27;,&#x27;name&#x27;]) + &#x27; &#x27; + GET(RES(&#x27;clicked_field&#x27;), [&#x27;origin&#x27;,&#x27;name&#x27;])+&#x27;已锁定&#x27;,GET(SELECT_ITEM(), [&#x27;employee&#x27;,&#x27;name&#x27;]) + &#x27; &#x27; + GET(RES(&#x27;clicked_field&#x27;), [&#x27;origin&#x27;,&#x27;name&#x27;]))]&quot;, &quot;selectorType&quot;: 0, &quot;program_item&quot;: &quot;expression[RES(&#x27;get_program_item&#x27;)]&quot;, &quot;filter_dict&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(SELECT_ITEM(), [&#x27;program_id&#x27;])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;program_item_id&quot;: &quot;expression[GET(RES(&#x27;clicked_field&#x27;), [&#x27;origin&#x27;,&#x27;id&#x27;])]&quot;, &quot;employee_id&quot;: &quot;expression[GET(SELECT_ITEM(), [&#x27;employee_id&#x27;])]&quot;, &quot;provide_id&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;provide_id&#x27;])]&quot;, &quot;depart_id&quot;: &quot;expression[GET(SELECT_ITEM(), [&#x27;depart_id&#x27;])]&quot;, &quot;position_id&quot;: &quot;expression[GET(SELECT_ITEM(), [&#x27;position_id&#x27;])]&quot;, &quot;pay_program_id&quot;: &quot;expression[IF(GET(STR_SPLIT(GET(ENV(), [&#x27;model_meta&#x27;, &#x27;model&#x27;]),&#x27;+&#x27;),[2]),GET(STR_SPLIT(GET(ENV(), [&#x27;model_meta&#x27;, &#x27;model&#x27;]),&#x27;+&#x27;),[2]), null)]&quot;, &quot;data_precision&quot;: &quot;expression[GET(RES(&#x27;get_program_item&#x27;), [&#x27;decimal_count&#x27;])]&quot; &#125;, &quot;is_operate&quot;: true, &quot;edit_permission&quot;: &quot;expression[IF(EQ(GET(SELECT_ITEM(), [&#x27;status&#x27;,&#x27;is_sealed&#x27;]), 1), false, IF(EQ(GET(SELECT_ITEM(), [&#x27;inst&#x27;,&#x27;status&#x27;]), 1), false, true))]&quot;, &quot;lock_status&quot;: &quot;expression[IF(OR(EQ(GET(SELECT_ITEM(), [&#x27;data&#x27;,GET(RES(&#x27;clicked_field&#x27;), [&#x27;origin&#x27;,&#x27;number&#x27;]), &#x27;is_locked&#x27;]), 1),EQ(GET(SELECT_ITEM(), [&#x27;is_locked&#x27;]), 1)),true,false)]&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;get_detail&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.detail&quot;, &quot;params&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(STR_SPLIT(GET(ENV(), [&#x27;model_meta&#x27;, &#x27;model&#x27;]),&#x27;+&#x27;),[1])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;program_item_id&quot;: &quot;expression[GET(RES(&#x27;clicked_field&#x27;), [&#x27;origin&#x27;,&#x27;id&#x27;])]&quot;, &quot;employee_id&quot;: &quot;expression[GET(SELECT_ITEM(), [&#x27;employee_id&#x27;])]&quot;, &quot;provide_id&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;provide_id&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;refresh_status&quot;, &quot;label&quot;: &quot;刷新状态&quot;, &quot;action&quot;: &quot;REFRESH&quot; &#125; ], &quot;condition&quot;: &quot;ITEM&quot; &#125;, &#123; &quot;key&quot;: &quot;viewOtherTypeDetail&quot;, &quot;hide&quot;: true, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;get_detail&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.detail&quot;, &quot;params&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(STR_SPLIT(GET(ENV(), [&#x27;model_meta&#x27;, &#x27;model&#x27;]),&#x27;+&#x27;),[1])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;program_item_id&quot;: &quot;expression[GET(RES(&#x27;clicked_field&#x27;), [&#x27;origin&#x27;,&#x27;id&#x27;])]&quot;, &quot;employee_id&quot;: &quot;expression[GET(SELECT_ITEM(), [&#x27;employee_id&#x27;])]&quot;, &quot;provide_id&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;provide_id&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;get_item&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;hcm.model.get&quot;, &quot;params&quot;: &#123; &quot;model&quot;: &quot;SalaryProgramItem&quot;, &quot;id_&quot;: &quot;expression[GET(RES(&#x27;clicked_field&#x27;), [&#x27;origin&#x27;,&#x27;id&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;open_list&quot;, &quot;action&quot;: &quot;COMMON_INFO_DIALOG&quot;, &quot;options&quot;: &#123; &quot;component&quot;: &quot;hc-category-list-selector&quot;, &quot;model&quot;: &quot;SalaryDataDetail&quot;, &quot;state&quot;: &quot;expression[IF(EQ(GET(RES(&#x27;get_item&#x27;),[&#x27;data_type&#x27;]),2),&#x27;three&#x27;, IF(EQ(GET(RES(&#x27;get_item&#x27;),[&#x27;data_type&#x27;]), 1), IF(EQ(GET(RES(&#x27;get_item&#x27;),[&#x27;refer_model&#x27;]), null),&#x27;second&#x27;, &#x27;select_second&#x27;),&#x27;select_second&#x27;))]&quot;, &quot;page_size&quot;: 200, &quot;title&quot;: &quot;expression[IF(OR(EQ(GET(SELECT_ITEM(), [&#x27;data&#x27;,GET(RES(&#x27;clicked_field&#x27;), [&#x27;origin&#x27;,&#x27;number&#x27;]), &#x27;is_locked&#x27;]), 1),EQ(GET(SELECT_ITEM(), [&#x27;is_locked&#x27;]), 1)),GET(SELECT_ITEM(), [&#x27;employee&#x27;,&#x27;name&#x27;]) + &#x27; &#x27; + GET(RES(&#x27;clicked_field&#x27;), [&#x27;origin&#x27;,&#x27;name&#x27;])+&#x27;已锁定&#x27;,GET(SELECT_ITEM(), [&#x27;employee&#x27;,&#x27;name&#x27;]) + &#x27; &#x27; + GET(RES(&#x27;clicked_field&#x27;), [&#x27;origin&#x27;,&#x27;name&#x27;]))]&quot;, &quot;selectorType&quot;: 0, &quot;detail_id&quot;: &quot;expression[GET(RES(&#x27;get_detail&#x27;), [&#x27;detail_id&#x27;])]&quot;, &quot;related_model&quot;: &quot;expression[GET(RES(&#x27;get_detail&#x27;), [&#x27;detail_id&#x27;])]&quot;, &quot;data&quot;: &#123; &quot;detail_id&quot;: &quot;expression[GET(RES(&#x27;get_detail&#x27;), [&#x27;detail_id&#x27;])]&quot;, &quot;program_item_id&quot;: &quot;expression[GET(RES(&#x27;clicked_field&#x27;), [&#x27;origin&#x27;,&#x27;id&#x27;])]&quot;, &quot;program_id&quot;: &quot;expression[GET(SELECT_ITEM(), [&#x27;program_id&#x27;])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;employee_id&quot;: &quot;expression[GET(SELECT_ITEM(), [&#x27;employee_id&#x27;])]&quot;, &quot;provide_id&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;provide_id&#x27;])]&quot;, &quot;depart_id&quot;: &quot;expression[GET(SELECT_ITEM(), [&#x27;depart_id&#x27;])]&quot;, &quot;position_id&quot;: &quot;expression[GET(SELECT_ITEM(), [&#x27;position_id&#x27;])]&quot;, &quot;value&quot;: &quot;expression[IF(EQ(GET(RES(&#x27;clicked_field&#x27;), [&#x27;origin&#x27;,&#x27;data_type&#x27;]), 3),IF(EQ(GET(RES(&#x27;get_detail&#x27;), [&#x27;detail_id&#x27;]), 0),null,GET(RES(&#x27;get_detail&#x27;), [&#x27;value&#x27;])),GET(SELECT_ITEM(), [&#x27;data&#x27;,GET(RES(&#x27;clicked_field&#x27;), [&#x27;origin&#x27;,&#x27;number&#x27;]), &#x27;value&#x27;]))]&quot;, &quot;select_model&quot;: &quot;expression[IF(GET(RES(&#x27;get_item&#x27;), [&#x27;related_model&#x27;]),GET(RES(&#x27;get_item&#x27;), [&#x27;related_model&#x27;]),GET(RES(&#x27;get_item&#x27;), [&#x27;refer_model&#x27;]))]&quot;, &quot;is_lock&quot;: &quot;expression[GET(SELECT_ITEM(), [&#x27;is_locked&#x27;])]&quot;, &quot;info_title&quot;: &quot;expression[IF(OR(EQ(GET(SELECT_ITEM(), [&#x27;data&#x27;,GET(RES(&#x27;clicked_field&#x27;), [&#x27;origin&#x27;,&#x27;number&#x27;]), &#x27;is_locked&#x27;]), 1),EQ(GET(SELECT_ITEM(), [&#x27;is_locked&#x27;]), 1)),GET(SELECT_ITEM(), [&#x27;employee&#x27;,&#x27;name&#x27;]) + &#x27; &#x27; + GET(RES(&#x27;clicked_field&#x27;), [&#x27;origin&#x27;,&#x27;name&#x27;])+&#x27;已锁定&#x27;,GET(SELECT_ITEM(), [&#x27;employee&#x27;,&#x27;name&#x27;]) + &#x27; &#x27; + GET(RES(&#x27;clicked_field&#x27;), [&#x27;origin&#x27;,&#x27;name&#x27;]))]&quot; &#125;, &quot;filter_dict&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(SELECT_ITEM(), [&#x27;program_id&#x27;])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;program_item_id&quot;: &quot;expression[GET(RES(&#x27;clicked_field&#x27;), [&#x27;origin&#x27;,&#x27;id&#x27;])]&quot;, &quot;employee_id&quot;: &quot;expression[GET(SELECT_ITEM(), [&#x27;employee_id&#x27;])]&quot;, &quot;provide_id&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;provide_id&#x27;])]&quot;, &quot;depart_id&quot;: &quot;expression[GET(SELECT_ITEM(), [&#x27;depart_id&#x27;])]&quot;, &quot;position_id&quot;: &quot;expression[GET(SELECT_ITEM(), [&#x27;position_id&#x27;])]&quot; &#125;, &quot;is_operate&quot;: true, &quot;edit_permission&quot;: &quot;expression[IF(EQ(GET(SELECT_ITEM(), [&#x27;status&#x27;,&#x27;is_sealed&#x27;]), 1), false, IF(EQ(GET(SELECT_ITEM(), [&#x27;inst&#x27;,&#x27;status&#x27;]), 1), false, true))]&quot;, &quot;lock_status&quot;: &quot;expression[IF(OR(EQ(GET(SELECT_ITEM(), [&#x27;data&#x27;,GET(RES(&#x27;clicked_field&#x27;), [&#x27;origin&#x27;,&#x27;number&#x27;]), &#x27;is_locked&#x27;]), 1),EQ(GET(SELECT_ITEM(), [&#x27;is_locked&#x27;]), 1)),true,false)]&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;refresh_status&quot;, &quot;label&quot;: &quot;刷新状态&quot;, &quot;action&quot;: &quot;REFRESH&quot; &#125; ], &quot;condition&quot;: &quot;ITEM&quot; &#125;, &#123; &quot;key&quot;: &quot;viewBalanceDetail&quot;, &quot;hide&quot;: true, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;open_list&quot;, &quot;action&quot;: &quot;COMMON_INFO_DIALOG&quot;, &quot;options&quot;: &#123; &quot;component&quot;: &quot;hc-category-list-selector&quot;, &quot;model&quot;: &quot;SalaryDataBalance&quot;, &quot;state&quot;: &quot;expression[&#x27;balance&#x27; + &#x27;+&#x27; + GET(RES(&#x27;clicked_field&#x27;), [&#x27;key&#x27;]) + &#x27;+&#x27; + GET(SELECT_ITEM(), [&#x27;is_locked&#x27;]) + &#x27;+&#x27; + GET(SELECT_ITEM(), [&#x27;employee&#x27;,&#x27;name&#x27;])]&quot;, &quot;page_size&quot;: 200, &quot;title&quot;: &quot;expression[IF(EQ(GET(SELECT_ITEM(), [&#x27;is_locked&#x27;]), 1),GET(SELECT_ITEM(), [&#x27;employee&#x27;,&#x27;name&#x27;]) + &#x27; &#x27; + GET(RES(&#x27;clicked_field&#x27;), [&#x27;origin&#x27;,&#x27;name&#x27;])+&#x27;已锁定&#x27;,GET(SELECT_ITEM(), [&#x27;employee&#x27;,&#x27;name&#x27;]) + &#x27; &#x27; + GET(RES(&#x27;clicked_field&#x27;), [&#x27;origin&#x27;,&#x27;name&#x27;]))]&quot;, &quot;selectorType&quot;: 0, &quot;detail_id&quot;: &quot;expression[GET(RES(&#x27;get_detail&#x27;), [&#x27;detail_id&#x27;])]&quot;, &quot;related_model&quot;: &quot;expression[GET(RES(&#x27;get_detail&#x27;), [&#x27;detail_id&#x27;])]&quot;, &quot;data&quot;: &quot;expression[GET(SELECT_ITEM(), [&#x27;balance&#x27;])]&quot;, &quot;alter&quot;: &#123; &quot;balance_id&quot;: &quot;expression[GET(SELECT_ITEM(), [&#x27;balance&#x27;,&#x27;id&#x27;])]&quot;, &quot;program_item_id&quot;: &quot;expression[GET(RES(&#x27;clicked_field&#x27;), [&#x27;origin&#x27;,&#x27;id&#x27;])]&quot;, &quot;program_id&quot;: &quot;expression[GET(SELECT_ITEM(), [&#x27;program_id&#x27;])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;employee_id&quot;: &quot;expression[GET(SELECT_ITEM(), [&#x27;employee_id&#x27;])]&quot;, &quot;provide_id&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;provide_id&#x27;])]&quot;, &quot;depart_id&quot;: &quot;expression[GET(SELECT_ITEM(), [&#x27;depart_id&#x27;])]&quot;, &quot;position_id&quot;: &quot;expression[GET(SELECT_ITEM(), [&#x27;position_id&#x27;])]&quot;, &quot;value&quot;: &quot;expression[GET(SELECT_ITEM(), [&#x27;data&#x27;,GET(RES(&#x27;clicked_field&#x27;), [&#x27;origin&#x27;,&#x27;number&#x27;]), &#x27;value&#x27;])]&quot;, &quot;pay_program_id&quot;: &quot;expression[IF(GET(STR_SPLIT(GET(ENV(), [&#x27;model_meta&#x27;, &#x27;model&#x27;]),&#x27;+&#x27;),[2]),GET(STR_SPLIT(GET(ENV(), [&#x27;model_meta&#x27;, &#x27;model&#x27;]),&#x27;+&#x27;),[2]), null)]&quot; &#125;, &quot;filter_dict&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(SELECT_ITEM(), [&#x27;program_id&#x27;])]&quot;, &quot;month&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;])]&quot;, &quot;program_item_id&quot;: &quot;expression[GET(RES(&#x27;clicked_field&#x27;), [&#x27;origin&#x27;,&#x27;id&#x27;])]&quot;, &quot;employee_id&quot;: &quot;expression[GET(SELECT_ITEM(), [&#x27;employee_id&#x27;])]&quot;, &quot;provide_id&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;provide_id&#x27;])]&quot;, &quot;depart_id&quot;: &quot;expression[GET(SELECT_ITEM(), [&#x27;depart_id&#x27;])]&quot;, &quot;position_id&quot;: &quot;expression[GET(SELECT_ITEM(), [&#x27;position_id&#x27;])]&quot;, &quot;pay_program_id&quot;: &quot;expression[IF(GET(STR_SPLIT(GET(ENV(), [&#x27;model_meta&#x27;, &#x27;model&#x27;]),&#x27;+&#x27;),[2]),GET(STR_SPLIT(GET(ENV(), [&#x27;model_meta&#x27;, &#x27;model&#x27;]),&#x27;+&#x27;),[2]), null)]&quot; &#125;, &quot;is_operate&quot;: true, &quot;edit_permission&quot;: &quot;expression[IF(EQ(GET(SELECT_ITEM(), [&#x27;status&#x27;,&#x27;is_sealed&#x27;]), 1), false, IF(EQ(GET(SELECT_ITEM(), [&#x27;inst&#x27;,&#x27;status&#x27;]), 1), false, true))]&quot;, &quot;lock_status&quot;: &quot;expression[IF(OR(EQ(GET(SELECT_ITEM(), [&#x27;data&#x27;,GET(RES(&#x27;clicked_field&#x27;), [&#x27;origin&#x27;,&#x27;number&#x27;]), &#x27;is_locked&#x27;]), 1),EQ(GET(SELECT_ITEM(), [&#x27;is_locked&#x27;]), 1)),true,false)]&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;refresh_status&quot;, &quot;label&quot;: &quot;刷新状态&quot;, &quot;action&quot;: &quot;REFRESH&quot; &#125; ], &quot;condition&quot;: &quot;ITEM&quot; &#125;, &#123; &quot;key&quot;: &quot;next&quot;, &quot;label&quot;: &quot;下一步&quot;, &quot;confirm&quot;: true, &quot;hide&quot;: &quot;=function()&#123;if(SCOPE.hcm_navigation_items)&#123;let current_key=JSON.parse(STATE.params.custom_params).key;if(SCOPE.hcm_navigation_items[SCOPE.hcm_navigation_items.length-1].key === current_key)&#123;return true;&#125;else&#123;if(SCOPE.hcm_navigation_items.filter(v=&gt;v.key == current_key)[0].status == &#x27;finish&#x27;)&#123;return true;&#125;else&#123;if(SCOPE.hcm_navigation_items[SCOPE.hcm_navigation_items.findIndex(v=&gt;v.key==current_key)-1].status == &#x27;finish&#x27;)&#123;return false;&#125;else&#123;return true;&#125;&#125;&#125;&#125;else&#123;return true;&#125;&#125;&quot;, &quot;confirm_tip&quot;: &quot;确认本步骤已完成？&quot;, &quot;func&quot;: &quot;=function()&#123;SCOPE;STATE;data=JSON.parse(STATE.params.custom_params);dataService.callHcmOpenApi(&#x27;salary.guide.setting.jump.fix.step&#x27;,&#123;&#x27;provide_id&#x27;:data.provide_id, &#x27;program_id&#x27;:data.program_id, &#x27;month&#x27;:data.month, &#x27;step_key&#x27;:data.key,&#x27;jump_type&#x27;: 1&#125;).then(function(_result)&#123;if(!_result)&#123;location.reload();return true;&#125;for(var i = 0; i &lt; SCOPE.hcm_navigation_items.length; i++)&#123;if(SCOPE.hcm_navigation_items[i].key==_result.step_key)&#123;SCOPE.hcm_navigation_items[i].status=&#x27;process&#x27;;SCOPE.hcm_navigation_items[i-1].status=&#x27;finish&#x27;&#125;&#125;SCOPE.super_go(_result.jump_type,_result.param,&#123;location: &#x27;replace&#x27;, animator: &#x27;none-animation&#x27;,inherit: false&#125;)&#125;);setTimeout(()=&gt;&#123;SCOPE.setNavigationCurrent()&#125;, 1000)&#125;&quot; &#125;, &#123; &quot;key&quot;: &quot;previous&quot;, &quot;hide&quot;: &quot;=function()&#123;if(SCOPE.hcm_navigation_items)&#123;let current_key=JSON.parse(STATE.params.custom_params).key; if(SCOPE.hcm_navigation_items.filter(v=&gt;v.key == current_key)[0].status == &#x27;finish&#x27;)&#123;return true;&#125;else&#123;if(SCOPE.hcm_navigation_items[SCOPE.hcm_navigation_items.findIndex(v=&gt;v.key==current_key)-1].status == &#x27;finish&#x27;)&#123;return false;&#125;else&#123;return true;&#125;&#125;&#125;else&#123;return true;&#125;&#125;&quot;, &quot;label&quot;: &quot;上一步&quot;, &quot;func&quot;: &quot;=function()&#123;SCOPE;STATE;data=JSON.parse(STATE.params.custom_params);dataService.callHcmOpenApi(&#x27;salary.guide.setting.jump.fix.step&#x27;,&#123;&#x27;provide_id&#x27;:data.provide_id, &#x27;program_id&#x27;:data.program_id, &#x27;month&#x27;:data.month, &#x27;step_key&#x27;:data.key,&#x27;jump_type&#x27;: -1&#125;).then(function(_result)&#123;if(!_result)&#123;location.reload();return true;&#125;for(var i = 0; i &lt; SCOPE.hcm_navigation_items.length; i++)&#123;if(SCOPE.hcm_navigation_items[i].key==_result.step_key)&#123;SCOPE.hcm_navigation_items[i].status=&#x27;process&#x27;;SCOPE.hcm_navigation_items[i+1].status=&#x27;&#x27;&#125;&#125;SCOPE.super_go(_result.jump_type,_result.param,&#123;location: &#x27;replace&#x27;, animator: &#x27;none-animation&#x27;,inherit: false&#125;)&#125;);setTimeout(()=&gt;&#123;SCOPE.setNavigationCurrent()&#125;, 1000)&#125;&quot; &#125;, &#123; &quot;key&quot;: &quot;step_finished&quot;, &quot;label&quot;: &quot;完成&quot;, &quot;hide&quot;: &quot;=function()&#123;SCOPE;if(SCOPE.hcm_navigation_items)&#123;if(SCOPE.hcm_navigation_items.filter(v=&gt;v.key == JSON.parse(STATE.params.custom_params).key)[0].status == &#x27;finish&#x27;)&#123;return true;&#125;else&#123;if(SCOPE.hcm_navigation_items[SCOPE.hcm_navigation_items.length-2].status == &#x27;finish&#x27;)&#123;return false;&#125;else&#123;return true;&#125;&#125;&#125;else&#123;return true;&#125;&#125;&quot;, &quot;func&quot;: &quot;=function()&#123;SCOPE;STATE;data=JSON.parse(STATE.params.custom_params);dataService.callHcmOpenApi(&#x27;salary.guide.setting.jump.fix.step&#x27;,&#123;&#x27;provide_id&#x27;:data.provide_id, &#x27;program_id&#x27;:data.program_id, &#x27;month&#x27;:data.month, &#x27;step_key&#x27;:data.key,&#x27;jump_type&#x27;: 1&#125;).then(function(_result)&#123;if(!_result)&#123;for(var i = 0; i &lt; SCOPE.hcm_navigation_items.length; i++)&#123;if(SCOPE.hcm_navigation_items[i].key==data.key)&#123;SCOPE.hcm_navigation_items[i].status=&#x27;finish&#x27;;&#125;&#125;location.reload();return true;&#125;&#125;)&#125;&quot; &#125;, &#123; &quot;key&quot;: &quot;step_cancel&quot;, &quot;label&quot;: &quot;取消完成&quot;, &quot;confirm_tip&quot;: &quot;是否确认取消完成？&quot;, &quot;hide&quot;: &quot;=function()&#123;SCOPE;if(SCOPE.hcm_navigation_items &amp;&amp; SCOPE.hcm_navigation_items[SCOPE.hcm_navigation_items.length-1].key===JSON.parse(STATE.params.custom_params).key&amp;&amp;SCOPE.hcm_navigation_items.filter(v=&gt;v.key == JSON.parse(STATE.params.custom_params).key)[0].status == &#x27;finish&#x27;)&#123;return false;&#125;else&#123;return true;&#125;&#125;&quot;, &quot;func&quot;: &quot;=function()&#123;SCOPE;STATE;data=JSON.parse(STATE.params.custom_params);dataService.callHcmOpenApi(&#x27;salary.guide.setting.step.cancel&#x27;,&#123;&#x27;provide_id&#x27;:data.provide_id, &#x27;program_id&#x27;:data.program_id,&#x27;month&#x27;:data.month&#125;).then(function()&#123;location.reload();&#125;)&#125;&quot; &#125;, &#123; &quot;key&quot;: &quot;init_params&quot;, &quot;label&quot;: &quot;初始化界面参数使用&quot;, &quot;hide&quot;: true, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;get_is_multi&quot;, &quot;entry_condition&quot;: &quot;expression[GET(AUTH(), [&#x27;company_setting&#x27;, &#x27;is_send_salary_bill_message&#x27;])]&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;hcm.model.get&quot;, &quot;params&quot;: &#123; &quot;model&quot;: &quot;SalaryProgram&quot;, &quot;id_&quot;: &quot;expression[GET(STR_SPLIT(GET(ENV(), [&#x27;model_meta&#x27;, &#x27;model&#x27;]),&#x27;+&#x27;),[1])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;init_params&quot;, &quot;action&quot;: &quot;SET_ENV&quot;, &quot;options&quot;: &#123; &quot;params&quot;: &#123; &quot;meta_change&quot;: true, &quot;program_id&quot;: &quot;expression[GET(STR_SPLIT(GET(ENV(), [&#x27;model_meta&#x27;, &#x27;model&#x27;]),&#x27;+&#x27;),[1])]&quot;, &quot;multiple_calc&quot;: &quot;expression[GET(RES(&#x27;get_is_multi&#x27;), [&#x27;is_multi&#x27;])]&quot;, &quot;is_approve&quot;: &quot;expression[GET(RES(&#x27;get_is_multi&#x27;), [&#x27;is_approve&#x27;])]&quot;, &quot;source_provide_id&quot;: &quot;expression[IF(GET(STR_SPLIT(GET(ENV(), [&#x27;model_meta&#x27;, &#x27;model&#x27;]),&#x27;+&#x27;),[2]),GET(STR_SPLIT(GET(ENV(), [&#x27;model_meta&#x27;, &#x27;model&#x27;]),&#x27;+&#x27;),[2]), null)]&quot; &#125; &#125; &#125; ] &#125;, &#123; &quot;key&quot;: &quot;EnterDeductionPenalty&quot;, &quot;label&quot;: &quot;录入扣罚&quot;, &quot;condition&quot;: &quot;MULTI_ITEM&quot;, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;enter_penalty&quot;, &quot;action&quot;: &quot;COMMON_LIST_DIALOG&quot;, &quot;options&quot;: &#123; &quot;component&quot;: &quot;hc-category-list-selector&quot;, &quot;model&quot;: &quot;U_YearEndBonus&quot;, &quot;page_size&quot;: 200, &quot;title&quot;: &quot;录入扣罚&quot;, &quot;dialog_options&quot;: &#123; &quot;resolveOnClose&quot;: true &#125;, &quot;filter_dict&quot;: &#123; &quot;employee_id&quot;: &quot;expression[SELECT_ITEMS().map((item)=&gt;&#123;return item.employee_id&#125;)]&quot;, &quot;distribution_year&quot;: &quot;expression[GET(FILTER_DICT(), [&#x27;month&#x27;]).split(&#x27;-&#x27;)[0]]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;can_calc1&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.can.calc.employee&quot;, &quot;params&quot;: &#123; &quot;filter_dict&quot;: &quot;expression[OBJ_MERGE(FILTER_DICT(), OBJ_PICK(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;extra_property&quot;: &quot;expression[GET(ENV(), [&#x27;extra_property&#x27;])]&quot;, &quot;employee_ids&quot;: &quot;expression[IF(GET(SELECT_ITEMS(), [0]),LIST_GET(SELECT_ITEMS(), &#x27;employee_id&#x27;), null)]&quot;, &quot;calc_type&quot;: 2 &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;on_calc2&quot;, &quot;validators&quot;: [ &#123; &quot;validator&quot;: &quot;expression[NEQ(GET(RES(&#x27;can_calc1&#x27;), [&#x27;can_calc&#x27;]), true)]&quot;, &quot;tips&quot;: &quot;未找到可计算数据，数据已锁定或已封存!&quot; &#125; ], &quot;action&quot;: &quot;WEBSOCKET_ACTION&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.calc.sync.count.notify&quot;, &quot;params&quot;: &#123; &quot;filter_dict&quot;: &quot;expression[OBJ_MERGE(FILTER_DICT(), OBJ_PICK(ENV(), [&#x27;program_id&#x27;]))]&quot;, &quot;extra_property&quot;: &quot;expression[GET(ENV(), [&#x27;extra_property&#x27;])]&quot;, &quot;employee_ids&quot;: &quot;expression[IF(GET(SELECT_ITEMS(), [0]),LIST_GET(SELECT_ITEMS(), &#x27;employee_id&#x27;), null)]&quot;, &quot;formula_ids&quot;: &quot;expression[IF(GET(RES(&#x27;open_list&#x27;), [0]),LIST_GET(RES(&#x27;open_list&#x27;), &#x27;id&#x27;), null)]&quot; &#125; &#125; &#125; ] &#125; ], &quot;childs&quot;: [], &quot;relations&quot;: [ &#123; &quot;filter&quot;: &#123; &quot;employee.id&quot;: &quot;:employee_id&quot; &#125;, &quot;model&quot;: &quot;Employee&quot;, &quot;name&quot;: &quot;人员基础信息&quot;, &quot;key&quot;: &quot;employee&quot;, &quot;blur&quot;: [ &quot;identity_card&quot; ], &quot;type&quot;: &quot;outer&quot; &#125;, &#123; &quot;filter&quot;: &#123; &quot;salary_b.id&quot;: &quot;:salary_bank&quot; &#125;, &quot;model&quot;: &quot;SalaryBank&quot;, &quot;name&quot;: &quot;银行信息&quot;, &quot;key&quot;: &quot;salary_b&quot;, &quot;blur&quot;: [ &quot;name&quot; ], &quot;type&quot;: &quot;outer&quot; &#125;, &#123; &quot;filter&quot;: &#123; &quot;status.employee_id&quot;: &quot;:employee_id&quot;, &quot;status.program_id&quot;: &quot;:program_id&quot; &#125;, &quot;model&quot;: &quot;SalaryDataStatus&quot;, &quot;key&quot;: &quot;status&quot;, &quot;type&quot;: &quot;outer&quot; &#125;, &#123; &quot;filter&quot;: &#123; &quot;inst.id&quot;: &quot;:status.inst_id&quot; &#125;, &quot;model&quot;: &quot;SalaryProgramInstance&quot;, &quot;key&quot;: &quot;inst&quot;, &quot;type&quot;: &quot;outer&quot; &#125;, &#123; &quot;filter&quot;: &#123; &quot;job_info.employee_id&quot;: &quot;:employee_id&quot;, &quot;job_info.position_type&quot;: 1, &quot;job_info.begin_date&quot;: &#123; &quot;lte&quot;: &quot;=date_&quot; &#125;, &quot;job_info.end_date&quot;: &#123; &quot;gt&quot;: &quot;=date_&quot; &#125; &#125;, &quot;model&quot;: &quot;JobInformation&quot;, &quot;name&quot;: &quot;任职信息&quot;, &quot;key&quot;: &quot;job_info&quot; &#125;, &#123; &quot;filter&quot;: &#123; &quot;job_info.position_id&quot;: &quot;:position.origin_id&quot;, &quot;position.begin_date&quot;: &#123; &quot;lte&quot;: &quot;=date_&quot; &#125;, &quot;position.end_date&quot;: &#123; &quot;gt&quot;: &quot;=date_&quot; &#125; &#125;, &quot;model&quot;: &quot;OrgPositionHistory&quot;, &quot;type&quot;: &quot;outer&quot;, &quot;name&quot;: &quot;岗位信息&quot;, &quot;key&quot;: &quot;position&quot;, &quot;blur&quot;: [ &quot;name&quot; ] &#125;, &#123; &quot;filter&quot;: &#123; &quot;depart_id&quot;: &quot;:department.origin_id&quot;, &quot;department.begin_date&quot;: &#123; &quot;lte&quot;: &quot;=date_&quot; &#125;, &quot;department.end_date&quot;: &#123; &quot;gt&quot;: &quot;=date_&quot; &#125; &#125;, &quot;model&quot;: &quot;OrgDepartmentHistory&quot;, &quot;type&quot;: &quot;outer&quot;, &quot;name&quot;: &quot;部门信息&quot;, &quot;key&quot;: &quot;department&quot; &#125;, &#123; &quot;filter&quot;: &#123; &quot;employee_id&quot;: &quot;:tax_return.employee_id&quot;, &quot;tax_company_id&quot;: &quot;:tax_return.tax_company_id&quot;, &quot;tax_return.tax_month&quot;: &quot;=month&quot; &#125;, &quot;model&quot;: &quot;TaxReturnData&quot;, &quot;key&quot;: &quot;tax_return&quot;, &quot;type&quot;: &quot;outer&quot;, &quot;name&quot;: &quot;个税计算&quot; &#125; ], &quot;filters&quot;: [ &#123; &quot;key&quot;: &quot;program_id&quot;, &quot;sequence&quot;: 10, &quot;label&quot;: &quot;薪酬方案&quot;, &quot;component&quot;: &quot;hc-super-selector&quot;, &quot;options&quot;: &#123; &quot;width&quot;: &quot;col-4&quot;, &quot;default&quot;: &quot;=function()&#123;if(STATE.params.flag_state === &#x27;provide_work_plat&#x27; || (STATE.params.custom_params &amp;&amp; JSON.parse(STATE.params.custom_params).flag_state === &#x27;provide_work_plat&#x27;) || STATE.params.program_id)&#123;return STATE.params.program_id ||parseInt(SCOPE.model_meta.model.split(&#x27;.&#x27;)[1])|| JSON.parse(STATE.params.custom_params).program_id;&#125;else&#123;if(SCOPE.model_meta.model.split(&#x27;.&#x27;)[0] == &#x27;salary_calculate_multi_data&#x27;)&#123;return parseInt(SCOPE.model_meta.model.split(&#x27;.&#x27;)[1]);&#125;&#125;&#125;&quot;, &quot;readOnly&quot;: &quot;=function()&#123;if(STATE.params.flag_state==&#x27;program_work_plat&#x27; || SCOPE.model_meta.model.split(&#x27;.&#x27;)[0] == &#x27;salary_calculate_multi_data&#x27; || (STATE.params.custom_params &amp;&amp; JSON.parse(STATE.params.custom_params).flag_state === &#x27;program_work_plat&#x27;) || STATE.params.flag_state==&#x27;provide_work_plat&#x27; || (STATE.params.custom_params &amp;&amp; JSON.parse(STATE.params.custom_params).flag_state === &#x27;provide_work_plat&#x27;) || SCOPE.dirtyModify.status == 1)&#123;return true;&#125;else&#123;return false&#125;&#125;&quot;, &quot;hide&quot;: &quot;=function()&#123;if(STATE.params.flag_state==&#x27;program_work_plat&#x27; || (STATE.params.custom_params &amp;&amp; JSON.parse(STATE.params.custom_params).flag_state === &#x27;program_work_plat&#x27;) || STATE.params.flag_state==&#x27;provide_work_plat&#x27; || (STATE.params.custom_params &amp;&amp; JSON.parse(STATE.params.custom_params).flag_state === &#x27;provide_work_plat&#x27;) || SCOPE.dirtyModify.status == 1)&#123;return false;&#125;else&#123;if(SCOPE.auth.company_setting[&#x27;disable_future_salary_calculate&#x27;])&#123;return true;&#125;&#125;&#125;&quot;, &quot;required&quot;: true, &quot;singleLine&quot;: true, &quot;multi&quot;: false, &quot;includeAll&quot;: false, &quot;placeholder&quot;: &quot;薪酬方案&quot;, &quot;selectorModel&quot;: &quot;SalaryProgram&quot;, &quot;hasNull&quot;: false, &quot;no_delete&quot;: true, &quot;extra_property&quot;: &#123; &quot;state&quot;: &quot;calc&quot;, &quot;sorts&quot;: [ &#123; &quot;key&quot;: &quot;number&quot;, &quot;type&quot;: &quot;asc&quot; &#125; ] &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;pay_program_id&quot;, &quot;sequence&quot;: 20, &quot;label&quot;: &quot;发放方案&quot;, &quot;component&quot;: &quot;hc-super-selector&quot;, &quot;options&quot;: &#123; &quot;hide&quot;: &quot;=function()&#123;return !SCOPE.multiple_calc&#125;&quot;, &quot;width&quot;: &quot;col-4&quot;, &quot;multi&quot;: false, &quot;singleLine&quot;: true, &quot;includeAll&quot;: false, &quot;placeholder&quot;: &quot;发放方案&quot;, &quot;hasNull&quot;: false, &quot;selectorModel&quot;: &quot;SalaryPayProgram&quot;, &quot;selectorFilter&quot;: &quot;=function () &#123;return &#123;&#x27;program_id&#x27;: SCOPE.advance_query.query_model.data.program_id&#125;&#125;&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;provide_id&quot;, &quot;sequence&quot;: 21, &quot;label&quot;: &quot;发放活动&quot;, &quot;component&quot;: &quot;hc-super-selector&quot;, &quot;options&quot;: &#123; &quot;hide&quot;: &quot;=function()&#123;if(STATE.params.flag_state==&#x27;provide_work_plat&#x27; || (STATE.params.custom_params &amp;&amp; JSON.parse(STATE.params.custom_params).flag_state === &#x27;provide_work_plat&#x27;))&#123;return false;&#125;else&#123;return true&#125;&#125;&quot;, &quot;default&quot;: &quot;=function()&#123;if(STATE.params.flag_state === &#x27;provide_work_plat&#x27; || (STATE.params.custom_params &amp;&amp; JSON.parse(STATE.params.custom_params).flag_state === &#x27;provide_work_plat&#x27;))&#123;return STATE.params.provide_id || JSON.parse(STATE.params.custom_params).provide_id;&#125;&#125;&quot;, &quot;readOnly&quot;: true, &quot;width&quot;: &quot;col-4&quot;, &quot;multi&quot;: false, &quot;singleLine&quot;: true, &quot;includeAll&quot;: false, &quot;placeholder&quot;: &quot;发放活动&quot;, &quot;hasNull&quot;: false, &quot;selectorModel&quot;: &quot;SalaryProvide&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;month&quot;, &quot;sequence&quot;: 30, &quot;label&quot;: &quot;月份&quot;, &quot;plan_exclude&quot;: true, &quot;component&quot;: &quot;hc-input-datetime&quot;, &quot;options&quot;: &#123; &quot;readOnly&quot;: &quot;=function()&#123;if(STATE.params.flag_state==&#x27;program_work_plat&#x27; || (STATE.params.custom_params &amp;&amp; JSON.parse(STATE.params.custom_params).flag_state === &#x27;program_work_plat&#x27;) || STATE.params.flag_state==&#x27;provide_work_plat&#x27; || (STATE.params.custom_params &amp;&amp; JSON.parse(STATE.params.custom_params).flag_state === &#x27;provide_work_plat&#x27;) || SCOPE.dirtyModify.status == 1)&#123;return true;&#125;else&#123;return false&#125;&#125;&quot;, &quot;default&quot;: &quot;=function()&#123;STATE; if(STATE.params.month!==undefined)&#123;return STATE.params.month;&#125;else&#123;if(STATE.params.custom_params!==undefined)&#123;return JSON.parse(STATE.params.custom_params).month || MOMENT().format(&#x27;YYYY-MM&#x27;);&#125;else&#123;return MOMENT().format(&#x27;YYYY-MM&#x27;);&#125;&#125;&#125;&quot;, &quot;width&quot;: &quot;col-4&quot;, &quot;singleLine&quot;: true, &quot;inputLock&quot;: true, &quot;format&quot;: &quot;yyyy-MM&quot;, &quot;placeholder&quot;: &quot;月份&quot;, &quot;required&quot;: true, &quot;no_trans_query&quot;: true &#125; &#125;, &#123; &quot;key&quot;: &quot;depart_id&quot;, &quot;sequence&quot;: 40, &quot;label&quot;: &quot;部门&quot;, &quot;component&quot;: &quot;hc-standard-tree-selector&quot;, &quot;options&quot;: &#123; &quot;placeholder&quot;: &quot;部门&quot;, &quot;width&quot;: &quot;col-4&quot;, &quot;singleLine&quot;: true, &quot;selectorModel&quot;: &quot;OrgDepartment&quot;, &quot;extra_property&quot;: &#123; &quot;role&quot;: &quot;cm-salary.business_specialist&quot; &#125;, &quot;auto_select&quot;: false, &quot;child_include&quot;: true, &quot;effect_date&quot;: &quot;=function()&#123;var a=SCOPE.advance_query.query_model.data.month; var b=a.substr(0,4);var c= a.substr(5,2); var end_date= new Date(b, c, 1); var final_date = (new Date(end_date.getTime() - 1000 * 60 * 60 * 24)).getDate(); result_date=a+&#x27;-&#x27;+final_date.toString(); return result_date;&#125;&quot;, &quot;mode&quot;: &quot;new&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;withhold_agent&quot;, &quot;sequence&quot;: 50, &quot;label&quot;: &quot;扣缴义务人&quot;, &quot;component&quot;: &quot;hc-super-selector&quot;, &quot;options&quot;: &#123; &quot;width&quot;: &quot;col-4&quot;, &quot;singleLine&quot;: true, &quot;multi&quot;: false, &quot;selectorModel&quot;: &quot;ContractFirstParty&quot;, &quot;includeAll&quot;: false, &quot;placeholder&quot;: &quot;扣缴义务人&quot;, &quot;hide&quot;: &quot;=SCOPE.auth.company_setting[&#x27;disable_salary_multi_calculate&#x27;]&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;tax_company_id&quot;, &quot;sequence&quot;: 50, &quot;label&quot;: &quot;扣缴义务人&quot;, &quot;component&quot;: &quot;hc-super-selector&quot;, &quot;options&quot;: &#123; &quot;width&quot;: &quot;col-4&quot;, &quot;hide&quot;: &quot;=!SCOPE.auth.company_setting[&#x27;disable_salary_multi_calculate&#x27;]&quot;, &quot;singleLine&quot;: true, &quot;multi&quot;: false, &quot;selectorModel&quot;: &quot;TaxCompany&quot;, &quot;extra_property&quot;: &#123; &quot;state&quot;: &quot;filter&quot;, &quot;sorts&quot;: [ &#123; &quot;key&quot;: &quot;number&quot;, &quot;type&quot;: &quot;asc&quot; &#125; ] &#125;, &quot;includeAll&quot;: false, &quot;placeholder&quot;: &quot;扣缴义务人&quot; &#125; &#125; ], &quot;static_filters&quot;: [], &quot;sorts&quot;: [ &#123; &quot;key&quot;: &quot;id&quot;, &quot;type&quot;: &quot;asc&quot;, &quot;sequence&quot;: 1000 &#125; ], &quot;conditions&quot;: &#123;&#125;, &quot;role&quot;: &#123;&#125;, &quot;default_filter_dict&quot;: &#123;&#125;, &quot;advance_query&quot;: &#123; &quot;default_meta_length&quot;: 5, &quot;enabled&quot;: true, &quot;disabled_query_str&quot;: true &#125;, &quot;analyse&quot;: &#123;&#125;, &quot;list_config&quot;: &#123; &quot;selector_type&quot;: 2, &quot;stat_config&quot;: &#123; &quot;stat_mode&quot;: &quot;table-footer&quot; &#125;, &quot;title&quot;: &quot;=(STATE.params.title|| (STATE.params.custom_params &amp;&amp; JSON.parse(STATE.params.custom_params).title))&quot;, &quot;page_change&quot;: &#123; &quot;readOnly&quot;: &quot;=function()&#123;if(STATE.params.flag_state==&#x27;program_work_plat&#x27;||(STATE.params.custom_params &amp;&amp; JSON.parse(STATE.params.custom_params).flag_state === &#x27;program_work_plat&#x27;) || STATE.params.flag_state==&#x27;provide_work_plat&#x27; || (STATE.params.custom_params &amp;&amp; JSON.parse(STATE.params.custom_params).flag_state === &#x27;provide_work_plat&#x27;) || SCOPE.dirtyModify.status == 1)&#123;return true;&#125;else&#123;return false&#125;&#125;&quot; &#125; &#125;, &quot;description&quot;: &quot;薪酬数据&quot;, &quot;data_plugins&quot;: [ &#123; &quot;name&quot;: &quot;DataSplitting&quot;, &quot;key&quot;: &quot;DataSplitting&quot; &#125; ], &quot;tree&quot;: &#123;&#125;, &quot;least_relations&quot;: null, &quot;relation_mode&quot;: null, &quot;count_async&quot;: null, &quot;column_defs&quot;: &#123;&#125;, &quot;functional_state&quot;: [], &quot;force_w&quot;: null, &quot;extend&quot;: [], &quot;hooks&quot;: &#123; &quot;beforeFetchDataAsync&quot;: &quot;=function(env)&#123;SCOPE;STATE;SCOPE.is_approve = SCOPE.getEnvironmentParams().is_approve; SCOPE.multiple_calc = SCOPE.getEnvironmentParams().multiple_calc;SCOPE.advance_query.filter_dict[&#x27;program_id&#x27;]=parseInt(SCOPE.model_meta.model.split(&#x27;.&#x27;)[1]);if(SCOPE.auth.company_setting[&#x27;disable_salary_multi_calculate&#x27;] === false)&#123;return true;&#125;if(SCOPE.pre_program_id)&#123;if(SCOPE.pre_program_id!==SCOPE.advance_query.query_model.data.program_id)&#123;if(SCOPE.changeFlag)&#123;SCOPE.init_s = null;SCOPE.init_m = null;SCOPE.pre_program_id=SCOPE.advance_query.query_model.data.program_id;SCOPE.changeFlag=false;&#125;else&#123;SCOPE.changeFlag=true;&#125;&#125;&#125;else&#123;SCOPE.pre_program_id=SCOPE.advance_query.query_model.data.program_id&#125; var all_meta=SCOPE.advance_query.all_list_meta; var b = SCOPE.advance_query.query_model.data.month;var p = SCOPE.advance_query.display_setting; if(SCOPE.advance_query.current_plan===null)&#123; SCOPE.list_meta = [].concat(SCOPE.model_meta.fields); &#125; var a = SCOPE.list_meta.filter(v =&gt; v.field !== null &amp;&amp; v.field !== undefined).filter(v =&gt; v.field.length === 3 &amp;&amp; v.field[0] === &#x27;data&#x27;);if(!SCOPE.init_m || SCOPE.customEnvironmentParams.meta_change === true)&#123;SCOPE.init_m = JSON.parse(JSON.stringify(SCOPE.list_meta))&#125;if(p !== null &amp;&amp; p !== undefined)&#123;for (var i = 0; i &lt; p.length; i++)&#123;var exist_p = SCOPE.list_meta.filter(v=&gt;v.key == p[i].key);if(exist_p.length&lt;=0)&#123;var add_fix=all_meta.filter(v=&gt;v.key ==p[i].key);if(add_fix.length&gt;0)&#123;p[i][&#x27;field&#x27;]=add_fix[0].field; p[i][&#x27;label&#x27;]=add_fix[0].label;&#125; p[i].hide = false; SCOPE.list_meta.push(p[i]);&#125;else&#123;exist_p[0].hide=p[i].hide;&#125;var fix_d = SCOPE.init_m.filter(v=&gt;v.field !== null &amp;&amp; v.field !== undefined).filter(v=&gt;v.field.length === 3 &amp;&amp; v.field[0] === &#x27;data&#x27;);if(fix_d.length &gt; 0)&#123;var fix_p = fix_d.filter(v=&gt;v.key == p[i].key);if(fix_p.length &gt; 0)&#123;if(fix_p[0].origin.end_month &gt;= b)&#123;if(fix_p[0].hide === true)&#123;p[i].hide=true;&#125;else&#123;p[i].hide = false;&#125;&#125;else&#123;p[i].hide = true;&#125;&#125;&#125;&#125;&#125;for(var i = 0; i &lt; a.length; i++) &#123;if (a[i].origin.end_month &gt;= b) &#123;var fix_a = SCOPE.init_m.filter(v=&gt;v.key === a[i].key);if(p !== null &amp;&amp; p !== undefined)&#123;var fix_c = p.filter(v=&gt;v.key === a[i].key);if(fix_c.length &gt; 0)&#123;if(fix_c[0].hide === true)&#123;a[i].hide = true&#125;else&#123;a[i].hide = false;a[i].fixed=fix_c[0].fixed;a[i].sequence=fix_c[0].sequence;&#125;&#125;else&#123;a[i].hide=true;&#125;&#125;else&#123;if (fix_a[0].hide !== true)&#123;a[i].hide = false;a[i].sequence = fix_a[0].sequence;&#125;else&#123;a[i].hide = false;&#125;&#125;&#125;else&#123;a[i].hide = true;&#125;&#125;var compare_setting = [].concat(SCOPE.list_meta);if(p !== null &amp;&amp; p !== undefined)&#123;var t=SCOPE.list_meta;var fix_t = SCOPE.init_m.filter(v=&gt;v.field !== null &amp;&amp; v.field !== undefined).filter(v=&gt;v.field.length === 3 &amp;&amp; v.field[0] === &#x27;data&#x27;);for (var i = 0; i &lt; t.length; i++)&#123;var fix_preset = fix_t.filter(v=&gt;v.key === t[i].key);if(t[i].key===&#x27;program_id&#x27; || t[i].key===&#x27;month&#x27; || t[i].key===&#x27;withhold_agent&#x27; || t[i].key===&#x27;pay_program_id&#x27; || t[i].key===&#x27;tax_company_id&#x27;)&#123;continue;&#125;if(fix_preset.length &lt;= 0)&#123;var preset_p = p.filter(v=&gt;v.key === t[i].key);if(preset_p.length&gt;0)&#123;var preset_m = SCOPE.init_m.filter(v=&gt;v.key === t[i].key);if(preset_m.length &gt; 0)&#123;if(preset_m[0].hide == true)&#123;t[i].hide = true;&#125;else&#123;t[i].hide = false;t[i].sequence=preset_p[0].sequence;t[i].fixed=preset_p[0].fixed;&#125;&#125;&#125;else&#123;t[i].hide = true; compare_setting = compare_setting.filter(function(item)&#123;return item.key!==t[i].key&#125;);&#125;&#125;&#125;&#125;else&#123;var t = SCOPE.list_meta;var fix_t = SCOPE.init_m.filter(v=&gt;v.field !== null &amp;&amp; v.field !== undefined).filter(v=&gt;v.field.length === 3 &amp;&amp; v.field[0] === &#x27;data&#x27;);for (var i = 0; i &lt; t.length; i++) &#123;var fix_preset = fix_t.filter(v=&gt;v.key === t[i].key);if (t[i].key === &#x27;program_id&#x27; || t[i].key === &#x27;month&#x27; || t[i].key === &#x27;withhold_agent&#x27; || t[i].key === &#x27;pay_program_id&#x27; || t[i].key === &#x27;tax_company_id&#x27;) &#123;continue;&#125;if (fix_preset.length &lt;= 0) &#123;var preset_m = SCOPE.init_m.filter(v=&gt;v.key === t[i].key);if (preset_m.length &gt; 0) &#123;if (preset_m[0].hide == true) &#123;t[i].hide = true;&#125; else &#123;t[i].hide = false; t[i].sequence = preset_m[0].sequence;&#125;&#125;&#125;&#125;&#125; SCOPE.list_meta=compare_setting; if(!SCOPE.init_s || SCOPE.customEnvironmentParams.meta_change === true)&#123;SCOPE.init_s = [].concat(SCOPE.stat_meta);&#125;var k = [].concat(SCOPE.init_s);m = [];for(var j = 0; j &lt; k.length; j++)&#123;if(k[j].end_month === undefined)&#123;m.push(k[j]);&#125;else&#123;if(k[j].end_month &gt;= b)&#123;m.push(k[j]);&#125;&#125;&#125;SCOPE.stat_meta=m; SCOPE.list_model.$setStatMeta(m);SCOPE.customEnvironmentParams.meta_change=false; SCOPE.setListColumns();return true;&#125;&quot;, &quot;metaLoadedAsync&quot;: &#123; &quot;action&quot;: &quot;init_params&quot; &#125; &#125;, &quot;modi_state&quot;: null, &quot;include&quot;: [], &quot;force_fields&quot;: [], &quot;execute_plan&quot;: [], &quot;plugins&quot;: [], &quot;meta_key&quot;: &quot;salary_calculate_data.+21636+109.meta.list.salary_calculate.json&quot;, &quot;model&quot;: &quot;salary_calculate_data.+21636+109&quot;, &quot;state&quot;: &quot;salary_calculate&quot;&#125;","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"046-自定义登录页面","slug":"项目/HCM教程/046-自定义登录页面","date":"2025-06-05T14:44:25.000Z","updated":"2025-09-09T06:19:59.337Z","comments":true,"path":"2025/06/05/项目/HCM教程/046-自定义登录页面/","link":"","permalink":"https://dbbruce.github.io/2025/06/05/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/046-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2/","excerpt":"自定义登录页面 wiki: https://wiki.hcmcloud.cn/spaces/DEV/pages/65603069/自定义登录页面 https://tedatest.hcmcloud.cn/login_by_authorize?type=test","text":"自定义登录页面 wiki: https://wiki.hcmcloud.cn/spaces/DEV/pages/65603069/自定义登录页面 https://tedatest.hcmcloud.cn/login_by_authorize?type=test 套打上传-html模板 系统设置 - 基础服务 - 套打管理 - 套打管理 doc_index : “auto_2ca1fd7de485422886757aff0545ff74” 配置 - 公司级模板-json模版 - login_by_customer.json1234567891011&#123; &quot;emp&quot;: &#123; &quot;error_info&quot;: &quot;测试信息&quot;, &quot;html_index&quot;: &quot;ww1172c0b4e8160053_1dca5596-461b-11ec-b3f1-acde48001122&quot;, &quot;img_sign&quot;: &quot;93617d1e-4618-11ec-b3f1-acde48001122&quot; &#125;, &quot;test&quot;: &#123; &quot;error_info&quot;: &quot;测试信息222&quot;, &quot;html_index&quot;: &quot;auto_2ca1fd7de485422886757aff0545ff74&quot; &#125;&#125; 页面访问 域名+&#x2F;login_by_authorize?type&#x3D;emp 域名+&#x2F;login_by_authorize?type&#x3D;test","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"045-将三方登录二维码嵌入系统登录页面","slug":"项目/HCM教程/045-将三方登录二维码嵌入系统登录页面","date":"2025-06-05T13:44:25.000Z","updated":"2025-09-09T06:19:59.333Z","comments":true,"path":"2025/06/05/项目/HCM教程/045-将三方登录二维码嵌入系统登录页面/","link":"","permalink":"https://dbbruce.github.io/2025/06/05/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/045-%E5%B0%86%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95%E4%BA%8C%E7%BB%B4%E7%A0%81%E5%B5%8C%E5%85%A5%E7%B3%BB%E7%BB%9F%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2/","excerpt":"将三方登录二维码嵌入系统登录页面 wiki: https://wiki.hcmcloud.cn/spaces/DEV/pages/49808302/%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2%E5%86%85%E5%B5%8C%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95%E4%BA%8C%E7%BB%B4%E7%A0%81 新增Json模板：more_login_method.json","text":"将三方登录二维码嵌入系统登录页面 wiki: https://wiki.hcmcloud.cn/spaces/DEV/pages/49808302/%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2%E5%86%85%E5%B5%8C%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95%E4%BA%8C%E7%BB%B4%E7%A0%81 新增Json模板：more_login_method.json 钉钉配置方法1234567891011121314151617181920212223242526272829303132333435363738 &#123; &quot;test&quot;: &#123; &quot;index&quot;: 1, &quot;img&quot;: &quot;ding&quot;, # 控制登录页钉钉图标 &quot;url&quot;: &quot;https://oapi.dingtalk.com/connect/qrconnect?appid=ding05gvn4rvbmxuvb4r&amp;response_type=code&amp;scope=snsapi_login&amp;state=STATE&amp;redirect_uri=http%3A%2F%2F27.223.11.43%3A15204%2Flogin%3Fsso%3Dding%26next%3D%252Fservice%252F%2523%252Findex%26hcm_id%3D899&quot;, # 需替换redirect_uri中编码前的域名 、 hcm_id （ 企业第三方绑定数据的id ） &quot;name&quot;: &quot;DD扫码登录1&quot;, &quot;default&quot;: &quot;QRCODE&quot;, &quot;in_page&quot;: 1, &quot;disable_switch&quot;: 0, &quot;sso_login_params&quot;: &#123; &quot;appid&quot;: &quot;ding05gvn4rvbmxuvb4r&quot;, # 对应钉钉的appKey &quot;redirect_uri&quot;: &quot;http%3A%2F%2F127.0.0.1%3A3000%2Flogin%3Fsso%3Dding%26next%3D%252Fservice%252F%2523%252Findex&quot;, # 需替换编码前的域名 &quot;third_type&quot;: &quot;dingtalk&quot;, # 第三方类型 &quot;goto&quot;: &quot;https://oapi.dingtalk.com/connect/oauth2/sns_authorize?appid=ding05gvn4rvbmxuvb4r&amp;response_type=code&amp;scope=snsapi_login&amp;state=STATE&amp;redirect_uri=http%3A%2F%2F127.0.0.1%3A3000%2Flogin%3Fsso%3Dding%26next%3D%252Fservice%252F%2523%252Findex&quot; # 需替换app_id ， redirect_uri中的域名 &#125;, &quot;disabled&quot;: 0, &quot;third_type&quot;: &quot;dingtalk&quot; &#125;&#125; 企业微信123456789101112131415161718192021222324&#123; &quot;test&quot;: &#123; &quot;index&quot;: 1, &quot;img&quot;: &quot;workweixin&quot;, &quot;url&quot;: &quot;https://open.work.weixin.qq.com/wwopen/sso/qrConnect?appid=ww22be02bdd05712b0&amp;agentid=1000028&amp;redirect_uri=https%3a%2f%2fhcm-release.hcmcloud.cn%2flogin%3fsso%3dwork_inner&amp;state=work_inner&quot;, &quot;name&quot;: &quot;企业微信扫码登录&quot;, &quot;default&quot;: &quot;QRCode&quot;, &quot;in_page&quot;: 1, &quot;disable_switch&quot;: 0, &quot;sso_login_params&quot;: &#123; &quot;appid&quot;: &quot;ww22be02bdd05712b0&quot;, &quot;agentid&quot;: 1000028, &quot;redirect_uri&quot;: &quot;https://hcm-release.hcmcloud.cn/login?sso=work_inner111&quot;, &quot;state&quot;: &quot;work_inner11&quot; &#125; &#125;, &quot;test_three1&quot;: &#123; &quot;name&quot;: &quot;微信&quot;, &quot;icon&quot;: &quot;img_circle_emmcloud_default120&quot;, &quot;third_type&quot;: &quot;emmcloud&quot;, &quot;url&quot;: &quot;&quot;, &quot;disabled&quot;: &quot;a&quot; &#125;&#125;","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"044-后端重定向html页面","slug":"项目/HCM教程/044-后端重定向html页面","date":"2025-06-05T12:44:25.000Z","updated":"2025-09-09T06:19:59.281Z","comments":true,"path":"2025/06/05/项目/HCM教程/044-后端重定向html页面/","link":"","permalink":"https://dbbruce.github.io/2025/06/05/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/044-%E5%90%8E%E7%AB%AF%E9%87%8D%E5%AE%9A%E5%90%91html%E9%A1%B5%E9%9D%A2/","excerpt":"后端重定向html页面 重定向入口：&#x2F;api&#x2F;render_api_page?config_key&#x3D;自定义&amp;参数1&#x3D;值1&amp;参数2&#x3D;值2 访问URL： https://tedatest.hcmcloud.cn/api/render_api_page?config_key=test1111&amp;id=1234&amp;name=李四999","text":"后端重定向html页面 重定向入口：&#x2F;api&#x2F;render_api_page?config_key&#x3D;自定义&amp;参数1&#x3D;值1&amp;参数2&#x3D;值2 访问URL： https://tedatest.hcmcloud.cn/api/render_api_page?config_key=test1111&amp;id=1234&amp;name=李四999 配置Json模板 hcm_customer_page.json config_key：test1111 模板名：ApprovalPage.html api.name: 云函数名 api.param: 参数123456789101112&#123; &quot;test1111&quot;: &#123; &quot;template&quot;: &quot;ApprovalPage.html&quot;, &quot;customer_data&quot;: &#123; &quot;api_name&quot;: &quot;private.get_test_params&quot;, &quot;api_param&quot;: &#123; &quot;id_&quot;: &quot;=id&quot;, &quot;name&quot;: &quot;=name&quot; &#125; &#125; &#125;&#125; 配置HTML模板 ApprovalPage.html 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145&lt;!DOCTYPE html&gt;&lt;html lang=&quot;zh-CN&quot;&gt;&lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt; &lt;title&gt;红色闪烁文字效果&lt;/title&gt; &lt;style&gt; * &#123; margin: 0; padding: 0; box-sizing: border-box; &#125; body &#123; display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #1a1a2e, #16213e); font-family: &#x27;Microsoft YaHei&#x27;, sans-serif; overflow: hidden; position: relative; &#125; .container &#123; text-align: center; padding: 30px; background: rgba(0, 0, 0, 0.7); border-radius: 15px; box-shadow: 0 0 30px rgba(255, 0, 0, 0.5); position: relative; z-index: 2; backdrop-filter: blur(5px); border: 1px solid rgba(255, 0, 0, 0.3); animation: border-pulse 3s infinite; &#125; .blinking-text &#123; font-size: 4.5rem; font-weight: bold; color: #ff0000; text-shadow: 0 0 10px rgba(255, 0, 0, 0.8); animation: blink 0.8s infinite; margin: 20px 0; &#125; .subtitle &#123; color: rgba(255, 255, 255, 0.7); font-size: 1.2rem; margin-top: 20px; max-width: 500px; line-height: 1.6; &#125; @keyframes blink &#123; 0% &#123; opacity: 1; &#125; 50% &#123; opacity: 0.2; text-shadow: 0 0 20px rgba(255, 0, 0, 1); &#125; 100% &#123; opacity: 1; &#125; &#125; @keyframes border-pulse &#123; 0% &#123; box-shadow: 0 0 15px rgba(255, 0, 0, 0.5); &#125; 50% &#123; box-shadow: 0 0 30px rgba(255, 0, 0, 0.8); &#125; 100% &#123; box-shadow: 0 0 15px rgba(255, 0, 0, 0.5); &#125; &#125; /* 装饰元素 */ .decoration &#123; position: absolute; z-index: 1; &#125; .circle &#123; width: 200px; height: 200px; border-radius: 50%; background: radial-gradient(circle, rgba(255, 0, 0, 0.3), transparent 70%); animation: float 12s infinite linear; &#125; .circle:nth-child(1) &#123; top: 10%; left: 15%; width: 150px; height: 150px; animation-duration: 15s; &#125; .circle:nth-child(2) &#123; bottom: 15%; right: 20%; width: 180px; height: 180px; animation-duration: 18s; &#125; .circle:nth-child(3) &#123; top: 40%; right: 10%; width: 100px; height: 100px; animation-duration: 10s; &#125; @keyframes float &#123; 0% &#123; transform: translate(0, 0) rotate(0deg); &#125; 25% &#123; transform: translate(20px, 20px) rotate(90deg); &#125; 50% &#123; transform: translate(40px, -20px) rotate(180deg); &#125; 75% &#123; transform: translate(-20px, 30px) rotate(270deg); &#125; 100% &#123; transform: translate(0, 0) rotate(360deg); &#125; &#125; /* 响应式设计 */ @media (max-width: 768px) &#123; .blinking-text &#123; font-size: 3rem; &#125; .container &#123; padding: 20px; margin: 0 20px; &#125; &#125; @media (max-width: 480px) &#123; .blinking-text &#123; font-size: 2.2rem; &#125; .subtitle &#123; font-size: 1rem; &#125; &#125; &lt;/style&gt;&lt;/head&gt;&lt;body&gt; &lt;!-- 主内容 --&gt; &lt;div class=&quot;container&quot;&gt; &lt;h1 class=&quot;blinking-text&quot;&gt;你好，&#123;&#123;name&#125;&#125;&lt;/h1&gt; &lt;/div&gt;&lt;/body&gt;&lt;/html&gt; 云函数 get_test_params 123456789101112131415161718class PrivateAPIService(BasePrivateApiService): &quot;&quot;&quot; 动态私有OpenAPI 使用方法 &quot;&quot;&quot; def execute(self, **kwargs): self.log(f&quot;kwargs-&#123;kwargs&#125;&quot;) name = kwargs.get(&#x27;name&#x27;, &#x27;0000&#x27;) return &#123;&quot;name&quot;:name, &quot;number&quot;:123123, &quot;title&quot;:&quot;测试html&quot;, &quot;message&quot;:&quot;消息1111&quot;, &quot;error_code&quot;:0&#125; def log(self, log_content): log_info = &#123; &quot;log_type&quot;: str(&#x27;demodone1&#x27;), &quot;create_time&quot;: datetime.datetime.now().strftime(&#x27;%Y-%m-%d %H:%M:%S&#x27;), &quot;record&quot;: str(log_content) &#125; CustomerUtil.call_open_api(&quot;hcm.model.create&quot;, &#123;&quot;model&quot;: &quot;hcm_flex_log_data.formula_log&quot;, &quot;info&quot;: log_info&#125;)","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"043-列表上显示合计","slug":"项目/HCM教程/043-列表上显示合计","date":"2025-06-04T12:44:25.000Z","updated":"2025-09-09T06:19:59.425Z","comments":true,"path":"2025/06/04/项目/HCM教程/043-列表上显示合计/","link":"","permalink":"https://dbbruce.github.io/2025/06/04/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/043-%E5%88%97%E8%A1%A8%E4%B8%8A%E6%98%BE%E7%A4%BA%E5%90%88%E8%AE%A1/","excerpt":"列表上显示合计","text":"列表上显示合计 配置123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172&quot;statistics&quot;: [ &#123; &quot;key&quot;: &quot;u_YFXZ&quot;, &quot;label&quot;: &quot;应付薪资&quot;, &quot;field&quot;: &quot;u_YFXZ&quot;, &quot;decimal&quot;: 2, &quot;type&quot;: &quot;sum&quot; &#125;, &#123; &quot;key&quot;: &quot;u_GRYL&quot;, &quot;label&quot;: &quot;求和项:养老&quot;, &quot;field&quot;: &quot;u_GRYL&quot;, &quot;decimal&quot;: 2, &quot;type&quot;: &quot;sum&quot; &#125;, &#123; &quot;key&quot;: &quot;u_YLIAO&quot;, &quot;label&quot;: &quot;求和项:医疗&quot;, &quot;field&quot;: &quot;u_YLIAO&quot;, &quot;decimal&quot;: 2, &quot;type&quot;: &quot;sum&quot; &#125;, &#123; &quot;key&quot;: &quot;u_GRSY&quot;, &quot;label&quot;: &quot;求和项:失业&quot;, &quot;field&quot;: &quot;u_GRSY&quot;, &quot;decimal&quot;: 2, &quot;type&quot;: &quot;sum&quot; &#125;, &#123; &quot;key&quot;: &quot;u_GRGJJ&quot;, &quot;label&quot;: &quot;求和项:公积金&quot;, &quot;field&quot;: &quot;u_GRGJJ&quot;, &quot;decimal&quot;: 2, &quot;type&quot;: &quot;sum&quot; &#125;, &#123; &quot;key&quot;: &quot;u_DEYL&quot;, &quot;label&quot;: &quot;求和项:大额&quot;, &quot;field&quot;: &quot;u_DEYL&quot;, &quot;decimal&quot;: 2, &quot;type&quot;: &quot;sum&quot; &#125;, &#123; &quot;key&quot;: &quot;u_KSHUI&quot;, &quot;label&quot;: &quot;求和项:扣税&quot;, &quot;field&quot;: &quot;u_KSHUI&quot;, &quot;decimal&quot;: 2, &quot;type&quot;: &quot;sum&quot; &#125;, &#123; &quot;key&quot;: &quot;u_QTA&quot;, &quot;label&quot;: &quot;求和项:其他&quot;, &quot;field&quot;: &quot;u_QTA&quot;, &quot;decimal&quot;: 2, &quot;type&quot;: &quot;sum&quot; &#125;, &#123; &quot;key&quot;: &quot;u_GHHF&quot;, &quot;label&quot;: &quot;求和项:工会会费&quot;, &quot;field&quot;: &quot;u_GHHF&quot;, &quot;decimal&quot;: 2, &quot;type&quot;: &quot;sum&quot; &#125;, &#123; &quot;key&quot;: &quot;u_SDXZ&quot;, &quot;label&quot;: &quot;求和项:实得薪资&quot;, &quot;field&quot;: &quot;u_SDXZ&quot;, &quot;decimal&quot;: 2, &quot;type&quot;: &quot;sum&quot; &#125;] 在列表最下面显示 12345&quot;list_config&quot;: &#123; &quot;stat_config&quot;: &#123; &quot;stat_mode&quot;: &quot;table-footer&quot; &#125;&#125;","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"042-按钮有返回信息","slug":"项目/HCM教程/042-按钮有返回信息","date":"2025-06-03T15:44:25.000Z","updated":"2025-09-09T06:19:59.400Z","comments":true,"path":"2025/06/03/项目/HCM教程/042-按钮有返回信息/","link":"","permalink":"https://dbbruce.github.io/2025/06/03/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/042-%E6%8C%89%E9%92%AE%E6%9C%89%E8%BF%94%E5%9B%9E%E4%BF%A1%E6%81%AF/","excerpt":"按钮有返回信息","text":"按钮有返回信息 按钮配置123456789101112131415161718192021222324252627282930313233343536373839404142434445&quot;actions&quot;:[ &#123; &quot;label&quot;: &quot;采集数据-外部&quot;, &quot;hide&quot;: false, &quot;key&quot;: &quot;generate_datas_report&quot;, &quot;roles&quot;: [ &quot;cm-salary&quot; ], &quot;is_important&quot;: true, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;generate_data&quot;, &quot;label&quot;: &quot;采集数据&quot;, &quot;action&quot;: &quot;OPEN_WEBSOCKET&quot;, &quot;condition&quot;: &quot;ITEM&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;private.CollectReportReports&quot;, &quot;beginTip&quot;: &quot;开始处理&quot;, &quot;completeTip&quot;: &quot;已完成&quot;, &quot;processingTitle&quot;: &quot;正在启动中&quot;, &quot;completeTitle&quot;: &quot;启动完成&quot;, &quot;autoClose&quot;: true, &quot;closeWaiting&quot;: 500, &quot;params&quot;: &#123; &quot;filter_month&quot;: &quot;expression[GET(FILTER_DICT(),[&#x27;u_month&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;show_warning_all&quot;, &quot;action&quot;: &quot;SHOW_WARNING&quot;, &quot;entry_condition&quot;: &quot;expression[RES(&#x27;generate_data&#x27;)]&quot;, &quot;options&quot;: &#123; &quot;content&quot;: &quot;expression[GET(RES(&#x27;generate_data&#x27;),[&#x27;msg&#x27;])]&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;refresh&quot;, &quot;label&quot;: &quot;刷新&quot;, &quot;action&quot;: &quot;REFRESH&quot; &#125; ] &#125;] 云函数123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365#!/usr/bin/env python# -*- coding: utf-8 -*-# @Time : 2024/9/8 9:45# @Author : 坤# @Content :实现的内容XXXXX# @File : 采集-上报.py&quot;&quot;&quot; 开发注意事项 1.禁止循环体里调用 查询、新增、修订、删除接口。--特殊需求需上报 2.日志记录 self.record() 测试完成后需删除 3.获取数据ID 要动态获取禁止写死 4.要判断空值 5.模型及流程的弹性字段建立时对关联人员，组织、岗位等的弹性字段须建立实体字段映射 6.代码项的数量不超过10个的尽量维护成枚举值，对于是否 维护成枚举值 0 ：否，1：是&quot;&quot;&quot;class CollectReportReports(BasePrivateApiService): def _get_orgunit_secondaryunit_id(self, sjztorg_code): &quot;&quot;&quot; 获取OrgUnit的ID &quot;&quot;&quot; record_list = ModelUtil.list( model=&quot;OrgUnit&quot;, filter_dict=&#123; &quot;number&quot;: sjztorg_code &#125;, extra_property=&#123;&quot;state&quot;: &quot;all&quot;&#125;, page_size=99999, page_index=1 ) if record_list: record_data = record_list[0] return record_data.get(&#x27;id&#x27;) else: return record_list def _get_secondary_unit_info(self, orgunit_id, u_org_code): &quot;&quot;&quot; 获取二级单位信息 &quot;&quot;&quot; record_list = ModelUtil.list( model=&quot;DepartmentHierarchy&quot;, filter_dict=&#123; &quot;department_id&quot;: orgunit_id, &quot;enabled&quot;: True &#125;, extra_property=&#123; &quot;fields&quot;: [ &#123;&quot;field&quot;: [&quot;l1.id&quot;], &quot;key&quot;: &quot;l1.id&quot;&#125;, &#123;&quot;field&quot;: [&quot;l1.name&quot;], &quot;key&quot;: &quot;l1.name&quot;&#125;, &#123;&quot;field&quot;: [&quot;l1.u_code&quot;], &quot;key&quot;: &quot;l1.u_code&quot;&#125;, &#123;&quot;field&quot;: [&quot;l1.u_gz_sorting_code&quot;], &quot;key&quot;: &quot;l1.u_gz_sorting_code&quot;&#125;, &#123;&quot;field&quot;: [&quot;level&quot;], &quot;key&quot;: &quot;level&quot;&#125; ] &#125;, page_size=99999, page_index=1 ) if str(record_list[0].get(&#x27;level&#x27;)) == &#x27;0&#x27;: self._format_log_content(&#x27;数据为一级部门&#x27;, f&quot;生成数据-子企业主数据编码[&#123;u_org_code&#125;]-单位id[&#123;orgunit_id&#125;]为一级部门！&quot;) orgunit_res = self._get_org_unit_info() return orgunit_res[0].get(&#x27;u_code&#x27;), orgunit_res[0].get(&#x27;u_gz_sorting_code&#x27;), orgunit_res[0].get(&#x27;id&#x27;) # self.log(f&#x27;record_list:&#123;record_list&#125;&#x27;) if record_list: hie_sec_data = record_list[0].get(&#x27;l1&#x27;) return hie_sec_data.get(&#x27;u_code&#x27;), hie_sec_data.get(&#x27;u_gz_sorting_code&#x27;), hie_sec_data.get(&#x27;id&#x27;) return record_list, record_list, record_list def _get_sorting_code(self, sjztorg_code): &quot;&quot;&quot; 获取手动排序码 &quot;&quot;&quot; record_list = ModelUtil.list( model= &quot;OrgUnit&quot;, filter_dict=&#123; &quot;number&quot;: sjztorg_code &#125;, extra_property=&#123;&quot;state&quot;: &quot;all&quot;&#125;, page_size=9999, page_index=1 ) self.record(&#x27;获取手动排序码[%s]:%s&#x27; % (sjztorg_code, record_list)) if record_list: return record_list[0].get(&#x27;u_gz_sorting_code&#x27;) else: return record_list def execute(self, notify=None, **kwargs): def update_state(_obj): if notify: notify(_obj) filter_month = kwargs.get(&quot;filter_month&quot;) if kwargs.get( &quot;filter_month&quot;) else DateTimeUtils.get_current_date_str()[0:7] # 过滤设置 update_state(dict(progress=0, message=&#x27;正在开始采集...&#x27;)) # 获取上报报表组织编码 nest_report_list = ModelUtil.list( model=&quot;NestReportCollectionScheme&quot;, filter_dict=&#123;&quot;number&quot;: &quot;GZW-001&quot;&#125;, extra_property=&#123; &quot;fields&quot;: [&#123;&quot;key&quot;: &quot;depart_id&quot;, &quot;field&quot;: [&quot;depart_id&quot;]&#125;], &#125; ) if not nest_report_list: update_state(dict(progress=100, message=&#x27;采集失败上报报表没有对应数据&#x27;)) return &#123;&quot;success&quot;: False, &quot;msg&quot;: &quot;采集失败上报报表没有对应数据&quot;&#125; report_depart_id = nest_report_list[0].get(&quot;depart_id&quot;) count_ids_list = ModelUtil.list(&quot;nestdata.GZW-001.0_5&quot;, &#123;&quot;report_depart_id&quot;: report_depart_id, &quot;report_period&quot;: filter_month&#125;, extra_property=&#123;&quot;only_id&quot;: True&#125;, page_size=10000000) if not count_ids_list: update_state(dict(progress=100, message=&#x27;没有找到需要采集的数据&#x27;)) return &#123;&quot;success&quot;: False, &quot;msg&quot;: &quot;没有找到需要采集的数据&quot;&#125; _groups = divide_list(count_ids_list, 1000) percent_ = 100 / len(_groups) index = 0 org_info_list = ModelUtil.list(&quot;ReportOrgInfo&quot;, &#123;&quot;u_month&quot;: filter_month, &quot;u_source_type&quot;: 1&#125;, extra_property=&#123; &quot;role&quot;: &quot;cm-salary&quot;, &quot;only_id&quot;: True &#125;, page_size=1000000) check_ids = [] for p in org_info_list: check_ids.append(p[&quot;id&quot;]) # 删除溯源表数据 ModelUtil.remove_batch(&quot;ReportOrgInfo&quot;, check_ids) for _group in _groups: ids = [p1[&quot;id&quot;] for p1 in _group] nest_list = ModelUtil.list( &quot;nestdata.GZW-001.0_5&quot;, &#123;&quot;report_depart_id&quot;: report_depart_id, &quot;id&quot;: ids, &quot;report_period&quot;: filter_month&#125;) # percent_ = 100 / len(nest_list) key_list = [&quot;object_key&quot;, &quot;report_period&quot;, &quot;report_depart_id&quot;, &quot;formula_data&quot;, &quot;id&quot;] # 单位查询统计 create_list = [] for nest in nest_list: self.record(nest) report_period = nest[&quot;report_period&quot;] # # 排序 nid = nest[&quot;id&quot;] uso_code = nest[&quot;u_sjzt_org_code&quot;] # report_depart_id = int(nest[&quot;report_depart_id&quot;]) if nest[&quot;report_depart_id&quot;] else None for key_ in key_list: del nest[key_] nest[&quot;check_status&quot;] = &quot;0&quot; # 未校验 nest[&quot;month&quot;] = report_period.replace(&quot;-&quot;, &quot;&quot;) if report_period else &quot;&quot; # 月份 nest[&quot;depart_id&quot;] = report_depart_id # 过滤月份 nest[&quot;u_source_type&quot;] = 1 nest[&quot;u_status&quot;] = &quot;1&quot; # 过滤月份 # 新增 # 表一的时间格式：&#x27;report_period&#x27;: &#x27;2024-12&#x27; nest.update(&#123;&quot;u_month&quot;: report_period if report_period else &quot;&quot;&#125; ) nest.update(&#123;&quot;u_enterprise_abbreviation&quot;: nest[&quot;org_refer_name&quot;] if nest[&quot;org_refer_name&quot;] else &quot;&quot;&#125; ) nest.update(&#123;&quot;u_sort_code&quot;: nest[&quot;sub_org_sort_code&quot;] if nest[&quot;sub_org_sort_code&quot;] else &quot;&quot;&#125; ) # u_sjzt_org_code--子企业主数据编码 orgunit_id = self._get_orgunit_secondaryunit_id(uso_code) # 根据OrgUnit.id获取：二级单位 ，手工排序码 u_secondaryunit_code, sq_num, did = self._get_secondary_unit_info(orgunit_id) nest[&quot;u_secondaryunit_code&quot;] = u_secondaryunit_code nest[&quot;depart_id&quot;] = did if not sq_num: return &#123;&quot;success&quot;: False ,&quot;msg&quot;: &#x27;获取排序码失败，停止采集!!!&#x27;&#125; # 调整顺序 new_bp_num = &#x27;0%s&#x27; % nid footer = new_bp_num.replace(&#x27; &#x27;, &#x27;&#x27;).rjust(5, &#x27;0&#x27;) num_bp_str = &#x27;%s%s&#x27; % (sq_num, footer) # nest.update(&#123;&quot;u_number_backup&quot;: int(num_bp_str)&#125;) nest.update(&#123;&quot;order_num&quot;: int(num_bp_str)&#125;) create_list.append(nest) ModelUtil.create_batch(&quot;ReportOrgInfo&quot;, create_list) index += 1 update_state( dict(progress=int(index * percent_), message=&quot;采集中，请稍后&quot;)) return &#123;&quot;success&quot;: True, &quot;msg&quot;: &#x27;采集成功&#x27;&#125; @staticmethod def get_fields(field_list): &quot;&quot;&quot; 拼接fields :param field_list: :return: &quot;&quot;&quot; result_list = [] for item in field_list: if item.find(&quot;.&quot;) == -1: result_list.append(&#123;&quot;field&quot;: [item], &quot;key&quot;: item&#125;) else: f_list = item.split(&quot;.&quot;) result_list.append(&#123;&quot;field&quot;: f_list, &quot;key&quot;: item&#125;) return result_list def hcm_db_flex_field_list(self, _model): return CustomerUtil.call_open_api( name=&quot;hcm.db.flex.field.list&quot;, param=&#123; &quot;model_name&quot;: _model, &quot;page_size&quot;: 999 &#125; )[&#x27;list&#x27;] def db_query(self, str_sql): api_name = &quot;command.conquer.limit&quot; return CustomerUtil.call_open_api( name=api_name, param=&#123; &quot;command&quot;: str_sql &#125; )[&quot;result&quot;] def hcm_model_get(self, model_, id_): &quot;&quot;&quot; 获取模型数据 :param model_: :param id_: :return: &quot;&quot;&quot; return CustomerUtil.call_open_api(&quot;hcm.model.get&quot;, &#123;&quot;model&quot;: model_, &quot;id_&quot;: id_&#125;) def hcm_model_list(self, filter_, model, extra_property=None, page_index=None, page_size=None): &quot;&quot;&quot; 获取模型数据 :param filter_: :param model: :param page_size: :param page_index: :param extra_property: :return: &quot;&quot;&quot; extra_ = extra_property if extra_property else &#123;&#125; extra_[&quot;only_list&quot;] = True page_index = page_index if page_index else 1 page_size = page_size if page_size else 10000 return CustomerUtil.call_open_api(&quot;hcm.model.list&quot;, &#123;&quot;model&quot;: model, &quot;page_size&quot;: page_size, &quot;page_index&quot;: page_index, &quot;filter_dict&quot;: filter_, &quot;extra_property&quot;: extra_&#125;)[&quot;list&quot;] def hcm_model_count(self, filter_, model, extra_property=None): &quot;&quot;&quot; 获取模型数据统计 :param filter_: :param model: :param extra_property: :return: &quot;&quot;&quot; extra_ = extra_property if extra_property else &#123;&#125; extra_[&quot;only_list&quot;] = True return CustomerUtil.call_open_api(&quot;hcm.model.count&quot;, &#123;&quot;model&quot;: model, &quot;filter_dict&quot;: filter_, &quot;count_by&quot;: &quot;id&quot;, &quot;extra_property&quot;: extra_&#125;)[&quot;list&quot;][0][&quot;id&quot;] def hcm_model_create(self, model, info): &quot;&quot;&quot; 新增模型数据 :param model: :param info: :return: &quot;&quot;&quot; return CustomerUtil.call_open_api(&quot;hcm.model.create&quot;, &#123;&quot;model&quot;: model, &quot;info&quot;: info&#125;) def hcm_model_create_batch(self, model, info_list): &quot;&quot;&quot; 批量新增模型数据 :param model: :param info_list: :return: &quot;&quot;&quot; if not info_list: return return CustomerUtil.call_open_api(&quot;hcm.model.create.batch&quot;, &#123;&quot;model&quot;: model, &quot;info_list&quot;: info_list&#125;)[&#x27;result&#x27;] def hcm_model_edit(self, model, info_, id_): &quot;&quot;&quot; 新增模型数据 :param model: :param info_: :param id_: :return: &quot;&quot;&quot; return CustomerUtil.call_open_api(&quot;hcm.model.edit&quot;, &#123;&quot;model&quot;: model, &quot;id_&quot;: id_, &quot;info&quot;: info_&#125;) def hcm_model_edit_batch(self, model, edit_list): &quot;&quot;&quot; 批量修改数据 :param model: :param edit_list: :return: &quot;&quot;&quot; if not edit_list: return return CustomerUtil.call_open_api(&quot;hcm.model.edit.batch&quot;, &#123;&quot;model&quot;: model, &quot;info_list&quot;: edit_list&#125;) def hcm_model_remove(self, model, id_): &quot;&quot;&quot; 删除数据 :param model: :param id_: :return: &quot;&quot;&quot; if not id_: return return CustomerUtil.call_open_api(&quot;hcm.model.remove&quot;, &#123;&quot;model&quot;: model, &quot;id_&quot;: id_&#125;) def hcm_model_remove_batch(self, model, ids): &quot;&quot;&quot; 批量删除数据 :param model: :param ids: :return: &quot;&quot;&quot; if not ids: return return CustomerUtil.call_open_api(&quot;hcm.model.remove.batch&quot;, &#123;&quot;model&quot;: model, &quot;ids&quot;: ids&#125;) def record(self, content, type_=3): &quot;&quot;&quot; 日志记录 :param content: 内容 :param type_: 2 异常 3 其他 :return: &quot;&quot;&quot; # employee_id=CustomerUtil.get_current_context().employee.id logging.info(content) company_id = CustomerUtil.get_current_context().company.id category = self.__class__.__name__ CustomerUtil.call_open_api( name=&quot;hcm.model.create&quot;, param=&#123; &quot;model&quot;: &quot;SyncOuterRecord&quot;, &quot;info&quot;: &#123; &quot;company_id&quot;: company_id, &quot;name&quot;: category, &quot;category&quot;: category, &quot;type&quot;: type_, &quot;content&quot;: &#123;&quot;content&quot;: &quot;&#123;&#125;&quot;.format(content)&#125;, &quot;update_time&quot;: datetime.datetime.now().strftime(&quot;%Y-%m-%d %H:%M:%S&quot;) &#125; &#125; )","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"041-按钮有弹窗","slug":"项目/HCM教程/041-按钮有弹窗","date":"2025-06-03T14:44:25.000Z","updated":"2025-09-09T06:19:59.329Z","comments":true,"path":"2025/06/03/项目/HCM教程/041-按钮有弹窗/","link":"","permalink":"https://dbbruce.github.io/2025/06/03/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/041-%E6%8C%89%E9%92%AE%E6%9C%89%E5%BC%B9%E7%AA%97/","excerpt":"按钮有弹窗-1","text":"按钮有弹窗-1 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980&quot;actions&quot;:[ &#123; &quot;key&quot;: &quot;db_make&quot;, &quot;label&quot;: &quot;生成DB文件&quot;, &quot;condition&quot;: &quot;ITEM&quot;, &quot;hide&quot;: false, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;ac0&quot;, &quot;action&quot;: &quot;SIMPLE_FORM&quot;, &quot;options&quot;: &#123; &quot;title&quot;: &quot;文件类型&quot;, &quot;form_options&quot;: &#123; &quot;size&quot;: &quot;small&quot; &#125;, &quot;meta&quot;: [ &#123; &quot;key&quot;: &quot;dsp_data_type&quot;, &quot;label&quot;: &quot;类型&quot;, &quot;component&quot;: &quot;hc-input-radio&quot;, &quot;options&quot;: &#123; &quot;default&quot;: &quot;Y&quot;, &quot;singleLine&quot;: true, &quot;list&quot;: [ &#123; &quot;name&quot;: &quot;正式&quot;, &quot;value&quot;: &quot;Y&quot; &#125;, &#123; &quot;name&quot;: &quot;测试&quot;, &quot;value&quot;: &quot;N&quot; &#125; ], &quot;items_inline&quot;: true &#125; &#125; ] &#125; &#125;, &#123; &quot;key&quot;: &quot;ac1&quot;, &quot;action&quot;: &quot;OPEN_WEBSOCKET&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.data.inst.operate&quot;, &quot;params&quot;: &#123; &quot;inst_id&quot;: &quot;expression[GET(SELECT_ITEM(),[&#x27;id&#x27;])]&quot;, &quot;command&quot;: &quot;sqlite_file&quot;, &quot;extra_params&quot;: &#123; &quot;dsp_data_type&quot;: &quot;expression[GET(RES(&#x27;ac0&#x27;),[&#x27;dsp_data_type&#x27;])]&quot; &#125; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;ac2&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;salary.db.make.summary.parse&quot;, &quot;params&quot;: &#123; &quot;inst_id&quot;: &quot;expression[GET(SELECT_ITEM(),[&#x27;id&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;ac3&quot;, &quot;action&quot;: &quot;DIALOG_CUSTOMER_HTML&quot;, &quot;options&quot;: &#123; &quot;bind_html&quot;: &quot;expression[RES(&#x27;ac2&#x27;)]&quot;, &quot;title&quot;: &quot;DB描述&quot;, &quot;size&quot;: &quot;small-middle&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;ac4&quot;, &quot;action&quot;: &quot;REFRESH&quot; &#125; ], &quot;sequence&quot;: 10 &#125;] 按钮有弹窗-2 实例2123456789101112131415161718192021222324252627282930313233343536373839404142434445464748&#123; &quot;label&quot;: &quot;上报2&quot;, &quot;key&quot;: &quot;generate_datas1&quot;, &quot;hide&quot;: false, &quot;roles&quot;: [ &quot;cm-salary&quot; ], &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;confirm&quot;, &quot;action&quot;: &quot;CONFIRM&quot;, &quot;hide&quot;: true, &quot;options&quot;: &#123; &quot;content&quot;: &quot;请确认上报数据是否完整，上报后所有单位不可再次上报&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;generate_data&quot;, &quot;label&quot;: &quot;处理数据&quot;, &quot;action&quot;: &quot;OPEN_WEBSOCKET&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;private.GZW_edit_report_status&quot;, &quot;beginTip&quot;: &quot;开始处理&quot;, &quot;completeTip&quot;: &quot;已完成&quot;, &quot;processingTitle&quot;: &quot;正在启动中&quot;, &quot;completeTitle&quot;: &quot;启动完成&quot;, &quot;autoClose&quot;: true, &quot;closeWaiting&quot;: 500, &quot;params&quot;: &#123; &quot;month&quot;: &quot;expression[GET(FILTER_DICT(),[&#x27;month&#x27;])]&quot;, &quot;model&quot;: &quot;ReportOrgInfo&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;show_warning_all&quot;, &quot;action&quot;: &quot;SHOW_WARNING&quot;, &quot;entry_condition&quot;: &quot;expression[RES(&#x27;generate_data&#x27;)]&quot;, &quot;options&quot;: &#123; &quot;content&quot;: &quot;expression[GET(RES(&#x27;generate_data&#x27;),[&#x27;msg&#x27;])]&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;refresh&quot;, &quot;action&quot;: &quot;REFRESH&quot; &#125; ]&#125;","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"040-创建新模型","slug":"项目/HCM教程/040-创建新模型","date":"2025-06-03T12:44:25.000Z","updated":"2025-09-09T06:19:59.393Z","comments":true,"path":"2025/06/03/项目/HCM教程/040-创建新模型/","link":"","permalink":"https://dbbruce.github.io/2025/06/03/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/040-%E5%88%9B%E5%BB%BA%E6%96%B0%E6%A8%A1%E5%9E%8B/","excerpt":"新模型标准弹性模型","text":"新模型标准弹性模型 增加字段 过滤项 1、新增的模型会自带3个过滤项，不想要，隐藏就可以了 2、新增过滤项 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091&quot;filters&quot;: [&#123; &quot;key&quot;: &quot;program_id&quot;, &quot;sequence&quot;: 10, &quot;label&quot;: &quot;薪酬方案&quot;, &quot;component&quot;: &quot;hc-super-selector&quot;, &quot;options&quot;: &#123; &quot;width&quot;: &quot;col-4&quot;, &quot;default&quot;: &quot;21771&quot;, &quot;readOnly&quot;: true, &quot;required&quot;: true, &quot;singleLine&quot;: true, &quot;multi&quot;: false, &quot;includeAll&quot;: false, &quot;placeholder&quot;: &quot;薪酬方案&quot;, &quot;selectorModel&quot;: &quot;SalaryProgram&quot;, &quot;hasNull&quot;: false, &quot;no_delete&quot;: true, &quot;extra_property&quot;: &#123; &quot;state&quot;: &quot;calc&quot;, &quot;sorts&quot;: [&#123; &quot;key&quot;: &quot;number&quot;, &quot;type&quot;: &quot;asc&quot; &#125;] &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;month&quot;, &quot;sequence&quot;: 20, &quot;label&quot;: &quot;月份&quot;, &quot;plan_exclude&quot;: true, &quot;component&quot;: &quot;hc-input-datetime&quot;, &quot;options&quot;: &#123; &quot;readOnly&quot;: false, &quot;default&quot;: &quot;=function()&#123;STATE; if(STATE.params.month!==undefined)&#123;return STATE.params.month;&#125;else&#123;if(STATE.params.custom_params!==undefined)&#123;return JSON.parse(STATE.params.custom_params).month || MOMENT().format(&#x27;YYYY-MM&#x27;);&#125;else&#123;return MOMENT().format(&#x27;YYYY-MM&#x27;);&#125;&#125;&#125;&quot;, &quot;width&quot;: &quot;col-4&quot;, &quot;singleLine&quot;: true, &quot;inputLock&quot;: true, &quot;format&quot;: &quot;yyyy-MM&quot;, &quot;placeholder&quot;: &quot;月份&quot;, &quot;required&quot;: true, &quot;no_trans_query&quot;: true &#125; &#125;, &#123; &quot;key&quot;: &quot;depart_id&quot;, &quot;sequence&quot;: 30, &quot;label&quot;: &quot;部门&quot;, &quot;component&quot;: &quot;hc-standard-tree-selector&quot;, &quot;options&quot;: &#123; &quot;placeholder&quot;: &quot;部门&quot;, &quot;width&quot;: &quot;col-4&quot;, &quot;singleLine&quot;: true, &quot;selectorModel&quot;: &quot;OrgDepartment&quot;, &quot;extra_property&quot;: &#123; &quot;role&quot;: &quot;cm-salary.business_specialist&quot; &#125;, &quot;auto_select&quot;: false, &quot;child_include&quot;: true, &quot;effect_date&quot;: &quot;=function()&#123;var a=SCOPE.advance_query.query_model.data.month; var b=a.substr(0,4);var c= a.substr(5,2); var end_date= new Date(b, c, 1); var final_date = (new Date(end_date.getTime() - 1000 * 60 * 60 * 24)).getDate(); result_date=a+&#x27;-&#x27;+final_date.toString(); return result_date;&#125;&quot;, &quot;mode&quot;: &quot;new&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;u_Unit&quot;, &quot;label&quot;: &quot;单位名称&quot;, &quot;component&quot;: &quot;hc-super-selector&quot;, &quot;options&quot;: &#123; &quot;width&quot;: &quot;col-4&quot;, &quot;hide&quot;: true &#125; &#125;, &#123; &quot;key&quot;: &quot;u_DocNum&quot;, &quot;label&quot;: &quot;单据编号&quot;, &quot;component&quot;: &quot;hc-super-selector&quot;, &quot;options&quot;: &#123; &quot;width&quot;: &quot;col-4&quot;, &quot;hide&quot;: true &#125; &#125;, &#123; &quot;key&quot;: &quot;u_Month&quot;, &quot;label&quot;: &quot;发放月份&quot;, &quot;component&quot;: &quot;hc-super-selector&quot;, &quot;options&quot;: &#123; &quot;width&quot;: &quot;col-4&quot;, &quot;hide&quot;: true &#125; &#125; ]","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"039-待办数据取消-直接接口","slug":"项目/HCM教程/039-待办数据取消-直接接口","date":"2025-06-02T14:44:25.000Z","updated":"2025-09-09T06:19:59.428Z","comments":true,"path":"2025/06/02/项目/HCM教程/039-待办数据取消-直接接口/","link":"","permalink":"https://dbbruce.github.io/2025/06/02/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/039-%E5%BE%85%E5%8A%9E%E6%95%B0%E6%8D%AE%E5%8F%96%E6%B6%88-%E7%9B%B4%E6%8E%A5%E6%8E%A5%E5%8F%A3/","excerpt":"配置字段映射123456789101112131415161718&#123; &quot;json&quot;: &#123; &quot;common&quot;: &#123; &quot;appName&quot;: &quot;HR&quot;, &quot;optType&quot;: 1, &quot;modelName&quot;: &quot;人力系统&quot; &#125;, &quot;special&quot;: [&#123; &quot;map&quot;: &quot;modelId&quot;, &quot;field&quot;: [&quot;id&quot;], &quot;value_func&quot;: &quot;inner_func(\\&quot;str(&#123;#value&#125;)\\&quot;)&quot; &#125;] &#125;, &quot;response_cache_config&quot;: &#123; &quot;success_response_key&quot;: [&quot;returnState&quot;], &quot;success_response_value&quot;: 2 &#125;&#125;","text":"配置字段映射123456789101112131415161718&#123; &quot;json&quot;: &#123; &quot;common&quot;: &#123; &quot;appName&quot;: &quot;HR&quot;, &quot;optType&quot;: 1, &quot;modelName&quot;: &quot;人力系统&quot; &#125;, &quot;special&quot;: [&#123; &quot;map&quot;: &quot;modelId&quot;, &quot;field&quot;: [&quot;id&quot;], &quot;value_func&quot;: &quot;inner_func(\\&quot;str(&#123;#value&#125;)\\&quot;)&quot; &#125;] &#125;, &quot;response_cache_config&quot;: &#123; &quot;success_response_key&quot;: [&quot;returnState&quot;], &quot;success_response_value&quot;: 2 &#125;&#125;","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"038-待办数据推送-直接接口","slug":"项目/HCM教程/038-待办数据推送-直接接口","date":"2025-06-02T13:44:25.000Z","updated":"2025-09-09T06:19:59.290Z","comments":true,"path":"2025/06/02/项目/HCM教程/038-待办数据推送-直接接口/","link":"","permalink":"https://dbbruce.github.io/2025/06/02/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/038-%E5%BE%85%E5%8A%9E%E6%95%B0%E6%8D%AE%E6%8E%A8%E9%80%81-%E7%9B%B4%E6%8E%A5%E6%8E%A5%E5%8F%A3/","excerpt":"配置字段映射123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051&#123; &quot;json&quot;: &#123; &quot;common&quot;: &#123; &quot;type&quot;: 1, &quot;appName&quot;: &quot;HR&quot;, &quot;modelName&quot;: &quot;人力系统&quot; &#125;, &quot;complex&quot;: [&#123; &quot;map&quot;: &quot;link&quot;, &quot;child_field&quot;: [&#123; &quot;map&quot;: &quot;child1&quot;, &quot;field&quot;: [&quot;id&quot;] &#125;], &quot;finally_str&quot;: &quot;http://ehrtest..com/login/redirect_inner?sso=customer_sso&amp;next=%2Fmessagerouter%3Fmessage_id%3D&#123;child1&#125;&quot; &#125;, &#123; &quot;map&quot;: &quot;mobileLink&quot;, &quot;child_field&quot;: [&#123; &quot;map&quot;: &quot;child1&quot;, &quot;field&quot;: [&quot;id&quot;] &#125;], &quot;finally_str&quot;: &quot;http://ehrtest..com/login/redirect_inner?sso=customer_sso&amp;next=%2Fmessagerouter%3Fmessage_id%3D&#123;child1&#125;&quot; &#125;, &#123; &quot;map&quot;: &quot;padLink&quot;, &quot;child_field&quot;: [&#123; &quot;map&quot;: &quot;child1&quot;, &quot;field&quot;: [&quot;id&quot;] &#125;], &quot;finally_str&quot;: &quot;http://ehrtest..com/login/redirect_inner?sso=customer_sso&amp;next=%2Fmessagerouter%3Fmessage_id%3D&#123;child1&#125;&quot; &#125;], &quot;special&quot;: [&#123; &quot;map&quot;: &quot;modelId&quot;, &quot;field&quot;: [&quot;id&quot;], &quot;value_func&quot;: &quot;inner_func(\\&quot;str(&#123;#value&#125;)\\&quot;)&quot; &#125;, &#123; &quot;map&quot;: &quot;targets&quot;, &quot;field&quot;: [&quot;receiver&quot;, &quot;number&quot;], &quot;value_func&quot;: &quot;&#x27;&#123;\\&quot;PersonNo\\&quot;:\\&quot;&#123;value&#125;\\&quot;&#125;&#x27;.replace(&#x27;&#123;value&#125;&#x27;,value)&quot; &#125;, &#123; &quot;map&quot;: &quot;subject&quot;, &quot;field&quot;: [&quot;content&quot;] &#125;, &#123; &quot;map&quot;: &quot;createTime&quot;, &quot;field&quot;: [&quot;send_date&quot;], &quot;value_func&quot;: &quot;timestamp_format(\\&quot;%Y-%m-%d %H:%M:%S\\&quot;)&quot; &#125;] &#125;, &quot;response_cache_config&quot;: &#123; &quot;success_response_key&quot;: [&quot;returnState&quot;], &quot;success_response_value&quot;: 2 &#125;&#125;","text":"配置字段映射123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051&#123; &quot;json&quot;: &#123; &quot;common&quot;: &#123; &quot;type&quot;: 1, &quot;appName&quot;: &quot;HR&quot;, &quot;modelName&quot;: &quot;人力系统&quot; &#125;, &quot;complex&quot;: [&#123; &quot;map&quot;: &quot;link&quot;, &quot;child_field&quot;: [&#123; &quot;map&quot;: &quot;child1&quot;, &quot;field&quot;: [&quot;id&quot;] &#125;], &quot;finally_str&quot;: &quot;http://ehrtest..com/login/redirect_inner?sso=customer_sso&amp;next=%2Fmessagerouter%3Fmessage_id%3D&#123;child1&#125;&quot; &#125;, &#123; &quot;map&quot;: &quot;mobileLink&quot;, &quot;child_field&quot;: [&#123; &quot;map&quot;: &quot;child1&quot;, &quot;field&quot;: [&quot;id&quot;] &#125;], &quot;finally_str&quot;: &quot;http://ehrtest..com/login/redirect_inner?sso=customer_sso&amp;next=%2Fmessagerouter%3Fmessage_id%3D&#123;child1&#125;&quot; &#125;, &#123; &quot;map&quot;: &quot;padLink&quot;, &quot;child_field&quot;: [&#123; &quot;map&quot;: &quot;child1&quot;, &quot;field&quot;: [&quot;id&quot;] &#125;], &quot;finally_str&quot;: &quot;http://ehrtest..com/login/redirect_inner?sso=customer_sso&amp;next=%2Fmessagerouter%3Fmessage_id%3D&#123;child1&#125;&quot; &#125;], &quot;special&quot;: [&#123; &quot;map&quot;: &quot;modelId&quot;, &quot;field&quot;: [&quot;id&quot;], &quot;value_func&quot;: &quot;inner_func(\\&quot;str(&#123;#value&#125;)\\&quot;)&quot; &#125;, &#123; &quot;map&quot;: &quot;targets&quot;, &quot;field&quot;: [&quot;receiver&quot;, &quot;number&quot;], &quot;value_func&quot;: &quot;&#x27;&#123;\\&quot;PersonNo\\&quot;:\\&quot;&#123;value&#125;\\&quot;&#125;&#x27;.replace(&#x27;&#123;value&#125;&#x27;,value)&quot; &#125;, &#123; &quot;map&quot;: &quot;subject&quot;, &quot;field&quot;: [&quot;content&quot;] &#125;, &#123; &quot;map&quot;: &quot;createTime&quot;, &quot;field&quot;: [&quot;send_date&quot;], &quot;value_func&quot;: &quot;timestamp_format(\\&quot;%Y-%m-%d %H:%M:%S\\&quot;)&quot; &#125;] &#125;, &quot;response_cache_config&quot;: &#123; &quot;success_response_key&quot;: [&quot;returnState&quot;], &quot;success_response_value&quot;: 2 &#125;&#125;","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"037-待办数据推送","slug":"项目/HCM教程/037-待办数据推送-云函数","date":"2025-06-02T12:44:25.000Z","updated":"2025-09-09T06:19:59.411Z","comments":true,"path":"2025/06/02/项目/HCM教程/037-待办数据推送-云函数/","link":"","permalink":"https://dbbruce.github.io/2025/06/02/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/037-%E5%BE%85%E5%8A%9E%E6%95%B0%E6%8D%AE%E6%8E%A8%E9%80%81-%E4%BA%91%E5%87%BD%E6%95%B0/","excerpt":"启用-数据推送 系统设置 - 企业设置 - 服务器设置 - 是否开启数据推送 选择 【是】","text":"启用-数据推送 系统设置 - 企业设置 - 服务器设置 - 是否开启数据推送 选择 【是】 创建云函数 private.demo1 12345678910111213141516171819class PrivateAPIService(BasePrivateApiService): &quot;&quot;&quot; 动态私有OpenAPI 使用方法 &quot;&quot;&quot; def execute(self, **kwargs): try: self.log(f&#x27;kwargs-&#123;kwargs&#125;&#x27;) except Exception as e: self.log(e) def log(self, log_content): log_info = &#123; &quot;log_type&quot;: str(&#x27;test111&#x27;), &quot;create_time&quot;: datetime.datetime.now().strftime(&#x27;%Y-%m-%d %H:%M:%S&#x27;), &quot;record&quot;: str(log_content) &#125; CustomerUtil.call_open_api(&quot;hcm.model.create&quot;, &#123;&quot;model&quot;: &quot;hcm_flex_log_data.formula_log&quot;, &quot;info&quot;: log_info&#125;) 配置-第三方访问令牌 系统设置 - 基础设置 - 第三方访问令牌 - 添加接口名称 令牌：hcm22b02f9b3e506e27c5101abe325f686d2853b567，下面配置时会用到 配置数据推送 系统设置 - 集成管理 - 数据推送管理 消息类别 - 待办 - 有新增待办消息就会触发 请求方法 - 必须是post 请求头 - 必填 - 自己设置的令牌123&#123; &quot;Authorization&quot;: &quot;Bearer hcm22b02f9b3e506e27c5101abe325f686d2853b567&quot;&#125; 字段映射配置123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051&#123; &quot;json&quot;: &#123; &quot;common&quot;: &#123; &quot;type&quot;: 1, &quot;appName&quot;: &quot;HR&quot;, &quot;modelName&quot;: &quot;人力系统&quot; &#125;, &quot;complex&quot;: [&#123; &quot;map&quot;: &quot;link&quot;, &quot;child_field&quot;: [&#123; &quot;map&quot;: &quot;child1&quot;, &quot;field&quot;: [&quot;id&quot;] &#125;], &quot;finally_str&quot;: &quot;https://tedatest.hcmcloud.cn/login/redirect_inner?sso=customer_sso&amp;next=%2Fmessagerouter%3Fmessage_id%3D&#123;child1&#125;&quot; &#125;, &#123; &quot;map&quot;: &quot;mobileLink&quot;, &quot;child_field&quot;: [&#123; &quot;map&quot;: &quot;child1&quot;, &quot;field&quot;: [&quot;id&quot;] &#125;], &quot;finally_str&quot;: &quot;http://ehrtest.bhzq.com/login/redirect_inner?sso=customer_sso&amp;next=%2Fmessagerouter%3Fmessage_id%3D&#123;child1&#125;&quot; &#125;, &#123; &quot;map&quot;: &quot;padLink&quot;, &quot;child_field&quot;: [&#123; &quot;map&quot;: &quot;child1&quot;, &quot;field&quot;: [&quot;id&quot;] &#125;], &quot;finally_str&quot;: &quot;http://ehrtest.bhzq.com/login/redirect_inner?sso=customer_sso&amp;next=%2Fmessagerouter%3Fmessage_id%3D&#123;child1&#125;&quot; &#125;], &quot;special&quot;: [&#123; &quot;map&quot;: &quot;modelId&quot;, &quot;field&quot;: [&quot;id&quot;], &quot;value_func&quot;: &quot;inner_func(\\&quot;str(&#123;#value&#125;)\\&quot;)&quot; &#125;, &#123; &quot;map&quot;: &quot;targets&quot;, &quot;field&quot;: [&quot;receiver&quot;, &quot;number&quot;], &quot;value_func&quot;: &quot;&#x27;&#123;\\&quot;PersonNo\\&quot;:\\&quot;&#123;value&#125;\\&quot;&#125;&#x27;.replace(&#x27;&#123;value&#125;&#x27;,value)&quot; &#125;, &#123; &quot;map&quot;: &quot;subject&quot;, &quot;field&quot;: [&quot;content&quot;] &#125;, &#123; &quot;map&quot;: &quot;createTime&quot;, &quot;field&quot;: [&quot;send_date&quot;], &quot;value_func&quot;: &quot;timestamp_format(\\&quot;%Y-%m-%d %H:%M:%S\\&quot;)&quot; &#125;] &#125;, &quot;response_cache_config&quot;: &#123; &quot;success_response_key&quot;: [&quot;returnState&quot;], &quot;success_response_value&quot;: 2 &#125;&#125; 验证 增加一条待办 查看推送日志 查看云函数日志","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"036-第三方访问令牌","slug":"项目/HCM教程/036-第三方访问令牌","date":"2025-06-01T15:44:25.000Z","updated":"2025-09-09T06:19:59.543Z","comments":true,"path":"2025/06/01/项目/HCM教程/036-第三方访问令牌/","link":"","permalink":"https://dbbruce.github.io/2025/06/01/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/036-%E7%AC%AC%E4%B8%89%E6%96%B9%E8%AE%BF%E9%97%AE%E4%BB%A4%E7%89%8C/","excerpt":"配置第三方访问令牌","text":"配置第三方访问令牌","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"035-单点登录","slug":"项目/HCM教程/035-单点登录","date":"2025-06-01T14:44:25.000Z","updated":"2025-09-09T06:19:59.396Z","comments":true,"path":"2025/06/01/项目/HCM教程/035-单点登录/","link":"","permalink":"https://dbbruce.github.io/2025/06/01/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/035-%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/","excerpt":"单点登录 url: &#x2F;api&#x2F;auth&#x2F;login_by_sso?sso&#x3D;customer_sso&amp;next&#x3D;&#x2F;index","text":"单点登录 url: &#x2F;api&#x2F;auth&#x2F;login_by_sso?sso&#x3D;customer_sso&amp;next&#x3D;&#x2F;index 实例代码 key 解释 实例 handler.request HTTPServerRequest(protocol&#x3D;’http’, host&#x3D;’20.24.9.85’, method&#x3D;’GET’, uri&#x3D;’&#x2F;api&#x2F;auth&#x2F;login_by_sso?sso&#x3D;customer_sso&amp;next&#x3D;&#x2F;index’, version&#x3D;’HTTP&#x2F;1.1’, remote_ip&#x3D;’172.18.11.51’) handler.request.cookies 三方系统在浏览器中的cookie信息 Set-Cookie: LtpaToken&#x3D;AAECAzY4NTEwMjRGNjg1MUFCMEZ6aGFuZ3l1ZW1laex7ejzeyUCjFkcF1A4yfXV19pHkSet-Cookie: token&#x3D;”2 res &#x3D; response.text 根据token获取三方系统用户的信息 response.text–{‘result’: True, ‘errorMsg’: None, ‘loginName’: ‘2631’, ‘userName’: ‘张月梅’} 云函数 customer_sso 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118class customer_sso(SSOService): __third_type__ = &quot;customer_sso&quot; __authorize_type__ = &quot;customer_sso&quot; __description__ = &quot;个性化单点登录&quot; map_key = &quot;number&quot; # 字段映射 host = &quot;20.24.9.85&quot; def get_authorize_redirect(self, redirect_uri, handler): &quot;&quot;&quot; 地址重定向 :param redirect_uri: :param handler: :return: &quot;&quot;&quot; # self.__redirect_uri__ = redirect_uri # url = &quot;&#123;&#125;/idp/oauth2/authorize?redirect_uri=&#123;&#125;&amp;state=&#123;&#125;&amp;client_id=&#123;&#125;&amp;response_type=&#123;&#125;&quot;.format( # self.__server_url__, urllib.parse.quote(self.__redirect_uri__), self.__state__, self.__client_id__, # self.__response_type__) logging.info(&quot;get_code_url:&#123;&#125;&quot;.format(redirect_uri)) return redirect_uri def get_sso_user(self, handler): try: # self.log(handler.request.cookies) # self.log(dict(handler.request.cookies)[&#x27;LtpaToken&#x27;].value) token = dict(handler.request.cookies)[&#x27;LtpaToken&#x27;].value account = self.token_get_information(token) return &#123;self.map_key: account, &quot;id&quot;: account, &quot;openid&quot;: account&#125; if account else None except Exception as e: self.log(traceback.format_exc()) raise e def token_get_information(self, account): url = f&quot;https://oatest.bhzq.com/api/bhzq-third/thirdLoginRestService/getTokenLoginName?token=&#123;account&#125;&quot; payload = &#123;&#125; headers = &#123;&#125; response = requests.request(&quot;POST&quot;, url, headers=headers, data=payload) res = response.text self.log(response.text) return res[&quot;loginName&quot;] def get_cloud_user(self, sso_user): &quot;&quot;&quot;获取人员信息&quot;&quot;&quot; employee_info = self.get_employee_info(self.map_key, sso_user.get(self.map_key)) if employee_info: mobile = employee_info.get(&quot;mobile&quot;) user = self.get_user(mobile) return user[0] if user else self.create_info(mobile) else: return None def log(self, content, type_=1): log_info = &#123;&quot;log_type&quot;: str(&#x27;sso&#x27;), &quot;create_time&quot;: datetime.datetime.now().strftime(&#x27;%Y-%m-%d %H:%M:%S&#x27;), &quot;content&quot;: str(content)&#125; CustomerUtil.call_open_api(&quot;hcm.model.create&quot;, &#123;&quot;model&quot;: &quot;dynamic_log&quot;, &quot;info&quot;: log_info&#125;) @staticmethod def create_info(mobile): &quot;&quot;&quot;新增至user表&quot;&quot;&quot; return CustomerUtil.call_open_api(&#x27;hcm.model.create&#x27;, &#123;&quot;model&quot;: &quot;User&quot;, &quot;info&quot;: &#123;&quot;cell_phone&quot;: mobile&#125;&#125;) @staticmethod def get_user(mobile): &quot;&quot;&quot;获取user表的数据&quot;&quot;&quot; param = &#123; &quot;model&quot;: &quot;User&quot;, &quot;filter_dict&quot;: &#123; &quot;cell_phone&quot;: mobile &#125;, &quot;extra_property&quot;: &#123; &quot;only_list&quot;: True &#125; &#125; return CustomerUtil.call_open_api(&#x27;hcm.model.list&#x27;, param)[&quot;list&quot;] @staticmethod def get_employee_info(key, value): &quot;&quot;&quot;获取人员信息&quot;&quot;&quot; param = &#123; &quot;model&quot;: &quot;Employee&quot;, &quot;filter_dict&quot;: &#123;key: value&#125;, &quot;extra_property&quot;: &#123; &quot;only_list&quot;: True, &quot;fields&quot;: [ &#123;&quot;field&quot;: [&quot;mobile&quot;], &quot;key&quot;: &quot;mobile&quot;&#125; ], &quot;relations&quot;: [ &#123; &quot;filter&quot;: &#123; &quot;job_info.employee_id&quot;: &quot;:id&quot;, &quot;job_info.position_type&quot;: &quot;1&quot;, &quot;job_info.on_job&quot;: &quot;1&quot;, &quot;job_info.begin_date&quot;: &#123; &quot;lte&quot;: &quot;=date_&quot; &#125;, &quot;job_info.end_date&quot;: &#123; &quot;gt&quot;: &quot;=date_&quot; &#125; &#125;, &quot;model&quot;: &quot;JobInformation&quot;, &quot;name&quot;: &quot;任职信息&quot;, &quot;key&quot;: &quot;job_info&quot; &#125; ] &#125; &#125; res = CustomerUtil.call_open_api(&#x27;hcm.model.list&#x27;, param)[&quot;list&quot;] return res[0] if res else None def customer_logout(self, handler): _cache_key = handler.get_secure_cookie(&quot;customer_sso_sso&quot;) self.clear_cached(&quot;customer_sso_&#123;&#125;&quot;.format(_cache_key)) return &quot;https://20.24.9.85/login&quot; customer_sso_18392218 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129class customer_sso(SSOService): __third_type__ = &quot;customer_sso&quot; __authorize_type__ = &quot;customer_sso&quot; __description__ = &quot;个性化单点登录&quot; map_key = &quot;number&quot; # 字段映射 host=&quot;http://ehrtest.hbzq.com&quot; def get_authorize_redirect(self, redirect_uri, handler): &quot;&quot;&quot; 地址重定向 :param redirect_uri: :param handler: :return: &quot;&quot;&quot; # self.__redirect_uri__ = redirect_uri # url = &quot;&#123;&#125;/idp/oauth2/authorize?redirect_uri=&#123;&#125;&amp;state=&#123;&#125;&amp;client_id=&#123;&#125;&amp;response_type=&#123;&#125;&quot;.format( # self.__server_url__, urllib.parse.quote(self.__redirect_uri__), self.__state__, self.__client_id__, # self.__response_type__) logging.info(&quot;get_code_url:&#123;&#125;&quot;.format(redirect_uri)) return redirect_uri def get_sso_user(self, handler): try: self.log(handler.request.cookies) self.log(dict(handler.request.cookies)[&#x27;LtpaToken&#x27;].value) token=dict(handler.request.cookies)[&#x27;LtpaToken&#x27;].value account=self.token_get_information(token) return &#123;self.map_key: account, &quot;id&quot;: account, &quot;openid&quot;: account&#125; if account else None except Exception as e: self.log(traceback.format_exc()) raise e def token_get_information(self,account): url = f&quot;https://oatest.bhzq.com/api/bhzq-third/thirdLoginRestService/getTokenLoginName?token=&#123;account&#125;&quot; account_id=&quot;token-hcm&quot; account_password=&quot;password-hcm&quot; auth_string=f&quot;&#123;account_id&#125;:&#123;account_password&#125;&quot; encode_auth=base64.b64encode(auth_string.encode(&quot;utf-8&quot;)).decode(&quot;utf-8&quot;) payload = &#123;&#125; headers = &#123; &quot;Authorization&quot;:f&quot;Basic &#123;encode_auth&#125;&quot; &#125; response = requests.request(&quot;POST&quot;, url, headers=headers, data=payload) res=json.loads(response.text) self.log(f&quot;response.text--&#123;res&#125;&quot;) return res[&quot;loginName&quot;] def get_cloud_user(self, sso_user): &quot;&quot;&quot;获取人员信息&quot;&quot;&quot; employee_info = self.get_employee_info(self.map_key, sso_user.get(self.map_key)) if employee_info: mobile = employee_info.get(&quot;mobile&quot;) user = self.get_user(mobile) return user[0] if user else self.create_info(mobile) else: return None def log(self, content, type_=1): log_info = &#123;&quot;log_type&quot;: str(&#x27;customer_sso_18392218&#x27;), &quot;create_time&quot;: datetime.datetime.now().strftime(&#x27;%Y-%m-%d %H:%M:%S&#x27;), &quot;content&quot;: str(content)&#125; CustomerUtil.call_open_api(&quot;hcm.model.create&quot;, &#123;&quot;model&quot;: &quot;dynamic_log&quot;, &quot;info&quot;: log_info&#125;) @staticmethod def create_info(mobile): &quot;&quot;&quot;新增至user表&quot;&quot;&quot; return CustomerUtil.call_open_api(&#x27;hcm.model.create&#x27;, &#123;&quot;model&quot;: &quot;User&quot;, &quot;info&quot;: &#123;&quot;cell_phone&quot;: mobile&#125;&#125;) @staticmethod def get_user(mobile): &quot;&quot;&quot;获取user表的数据&quot;&quot;&quot; param = &#123; &quot;model&quot;: &quot;User&quot;, &quot;filter_dict&quot;: &#123; &quot;cell_phone&quot;: mobile &#125;, &quot;extra_property&quot;: &#123; &quot;only_list&quot;: True &#125; &#125; return CustomerUtil.call_open_api(&#x27;hcm.model.list&#x27;, param)[&quot;list&quot;] @staticmethod def get_employee_info(key, value): &quot;&quot;&quot;获取人员信息&quot;&quot;&quot; param = &#123; &quot;model&quot;: &quot;Employee&quot;, &quot;filter_dict&quot;: &#123;key: value&#125;, &quot;extra_property&quot;: &#123; &quot;only_list&quot;: True, &quot;fields&quot;: [ &#123;&quot;field&quot;: [&quot;mobile&quot;], &quot;key&quot;: &quot;mobile&quot;&#125; ], &quot;relations&quot;: [ &#123; &quot;filter&quot;: &#123; &quot;job_info.employee_id&quot;: &quot;:id&quot;, &quot;job_info.position_type&quot;: &quot;1&quot;, &quot;job_info.on_job&quot;: &quot;1&quot;, &quot;job_info.begin_date&quot;: &#123; &quot;lte&quot;: &quot;=date_&quot; &#125;, &quot;job_info.end_date&quot;: &#123; &quot;gt&quot;: &quot;=date_&quot; &#125; &#125;, &quot;model&quot;: &quot;JobInformation&quot;, &quot;name&quot;: &quot;任职信息&quot;, &quot;key&quot;: &quot;job_info&quot; &#125; ] &#125; &#125; res = CustomerUtil.call_open_api(&#x27;hcm.model.list&#x27;, param)[&quot;list&quot;] return res[0] if res else None def customer_logout(self,handler): _cache_key=handler.get_secure_cookie(&quot;customer_sso_sso&quot;) self.clear_cached(&quot;customer_sso_&#123;&#125;&quot;.format(_cache_key)) return &quot;https://20.24.9.85/login&quot; 分析 get_sso_user 是调用的入口","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"034-hooks的使用","slug":"项目/HCM教程/034-hooks的使用","date":"2025-06-01T12:44:25.000Z","updated":"2025-09-09T06:19:59.297Z","comments":true,"path":"2025/06/01/项目/HCM教程/034-hooks的使用/","link":"","permalink":"https://dbbruce.github.io/2025/06/01/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/034-hooks%E7%9A%84%E4%BD%BF%E7%94%A8/","excerpt":"在元数据中定义 hooks的方法 考勤月报功能为例12345678910111213&quot;hooks&quot;: &#123; &quot;beforeFetchDataAsync&quot;: &quot;=async function fn()&#123;var range=await dataService.callHcmOpenApi(&#x27;time.parameters.setting.get.by.key&#x27;,&#123;&#x27;key&#x27;:&#x27;TIME_MONTH_RANGE&#x27;,depart_id:SCOPE.getAllFilterDict().depart_id.child_include&#125;);SCOPE.TIME_MONTH_RANGE=range?range:SCOPE.auth.company_setting.TIME_MONTH_RANGE;SCOPE.getMonthStartEnd(SCOPE.filter_year_month);&#125;&quot;, &quot;getMonthStartEnd&quot;: &quot;=function(year_month)&#123;var mrs=SCOPE.TIME_MONTH_RANGE;if(/^-?[0-9]&#123;1,2&#125;~\\\\+?[0-9]&#123;1,2&#125;$/.test(mrs))&#123;var[mbs,mes]=mrs.split(&#x27;~&#x27;);var mbi=parseInt(mbs.replace(/-/g,&#x27;&#x27;));var mei=parseInt(mes.replace(/\\\\+/g,&#x27;&#x27;));if(mbs&lt;mes.replace(/\\\\+/g,&#x27;9&#x27;)&amp;&amp;(1&lt;mbi&amp;&amp;mbi&lt;=31)&amp;&amp;(1&lt;mei&amp;&amp;mei&lt;=31))&#123;var bm=mbs.startsWith(&#x27;-&#x27;)?MOMENT(year_month).subtract(1,&#x27;months&#x27;):MOMENT(year_month);var begin_date=(bm.endOf(&#x27;month&#x27;).date()&lt;mbi?bm.add(1,&#x27;months&#x27;).startOf(&#x27;month&#x27;):bm.date(mbi)).format(&#x27;YYYY-MM-DD&#x27;);var em=mes.startsWith(&#x27;+&#x27;)?MOMENT(year_month).add(1,&#x27;months&#x27;):MOMENT(year_month);var end_date=(em.endOf(&#x27;month&#x27;).date()&lt;mei?em.endOf(&#x27;month&#x27;):em.date(mei)).format(&#x27;YYYY-MM-DD&#x27;);SCOPE.begin_date=begin_date;SCOPE.end_date=end_date;return[SCOPE.begin_date,SCOPE.end_date]&#125;&#125;SCOPE.begin_date=MOMENT(year_month).startOf(&#x27;month&#x27;).format(&#x27;YYYY-MM-DD&#x27;);SCOPE.end_date=MOMENT(year_month).endOf(&#x27;month&#x27;).format(&#x27;YYYY-MM-DD&#x27;);return[SCOPE.begin_date,SCOPE.end_date]&#125;&quot;, &quot;setColumn&quot;: &quot;=function()&#123;setTimeout(function()&#123;SCOPE.temp_columns=SCOPE.temp_columns&amp;&amp;SCOPE.temp_columns.length?SCOPE.temp_columns:SCOPE.list_model.columns;var weekday_map=[&#x27;一&#x27;,&#x27;二&#x27;,&#x27;三&#x27;,&#x27;四&#x27;,&#x27;五&#x27;,&#x27;六&#x27;,&#x27;日&#x27;];var _date=MOMENT(SCOPE.begin_date);var end_date_moment=MOMENT(SCOPE.end_date);var _i=1,index_date_map=&#123;&#125;;while(_date&lt;=end_date_moment)&#123;index_date_map[_i.toString()]=&#123;label:`$&#123;_date.date()&#125;\\\\n$&#123;weekday_map[_date.weekday()]&#125;`,date:_date.format(&#x27;YYYY-MM-DD&#x27;),hide:false&#125;;_date=_date.add(1,&#x27;days&#x27;);_i++&#125;var cols=SCOPE.temp_columns.map(function(_col)&#123;if(_col.key.startsWith(&#x27;month_data_&#x27;))&#123;var date_index=_col.key.substr(11);if(index_date_map.hasOwnProperty(date_index))&#123;$filter(&#x27;deepMerge&#x27;)(_col,index_date_map[date_index])&#125;else&#123;_col.hide=true&#125;&#125;return _col&#125;);SCOPE.list_model.$setColumns(cols,SCOPE.list_model.fix_count)&#125;,233)&#125;&quot;, &quot;setMetaBeforeAsync&quot;: &quot;=async function()&#123;SCOPE.customEnvironmentParams.view_items=SCOPE.mlGetViewItems();&#125;&quot;, &quot;getExtraFilterDict&quot;: &quot;=function()&#123;return &#123;date_:SCOPE.end_date&#125;&#125;&quot;, &quot;mlDefaultViewItems&quot;: &quot;=function()&#123;return [&#x27;shift&#x27;,&#x27;result&#x27;]&#125;&quot;, &quot;mlGetViewItems&quot;: &quot;=function()&#123;if(SCOPE.customEnvironmentParams.view_items)&#123;return SCOPE.customEnvironmentParams.view_items&#125;;var custom_params=JSON.parse(STATE.params.custom_params||&#x27;&#123;&#125;&#x27;);if($filter(&#x27;isValidValue&#x27;)(custom_params.view_items))&#123;SCOPE.customEnvironmentParams.view_items=custom_params.view_items&#125;else&#123;SCOPE.customEnvironmentParams.view_items=SCOPE.mlDefaultViewItems();&#125;return SCOPE.customEnvironmentParams.view_items&#125;&quot;, &quot;getAlterStateParams&quot;: &quot;=function () &#123; return &#123;&#x27;custom_params&#x27;: &#123;&#x27;view_items&#x27;: SCOPE.mlGetViewItems()&#125;&#125; &#125;&quot;, &quot;fieldShow&quot;: &quot;=function(_row,_col,value)&#123;var cell_template=&#x27;&lt;div&gt;&#x27;;var date_info=_row[_col[&#x27;field&#x27;][0]];if(date_info&amp;&amp;!date_info.click_enabled)&#123;cell_template+=`&lt;div class=\\&quot;icon icon-hcm-minus-circle\\&quot; style=\\&quot;color:#bbb;\\&quot; title=\\&quot;无权限查看今日考勤结果明细\\&quot;&gt;&lt;/div&gt;`;cell_template+=&#x27;&lt;/div&gt;&#x27;;return cell_template&#125; if(date_info&amp;&amp;date_info.date_status)&#123;if(date_info.date_status===\\&quot;no_schedule\\&quot;)&#123;cell_template+=`&lt;div class=\\&quot;icon icon-hcm-minus-circle\\&quot;style=\\&quot;color:#bbb;\\&quot; title=\\&quot;未排班\\&quot;&gt;&lt;/div&gt;`;cell_template+=&#x27;&lt;/div&gt;&#x27;;return cell_template&#125;&#125; if(!(date_info&amp;&amp;date_info.shift&amp;&amp;date_info.shift.id))&#123;return&#x27;&#x27;&#125;var view_items=SCOPE.mlGetViewItems();if(view_items.indexOf(&#x27;shift&#x27;)&gt;-1)&#123;var shift=date_info.shift?date_info.shift.name:&#x27;-&#x27;;var shift_style=&#x27;color:#333;display:block;white-space:nowrap;&#x27;;shift_style+=&#x27;font-size:&#x27;+(view_items.indexOf(&#x27;result&#x27;)&gt;-1?&#x27;10&#x27;:&#x27;14&#x27;)+&#x27;px;&#x27;;cell_template+=&#x27;&lt;div class=\\&quot;cell-content ellipsis-text\\&quot; style=\\&quot;&#x27;+shift_style+&#x27;\\&quot;&gt;&#x27;+shift+&#x27;&lt;/div&gt;&#x27;&#125;if(view_items.indexOf(&#x27;result&#x27;)&gt;-1)&#123;var result=date_info.result_item?date_info.result_item.desc:&#x27;-&#x27;;var result_class=[],_italic=false;if(date_info.status===-1)&#123;result_class.push(&#x27;color-gray&#x27;);_italic=true&#125;else if(result===&#x27;-&#x27;||(date_info.shift_id===-1&amp;&amp;date_info.result_item_id===&#x27;work_rest&#x27;))&#123;result_class.push(&#x27;color-gray&#x27;)&#125;else if(date_info.result_item&amp;&amp;date_info.result_item.priority&gt;=60)&#123;result_class.push(&#x27;color-red&#x27;);_italic=true&#125;else if(date_info.result_item&amp;&amp;date_info.result_item.priority&gt;=30&amp;&amp;date_info.result_item.priority&lt;60)&#123;result_class.push(&#x27;color-orange&#x27;)&#125;var result_style=&#x27;margin:2px 0;&#x27;;result_style+=_italic?&#x27;font-style:italic;&#x27;:&#x27;&#x27;;cell_template+=&#x27;&lt;div class=\\&quot;cell-content &#x27;+result_class.join(&#x27; &#x27;)+&#x27;\\&quot; style=\\&quot;&#x27;+result_style+&#x27;\\&quot;&gt;&#x27;+result+&#x27;&lt;/div&gt;&#x27;&#125;if(view_items.indexOf(&#x27;hours&#x27;)&gt;-1)&#123;var hours=date_info.attend_hours;hours=$filter(&#x27;isValidValue&#x27;)(hours)?hours:&#x27;-&#x27;;var hours_style=&#x27;color:#333;&#x27;;hours_style+=&#x27;font-size:&#x27;+(view_items.indexOf(&#x27;result&#x27;)&gt;-1?&#x27;10&#x27;:&#x27;14&#x27;)+&#x27;px;&#x27;;cell_template+=&#x27;&lt;div class=\\&quot;cell-content\\&quot; style=\\&quot;&#x27;+hours_style+&#x27;\\&quot;&gt;&#x27;+hours+&#x27;&lt;/div&gt;&#x27;&#125;var extra_items=view_items.filter(function(_i)&#123;return [&#x27;shift&#x27;,&#x27;result&#x27;,&#x27;hours&#x27;].indexOf(_i)===-1&#125;);extra_items.map(function(_item)&#123;var extra_value=$filter(&#x27;getValue&#x27;)(date_info,_item.split(&#x27;.&#x27;));extra_value=$filter(&#x27;isValidValue&#x27;)(extra_value)?extra_value:&#x27;-&#x27;;var extra_style=&#x27;color:#333;&#x27;;extra_style+=&#x27;font-size:&#x27;+(view_items.indexOf(&#x27;result&#x27;)&gt;-1?&#x27;10&#x27;:&#x27;14&#x27;)+&#x27;px;&#x27;;cell_template+=&#x27;&lt;div class=\\&quot;cell-content\\&quot; style=\\&quot;&#x27;+extra_style+&#x27;\\&quot;&gt;&#x27;+extra_value+&#x27;&lt;/div&gt;&#x27;&#125;);cell_template+=&#x27;&lt;/div&gt;&#x27;;return $filter(&#x27;toTrusted&#x27;)(cell_template)&#125;&quot;, &quot;empDateClick&quot;: &quot;=function(_row,_col)&#123;var _r=_row[_col[&#x27;field&#x27;][0]];if(!_r?.click_enabled)return;console.log(_row,_r);SCOPE.viewAppointItem(_r,&#123;model:&#x27;AttendDataResult&#x27;,state:&#x27;office_resultMonth&#x27;,id:_r.id?_r.id:&#123;employee_id:_row.employee.id,date:_col.date,depart_id:_r.depart_id,profile_type:_row.profile_type || 1&#125;&#125;,&#123;options:&#123;alter:&#123;employee_id:_row.employee.id,employee_name:_row.employee.name,date:_col.date,depart_id:_r.depart_id,origin_id:_row.origin_id&#125;&#125;&#125;).then(function()&#123;SCOPE.fetchData()&#125;)&#125;&quot;, &quot;empInfoClick&quot;: &quot;=function fn(_row)&#123;debugger;var profile_types=[];if(_row.profile_type)&#123;if(_row.profile_type==1)&#123;profile_types=[1,null]&#125;else&#123;profile_types=[2]&#125;&#125;else&#123;profile_types=[1,null]&#125;var depart_ids=[];for(let key in _row)&#123;if(key.startsWith(&#x27;month_data&#x27;))&#123;if(_row[key].depart_id&amp;&amp;!depart_ids.includes(_row[key].depart_id))&#123;depart_ids.push(_row[key].depart_id)&#125;&#125;&#125;filter_dict=&#123;&#x27;employee_id&#x27;:_row.employee.id,&#x27;date&#x27;:&#123;&#x27;gte&#x27;:SCOPE.begin_date,&#x27;lte&#x27;:SCOPE.end_date&#125;,&#x27;profile_type&#x27;:&#123;&#x27;in&#x27;:profile_types&#125;&#125;;if(depart_ids.length)&#123;filter_dict.depart_id=&#123;in:depart_ids&#125;&#125;if(_row?.employee?.id)&#123;SCOPE.super_commgo(&#x27;common_model_list&#x27;,&#123;&#x27;model&#x27;:&#x27;AttendDataResult&#x27;,&#x27;meta_state&#x27;:&#x27;emp_detail&#x27;,&#x27;filter_dict&#x27;:filter_dict,&#x27;custom_params&#x27;:&#123;&#x27;year_month&#x27;:SCOPE.filter_year_month&#125;,show_fields_key:null,&#125;,&#123;&#x27;inherit&#x27;:false&#125;)&#125;&#125;&quot;&#125;","text":"在元数据中定义 hooks的方法 考勤月报功能为例12345678910111213&quot;hooks&quot;: &#123; &quot;beforeFetchDataAsync&quot;: &quot;=async function fn()&#123;var range=await dataService.callHcmOpenApi(&#x27;time.parameters.setting.get.by.key&#x27;,&#123;&#x27;key&#x27;:&#x27;TIME_MONTH_RANGE&#x27;,depart_id:SCOPE.getAllFilterDict().depart_id.child_include&#125;);SCOPE.TIME_MONTH_RANGE=range?range:SCOPE.auth.company_setting.TIME_MONTH_RANGE;SCOPE.getMonthStartEnd(SCOPE.filter_year_month);&#125;&quot;, &quot;getMonthStartEnd&quot;: &quot;=function(year_month)&#123;var mrs=SCOPE.TIME_MONTH_RANGE;if(/^-?[0-9]&#123;1,2&#125;~\\\\+?[0-9]&#123;1,2&#125;$/.test(mrs))&#123;var[mbs,mes]=mrs.split(&#x27;~&#x27;);var mbi=parseInt(mbs.replace(/-/g,&#x27;&#x27;));var mei=parseInt(mes.replace(/\\\\+/g,&#x27;&#x27;));if(mbs&lt;mes.replace(/\\\\+/g,&#x27;9&#x27;)&amp;&amp;(1&lt;mbi&amp;&amp;mbi&lt;=31)&amp;&amp;(1&lt;mei&amp;&amp;mei&lt;=31))&#123;var bm=mbs.startsWith(&#x27;-&#x27;)?MOMENT(year_month).subtract(1,&#x27;months&#x27;):MOMENT(year_month);var begin_date=(bm.endOf(&#x27;month&#x27;).date()&lt;mbi?bm.add(1,&#x27;months&#x27;).startOf(&#x27;month&#x27;):bm.date(mbi)).format(&#x27;YYYY-MM-DD&#x27;);var em=mes.startsWith(&#x27;+&#x27;)?MOMENT(year_month).add(1,&#x27;months&#x27;):MOMENT(year_month);var end_date=(em.endOf(&#x27;month&#x27;).date()&lt;mei?em.endOf(&#x27;month&#x27;):em.date(mei)).format(&#x27;YYYY-MM-DD&#x27;);SCOPE.begin_date=begin_date;SCOPE.end_date=end_date;return[SCOPE.begin_date,SCOPE.end_date]&#125;&#125;SCOPE.begin_date=MOMENT(year_month).startOf(&#x27;month&#x27;).format(&#x27;YYYY-MM-DD&#x27;);SCOPE.end_date=MOMENT(year_month).endOf(&#x27;month&#x27;).format(&#x27;YYYY-MM-DD&#x27;);return[SCOPE.begin_date,SCOPE.end_date]&#125;&quot;, &quot;setColumn&quot;: &quot;=function()&#123;setTimeout(function()&#123;SCOPE.temp_columns=SCOPE.temp_columns&amp;&amp;SCOPE.temp_columns.length?SCOPE.temp_columns:SCOPE.list_model.columns;var weekday_map=[&#x27;一&#x27;,&#x27;二&#x27;,&#x27;三&#x27;,&#x27;四&#x27;,&#x27;五&#x27;,&#x27;六&#x27;,&#x27;日&#x27;];var _date=MOMENT(SCOPE.begin_date);var end_date_moment=MOMENT(SCOPE.end_date);var _i=1,index_date_map=&#123;&#125;;while(_date&lt;=end_date_moment)&#123;index_date_map[_i.toString()]=&#123;label:`$&#123;_date.date()&#125;\\\\n$&#123;weekday_map[_date.weekday()]&#125;`,date:_date.format(&#x27;YYYY-MM-DD&#x27;),hide:false&#125;;_date=_date.add(1,&#x27;days&#x27;);_i++&#125;var cols=SCOPE.temp_columns.map(function(_col)&#123;if(_col.key.startsWith(&#x27;month_data_&#x27;))&#123;var date_index=_col.key.substr(11);if(index_date_map.hasOwnProperty(date_index))&#123;$filter(&#x27;deepMerge&#x27;)(_col,index_date_map[date_index])&#125;else&#123;_col.hide=true&#125;&#125;return _col&#125;);SCOPE.list_model.$setColumns(cols,SCOPE.list_model.fix_count)&#125;,233)&#125;&quot;, &quot;setMetaBeforeAsync&quot;: &quot;=async function()&#123;SCOPE.customEnvironmentParams.view_items=SCOPE.mlGetViewItems();&#125;&quot;, &quot;getExtraFilterDict&quot;: &quot;=function()&#123;return &#123;date_:SCOPE.end_date&#125;&#125;&quot;, &quot;mlDefaultViewItems&quot;: &quot;=function()&#123;return [&#x27;shift&#x27;,&#x27;result&#x27;]&#125;&quot;, &quot;mlGetViewItems&quot;: &quot;=function()&#123;if(SCOPE.customEnvironmentParams.view_items)&#123;return SCOPE.customEnvironmentParams.view_items&#125;;var custom_params=JSON.parse(STATE.params.custom_params||&#x27;&#123;&#125;&#x27;);if($filter(&#x27;isValidValue&#x27;)(custom_params.view_items))&#123;SCOPE.customEnvironmentParams.view_items=custom_params.view_items&#125;else&#123;SCOPE.customEnvironmentParams.view_items=SCOPE.mlDefaultViewItems();&#125;return SCOPE.customEnvironmentParams.view_items&#125;&quot;, &quot;getAlterStateParams&quot;: &quot;=function () &#123; return &#123;&#x27;custom_params&#x27;: &#123;&#x27;view_items&#x27;: SCOPE.mlGetViewItems()&#125;&#125; &#125;&quot;, &quot;fieldShow&quot;: &quot;=function(_row,_col,value)&#123;var cell_template=&#x27;&lt;div&gt;&#x27;;var date_info=_row[_col[&#x27;field&#x27;][0]];if(date_info&amp;&amp;!date_info.click_enabled)&#123;cell_template+=`&lt;div class=\\&quot;icon icon-hcm-minus-circle\\&quot; style=\\&quot;color:#bbb;\\&quot; title=\\&quot;无权限查看今日考勤结果明细\\&quot;&gt;&lt;/div&gt;`;cell_template+=&#x27;&lt;/div&gt;&#x27;;return cell_template&#125; if(date_info&amp;&amp;date_info.date_status)&#123;if(date_info.date_status===\\&quot;no_schedule\\&quot;)&#123;cell_template+=`&lt;div class=\\&quot;icon icon-hcm-minus-circle\\&quot;style=\\&quot;color:#bbb;\\&quot; title=\\&quot;未排班\\&quot;&gt;&lt;/div&gt;`;cell_template+=&#x27;&lt;/div&gt;&#x27;;return cell_template&#125;&#125; if(!(date_info&amp;&amp;date_info.shift&amp;&amp;date_info.shift.id))&#123;return&#x27;&#x27;&#125;var view_items=SCOPE.mlGetViewItems();if(view_items.indexOf(&#x27;shift&#x27;)&gt;-1)&#123;var shift=date_info.shift?date_info.shift.name:&#x27;-&#x27;;var shift_style=&#x27;color:#333;display:block;white-space:nowrap;&#x27;;shift_style+=&#x27;font-size:&#x27;+(view_items.indexOf(&#x27;result&#x27;)&gt;-1?&#x27;10&#x27;:&#x27;14&#x27;)+&#x27;px;&#x27;;cell_template+=&#x27;&lt;div class=\\&quot;cell-content ellipsis-text\\&quot; style=\\&quot;&#x27;+shift_style+&#x27;\\&quot;&gt;&#x27;+shift+&#x27;&lt;/div&gt;&#x27;&#125;if(view_items.indexOf(&#x27;result&#x27;)&gt;-1)&#123;var result=date_info.result_item?date_info.result_item.desc:&#x27;-&#x27;;var result_class=[],_italic=false;if(date_info.status===-1)&#123;result_class.push(&#x27;color-gray&#x27;);_italic=true&#125;else if(result===&#x27;-&#x27;||(date_info.shift_id===-1&amp;&amp;date_info.result_item_id===&#x27;work_rest&#x27;))&#123;result_class.push(&#x27;color-gray&#x27;)&#125;else if(date_info.result_item&amp;&amp;date_info.result_item.priority&gt;=60)&#123;result_class.push(&#x27;color-red&#x27;);_italic=true&#125;else if(date_info.result_item&amp;&amp;date_info.result_item.priority&gt;=30&amp;&amp;date_info.result_item.priority&lt;60)&#123;result_class.push(&#x27;color-orange&#x27;)&#125;var result_style=&#x27;margin:2px 0;&#x27;;result_style+=_italic?&#x27;font-style:italic;&#x27;:&#x27;&#x27;;cell_template+=&#x27;&lt;div class=\\&quot;cell-content &#x27;+result_class.join(&#x27; &#x27;)+&#x27;\\&quot; style=\\&quot;&#x27;+result_style+&#x27;\\&quot;&gt;&#x27;+result+&#x27;&lt;/div&gt;&#x27;&#125;if(view_items.indexOf(&#x27;hours&#x27;)&gt;-1)&#123;var hours=date_info.attend_hours;hours=$filter(&#x27;isValidValue&#x27;)(hours)?hours:&#x27;-&#x27;;var hours_style=&#x27;color:#333;&#x27;;hours_style+=&#x27;font-size:&#x27;+(view_items.indexOf(&#x27;result&#x27;)&gt;-1?&#x27;10&#x27;:&#x27;14&#x27;)+&#x27;px;&#x27;;cell_template+=&#x27;&lt;div class=\\&quot;cell-content\\&quot; style=\\&quot;&#x27;+hours_style+&#x27;\\&quot;&gt;&#x27;+hours+&#x27;&lt;/div&gt;&#x27;&#125;var extra_items=view_items.filter(function(_i)&#123;return [&#x27;shift&#x27;,&#x27;result&#x27;,&#x27;hours&#x27;].indexOf(_i)===-1&#125;);extra_items.map(function(_item)&#123;var extra_value=$filter(&#x27;getValue&#x27;)(date_info,_item.split(&#x27;.&#x27;));extra_value=$filter(&#x27;isValidValue&#x27;)(extra_value)?extra_value:&#x27;-&#x27;;var extra_style=&#x27;color:#333;&#x27;;extra_style+=&#x27;font-size:&#x27;+(view_items.indexOf(&#x27;result&#x27;)&gt;-1?&#x27;10&#x27;:&#x27;14&#x27;)+&#x27;px;&#x27;;cell_template+=&#x27;&lt;div class=\\&quot;cell-content\\&quot; style=\\&quot;&#x27;+extra_style+&#x27;\\&quot;&gt;&#x27;+extra_value+&#x27;&lt;/div&gt;&#x27;&#125;);cell_template+=&#x27;&lt;/div&gt;&#x27;;return $filter(&#x27;toTrusted&#x27;)(cell_template)&#125;&quot;, &quot;empDateClick&quot;: &quot;=function(_row,_col)&#123;var _r=_row[_col[&#x27;field&#x27;][0]];if(!_r?.click_enabled)return;console.log(_row,_r);SCOPE.viewAppointItem(_r,&#123;model:&#x27;AttendDataResult&#x27;,state:&#x27;office_resultMonth&#x27;,id:_r.id?_r.id:&#123;employee_id:_row.employee.id,date:_col.date,depart_id:_r.depart_id,profile_type:_row.profile_type || 1&#125;&#125;,&#123;options:&#123;alter:&#123;employee_id:_row.employee.id,employee_name:_row.employee.name,date:_col.date,depart_id:_r.depart_id,origin_id:_row.origin_id&#125;&#125;&#125;).then(function()&#123;SCOPE.fetchData()&#125;)&#125;&quot;, &quot;empInfoClick&quot;: &quot;=function fn(_row)&#123;debugger;var profile_types=[];if(_row.profile_type)&#123;if(_row.profile_type==1)&#123;profile_types=[1,null]&#125;else&#123;profile_types=[2]&#125;&#125;else&#123;profile_types=[1,null]&#125;var depart_ids=[];for(let key in _row)&#123;if(key.startsWith(&#x27;month_data&#x27;))&#123;if(_row[key].depart_id&amp;&amp;!depart_ids.includes(_row[key].depart_id))&#123;depart_ids.push(_row[key].depart_id)&#125;&#125;&#125;filter_dict=&#123;&#x27;employee_id&#x27;:_row.employee.id,&#x27;date&#x27;:&#123;&#x27;gte&#x27;:SCOPE.begin_date,&#x27;lte&#x27;:SCOPE.end_date&#125;,&#x27;profile_type&#x27;:&#123;&#x27;in&#x27;:profile_types&#125;&#125;;if(depart_ids.length)&#123;filter_dict.depart_id=&#123;in:depart_ids&#125;&#125;if(_row?.employee?.id)&#123;SCOPE.super_commgo(&#x27;common_model_list&#x27;,&#123;&#x27;model&#x27;:&#x27;AttendDataResult&#x27;,&#x27;meta_state&#x27;:&#x27;emp_detail&#x27;,&#x27;filter_dict&#x27;:filter_dict,&#x27;custom_params&#x27;:&#123;&#x27;year_month&#x27;:SCOPE.filter_year_month&#125;,show_fields_key:null,&#125;,&#123;&#x27;inherit&#x27;:false&#125;)&#125;&#125;&quot;&#125; 使用hooks中的方法 使用方法：SCOPE.方法名，例如：SCOPE.empDateClick(参数)1234567891011121314151617fields: [ &#123; &quot;label&quot;: &quot;30\\n一&quot;, &quot;key&quot;: &quot;month_data_30&quot;, &quot;field&quot;: [ &quot;month_data_30&quot;, &quot;result_item&quot;, &quot;desc&quot; ], &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 80, &quot;sequence&quot;: 400, &quot;sortable&quot;: false, &quot;func&quot;: &quot;=function(_row,_col)&#123;return SCOPE.empDateClick(_row,_col)&#125;&quot;, &quot;fieldFunc&quot;: &quot;=function(_row,_col,value)&#123;return SCOPE.fieldShow(_row,_col,value)&#125;&quot; &#125;]","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"033-分析报表-合并单元格","slug":"项目/HCM教程/033-分析报表-合并单元格","date":"2025-05-31T14:44:25.000Z","updated":"2025-09-09T06:19:59.317Z","comments":true,"path":"2025/05/31/项目/HCM教程/033-分析报表-合并单元格/","link":"","permalink":"https://dbbruce.github.io/2025/05/31/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/033-%E5%88%86%E6%9E%90%E6%8A%A5%E8%A1%A8-%E5%90%88%E5%B9%B6%E5%8D%95%E5%85%83%E6%A0%BC/","excerpt":"云函数编写注意点 类型：报表公式 相同的合并数据放在一起，例如：序号、员工工号、姓名 3个单元格上下都合并12345678910111213141516171819202122232425[ &#123; &quot;rows&quot;: 1, &quot;number&quot;: &quot;3452&quot;, &quot;name&quot;: &quot;何华&quot;, &quot;date&quot;: &quot;2025-05-07&quot;, &quot;begin_time&quot;: &quot;2025-05-0718: 00: 00&quot;, &quot;end_time&quot;: &quot;2025-05-0719: 26: 00&quot;, &quot;overtime_normal&quot;: 1, &quot;overtime_rest&quot;: 0, &quot;overtime_holiday&quot;: 0 &#125;, &#123; &quot;rows&quot;: 1, &quot;number&quot;: &quot;3452&quot;, &quot;name&quot;: &quot;何华&quot;, &quot;date&quot;: &quot;2025-05-08&quot;, &quot;begin_time&quot;: &quot;2025-05-0818: 00: 00&quot;, &quot;end_time&quot;: &quot;2025-05-0818: 55: 00&quot;, &quot;overtime_normal&quot;: 0.5, &quot;overtime_rest&quot;: 0, &quot;overtime_holiday&quot;: 0 &#125;]","text":"云函数编写注意点 类型：报表公式 相同的合并数据放在一起，例如：序号、员工工号、姓名 3个单元格上下都合并12345678910111213141516171819202122232425[ &#123; &quot;rows&quot;: 1, &quot;number&quot;: &quot;3452&quot;, &quot;name&quot;: &quot;何华&quot;, &quot;date&quot;: &quot;2025-05-07&quot;, &quot;begin_time&quot;: &quot;2025-05-0718: 00: 00&quot;, &quot;end_time&quot;: &quot;2025-05-0719: 26: 00&quot;, &quot;overtime_normal&quot;: 1, &quot;overtime_rest&quot;: 0, &quot;overtime_holiday&quot;: 0 &#125;, &#123; &quot;rows&quot;: 1, &quot;number&quot;: &quot;3452&quot;, &quot;name&quot;: &quot;何华&quot;, &quot;date&quot;: &quot;2025-05-08&quot;, &quot;begin_time&quot;: &quot;2025-05-0818: 00: 00&quot;, &quot;end_time&quot;: &quot;2025-05-0818: 55: 00&quot;, &quot;overtime_normal&quot;: 0.5, &quot;overtime_rest&quot;: 0, &quot;overtime_holiday&quot;: 0 &#125;] 分析报表的配置 使用 &gt; 合并单元格 序号 工号 姓名 日期 开始时间 [LIST:main:&gt;{rows}] &gt;{number} &gt;{name} {date} {begin_time}","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"032-云函数-后台任务","slug":"项目/HCM教程/032-云函数-后台任务","date":"2025-05-31T12:44:25.000Z","updated":"2025-06-16T03:16:34.099Z","comments":true,"path":"2025/05/31/项目/HCM教程/032-云函数-后台任务/","link":"","permalink":"https://dbbruce.github.io/2025/05/31/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/032-%E4%BA%91%E5%87%BD%E6%95%B0-%E5%90%8E%E5%8F%B0%E4%BB%BB%E5%8A%A1/","excerpt":"后台任务代码示例","text":"后台任务代码示例 12345678910111213141516171819202122232425262728class PrivateAPIService(BasePrivateApiService): &quot;&quot;&quot; 动态私有OpenAPI 使用方法 &quot;&quot;&quot; def execute(self, **kwargs): try: ParallelTaskUtil.send_parallel_task( CustomerUtil.get_current_context().company.id, CustomerUtil.get_current_context().employee.id, &quot;后台同步企业微信打卡数据&quot;, &quot;private.GetWeixinCheckInData&quot;, [kwargs], queue=&quot;syn&quot;) self.log(&#x27;开始同步企业微信打卡数据.&#x27;) return &quot;开始同步企业微信打卡数据&quot; except Exception as e: self.log(traceback.format_exc()) raise e def log(self, log_content): log_info = &#123; &quot;log_type&quot;: str(&#x27;GetWeixinCheckInDataBackend&#x27;), &quot;create_time&quot;: datetime.datetime.now().strftime(&#x27;%Y-%m-%d %H:%M:%S&#x27;), &quot;content&quot;: str(log_content) &#125; CustomerUtil.call_open_api(&quot;hcm.model.create&quot;, &#123;&quot;model&quot;: &quot;dynamic_log&quot;, &quot;info&quot;: log_info&#125;)","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"031-干审表-干审表取数配置","slug":"项目/HCM教程/031-干审表-干审表取数配置","date":"2025-05-30T14:44:25.000Z","updated":"2025-09-09T06:19:59.320Z","comments":true,"path":"2025/05/30/项目/HCM教程/031-干审表-干审表取数配置/","link":"","permalink":"https://dbbruce.github.io/2025/05/30/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/031-%E5%B9%B2%E5%AE%A1%E8%A1%A8-%E5%B9%B2%E5%AE%A1%E8%A1%A8%E5%8F%96%E6%95%B0%E9%85%8D%E7%BD%AE/","excerpt":"干审表取数配置","text":"干审表取数配置 字段-取值 公式-取值 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071#V2#ret = &#x27;&#x27;# # 查询全日制教育经历edu_list = MODEL_LIST(model_name=&quot;EmployeeEducation&quot;, filter_dict=&#123;&quot;employee_id&quot;: employee_id, &quot;u_education_form_id&quot;: 15734929&#125;, page_size=999, extra_property=&#123;&quot;state&quot;: &quot;inside&quot;, &quot;fields&quot;: [ &#123;&quot;key&quot;: &quot;education&quot;, &quot;field&quot;: [&quot;u_education&quot;,&quot;name&quot;]&#125;, &#123;&quot;key&quot;: &quot;is_highest&quot;, &quot;field&quot;: [&quot;is_highest&quot;]&#125;, &#123;&quot;key&quot;: &quot;is_first&quot;, &quot;field&quot;: [&quot;is_first&quot;]&#125;, &#123;&quot;key&quot;: &quot;is_highest_deg&quot;, &quot;field&quot;: [&quot;is_highest_deg&quot;]&#125;, &#123;&quot;key&quot;: &quot;degree&quot;, &quot;field&quot;: [&quot;u_degree&quot;,&quot;name&quot;]&#125;, &#123;&quot;key&quot;: &quot;school&quot;, &quot;field&quot;: [&quot;school&quot;]&#125;, &#123;&quot;key&quot;: &quot;specialty&quot;, &quot;field&quot;: [&quot;u_major&quot;]&#125;, &#123;&quot;key&quot;: &quot;u_degree&quot;, &quot;field&quot;: [&quot;u_degree&quot;, &quot;name&quot;]&#125;, &#123;&quot;key&quot;: &quot;u_degree&quot;, &quot;field&quot;: [&quot;u_degree&quot;, &quot;parent_id&quot;]&#125; ] &#125;)if edu_list: first_edu_list = [_ for _ in edu_list if _.get(&quot;is_highest&quot;) == 1] # 最高学历 if first_edu_list: s1=first_edu_list[0].get(&quot;school&quot;,&quot;&quot;) s2=first_edu_list[0].get(&quot;u_major&quot;,&quot;&quot;) ret=s1 + &#x27;\\n&#x27; + s2 else: first_edu_dict = edu_list[0] s1=first_edu_dict.get(&quot;school&quot;,&quot;&quot;) s2=first_edu_dict.get(&quot;u_major&quot;,&quot;&quot;) ret=s1 + &#x27;\\n&#x27; + s2# LOGGING_INFO(first_edu_list)# LOGGING_INFO(first_edu_list)# first_edu_info = first_edu_list[0] if first_edu_list else None# other_edu_list = [_ for _ in edu_list if _.get(&quot;is_first&quot;) == &#x27;0&#x27;]# # 第一学历以及学历名称相同# all_edu_list = first_edu_list + other_edu_list# first_degree =first_edu_info.get(&#x27;u_degree&#x27;) if first_edu_info else None# first_deg_list = [first_edu_info] if first_edu_info else []# ohther_deg_list = []# if first_degree:# # degree_name_list = [_.get(&quot;degree&quot;, &#123;&#125;).get(&#x27;name&#x27;) for _ in edu_list if _.get(&quot;u_degree&quot;, &#123;&#125;)]# degree_name_list = [first_degree.get(&#x27;name&#x27;, &#x27;&#x27;)]# item_list = MODEL_LIST(model_name=&quot;common_basic_tree_item_data.学位&quot;,filter_dict=&#123;&quot;name&quot;: degree_name_list, &quot;enable&quot;: True&#125;, page_size=999,extra_property=&#123;&quot;fields&quot;: [&#123;&quot;key&quot;: &quot;name&quot;, &quot;field&quot;: [&quot;name&quot;]&#125;,&#123;&quot;key&quot;: &quot;parent_id&quot;, &quot;field&quot;: [&quot;parent_id&quot;]&#125;]&#125;)# item_dict = &#123;_item.get(&quot;name&quot;): _item for _item in item_list&#125;# first_parent_id = item_dict.get(first_degree.get(&#x27;name&#x27;, &#x27;&#x27;),&#123;&#125;).get(&quot;parent_id&quot;)# if first_parent_id:# for _edu_info in edu_list:# if _edu_info[&#x27;id&#x27;] != first_edu_info[&#x27;id&#x27;] and (item_dict.get(_edu_info.get(&#x27;u_degree&#x27;,&#123;&#125;).get(&quot;name&quot;, &#x27;&#x27;),&#123;&#125;)).get(&quot;parent_id&quot;, &quot;&quot;) == first_parent_id:# ohther_deg_list.append(_edu_info)# # 最高学位以及学位parent_id相同# all_deg_list = first_deg_list + ohther_deg_list# #all_edu_schools = [f&quot;&#123;_.get(&#x27;school&#x27;)&#125;&#123;_.get(&#x27;specialty&#x27;)&#125;&quot; for _ in all_edu_list]# all_edu_schools = [ _ for _ in edu_list if _.get(&quot;is_first&quot;) == &#x27;1&#x27;]# # 学校+专业相同的去重# all_deg_list_filter = [_ for _ in all_deg_list if f&quot;&#123;_.get(&#x27;school&#x27;)&#125;&#123;_.get(&#x27;u_major&#x27;)&#125;&quot; not in all_edu_schools]# d = &#123;&#125;# for _ in all_edu_list:# d.setdefault(_[&#x27;school&#x27;], []).append(_[&#x27;u_major&#x27;])# edu_msg = &#x27;、&#x27;.join(f&quot;&#123;sch&#125;&#123;&#x27;、&#x27;.join(spe) if len(spe) &gt; 1 else spe[0]&#125;&quot; for sch, spe in d.items())# d = &#123;&#125;# for _ in all_deg_list_filter:# d.setdefault(_[&#x27;school&#x27;], []).append(_[&#x27;u_major&#x27;])# deg_msg = &#x27;、&#x27;.join(f&quot;&#123;sch&#125;&#123;&#x27;、&#x27;.join(spe) if len(spe) &gt; 1 else spe[0]&#125;&quot; for sch, spe in d.items())# if edu_msg and deg_msg:# ret = edu_msg + &#x27;\\n&#x27; + deg_msg# elif edu_msg:# ret = edu_msg# elif deg_msg:# ret = deg_msg","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"030-干审表-代码","slug":"项目/HCM教程/030-干审表-代码","date":"2025-05-30T12:44:25.000Z","updated":"2025-09-09T06:19:59.432Z","comments":true,"path":"2025/05/30/项目/HCM教程/030-干审表-代码/","link":"","permalink":"https://dbbruce.github.io/2025/05/30/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/030-%E5%B9%B2%E5%AE%A1%E8%A1%A8-%E4%BB%A3%E7%A0%81/","excerpt":"代码实例 appointment_dismissal_basic_info","text":"代码实例 appointment_dismissal_basic_info 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587588589590591592593594595596597598599600601602603604605606607608609610611612613614615616617618619620621622623624625626627628629630631632633634635636637638639640641642643644645646647648649650651652653654655656657658659660661662663664665666667668669670671672673674675676677678679680681682683684685686687688689690691692693694695696697698699700701702703704705706707708709710711712713714715716717718719720721722723724725726727728729730731732733734735736737738739740741742743744745746747748749750751752753754755756757758759760761762763764765766767768769770771772773774775776777778779780781782783784785786787788789790791792793794795796797798799800801802803804805806807808809810811812813814815816817818819820821822823824825826827828829830831832833834835836837838839840841842843844845846847848849850851852853854855856857858859860861862863864865866867868869870871872873874875876877878879880881882883884885886887888889890891892893894895896897898899900901902903904905906907908909910911912913914915916917918919920921922923924925926927class appointment_dismissal_basic_info(object): &quot;&quot;&quot; 其他类别云函数 &quot;&quot;&quot; def execute(self, param): try: #self.log(param) employee_id = param.get(&quot;employee_id&quot;) or &quot;&quot; emp_info = CustomerUtil.call_open_api(&quot;hcm.model.get&quot;,&#123; &quot;model&quot;: &quot;Employee&quot;, &quot;id_&quot;: employee_id &#125;) native_place=emp_info.get(&quot;native_place&quot;,&quot;&quot;)#.replace(&#x27;县&#x27;,&#x27;&#x27;).replace(&#x27;区&#x27;,&#x27;&#x27;).replace(&#x27;市&#x27;,&#x27;&#x27;) if emp_info.get(&quot;native_place&quot;,&quot;&quot;) else &quot;&quot; param[&quot;info&quot;][&quot;Employee#native_place&quot;]=native_place birth_place=emp_info.get(&quot;birth_place&quot;,&quot;&quot;)#.replace(&#x27;县&#x27;,&#x27;&#x27;).replace(&#x27;区&#x27;,&#x27;&#x27;).replace(&#x27;市&#x27;,&#x27;&#x27;) if emp_info.get(&quot;birth_place&quot;,&quot;&quot;) else &quot;&quot; param[&quot;info&quot;][&quot;Employee#birth_place&quot;]=birth_place img=emp_info.get(&quot;photo&quot;,&quot;&quot;) if img: param[&quot;info&quot;][&quot;image_person&quot;]=img param[&quot;info&quot;][&quot;specialty_hcm&quot;]=emp_info.get(&quot;specialty_hcm&quot;,&quot;&quot;) #政治面貌 param[&quot;info&quot;][&quot;last_political#begin_date&quot;]=&quot;&quot; zhengzhi=CustomerUtil.call_open_api(&quot;hcm.model.list&quot;, &#123; &quot;model&quot;: &quot;EmployeePoliticalLandscape&quot;, &quot;filter_dict&quot;: &#123;&quot;employee_id&quot;:employee_id&#125; &#125;)[&quot;list&quot;] if zhengzhi: res=[] for z in zhengzhi: if z.get(&quot;political_landsc&quot;,&#123;&#125;).get(&quot;name&quot;,&quot;&quot;) in [&quot;中共党员&quot;,&quot;预备党员&quot;] and z[&quot;begin_date&quot;]: res.append(z[&quot;begin_date&quot;][:7].replace(&#x27;-&#x27;,&#x27;.&#x27;)) elif z.get(&quot;political_landsc&quot;,&#123;&#125;).get(&quot;name&quot;,&quot;&quot;) in [&quot;中共党员&quot;,&quot;预备党员&quot;] and not z[&quot;begin_date&quot;]: break elif z.get(&quot;political_landsc&quot;,&#123;&#125;).get(&quot;name&quot;,&quot;&quot;) in [&quot;群众&quot;]: break else: res.append(z[&quot;political_landsc&quot;][&quot;name&quot;]) param[&quot;info&quot;][&quot;last_political#begin_date&quot;]=&#x27;\\n&#x27;.join(res) #教育信息 edu_list=CustomerUtil.call_open_api(&quot;hcm.model.list&quot;, &#123; &quot;model&quot;: &quot;EmployeeEducation&quot;, &quot;filter_dict&quot;:&#123; &quot;employee_id&quot;:employee_id, &#125;, &quot;extra_property&quot;:&#123; &quot;state&quot;:&quot;inside&quot; &#125; &#125;)[&quot;list&quot;] #全日制 quanrizhi=[x for x in edu_list if x[&quot;education_form&quot;]==&quot;全日制教育&quot; and x[&quot;from_date&quot;]] quanrizhi=sorted(quanrizhi,key=lambda quanrizhi:quanrizhi[&quot;from_date&quot;],reverse=True) q_education=&quot;&quot; q_degree=&quot;&quot; q_school=[] full_education=&quot;&quot; for i in quanrizhi: if q_education and q_degree: break education=i.get(&quot;education&quot;,&quot;&quot;) if &quot;研究生&quot; in education: full_education=&quot;研究生&quot; elif &quot;大学本科&quot; in education or &quot;大学普通&quot; in education: full_education=&quot;大学&quot; elif &quot;大学专科&quot; in education: full_education=&quot;大专&quot; elif &quot;中等专科&quot; in education or &quot;职业高中&quot; in education or &quot;技工学校&quot; in education: full_education=&quot;中专&quot; elif &quot;普通高中&quot; in education: full_education=&quot;高中&quot; elif &quot;初中&quot; in education or &quot;小学&quot; in education: full_education=education.replace(&quot;毕业&quot;,&quot;&quot;).replace(&quot;结业&quot;,&quot;&quot;).replace(&quot;肄业&quot;,&quot;&quot;) else: full_education=education if full_education and not q_education: q_education=full_education.replace(&quot;毕业&quot;,&quot;&quot;).replace(&quot;结业&quot;,&quot;&quot;).replace(&quot;肄业&quot;,&quot;&quot;) if i.get(&quot;school&quot;,&quot;&quot;) and i.get(&quot;specialty&quot;,&quot;&quot;): q_school.append(i.get(&quot;school&quot;,&quot;&quot;)+i.get(&quot;specialty&quot;,&quot;&quot;)+&quot;专业&quot;) degree=i.get(&quot;degree&quot;,&quot;&quot;) if degree and not q_degree: full_degree=degree.replace(&#x27;学位&#x27;,&#x27;&#x27;) q_degree=full_degree if i.get(&quot;school&quot;,&quot;&quot;)+i.get(&quot;specialty&quot;,&quot;&quot;)+&quot;专业&quot; !=q_school[0]: q_school.append(i.get(&quot;school&quot;,&quot;&quot;)+i.get(&quot;specialty&quot;,&quot;&quot;)+&quot;专业&quot;) param[&quot;info&quot;][&quot;full_education#education&quot;]=&#x27;\\n&#x27;.join([x for x in [q_education,q_degree] if x]) param[&quot;info&quot;][&quot;full_education#school&quot;]=&#x27;\\n&#x27;.join(q_school) if full_education in [&quot;小学&quot;,&quot;高中&quot;]: param[&quot;info&quot;][&quot;full_education#school&quot;]=&quot;&quot; #在职 zaizhi=[x for x in edu_list if x[&quot;education_form&quot;]==&quot;在职教育&quot; and x[&quot;from_date&quot;]] zaizhi=sorted(zaizhi,key=lambda zaizhi:zaizhi[&quot;from_date&quot;],reverse=True) z_education=&quot;&quot; z_degree=&quot;&quot; z_school=[] work_education=&quot;&quot; edu_degree=[] for i in zaizhi: if z_education: break education=i.get(&quot;education&quot;,&quot;&quot;) if education: if &quot;研究生&quot; in education and &quot;党校&quot; not in education: work_education=&quot;研究生&quot; elif (&quot;大学本科&quot; in education or &quot;大学普通&quot; in education) and &quot;党校&quot; not in education: work_education=&quot;大学&quot; elif &quot;大学专科&quot; in education: work_education=&quot;大专&quot; elif &quot;中等专科&quot; in education or &quot;职业高中&quot; in education or &quot;技工学校&quot; in education: work_education=&quot;中专&quot; elif &quot;普通高中&quot; in education: work_education=&quot;高中&quot; elif &quot;初中&quot; in education or &quot;小学&quot; in education: work_education=education.replace(&quot;毕业&quot;,&quot;&quot;).replace(&quot;结业&quot;,&quot;&quot;).replace(&quot;肄业&quot;,&quot;&quot;) else: work_education=education #if not z_education: z_education=work_education.replace(&quot;毕业&quot;,&quot;&quot;).replace(&quot;结业&quot;,&quot;&quot;).replace(&quot;肄业&quot;,&quot;&quot;) if z_education: edu_degree.append(z_education) specialty=i.get(&quot;specialty&quot;,&quot;&quot;) if &quot;（函授）&quot; in specialty: specialty=specialty.replace(&#x27;（函授）&#x27;,&#x27;&#x27;) z_school.append(i.get(&quot;school&quot;,&quot;&quot;)+specialty+&quot;专业（函授）&quot;) else: z_school.append(i.get(&quot;school&quot;,&quot;&quot;)+specialty+&quot;专业&quot;) for i in zaizhi: if z_degree: break degree=i.get(&quot;degree&quot;,&quot;&quot;) if degree and not z_degree: work_degree=degree.replace(&#x27;学位&#x27;,&#x27;&#x27;) z_degree=work_degree if z_degree: edu_degree.append(z_degree) specialty=i.get(&quot;specialty&quot;,&quot;&quot;) if &quot;（函授）&quot; in specialty: specialty=specialty.replace(&#x27;（函授）&#x27;,&#x27;&#x27;) zz_school=i.get(&quot;school&quot;,&quot;&quot;)+specialty+&quot;专业（函授）&quot; else: zz_school=i.get(&quot;school&quot;,&quot;&quot;)+specialty+&quot;专业&quot; if z_school: if zz_school !=z_school[0]: specialty=i.get(&quot;specialty&quot;,&quot;&quot;) if &quot;（函授）&quot; in specialty: specialty=specialty.replace(&#x27;（函授）&#x27;,&#x27;&#x27;) z_school.append(i.get(&quot;school&quot;,&quot;&quot;)+specialty+&quot;专业（函授）&quot;) else: z_school.append(i.get(&quot;school&quot;,&quot;&quot;)+specialty+&quot;专业&quot;) else: specialty=i.get(&quot;specialty&quot;,&quot;&quot;) if &quot;（函授）&quot; in specialty: specialty=specialty.replace(&#x27;（函授）&#x27;,&#x27;&#x27;) z_school.append(i.get(&quot;school&quot;,&quot;&quot;)+specialty+&quot;专业（函授）&quot;) else: z_school.append(i.get(&quot;school&quot;,&quot;&quot;)+specialty+&quot;专业&quot;) param[&quot;info&quot;][&quot;work_education#education&quot;]=&#x27;\\n&#x27;.join(edu_degree) param[&quot;info&quot;][&quot;work_education#school&quot;]=&#x27;\\n&#x27;.join(z_school) if work_education in [&quot;小学&quot;,&quot;高中&quot;]: param[&quot;info&quot;][&quot;work_education#school&quot;]=&quot;&quot; #家庭信息 emp_family=CustomerUtil.call_open_api(&quot;hcm.model.list&quot;, &#123; &quot;model&quot;: &quot;FamilyInformation&quot;, &quot;filter_dict&quot;: &#123; &quot;employee_id&quot;:employee_id &#125;, &quot;page_size&quot;:99, &quot;extra_property&quot;:&#123;&quot;state&quot;:&quot;inside&quot;&#125; &#125;)[&quot;list&quot;] family_new=[] for i in emp_family: info=&#123;&#125; info[&quot;FamilyInformation#appellat&quot;]=i[&quot;appellat&quot;][&quot;name&quot;] info[&quot;FamilyInformation#name&quot;]=i[&quot;name&quot;] info[&quot;FamilyInformation#age&quot;]=i[&quot;age&quot;] info[&quot;FamilyInformation#politi&quot;]=i[&quot;politi&quot;][&quot;name&quot;] info[&quot;job&quot;]=i[&quot;unit_job&quot;] family_new.append(info) family_new_age=[] for i in family_new: if i[&quot;FamilyInformation#age&quot;]==0: i[&quot;FamilyInformation#age&quot;]=1 family_new_age.append(i) else: family_new_age.append(i) family_new=family_new_age cp=[x for x in family_new if x[&quot;FamilyInformation#appellat&quot;] in [&quot;丈夫&quot;,&quot;妻子&quot;]] fuqin=[x for x in family_new if x[&quot;FamilyInformation#appellat&quot;] in [&quot;父亲&quot;]] muqin=[x for x in family_new if x[&quot;FamilyInformation#appellat&quot;] in [&quot;母亲&quot;]] haizi=[x for x in family_new if x[&quot;FamilyInformation#appellat&quot;] not in [&quot;丈夫&quot;,&quot;妻子&quot;,&quot;父亲&quot;,&quot;母亲&quot;]] all=cp+haizi+fuqin+muqin family_new=all if len(family_new) &lt; 7: for i in range(0, 7 - len(family_new)): family_new.append(&#123;&#125;) param[&quot;info&quot;][&quot;FamilyInformation&quot;]=family_new #奖惩信息 award_publist=&quot;&quot; award=CustomerUtil.call_open_api(&quot;hcm.model.list&quot;, &#123; &quot;model&quot;: &quot;RewardInformation&quot;, &quot;filter_dict&quot;: &#123; &quot;employee_id&quot;:employee_id &#125;, &quot;page_size&quot;:99, &quot;extra_property&quot;:&#123;&quot;state&quot;:&quot;inside&quot;&#125; &#125;)[&quot;list&quot;] awards=[] aw=&quot;&quot; if award: for i in award: if i[&quot;obtain_date&quot;]: if not i[&quot;vote_unit&quot;]: awards.append(f&quot;&#123;i[&#x27;obtain_date&#x27;][:4]&#125;年&#123;int(i[&#x27;obtain_date&#x27;][5:7])&#125;月，被评为&#123;i[&#x27;name&#x27;]&#125;&quot;) else: awards.append(f&quot;&#123;i[&#x27;obtain_date&#x27;][:4]&#125;年&#123;int(i[&#x27;obtain_date&#x27;][5:7])&#125;月，经&#123;i[&#x27;vote_unit&#x27;]&#125;表彰，被评为&#123;i[&#x27;name&#x27;]&#125;&quot;) aw=&quot;；&quot;.join(awards) if aw: aw=aw+&quot;。&quot; publish=CustomerUtil.call_open_api(&quot;hcm.model.list&quot;, &#123; &quot;model&quot;: &quot;EmployeePunishmentInfo&quot;, &quot;filter_dict&quot;: &#123; &quot;employee_id&quot;:employee_id &#125;, &quot;page_size&quot;:99, &quot;extra_property&quot;:&#123;&quot;state&quot;:&quot;inside&quot;&#125; &#125;)[&quot;list&quot;] pushlishs=[] pu=&quot;&quot; if publish: for i in publish: if i[&#x27;punishment_date&#x27;]: #没有撤销 if not i[&quot;revoked_punishment_date&quot;]: #没有惩处单位 if not i[&quot;punishment_unit&quot;]: #没有惩处原因 if not i[&quot;u_punishment_cause&quot;]: pushlishs.append(f&quot;&#123;i[&#x27;punishment_date&#x27;][:4]&#125;年&#123;int(i[&#x27;punishment_date&#x27;][5:7])&#125;月，&#123;i[&#x27;punishment_name&#x27;]&#125;&quot;) #有惩处原因 else: pushlishs.append(f&quot;&#123;i[&#x27;punishment_date&#x27;][:4]&#125;年&#123;int(i[&#x27;punishment_date&#x27;][5:7])&#125;月，&#123;i[&#x27;u_punishment_cause&#x27;]&#125;，&#123;i[&#x27;punishment_name&#x27;]&#125;&quot;) #有惩处单位 else: #没有惩处原因 if not i[&quot;u_punishment_cause&quot;]: pushlishs.append(f&quot;&#123;i[&#x27;punishment_date&#x27;][:4]&#125;年&#123;int(i[&#x27;punishment_date&#x27;][5:7])&#125;月，&#123;i[&#x27;punishment_unit&#x27;]&#125;&#123;i[&#x27;punishment_name&#x27;]&#125;&quot;) #有惩处原因 else: pushlishs.append(f&quot;&#123;i[&#x27;punishment_date&#x27;][:4]&#125;年&#123;int(i[&#x27;punishment_date&#x27;][5:7])&#125;月，&#123;i[&#x27;u_punishment_cause&#x27;]&#125;，&#123;i[&#x27;punishment_unit&#x27;]&#125;&#123;i[&#x27;punishment_name&#x27;]&#125;&quot;) #有撤销 else: #没有惩处单位 if not i[&quot;punishment_unit&quot;]: #没有惩处原因 if not i[&quot;u_punishment_cause&quot;]: pushlishs.append(f&quot;&#123;i[&#x27;punishment_date&#x27;][:4]&#125;年&#123;int(i[&#x27;punishment_date&#x27;][5:7])&#125;月，&#123;i[&#x27;punishment_name&#x27;]&#125;，&#123;i[&#x27;revoked_punishment_date&#x27;][:4]&#125;年&#123;i[&#x27;revoked_punishment_date&#x27;][5:7]&#125;月按期解除&quot;) #有惩处原因 else: pushlishs.append(f&quot;&#123;i[&#x27;punishment_date&#x27;][:4]&#125;年&#123;int(i[&#x27;punishment_date&#x27;][5:7])&#125;月，&#123;i[&#x27;u_punishment_cause&#x27;]&#125;，&#123;i[&#x27;punishment_name&#x27;]&#125;，&#123;i[&#x27;revoked_punishment_date&#x27;][:4]&#125;年&#123;i[&#x27;revoked_punishment_date&#x27;][5:7]&#125;月按期解除&quot;) #有惩处单位 else: #没有惩处原因 if not i[&quot;u_punishment_cause&quot;]: pushlishs.append(f&quot;&#123;i[&#x27;punishment_date&#x27;][:4]&#125;年&#123;int(i[&#x27;punishment_date&#x27;][5:7])&#125;月，&#123;i[&#x27;punishment_unit&#x27;]&#125;&#123;i[&#x27;punishment_name&#x27;]&#125;，&#123;i[&#x27;revoked_punishment_date&#x27;][:4]&#125;年&#123;i[&#x27;revoked_punishment_date&#x27;][5:7]&#125;月按期解除&quot;) #有惩处原因 else: pushlishs.append(f&quot;&#123;i[&#x27;punishment_date&#x27;][:4]&#125;年&#123;int(i[&#x27;punishment_date&#x27;][5:7])&#125;月，&#123;i[&#x27;u_punishment_cause&#x27;]&#125;，经&#123;i[&#x27;punishment_unit&#x27;]&#125;&#123;i[&#x27;punishment_name&#x27;]&#125;，&#123;i[&#x27;revoked_punishment_date&#x27;][:4]&#125;年&#123;i[&#x27;revoked_punishment_date&#x27;][5:7]&#125;月按期解除&quot;) pu=&quot;；&quot;.join(pushlishs) if pu: pu=pu+&quot;。&quot; award_publist=aw+pu if not award_publist: award_publist=&quot;无&quot; param[&quot;info&quot;][&quot;special_text_award_str&quot;]=award_publist # self.log(award_publist) if award_publist.count(&#x27;；&#x27;)&gt;=3: param[&quot;info&quot;][&quot;special_text_award_str_style&quot;]=&#123;&quot;font&quot;:&#123;&quot;size&quot;:8&#125;&#125; kaohe=CustomerUtil.call_open_api(&quot;hcm.model.list&quot;, &#123; &quot;model&quot;: &quot;employee_dynamic_subset.AnnualCheck&quot;, &quot;filter_dict&quot;: &#123; &quot;employee_id&quot;:employee_id &#125;, &quot;page_size&quot;:99, &quot;extra_property&quot;:&#123;&quot;state&quot;:&quot;inside&quot;&#125; &#125;)[&quot;list&quot;] kaohe_list=[] now_year=datetime.datetime.now().year kaohe=[x for x in kaohe if x[&quot;u_annual&quot;] and (int(now_year)-int(x[&quot;u_annual&quot;]))&lt;=3] for i in kaohe: level=i.get(&#x27;u_result&#x27;,&#x27;&#x27;) le=&#x27;&#x27; if level==&quot;1&quot;: le=&quot;优秀&quot; if level==&quot;2&quot;: le=&quot;良好&quot; if level==&quot;3&quot;: le=&quot;称职&quot; if level==&quot;4&quot;: le=&quot;基本称职&quot; if level==&quot;5&quot;: le=&quot;不称职&quot; if level==&quot;6&quot;: le=&quot;A+(优秀)&quot; if level==&quot;7&quot;: le=&quot;A(良好)&quot; if level==&quot;8&quot;: le=&quot;B(称职)&quot; if level==&quot;9&quot;: le=&quot;C(基本称职)&quot; if level==&quot;10&quot;: le=&quot;D(不称职)&quot; if level==&quot;11&quot;: le=&quot;不确定等次&quot; kaohe_list.append(f&quot;&#123;i.get(&#x27;u_annual&#x27;,&#x27;&#x27;)&#125;年年度考核&#123;le&#125;&quot;) param[&quot;info&quot;][&quot;result&quot;]=&quot;，&quot;.join(kaohe_list) #教育信息 edu_list2=CustomerUtil.call_open_api(&quot;hcm.model.list&quot;, &#123; &quot;model&quot;: &quot;EmployeeEducation&quot;, &quot;filter_dict&quot;:&#123; &quot;employee_id&quot;:employee_id &#125;, &quot;extra_property&quot;:&#123; &quot;state&quot;:&quot;inside&quot; &#125; &#125;)[&quot;list&quot;] quanzhi_edu_list=[x for x in edu_list2 if x[&quot;from_date&quot;] and x[&quot;end_date&quot;] and x[&quot;education_form&quot;]==&quot;全日制教育&quot;] edu=[] if quanzhi_edu_list: for i in quanzhi_edu_list: school=i.get(&quot;school&quot;,&quot;&quot;) specialty=i.get(&quot;specialty&quot;,&quot;&quot;) if i[&quot;education&quot;] in [&quot;普通高中毕业&quot;,&quot;普通高中结业&quot;,&quot;普通高中肄业&quot;]: #edu.append(f&quot;&#123;i[&#x27;from_date&#x27;][:7].replace(&#x27;-&#x27;,&#x27;.&#x27;)&#125;--&#123;i[&#x27;end_date&#x27;][:7].replace(&#x27;-&#x27;,&#x27;.&#x27;)&#125; &#123;i[&#x27;school&#x27;]&#125;&#123;i[&#x27;specialty&#x27;]&#125;学习&quot;) continue else: xueli=i.get(&quot;education&quot;,&quot;&quot;) if &quot;大学本科&quot; in i[&quot;education&quot;] or &quot;大学普通班&quot; in i[&quot;education&quot;]: xueli=&quot;大学&quot; if &quot;大学专科&quot; in i[&quot;education&quot;]: xueli=&quot;大专&quot; if &quot;中等专科&quot; in i[&quot;education&quot;]: xueli=&quot;中专&quot; if &quot;硕士研究生&quot; in i[&quot;education&quot;]: xueli=&quot;硕士&quot; if &quot;博士研究生&quot; in i[&quot;education&quot;]: xueli=&quot;博士&quot; if &quot;研究生班&quot; in i[&quot;education&quot;]: xueli=&quot;研究生&quot; if &quot;大学本科&quot; in i[&quot;education&quot;]: xueli=&quot;大学&quot; if &quot;大学本科&quot; in i[&quot;education&quot;]: xueli=&quot;大学&quot; if &quot;大学本科&quot; in i[&quot;education&quot;]: xueli=&quot;大学&quot; if xueli: xueli=xueli.replace(&#x27;毕业&#x27;,&#x27;&#x27;) #degree=i[&quot;degree&quot;] if specialty: s=f&quot;&#123;i[&#x27;from_date&#x27;][:7].replace(&#x27;-&#x27;,&#x27;.&#x27;)&#125;--&#123;i[&#x27;end_date&#x27;][:7].replace(&#x27;-&#x27;,&#x27;.&#x27;)&#125; &#123;school&#125;&#123;specialty&#125;专业学习&quot; else: s=f&quot;&#123;i[&#x27;from_date&#x27;][:7].replace(&#x27;-&#x27;,&#x27;.&#x27;)&#125;--&#123;i[&#x27;end_date&#x27;][:7].replace(&#x27;-&#x27;,&#x27;.&#x27;)&#125; &#123;school&#125;&#123;xueli&#125;学习&quot; #if degree: # s=s+&quot;,&quot;+degree #s=s.replace(&#x27;None&#x27;,&#x27;&#x27;) edu.append(s) #技术职务 param[&quot;info&quot;][&quot;last_technical#skills_name&quot;]=&#x27;&#x27; skill=CustomerUtil.call_open_api(&quot;hcm.model.list&quot;, &#123; &quot;model&quot;: &quot;TechnicalSkills&quot;, &quot;filter_dict&quot;:&#123; &quot;employee_id&quot;:employee_id &#125;, &quot;extra_property&quot;:&#123; &quot;state&quot;:&quot;inside&quot; &#125; &#125;)[&quot;list&quot;] if skill: skill_list=[] for j in [&quot;高级&quot;,&quot;中级&quot;,&quot;初级&quot;,&quot;未知&quot;]: skill_list=[x[&quot;technical_skills_n&quot;][&quot;name&quot;] for x in skill if x[&quot;technical_title_level&quot;]==j] if skill_list: break if skill_list: param[&quot;info&quot;][&quot;last_technical#skills_name&quot;]=&#x27;、&#x27;.join(skill_list) else: param[&quot;info&quot;][&quot;last_technical#skills_name&quot;]=skill[0][&quot;technical_skills_n&quot;][&quot;name&quot;] #单位名称 unit_info=CustomerUtil.call_open_api(&quot;hcm.model.get&quot;,&#123; &quot;model&quot;: &quot;OrgUnit&quot;, &quot;id_&quot;:17658273 &#125;) unit_name=unit_info.get(&quot;name&quot;) #现任职信息 curr=CustomerUtil.call_open_api(&quot;hcm.model.list&quot;, &#123; &quot;model&quot;: &quot;JobInformationMaster&quot;, &quot;filter_dict&quot;:&#123; &quot;employee_id&quot;:employee_id, &quot;position_type&quot;:[1,2] &#125;, &quot;extra_property&quot;:&#123; &quot;state&quot;:&quot;inside&quot; &#125; &#125;)[&quot;list&quot;] curr_pos=&quot;&quot; pos3=&quot;&quot; jianzhi_list=&quot;&quot; if curr: #主任职 info=[x for x in curr if x[&quot;position_type&quot;]==1][0] pos_shuxing,pos_id=self.get_parent_dep(info[&quot;position&quot;][&quot;origin_id&quot;]) if pos_id: dep_name=self.get_dept_level(pos_shuxing,pos_id) curr_pos=unit_name+dep_name+info[&quot;position&quot;][&quot;name&quot;] pos3=&quot;&#123;&#125;--&#123;&#125; &#123;&#125;&quot;.format(info[&quot;begin_date&quot;][:7].replace(&#x27;-&#x27;,&#x27;.&#x27;),&quot;2199.12&quot;,curr_pos) #兼职 info2=[x for x in curr if x[&quot;position_type&quot;]==2 and x[&quot;action&quot;][&quot;name&quot;]!=&quot;兼职结束&quot;] jianzhi=[] for i in info2: pos_shuxing,pos_id=self.get_parent_dep(i[&quot;position&quot;][&quot;origin_id&quot;]) if pos_id: dep_name=self.get_dept_level(pos_shuxing,pos_id) if i[&quot;position&quot;][&quot;name&quot;]==&quot;团委书记&quot;: jianzhi_pos=i[&quot;position&quot;][&quot;name&quot;] else: jianzhi_pos=dep_name+i[&quot;position&quot;][&quot;name&quot;] jianzhi.append(jianzhi_pos) if jianzhi: jianzhi_list=&#x27;、&#x27;.join(jianzhi) curr_pos=curr_pos+&#x27;兼任&#x27;+jianzhi_list pos3=pos3+&#x27;兼任&#x27;+jianzhi_list param[&quot;info&quot;][&quot;Employee#current_pos&quot;]=curr_pos #主任职处理 job_zhurenzhi=CustomerUtil.call_open_api(&quot;hcm.model.list&quot;, &#123; &quot;model&quot;: &quot;JobInformation&quot;, &quot;filter_dict&quot;:&#123; &quot;employee_id&quot;:employee_id, &quot;position_type&quot;:1 &#125;, &quot;extra_property&quot;:&#123; &quot;state&quot;:&quot;history&quot; &#125; &#125;)[&quot;list&quot;] job_zhurenzhi_list=[] if job_zhurenzhi: for i in job_zhurenzhi: pos_shuxing,pos_id=self.get_parent_dep(i[&quot;position&quot;][&quot;origin_id&quot;]) if pos_id: dep_name=self.get_dept_level(pos_shuxing,pos_id) curr_pos=unit_name+dep_name+i[&quot;position&quot;][&quot;name&quot;] end_date=i[&quot;end_date&quot;] if end_date==&quot;至今&quot;: end_date=&quot;2199-12-31&quot; pos3=&quot;&#123;&#125;--&#123;&#125; &#123;&#125;&quot;.format(i[&quot;begin_date&quot;][:7].replace(&#x27;-&#x27;,&#x27;.&#x27;),end_date[:7].replace(&#x27;-&#x27;,&#x27;.&#x27;),curr_pos) pos3=pos3.replace(&quot;（&quot;,&quot;(&quot;).replace(&quot;）&quot;,&quot;)&quot;) job_zhurenzhi_list.append(pos3) if jianzhi_list: job_zhurenzhi_list_new=[] for i in job_zhurenzhi_list: if &quot;2199&quot; in i: i=i+&#x27;兼任&#x27;+jianzhi_list job_zhurenzhi_list_new.append(i) else: job_zhurenzhi_list_new.append(i) job_zhurenzhi_list=job_zhurenzhi_list_new #外部工作经历 job2=[] job_list=CustomerUtil.call_open_api(&quot;hcm.model.list&quot;, &#123; &quot;model&quot;: &quot;OuterExperience&quot;, &quot;filter_dict&quot;: &#123; &quot;employee_id&quot;:employee_id &#125;, &quot;page_size&quot;:99, &quot;extra_property&quot;:&#123;&quot;state&quot;:&quot;inside&quot;&#125; &#125;)[&quot;list&quot;] for j in job_list: if j[&#x27;end_date&#x27;]==&quot;至今&quot;: continue resume=j.get(&#x27;position_desc&#x27;,&#x27;&#x27;) if resume and &quot;（&quot; in resume: index=resume.find(&quot;（&quot;) resume=resume[:index]+&quot;\\n&quot;+&quot; &quot;+resume[index:] begin_date=j[&quot;begin_date&quot;][:7].replace(&#x27;-&#x27;,&#x27;.&#x27;) end_date=j[&quot;end_date&quot;][:7].replace(&#x27;-&#x27;,&#x27;.&#x27;) s=&quot;&#123;&#125;--&#123;&#125; &#123;&#125;&#123;&#125;&#123;&#125;&#123;&#125;&quot;.format(begin_date,end_date,j.get(&quot;company_name&quot;,&quot;&quot;),j.get(&quot;department_name&quot;,&quot;&quot;),j.get(&quot;position_name&quot;,&quot;&quot;),resume).replace(&quot;None&quot;,&quot;&quot;).replace(&quot;None&quot;,&quot;&quot;).replace(&quot;None&quot;,&quot;&quot;).replace(&quot;None&quot;,&quot;&quot;) job2.append(s) #pos3=pos3.replace(&quot;（&quot;,&quot;(&quot;).replace(&quot;）&quot;,&quot;)&quot;) #job2.append(pos3) job2+=edu+job_zhurenzhi_list job2_new=[] for i in job2: if &quot;（历史）&quot; in i: i=i.replace(&quot;（历史）&quot;,&quot;&quot;) job2_new.append(i) elif &quot;(历史)&quot; in i: i=i.replace(&quot;(历史)&quot;,&quot;&quot;) job2_new.append(i) else: job2_new.append(i) job2=job2_new job2=sorted(job2,key=lambda job2:job2[:7]) #&#x27;&#x27;&#x27; &#x27;&#x27;&#x27; #插入技术职务 skill=[x for x in skill if x[&quot;obtain_date&quot;]] if skill: skill_list=[] for s in skill: skill_name=&quot;&#123;&#125;获&#123;&#125;资格&quot;.format(s.get(&#x27;obtain_date&#x27;,&#x27;&#x27;)[:7].replace(&#x27;-&#x27;,&#x27;.&#x27;),s.get(&#x27;technical_skills_n&#x27;,&#123;&#125;).get(&#x27;name&#x27;,&#123;&#125;)) skill_name=skill_name.replace(&#x27;（&#x27;,&#x27;（&#x27;).replace(&#x27;）&#x27;,&#x27;)&#x27;) skill_list.append(skill_name) #self.log(skill_list) q=0 for i in skill_list: while(q&lt;len(job2)): #技术职务在简历期间 if job2[q][:7]&lt;i[:7] and job2[q][9:16]&gt;=i[:7]: if &quot;其间&quot; in job2[q]: right=job2[q].find(&quot;）&quot;) job2[q]=job2[q][:right]+&quot;;&quot;+i+&quot;）&quot; q=0 break else: if &quot;）&quot; in job2[q]: right=job2[q].find(&quot;）&quot;) job2[q]=job2[q][:right]+&quot;;&quot;+i+&quot;）&quot; q=0 break else: job2[q]= job2[q]+f&quot;（其间：&#123;i&#125;）&quot; q=0 break q+=1 &#x27;&#x27;&#x27; #插入在职教育信息 work_edu_list=[x for x in edu_list2 if x[&quot;from_date&quot;] and x[&quot;end_date&quot;] and x[&quot;education_form&quot;]==&quot;在职教育&quot;] w_edu=[] if work_edu_list: for i in work_edu_list: school=i.get(&quot;school&quot;,&quot;&quot;) specialty=i.get(&quot;specialty&quot;,&quot;&quot;) #dangxiao=i.get(&quot;education&quot;,&quot;&quot;) if i[&quot;education&quot;] in [&quot;普通高中毕业&quot;,&quot;普通高中结业&quot;,&quot;普通高中肄业&quot;]: w_edu.append(f&quot;&#123;i[&#x27;from_date&#x27;][:7].replace(&#x27;-&#x27;,&#x27;.&#x27;)&#125;--&#123;i[&#x27;end_date&#x27;][:7].replace(&#x27;-&#x27;,&#x27;.&#x27;)&#125; &#123;i[&#x27;school&#x27;]&#125;&#123;i[&#x27;specialty&#x27;]&#125;学生&quot;) else: xueli=i.get(&quot;education&quot;,&quot;&quot;) if i[&quot;education&quot;]: if &quot;大学本科&quot; in i[&quot;education&quot;] or &quot;大学普通班&quot; in i[&quot;education&quot;] or &quot;中央党校大学&quot; in i[&quot;education&quot;] or &quot;市委党校大学&quot; in i[&quot;education&quot;]: xueli=&quot;大学&quot; if &quot;大学专科&quot; in i[&quot;education&quot;]: xueli=&quot;大专&quot; if &quot;中等专科&quot; in i[&quot;education&quot;]: xueli=&quot;中专&quot; if &quot;硕士研究生&quot; in i[&quot;education&quot;]: xueli=&quot;研究生&quot; if &quot;博士研究生&quot; in i[&quot;education&quot;]: xueli=&quot;研究生&quot; if &quot;研究生班&quot; in i[&quot;education&quot;] or &quot;市委党校研究生&quot; in i[&quot;education&quot;] or &quot;中央党校研究生&quot; in i[&quot;education&quot;]: xueli=&quot;研究生&quot; if xueli: xueli=xueli.replace(&#x27;毕业&#x27;,&#x27;&#x27;) degree=i[&quot;degree&quot;] #if xueli: # xueli=&quot;,获&quot;+xueli+&quot;学历&quot; s=f&quot;&#123;i[&#x27;from_date&#x27;][:7].replace(&#x27;-&#x27;,&#x27;.&#x27;)&#125;--&#123;i[&#x27;end_date&#x27;][:7].replace(&#x27;-&#x27;,&#x27;.&#x27;)&#125; &#123;school&#125;&#123;specialty&#125;专业在职&#123;xueli&#125;学习&quot; if degree: if xueli: s=s+&quot;,获&quot;+degree #else: # s=s+&quot;,获&quot;+degree s=s.replace(&#x27;None&#x27;,&#x27;&#x27;) if school and &quot;党校&quot; in school: s=s.replace(&#x27;在职&#x27;,&#x27;&#x27;) w_edu.append(s) q=0 for i in w_edu: while(q&lt;len(job2)): #在职教育在简历期间 #全包 主线开始小于毕业时间，结束时间大于毕业时间,开始时间小于等于入学时间 if job2[q][:7]&lt;i[9:16] and job2[q][9:16]&gt;=i[9:16] and job2[q][:7]&lt;=i[:7]: #有其间 if &quot;其间&quot; in job2[q]: right=job2[q].find(&quot;）&quot;) job2[q]=job2[q][:right]+&quot;;&quot;+i+&quot;）&quot; q=0 break #没有期间 else: #有括号 if &quot;）&quot; in job2[q]: right=job2[q].find(&quot;）&quot;) job2[q]=job2[q][:right]+&quot;;&quot;+i+&quot;）&quot; q=0 break #没有括号 else: job2[q]= job2[q]+f&quot;（其间：&#123;i&#125;）&quot; q=0 break #半包 主线开始小于毕业时间，结束时间大于毕业时间,开始时间大于于入学时间 if job2[q][:7]&lt;i[9:16] and job2[q][9:16]&gt;=i[9:16] and job2[q][:7]&gt;i[:7]: if &quot;其间&quot; in job2[q]: right=job2[q].find(&quot;）&quot;) job2[q]=job2[q][:right]+&quot;;&quot;+i+&quot;）&quot; q=0 break else: #有括号 if &quot;）&quot; in job2[q]: right=job2[q].find(&quot;）&quot;) job2[q]=job2[q][:right]+&quot;;&quot;+i+&quot;）&quot; q=0 break #没有括号 else: job2[q]= job2[q]+&quot;\\n&quot;+&quot; &quot;+f&quot;（&#123;i&#125;）&quot; q=0 break q+=1 #培训 train=CustomerUtil.call_open_api(&quot;hcm.model.list&quot;, &#123; &quot;model&quot;: &quot;employee_dynamic_subset.TrainingExperience&quot;, &quot;filter_dict&quot;:&#123; &quot;employee_id&quot;:employee_id &#125;, &quot;extra_property&quot;:&#123; &quot;state&quot;:&quot;inside&quot; &#125; &#125;)[&quot;list&quot;] train_list=[x for x in train if x[&quot;u_training_date&quot;] and x[&quot;u_training_end&quot;]] t_list=[] if train_list: for t in train_list: train_name=&quot;&#123;&#125;--&#123;&#125; &#123;&#125;&#123;&#125;&quot;.format(t.get(&#x27;u_training_date&#x27;,&#x27;&#x27;)[:7].replace(&#x27;-&#x27;,&#x27;.&#x27;),t.get(&#x27;u_training_end&#x27;,&#x27;&#x27;)[:7].replace(&#x27;-&#x27;,&#x27;.&#x27;),t.get(&#x27;u_organiser&#x27;,&#x27;&#x27;),t.get(&#x27;u_training_name&#x27;,&#x27;&#x27;)) t_list.append(train_name) q=0 for i in t_list: while(q&lt;len(job2)): #在职教育在简历期间 #全包 主线开始小于毕业时间，结束时间大于毕业时间,开始时间小于等于入学时间 if job2[q][:7]&lt;i[9:16] and job2[q][9:16]&gt;=i[9:16] and job2[q][:7]&lt;=i[:7]: #有其间 if &quot;其间&quot; in job2[q]: right=job2[q].find(&quot;）&quot;) job2[q]=job2[q][:right]+&quot;;&quot;+i+&quot;）&quot; q=0 break #没有期间 else: #有括号 if &quot;）&quot; in job2[q]: right=job2[q].find(&quot;）&quot;) job2[q]=job2[q][:right]+&quot;;&quot;+i+&quot;）&quot; q=0 break #没有括号 else: job2[q]= job2[q]+f&quot;（其间：&#123;i&#125;）&quot; q=0 break #半包 主线开始小于毕业时间，结束时间大于毕业时间,开始时间大于于入学时间 if job2[q][:7]&lt;i[9:16] and job2[q][9:16]&gt;=i[9:16] and job2[q][:7]&gt;i[:7]: if &quot;其间&quot; in job2[q]: right=job2[q].find(&quot;）&quot;) job2[q]=job2[q][:right]+&quot;;&quot;+i+&quot;）&quot; q=0 break else: #有括号 if &quot;）&quot; in job2[q]: right=job2[q].find(&quot;）&quot;) job2[q]=job2[q][:right]+&quot;;&quot;+i+&quot;）&quot; q=0 break #没有括号 else: job2[q]= job2[q]+&quot;\\n&quot;+&quot; &quot;+f&quot;（&#123;i&#125;）&quot; q=0 break q+=1 #插入挂职 借调 临时负责信息 job_guazhi=CustomerUtil.call_open_api(&quot;hcm.model.list&quot;, &#123; &quot;model&quot;: &quot;JobInformation&quot;, &quot;filter_dict&quot;:&#123; &quot;employee_id&quot;:employee_id, &quot;position_type&quot;:[3,6,8], &quot;action_id&quot;:[48256,47889,48261] &#125;, &quot;extra_property&quot;:&#123; &quot;state&quot;:&quot;history&quot; &#125; &#125;)[&quot;list&quot;] if job_guazhi: job_guazhi_list=[] #self.log(job_guazhi) for j in job_guazhi: pos_shuxing,pos_id=self.get_parent_dep(j[&quot;position&quot;][&quot;origin_id&quot;]) if pos_id: dep_name=self.get_dept_level(pos_shuxing,pos_id) guazhi=dep_name+j[&quot;position&quot;][&quot;name&quot;] else: guazhi=j[&quot;department&quot;][&quot;name&quot;]+j[&quot;position&quot;][&quot;name&quot;] end_date=j[&quot;end_date&quot;] if end_date==&quot;至今&quot;: end_date=&quot;2199-12-31&quot; if j[&quot;position_type&quot;]==6: guazhi_name=&quot;&#123;&#125;--&#123;&#125; 挂职&#123;&#125;&quot;.format(j[&quot;begin_date&quot;][:7].replace(&#x27;-&#x27;,&#x27;.&#x27;),end_date[:7].replace(&#x27;-&#x27;,&#x27;.&#x27;),guazhi) elif j[&quot;position_type&quot;]==3: guazhi_name=&quot;&#123;&#125;--&#123;&#125; 借调&#123;&#125;&quot;.format(j[&quot;begin_date&quot;][:7].replace(&#x27;-&#x27;,&#x27;.&#x27;),end_date[:7].replace(&#x27;-&#x27;,&#x27;.&#x27;),guazhi) else: guazhi_name=&quot;&#123;&#125;--&#123;&#125; 临时负责&#123;&#125;&quot;.format(j[&quot;begin_date&quot;][:7].replace(&#x27;-&#x27;,&#x27;.&#x27;),end_date[:7].replace(&#x27;-&#x27;,&#x27;.&#x27;),guazhi) guazhi_name=guazhi_name.replace(&quot;（&quot;,&quot;(&quot;).replace(&quot;）&quot;,&quot;)&quot;) job_guazhi_list.append(guazhi_name) q=0 job_guazhi_list=sorted(job_guazhi_list,key=lambda job_guazhi_list:job_guazhi_list[9:16]) for i in job_guazhi_list: while(q&lt;len(job2)): #简历开始时间&lt;挂职结束时间 简历结束时间&gt;=挂职结束时间 简历开始时间&lt;=挂职开始时间 if job2[q][:7]&lt;i[9:16] and job2[q][9:16]&gt;=i[9:16] and job2[q][:7]&lt;=i[:7]: #有其间 if &quot;其间&quot; in job2[q]: right=job2[q].find(&quot;）&quot;) job2[q]=job2[q][:right]+&quot;;&quot;+i+&quot;）&quot; q=0 break #没有期间 else: #有括号 if &quot;）&quot; in job2[q]: right=job2[q].find(&quot;）&quot;) job2[q]=job2[q][:right]+&quot;;&quot;+i+&quot;）&quot; q=0 break #没有括号 else: job2[q]= job2[q]+f&quot;（其间：&#123;i&#125;）&quot; q=0 break #半包 #简历开始时间&lt;挂职结束时间 简历结束时间&gt;=挂职结束时间 简历开始时间&gt;=挂职开始时间 if job2[q][:7]&lt;i[9:16] and job2[q][9:16]&gt;=i[9:16] and job2[q][:7]&gt;=i[:7]: if &quot;其间&quot; in job2[q]: right=job2[q].find(&quot;）&quot;) job2[q]=job2[q][:right]+&quot;;&quot;+&quot;）&quot; q=0 break else: #有括号 if &quot;）&quot; in job2[q]: right=job2[q].find(&quot;）&quot;) job2[q]=job2[q][:right]+&quot;;&quot;+i+&quot;）&quot; q=0 break #没有括号 else: job2[q]= job2[q]+&quot;\\n&quot;+&quot; &quot;+f&quot;（&#123;i&#125;）&quot; q=0 break q+=1 job_new=[] for i in job2: if &quot;2199.12&quot; in i: i=i.replace(&quot;2199.12&quot;,&quot; &quot;) job_new.append(i) else: job_new.append(i) #&#x27;&#x27;&#x27; #param[&quot;info&quot;][&quot;pic_reduce_rate&quot;]=0.864 param[&quot;info&quot;][&quot;special_text_jobs_str&quot;]=&quot;\\n&quot;.join(job_new) self.log(param[&quot;info&quot;]) return param[&quot;info&quot;] except Exception as e: #self.record(f&quot;&#123;param&#125;:&#123;e&#125;&quot;) self.log(traceback.format_exc()) raise e def get_parent_dep(self,origin_id): pos_info=CustomerUtil.call_open_api(&quot;hcm.model.list&quot;, &#123; &quot;model&quot;: &quot;OrgPosition&quot;, &quot;filter_dict&quot;: &#123; &quot;id&quot;:origin_id &#125;, &quot;page_size&quot;:99, &quot;extra_property&quot;:&#123; &quot;role&quot;:&quot;all&quot;, &quot;state&quot;:&quot;all&quot; &#125; &#125;)[&quot;list&quot;] if pos_info: return pos_info[0][&quot;department&quot;][&quot;u_department_attribute&quot;][&quot;name&quot;],pos_info[0][&quot;department&quot;][&quot;origin_id&quot;] else: return &quot;&quot; def get_parent_unit(self,origin_id): pos_info=CustomerUtil.call_open_api(&quot;hcm.model.list&quot;, &#123; &quot;model&quot;: &quot;OrgUnit&quot;, &quot;filter_dict&quot;: &#123; &quot;id&quot;:origin_id &#125;, &quot;page_size&quot;:99 &#125;)[&quot;list&quot;] if pos_info: return pos_info[0][&quot;parent&quot;][&quot;name&quot;] else: return &quot;&quot; def get_dept_level(self,pos_shuxing,pos_id): now=datetime.datetime.now().strftime(&#x27;%Y-%m-%d&#x27;) info=CustomerUtil.call_open_api(&quot;hcm.model.list&quot;, &#123; &quot;model&quot;: &quot;DepartmentHierarchy&quot;, &quot;filter_dict&quot;: &#123; &quot;department_id&quot;:pos_id, &quot;begin_date&quot;:&#123;&quot;lte&quot;:now&#125;, &quot;end_date&quot;:&#123;&quot;gt&quot;:now&#125; &#125;, &quot;extra_property&quot;:&#123; &quot;fields&quot;:[ &#123;&quot;field&quot;:[&quot;l0.name&quot;],&quot;key&quot;:&quot;l0.name&quot;&#125;, &#123;&quot;field&quot;:[&quot;l1.name&quot;],&quot;key&quot;:&quot;l1.name&quot;&#125;, &#123;&quot;field&quot;:[&quot;l2.name&quot;],&quot;key&quot;:&quot;l2.name&quot;&#125;, &#123;&quot;field&quot;:[&quot;l3.name&quot;],&quot;key&quot;:&quot;l3.name&quot;&#125;, &#123;&quot;field&quot;:[&quot;l4.name&quot;],&quot;key&quot;:&quot;l4.name&quot;&#125;, &#123;&quot;field&quot;:[&quot;l5.name&quot;],&quot;key&quot;:&quot;l5.name&quot;&#125; ] &#125; &#125;)[&quot;list&quot;] name=&quot;&quot; if info: info=info[0] if pos_shuxing==&quot;总部领导班子、直属&quot;: name=info[&quot;l2&quot;][&quot;name&quot;] if pos_shuxing==&quot;总部非领导班子&quot;: name=info[&quot;l2&quot;][&quot;name&quot;]+info[&quot;l3&quot;][&quot;name&quot;] if pos_shuxing==&quot;分行领导班子&quot;: name=info[&quot;l2&quot;][&quot;name&quot;] if pos_shuxing==&quot;分行内设部室、其他&quot;: name=info[&quot;l2&quot;][&quot;name&quot;]+info[&quot;l4&quot;][&quot;name&quot;] if pos_shuxing==&quot;支行领导班子、营业厅&quot;: name=info[&quot;l2&quot;][&quot;name&quot;]+info[&quot;l3&quot;][&quot;name&quot;] if pos_shuxing==&quot;支行分理处、其他&quot;: name=info[&quot;l2&quot;][&quot;name&quot;]+info[&quot;l3&quot;][&quot;name&quot;]+info[&quot;l4&quot;][&quot;name&quot;] if pos_shuxing==&quot;行领导&quot;: name=&quot;&quot; return name def log(self, log_content): log_info = &#123;&quot;log_type&quot;: str(&#x27;appointment_dismissal_basic_info&#x27;), &quot;create_time&quot;: datetime.datetime.now().strftime(&#x27;%Y-%m-%d %H:%M:%S&#x27;), &quot;content&quot;: str(log_content)&#125; CustomerUtil.call_open_api(&quot;hcm.model.create&quot;, &#123;&quot;model&quot;: &quot;dynamic_log&quot;, &quot;info&quot;: log_info&#125;)","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"029-仪表盘-模版配置实例","slug":"项目/HCM教程/029-仪表盘-模版配置实例","date":"2025-05-29T12:44:25.000Z","updated":"2025-09-09T06:19:59.377Z","comments":true,"path":"2025/05/29/项目/HCM教程/029-仪表盘-模版配置实例/","link":"","permalink":"https://dbbruce.github.io/2025/05/29/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/029-%E4%BB%AA%E8%A1%A8%E7%9B%98-%E6%A8%A1%E7%89%88%E9%85%8D%E7%BD%AE%E5%AE%9E%E4%BE%8B/","excerpt":"模板实例","text":"模板实例 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273&#123; &quot;grid&quot;: &#123; &quot;top&quot;: &quot;15%&quot;, &quot;left&quot;: &quot;15%&quot; &#125;, &quot;xAxis&quot;: &#123; &quot;axisLabel&quot;: &#123; &quot;color&quot;: &quot;#000000&quot;, &quot;rotate&quot;: 0 &#125; &#125;, &quot;yAxis&quot;: &#123; &quot;data&quot;: [&quot;一般管理人员1&quot;, &quot;首席技师6&quot;, &quot;正高级专业技术人员8&quot;, &quot;部门内设机构负责人66&quot;, &quot;部门负责人88&quot;], &quot;type&quot;: &quot;category&quot;, &quot;axisLabel&quot;: &#123; &quot;color&quot;: &quot;#000000&quot;, &quot;rotate&quot;: 0 &#125; &#125;, &quot;series&quot;: [&#123; &quot;data&quot;: [&#123; &quot;name&quot;: &quot;一般管理人员&quot;, &quot;value&quot;: 20 &#125;, &#123; &quot;name&quot;: &quot;首席技师&quot;, &quot;value&quot;: 30 &#125;, &#123; &quot;name&quot;: &quot;正高级专业技术人员&quot;, &quot;value&quot;: 40 &#125;, &#123; &quot;name&quot;: &quot;部门内设机构负责人&quot;, &quot;value&quot;: 50 &#125;, &#123; &quot;name&quot;: &quot;部门负责人&quot;, &quot;value&quot;: 60 &#125;], &quot;name&quot;: &quot;主数据源&quot;, &quot;type&quot;: &quot;bar&quot;, &quot;label&quot;: &#123; &quot;show&quot;: false, &quot;offset&quot;: [0, 0], &quot;rotate&quot;: 0, &quot;distance&quot;: 0, &quot;position&quot;: &quot;top&quot;, &quot;formatter&quot;: &quot;&#123;@[1]&#125;&quot; &#125;, &quot;barWidth&quot;: &quot;60%&quot;, &quot;itemStyle&quot;: &#123; &quot;color&quot;: &#123; &quot;x&quot;: 0, &quot;y&quot;: 1, &quot;x2&quot;: 0, &quot;y2&quot;: 0, &quot;colorStops&quot;: [&#123; &quot;color&quot;: &quot;#FFA500&quot;, &quot;offset&quot;: 0 &#125;, &#123; &quot;color&quot;: &quot;#FFA500&quot;, &quot;offset&quot;: 1 &#125;] &#125;, &quot;borderWidth&quot;: 10, &quot;borderRadius&quot;: [100, 100, 100, 100] &#125; &#125;], &quot;dataset&quot;: &#123; &quot;dimensions&quot;: &#123; &quot;name&quot;: &quot;name&quot;, &quot;value&quot;: &quot;value&quot; &#125; &#125;, &quot;tooltip&quot;: &#123;&#125;&#125; 实例讲解 xAxis 配置x轴的信息 series 配置的数据信息，这里的name用于显示 数据点上的名称，value是实际数值123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105&#123; &quot;grid&quot;: &#123; &quot;left&quot;: &quot;3%&quot;, &quot;right&quot;: &quot;5%&quot;, &quot;bottom&quot;: &quot;5%&quot;, &quot;containLabel&quot;: true &#125;, &quot;xAxis&quot;: &#123; &quot;data&quot;: [&quot;部门1&quot;, &quot;部门3&quot;, &quot;部门5&quot;, &quot;部门7&quot;, &quot;部门9&quot;], &quot;type&quot;: &quot;category&quot;, &quot;axisLine&quot;: &#123; &quot;show&quot;: true, &quot;lineStyle&quot;: &#123; &quot;color&quot;: &quot;#DCDDE1&quot; &#125; &#125;, &quot;axisTick&quot;: &#123; &quot;show&quot;: false &#125;, &quot;axisLabel&quot;: &#123; &quot;color&quot;: &quot;#6F7686&quot;, &quot;rotate&quot;: 45 &#125;, &quot;textStyle&quot;: &#123; &quot;fontSize&quot;: &quot;0.75rem&quot; &#125;, &quot;boundaryGap&quot;: false &#125;, &quot;yAxis&quot;: &#123; &quot;axisTick&quot;: &#123; &quot;show&quot;: true, &quot;lineStyle&quot;: &#123; &quot;color&quot;: &quot;#DCDDE1&quot; &#125; &#125;, &quot;axisLabel&quot;: &#123; &quot;color&quot;: &quot;#6F7686&quot;, &quot;rotate&quot;: 0, &quot;fontSize&quot;: &quot;0.75rem&quot; &#125;, &quot;splitLine&quot;: &#123; &quot;show&quot;: true, &quot;lineStyle&quot;: &#123; &quot;color&quot;: &quot;#F1F2F5&quot; &#125; &#125; &#125;, &quot;series&quot;: [&#123; &quot;data&quot;: [&#123; &quot;name&quot;: &quot;test1&quot;, &quot;value&quot;: 11 &#125;, &#123; &quot;name&quot;: &quot;test2&quot;, &quot;value&quot;: 22 &#125;, &#123; &quot;name&quot;: &quot;部门5&quot;, &quot;value&quot;: 33 &#125;, &#123; &quot;name&quot;: &quot;部门5&quot;, &quot;value&quot;: 11 &#125;, &#123; &quot;name&quot;: &quot;部门9&quot;, &quot;value&quot;: 77 &#125;], &quot;type&quot;: &quot;line&quot;, &quot;label&quot;: &#123; &quot;show&quot;: true, &quot;fontSize&quot;: &quot;0.75rem&quot;, &quot;position&quot;: &quot;insideTopLeft&quot;, &quot;formatter&quot;: &quot;&#123;@[1]&#125;&quot; &#125;, &quot;smooth&quot;: true, &quot;barWidth&quot;: &quot;0%&quot;, &quot;emphasis&quot;: &#123; &quot;focus&quot;: &quot;series&quot; &#125;, &quot;areaStyle&quot;: &#123; &quot;color&quot;: &#123; &quot;x&quot;: 0, &quot;y&quot;: 0, &quot;x2&quot;: 0, &quot;y2&quot;: 1, &quot;type&quot;: &quot;linear&quot;, &quot;colorStops&quot;: [&#123; &quot;color&quot;: &quot;#EBF3FE&quot;, &quot;offset&quot;: 0 &#125;, &#123; &quot;color&quot;: &quot;rgba(235, 243, 254, 0)&quot;, &quot;offset&quot;: 1 &#125;] &#125; &#125;, &quot;lineStyle&quot;: &#123; &quot;color&quot;: &quot;rgba(0, 119, 204, 0.6)&quot;, &quot;width&quot;: 1 &#125; &#125;], &quot;dataset&quot;: &#123; &quot;dimensions&quot;: &#123; &quot;name&quot;: &quot;name&quot;, &quot;value&quot;: &quot;value&quot; &#125; &#125;, &quot;tooltip&quot;: &#123;&#125;&#125;","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"028-仪表盘-簇状柱状图","slug":"项目/HCM教程/028-仪表盘-簇状柱状图","date":"2025-05-28T12:44:25.000Z","updated":"2025-09-09T06:19:59.293Z","comments":true,"path":"2025/05/28/项目/HCM教程/028-仪表盘-簇状柱状图/","link":"","permalink":"https://dbbruce.github.io/2025/05/28/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/028-%E4%BB%AA%E8%A1%A8%E7%9B%98-%E7%B0%87%E7%8A%B6%E6%9F%B1%E7%8A%B6%E5%9B%BE/","excerpt":"簇状柱状图","text":"簇状柱状图 模版定义123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081&#123; &quot;xAxis&quot;: [&#123; &quot;data&quot;: [&quot;集团总部&quot;, &quot;西电集团&quot;, &quot;许继集团&quot;, &quot;平高集团&quot;, &quot;山东电工电器&quot;], &quot;type&quot;: &quot;category&quot;, &quot;axisPointer&quot;: &#123; &quot;type&quot;: &quot;shadow&quot; &#125; &#125;], &quot;yAxis&quot;: [&#123; &quot;max&quot;: 20, &quot;min&quot;: 0, &quot;name&quot;: &quot;预算总额、预算执行情况(万元)&quot;, &quot;type&quot;: &quot;value&quot;, &quot;interval&quot;: 5, &quot;axisLabel&quot;: &#123; &quot;formatter&quot;: &quot;&#123;value&#125; &quot; &#125; &#125;, &#123; &quot;max&quot;: 1, &quot;min&quot;: 0, &quot;name&quot;: &quot;执行比例&quot;, &quot;type&quot;: &quot;value&quot;, &quot;interval&quot;: 0.25, &quot;axisLabel&quot;: &#123; &quot;formatter&quot;: &quot;&#123;value&#125; &quot; &#125; &#125;], &quot;legend&quot;: &#123; &quot;data&quot;: [&quot;预算总额&quot;, &quot;预算执行情况&quot;, &quot;执行比例&quot;] &#125;, &quot;series&quot;: [&#123; &quot;data&quot;: [15, 12, 16, 17, 14], &quot;name&quot;: &quot;预算总额&quot;, &quot;type&quot;: &quot;bar&quot;, &quot;tooltip&quot;: &#123; &quot;valueFormatter&quot;: &quot;&quot; &#125; &#125;, &#123; &quot;data&quot;: [10, 8, 12, 11, 10], &quot;name&quot;: &quot;预算执行情况&quot;, &quot;type&quot;: &quot;bar&quot;, &quot;tooltip&quot;: &#123; &quot;valueFormatter&quot;: &quot;&quot; &#125; &#125;, &#123; &quot;data&quot;: [0.7, 0.7, 0.75, 0.67, 0.6], &quot;name&quot;: &quot;执行比例&quot;, &quot;type&quot;: &quot;line&quot;, &quot;tooltip&quot;: &#123; &quot;valueFormatter&quot;: &quot;&quot; &#125;, &quot;yAxisIndex&quot;: 1 &#125;], &quot;toolbox&quot;: &#123; &quot;feature&quot;: &#123; &quot;restore&quot;: &#123; &quot;show&quot;: false &#125;, &quot;dataView&quot;: &#123; &quot;show&quot;: false, &quot;readOnly&quot;: false &#125;, &quot;magicType&quot;: &#123; &quot;show&quot;: false, &quot;type&quot;: [&quot;line&quot;, &quot;bar&quot;] &#125;, &quot;saveAsImage&quot;: &#123; &quot;show&quot;: false &#125; &#125; &#125;, &quot;tooltip&quot;: &#123; &quot;trigger&quot;: &quot;axis&quot;, &quot;axisPointer&quot;: &#123; &quot;type&quot;: &quot;cross&quot;, &quot;crossStyle&quot;: &#123; &quot;color&quot;: &quot;#999&quot; &#125; &#125; &#125;&#125;","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"027-仪表盘-仪表盘","slug":"项目/HCM教程/027-仪表盘-仪表盘","date":"2025-05-27T12:44:25.000Z","updated":"2025-09-09T06:19:59.389Z","comments":true,"path":"2025/05/27/项目/HCM教程/027-仪表盘-仪表盘/","link":"","permalink":"https://dbbruce.github.io/2025/05/27/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/027-%E4%BB%AA%E8%A1%A8%E7%9B%98-%E4%BB%AA%E8%A1%A8%E7%9B%98/","excerpt":"仪表盘","text":"仪表盘 模版定义12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849&#123; &quot;series&quot;: [&#123; &quot;data&quot;: [&#123; &quot;value&quot;: 70 &#125;], &quot;type&quot;: &quot;gauge&quot;, &quot;detail&quot;: &#123; &quot;color&quot;: &quot;inherit&quot;, &quot;formatter&quot;: &quot;&#123;value&#125; %&quot;, &quot;valueAnimation&quot;: true &#125;, &quot;pointer&quot;: &#123; &quot;itemStyle&quot;: &#123; &quot;color&quot;: &quot;auto&quot; &#125; &#125;, &quot;axisLine&quot;: &#123; &quot;lineStyle&quot;: &#123; &quot;color&quot;: [ [0.3, &quot;#67e0e3&quot;], [0.7, &quot;#37a2da&quot;], [1, &quot;#fd666d&quot;] ], &quot;width&quot;: 30 &#125; &#125;, &quot;axisTick&quot;: &#123; &quot;length&quot;: 8, &quot;distance&quot;: -30, &quot;lineStyle&quot;: &#123; &quot;color&quot;: &quot;#fff&quot;, &quot;width&quot;: 2 &#125; &#125;, &quot;axisLabel&quot;: &#123; &quot;color&quot;: &quot;inherit&quot;, &quot;distance&quot;: 40, &quot;fontSize&quot;: 20 &#125;, &quot;splitLine&quot;: &#123; &quot;length&quot;: 30, &quot;distance&quot;: -30, &quot;lineStyle&quot;: &#123; &quot;color&quot;: &quot;#fff&quot;, &quot;width&quot;: 4 &#125; &#125; &#125;]&#125;","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"026-仪表盘-柱状图","slug":"项目/HCM教程/026-仪表盘-柱状图","date":"2025-05-26T12:44:25.000Z","updated":"2025-09-09T06:19:59.353Z","comments":true,"path":"2025/05/26/项目/HCM教程/026-仪表盘-柱状图/","link":"","permalink":"https://dbbruce.github.io/2025/05/26/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/026-%E4%BB%AA%E8%A1%A8%E7%9B%98-%E6%9F%B1%E7%8A%B6%E5%9B%BE/","excerpt":"柱状图 - 纵向","text":"柱状图 - 纵向 模版定义 - 纵向 &#x3D;list(map(lambda x:x[‘name’], SORTED(main, ‘value’)))&#x3D;SORTED(main, ‘value’) 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950&#123; &quot;xAxis&quot;: &#123; &quot;data&quot;: &quot;=list(map(lambda x:x[&#x27;name&#x27;], SORTED(main, &#x27;value&#x27;)))&quot;, &quot;type&quot;: &quot;category&quot;, &quot;axisLabel&quot;: &#123; &quot;rotate&quot;: 45 &#125; &#125;, &quot;yAxis&quot;: &#123; &quot;axisLabel&quot;: &#123; &quot;rotate&quot;: 0 &#125; &#125;, &quot;series&quot;: [&#123; &quot;data&quot;: &quot;=SORTED(main, &#x27;value&#x27;)&quot;, &quot;name&quot;: &quot;主数据源&quot;, &quot;type&quot;: &quot;bar&quot;, &quot;label&quot;: &#123; &quot;show&quot;: false, &quot;offset&quot;: [0, 0], &quot;rotate&quot;: 0, &quot;distance&quot;: 0, &quot;position&quot;: &quot;top&quot;, &quot;formatter&quot;: &quot;&#123;@[1]&#125;&quot; &#125;, &quot;barWidth&quot;: &quot;80%&quot;, &quot;itemStyle&quot;: &#123; &quot;color&quot;: &quot;=AUTO_COLOR(&#x27;bar&#x27;)&quot;, &quot;borderWidth&quot;: 10 &#125; &#125;], &quot;dataset&quot;: &#123; &quot;dimensions&quot;: &#123; &quot;name&quot;: &quot;name&quot;, &quot;value&quot;: &quot;value&quot; &#125; &#125;, &quot;toolbox&quot;: &#123; &quot;show&quot;: true, &quot;feature&quot;: &#123; &quot;myInvert&quot;: &#123; &quot;icon&quot;: &quot;path://M696.888889 287.288889h-512l142.222222-122.311111c11.377778-11.377778 14.222222-28.444444 2.844445-39.822222s-28.444444-14.222222-39.822223-2.844445l-199.111111 170.666667c-5.688889 2.844444-11.377778 11.377778-11.377778 19.911111s2.844444 14.222222 8.533334 19.911111l190.577778 190.577778c5.688889 5.688889 14.222222 8.533333 19.911111 8.533333s14.222222-2.844444 19.911111-8.533333c11.377778-11.377778 11.377778-28.444444 0-39.822222l-142.222222-142.222223h517.688888c93.866667 0 170.666667 76.8 170.666667 170.666667v139.377778c0 93.866667-76.8 170.666667-170.666667 170.666666H216.177778c-17.066667 0-28.444444 11.377778-28.444445 28.444445s11.377778 28.444444 28.444445 28.444444h480.711111c125.155556 0 227.555556-102.4 227.555555-227.555555V512c0-122.311111-102.4-224.711111-227.555555-224.711111z&quot;, &quot;show&quot;: true, &quot;title&quot;: &quot;坐标翻转&quot;, &quot;onclick&quot;: &quot;function()&#123; let _that=SCOPE; let tmp = _that.options.chart.xAxis; _that.options.chart.xAxis = _that.options.chart.yAxis; _that.options.chart.yAxis = tmp; _that.$onRender(true); &#125;&quot; &#125; &#125; &#125;, &quot;tooltip&quot;: &#123;&#125;&#125; 柱状图 - 横向 模版定义 - 横向12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182&#123; &quot;grid&quot;: &#123; &quot;top&quot;: &quot;15%&quot;, &quot;left&quot;: &quot;15%&quot; &#125;, &quot;xAxis&quot;: &#123; &quot;axisLabel&quot;: &#123; &quot;color&quot;: &quot;#000000&quot;, &quot;rotate&quot;: 0 &#125; &#125;, &quot;yAxis&quot;: &#123; &quot;data&quot;: [&quot;未鉴定技能等级人员&quot;, &quot;初级工&quot;, &quot;中级工&quot;, &quot;高级工&quot;, &quot;技师&quot;, &quot;高级技师&quot;, &quot;特级技师&quot;, &quot;首席技师&quot;], &quot;type&quot;: &quot;category&quot;, &quot;axisLabel&quot;: &#123; &quot;color&quot;: &quot;#000000&quot;, &quot;rotate&quot;: 30 &#125; &#125;, &quot;series&quot;: [&#123; &quot;data&quot;: [&#123; &quot;name&quot;: &quot;未鉴定技能等级人员&quot;, &quot;value&quot;: 11 &#125;, &#123; &quot;name&quot;: &quot;初级工&quot;, &quot;value&quot;: 14 &#125;, &#123; &quot;name&quot;: &quot;中级工&quot;, &quot;value&quot;: 17 &#125;, &#123; &quot;name&quot;: &quot;高级工&quot;, &quot;value&quot;: 20 &#125;, &#123; &quot;name&quot;: &quot;技师&quot;, &quot;value&quot;: 24 &#125;, &#123; &quot;name&quot;: &quot;高级技师&quot;, &quot;value&quot;: 26 &#125;, &#123; &quot;name&quot;: &quot;特级技师&quot;, &quot;value&quot;: 30 &#125;, &#123; &quot;name&quot;: &quot;首席技师&quot;, &quot;value&quot;: 33 &#125;], &quot;name&quot;: &quot;主数据源&quot;, &quot;type&quot;: &quot;bar&quot;, &quot;label&quot;: &#123; &quot;show&quot;: false, &quot;offset&quot;: [0, 0], &quot;rotate&quot;: 0, &quot;distance&quot;: 0, &quot;position&quot;: &quot;top&quot;, &quot;formatter&quot;: &quot;&#123;@[1]&#125;&quot; &#125;, &quot;barWidth&quot;: &quot;60%&quot;, &quot;itemStyle&quot;: &#123; &quot;color&quot;: &#123; &quot;x&quot;: 0, &quot;y&quot;: 1, &quot;x2&quot;: 0, &quot;y2&quot;: 0, &quot;colorStops&quot;: [&#123; &quot;color&quot;: &quot;#FFA500&quot;, &quot;offset&quot;: 0 &#125;, &#123; &quot;color&quot;: &quot;#FFA500&quot;, &quot;offset&quot;: 1 &#125;] &#125;, &quot;borderWidth&quot;: 10, &quot;borderRadius&quot;: [100, 100, 100, 100] &#125; &#125;], &quot;dataset&quot;: &#123; &quot;dimensions&quot;: &#123; &quot;name&quot;: &quot;name&quot;, &quot;value&quot;: &quot;value&quot; &#125; &#125;, &quot;tooltip&quot;: &#123;&#125;&#125;","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"025-仪表盘-饼图","slug":"项目/HCM教程/025-仪表盘-饼图","date":"2025-05-25T12:44:25.000Z","updated":"2025-09-09T06:19:59.286Z","comments":true,"path":"2025/05/25/项目/HCM教程/025-仪表盘-饼图/","link":"","permalink":"https://dbbruce.github.io/2025/05/25/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/025-%E4%BB%AA%E8%A1%A8%E7%9B%98-%E9%A5%BC%E5%9B%BE/","excerpt":"新建仪表盘分析报表 - 新建报表 - 报表类别选择【仪表盘】","text":"新建仪表盘分析报表 - 新建报表 - 报表类别选择【仪表盘】 配置饼图填写标题，选择图形 配置数据源 公式取数定义: 云函数: 报表公式 - 配置公式:DYNAMIC(‘bonus_summary_table’,dept_id&#x3D;CURR_DEPARTMENT,year&#x3D;CURR_YEAR,page_index&#x3D;PAGE_INDEX, page_size&#x3D;PAGE_SIZE) OpenAPI取数定义: 云函数: openAPI 列表取数定义: 模型标识：main名称：自定义自定义模型 维度 、 统计值 模版定义 12345678910111213141516171819202122232425262728293031323334353637383940&#123; &quot;legend&quot;: &#123; &quot;top&quot;: &quot;15%&quot;, &quot;icon&quot;: &quot;circle&quot;, &quot;left&quot;: 5, &quot;orient&quot;: &quot;vertical&quot;, &quot;textStyle&quot;: &#123; &quot;fontSize&quot;: &quot;0.75rem&quot; &#125; &#125;, &quot;series&quot;: [&#123; &quot;data&quot;: &quot;=SORTED(main, &#x27;value&#x27;)&quot;, &quot;type&quot;: &quot;pie&quot;, &quot;label&quot;: &#123; &quot;show&quot;: true, &quot;position&quot;: &quot;outside&quot;, &quot;formatter&quot;: &quot;&#123;@[1]&#125;(&#123;d&#125;%)&quot; &#125;, &quot;center&quot;: [&quot;65%&quot;, &quot;50%&quot;], &quot;radius&quot;: [&quot;40%&quot;, &quot;60%&quot;], &quot;emphasis&quot;: &#123; &quot;label&quot;: &#123; &quot;show&quot;: true, &quot;fontSize&quot;: &quot;20&quot;, &quot;fontWeight&quot;: &quot;bold&quot; &#125; &#125;, &quot;clockwise&quot;: false &#125;], &quot;dataset&quot;: &#123; &quot;dimensions&quot;: &#123; &quot;name&quot;: &quot;title&quot;, &quot;value&quot;: &quot;value&quot; &#125; &#125;, &quot;tooltip&quot;: &#123; &quot;trigger&quot;: &quot;item&quot;, &quot;formatter&quot;: &quot;&#123;b&#125; : &#123;c&#125; (&#123;d&#125;%)&quot; &#125;&#125; 显示名称","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"024-穿透字段","slug":"项目/HCM教程/024-穿透字段","date":"2025-05-21T12:44:25.000Z","updated":"2025-09-09T06:19:59.385Z","comments":true,"path":"2025/05/21/项目/HCM教程/024-穿透字段/","link":"","permalink":"https://dbbruce.github.io/2025/05/21/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/024-%E7%A9%BF%E9%80%8F%E5%AD%97%E6%AE%B5/","excerpt":"穿透字段-点击表格中的字段内容，跳转1234567891011121314151617181920 &quot;fields&quot;: [ &#123; &quot;label&quot;: &quot;管理员人员差异(%)&quot;, &quot;key&quot;: &quot;u_manager&quot;, &quot;field&quot;: [ &quot;u_manager&quot; ], &quot;data_type&quot;: &quot;integer&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 100, &quot;sequence&quot;: 30, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: false, &quot;color&quot;: &quot;35baf6&quot;, &quot;func&quot;: &quot;=function(_row,col,value)&#123;return SCOPE.super_go(&#x27;common_model_tree_list&#x27;,&#123;&#x27;model&#x27;:&#x27;U_salary_cont&#x27;, &#x27;meta_state&#x27;: &#x27;manage&#x27;, &#x27;filter_dict&#x27;:&#123;&#x27;u_month&#x27;:SCOPE.advance_query.filter_dict.u_month.split(&#x27;&#x27;).join(&#x27;&#x27;)&#125;,&#x27;tree_id&#x27;:&#x27;18309808!&#x27;+_row.depart.id,&#x27;custom_params&#x27;:&#123;&#x27;u_month&#x27;:SCOPE.advance_query.filter_dict.u_month.split(&#x27;&#x27;).join(&#x27;&#x27;)&#125;&#125;)&#125;&quot; &#125;]","text":"穿透字段-点击表格中的字段内容，跳转1234567891011121314151617181920 &quot;fields&quot;: [ &#123; &quot;label&quot;: &quot;管理员人员差异(%)&quot;, &quot;key&quot;: &quot;u_manager&quot;, &quot;field&quot;: [ &quot;u_manager&quot; ], &quot;data_type&quot;: &quot;integer&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 100, &quot;sequence&quot;: 30, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: false, &quot;color&quot;: &quot;35baf6&quot;, &quot;func&quot;: &quot;=function(_row,col,value)&#123;return SCOPE.super_go(&#x27;common_model_tree_list&#x27;,&#123;&#x27;model&#x27;:&#x27;U_salary_cont&#x27;, &#x27;meta_state&#x27;: &#x27;manage&#x27;, &#x27;filter_dict&#x27;:&#123;&#x27;u_month&#x27;:SCOPE.advance_query.filter_dict.u_month.split(&#x27;&#x27;).join(&#x27;&#x27;)&#125;,&#x27;tree_id&#x27;:&#x27;18309808!&#x27;+_row.depart.id,&#x27;custom_params&#x27;:&#123;&#x27;u_month&#x27;:SCOPE.advance_query.filter_dict.u_month.split(&#x27;&#x27;).join(&#x27;&#x27;)&#125;&#125;)&#125;&quot; &#125;]","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"023-function取值的方法","slug":"项目/HCM教程/023-function取值的方法","date":"2025-05-20T15:44:25.000Z","updated":"2025-05-27T07:34:22.412Z","comments":true,"path":"2025/05/20/项目/HCM教程/023-function取值的方法/","link":"","permalink":"https://dbbruce.github.io/2025/05/20/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/023-function%E5%8F%96%E5%80%BC%E7%9A%84%E6%96%B9%E6%B3%95/","excerpt":"function取值的方法 表单：选中的数据 SCOPE.list_model.selected_items 过滤条件： SCOPE.advance_query.filter_dict 三元运算： 条件语句 ? true执行的逻辑 : false执行的逻辑123programid = SCOPE.advance_query.model.split(&#x27;.+&#x27;)[1]fmonth = SCOPE.advance_query.filter_dict.monthfemployee_ids = SCOPE.list_model.selected_items.length &gt; 0 ? SCOPE.list_model.selected_items.map(i =&gt; i.employee_id) : null;","text":"function取值的方法 表单：选中的数据 SCOPE.list_model.selected_items 过滤条件： SCOPE.advance_query.filter_dict 三元运算： 条件语句 ? true执行的逻辑 : false执行的逻辑123programid = SCOPE.advance_query.model.split(&#x27;.+&#x27;)[1]fmonth = SCOPE.advance_query.filter_dict.monthfemployee_ids = SCOPE.list_model.selected_items.length &gt; 0 ? SCOPE.list_model.selected_items.map(i =&gt; i.employee_id) : null; 例子12345678&quot;actions&quot;: [ &#123; &quot;key&quot;: &quot;CmpSCData&quot;, &quot;action&quot;: &quot;CmpSCData&quot;, &quot;label&quot;: &quot;福利数据对比&quot;, &quot;func&quot;: &quot;=function()&#123;debugger;var femployee_ids=SCOPE.list_model.selected_items.length &gt; 0 ? SCOPE.list_model.selected_items.map(i =&gt; i.employee_id) : [];var programid=SCOPE.advance_query.model.split(&#x27;.+&#x27;)[1];var fmonth=SCOPE.advance_query.filter_dict.month;var month2 = fmonth+&#x27;-01&#x27;;var lmonth=`$&#123;new Date(new Date(month2).setMonth(new Date(month2).getMonth() - 1)).getFullYear()&#125;-$&#123;String(new Date(new Date(month2).setMonth(new Date(month2).getMonth() - 1)).getMonth() + 1).padStart(2, &#x27;0&#x27;)&#125;`;var filter_str= &#x27;SOCIAL_PROGRAM:@&#x27;+programid+&#x27;;CURR_MONTH:\\&quot;&#x27;+fmonth+&#x27;\\&quot;;LAST_MONTH:\\&quot;&#x27;+lmonth+&#x27;\\&quot;;PAGE_INDEX:@1;PAGE_SIZE:@20&#x27;;filter_str+=femployee_ids.length &gt; 0 ? &#x27;;EMPLOYEE_ID:[&#x27; + femployee_ids+&#x27;]&#x27;:&#x27;&#x27;;debugger;return SCOPE.super_go(&#x27;flex_report&#x27;,&#123;&#x27;report&#x27;:&#x27;CmpSocialCalculateData&#x27;, &#x27;filter&#x27;: filter_str&#125;)&#125;&quot; &#125;]","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"022-super_go案例","slug":"项目/HCM教程/022-super_go案例","date":"2025-05-20T12:44:25.000Z","updated":"2025-09-09T06:19:59.550Z","comments":true,"path":"2025/05/20/项目/HCM教程/022-super_go案例/","link":"","permalink":"https://dbbruce.github.io/2025/05/20/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/022-super_go%E6%A1%88%E4%BE%8B/","excerpt":"表单字段，使用super_go跳转其他页面 _row 当前行的数据 col 当前字段的信息，字段名，字段长度 value 当前行中表格中的数据","text":"表单字段，使用super_go跳转其他页面 _row 当前行的数据 col 当前字段的信息，字段名，字段长度 value 当前行中表格中的数据 SCOPE.super_go格式123456789101112SCOPE.super_go(&#x27;common_model_tree_list&#x27;,&#123; &#x27;model&#x27;: &#x27;U_salary_cont&#x27;, &#x27;meta_state&#x27;: &#x27;manage&#x27;, &#x27;filter_dict&#x27;: &#123; &#x27;u_month&#x27;: SCOPE.advance_query.filter_dict.u_month.split(&#x27;&#x27;).join(&#x27;&#x27;) &#125;, &#x27;tree_id&#x27;: &#x27;18309808!&#x27;+_row.depart.id, &#x27;custom_params&#x27;: &#123; &#x27;u_month&#x27;: SCOPE.advance_query.filter_dict.u_month.split(&#x27;&#x27;).join(&#x27;&#x27;) &#125;&#125;) 例子-西电1234567891011121314151617181920&quot;fields&quot;: [ &#123; &quot;label&quot;: &quot;管理员人员差异(%)&quot;, &quot;key&quot;: &quot;u_manager&quot;, &quot;field&quot;: [ &quot;u_manager&quot; ], &quot;data_type&quot;: &quot;integer&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;center&quot;, &quot;width&quot;: 100, &quot;sequence&quot;: 30, &quot;fieldFunc&quot;: null, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: false, &quot;color&quot;: &quot;35baf6&quot;, &quot;func&quot;: &quot;=function(_row,col,value)&#123;return SCOPE.super_go(&#x27;common_model_tree_list&#x27;,&#123;&#x27;model&#x27;:&#x27;U_salary_cont&#x27;, &#x27;meta_state&#x27;: &#x27;manage&#x27;, &#x27;filter_dict&#x27;:&#123;&#x27;u_month&#x27;:SCOPE.advance_query.filter_dict.u_month.split(&#x27;&#x27;).join(&#x27;&#x27;)&#125;,&#x27;tree_id&#x27;:&#x27;18309808!&#x27;+_row.depart.id,&#x27;custom_params&#x27;:&#123;&#x27;u_month&#x27;:SCOPE.advance_query.filter_dict.u_month.split(&#x27;&#x27;).join(&#x27;&#x27;)&#125;&#125;)&#125;&quot; &#125;]","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"021-表格多选、单选、无选择控制","slug":"项目/HCM教程/021-表格多选、单选、无选择控制","date":"2025-05-19T15:44:25.000Z","updated":"2025-09-09T06:19:59.342Z","comments":true,"path":"2025/05/19/项目/HCM教程/021-表格多选、单选、无选择控制/","link":"","permalink":"https://dbbruce.github.io/2025/05/19/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/021-%E8%A1%A8%E6%A0%BC%E5%A4%9A%E9%80%89%E3%80%81%E5%8D%95%E9%80%89%E3%80%81%E6%97%A0%E9%80%89%E6%8B%A9%E6%8E%A7%E5%88%B6/","excerpt":"1、表格多选、单选、无选择控制 多选：”selector_type”: 2 单选：”selector_type”: 1 无选择：”selector_type”: 0123&quot;list_config&quot;: &#123; &quot;selector_type&quot;: 2 &#125;","text":"1、表格多选、单选、无选择控制 多选：”selector_type”: 2 单选：”selector_type”: 1 无选择：”selector_type”: 0123&quot;list_config&quot;: &#123; &quot;selector_type&quot;: 2 &#125; 2、给云函数传参 2.1 function方式 _row 1 2.2 action方式 SELECT_ITEMS ：多选中的数据SELECT_ITEM: 单选 1234567891011&#123; &quot;action&quot;: &quot;CALL_API&quot;, &quot;key&quot;: &quot;fmttransfercompensatoryleaveData1&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;private.HRTransferCompensatoryLeaveData&quot;, &quot;params&quot;: &#123; &quot;month&quot;: &quot;expression[FILTER_DICT()]&quot;, &quot;records&quot;: &quot;expression[SELECT_ITEMS().map(item =&gt; item.id)]&quot; &#125; &#125;&#125;","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"020-流程-表格-弹窗禁用","slug":"项目/HCM教程/020-流程表格弹窗禁用","date":"2025-05-19T12:44:25.000Z","updated":"2025-09-09T06:19:59.444Z","comments":true,"path":"2025/05/19/项目/HCM教程/020-流程表格弹窗禁用/","link":"","permalink":"https://dbbruce.github.io/2025/05/19/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/020-%E6%B5%81%E7%A8%8B%E8%A1%A8%E6%A0%BC%E5%BC%B9%E7%AA%97%E7%A6%81%E7%94%A8/","excerpt":"1、流程中【表格】，单据每一条记录会弹窗，一个修改窗口，禁用的方法 弹窗 , “default”: true12345678910&quot;actions&quot;: [ &#123; &quot;key&quot;: &quot;edit&quot;, &quot;label&quot;: &quot;编辑&quot;, &quot;default&quot;: true, &quot;action&quot;: &quot;EDIT&quot;, &quot;left&quot;: true, &quot;condition&quot;: &quot;ITEM&quot; &#125;]","text":"1、流程中【表格】，单据每一条记录会弹窗，一个修改窗口，禁用的方法 弹窗 , “default”: true12345678910&quot;actions&quot;: [ &#123; &quot;key&quot;: &quot;edit&quot;, &quot;label&quot;: &quot;编辑&quot;, &quot;default&quot;: true, &quot;action&quot;: &quot;EDIT&quot;, &quot;left&quot;: true, &quot;condition&quot;: &quot;ITEM&quot; &#125;] 禁止弹窗： “default”: false 隐藏编辑按钮：”hide”: true1234567891011&quot;actions&quot;: [ &#123; &quot;key&quot;: &quot;edit&quot;, &quot;label&quot;: &quot;编辑&quot;, &quot;default&quot;: false, &quot;action&quot;: &quot;EDIT&quot;, &quot;left&quot;: true, &quot;condition&quot;: &quot;ITEM&quot;, &quot;hide&quot;: true &#125;]","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"019-action链-调用流程","slug":"项目/HCM教程/019-action链-调用流程","date":"2025-05-18T14:44:25.000Z","updated":"2025-09-09T06:19:59.554Z","comments":true,"path":"2025/05/18/项目/HCM教程/019-action链-调用流程/","link":"","permalink":"https://dbbruce.github.io/2025/05/18/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/019-action%E9%93%BE-%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B/","excerpt":"1、创建流程 1.1 进入【系统设置，打开一级目录【基础服务】，选择【流程设置】","text":"1、创建流程 1.1 进入【系统设置，打开一级目录【基础服务】，选择【流程设置】 1.2 点击【新增】按钮，填写流程信息，点击【确定】按钮 注意：【编码】在【元数据配置】会用到field_4为表格的key，表格下有2个字段，部门keydepart_id ，调休结转额度keyleave_limit 1.3 流程创建后，将自动生成流程ID，并在【对象管理器】中创建名称为“wf_form_data_flex_data.id”的对象 wf_form_data_flex_data.1062231 1.4 表单设置，页面展示，用于配置流程中的字段与表格 1.5 流程设置，配置【基本信息】，【审批人】，【事件、消息】 1.6 发布 不发布，使用流程会，报错：业务’Transfer_process_renli’未定义或未发布 2、元数据配置 - action链 2.1 配置按钮 12345678910111213141516171819202122232425262728293031323334actions: [ &#123; &quot;label&quot;: &quot;调休结转(人力)&quot;, &quot;key&quot;: &quot;compensatory_leave_off_hr&quot;, &quot;hide&quot;: &quot;=function()&#123;var filtermap=SCOPE.advance_query.filter_dict;if(filtermap[&#x27;standard.u_state&#x27;]==&#x27;1&#x27;)&#123;return false&#125; else&#123;return true&#125;&#125;&quot;, &quot;action&quot;: [ &#123; &quot;action&quot;: &quot;CALL_API&quot;, &quot;key&quot;: &quot;fmttransfercompensatoryleaveData1&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;private.HRTransferCompensatoryLeaveData&quot;, &quot;params&quot;: &#123; &quot;month&quot;: &quot;expression[FILTER_DICT()]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;compensatory_leave_off2&quot;, &quot;action&quot;: &quot;WORKFLOW_CREATE&quot;, &quot;options&quot;: &#123; &quot;business_number&quot;: &quot;Transfer_process_renli&quot;, &quot;go_option&quot;: &#123; &quot;module_type&quot;: &quot;page&quot; &#125;, &quot;form_data&quot;: &#123; &quot;month&quot;: &quot;expression[GET(RES(&#x27;fmttransfercompensatoryleaveData1&#x27;),[&#x27;month&#x27;])]&quot;, &quot;note&quot;: &quot;expression[GET(RES(&#x27;fmttransfercompensatoryleaveData1&#x27;),[&#x27;note&#x27;])]&quot; &#125; &#125; &#125; ] &#125;] 小窗口 “module_type”: “page” 3、云函数 HRTransferCompensatoryLeaveData.py 123456789101112131415161718192021class PrivateAPIService(BasePrivateApiService): &quot;&quot;&quot; 动态私有OpenAPI 使用方法 &quot;&quot;&quot; def execute(self, **kwargs): try: fmt_data = &#123;&#x27;month&#x27;:&#x27;2025-03&#x27;, &#x27;note&#x27;:&#x27;人力部门批量调休转结&#x27;&#125; return fmt_data except Exception as e: self.log(e) raise e def log(self, log_content): log_entry = &#123; &quot;log_type&quot;: &quot;HRTransferCompensatoryLeaveData&quot;, &quot;create_time&quot;: datetime.datetime.now().strftime(&#x27;%Y-%m-%d %H:%M:%S&#x27;), &quot;content&quot;: str(log_content) &#125; CustomerUtil.call_open_api(&quot;hcm.model.create&quot;, &#123;&quot;model&quot;: &quot;dynamic_log&quot;, &quot;info&quot;: log_entry&#125;) 4、表格配置跳转 4.1 fieldFunc,页面加载时就会执行1&quot;fieldFunc&quot;: &quot;=function(_row,col,value)&#123;return &#x27;&lt;div&gt;&lt;a href=&#x27;+STATE.href(\\&quot;emp_details_base\\&quot;,&#123;model:\\&quot;Employee\\&quot;,id:_row.employee_id||_row.id,mode:\\&quot;view\\&quot;&#125;)+&#x27;&gt;&#x27;+value+&#x27;&lt;/a&gt;&lt;/span&gt;&lt;/div&gt;&#x27;;&#125;&quot; 123456789101112131415161718&quot;fields&quot;: [ &#123; &quot;label&quot;: &quot;部门名称&quot;, &quot;key&quot;: &quot;depart_name&quot;, &quot;field&quot;: [ &quot;depart_name&quot; ], &quot;data_type&quot;: &quot;string&quot;, &quot;object&quot;: null, &quot;align&quot;: &quot;left&quot;, &quot;width&quot;: 300, &quot;sequence&quot;: 20, &quot;fieldFunc&quot;: &quot;=function(_row,col,value)&#123;debugger;var pdate=_row.filter_date;var did=_row.depart_id;var s1=&#x27;#/common_model_tree_list?model=AttendanceProfileProgram&amp;page_index=1&amp;page_size=20&amp;meta_state=leave_stand_compensatorydayoff&amp;tree_id=18392218!18392219!19412662&amp;advance_filter_dict=&#123;\\&quot;standard.u_state\\&quot;:\\&quot;1\\&quot;,\\&quot;param_date\\&quot;:\\&quot;&#x27;+pdate+&#x27;\\&quot;,\\&quot;depart_id\\&quot;:&#x27;+did+&#x27;&#125;&amp;show_fields_key=[\\&quot;standard.u_state\\&quot;,\\&quot;param_date\\&quot;,\\&quot;depart_id\\&quot;]&#x27;;debugger;return &#x27;&lt;div&gt;&lt;span&gt;&lt;a href=&#x27;+s1+&#x27;&gt;&#x27;+value+&#x27;&lt;/a&gt;&lt;/span&gt;&lt;/div&gt;&#x27;;&#125;&quot;, &quot;format&quot;: null, &quot;state&quot;: null, &quot;is_blur&quot;: false &#125;]","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"018-按钮调用流程","slug":"项目/HCM教程/018-按钮调用流程","date":"2025-05-18T12:44:25.000Z","updated":"2025-09-09T06:19:59.458Z","comments":true,"path":"2025/05/18/项目/HCM教程/018-按钮调用流程/","link":"","permalink":"https://dbbruce.github.io/2025/05/18/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/018-%E6%8C%89%E9%92%AE%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B/","excerpt":"配置流程 这里的编码，后面调用流程时，会使用到","text":"配置流程 这里的编码，后面调用流程时，会使用到 表单设计，字段的key用来传值 表单设计，配置了表格 表格里的字段 注意流程发布才可以使用，否则会报错：【业务’Transfer_process’未定义或未发布】 配置按钮 business_number 填写的是流程编码 form_data 传数据使用 表格数据格式：’field_3’:[{field_8: 5535042, field_5: ‘测试账号1’, field_6: ‘000004’, field_7: ‘调休’, field_9: 3}]123456789101112&#123; &quot;key&quot;: &quot;compensatory_leave_off&quot;, &quot;label&quot;: &quot;调休结转&quot;, &quot;condition&quot;: &quot;MULTI_ITEM&quot;, &quot;left&quot;: true, &quot;is_important&quot;: true, &quot;hide&quot;: &quot;=function()&#123;debugger;var filtermap=SCOPE.advance_query.filter_dict;if(filtermap[&#x27;standard.u_state&#x27;]==&#x27;null&#x27;)&#123;return false&#125; else&#123;return true&#125;&#125;&quot;, &quot;icon&quot;: &quot;icon-hcm-add-circle&quot;, &quot;action&quot;: &quot;WORKFLOW_CREATE&quot;, &quot;command&quot;: &quot;workflow_Create&quot;, &quot;params&quot;: &quot;=function(_row)&#123;debugger;var r1=_row;return &#123;&#x27;business_number&#x27;:&#x27;Transfer_process&#x27;,go_option:&#123;&#x27;module_type&#x27;:&#x27;page&#x27;&#125;,&#x27;form_data&#x27;: &#123; &#x27;field_3&#x27;:_row.map(item =&gt; &#123; return &#123; field_8:item.standard.id, field_5: item.employee.name, field_6: item.employee.number, field_7: item.standard.attend_item.name, field_9: item.standard.left&#125;&#125;) &#125;&#125;&#125;&quot;&#125; 流程 - 事件设置 事件，后期给节点使用 流程给云函数传数据：@form.field_3@”1234&#123; &quot;field_3&quot;: &quot;@form.field_3@&quot;, &quot;approval_node&quot;: 1&#125; 流程- 节点设置，引用事件 节点，引入事件，添加消息 流程- 流转设置 流转，节点的执行顺序","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"017-案例:上传薪酬方案时，同时创建薪酬档案","slug":"项目/HCM教程/017-案例:上传薪酬方案时，同时创建薪酬档案","date":"2025-05-17T15:44:25.000Z","updated":"2025-09-09T06:19:59.369Z","comments":true,"path":"2025/05/17/项目/HCM教程/017-案例:上传薪酬方案时，同时创建薪酬档案/","link":"","permalink":"https://dbbruce.github.io/2025/05/17/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/017-%E6%A1%88%E4%BE%8B:%E4%B8%8A%E4%BC%A0%E8%96%AA%E9%85%AC%E6%96%B9%E6%A1%88%E6%97%B6%EF%BC%8C%E5%90%8C%E6%97%B6%E5%88%9B%E5%BB%BA%E8%96%AA%E9%85%AC%E6%A1%A3%E6%A1%88/","excerpt":"导入按钮 目前可使用的插件为before_imp_data类型和after_imp_data类型，功能分别为“批量新增数据之前进行数据处理”和“批量新增数据之后进行数据处理” extend_property:{ data_plugins: []} ‘data_plugins’: [{‘key’: ‘before_imp_data_no_file_import’,’name’: ‘AddSalaryProfileRecord’}]","text":"导入按钮 目前可使用的插件为before_imp_data类型和after_imp_data类型，功能分别为“批量新增数据之前进行数据处理”和“批量新增数据之后进行数据处理” extend_property:{ data_plugins: []} ‘data_plugins’: [{‘key’: ‘before_imp_data_no_file_import’,’name’: ‘AddSalaryProfileRecord’}] 12345678910111213141516171819&quot;actions&quot;: [ &#123; &quot;action&quot;: &quot;COMMON_IMPORT&quot;, &quot;left&quot;: true, &quot;data&quot;: &#123; &quot;is_from_config&quot;: true, &quot;imp_method&quot;: 2, &quot;components_hide_config&quot;: &#123; &quot;show_choose_method&quot;: false, &quot;show_key&quot;: true &#125;, &quot;extend_property&quot;: &#123; &quot;data_plugins&quot;: [&#123;&quot;key&quot;: &quot;before_imp_data_yearcheck&quot;, &quot;name&quot;: &quot;YearEndBonusCheck&quot;&#125;] &#125; &#125;, &quot;key&quot;: &quot;common_import&quot;, &quot;label&quot;: &quot;导入&quot; &#125;] 插件代码 AddSalaryProfileRecord 类型：list data插件 kwargs[‘imp_class’].param[‘employee_ids’].append(emp_dict.get(‘id’, ‘’)) 这个是解决:上传文档原本没有档案，新增档案后，不生效的问题。 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233# AddSalaryProfileRecordclass ListPlugInAddSalaryProfileRecord(BaseListPlugIn): &quot;&quot;&quot; 模型data list插件 应用范围：对list接口返回的数据进行二次处理、 &quot;&quot;&quot; # def get_next_month(self, date_str): # &quot;&quot;&quot; # 获取下一个月 # &quot;&quot;&quot; # date = datetime.datetime.strptime(date_str, &quot;%Y-%m&quot;) # next_month = date.replace(day=1) + datetime.timedelta(days=32) # return f&quot;&#123;next_month.year&#125;-&#123;next_month.month:02d&#125;&quot; def _call_api(self, api_name, args_dict): &quot;&quot;&quot;封装API调用逻辑&quot;&quot;&quot; return CustomerUtil.call_open_api(api_name, args_dict).get(&quot;list&quot;, []) def create_profile_record(self, arg_dict): return CustomerUtil.call_open_api(&#x27;salary.profile.batch.new&#x27;, arg_dict) def group_list_by_profile_info(self, list_data): grouped_data = &#123;&#125; for item in list_data: for key, value in item.items(): profile_info = value[&#x27;profile_info&#x27;] employee_info = value[&#x27;employee_ids_info&#x27;] profile_info_tuple = tuple(profile_info.items()) # print(f&#x27;profile_info_tuple-&#123;profile_info_tuple&#125;&#x27;) if profile_info_tuple not in grouped_data: grouped_data[profile_info_tuple] = &#123;&#x27;employee_ids&#x27;: [], &#x27;info&#x27;: profile_info&#125; grouped_data[profile_info_tuple][&#x27;employee_ids&#x27;].append(employee_info) # 将字典转换为列表 result = [] for key, value in grouped_data.items(): result.append(&#123; &#x27;employee_ids&#x27;: value[&#x27;employee_ids&#x27;], &#x27;info&#x27;: value[&#x27;info&#x27;] &#125;) return result def employee_info_datas(self, employee_num_list, current_date): &quot;&quot;&quot; 根据人员编号查询人员信息 &quot;&quot;&quot; args_dict = &#123; &quot;model&quot;: &quot;Employee&quot;, &quot;filter_dict&quot;: &#123; &quot;number&quot;: &#123; &quot;in&quot;: employee_num_list &#125;, &quot;date_&quot;: current_date &#125;, &quot;page_index&quot;: 1, &quot;page_size&quot;: 99999, &quot;extra_property&quot;: &#123; &quot;state&quot;: &quot;all&quot;, &quot;fields&quot;:[ &#123;&quot;key&quot;:&quot;depart_id&quot;, &quot;field&quot;:[&quot;department&quot;, &quot;origin_id&quot;]&#125;, &#123;&quot;key&quot;:&quot;position_id&quot;, &quot;field&quot;:[&quot;position&quot;, &quot;origin_id&quot;]&#125;, &#123;&quot;key&quot;:&quot;origin_job_id&quot;, &quot;field&quot;:[&quot;job_info&quot;, &quot;id&quot;]&#125;, &#123;&quot;key&quot;:&quot;number&quot;, &quot;field&quot;:[&quot;number&quot;]&#125; ] &#125; &#125; return self._call_api(&quot;hcm.model.list&quot;, args_dict) def _get_other_salaryprofile_data(self, employee_num_list): &quot;&quot;&quot; 根据人员编号查询在其他的薪酬档案中是否有信息，获取薪档等信息，用于创建新的薪酬档案 &quot;&quot;&quot; args_dict = &#123; &quot;model&quot;: &quot;SalaryProfile&quot;, &quot;filter_dict&quot;: &#123; &quot;end_month&quot;: &quot;2199-12&quot;, &quot;employee.number&quot;: &#123; &quot;in&quot;: employee_num_list &#125; &#125;, &quot;page_index&quot;: 1, &quot;page_size&quot;: 99999, &quot;extra_property&quot;: &#123; &quot;state&quot;: &quot;normal_multi&quot; &#125; &#125; return self._call_api(&quot;hcm.model.list&quot;, args_dict) def _get_salaryprofile_datas(self, month, program_id, employee_num_list): &quot;&quot;&quot; 获取薪酬档案数据 params: program_id 薪酬档案方案ID params: employee_num_list 人员编号 params: month 日期 return: list &quot;&quot;&quot; args_dict = &#123; &quot;model&quot;: &quot;SalaryProfile&quot;, &quot;filter_dict&quot;: &#123; &quot;month&quot;: month, &quot;program_id&quot;: program_id, &quot;employee.number&quot;: &#123; &quot;in&quot;: employee_num_list &#125; &#125;, &quot;page_index&quot;: 1, &quot;page_size&quot;: 99999, &quot;extra_property&quot;: &#123; &quot;state&quot;: &quot;normal_multi&quot;, &quot;fields&quot;:[ &#123; &quot;field&quot;: [&quot;employee&quot;, &quot;number&quot;],&quot;key&quot;: &quot;emp_number&quot;&#125; ] &#125; &#125; return self._call_api(&quot;hcm.model.list&quot;, args_dict) def post(self, context, _list, _count, plugin_config, **kwargs): try: filter_data = kwargs.get(&#x27;imp_class&#x27;).extend_property program_id = filter_data.get(&#x27;filter_dict&#x27;, &#123;&#125;).get(&#x27;program_id&#x27;) month = filter_data.get(&#x27;filter_dict&#x27;, &#123;&#125;).get(&#x27;month&#x27;) current_date = datetime.datetime.now().strftime(&quot;%Y-%m-%d&quot;) # next_month = self.get_next_month(month) # excel表中的人员编号 all_emp_num_list = list() for _l in _list: # 改成校验通过 _l[&#x27;imp_status&#x27;] = &#x27;校验通过&#x27; # 人员编号 employee_number = _l.get(&#x27;employee_number&#x27;) all_emp_num_list.append(employee_number) # 根据人员编号查询薪酬档案 exsit_emp_num_list = list() salaryprofile_datas = self._get_salaryprofile_datas(month, program_id, all_emp_num_list) for sp_dict in salaryprofile_datas: employee_number = sp_dict.get(&#x27;employee&#x27;, &#123;&#125;).get(&#x27;number&#x27;) exsit_emp_num_list.append(employee_number) # 差集 - 没有档案的人员编号 diff_emp_num = list(set(all_emp_num_list)-set(exsit_emp_num_list)) # 查询是否有旧的薪酬档案 other_salaryProfile_dict = dict() other_salaryprofile_datas =self._get_other_salaryprofile_data(diff_emp_num) for odata_dict in other_salaryprofile_datas: emp_num = odata_dict.get(&#x27;employee&#x27;, &#123;&#125;).get(&#x27;number&#x27;) u_salary_n_id = odata_dict.get(&#x27;u_salary_n&#x27;, &#123;&#125;).get(&#x27;id&#x27;) u_salary_level = odata_dict.get(&#x27;u_salary_level&#x27;, &#x27;&#x27;) # 薪资表 或者 薪档有数据的写入 if u_salary_n_id or u_salary_level: other_salaryProfile_dict[emp_num] = &#123; &#x27;u_salary_n_id&#x27;: u_salary_n_id, &#x27;u_salary_level&#x27;: u_salary_level, &#125; # 创建薪酬档案的信息 - 薪酬档案的信息，value是人员列表信息 create_profile_list = list() emp_list = self.employee_info_datas(diff_emp_num, current_date) for emp_dict in emp_list: emp_num = emp_dict.get(&#x27;number&#x27;, &#x27;&#x27;) # 人员信息 employee_ids_info = &#123; &quot;employee_id&quot;: emp_dict.get(&#x27;id&#x27;, &#x27;&#x27;), &quot;depart_id&quot;: emp_dict.get(&#x27;department&#x27;,&#123;&#125;).get(&#x27;origin_id&#x27;, &#x27;&#x27;), &quot;position_id&quot;: emp_dict.get(&#x27;position&#x27;,&#123;&#125;).get(&#x27;origin_id&#x27;, &#x27;&#x27;), &quot;position_type&quot;: 1, &quot;origin_job_id&quot;: emp_dict.get(&#x27;job_info&#x27;,&#123;&#125;).get(&#x27;id&#x27;, &#x27;&#x27;) &#125; kwargs[&#x27;imp_class&#x27;].param[&#x27;employee_ids&#x27;].append(emp_dict.get(&#x27;id&#x27;, &#x27;&#x27;)) # 薪酬档案信息 profile_info = &#123; &quot;begin_month&quot;: month, &quot;end_month&quot;: month, &quot;salary_begin_month&quot;: month, &quot;program_id&quot;: program_id, &quot;tax_company_id&quot;: 17443, # &quot;is_resident&quot;: 1, # &quot;init_calc&quot;: True, # &quot;is_calc_tax&quot;: True, &#125; old_profile_data = other_salaryProfile_dict.get(emp_num, &#123;&#125;) if old_profile_data: u_salary_n_id = old_profile_data.get(&#x27;u_salary_n_id&#x27;, &#x27;&#x27;) if u_salary_n_id: profile_info[&#x27;u_salary_name&#x27;] = u_salary_n_id u_salary_level = old_profile_data.get(&#x27;u_salary_level&#x27;, &#x27;&#x27;) if u_salary_level: profile_info[&#x27;u_salary_level&#x27;] = u_salary_level create_profile_list.append( &#123;emp_num: &#123; &quot;employee_ids_info&quot;:employee_ids_info, &quot;profile_info&quot;:profile_info &#125; &#125; ) fmt_create_data = self.group_list_by_profile_info(create_profile_list) for cdata in fmt_create_data: self.create_profile_record(cdata) except Exception as e: self.log(e) # self.log(f&quot;employee_ids-&#123;kwargs[&#x27;imp_class&#x27;].param[&#x27;employee_ids&#x27;]&#125;&quot;) return _list, _count def log(self, log_content): log_entry = &#123; &quot;log_type&quot;: &quot;AddSalaryProfileRecord&quot;, &quot;create_time&quot;: datetime.datetime.now().strftime(&#x27;%Y-%m-%d %H:%M:%S&#x27;), &quot;content&quot;: str(log_content) &#125; CustomerUtil.call_open_api(&quot;hcm.model.create&quot;, &#123;&quot;model&quot;: &quot;dynamic_log&quot;, &quot;info&quot;: log_entry&#125;) 导入按钮上配置1234567&#123; &quot;action&quot;: &quot;COMMON_IMPORT&quot;, &quot;key&quot;: &quot;salary_data_import1&quot;, &quot;label&quot;: &quot;覆盖导入&quot;, &quot;hide&quot;: &quot;=function()&#123;if(JSON.parse(STATE.params.custom_params).flag_state==&#x27;work_flow&#x27;)&#123;return true;&#125;else&#123;return false&#125;&#125;&quot;, &quot;data&quot;: &quot;=function()&#123;let filter_dict = SCOPE.advance_query.filter_dict;if(SCOPE.advance_query.filter_dict.month == undefined)&#123;filter_dict = SCOPE.advance_query.default_filter_dict&#125;return &#123;&#x27;title&#x27;: &#x27;薪酬数据导入&#x27;,&#x27;category&#x27;:SCOPE.advance_query.model,&#x27;import_class&#x27;:&#x27;apps.salary.data.services.SalaryDataImportServices&#x27;,&#x27;impMethod&#x27;: 2,&#x27;imp_tips&#x27;: [&#x27;建议每次导入间隔2分钟。&#x27;],&#x27;choose_method&#x27;: false,&#x27;show_business_key&#x27;: false,&#x27;extend_property&#x27;:&#123;&#x27;empty_selector&#x27;: false, empty_mode:0,&#x27;is_clear&#x27;:1,&#x27;filter_dict&#x27;:filter_dict,&#x27;model&#x27;:SCOPE.advance_query.model,&#x27;month&#x27;:SCOPE.advance_query.query_model.data.month,&#x27;extra_property&#x27;:&#123;&#x27;state&#x27;:&#x27;result_imp_template&#x27;,&#x27;fields&#x27;:[]&#125;,&#x27;data_plugins&#x27;: [&#123;&#x27;key&#x27;: &#x27;before_imp_data_no_file_import&#x27;,&#x27;name&#x27;: &#x27;AddSalaryProfileRecord&#x27;&#125;]&#125;&#125;&#125;&quot;&#125;","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"016-自定义模板","slug":"项目/HCM教程/016-自定义模板","date":"2025-05-17T12:44:25.000Z","updated":"2025-09-09T06:19:59.381Z","comments":true,"path":"2025/05/17/项目/HCM教程/016-自定义模板/","link":"","permalink":"https://dbbruce.github.io/2025/05/17/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/016-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A8%A1%E6%9D%BF/","excerpt":"导入按钮","text":"导入按钮 “category”: “EmpApplicationForm” 对应模板中的Key is_from_config 是否使用个性化模板，false为否。 category 模型名或者个性化模板的common_imp_setting.json映射名称123456789101112131415actions: [ &#123; &quot;action&quot;: &quot;COMMON_IMPORT&quot;, &quot;key&quot;: &quot;custome_emp_application_form&quot;, &quot;data&quot;: &#123; &quot;is_from_config&quot;: true, &quot;category&quot;: &quot;EmpApplicationForm&quot;, &quot;import_class&quot;: &quot;core.base.imp_exp.services_dynamic_model.DynamicCustomerImport&quot;, &quot;extend_property&quot;: &#123; &quot;dynamic_plugin&quot;: &quot;CustomEmpApplicationForm&quot; &#125; &#125;, &quot;label&quot;: &quot;导入应聘申请表&quot; &#125;] 所有参数解释12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667&#123; &quot;action&quot;: &quot;COMMON_IMPORT&quot;, #【必填】按钮调用的方法，COMMON_IMPORT是框架通用导入。 &quot;label&quot; : &quot;模版型导入&quot;, #【必填】按钮名称。 &quot;key&quot; : &quot;common_import&quot;, #【必填】按钮的key，即唯一键，与其他按钮区分的唯一标识。 &quot;data&quot;:&#123; #【选填】导入按钮的一些个性设置，以下均为选填。 &quot;is_from_config&quot;: false, # 是否使用个性化模板，false为否。 &quot;category&quot;: &quot;whatever&quot;, # 模型名或者个性化模板的common_imp_setting.json映射名称。不用个性化模板最好别设置。注意！：可自定义，但需要与common_imp_setting.json相互对应，模板内的category必须是具体模型名。 &quot;file_name&quot;: &quot;自己想怎么命名怎么命名.xlsx&quot;, # 自定义下载的导入模板文件名，使用个性化模板时（is_from_config:true）时不生效，需在common_imp_setting.json中配置name。 &quot;import_class&quot;: &quot;&quot;, # 使用的导入类。业务老师提供了，则使用业务老师提供的，否则不写。是固定的，不要自己瞎写。 &quot;role&quot;: &quot;&quot;, # 导入角色。 &quot;imp_type&quot;: &quot;SUB_IMPORT&quot;, # 子表导入 &quot;use_column_defs&quot;: false, # 设为true则多表头导入(生成不了多表头导入模板，但是能多表头导入) &quot;imp_tips&quot;: [&quot;1、今天简单说以下几点&quot;, &quot;。&quot;, &quot;。。&quot;], # 自定义导入提示 &quot;show_business_key&quot;: false, # 显示导入依据 &quot;choose_method&quot;: false, # 是否展示导入模式选择 &quot;imp_method&quot;: 0, # 默认导入模式（0:仅新增，1:仅编辑，2:有则编辑无则新增） &quot;empty_selector&quot;: false, # 是否展示选择器（默认为false） false: 不展示, true: 展示 &quot;empty_mode&quot;: 1, # 默认值（默认为1） 0: 正常导入(编辑时覆盖)， 1： 跳过 &quot;action_state&quot;: &quot;&quot;, # 弹窗内部按钮的场景，修改ImpActionVirtual不同场景的list元数据来配置不同的弹窗内按钮，详见【导入导出小案例-9】 &quot;filter_org&quot;: [], # 过滤组织（需要配合charge_role使用，进一步控制权限范围内的部门） &quot;extend_property&quot;: &#123; &quot;begin_row&quot;:1 #开始导入行,数据从excel文件的哪一行开始读取。默认是：导入文件有描述行，则从第三行开始读取，否则从第二行开始。 &quot;check_column_config&quot;:true/false #是否校验上传模板中column_config列完整 &quot;map_warn&quot;: false, # 当导入文件中的列名与info元数据中的列名不匹配时，是否直接拦截导入。默认为否（false）。 &quot;data_plugins&quot;: &#123;&#125;, # 自定义导入插件，详见【3.自定义配置导入插件】 &quot;convert_none_data&quot;: false, # 是否需要二次转换空数据。一般不用填。单位、部门、岗位导入需要填为true。 &quot;send_message&quot;: true, # 导入报告是否以消息形式发送。 &quot;charge_role&quot;: [&#123; # 用于校验权限。 &quot;field&quot;: &quot;dept_id&quot;, # 需要校验部门/岗位权限的字段 &quot;role&quot;: &quot;cm-org-emp&quot;, # 权限范围 &quot;type&quot;: &quot;dept&quot; # 类型（部门/岗位校验） &#125;, &#123; &quot;field&quot;: &quot;employee&quot;, # 需要校验人员权限的字段 &quot;role&quot;: &quot;cm-org-emp&quot;, # 权限范围 &quot;type&quot;: &quot;emp&quot; # 类型（人员校验） &#125;, &#123; &quot;field&quot;: &quot;pre_employee_id&quot;, # 需要校验待入职人员权限的字段 &quot;role&quot;: &quot;cm-org-emp&quot;, # 权限范围 &quot;type&quot;: &quot;pre_emp&quot; # 类型（待入职人员校验） &#125;], &quot;common_check_items&quot;:&#123; &quot;imp&quot;:&#123; &quot;int_float_data_max_min_check&quot;:[&quot;u_int&quot;,&quot;u_float&quot;] &#125; &#125; # 导入时根据整数和浮点数的info元数据上字段属性(&quot;options&quot;:&#123;&quot;max&quot;:xxx,&quot;min&quot;:xxx&#125;)校验最大最小值。&#125;, &quot;extra_property&quot;: &#123; &quot;field_state&quot;: &#123;&quot;字段1的key&quot;: &quot;想要的场景&quot;&#125;, # 字典类型。当一个字段为关联对象类型时，可以设置他关联对象的场景进行下拉选项的过滤。详见【导入导出案例】 &quot;state&quot;: &quot;imp&quot;, # 导入场景。自定义是以哪个场景的info元数据为依据。 &#125;,# 支持自定义修改导入弹窗的各个组件是否展示，默认还是展示可设置隐藏即将对应参数改为false&quot;components_hide_config&quot;: &#123; &quot;show_imp_tip&quot;: true, # 导入提示 &quot;show_choose_method&quot;: true, # 导入模式选择 &quot;show_empty_selector&quot;: true, # 单元格为空操作 &quot;show_key&quot;: true, # 导入依据（业务主键） &quot;show_import_message&quot;: true, # 导入过程信息 &quot;show_download_template&quot;: true, # 点击下载模板 &quot;show_import_map&quot;: true, # 导入映射按钮 &quot;show_imp_msg&quot;: true, # 人力_导入详情 &quot;show_imp_result&quot;: true, # 人力_导入结果 &quot;upload_tip_line_1&quot;: , # 可修改附件上传的描述内容（第一行） &quot;upload_tip_line_2&quot;: , # 可修改附件上传的描述内容（第二行） &#125; &#125; &#125;&#125; 按钮实例12345678&#123; &quot;key&quot;: &quot;common_import&quot;, &quot;label&quot;: &quot;标准导入按钮&quot;, &quot;action&quot;: &quot;COMMON_IMPORT&quot;, &quot;data&quot;: &#123; &quot;is_from_config&quot;: true, &quot;category&quot;: &quot;可以不填，不填时默认取当前模型名。填的话想写啥就写啥，但是要记下来，下面要用。&quot;&#125; 模版-描述行设置-可以关闭 配置模板- import_custome_emp_application_form 12345678910111213141516171819&#123; &quot;alias&quot;: &quot;应聘申请表导入&quot;, &quot;category&quot;: &quot;Employee&quot;, &quot;primary_key&quot;: &quot;name&quot;, &quot;import_class&quot;: &quot;core.base.imp_exp.services_dynamic_model.DynamicCustomerImport&quot;, &quot;filters&quot;: [], &quot;orders&quot;: [], &quot;fields&quot;: [&#123; &quot;key&quot;: &quot;name&quot;, &quot;name&quot;: &quot;姓名&quot;, &quot;width&quot;: 20, &quot;comment&quot;: &quot;★系统校验项\\n填写有效身份证对应的姓名，不能含有空格&quot;, &quot;require&quot;: false &#125;], &quot;check_items&quot;: &#123; &quot;imp&quot;: [], &quot;exp&quot;: [] &#125;&#125; 配置模板与按钮的关系 -common_imp_setting.json 需要继承，新建一个common_imp_setting.json，把原内容拷贝过来，然后修改 EmpApplicationForm 用于按钮12345678910&#123; ... ... ... &quot;EmpApplicationForm&quot;: &#123; &quot;name&quot;: &quot;导入应聘申请表&quot;, &quot;imp&quot;: &quot;import_custome_emp_application_form.json&quot;, &quot;role&quot;: &quot;cm-org-emp.emp&quot; &#125;&#125;","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"015-套打功能","slug":"项目/HCM教程/015-套打功能","date":"2025-05-16T15:44:25.000Z","updated":"2025-09-09T06:19:59.365Z","comments":true,"path":"2025/05/16/项目/HCM教程/015-套打功能/","link":"","permalink":"https://dbbruce.github.io/2025/05/16/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/015-%E5%A5%97%E6%89%93%E5%8A%9F%E8%83%BD/","excerpt":"功能展示","text":"功能展示 配置套打模板 套打管理，上传模板 模板修改，必须使用域，不能直接修改 编辑云函数 类型： 其他 函数名： print_doc_data_expand_上面套打的标识 ， print_doc_data_expand_Personnel_Resume 预览 “is_print”: true 就是预览 ， 不加这个配置，就是下载 1234567891011121314151617&quot;actions&quot;:[ &#123; &quot;action&quot;: &quot;PRINT_DOWNLOAD&quot;, &quot;key&quot;: &quot;print_download&quot;, &quot;label&quot;: &quot;下载人员履历表&quot;, &quot;sequence&quot;: 51, &quot;hide&quot;: false, &quot;params&quot;: &#123; &quot;api_name&quot;: &quot;hcm.model.list&quot;, &quot;model_id&quot;: &quot;Personnel_Resume&quot;, &quot;model&quot;: &quot;Employee&quot;, &quot;multi&quot;: &quot;multi&quot;, &quot;view_type&quot;: &quot;docx&quot;, &quot;is_print&quot;: true &#125; &#125;] 下载 “is_print”: true 不加这个配置，就是下载 12345678910111213141516&quot;actions&quot;:[ &#123; &quot;action&quot;: &quot;PRINT_DOWNLOAD&quot;, &quot;key&quot;: &quot;print_download&quot;, &quot;label&quot;: &quot;下载人员履历表&quot;, &quot;sequence&quot;: 51, &quot;hide&quot;: false, &quot;params&quot;: &#123; &quot;api_name&quot;: &quot;hcm.model.list&quot;, &quot;model_id&quot;: &quot;Personnel_Resume&quot;, &quot;model&quot;: &quot;Employee&quot;, &quot;multi&quot;: &quot;multi&quot;, &quot;view_type&quot;: &quot;docx&quot; &#125; &#125;]","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"014-点按钮、弹窗","slug":"项目/HCM教程/014-点按钮、弹窗","date":"2025-05-16T12:44:25.000Z","updated":"2025-09-09T06:19:59.361Z","comments":true,"path":"2025/05/16/项目/HCM教程/014-点按钮、弹窗/","link":"","permalink":"https://dbbruce.github.io/2025/05/16/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/014-%E7%82%B9%E6%8C%89%E9%92%AE%E3%80%81%E5%BC%B9%E7%AA%97/","excerpt":"功能展示 点击 【按钮】， 出现 【弹窗】","text":"功能展示 点击 【按钮】， 出现 【弹窗】 配置代码 按钮配置123456789101112131415161718192021222324252627282930313233343536373839&quot;actions&quot;: [ &#123; &quot;key&quot;: &quot;dept_check&quot;, &quot;label&quot;: &quot;查看检查结果&quot;, &quot;action&quot;: [ &#123; &quot;action&quot;: &quot;CALL_API&quot;, &quot;key&quot;: &quot;call_api&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;hcm.model.list&quot;, &quot;params&quot;: &#123; &quot;model&quot;: &quot;HCMModelCheckProgram&quot;, &quot;filter_dict&quot;: &#123; &quot;number&quot;: &quot;GZW_003&quot; &#125;, &quot;extra_property&quot;: &#123; &quot;only_list&quot;: true &#125; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;show&quot;, &quot;action&quot;: &quot;COMMON_LIST_DIALOG&quot;, &quot;options&quot;: &#123; &quot;title&quot;: &quot;组织信息检查&quot;, &quot;selectorModel&quot;: &quot;HCMModelCheckInstance&quot;, &quot;component&quot;: &quot;hc-category-list-selector&quot;, &quot;selectorType&quot;: 0, &quot;state&quot;: &quot;main_salary&quot;, &quot;filter_dict&quot;: &#123; &quot;program_id&quot;: &quot;expression[GET(RES(&#x27;call_api&#x27;)[&#x27;list&#x27;][0], [&#x27;id&#x27;])]&quot; &#125; &#125; &#125; ], &quot;hide&quot;: false &#125;]","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"013-模型插件","slug":"项目/HCM教程/013-模型插件","date":"2025-05-15T12:44:25.000Z","updated":"2025-09-09T06:19:59.345Z","comments":true,"path":"2025/05/15/项目/HCM教程/013-模型插件/","link":"","permalink":"https://dbbruce.github.io/2025/05/15/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/013-%E6%A8%A1%E5%9E%8B%E6%8F%92%E4%BB%B6/","excerpt":"页面配置1https://wiki.hcmcloud.cn/spaces/DOC/pages/149723225/0208.%E6%A8%A1%E5%9E%8B%E6%8F%92%E4%BB%B6%E5%92%8C%E5%88%97%E8%A1%A8%E6%8F%92%E4%BB%B6%E8%AE%B2%E8%A7%A3","text":"页面配置1https://wiki.hcmcloud.cn/spaces/DOC/pages/149723225/0208.%E6%A8%A1%E5%9E%8B%E6%8F%92%E4%BB%B6%E5%92%8C%E5%88%97%E8%A1%A8%E6%8F%92%E4%BB%B6%E8%AE%B2%E8%A7%A3 1、打开元数据配置 2、切换到元数据 3、plugin写入代码在Model元数据中配置：Model元数据 配置key 必填 说明 key 是 插件key值，唯一 type 是 插入点类型，格式：{pre&#x2F;post操作}_{增删改操作} pre，post create_data,edit_data,remove_data,remove_datas name 是 插件名称，标准产品插件写入插件路径，云函数填入云函数名称 plugin_type 否 插件类型，值为standard为标准代码 其他为云函数 meta_disabled 否 是否禁用，为true则禁用 123456789101112&quot;plugins&quot;: [&#123; &quot;key&quot;: &quot;OrgDepartment_pre_number_generator&quot;, &quot;type&quot;: &quot;pre_create_data&quot;, &quot;name&quot;: &quot;apps.org.org_model_plugin.ModelPlugInOrgNumberGenerator&quot;, &quot;plugin_type&quot;: &quot;standard&quot; &#125;, &#123; &quot;key&quot;: &quot;pre_create_dept_plugin&quot;, &quot;type&quot;: &quot;pre_create_data&quot;, &quot;name&quot;: &quot;prepost_create_dept_plugin&quot; &#125;] 1234567&quot;plugins&quot;: [ &#123; &quot;key&quot;: &quot;post_create_addlvStddtl_plugin&quot;, &quot;type&quot;: &quot;pre_create_data&quot;, &quot;name&quot;: &quot;PostPluginAddLeaveStandardDetail&quot; &#125;] 4、云函数 - 类型：模型插件 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177class ModelPlugInAddLeaveStandardDetail(BaseModelPlugIn): &quot;&quot;&quot; 模型插件 应用范围：create_data,edit_data,remove_data,remove_datas 如果类型为pre，调用pre方法，类型为post，调用post方法 &quot;&quot;&quot; # 定义常量 # 休假项目:调休 ATTEND_ITEM_ID = 12866 SOURCE_TYPE = &quot;adjust_manual&quot; DESCRIPTION = &quot;加班额度扣减&quot; # 发生方向:减 DIRECTION = -1 PAGE_SIZE = 999999 def _create_leavestandarddetail_record(self, employee_id, standard_id, uvalue, effect_date): &quot;&quot;&quot; 创建休假标准明细记录 params: employee_id 人员ID params: standard_id 标准ID params: uvalue 单位值 params: effect_date 生效日期 &quot;&quot;&quot; args_dict = &#123; &quot;model&quot;: &quot;LeaveStandardDetail&quot;, &quot;info&quot;: &#123; &quot;employee_id&quot;: employee_id, &quot;calc_unit&quot;: 1, &quot;attend_item_id&quot;: self.ATTEND_ITEM_ID, &quot;calc&quot;: True, &quot;source_type&quot;: self.SOURCE_TYPE, &quot;standard_id&quot;: standard_id, &quot;description&quot;: self.DESCRIPTION, &quot;unit_value&quot;: uvalue, &quot;direction&quot;: self.DIRECTION, &quot;effect_date&quot;: effect_date &#125; &#125; return self._call_api(&quot;hcm.model.create&quot;, args_dict) def _call_api(self, api_name, args_dict): &quot;&quot;&quot;封装API调用逻辑&quot;&quot;&quot; return CustomerUtil.call_open_api(api_name, args_dict).get(&quot;list&quot;, []) def _get_leavestandarddetail_datas(self, employee_id, standard_id): &quot;&quot;&quot; 获取休假标准明细数据 params: employee_id 人员ID params: standard_id 标准ID &quot;&quot;&quot; args_dict = &#123; &quot;model&quot;: &quot;LeaveStandardDetail&quot;, &quot;filter_dict&quot;: &#123; &quot;attend_item_id&quot;: self.ATTEND_ITEM_ID, &quot;employee_id&quot;: employee_id, &quot;standard_id&quot;: standard_id &#125;, &quot;page_index&quot;: 1, &quot;page_size&quot;: self.PAGE_SIZE, &quot;extra_property&quot;: &#123; &quot;state&quot;: &quot;office_empDetail&quot;, &quot;fields&quot;: [ &#123;&quot;key&quot;: &quot;unit_value&quot;, &quot;field&quot;: [&quot;unit_value&quot;]&#125;, &#123;&quot;key&quot;: &quot;direction&quot;, &quot;field&quot;: [&quot;direction&quot;]&#125; ] &#125; &#125; return self._call_api(&quot;hcm.model.list&quot;, args_dict) def _get_attendanceprofileprogram_datas(self, date_str, employee_id): &quot;&quot;&quot; 获取考勤档案数据 params: employee_id 人员ID params: date_str 日期 return: list 考勤月报数据 &quot;&quot;&quot; args_dict = &#123; &quot;model&quot;: &quot;AttendanceProfileProgram&quot;, &quot;filter_dict&quot;: &#123; &quot;date_&quot;: date_str, &quot;employee_id&quot;: employee_id, &quot;standard.attend_item_id&quot;: [self.ATTEND_ITEM_ID] &#125;, &quot;page_index&quot;: 1, &quot;page_size&quot;: 20, &quot;extra_property&quot;: &#123; &quot;state&quot;: &quot;leave_stand&quot;, &quot;fields&quot;: [&#123;&quot;key&quot;: &quot;standard_id&quot;, &quot;field&quot;: [&quot;standard&quot;, &quot;id&quot;]&#125;] &#125; &#125; return self._call_api(&quot;hcm.model.list&quot;, args_dict) def pre(self, company_id, **kwargs): &quot;&quot;&quot; Pre插件 kwargs:经过转换的原函数调用参数，经过干预后，返回kwargs继续调用原函数 &quot;&quot;&quot; try: self.log(f&#x27;kwargs-&#123;kwargs&#125;&#x27;) effect_date = kwargs.get(&#x27;info&#x27;, &#123;&#125;).get(&#x27;effect_date&#x27;, &#x27;&#x27;) employee_id = kwargs.get(&#x27;info&#x27;, &#123;&#125;).get(&#x27;employee_id&#x27;, &#x27;&#x27;) # 本次值 curr_unit_value = kwargs[&#x27;info&#x27;][&#x27;unit_value&#x27;] # 本次方向 curr_direction = kwargs[&#x27;info&#x27;][&#x27;direction&#x27;] # self.log(f&#x27;effect_date-&#123;effect_date&#125;-employee_id-&#123;employee_id&#125;&#x27;) # 获取考勤档案数据 attendanceprofileprogram_list = self._get_attendanceprofileprogram_datas(effect_date, employee_id) # self.log(f&#x27;考勤档案数据: &#123;attendanceprofileprogram_list&#125;&#x27;) if not attendanceprofileprogram_list: self.log(f&#x27;新增休假额度-不增加 - employee_id: &#123;employee_id&#125;, effect_date: &#123;effect_date&#125;, 考勤档案为空&#x27;) return kwargs standard_id = attendanceprofileprogram_list[0].get(&quot;standard&quot;, &#123;&#125;).get(&quot;id&quot;, &quot;&quot;) if not standard_id: self.log(f&#x27;新增休假额度-不增加 - employee_id: &#123;employee_id&#125;, effect_date: &#123;effect_date&#125;, standard_id为空&#x27;) return kwargs # 获取休假标准明细数据 leavestandarddetail_list = self._get_leavestandarddetail_datas(employee_id, standard_id) # self.log(f&#x27;新增休假额度-查看明细数据: &#123;leavestandarddetail_list&#125;&#x27;) # 计算已扣减明细总和 lsdetail_num = 0 for detail_dict in leavestandarddetail_list: if detail_dict.get(&#x27;direction&#x27;) == -1: lsdetail_num -= float(detail_dict.get(&#x27;unit_value&#x27;, 0)) else: lsdetail_num += float(detail_dict.get(&#x27;unit_value&#x27;, 0)) # self.log(f&#x27;新增休假额度-已扣减明细总和: &#123;lsdetail_num&#125; 小时&#x27;) # 增方向 if curr_direction == 1: # 已经大于36 if lsdetail_num &gt;= 36: kwargs[&#x27;info&#x27;][&#x27;unit_value&#x27;] = 0 kwargs[&#x27;info&#x27;][&#x27;description&#x27;] = f&quot;当前额度为 &#123;lsdetail_num&#125; 小时，该额度已大于 36 小时，因此不允许再增加额度！！！&quot; else: reduce_num = 36 - lsdetail_num if curr_unit_value &gt; reduce_num: kwargs[&#x27;info&#x27;][&#x27;unit_value&#x27;] = reduce_num kwargs[&#x27;info&#x27;][&#x27;description&#x27;] = f&quot;当前额度为 &#123;lsdetail_num&#125; 小时，预期增加 &#123;curr_unit_value&#125; 小时，但因剩余可增加额度仅 &#123;reduce_num&#125; 小时，本次实际增加 &#123;reduce_num&#125; 小时！！！&quot; return kwargs except Exception as e: self.log(e) raise e def post(self, company_id, result,**kwargs): &quot;&quot;&quot; Post插件 result：原函数调用返回的结果，经过干预后，返回 kwargs：原函数调用参数 &quot;&quot;&quot; return result def log(self, log_content): log_entry = &#123; &quot;log_type&quot;: &quot;PostPluginAddLeaveStandardDetail&quot;, &quot;create_time&quot;: datetime.datetime.now().strftime(&#x27;%Y-%m-%d %H:%M:%S&#x27;), &quot;content&quot;: str(log_content) &#125; CustomerUtil.call_open_api(&quot;hcm.model.create&quot;, &#123;&quot;model&quot;: &quot;dynamic_log&quot;, &quot;info&quot;: log_entry&#125;) 获取模型数据报错时一个方法遇到一个项目是 CustomerUtil.call_open_api获取模型数据报错，使用ModelUtil就可以 1parfresult_list = ModelUtil.list(&quot;PerfResult&quot;, &#123;&quot;assess_card_id&quot;: cardids_list&#125;)","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"012-小技巧-0002","slug":"项目/HCM教程/012-2-小技巧-0002","date":"2025-05-08T12:55:00.000Z","updated":"2025-09-09T06:19:59.440Z","comments":true,"path":"2025/05/08/项目/HCM教程/012-2-小技巧-0002/","link":"","permalink":"https://dbbruce.github.io/2025/05/08/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/012-2-%E5%B0%8F%E6%8A%80%E5%B7%A7-0002/","excerpt":"新建多维度组织弹性模型 业务场景 客户在现有的行政维度管理基础上存在党派维度、工会维度的管理方式。 以工会维度为例：不同的工会被视作不同的部门，存在工会组长等岗位，每个工会中存在的人员信息有别于行政维度下部门人员信息。需要支持对不同维度部门的查看功能，以及不同维度下人员管理、查询、统计功能。","text":"新建多维度组织弹性模型 业务场景 客户在现有的行政维度管理基础上存在党派维度、工会维度的管理方式。 以工会维度为例：不同的工会被视作不同的部门，存在工会组长等岗位，每个工会中存在的人员信息有别于行政维度下部门人员信息。需要支持对不同维度部门的查看功能，以及不同维度下人员管理、查询、统计功能。 干审表：继承 appointment_dismissal_basic_info ， 类型： 其他消息模板-保存 分析报表冻结分析报表-高级设置中 123456789101112131415161718192021222324252627282930313233343536&#123; &quot;data&quot;: [&#123; &quot;key&quot;: &quot;main&quot;, &quot;name&quot;: &quot;main&quot;, &quot;class&quot;: &quot;formula&quot;, &quot;source&quot;: &quot;DYNAMIC(&#x27;SalaryInfoManage&#x27;,month=CURR_MONTH, page_index=PAGE_INDEX, page_size=PAGE_SIZE)&quot;, &quot;page_count&quot;: true &#125;], &quot;filter&quot;: [&#123; &quot;key&quot;: &quot;CURR_MONTH&quot;, &quot;label&quot;: &quot;月份&quot;, &quot;options&quot;: &#123; &quot;hover&quot;: false, &quot;query&quot;: true, &quot;format&quot;: &quot;yyyy-MM&quot;, &quot;default&quot;: true, &quot;disabled&quot;: false, &quot;required&quot;: true, &quot;form_mode&quot;: null, &quot;inputLock&quot;: true, &quot;singleLine&quot;: true, &quot;placeholder&quot;: &quot;report_filter_month&quot;, &quot;no_trans_query&quot;: true &#125;, &quot;component&quot;: &quot;hc-input-datetime&quot; &#125;], &quot;paging&quot;: true, &quot;immediately&quot;: true, &quot;rect_formula&quot;: &#123; &quot;formula&quot;: [] &#125;, &quot;freeze_setting&quot;: &#123; &quot;freeze_cell&quot;: &quot;A1&quot; &#125;, &quot;auto_recalc_time&quot;: 60&#125; 分析报表-求和公式12[RANGE_SUM(&quot;D4&quot;,(0,-1))][RANGE_SUM(&#x27;B6&#x27;,(0,-1),default=0)] 表头的一些信息1234[&quot;天津社会保险缴费汇总（&quot;+S(CURR_MONTH[:4])+&quot;年&quot;+S(CURR_MONTH[5:7])+&quot;月）&quot;][&quot;制表日期：&quot;+NOW(formatter=&#x27;yyyy-mm-dd&#x27;)[:4]+&quot;年&quot;+NOW(formatter=&#x27;yyyy-mm-dd&#x27;)[5:7]+&quot;月&quot;+NOW(formatter=&#x27;yyyy-mm-dd&#x27;)[8:]+&quot;日&quot;][F(VLOOKSTAT(main,&quot;&quot;,&quot;sum&quot;,&quot;n_field9&quot;),2)][VLOOKSTAT(main,&quot;&quot;,&quot;sum&quot;,&quot;n_field9&quot;)+VLOOKSTAT(main2,&quot;&quot;,&quot;sum&quot;,&quot;n_field9&quot;)] 公式日志123薪酬公式，报表公式，干审表公式都可以用 - LOGGING_INFO(first_edu_list)LOGGING_INFO(输入日志信息&quot;) 查看日志地址: /#/common_model_list?model=hcm_flex_log_data.formula_log 字段讲解 fields 字段 描述 实例 fieldFunc 动态拼装字段 “fieldFunc”: “&#x3D;function(_row,col,value){return value;}” func 点击事件 “func”: “&#x3D;function(_row,_col){return SCOPE.empDateClick(_row,_col)}”, 套打支持上传html文件 服务器设置 - 只允许附件上传的白名单, 多个文件名之间使用英文逗号分隔,添加规则如下:jpg,jpeg) 1db,xlsx,html,jpeg,docx 套打管理 - 套打管理 - 元数据配置 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455&quot;actions&quot; : [ &#123; &quot;key&quot;: &quot;new&quot;, &quot;label&quot;: &quot;模版上传&quot;, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;check_node_item&quot;, &quot;func&quot;: &quot;=function()&#123;if(!SCOPE.tree_model.selectedNode.id)&#123;SCOPE.show_warning(&#x27;请选择节点&#x27;);return;&#125;&#125;&quot; &#125;, &#123; &quot;key&quot;: &quot;upload_file&quot;, &quot;action&quot;: &quot;UPLOAD_FILE&quot;, &quot;options&quot;: &#123; &quot;params&quot;: &#123; &quot;ignore_convert&quot;: true &#125;, &quot;file_type&quot;: [ &quot;docx&quot;, &quot;xlsx&quot;, &quot;lrmx&quot;, &quot;html&quot; ], &quot;size&quot;: 10, &quot;url&quot;: &quot;/document/savedocumentprintbill&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;create_info&quot;, &quot;action&quot;: &quot;CALL_API&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;hcm.model.create&quot;, &quot;params&quot;: &#123; &quot;model&quot;: &quot;PrintBillTemplate&quot;, &quot;info&quot;: &#123; &quot;doc_index&quot;: &quot;expression[GET(RES(&#x27;upload_file&#x27;),[&#x27;index&#x27;])]&quot;, &quot;template_name&quot;: &quot;expression[GET(RES(&#x27;upload_file&#x27;),[&#x27;name&#x27;])]&quot;, &quot;dept_id&quot;: &quot;expression[GET(FILTER_DICT(),[&#x27;tree_node_id&#x27;])]&quot;, &quot;bill_id&quot;: &quot;expression[GET(FILTER_DICT(),[&#x27;bill_id&#x27;])]&quot;, &quot;description&quot;: &quot;expression[GET(STR_SPLIT(GET(RES(&#x27;upload_file&#x27;),[&#x27;index&#x27;]), &#x27;.&#x27;),[-1])]&quot; &#125; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;refresh&quot;, &quot;action&quot;: &quot;REFRESH&quot; &#125; ], &quot;icon&quot;: &quot;icon-hcm-add-circle&quot;, &quot;is_important&quot;: true, &quot;default&quot;: true, &quot;type&quot;: &quot;selector&quot;, &quot;left&quot;: false &#125;] 读取文件内容 https://wiki.hcmcloud.cn/spaces/DEV/pages/149719077/1.%E9%99%84%E4%BB%B6%E6%93%8D%E4%BD%9C 1234_file_path = DocumentUtil.generate_file_path(index=&quot;auto_99c0f3f46f654666be45dfbd068f0341&quot;, file_type=&quot;html&quot;)return _file_pathwith open(_file_path, &quot;r&quot;) as f: return f.read() 文件下载 域名+&#x2F;document&#x2F;loadsourcedocument&#x2F;文件索引 文件操作 - DocumentUtilhttps://wiki.hcmcloud.cn/spaces/DEV/pages/149719077/1.%E9%99%84%E4%BB%B6%E6%93%8D%E4%BD%9C 指定每页数据条数12345&quot;list_config&quot;: &#123; &quot;paging&quot;: &#123; &quot;page_size&quot;: 2000 &#125;&#125; 报表 字典的配置： [DYNAMIC(‘SalaryInfoManage3’,emp_id&#x3D;EMPLOYEE_ID, smonth&#x3D;S_MONTH, emonth&#x3D;E_MONTH, page_index&#x3D;PAGE_INDEX, page_size&#x3D;PAGE_SIZE)]列表的配置： DYNAMIC(‘SalaryInfoManage3’,emp_id&#x3D;EMPLOYEE_ID, smonth&#x3D;S_MONTH, emonth&#x3D;E_MONTH, page_index&#x3D;PAGE_INDEX, page_size&#x3D;PAGE_SIZE) 报表公式 [list:main:{number}][GET_ROW(2)] 执行sql语句12http://20.24.9.85/api/wf.db.query&#123;&quot;command&quot;:&quot;SELECT * from company_meta_operate_log order by id desc limit 1;&quot;&#125; 模糊查询 is_blur: TrueCELL(-3,-2)1234[F(F(x=CELL(-14,0),y=2)+F(x=CELL(-13,0),y=2),2)]获取单元格值公式、常用于单元格之间运算:param x:行坐标左-右+，以当前格子为原点:param y:列坐标上-下+，以当前格子为原点 薪酬福利常用的模型 名称 model 薪酬档案 SalaryProfile 薪酬统计 SalaryResultData 全局标准表 SalaryStandardDataGlobal 福利档案 SocialProfile 福利计算 SocialBalance 个税计算 TaxReturnData 封存、解封表 SalaryDataStatus ModelUtil 查询模型数据注意：必须用双引号，单引号报错 1result_list = ModelUtil.list(model=&quot;PerfResult&quot;,filter_dict=&#123;&quot;assess_card_id&quot;: cardids_list&#125;, extra_property=&#123;&quot;state&quot;: &quot;emp&quot;,&quot;fields&quot;:[&#123;&quot;field&quot;:[&quot;id&quot;]&#125;,&#123;&quot;field&quot;:[&quot;assess_cycle&quot;]&#125;,&#123;&quot;field&quot;:[&quot;level&quot;]&#125;]&#125;)","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"012-小技巧-0001","slug":"项目/HCM教程/012-1-小技巧-0001","date":"2025-05-08T12:50:25.000Z","updated":"2025-09-09T06:19:59.522Z","comments":true,"path":"2025/05/08/项目/HCM教程/012-1-小技巧-0001/","link":"","permalink":"https://dbbruce.github.io/2025/05/08/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/012-1-%E5%B0%8F%E6%8A%80%E5%B7%A7-0001/","excerpt":"请求产生解密 浏览器控制台1hcm_transfer_strategy=&#x27;no&#x27; 分析报表，发布后就不能看设计，使用setup，可以直接查看设计 url上加，【&#x2F;setup】","text":"请求产生解密 浏览器控制台1hcm_transfer_strategy=&#x27;no&#x27; 分析报表，发布后就不能看设计，使用setup，可以直接查看设计 url上加，【&#x2F;setup】 批量删除123456789&quot;actions&quot;: [ &#123; &quot;action&quot;: &quot;DELETE_BATCH&quot;, &quot;left&quot;: true, &quot;condition&quot;: &quot;MULTI_ITEM&quot;, &quot;key&quot;: &quot;delete_batch&quot;, &quot;label&quot;: &quot;批量删除&quot; &#125;] 按钮调用云函数 - OPEN_WEBSOCKET - action链12345678910111213141516171819202122232425262728293031323334353637383940414243&quot;actions&quot;: [ &#123; &quot;label&quot;: &quot;采集数据-外部&quot;, &quot;hide&quot;: false, &quot;key&quot;: &quot;generate_datas_report&quot;, &quot;roles&quot;: [ &quot;cm-salary&quot; ], &quot;is_important&quot;: true, &quot;action&quot;: [ &#123; &quot;key&quot;: &quot;generate_data&quot;, &quot;label&quot;: &quot;采集数据&quot;, &quot;action&quot;: &quot;OPEN_WEBSOCKET&quot;, &quot;condition&quot;: &quot;ITEM&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;private.CollectReportReports&quot;, &quot;beginTip&quot;: &quot;开始处理&quot;, &quot;completeTip&quot;: &quot;已完成&quot;, &quot;processingTitle&quot;: &quot;正在启动中&quot;, &quot;completeTitle&quot;: &quot;启动完成&quot;, &quot;autoClose&quot;: true, &quot;closeWaiting&quot;: 500, &quot;params&quot;: &#123; &quot;filter_month&quot;: &quot;expression[GET(FILTER_DICT(),[&#x27;u_month&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;show_warning_all&quot;, &quot;action&quot;: &quot;SHOW_WARNING&quot;, &quot;entry_condition&quot;: &quot;expression[RES(&#x27;generate_data&#x27;)]&quot;, &quot;options&quot;: &#123; &quot;content&quot;: &quot;expression[GET(RES(&#x27;generate_data&#x27;),[&#x27;msg&#x27;])]&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;refresh&quot;, &quot;action&quot;: &quot;REFRESH&quot; &#125; ] &#125;] 云函数：CollectReportReports 1234567891011class CollectReportReportsRGCB(BasePrivateApiService): def execute(self, notify=None, **kwargs): def update_state(_obj): if notify: notify(_obj) update_state(dict(progress=10, message=&#x27;开始执行&#x27;)) # 逻辑代码 return &#123;&quot;success&quot;: True, &quot;msg&quot;: &#x27;采集成功&#x27;&#125; 按钮调用云函数 - function12345678&quot;actions&quot;: [ &#123; &quot;label&quot;: &quot;校验报告zip&quot;, &quot;condition&quot;: &quot;ITEM&quot;, &quot;key&quot;: &quot;dsb4&quot;, &quot;func&quot;: &quot;=function()&#123;debugger;dataService.callHcmOpenApi(&#x27;private.print_form_zip&#x27;, &#123;&#x27;month&#x27;:ITEM().month&#125;).then(function(data)&#123;if(data)&#123;WINDOW.open(WINDOW.hcm_wengen+\\&quot;/document/get_file_by_type?index=\\&quot;+data+\\&quot;&amp;type=zip&amp;file_name=校验报告.zip\\&quot;);&#125;&#125;)&#125;&quot; &#125;] 多级按钮 1234567891011121314151617181920212223242526272829&quot;actions&quot;: [ &#123; &quot;label&quot;: &quot;下载上报文件&quot;, &quot;key&quot;: &quot;Dsb&quot;, &quot;condition&quot;: &quot;ITEM&quot;, &quot;actions&quot;: [ &#123; &quot;label&quot;: &quot;单位信息统计表&quot;, &quot;key&quot;: &quot;dsb1&quot;, &quot;func&quot;: &quot;=function()&#123;debugger;dataService.callHcmOpenApi(&#x27;private.print_form1&#x27;, &#123;&#x27;month&#x27;:ITEM().month&#125;).then(function(data)&#123;if(data)&#123;WINDOW.open(WINDOW.hcm_wengen+\\&quot;/document/loadsourcedocument/\\&quot;+data+WINDOW.hcm_env_pre);&#125;&#125;)&#125;&quot; &#125;, &#123; &quot;label&quot;: &quot;人工成本情况统计表&quot;, &quot;key&quot;: &quot;dsb2&quot;, &quot;func&quot;: &quot;=function()&#123;debugger;dataService.callHcmOpenApi(&#x27;private.print_form2&#x27;, &#123;&#x27;month&#x27;:ITEM().month&#125;).then(function(data)&#123;if(data)&#123;WINDOW.open(WINDOW.hcm_wengen+\\&quot;/document/loadsourcedocument/\\&quot;+data+WINDOW.hcm_env_pre);&#125;&#125;)&#125;&quot; &#125;, &#123; &quot;label&quot;: &quot;企业职工收入情况统计表&quot;, &quot;key&quot;: &quot;dsb3&quot;, &quot;func&quot;: &quot;=function()&#123;debugger;dataService.callHcmOpenApi(&#x27;private.print_form3&#x27;, &#123;&#x27;month&#x27;:ITEM().month&#125;).then(function(data)&#123;if(data)&#123;WINDOW.open(WINDOW.hcm_wengen+\\&quot;/document/loadsourcedocument/\\&quot;+data+WINDOW.hcm_env_pre);&#125;&#125;)&#125;&quot; &#125;, &#123; &quot;label&quot;: &quot;上报文件zip&quot;, &quot;key&quot;: &quot;dsb4&quot;, &quot;func&quot;: &quot;=function()&#123;debugger;dataService.callHcmOpenApi(&#x27;private.print_form_zip&#x27;, &#123;&#x27;month&#x27;:ITEM().month&#125;).then(function(data)&#123;if(data)&#123;WINDOW.open(WINDOW.hcm_wengen+\\&quot;/document/get_file_by_type?index=\\&quot;+data+\\&quot;&amp;type=zip&amp;file_name=校验报告.zip\\&quot;);&#125;&#125;)&#125;&quot; &#125; ] &#125;] 新增一个应用 - 调休兑现台账 参数1234&#123; &quot;model&quot;: &quot;AttendanceProfileProgram&quot;, &quot;meta_state&quot;: &quot;leave_stand_compensatorydayoff&quot;&#125; 场景1common_model_tree_list 图形实例 先建一个仪表盘，后面需要时用其ID这个的ID，后面需要写到参数里，下面的9000其实应该使用23283 新增一个应用 启用应用 应用出现 按钮 对列表是多选还是单选 condition: 数据选择模式，可以是 “ITEM”（单选）或 “MULTI_ITEM”（多选） fuction 调用 云函数123456789function () &#123; return dataService.callHcmOpenApi(&#x27;private.select_model_return_number_name&#x27;, &#123; &#x27;id&#x27;: _model, &#x27;mname&#x27;: &#x27;common_basic_item_data.国资委-子企业所在行业&#x27; &#125;).then(function (data) &#123; debugger; return &#123;&#x27;list&#x27;: data&#125; &#125;)&#125; 薪酬上传时，创建薪酬档案，薪酬数据会先验证，需要加下面的语句，解决这个问题薪酬数据档案，上传时使用模型插件，档案不生效，必须使用下面的代码 1kwargs[&#x27;imp_class&#x27;].param[&#x27;employee_ids&#x27;].append(emp_dict.get(&#x27;id&#x27;, &#x27;&#x27;)) items在function的使用 ITEMS():窗体上过滤的数据123456789&quot;actions&quot;: [ &#123; &quot;key&quot;: &quot;Diff_Person_Percent_Table&quot;, &quot;label&quot;: &quot;同比上月&quot;, &quot;left&quot;: true, &quot;hide&quot;: false, &quot;func&quot;: &quot;=function()&#123;debugger;items=ITEMS();dataService.callHcmOpenApi(&#x27;private.Diff_Person_Percent_Table&#x27;, &#123;&#x27;items&#x27;:items[0],&#x27;month&#x27;:items[0].u_fill_month, &#x27;depart_id&#x27;:items[0].u_depart.id, &#x27;secondaryunit_code&#x27;:items[0].u_code &#125;)&#125;&quot; &#125;] 报表每次打开重新计算 分析报表-设置-高级设置 immediately 每次打开重新计算 auto_recalc_time 每次打开重新计算间隔时间12&quot;immediately&quot;: true, &quot;auto_recalc_time&quot;: 60 部门编码规则设置 查看当前编码 设置方式： 扩展管理 - 编码规则 - DepartmentNumberSerial - 规则配置 设置创建时自动生成: number_increment_rule ， type: create &#x2F; save , 注意：create有个问题，就是每次创建后，不保存也会占用 123456789101112131415161718192021222324252627&quot;fields&quot;: [ &#123; &quot;key&quot;: &quot;number&quot;, &quot;label&quot;: &quot;编号&quot;, &quot;component&quot;: &quot;hc-input&quot;, &quot;sequence&quot;: 20, &quot;options&quot;: &#123; &quot;data_type&quot;: &quot;string&quot;, &quot;required&quot;: false, &quot;width&quot;: &quot;col-6&quot;, &quot;singleLine&quot;: true, &quot;data_precision&quot;: null, &quot;hide&quot;: false, &quot;readOnly&quot;: false, &quot;placeholder&quot;: &quot;请输入编号&quot;, &quot;default&quot;: null, &quot;default_expression&quot;: null, &quot;tip&quot;: null, &quot;maxlength&quot;: 30, &quot;number_increment_rule&quot;: &#123; &quot;key&quot;: &quot;DepartmentNumberSerial&quot;, # 编码规则名称 &quot;type&quot;: &quot;create&quot; # 创建时间 只有 create / save 两种 &#125; &#125;, &quot;state&quot;: null &#125;]","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"011-action链","slug":"项目/HCM教程/011-action链","date":"2025-04-26T12:50:25.000Z","updated":"2025-09-01T02:05:40.830Z","comments":true,"path":"2025/04/26/项目/HCM教程/011-action链/","link":"","permalink":"https://dbbruce.github.io/2025/04/26/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/011-action%E9%93%BE/","excerpt":"action链一个按钮中配置多个方法","text":"action链一个按钮中配置多个方法 12345678910111213141516171819202122232425262728293031323334353637383940414243&quot;actions&quot;: [ &#123; &quot;label&quot;: &quot;采集数据-外部&quot;, &quot;hide&quot;: false, &quot;key&quot;: &quot;generate_datas_report&quot;, &quot;roles&quot;: [ &quot;cm-salary&quot; ], &quot;is_important&quot;: true, &quot;action&quot;: [ # 这里就是action链 &#123; &quot;key&quot;: &quot;generate_data&quot;, &quot;label&quot;: &quot;采集数据&quot;, &quot;action&quot;: &quot;OPEN_WEBSOCKET&quot;, &quot;condition&quot;: &quot;ITEM&quot;, &quot;options&quot;: &#123; &quot;api&quot;: &quot;private.CollectReportReports&quot;, &quot;beginTip&quot;: &quot;开始处理&quot;, &quot;completeTip&quot;: &quot;已完成&quot;, &quot;processingTitle&quot;: &quot;正在启动中&quot;, &quot;completeTitle&quot;: &quot;启动完成&quot;, &quot;autoClose&quot;: true, &quot;closeWaiting&quot;: 500, &quot;params&quot;: &#123; &quot;filter_month&quot;: &quot;expression[GET(FILTER_DICT(),[&#x27;u_month&#x27;])]&quot; &#125; &#125; &#125;, &#123; &quot;key&quot;: &quot;show_warning_all&quot;, &quot;action&quot;: &quot;SHOW_WARNING&quot;, &quot;entry_condition&quot;: &quot;expression[RES(&#x27;generate_data&#x27;)]&quot;, &quot;options&quot;: &#123; &quot;content&quot;: &quot;expression[GET(RES(&#x27;generate_data&#x27;),[&#x27;msg&#x27;])]&quot; &#125; &#125;, &#123; &quot;key&quot;: &quot;refresh&quot;, &quot;action&quot;: &quot;REFRESH&quot; &#125; ] &#125;]","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"010-配置按钮","slug":"项目/HCM教程/010-配置按钮","date":"2025-04-20T12:50:25.000Z","updated":"2025-09-09T06:19:59.451Z","comments":true,"path":"2025/04/20/项目/HCM教程/010-配置按钮/","link":"","permalink":"https://dbbruce.github.io/2025/04/20/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/010-%E9%85%8D%E7%BD%AE%E6%8C%89%E9%92%AE/","excerpt":"配置按钮","text":"配置按钮 123456789&quot;actions&quot;: [ &#123; &quot;key&quot;: &quot;Diff_Person_Percent_Table&quot;, &quot;label&quot;: &quot;同比上月&quot;, &quot;left&quot;: true, &quot;hide&quot;: false, &quot;func&quot;: &quot;=function()&#123;debugger;items=ITEMS();dataService.callHcmOpenApi(&#x27;private.Diff_Person_Percent_Table&#x27;, &#123;&#x27;items&#x27;:items[0],&#x27;month&#x27;:items[0].u_fill_month, &#x27;depart_id&#x27;:items[0].u_depart.id, &#x27;secondaryunit_code&#x27;:items[0].u_code &#125;)&#125;&quot; &#125;] 以下公式只在action链中使用，返回action链执行过程中的相关参数。通用表达式请点击查看 序号 公式 含义 范围 1 RES(‘key’) 根据传入的key值返回相应action的执行结果 RES(‘{被执行的action链最外层的key}_action’) 可获取到action的配置，一些简单action链参数控制可放在此处，然后action链取读取这里的参数。RES(‘clicked_field’) 在点击单元格触发的action中获取点击单元格对应列定义的方法 全部 2 SELECT_ITEM() 返回选中的数据。在单选模式下使用，返回的是单条数据。如果action是operate_row或operate_default，也要使用这个公式获取选中项 list 3 SELECT_ITEMS() 返回选中的数据。在多选模式下使用，返回的是数组 list 4 ENV() 返回环境变量， 可获取 filter_str, paging 等信息 全部 5 AUTH() 当前账号信息 全部 6 FILTER_DICT() 过滤条件 list 7 GET_LIST() 获取列表数据 list 8 FORM_DATA(‘key’) 获取表单上的具某个字段的值 info, view 9 FORMINFO() 获取完整的表单数据 info 10 TRANSLATE(key) 获取多语言key 全部 123&quot;month&quot;: &quot;expression[GET(FILTER_DICT(),[&#x27;month&#x27;]).replace(&#x27;-&#x27;, &#x27;&#x27;)]&quot;&quot;entry_condition&quot;: &quot;expression[EQ(RES(&#x27;type_&#x27;),false)]&quot;&quot;entry_condition&quot;: &quot;expression[RES(&#x27;generate_data&#x27;)]&quot;","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"008-分析报表分页","slug":"项目/HCM教程/008-分析报表分页","date":"2025-04-06T12:50:25.000Z","updated":"2025-09-09T06:19:59.455Z","comments":true,"path":"2025/04/06/项目/HCM教程/008-分析报表分页/","link":"","permalink":"https://dbbruce.github.io/2025/04/06/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/008-%E5%88%86%E6%9E%90%E6%8A%A5%E8%A1%A8%E5%88%86%E9%A1%B5/","excerpt":"分析报表分页1、数据源设置，选择 【分页】 page_index&#x3D;PAGE_INDEX, page_size&#x3D;PAGE_SIZE 这2个分页参数一定要传1DYNAMIC(&#x27;EmployeeCosts&#x27;,department_id=CURR_DEPARTMENT, start_month=START_MONTH, end_month=END_MONTH, page_index=PAGE_INDEX, page_size=PAGE_SIZE)","text":"分析报表分页1、数据源设置，选择 【分页】 page_index&#x3D;PAGE_INDEX, page_size&#x3D;PAGE_SIZE 这2个分页参数一定要传1DYNAMIC(&#x27;EmployeeCosts&#x27;,department_id=CURR_DEPARTMENT, start_month=START_MONTH, end_month=END_MONTH, page_index=PAGE_INDEX, page_size=PAGE_SIZE) 设置分页后，查看下【设置】 中 【paging:true】 2、修改云函数1234567891011121314151617181920212223class DynamicFunc(BaseFormulaObject): def do(self, param_one, param_two, page_index=None, page_size=None, _return=None): # 必须增加一个默认参数 _return=None # 界面定义中加了 paging:true 后，会默认增加两个参数到context中 PAGE_INDEX &amp; PAGE_SIZE page_index = page_index if page_index else self.context.get(&#x27;PAGE_INDEX&#x27;) page_size = page_size if page_size else self.context.get(&#x27;PAGE_SIZE&#x27;) # 对过滤条件的放到接口中获取数据 _list = self._filter(param_one, param_two) # 对_return 的情况进行返回 if _return == &#x27;all&#x27;: # 通过 过滤 参数 param_one 和 param_two 过滤后的数据 直接返回 return _list if _return == &#x27;count&#x27;: return len(_list) # 对page 参数要进行判断，如果界面没有paging:true控制, 通过context拿不到page参数。 且如果没有显性的传递page参数，没有办法分页 # 且这也是第三种 _return is None 的情况 page_index = page_index if page_index else 1 page_size = page_size if page_size else 20 return _list[(page_index - 1)*page_size:page_index*page_size] def _filter(self, *args, **kwargs): # 这个函数通过传入的条件进行过滤，返回具体的明细数据 return [] _return &#x3D;&#x3D; ‘all’ 这里的返回数据用于导出，返回全部的数据 _return &#x3D;&#x3D; ‘count’ 这里返回的为数据总量 3、模板1[list:main:&#123;col_0&#125;]","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"009-底层模型对应关系","slug":"项目/HCM教程/009-底层模型对应关系","date":"2025-04-06T12:50:25.000Z","updated":"2025-09-01T02:05:40.812Z","comments":true,"path":"2025/04/06/项目/HCM教程/009-底层模型对应关系/","link":"","permalink":"https://dbbruce.github.io/2025/04/06/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/009-%E5%BA%95%E5%B1%82%E6%A8%A1%E5%9E%8B%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB/","excerpt":"底层模型对应关系 底层模型 social_calculate_data SocialProfile salary_to_rpt_data SalaryRptObjDataToRpt","text":"底层模型对应关系 底层模型 social_calculate_data SocialProfile salary_to_rpt_data SalaryRptObjDataToRpt","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"005-分析报表","slug":"项目/HCM教程/005-分析报表","date":"2025-04-03T12:50:25.000Z","updated":"2025-09-09T06:19:59.306Z","comments":true,"path":"2025/04/03/项目/HCM教程/005-分析报表/","link":"","permalink":"https://dbbruce.github.io/2025/04/03/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/005-%E5%88%86%E6%9E%90%E6%8A%A5%E8%A1%A8/","excerpt":"分析报表新增一个报表公式 云函数 → 报表公式","text":"分析报表新增一个报表公式 云函数 → 报表公式 FlexFormula_BranchSalaryDetailedReportCMB123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219class DynamicFunctionReport(BaseFormulaObject): &quot;&quot;&quot; 报表云函数 &quot;&quot;&quot; # 统计字段列表 STATISTICS_FIELD_LIST = [ &quot;n_field1&quot;, #基本工资 &quot;n_field2&quot;, #岗位工资 &quot;n_field3&quot;, #绩效工资 &quot;n_field4&quot;, #绩效调整 &quot;n_field5&quot;, #补发工资 &quot;n_field6&quot;, #内退生活补助 &quot;n_field7&quot;, #内退退休住房补贴 &quot;n_field8&quot;, #岗位工资2 &quot;n_field13&quot;, #驻外补贴 &quot;n_field15&quot;, #午餐费 &quot;n_field20&quot;, #通讯补贴 &quot;n_field24&quot;, #通道类奖励 &quot;n_field25&quot;, #投顾签约奖励_线上 &quot;n_field26&quot;, #投顾签约奖励_线下 &quot;n_field27&quot;, #金融产品销售业务专项营销奖励 &quot;n_field31&quot;, #经纪业务季度奖 &quot;n_field32&quot;, #财富顾问调整项 &quot;n_field35&quot;, #缺勤扣款 &quot;salary_count&quot;, #应发工资 &quot;n_field37&quot;, #公司垫付 &quot;n_field38&quot;, #覆盖险金员工交回 &quot;n_field39&quot;, #独生子女费 &quot;n_field40&quot;, #风险金发放 &quot;n_field41&quot;, #风险金扣留 &quot;n_field42&quot;, #养老保险个人缴纳 &quot;n_field43&quot;, #医疗保险个人缴纳 &quot;n_field44&quot;, #失业保险个人缴纳 &quot;n_field45&quot;, #大病险个人缴纳 &quot;n_field46&quot;, #公积金个人缴存 &quot;tax_data_current&quot;, #个人所得税 &quot;n_field47&quot;, #其他扣款(税后) &quot;n_field49&quot;, #工会费 &quot;salary_real &quot; #实发工资 ] # 模型关联关系 MODEL_RELATION = &#123; &quot;relations&quot;: [ &#123; &quot;filter&quot;: &#123; &quot;job_info.employee_id&quot;: &quot;:employee_id&quot;, &quot;job_info.position_type&quot;: 1, &quot;job_info.begin_date&quot;: &#123; &quot;lte&quot;: &quot;=date_&quot; &#125;, &quot;job_info.end_date&quot;: &#123; &quot;gt&quot;: &quot;=date_&quot; &#125; &#125;, &quot;model&quot;: &quot;JobInformation&quot;, &quot;key&quot;: &quot;job_info&quot; &#125;, &#123; &quot;filter&quot;: &#123; &quot;salary_profile.employee_id&quot;: &quot;:employee_id&quot;, &quot;salary_profile.program_id&quot;: &quot;:program_id&quot; &#125;, &quot;model&quot;: &quot;SalaryProfile&quot;, &quot;key&quot;: &quot;salary_profile&quot; &#125;, &#123; &quot;filter&quot;: &#123; &quot;job_info.position_id&quot;: &quot;:position.origin_id&quot;, &quot;position.begin_date&quot;: &#123; &quot;lte&quot;: &quot;=date_&quot; &#125;, &quot;position.end_date&quot;: &#123; &quot;gt&quot;: &quot;=date_&quot; &#125; &#125;, &quot;model&quot;: &quot;OrgPositionHistory&quot;, &quot;type&quot;: &quot;outer&quot;, &quot;key&quot;: &quot;position&quot; &#125;, &#123; &quot;filter&quot;: &#123; &quot;position.parent_id&quot;: &quot;:department.origin_id&quot;, &quot;department.begin_date&quot;: &#123; &quot;lte&quot;: &quot;=date_&quot; &#125;, &quot;department.end_date&quot;: &#123; &quot;gt&quot;: &quot;=date_&quot; &#125; &#125;, &quot;model&quot;: &quot;OrgDepartmentHistory&quot;, &quot;type&quot;: &quot;outer&quot;, &quot;key&quot;: &quot;department&quot; &#125;, &#123; &quot;filter&quot;: &#123; &quot;department.subordinate_unit_id&quot;: &quot;:unit.origin_id&quot;, &quot;unit.begin_date&quot;: &#123; &quot;lte&quot;: &quot;=date_&quot; &#125;, &quot;unit.end_date&quot;: &#123; &quot;gt&quot;: &quot;=date_&quot; &#125; &#125;, &quot;model&quot;: &quot;OrgUnitHistory&quot;, &quot;type&quot;: &quot;outer&quot;, &quot;key&quot;: &quot;unit&quot; &#125;, &#123; &quot;filter&quot;: &#123; &quot;position.parent_id&quot;: &quot;:department_level.department_id&quot;, &quot;department_level.begin_date&quot;: &#123; &quot;lte&quot;: &quot;=date_&quot; &#125;, &quot;department_level.end_date&quot;: &#123; &quot;gt&quot;: &quot;=date_&quot; &#125; &#125;, &quot;model&quot;: &quot;DepartmentHierarchy&quot;, &quot;type&quot;: &quot;outer&quot;, &quot;key&quot;: &quot;department_level&quot; &#125; ] &#125; def get_department_name(self, depart_id): &#x27;&#x27;&#x27; 获取部门名称 &#x27;&#x27;&#x27; department_list = CustomerUtil.call_open_api(&quot;hcm.model.list&quot;, &#123; &quot;model&quot;: &quot;DepartmentHierarchy&quot;, &quot;filter_dict&quot;: &#123; &quot;department_id&quot;: depart_id &#125;, &quot;extra_property&quot;: &#123; &quot;fields&quot;: [ &#123; &quot;field&quot;: [ &quot;l2.name&quot; ], &quot;key&quot;: &quot;l2.name&quot; &#125; ] &#125; &#125; )[&quot;list&quot;] # 把部门名称取出来 department_name = &#x27;&#x27; if department_list: department_name = department_list[0].get(&#x27;l2&#x27;).get(&#x27;name&#x27;) if department_list[0].get(&#x27;l2&#x27;) else &#x27;&#x27; return department_name def get_salary_statistics(self, month): &#x27;&#x27;&#x27; 统计薪酬数据 params: month 统计年月 u_jingjitiaoxian： &#x27;&#x27;&#x27; salary_statistics_list = CustomerUtil.call_open_api(&quot;hcm.model.count&quot;, &#123; &quot;page_size&quot;: 99999999, &quot;sum_by&quot;: self.STATISTICS_FIELD_LIST, &quot;group_by&quot;: [ &quot;department_level.l2_id&quot; ], &quot;model&quot;: &quot;SalaryResultData&quot;, &quot;filter_dict&quot;: &#123; &quot;depart_id&quot;: &#123; &quot;child_include&quot;: 18395747 # 分支机构 &#125;, &quot;month&quot;: month, &quot;salary_b.name&quot;: &#123; &quot;like&quot;: &quot;招商银行&quot; &#125; &#125;, &quot;extra_property&quot;: self.MODEL_RELATION &#125; )[&quot;list&quot;] self.log(salary_statistics_list) # 根据部门ID，替换部门名称 for s_dict in salary_statistics_list: self.log(f&#x27;s_dict-&#123;s_dict&#125;&#x27;) depart_id = s_dict.get(&#x27;department_level.l2_id&#x27;) self.log(f&#x27;depart_id1-&#123;depart_id&#125;&#x27;) # depart_id = 18395731 department_name = self.get_department_name(depart_id) self.log(f&#x27;dept_name-&#123;department_name&#125;&#x27;) s_dict[&#x27;department_name&#x27;] = department_name return salary_statistics_list def do(self, month): # 引入日志 try: # 3级部门统计 l2_salary_statistics_list = self.get_salary_statistics(month) return l2_salary_statistics_list except Exception as e: self.log(traceback.format_exc()) raise e def log(self, log_content): log_info = &#123; &quot;log_type&quot;: str(&#x27;FlexFormula_BranchSalaryDetailedReportCMB&#x27;), &quot;create_time&quot;: datetime.datetime.now().strftime(&#x27;%Y-%m-%d %H:%M:%S&#x27;), &quot;content&quot;: str(log_content) &#125; CustomerUtil.call_open_api(&quot;hcm.model.create&quot;, &#123;&quot;model&quot;: &quot;dynamic_log&quot;, &quot;info&quot;: log_info&#125;) 结果1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071[ &#123; &#x27;sum__n_field46&#x27;: 17745.0, &#x27;sum__n_field41&#x27;: 0.0, &#x27;sum__n_field25&#x27;: 0.0, &#x27;sum__n_field20&#x27;: 0.0, &#x27;sum__n_field5&#x27;: 0.0, &#x27;sum__n_field44&#x27;: 744.49, &#x27;sum__n_field49&#x27;: 174.0, &#x27;sum__n_field3&#x27;: 0.0, &#x27;sum__n_field4&#x27;: 0.0, &#x27;sum__n_field13&#x27;: 0.0, &#x27;sum__n_field26&#x27;: 0.0, &#x27;sum__n_field27&#x27;: 0.0, &#x27;sum__n_field35&#x27;: 67.59, &#x27;sum__salary_count&#x27;: 161014.16, &#x27;sum__n_field15&#x27;: 0.0, &#x27;sum__n_field47&#x27;: 0.0, &#x27;sum__n_field40&#x27;: 0.0, &#x27;sum__n_field32&#x27;: 0.0, &#x27;sum__tax_data_current&#x27;: None, &#x27;sum__n_field42&#x27;: 11910.16, &#x27;sum__n_field37&#x27;: 0.0, &#x27;sum__n_field6&#x27;: 26100.0, &#x27;sum__n_field45&#x27;: 609.0, &#x27;sum__n_field8&#x27;: 0.0, &#x27;sum__n_field43&#x27;: 2977.54, &#x27;sum__n_field31&#x27;: 0.0, &#x27;sum__n_field39&#x27;: 0.0, &#x27;sum__n_field7&#x27;: 31860.0, &#x27;sum__n_field1&#x27;: 102925.0, &#x27;sum__n_field2&#x27;: 0.0, &#x27;sum__n_field24&#x27;: 196.75, &#x27;sum__salary_real&#x27;: None, &#x27;sum__n_field38&#x27;: 0.0, &#x27;department_level.l2_id&#x27;: 18395998, &#x27;n_field46&#x27;: 17745.0, &#x27;n_field41&#x27;: 0.0, &#x27;n_field25&#x27;: 0.0, &#x27;n_field20&#x27;: 0.0, &#x27;n_field5&#x27;: 0.0, &#x27;n_field44&#x27;: 744.49, &#x27;n_field49&#x27;: 174.0, &#x27;n_field3&#x27;: 0.0, &#x27;n_field4&#x27;: 0.0, &#x27;n_field13&#x27;: 0.0, &#x27;n_field26&#x27;: 0.0, &#x27;n_field27&#x27;: 0.0, &#x27;n_field35&#x27;: 67.59, &#x27;salary_count&#x27;: 161014.16, &#x27;n_field15&#x27;: 0.0, &#x27;n_field47&#x27;: 0.0, &#x27;n_field40&#x27;: 0.0, &#x27;n_field32&#x27;: 0.0, &#x27;tax_data_current&#x27;: None, &#x27;n_field42&#x27;: 11910.16, &#x27;n_field37&#x27;: 0.0, &#x27;n_field6&#x27;: 26100.0, &#x27;n_field45&#x27;: 609.0, &#x27;n_field8&#x27;: 0.0, &#x27;n_field43&#x27;: 2977.54, &#x27;n_field31&#x27;: 0.0, &#x27;n_field39&#x27;: 0.0, &#x27;n_field7&#x27;: 31860.0, &#x27;n_field1&#x27;: 102925.0, &#x27;n_field2&#x27;: 0.0, &#x27;n_field24&#x27;: 196.75, &#x27;salary_real&#x27;: None, &#x27;n_field38&#x27;: 0.0 &#125;] 配置分析报表 创建分析报表 上传模板 配置过滤条件 过滤条件，配置后显示 配置数据源 DYNAMIC(‘云函数名’,参数key&#x3D;参数value) 配置模板数据 列表：[LIST:main:{department_name}]列表里n_field1的值：{n_field1}统计：从B4开始统计，到最后，[RANGE_SUM(“B4”,(0,-1))]获取部门名称：DEPART_NAME(CURR_DEPARTMENT) 多条数据合并：&gt;{number} &#x2F; &gt;{name}","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"006-after_func","slug":"项目/HCM教程/006-after_func","date":"2025-04-03T12:50:25.000Z","updated":"2025-09-09T06:19:59.403Z","comments":true,"path":"2025/04/03/项目/HCM教程/006-after_func/","link":"","permalink":"https://dbbruce.github.io/2025/04/03/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/006-after_func/","excerpt":"after_func按钮动作完成后执行的函数 https://wiki.hcmcloud.cn/spaces/paas/pages/175867473/actions通用基础配置","text":"after_func按钮动作完成后执行的函数 https://wiki.hcmcloud.cn/spaces/paas/pages/175867473/actions通用基础配置 123456789101112131415161718192021222324252627&quot;actions&quot;: [ &#123; &quot;key&quot;: &quot;seal_data&quot;, &quot;label&quot;: &quot;封存&quot;, &quot;action&quot;: &quot;CUSTOM_ACTION&quot;, &quot;confirm&quot;: true, &quot;confirm_tip&quot;: &quot;即将对福利数据进行封存操作，请确认是否封存&quot;, &quot;api&quot;: &quot;social.data.seal.unseal.data&quot;, &quot;params&quot;: &quot;=function()&#123;_filter_dict=SCOPE.getAllFilterDict();model=SCOPE.advance_query.model;_filter_dict[&#x27;program_id&#x27;]=parseInt(model.split(&#x27;.+&#x27;)[1]);return &#123;filter_dict: _filter_dict,filter_str: SCOPE.getFilterStr(),status: 1,employee_ids: SCOPE.list_model.selected_items.length &gt; 0 ? SCOPE.list_model.selected_items.map(i =&gt; i.employee_id) : null, extra_property: SCOPE.getExtraProperty()&#125;&#125;&quot;, &quot;result_tip&quot;: true, &quot;hide&quot;: &quot;=function()&#123;if(JSON.parse(STATE.params.custom_params).flag_state==&#x27;work_flow&#x27;)&#123;return true;&#125;else&#123;return false&#125;&#125;&quot;, &quot;after_func&quot;: &quot;=function()&#123;debugger;SCOPE.parseAction(SCOPE.list_btn_meta.find(i=&gt;i.key===&#x27;welfare_approval&#x27;))&#125;&quot; &#125;, &#123; &quot;key&quot;: &quot;welfare_approval&quot;, &quot;label&quot;: &quot;福利审批&quot;, &quot;left&quot;: true, &quot;is_important&quot;: true, &quot;icon&quot;: &quot;icon-hcm-add-circle&quot;, &quot;action&quot;: &quot;WORKFLOW_CREATE&quot;, &quot;command&quot;: &quot;workflow_Create&quot;, &quot;hide&quot;: true, &quot;params&quot;: &quot;=function()&#123;debugger;var s1 = SCOPE.customEnvironmentParams[&#x27;program_id&#x27;];var s2=SCOPE.advance_query.filter_dict.month ;return &#123;&#x27;business_number&#x27;:&#x27;welfare_sealing&#x27;,go_option:&#123;&#x27;module_type&#x27;:&#x27;page&#x27;&#125;,&#x27;form_data&#x27;: &#123;&#x27;program_id&#x27;: SCOPE.customEnvironmentParams[&#x27;program_id&#x27;], &#x27;month&#x27;: SCOPE.advance_query.filter_dict.month&#125;&#125;&#125;&quot; &#125;]","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"007-跳转配置方式","slug":"项目/HCM教程/007-跳转配置方式","date":"2025-04-03T12:50:25.000Z","updated":"2025-09-09T06:19:59.276Z","comments":true,"path":"2025/04/03/项目/HCM教程/007-跳转配置方式/","link":"","permalink":"https://dbbruce.github.io/2025/04/03/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/007-%E8%B7%B3%E8%BD%AC%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F/","excerpt":"跳转配置方式点击页面上的连接跳转到另一个页面 渤XXXX证券项目：","text":"跳转配置方式点击页面上的连接跳转到另一个页面 渤XXXX证券项目： 配置跳转 wiki参考地址: https://wiki.hcmcloud.cn/spaces/DEV/pages/18416214/hc-sys-link组件 params (证券项目配置时，模型能带过去，月份参数带不过去)1234567891011121314151617181920212223242526&quot;fields&quot;: [ &#123; &quot;key&quot;: &quot;test_link&quot;, &quot;label&quot;: &quot;福利核算数据&quot;, &quot;component&quot;: &quot;hc-sys-link&quot;, &quot;options&quot;: &#123; &quot;target&quot;: [ &quot;pc&quot;, &quot;mobile&quot; ], &quot;force_assign&quot;: true, &quot;singleLine&quot;: true, &quot;data_type&quot;: &quot;link&quot;, &quot;default&quot;: &#123; &quot;state&quot;: &quot;common_model_list&quot;, &quot;params&quot;: &quot;=function()&#123;var program_id = SCOPE.base_form.data.program_id;return &#123;&#x27;model&#x27;:&#x27;social_calculate_data.&#x27;+program_id,&#x27;month&#x27;:SCOPE.base_form.data.month,&#x27;meta_state&#x27;:&#x27;social_result_new&#x27;&#125;&#125;&quot;, &quot;label&quot;: &quot;查看明细数据&quot; &#125;, &quot;required&quot;: false, &quot;default_expression&quot;: null, &quot;width&quot;: &quot;col-6&quot;, &quot;readOnly&quot;: false, &quot;data_precision&quot;: 0 &#125; &#125; ], url12345678910111213141516171819202122&quot;fields&quot;: [ &#123; &quot;key&quot;: &quot;test_link&quot;, &quot;label&quot;: &quot;福利核算数据&quot;, &quot;component&quot;: &quot;hc-sys-link&quot;, &quot;options&quot;: &#123; &quot;target&quot;: [&quot;pc&quot;, &quot;mobile&quot;], &quot;force_assign&quot;: true, &quot;singleLine&quot;: true, &quot;data_type&quot;: &quot;link&quot;, &quot;default&quot;: &#123; &quot;url&quot;: &quot;=function()&#123;debugger;var program_id = SCOPE.base_form.data.program_id;var cmonth=SCOPE.base_form.data.month; return &#x27;/#/common_model_list?model=social_calculate_data.&#x27;+program_id+&#x27;&amp;page_index=1&amp;page_size=20&amp;meta_state=social_result_new&amp;advance_filter_dict=%7B%22month%22:%22&#x27;+cmonth+&#x27;%22%7D&amp;show_fields_key=%5B%22month%22,%22depart_id%22%5D&#x27;&#125;&quot;, &quot;label&quot;: &quot;查看明细数据&quot; &#125;, &quot;required&quot;: false, &quot;default_expression&quot;: null, &quot;width&quot;: &quot;col-6&quot;, &quot;readOnly&quot;: false, &quot;data_precision&quot;: 0 &#125; &#125;], params使用super_go12345678params = function (item) &#123; SCOPE.super_go(&#x27;common_model_list&#x27;, &#123; &#x27;model&#x27;: &#x27;salary_assist_entry.&#x27; + item.assist_id, &#x27;advance_filter_dict&#x27;: &#123;&#x27;month&#x27;: SCOPE.advance_query.filter_dict.month&#125;, &#x27;meta_state&#x27;:&#x27;detail_&#x27;+item.assist_type+&#x27;_test&#x27;, &#x27;filter_dict&#x27;: &#123;&#x27;month&#x27;: SCOPE.advance_query.filter_dict.month, &#x27;assign_id&#x27;: item.id&#125; &#125;)&#125; 1SCOPE.super_go(&#x27;PrintToPreview&#x27;,&#123;&#x27;api_name&#x27;:&#x27;appoint.info.get.by.dynamic.method&#x27;,&#x27;api_param&#x27;:&#123;&#x27;employee_id&#x27;:SCOPE.origin_data.id,&#x27;dynamic_method&#x27;:&#x27;emp_info&#x27;,&#x27;extra_property&#x27;:&#123;&#125;&#125;,&#x27;bill_name&#x27;:&#x27;emp_info&#x27;,&#x27;docx&#x27;:true,&#x27;pdf&#x27;:true,&#x27;lrmx&#x27;:false,&#x27;dispaly_name&#x27;:SCOPE.origin_data.name&#125;) 按钮跳转 1234567891011&quot;action&quot;: [ &#123; &quot;key&quot;: &quot;check1&quot;, &quot;action&quot;: &quot;check1&quot;, &quot;label&quot;: &quot;查看确认单&quot;, &quot;func&quot;: &quot;=function(_item)&#123; return SCOPE.super_go(&#x27;common_model_list&#x27;,&#123;&#x27;model&#x27;:&#x27;ReportOrgInstance&#x27;, &#x27;meta_state&#x27;: &#x27;manage_collect&#x27;, &#x27;advance_filter_dict&#x27;:&#123;&#x27;month&#x27;:SCOPE.advance_query.filter_dict.u_month&#125;,&#x27;custom_params&#x27;:&#123;&#x27;month&#x27;:SCOPE.advance_query.filter_dict.month&#125;&#125;)&#125;&quot;, &quot;roles&quot;: [ &quot;cm-salary&quot; ] &#125;] URL跳转 12345678910111213141516171819202122232425&quot;fields&quot;: [ &#123; &quot;key&quot;: &quot;test_link&quot;, &quot;label&quot;: &quot;福利核算数据&quot;, &quot;component&quot;: &quot;hc-sys-link&quot;, &quot;options&quot;: &#123; &quot;target&quot;: [ &quot;pc&quot;, &quot;mobile&quot; ], &quot;force_assign&quot;: true, &quot;singleLine&quot;: true, &quot;data_type&quot;: &quot;link&quot;, &quot;default&quot;: &#123; &quot;url&quot;: &quot;=function()&#123;debugger;var program_id = SCOPE.base_form.data.program_id;var cmonth=SCOPE.base_form.data.month; return &#x27;/#/common_model_list?model=social_calculate_data.&#x27;+program_id+&#x27;&amp;page_index=1&amp;page_size=20&amp;meta_state=social_result_new&amp;advance_filter_dict=%7B%22month%22:%22&#x27;+cmonth+&#x27;%22%7D&amp;show_fields_key=%5B%22month%22,%22depart_id%22%5D&#x27;&#125;&quot;, &quot;label&quot;: &quot;查看明细数据&quot; &#125;, &quot;required&quot;: false, &quot;default_expression&quot;: null, &quot;width&quot;: &quot;col-6&quot;, &quot;readOnly&quot;: false, &quot;data_precision&quot;: 0 &#125; &#125;] onclick12345678910111213141516171819202122232425&#123; &quot;key&quot;: &quot;abroad_link&quot;, &quot;label&quot;: &quot;出国（境）审批流程&quot;, &quot;component&quot;: &quot;hc-sys-link&quot;, &quot;options&quot;: &#123; &quot;hide&quot;: false, &quot;target&quot;: [ &quot;pc&quot;, &quot;mobile&quot; ], &quot;force_assign&quot;: true, &quot;singleLine&quot;: true, &quot;data_type&quot;: &quot;link&quot;, &quot;default&quot;: &#123; &quot;label&quot;: &quot;查看流程明细&quot;, &quot;onClick&quot;: &quot;=function()&#123;dataService.callHcmOpenApi(&#x27;private.HeadSecDepartment&#x27;, &#123;&#x27;employee_id&#x27;: 7777&#125;).then(function(data)&#123;debugger;var inst_id=data.wf_inst_id;var business_id=23174;SCOPE.super_go(&#x27;workflow_bill_v3&#x27;,&#123;&#x27;wf_inst_id&#x27;:inst_id,&#x27;business_id&#x27;:business_id&#125;)&#125;)&#125;&quot; &#125;, &quot;required&quot;: false, &quot;default_expression&quot;: null, &quot;width&quot;: &quot;col-6&quot;, &quot;readOnly&quot;: false, &quot;data_precision&quot;: 0 &#125;, &quot;sequence&quot;: 240 &#125; state - 场景12345678910111213141516171819202122&#123; &quot;component&quot;: &quot;hc-sys-link&quot;, &quot;label&quot;: &quot;集团总部薪酬（员工）&quot;, &quot;key&quot;: &quot;test_link&quot;, &quot;options&quot;: &#123; &quot;target&quot;: [&quot;pc&quot;, &quot;mobile&quot;], &quot;force_assign&quot;: true, &quot;singleLine&quot;: true, &quot;hide&quot;: false, &quot;data_type&quot;: &quot;link&quot;, &quot;default&quot;: &#123; &quot;state&quot;: &quot;salary_data_view&quot;, &quot;params&quot;: &quot;=function()&#123;return &#123;program_id: SCOPE.base_form.data.salary_link.content.params.program_id, pay_program_id:SCOPE.base_form.data.salary_link.content.params.pay_program_id,provide_id: SCOPE.base_form.data.salary_link.content.params.provide_id,source_provide_id: SCOPE.base_form.data.salary_link.content.params.source_provide_id,flag_state: SCOPE.base_form.data.salary_link.content.params.provide_id? &#x27;provide_work_plat&#x27;: &#x27;&#x27;, depart_id:JSON.parse(SCOPE.base_form.data.salary_link.content.params.depart_id).length===1?JSON.parse(SCOPE.base_form.data.salary_link.content.params.depart_id)[0]:SCOPE.base_form.data.salary_link.content.params.depart_id, month:SCOPE.base_form.data.salary_link.content.params.month&#125;&#125;&quot;, &quot;label&quot;: &quot;查看明细数据&quot; &#125;, &quot;required&quot;: false, &quot;default_expression&quot;: null, &quot;width&quot;: &quot;col-6&quot;, &quot;readOnly&quot;: false, &quot;data_precision&quot;: 0 &#125; &#125; 跳转打开新页面与在原页面跳转 ,null,true)})}”, - 打开新页面 没有true -原页面跳转 12345678910111213141516171819202122232425&#123; &quot;key&quot;: &quot;abroad_link&quot;, &quot;label&quot;: &quot;出国（境）审批流程&quot;, &quot;component&quot;: &quot;hc-sys-link&quot;, &quot;options&quot;: &#123; &quot;hide&quot;: false, &quot;target&quot;: [ &quot;pc&quot;, &quot;mobile&quot; ], &quot;force_assign&quot;: false, &quot;singleLine&quot;: true, &quot;data_type&quot;: &quot;link&quot;, &quot;default&quot;: &#123; &quot;label&quot;: &quot;查看流程明细&quot; &#125;, &quot;onClick&quot;: &quot;=function()&#123;dataService.callHcmOpenApi(&#x27;private.HeadSecDepartment&#x27;, &#123;&#x27;employee_id&#x27;: SCOPE.employee.id,&#x27;start_date&#x27;:SCOPE.data.start_date,&#x27;end_date&#x27;:SCOPE.data.end_date&#125;).then(function(data)&#123;debugger;var business_id=data.business_id;SCOPE.super_go(&#x27;workflow_detail&#x27;,&#123;&#x27;role&#x27;:&#x27;all&#x27;,&#x27;business_id&#x27;:business_id,&#x27;version&#x27;:3,&#x27;filter_dict&#x27;: &#123;&#x27;employee_id&#x27;:SCOPE.employee.id,&#x27;exit_time&#x27;: &#123;&#x27;gte&#x27;:SCOPE.data.start_date,&#x27;lte&#x27;:SCOPE.data.end_date&#125;,&#125;&#125;,null,true)&#125;)&#125;&quot;, &quot;required&quot;: false, &quot;default_expression&quot;: null, &quot;width&quot;: &quot;col-6&quot;, &quot;readOnly&quot;: false, &quot;data_precision&quot;: 0 &#125;, &quot;sequence&quot;: 240&#125;","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"003-配置菜单","slug":"项目/HCM教程/003-配置菜单","date":"2025-04-02T12:50:25.000Z","updated":"2025-09-09T06:19:59.414Z","comments":true,"path":"2025/04/02/项目/HCM教程/003-配置菜单/","link":"","permalink":"https://dbbruce.github.io/2025/04/02/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/003-%E9%85%8D%E7%BD%AE%E8%8F%9C%E5%8D%95/","excerpt":"页面上加一个菜单系统设置 - 应用管理 - 自定义应用","text":"页面上加一个菜单系统设置 - 应用管理 - 自定义应用","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"004-薪酬公式","slug":"项目/HCM教程/004-薪酬公式","date":"2025-04-02T12:50:25.000Z","updated":"2025-09-09T06:19:59.313Z","comments":true,"path":"2025/04/02/项目/HCM教程/004-薪酬公式/","link":"","permalink":"https://dbbruce.github.io/2025/04/02/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/004-%E8%96%AA%E9%85%AC%E5%85%AC%E5%BC%8F/","excerpt":"薪酬公式薪酬福利 - 薪酬公式","text":"薪酬公式薪酬福利 - 薪酬公式 1、配置方法1DYNAMIC(&#x27;ComplementMiniWage&#x27;,&#x27;minimum_wage&#x27;) 2、函数系统设置 - 扩展管理 - 云函数管理 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437class BaseSalaryFormula(BaseSalaryFormulaObject): &quot;&quot;&quot; 薪酬公式云函数示例 &quot;&quot;&quot; def get_previous_month(self, year_month): &#x27;&#x27;&#x27; 获取上一个月的日期 params: year_month 年月 res: &#x27;2025-12&#x27; &#x27;&#x27;&#x27; year, month = map(int, year_month.split(&#x27;-&#x27;)) # 如果当前月是1月，则上个月是去年的12月 if month == 1: previous_year = year - 1 previous_month = 12 else: previous_year = year previous_month = month - 1 # 格式化为两位数的月份 previous_month_str = f&quot;&#123;previous_month:02d&#125;&quot; # 返回上个月的年月字符串 return f&quot;&#123;previous_year&#125;-&#123;previous_month_str&#125;&quot; def get_first_and_last_day(self, gyear, gmonth): &#x27;&#x27;&#x27; 获取指定年月，第一天和最后一天 params: gyear 年 params: gmonth 月 &#x27;&#x27;&#x27; gyear = int(gyear) gmonth= int(gmonth) # 获取该月的第一天 first_day = datetime.date(gyear, gmonth, 1) # 获取该月的天数 _, num_days = calendar.monthrange(gyear, gmonth) # 获取该月的最后一天 last_day = datetime.date(gyear, gmonth, num_days) return first_day, last_day def get_salary_calculate_data(self, month, js_employee_ids): &#x27;&#x27;&#x27; 获取薪酬数据 param: month 统计年月 2025-02 param: program_id 总部薪酬方案开发是ID为：21569，复用时注意这个ID &#x27;&#x27;&#x27; # 全员过滤 filter_dict= &#123; &quot;month&quot;: month, &quot;program_id&quot;: 21569 &#125; # 人员ID过滤 if js_employee_ids: filter_dict= &#123; &quot;month&quot;: month, &quot;program_id&quot;: 21569, &quot;employee_id&quot;: &#123; &quot;in&quot;: js_employee_ids &#125; &#125; record_list = ModelUtil.list( model= &quot;salary_calculate_data.&quot;, filter_dict= filter_dict, extra_property= &#123; &quot;state&quot;: &quot;salary_calculate&quot; &#125;, page_size=99999, page_index=1 ) return record_list def get_mini_wage_standard(self): &#x27;&#x27;&#x27; 获取城市最低工资标准 res：城市:最低标准 - &#123;&#x27;北京&#x27;:2000, &#x27;天津&#x27;:3000 &#125; &#x27;&#x27;&#x27; miniwage_dict = dict() miniwage_list = ModelUtil.list( model=&quot;U_Min_Wage&quot;, filter_dict=&#123;&#125;, # extra_property= &#123; # &quot;fields&quot;: [ # &#123;&quot;key&quot;: &quot;u_a&quot;, &quot;field&quot;: [&quot;u_a&quot;, &quot;name&quot;]&#125;, # &#123;&quot;key&quot;: &quot;u_wage&quot;, &quot;field&quot;: [&quot;u_wage&quot;]&#125; # ] # &#125;, page_size=99999, page_index=1 ) for mwage in miniwage_list: city_name = mwage.get(&#x27;u_a&#x27;, &#x27;&#x27;).get(&#x27;name&#x27;, &#x27;&#x27;) if mwage.get(&#x27;u_a&#x27;, &#x27;&#x27;) else &#x27;&#x27; m_wage = mwage.get(&#x27;u_wage&#x27;, &#x27;&#x27;) miniwage_dict[city_name] = m_wage return miniwage_dict def get_salary_pay_items(self): &#x27;&#x27;&#x27; 获取工资方案-应发项字典-判断条件: 是否计算补足=否+应发项=是 res: 应发项字典 &#123;&quot;项目编码值&quot;: &quot;增减项值&quot;, &quot;001&quot;:&quot;-1&quot;, ...&#125; 注意：增减项：&quot;0&quot;: &quot;辅助&quot;,&quot;1&quot;: &quot;增&quot;,&quot;-1&quot;: &quot;减&quot; &#x27;&#x27;&#x27; pay_item_dict = dict() salaryitems_list = CustomerUtil.call_open_api(&quot;hcm.model.list&quot;, &#123; &quot;model&quot;: &quot;SalaryProgramItem&quot;, &quot;filter_dict&quot;: &#123; &quot;program_id&quot;: 21569, &quot;is_pay&quot;: True, &quot;u_is_complement&quot;: False &#125;, &quot;page_index&quot;: 1, &quot;page_size&quot;: 9999, &quot;extra_property&quot;: &#123; &quot;fields&quot;: [ &#123; &quot;key&quot;: &quot;number&quot;, &quot;field&quot;: [ &quot;number&quot; ] &#125;, &#123; &quot;key&quot;: &quot;direction&quot;, &quot;field&quot;: [ &quot;direction&quot; ] &#125; ] &#125; &#125; )[&quot;list&quot;] # 格式化数据 for sitems in salaryitems_list: st_number = sitems.get(&#x27;number&#x27;, &#x27;&#x27;) st_direction = sitems.get(&#x27;direction&#x27;, &#x27;&#x27;) pay_item_dict[st_number] = st_direction return pay_item_dict def get_salary_remit_items(self): &#x27;&#x27;&#x27; 获取工资方案-代扣代缴项字典-判断条件: 代扣代缴=是 res: 应发项字典 &#123;&quot;项目编码值&quot;: &quot;增减项值&quot;, &quot;001&quot;:&quot;-1&quot;, ...&#125; 注意：增减项：&quot;0&quot;: &quot;辅助&quot;,&quot;1&quot;: &quot;增&quot;,&quot;-1&quot;: &quot;减&quot; &#x27;&#x27;&#x27; pay_remit_dict = dict() salaryitems_list = CustomerUtil.call_open_api(&quot;hcm.model.list&quot;, &#123; &quot;model&quot;: &quot;SalaryProgramItem&quot;, &quot;filter_dict&quot;: &#123; &quot;program_id&quot;: 21569, &quot;is_remit&quot;:True &#125;, &quot;page_index&quot;: 1, &quot;page_size&quot;: 9999, &quot;extra_property&quot;: &#123; &quot;fields&quot;: [ &#123; &quot;key&quot;: &quot;number&quot;, &quot;field&quot;: [ &quot;number&quot; ] &#125;, &#123; &quot;key&quot;: &quot;direction&quot;, &quot;field&quot;: [ &quot;direction&quot; ] &#125; ] &#125; &#125; )[&quot;list&quot;] # 格式化数据 for sitems in salaryitems_list: st_number = sitems.get(&#x27;number&#x27;, &#x27;&#x27;) st_direction = sitems.get(&#x27;direction&#x27;, &#x27;&#x27;) pay_remit_dict[st_number] = st_direction return pay_remit_dict def get_emp_workplace(self, eid): &#x27;&#x27;&#x27; 获取人员的工作地 param: 人员id 4656989 返回结果：天津 &#x27;&#x27;&#x27; emp_workplace = ModelUtil.get( model_=&quot;Employee&quot;, id_=eid, state=&quot;inside&quot; ) emp_name = emp_workplace.get(&#x27;name&#x27;) wk_city = emp_workplace.get(&#x27;u_work_c&#x27;).get(&#x27;name&#x27;) if emp_workplace.get(&#x27;u_work_c&#x27;) else &#x27;&#x27; return wk_city, emp_name def get_attendance_month_rdata(self,fdate, ldata, eid): &#x27;&#x27;&#x27; 获取考勤月报数据 param: fdate 月份首日 param: ldata 月份最后一天 &#x27;&#x27;&#x27; record_list = CustomerUtil.call_open_api(&quot;hcm.model.list&quot;, &#123; &quot;model&quot;: &quot;AttendResultStatistics&quot;, &quot;filter_dict&quot;: &#123; &quot;employee_id&quot;: eid, &quot;end_date&quot;: &#123; &quot;gt&quot;: fdate &#125;, &quot;begin_date&quot;: &#123; &quot;lte&quot;: ldata &#125; &#125;, &quot;extra_property&quot;:&#123; &quot;state&quot;: &quot;office&quot;, &#x27;role&#x27;:&quot;all&quot; &#125;, &quot;page_size&quot;: 1, &quot;page_index&quot;:1 &#125; )[&quot;list&quot;] record_dict = dict() if record_list: record_dict = record_list[0] return record_dict def sum_salary_items(self, value_data_dicts, salaryitems_dict): &quot;&quot;&quot; 根据工资项计算薪资总和 params: value_data_dicts 薪酬记录 params: salary_items 薪资项 &quot;&quot;&quot; cal_sum = 0 cal_sum_formula = &#x27;&#x27; for vdata in value_data_dicts: # 判断薪酬记录中薪酬项，是否在薪酬方案字典中 if vdata in salaryitems_dict: direction_str = salaryitems_dict.get(vdata) # 获取工资项值 # 兼容工资项没有值的情况 salary_details_value = 0 if value_data_dicts.get(vdata): salary_details_value = value_data_dicts.get(vdata).get(&#x27;value&#x27;) if salary_details_value: salary_details_value = float(salary_details_value) # &quot;0&quot;: &quot;辅助&quot;,&quot;1&quot;: &quot;增&quot;,&quot;-1&quot;: &quot;减&quot; if str(direction_str) == &#x27;-1&#x27;: cal_sum_str = f&#x27;-&#123;salary_details_value&#125;&#x27; if &#x27;--&#x27; in cal_sum_str: cal_sum += float(cal_sum_str.replace(&#x27;--&#x27;, &#x27;&#x27;)) else: cal_sum += float(cal_sum_str) cal_sum_formula += f&#x27;-&#123;salary_details_value&#125;&#x27; elif str(direction_str) == &#x27;1&#x27;: cal_sum += float(f&#x27;&#123;salary_details_value&#125;&#x27;) cal_sum_formula += f&#x27;+&#123;salary_details_value&#125;&#x27; return round(cal_sum,2), cal_sum_formula def execute_count(self, field_name, js_program_id, js_employee_ids, month): &#x27;&#x27;&#x27; 执行计算方法 params: program_id: 方案ID params: employee_ids: 人员ID params: month: 月份 &#x27;&#x27;&#x27; try: # 城市最低工资标准 miniwage_dict = self.get_mini_wage_standard() # self.log(f&#x27;城市最低工资标准-&#123;miniwage_dict&#125;&#x27;) # 薪酬项目-应发项目 salary_pay_dict = self.get_salary_pay_items() # self.log(f&#x27;薪酬项目-应发方案-&#123;salary_pay_dict&#125;&#x27;) # 薪酬项目-代扣代缴 salary_remit_dict = self.get_salary_remit_items() # self.log(f&#x27;薪酬项目-代扣代缴方案-&#123;salary_remit_dict&#125;&#x27;) # 薪酬数据 salary_lists = self.get_salary_calculate_data(month, js_employee_ids) # self.log(f&#x27;薪酬数据-&#123;len(salary_lists)&#125;-&#123;salary_lists&#125;&#x27;) edit_dict_list = list() for sdata in salary_lists: # 员工ID employee_id = sdata.get(&quot;employee_id&quot;) # 人员工作地 wk_city, emp_name = self.get_emp_workplace(employee_id) # self.log(f&#x27;人员-&#123;emp_name&#125;-id-&#123;employee_id&#125;-人员工作地:&#123;wk_city&#125;&#x27;) # 判断人员工作地 if not wk_city: # self.log(f&#x27;人员-&#123;emp_name&#125;-id-&#123;employee_id&#125;-没有工作地-工作城市-&#123;wk_city&#125;-不计算最低工资&#x27;) continue # 判断是否锁定 # js_locked = sdata.get(&#x27;balance&#x27;, &#x27;&#x27;).get(&#x27;is_locked&#x27;) # if str(js_locked) != &#x27;1&#x27;: # # self.log(f&#x27;人员-&#123;emp_name&#125;-id-&#123;employee_id&#125;-没有锁定-&#123;js_locked&#125;&#x27;) # continue # 城市最低工资 # 北京城市的最低工资有区别 xc_dept_name = sdata.get(&#x27;depart&#x27;, &#123;&#125;).get(&#x27;name&#x27;, &#x27;&#x27;) if xc_dept_name in [&#x27;北京大兴兴华大街证券营业部&#x27;, &#x27;北京西外大街证券营业部&#x27;]: emp_mini_wage = float(miniwage_dict.get(xc_dept_name)) if miniwage_dict.get(xc_dept_name) else 0 # self.log(f&#x27;人员-&#123;xc_dept_name&#125;-id-&#123;employee_id&#125;-最低工资:&#123;emp_mini_wage&#125;&#x27;) else: emp_mini_wage = float(miniwage_dict.get(wk_city)) if miniwage_dict.get(wk_city) else 0 # self.log(f&#x27;人员-&#123;emp_name&#125;-id-&#123;employee_id&#125;-最低工资:&#123;emp_mini_wage&#125;&#x27;) # 判断城市最低工资 if not emp_mini_wage: # self.log(f&#x27;人员-&#123;emp_name&#125;-id-&#123;employee_id&#125;-没有城市最低工资-城市最低补贴-&#123;emp_mini_wage&#125;-不计算最低工资&#x27;) continue # 薪酬记录 - data 包含各个薪酬项目，考勤时间 value_data_dicts = sdata.get(&#x27;data&#x27;, &#123;&#125;) # self.log(f&#x27;各个薪酬项目-&#123;value_data_dicts&#125;&#x27;) # 考勤数据 - 使用薪酬记录上的数据 #事假 sj_num = value_data_dicts.get(&#x27;057&#x27;, &#123;&#125;).get(&#x27;value&#x27;, 0) #旷工 kg_num = value_data_dicts.get(&#x27;060&#x27;, &#123;&#125;).get(&#x27;value&#x27;, 0) #病假 bj_num = value_data_dicts.get(&#x27;056&#x27;, &#123;&#125;).get(&#x27;value&#x27;, 0) #上月应出勤天数 ycq_num = value_data_dicts.get(&#x27;061&#x27;, &#123;&#125;).get(&#x27;value&#x27;, 0) # self.log(f&#x27;人员-&#123;emp_name&#125;-id-&#123;employee_id&#125;-事假:&#123;sj_num&#125;-旷工:&#123;kg_num&#125;-病假:&#123;bj_num&#125;-应出勤:&#123;ycq_num&#125;&#x27;) # 有事假或者旷工 if sj_num or kg_num: continue # 没有出勤天数 if not ycq_num: continue # 发薪地 # 北京/上海 总额=应付+代扣代缴计； # 其他地方 总额=应付 pay_sum , pay_sum_formula = self.sum_salary_items(value_data_dicts, salary_pay_dict) self.log(f&#x27;人员-&#123;emp_name&#125;-id-&#123;employee_id&#125;-应发公式:&#123;pay_sum&#125;:&#123;pay_sum_formula&#125;&#x27;) if wk_city in [&#x27;北京&#x27;, &#x27;上海&#x27;]: # 应付 + 代扣代缴 remit_sum , remit_sum_formula = self.sum_salary_items(value_data_dicts, salary_remit_dict) self.log(f&#x27;人员-&#123;emp_name&#125;-id-&#123;employee_id&#125;-代扣代缴公式:&#123;remit_sum&#125;:&#123;remit_sum_formula&#125;&#x27;) total_salary = pay_sum+remit_sum else: # 应付 total_salary = pay_sum # 格式下数据，保留2位小数 total_salary = round(total_salary, 2) # 判断合计是否为空 if not total_salary: # self.log(f&#x27;人员-&#123;emp_name&#125;-id-&#123;employee_id&#125;-合计为空:&#123;total_salary&#125;-不计算最低工资&#x27;) continue # 计算出需要补足的金额 # 病假的情况 if bj_num and field_name == &#x27;sick_pay&#x27;: # 拿最低工资/应出勤天数*（应出勤天数-病假天数）+最低工资*0.8/应出勤天数*病假天数 bjbj_pay = round(emp_mini_wage/ycq_num*(ycq_num-bj_num)+emp_mini_wage*0.8/ycq_num*bj_num, 2) self.log(f&#x27;人员-&#123;emp_name&#125;-id-&#123;employee_id&#125;-补足病假工资-计算公式: (&#123;emp_mini_wage&#125;/&#123;ycq_num&#125;*(&#123;ycq_num&#125;-&#123;bj_num&#125;)+&#123;emp_mini_wage&#125;*0.8/&#123;ycq_num&#125;*&#123;bj_num&#125;)=&#123;bjbj_pay&#125;-&#123;total_salary&#125;&#x27;) # 补足 bz_salary_valuel = bjbj_pay - total_salary elif not bj_num and field_name == &#x27;minimum_wage&#x27;: self.log(f&#x27;人员-&#123;emp_name&#125;-id-&#123;employee_id&#125;-补足最低工资-计算公式: &#123;emp_mini_wage&#125;-&#123;total_salary&#125;&#x27;) bz_salary_valuel = emp_mini_wage -total_salary else: continue if bz_salary_valuel &lt;= 0: bz_salary_valuel = &#x27;&#x27; edit_dict_list.append(&#123;&quot;employee_id&quot;:employee_id,&quot;bz_salary_valuel&quot;:bz_salary_valuel&#125;) return edit_dict_list except Exception as e: logging.info(traceback.format_exc()) raise e def execute(self, field): _cache_key = f&#x27;salary_complement_miniwage_&#123;field&#125;&#x27; # 缓存key值自定义唯一key值 _cache = self.executor.context.get(_cache_key) if _cache is None: #缓存为空计算 js_employee_ids = [_p.get(&#x27;employee_id&#x27;) for _p in self.context[&#x27;profile_list&#x27;]] month = self.context[&#x27;month&#x27;] js_program_id = self.context[&#x27;program_id&#x27;] count_num_list = self.execute_count(field, js_program_id, js_employee_ids, month) result = &#123;&#125; for item in count_num_list: result[item.get(&quot;employee_id&quot;)] = &#123; field: item.get(&quot;bz_salary_valuel&quot;) &#125; _cache = result self.executor.context[_cache_key] = _cache _result = _cache.get(self.context[&#x27;profile&#x27;][&#x27;employee_id&#x27;], &#123;&#125;).get(field, 0) or 0 return _result def log(self, log_content): log_info = &#123; &quot;log_type&quot;: str(&#x27;SalaryFormula_ComplementMiniWage&#x27;), &quot;create_time&quot;: datetime.datetime.now().strftime(&#x27;%Y-%m-%d %H:%M:%S&#x27;), &quot;content&quot;: str(log_content) &#125; CustomerUtil.call_open_api(&quot;hcm.model.create&quot;, &#123;&quot;model&quot;: &quot;dynamic_log&quot;, &quot;info&quot;: log_info&#125;)","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"002-定时任务","slug":"项目/HCM教程/002-定时任务","date":"2025-04-01T12:50:25.000Z","updated":"2025-09-09T06:19:59.546Z","comments":true,"path":"2025/04/01/项目/HCM教程/002-定时任务/","link":"","permalink":"https://dbbruce.github.io/2025/04/01/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/002-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/","excerpt":"定时任务系统设置 - 基本服务 - 定时任务管理 任务名称，会用于任务日志查询","text":"定时任务系统设置 - 基本服务 - 定时任务管理 任务名称，会用于任务日志查询 1、任务组件 https://wiki.hcmcloud.cn/spaces/paas/pages/175866041/03+%E5%AE%9A%E6%9C%9F%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86 12apps.task.task_background.execute_open_api_task 2、组件参数123456&#123; &quot;api_name&quot;: &quot;private.GetWeixinCheckInData&quot;, &quot;api_param&quot;: &#123; &quot;wx_sync_interval&quot;: &quot;month&quot; &#125;&#125; 3、执行计划(定时任务)每天凌晨3点20分执行 4、查看执行结果系统设置 - 基础服务 - 后台任务管理","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"001-下拉列表选项变动，输入框或者下拉表随着变化","slug":"项目/HCM教程/001-下拉列表选项变动，输入框或者下拉表随着变化","date":"2025-04-01T12:44:25.000Z","updated":"2025-09-09T06:19:59.301Z","comments":true,"path":"2025/04/01/项目/HCM教程/001-下拉列表选项变动，输入框或者下拉表随着变化/","link":"","permalink":"https://dbbruce.github.io/2025/04/01/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/001-%E4%B8%8B%E6%8B%89%E5%88%97%E8%A1%A8%E9%80%89%E9%A1%B9%E5%8F%98%E5%8A%A8%EF%BC%8C%E8%BE%93%E5%85%A5%E6%A1%86%E6%88%96%E8%80%85%E4%B8%8B%E6%8B%89%E8%A1%A8%E9%9A%8F%E7%9D%80%E5%8F%98%E5%8C%96/","excerpt":"下拉列表选项变动，输入框或者下拉表随着变化","text":"下拉列表选项变动，输入框或者下拉表随着变化 字段12345678910111213141516171819202122232425&quot;fields&quot;: [ &#123; &quot;key&quot;: &quot;attend_item_id&quot;, &quot;label&quot;: &quot;加班项目&quot;, &quot;component&quot;: &quot;hc-super-selector&quot;, &quot;sequence&quot;: 24, &quot;options&quot;: &#123; &quot;data_type&quot;: &quot;integer&quot;, &quot;required&quot;: true, &quot;width&quot;: &quot;col-6&quot;, &quot;singleLine&quot;: true, &quot;data_precision&quot;: null, &quot;hide&quot;: false, &quot;readOnly&quot;: false, &quot;placeholder&quot;: &quot;请输入加班项目&quot;, &quot;default&quot;: null, &quot;default_expression&quot;: null, &quot;tip&quot;: null, &quot;selectorModel&quot;: &quot;OvertimeItem&quot;, &quot;selectorFilter&quot;: &quot;=function()&#123;return &#123;&#x27;is_enable&#x27;: 1, &#x27;employee_id&#x27;: (FORM().data.employee_id&amp;&amp;FORM().data.employee_id.length)?FORM().data.employee_id[0]:SCOPE.auth.employee.id&#125;&#125;&quot;, &quot;selectorMapper&quot;: &quot;=function (id_) &#123;return Array.isArray(id_)?dataService.callHcmOpenApi(&#x27;hcm.model.list&#x27;, &#123;model: &#x27;OvertimeItem&#x27;, filter_dict: &#123;id: id_&#125;, page_index: 1, page_size: 50&#125;):dataService.callHcmOpenApi(&#x27;hcm.model.get&#x27;, Object.assign(&#123;model: &#x27;OvertimeItem&#x27;,id_: typeof (id_) === &#x27;object&#x27; ? id_.id : id_&#125;));&#125;&quot; &#125;, &quot;state&quot;: null &#125;,] form_relations 联动123456789101112131415161718192021222324252627282930313233343536&quot;form_relations&quot;: [ &#123; &quot;default&quot;: &#123; &quot;expression&quot;: &quot;API(&#x27;time.bill.get.default.apply.data&#x27;, &#123;&#x27;bill_type&#x27;: &#x27;overtime&#x27;&#125;)[&#x27;data&#x27;]&quot; &#125;, &quot;key&quot;: &quot;overtime_data&quot; &#125;, &#123; &quot;default&quot;: &#123; &quot;expression&quot;: &quot;overtime_data.get(&#x27;attend_item_id&#x27;)&quot; &#125;, &quot;value_onchange&quot;: [ &#123; &quot;expression&quot;: &quot;API(&#x27;time.bill.get.overtime.plan.duration.result&#x27;, &#123;&#x27;start_p&#x27;:start_time,&#x27;end_p&#x27;:end_time,&#x27;attend_item&#x27;:attend_item_id,&#x27;employee_id&#x27;:view_emp_id if view_emp_id else None,&#x27;shift_id&#x27;:shift_id if shift_id else None&#125;) if start_time and end_time and attend_item_id else &#123;&#125;&quot;, &quot;key&quot;: &quot;attend_item_result&quot; &#125;, &#123; &quot;expression&quot;: &quot;3 if attend_item_id==2171 else 8.5&quot;, &quot;key&quot;: &quot;accounting_len&quot; &#125;, &#123; &quot;expression&quot;: &quot;180 if attend_item_id==2171 else 510&quot;, &quot;key&quot;: &quot;plan_duration&quot; &#125;, &#123; &quot;key&quot;: &quot;change_to_leave&quot;, &quot;expression&quot;: &quot;MODELGET(&#x27;OvertimeItem&#x27;, id=attend_item_id, employee_id=employee_id[0]).change_to_leave if attend_item_id and employee_id else 0&quot; &#125;, &#123; &quot;key&quot;: &quot;work_overtime_period&quot;, &quot;expression&quot;: &quot;1 if attend_item_id==2171 else 2&quot; &#125; ], &quot;key&quot;: &quot;attend_item_id&quot; # 字段key &#125;,]","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"3月份","slug":"每月概要/2025/202503","date":"2025-03-28T10:08:28.000Z","updated":"2025-03-04T05:41:14.252Z","comments":true,"path":"2025/03/28/每月概要/2025/202503/","link":"","permalink":"https://dbbruce.github.io/2025/03/28/%E6%AF%8F%E6%9C%88%E6%A6%82%E8%A6%81/2025/202503/","excerpt":"代理ip的匿名度123透明：服务器知道使用了代理，也知道请求对应的真实ip匿名：知道使用了代理，不知道真实ip高匿：不知道使用了代理和真实IP","text":"代理ip的匿名度123透明：服务器知道使用了代理，也知道请求对应的真实ip匿名：知道使用了代理，不知道真实ip高匿：不知道使用了代理和真实IP","categories":[{"name":"每月概要","slug":"每月概要","permalink":"https://dbbruce.github.io/categories/%E6%AF%8F%E6%9C%88%E6%A6%82%E8%A6%81/"},{"name":"2025","slug":"每月概要/2025","permalink":"https://dbbruce.github.io/categories/%E6%AF%8F%E6%9C%88%E6%A6%82%E8%A6%81/2025/"}],"tags":[]},{"title":"<<玩转Python网络爬虫>>笔记","slug":"书籍/02-<<玩转Python网络爬虫>>笔记","date":"2025-03-07T12:30:58.000Z","updated":"2025-03-10T03:14:12.321Z","comments":true,"path":"2025/03/07/书籍/02-<<玩转Python网络爬虫>>笔记/","link":"","permalink":"https://dbbruce.github.io/2025/03/07/%E4%B9%A6%E7%B1%8D/02-%3C%3C%E7%8E%A9%E8%BD%ACPython%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%3E%3E%E7%AC%94%E8%AE%B0/","excerpt":"headers标签划分为4部分 1.常规-General：请求连接，请求方法，请求状态码 请求网址 https://xxxxx.cn/ 请求方法 GET 状态代码 200 OK 远程地址 119.29.55.55:443 引荐来源网址政策 strict-origin-when-cross-origin","text":"headers标签划分为4部分 1.常规-General：请求连接，请求方法，请求状态码 请求网址 https://xxxxx.cn/ 请求方法 GET 状态代码 200 OK 远程地址 119.29.55.55:443 引荐来源网址政策 strict-origin-when-cross-origin 123&quot;strict-origin-when-cross-origin&quot; 是一种比较严格的 Referrer Policy 策略。它的行为如下：当请求从一个页面 A 跳转到同一源的页面 B 时，Referrer 首部会包含完整的 URL 信息，包括路径和查询参数。这是为了确保目标页面 B 能够获取足够的信息来处理请求 2.响应标头-Response Headers：服务器响应头 HTTP响应标头 描述 Access-Control-Allow-Credentials 响应标头告诉浏览器服务器是否允许 HTTP 跨源请求携带凭据。 响应标头 Access-Control-Expose-Headers 允许服务器指示那些响应标头可以暴露给浏览器中运行的脚本，以响应跨源请求 Access-Control-Allow-Origin 响应标头指定了该响应的资源是否被允许与给定的来源（origin）共享。 Cache-Control 通用消息头字段，被用于在 http 请求和响应中，通过指定指令来实现缓存机制。缓存指令是单向的，这意味着在请求中设置的指令，不一定被包含在响应中。 Content-Encoding 列出了对当前应用资源的任何编码类型，以及编码的顺序 Content-Length 标头表示发送给接收方的消息体的大小（以字节为单位）。 Content-Type 表示标头用于指示资源的原始媒体类型（在发送时应用任何内容编码之前）。 Date 通用 HTTP 标头包含了消息创建时的日期和时间。 ETag HTTP 响应头是资源的特定版本的标识符。这可以让缓存更高效，并节省带宽，因为如果内容没有改变，Web 服务器不需要发送完整的响应。而如果内容发生了变化，使用 ETag 有助于防止资源的同时更新相互覆盖（“空中碰撞”）。 Pragma 是一个在 HTTP&#x2F;1.0 中规定的通用首部，这个首部的效果依赖于不同的实现，所以在“请求 - 响应”链中可能会有不同的效果。它用来向后兼容只支持 HTTP&#x2F;1.0 协议的缓存服务器，那时候 HTTP&#x2F;1.1 协议中的 Cache-Control 还没有出来 Server 标头描述了处理请求的源服务器（即生成响应的服务器）所使用的软件。 Vary HTTP 响应标头描述了除方法和 URL 之外影响响应内容的请求消息。大多数情况下，这用于在使用内容协商时创建缓存键。 X-Content-Type-Options HTTP 消息头相当于一个提示标志，被服务器用来提示客户端一定要遵循在 Content-Type 首部中对 MIME 类型 的设定，而不能对其进行修改。这就禁用了客户端的 MIME 类型嗅探行为，换句话说，也就是意味着网站管理员确定自己的设置没有问题 X-XSS-Protection 响应头是 Internet Explorer，Chrome 和 Safari 的一个特性，当检测到跨站脚本攻击 (XSS) 时，浏览器将停止加载页面。若网站设置了良好的 Content-Security-Policy 来禁用内联 JavaScript (‘unsafe-inline’)，现代浏览器不太需要这些保护，但其仍然可以为尚不支持 CSP 的旧版浏览器的用户提供保护。 3.请求标头-Request Headers-用户请求头 下面4个标头，都是 请求伪标头字段，都是 HTTP2.0 新来的 :authority :method :path :scheme Accept 请求 HTTP 标头表示客户端能够理解的内容类型，以 MIME 类型的形式表达。借助内容协商机制, 服务器可以从诸多备选项中选择一项进行应用，并使用 Content-Type 响应标头通知客户端它的选择。浏览器会基于请求的上下文来为这个请求标头设置合适的值，比如，获取一个 CSS 层叠样式表时的值与获取图片、视频或脚本文件时的值是不同的 Accept-Encoding 请求 HTTP 标头表示客户端能够理解的内容编码（通常是某种压缩算法）。服务器使用内容协商从中选择一个提议，并通过 Content-Encoding 响应标头告知客户端这一选择 Accept-Language 请求 HTTP 标头表示客户端所偏好的自然语言和区域设置。服务器利用内容协商机制从这些提议中选出一项，并通过 Content-Language 响应标头将这一选择告知客户端。浏览器会根据其当前活跃的用户界面语言为该标头设定所需的值。用户很少更改此设置，而且也不建议这样做，因为这可能导致指纹识别。 Cache-Control 通用消息头字段，被用于在 http 请求和响应中，通过指定指令来实现缓存机制。缓存指令是单向的，这意味着在请求中设置的指令，不一定被包含在响应中。 Content-Length 标头表示发送给接收方的消息体的大小（以字节为单位）。 Content-Type 表示标头用于指示资源的原始媒体类型（在发送时应用任何内容编码之前）。 Cookie 是一个 HTTP 请求标头，其中含有先前由服务器通过 Set-Cookie 标头投放或通过 JavaScript 的 Document.cookie 方法设置，然后存储到客户端的 HTTP cookie 。 Origin 表示了请求的来源（协议、主机、端口）。例如，如果一个用户代理需要请求一个页面中包含的资源，或者执行脚本中的 HTTP 请求（fetch），那么该页面的来源（origin）就可能被包含在这次请求中。 Pragma 是一个在 HTTP&#x2F;1.0 中规定的通用首部，这个首部的效果依赖于不同的实现，所以在“请求 - 响应”链中可能会有不同的效果。它用来向后兼容只支持 HTTP&#x2F;1.0 协议的缓存服务器，那时候 HTTP&#x2F;1.1 协议中的 Cache-Control 还没有出来。 priority 提示特定资源请求在特定连接上的优先级。该值可以在请求中发送，以指示客户端的优先级，或者在响应中发送，如果服务器选择重新调整请求的优先级。 Referer 请求头包含了当前请求页面的来源页面的地址，即表示当前页面是通过此来源页面里的链接进入的。服务端一般使用 Referer 请求头识别访问来源，可能会以此进行统计分析、日志记录以及缓存优化等。 Sec-CH-UA 用户代理客户端提示请求标头（header）提供用户代理的品牌（brand）和重要的版本信息。 Sec-CH-UA-Mobile 是否是移动端用户，请求标头是一个用户代理客户端提示，用于指示浏览器是否在移动设备上。 桌面浏览器也可以使用它来指示对 “移动” 用户体验的偏好 Sec-CH-UA-Platform 请求标头是一个用户代理客户端提示，它提供运行用户代理的平台或作系统。 例如：“Windows”或“Android”。 Sec-Fetch-Dest fetch 元数据请求标头指示请求的目的地。 这是原始 fetch 请求的发起者，即 fetch 数据将在哪里 （以及如何） 使用。 Sec-Fetch-Mode fetch 元数据请求标头指示请求的模式。 Sec-Fetch-Site fetch 元数据请求标头指示请求发起方的源与所请求资源的源之间的关系。 User-Agent 请求标头是一个特征字符串，它允许服务器和网络对等体识别请求用户代理的应用程序、作系统、供应商和&#x2F;或版本 X-Requested-With 请求头用于在服务器端判断request来自Ajax请求还是传统请求。 如果 requestedWith 为 null，则为同步请求。如果 requestedWith 为 XMLHttpRequest 则为 Ajax 请求 4.请求参数 - Query String Parameters Fiddlerhttp抓包工具，原理是在电脑上开启一个http服务器代理，然后转发全部的http代理的请求和响应","categories":[{"name":"读书笔记","slug":"读书笔记","permalink":"https://dbbruce.github.io/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"}],"tags":[]},{"title":"<<精通Python爬虫框架scrapy框架>>笔记","slug":"书籍/01-<<精通Python爬虫框架scrapy框架>>笔记","date":"2025-03-07T10:30:58.000Z","updated":"2025-03-07T07:39:22.694Z","comments":true,"path":"2025/03/07/书籍/01-<<精通Python爬虫框架scrapy框架>>笔记/","link":"","permalink":"https://dbbruce.github.io/2025/03/07/%E4%B9%A6%E7%B1%8D/01-%3C%3C%E7%B2%BE%E9%80%9APython%E7%88%AC%E8%99%AB%E6%A1%86%E6%9E%B6scrapy%E6%A1%86%E6%9E%B6%3E%3E%E7%AC%94%E8%AE%B0/","excerpt":"1.非常重要的2个事情 避免类似拒绝服务（DoS）攻击的行为1234问题：普通访问者：可能每几秒访问一个新的页面，而一个典型的网络爬虫则可能每秒下载数十个页面。解决办法：使用流量限速将你产生的流量减少到可以接受的普通用户的水平问题：响应时间增加解决方法：监控响应时间，如果发现响应时间增加了，就需要降低爬虫的强度 侵犯版权123456问题：版权问题解决办法：需要看一下你抓取的每个网站的版权声明，并确保你理解其允许做什么，不允许做什么。大多数网站都允许你处理其站点的信息，只要不以自己的名义重新发布即可。在你的请求中，有一个很好的User-Agent字段，它可以让网站管理员知道你是谁，你用他们的数据做什么。Scrapy在制造请求时，默认使用BOT_NAME参数作为User-Agent。如果User-Agent是一个URL或者能够指明你的应用名称，那么网站管理员可以通过访问你的站点，更多地了解你是如何使用他们的数据的。另一个非常重要的方面是，请允许任何网站管理员阻止你访问其网站的指定区域。对于基于Web标准的robots.txt文件（参见http://www.google.com/robots.txt的文件示例），Scrapy提供了用于尊重网站管理员设置的功能（RobotsTxtMiddleware）。最后，最好向网站管理员提供一些方法，让他们能说明不希望在你的爬虫中出现的东西。至少网站管理员能很容易找到和你交流和表达顾虑的方式","text":"1.非常重要的2个事情 避免类似拒绝服务（DoS）攻击的行为1234问题：普通访问者：可能每几秒访问一个新的页面，而一个典型的网络爬虫则可能每秒下载数十个页面。解决办法：使用流量限速将你产生的流量减少到可以接受的普通用户的水平问题：响应时间增加解决方法：监控响应时间，如果发现响应时间增加了，就需要降低爬虫的强度 侵犯版权123456问题：版权问题解决办法：需要看一下你抓取的每个网站的版权声明，并确保你理解其允许做什么，不允许做什么。大多数网站都允许你处理其站点的信息，只要不以自己的名义重新发布即可。在你的请求中，有一个很好的User-Agent字段，它可以让网站管理员知道你是谁，你用他们的数据做什么。Scrapy在制造请求时，默认使用BOT_NAME参数作为User-Agent。如果User-Agent是一个URL或者能够指明你的应用名称，那么网站管理员可以通过访问你的站点，更多地了解你是如何使用他们的数据的。另一个非常重要的方面是，请允许任何网站管理员阻止你访问其网站的指定区域。对于基于Web标准的robots.txt文件（参见http://www.google.com/robots.txt的文件示例），Scrapy提供了用于尊重网站管理员设置的功能（RobotsTxtMiddleware）。最后，最好向网站管理员提供一些方法，让他们能说明不希望在你的爬虫中出现的东西。至少网站管理员能很容易找到和你交流和表达顾虑的方式 2.文档对象模型 (Document Object Model，DOM)将HTML转换为浏览器内部的树状表示形式 3.URL分为两个主要部分 第一个部分: 通过域名系统（Domain Name System，DNS）帮助我们在网络上定位合适的服务器。比如，当在浏览器中发送https://mail.google.com/mail/u/0/#inbox时，将会创建一个对mail.google.com的DNS请求，用于确定合适的服务器IP地址，如173.194.71.83。 URL的剩余部分: 对于服务端理解请求是什么非常重要。它可能是一张图片、一个文档，或是需要触发某个动作的东西，比如向服务器发送邮件 4.chrome使用xpath 打开 “控制台” “console” 使用$x(), 例如: $x(‘&#x2F;&#x2F;head’) 5.scrapy shell时调试123456789101112131415161718192021222324252627scrapy shell --pdb https://gumtree.com# 可以scrapy 对象列表[s] Available Scrapy objects:[s] scrapy scrapy module (contains scrapy.Request, scrapy.Selector, etc)[s] crawler &lt;scrapy.crawler.Crawler object at 0x110081520&gt;[s] item &#123;&#125;[s] request &lt;GET https://gumtree.com&gt;[s] response &lt;200 https://www.gumtree.com:443/&gt;[s] settings &lt;scrapy.settings.Settings object at 0x11007cf10&gt;[s] spider &lt;DefaultSpider &#x27;default&#x27; at 0x1106dfb50&gt;[s] Useful shortcuts:[s] fetch(url[, redirect=True]) Fetch URL and update local objects (by default, redirects are followed)[s] fetch(req) Fetch a scrapy.Request and update local objects[s] shelp() Shell help (print this help)[s] view(response) View response in a browser&gt;&gt;&gt; scrapy&lt;module &#x27;scrapy&#x27; from &#x27;/Users/dbbruce/.virtualenvs/spider-env/lib/python3.9/site-packages/scrapy/__init__.py&#x27;&gt;&gt;&gt;&gt; request&lt;GET https://gumtree.com&gt;&gt;&gt;&gt; dir(request)[&#x27;__annotations__&#x27;, &#x27;__class__&#x27;, &#x27;__delattr__&#x27;, &#x27;__dict__&#x27;, &#x27;__dir__&#x27;, &#x27;__doc__&#x27;, &#x27;__eq__&#x27;, &#x27;__format__&#x27;, &#x27;__ge__&#x27;, &#x27;__getattribute__&#x27;, &#x27;__gt__&#x27;, &#x27;__hash__&#x27;, &#x27;__init__&#x27;, &#x27;__init_subclass__&#x27;, &#x27;__le__&#x27;, &#x27;__lt__&#x27;, &#x27;__module__&#x27;, &#x27;__ne__&#x27;, &#x27;__new__&#x27;, &#x27;__reduce__&#x27;, &#x27;__reduce_ex__&#x27;, &#x27;__repr__&#x27;, &#x27;__setattr__&#x27;, &#x27;__sizeof__&#x27;, &#x27;__slots__&#x27;, &#x27;__str__&#x27;, &#x27;__subclasshook__&#x27;, &#x27;__weakref__&#x27;, &#x27;_body&#x27;, &#x27;_cb_kwargs&#x27;, &#x27;_encoding&#x27;, &#x27;_get_body&#x27;, &#x27;_get_url&#x27;, &#x27;_meta&#x27;, &#x27;_set_body&#x27;, &#x27;_set_url&#x27;, &#x27;_url&#x27;, &#x27;attributes&#x27;, &#x27;body&#x27;, &#x27;callback&#x27;, &#x27;cb_kwargs&#x27;, &#x27;cookies&#x27;, &#x27;copy&#x27;, &#x27;dont_filter&#x27;, &#x27;encoding&#x27;, &#x27;errback&#x27;, &#x27;flags&#x27;, &#x27;from_curl&#x27;, &#x27;headers&#x27;, &#x27;meta&#x27;, &#x27;method&#x27;, &#x27;priority&#x27;, &#x27;replace&#x27;, &#x27;to_dict&#x27;, &#x27;url&#x27;]&gt;&gt;&gt; request.method&#x27;GET&#x27;&gt;&gt;&gt; response.status200 6.UR²IM——基本抓取流程 7.项目，爬虫 什么时候使用爬虫，什么时候使用项目呢？123项目是由Item和若干爬虫组成的。如果有很多网站，并且需要从中抽取相同类型的Item，比如：房产，那么所有这些网站都可以使用同一个项目，并且为每个源/网站使用一个爬虫。反之，如果要处理图书及房产这两种不同的源时，则应该使用不同的项目 8.创建项目12345678910111213scrapy startproject properties(spider-env) dbbruce@dbburce spider-project % tree properties properties├── properties│ ├── __init__.py│ ├── items.py│ ├── middlewares.py│ ├── pipelines.py│ ├── settings.py│ └── spiders│ ├── __init__.py└── scrapy.cfg 9.查看全部模板 查看全部 scrapy genspider -l123456(spider-env) dbbruce@dbburce spider-project % scrapy genspider -lAvailable templates: basic crawl csvfeed xmlfeed 9.创建爬虫 -t 模板，例如 -t crawl basic 模板，py文件名也会用这个名 web 域名1234567891011121314scrapy genspider basic web(spider-env) dbbruce@dbburce spider-project % tree properties properties├── properties│ ├── __init__.py│ ├── items.py│ ├── middlewares.py│ ├── pipelines.py│ ├── settings.py│ └── spiders│ ├── __init__.py│ └── basic.py #### 这里└── scrapy.cfg properties&#x2F;spider&#x2F;basic.py123456789import scrapyclass BasicSpider(scrapy.Spider): name = &quot;basic&quot; allowed_domains = [&quot;web&quot;] start_urls = [&quot;https://web&quot;] def parse(self, response): pass 10.执行爬虫1(spider-env) dbbruce@dbburce properties % scrapy crawl basic 11.保存文件12scrapy crawl basic -o items.jsonscrapy crawl basic -o items.csv 12.item复制方法123456789101112131415161718192021222324252627282930313233343536373839404142import scrapyfrom properties.items import PropertiesItemfrom scrapy.loader import ItemLoaderfrom scrapy.loader.processors import MapCompose, Joinfrom urllib.parse import urlparseimport datetimeimport socketclass BasicSpider(scrapy.Spider): name = &quot;basic&quot; allowed_domains = [&quot;gumtree.com&quot;] start_urls = ( &#x27;https://www.gumtree.com/p/property-for-sale/cheap-holiday-home-caravan-unlimited-license-low-fees-scratby-great-yarmouth-close-to-beach-/1493108361&#x27;, &#x27;https://www.gumtree.com/p/property-for-sale/spread-the-balance-over-10-years-apartment-in-birmingham-city-centre/1492958745&#x27;, &#x27;https://www.gumtree.com/p/property-for-sale/tain-24-jubilee-drive-price-reduced-/1482274947&#x27;, ) # def parse(self, response): # item = PropertiesItem() # item[&#x27;title&#x27;] = response.xpath(&#x27;//*[@itemprop=&quot;name&quot;][1]/text()&#x27;).extract() # item[&#x27;price&#x27;] = response.xpath(&#x27;//*[@itemprop=&quot;price&quot;][1]/text()&#x27;).re(&#x27;[.0-9]+&#x27;) # item[&#x27;description&#x27;] = response.xpath(&#x27;//*[@itemprop=&quot;description&quot;][1]/text()&#x27;).extract() # item[&#x27;address&#x27;] = response.xpath(&#x27;//*[@itemtype=&quot;http://schema.org/Place&quot;][1]/text()&#x27;).extract() # item[&#x27;image_urls&#x27;] = response.xpath(&#x27;//*[@itemprop=&quot;image&quot;][1]/@src&#x27;).extract() # return item def parse(self, response): l = ItemLoader(item=PropertiesItem(), response=response) l.add_xpath(&#x27;title&#x27;, &#x27;//h1/text()&#x27;, MapCompose(str.strip, str.title)) l.add_xpath(&#x27;price&#x27;, &#x27;//*[@id=&quot;content&quot;]/div[1]/div/main/div[3]/div[1]/div/div/span[2]/h3/text()&#x27;,MapCompose(lambda i:i.replace(&#x27;,&#x27;,&#x27;&#x27;), float), re=&#x27;[,.0-9]+&#x27;) l.add_xpath(&#x27;description&#x27;, &#x27;//*[@itemprop=&quot;description&quot;][1]/text()&#x27;,MapCompose(str.strip),Join()) l.add_xpath(&#x27;address&#x27;, &#x27;//*[@id=&quot;content&quot;]/div[1]/div/main/div[3]/div[1]/div/div/span[1]/h4/text()&#x27;, MapCompose(str.strip)) l.add_xpath(&#x27;image_urls&#x27;,&#x27;//img/@src&#x27;) l.add_value(&#x27;url&#x27;, response.url) l.add_value(&#x27;project&#x27;, self.settings.get(&#x27;BOT_NAME&#x27;)) l.add_value(&#x27;spider&#x27;, self.name) l.add_value(&#x27;server&#x27;, socket.gethostname()) l.add_value(&#x27;date&#x27;, datetime.datetime.now()) return l.load_item() 13.水平爬取12横向——从一个索引页到另一个索引页；因为这种情况下是在同一层级下爬取页面（比如索引页） 14.垂直爬取12纵向——从一个索引页到房源页并抽取Item。而将后者称为垂直爬取，因为该方式是从一个更高的层级（比如索引页）到一个更低的层级（比如房源页） 15.scrapy调试1234&gt;&gt;&gt; scrapy shell https://www.gumtree.com/flats-houses/property-for-sale&gt;&gt;&gt; urls=response.xpath(&#x27;//*[contains(@class,&quot;pagination-link--next&quot;)]//@href&#x27;).extract()&gt;&gt;&gt; urls[&#x27;/flats-houses/property-for-sale/uk/page2&#x27;] 16.为了避免运行时间过长，可以通过命令行参数：-s CLOSESPIDER_ITEMCOUNT&#x3D;90，告知爬虫在爬取指定数量（如90个）的Item后停止运行1234CLOSESPIDER_TIMEOUT（秒）、指定时间CLOSESPIDER_ITEMCOUNT、指定数目的ItemCLOSESPIDER_PAGECOUNT、指定数目的响应CLOSESPIDER_ERRORCOUNT、指定数目的错误 12scrapy crawl manual -s CLOSESPIDER_ITEMCOUNT=2scrapy crawl manual -s CLOSESPIDER_PAGECOUNT=2 17.后入先出12345Scrapy在处理请求时使用的是后入先出（LIFO）策略（即深度优先爬取）。用户提交的最后一个请求会被首先处理。在大多数情况下，这种默认的方式非常方便。比如，我们想要在移动到下一个索引页之前处理每一个房源页时。否则，我们将会填充一个包含待爬取房源页URL的巨大队列，无谓地消耗内存。另外，在许多情况中，你可能需要辅助的请求来完成单个请求，我们将会在后面的章节中遇到这种情况。你需要这些辅助的请求能够尽快完成，以腾出资源，并且让被抓取的Item能够稳定流动。 18.Request优先级12345通过设置Request()的优先级参数修改默认顺序，大于0表示高于默认的优先级，小于0表示低于默认的优先级。通常来说，Scrapy的调度器会首先执行高优先级的请求，不过不要花费太多时间来考虑具体的哪个请求应该被首先执行。很可能在你的应用中，不会使用超过1个或或2个请求优先级。此外还需要注意的是， 19.URL去重12URL还会被执行去重操作，这在大部分时候也是我们想要的功能。不过如果我们需要多次执行同一个URL的请求，可以设置dont_filter_Request()参数为true。 20.使用CrawlSpider12345这是一个能够更容易地实现这种爬取的类。为了实现它，我们需要使用genspider命令，并设置-t crawl参数，以使用crawl爬虫模板创建一个爬虫。$scrapy genspider -t crawl easy webscrapy genspider -t crawl easy gumtree.com 21.LinkExtractor1234567正是专门用于抽取链接的，因此在默认情况下，它们会去查找a（及area）href属性。你可以通过设置LinkExtractor()的tags和attrs参数来进行自定义。需要注意的是，回调参数目前是包含回调方法名称的字符串（比如&#x27;parse_item&#x27;），而不是方法引用，如Request(self.parse_item)。最后，除非设置了callback参数，否则Rule将跟踪已经抽取的URL，也就是说它将会扫描目标页面以获取额外的链接并跟踪它们。如果设置了callback，Rule将不会跟踪目标页面的链接。如果你希望它跟踪链接，应当在callback方法中使用return或yield返回它们，或者将Rule()的follow参数设置为true。当你的房源页既包含Item又包含其他有用的导航链接时，该功能可能会非常有用。 22.HTTP Cookie123是一些服务端发送给浏览器的文本或数值，通常都很短。相应地，浏览器会在随后的每个请求中将其返回给服务端，用于标识你、用户和会话。这样你就可以执行需要服务端状态信息的复杂操作了，比如购物车里的商品或你的用户名和密码。 23.scrapy配置 PyCharm调试运行Scrapy教程 1.找到scrapy框架下的cmdline.py文件 ，\\site-packages\\scrapy\\cmdline.py 2.复制一份到tutorial项目的根目录下（scrapy.cfg文件的同一目录下） 3.edit configurations 利特尔法则1队列系统的基本法则是利特尔法则，该法则认为在稳定状态下，队列系统中的元素数量（N）等于系统吞吐量（T）乘以总排队/服务时间（S），即N = T · S scrapy telnet123&gt; telnet localhost 6023&gt; username scrapy&gt; password 终端随机生成的密码 指标 说明 len(engine.slot.scheduler.mqs) 目前在调度器中还有很多等待（12个请求） len(engine.downloader.active) 目前有9个请求正在下载器中被下载。settings.py文件中设置CONCURRENT_REQUESTS值，默认16 len(engine.scraper.slot.active) 正在进行抓取处理的响应有9个 engine.scraper.slot.active_size 这些响应大小总计为3011708kb。 engine.scraper.slot.itemproc_size 在这些响应中，有 0个Item此时正在通过管道处理 主要监控一下五个指标： 123451. engine.downloader.active：下载器中等待下载的请求，对应最大并发数。设置中为16，这里也是16，说明下载器已经满了，其他请求进不来了。2. engine.slot.scheduler.mqs：内存调度队列。进不去下载器的请求就只能在调度器中等待了，这里有12个请求在等待。3. engine.slot.scheduler.dqs：磁盘调度队列，可以设置，将请求放于磁盘之中。4. engine.scraper.slot.active：正在被处理的响应数量5. engine.scraper.slot.itemproc_size：pipeline处理的Item数量 另一个信息元是stats对象，即通常在爬取完成后打印的信息 我们可以在Telnet中，通过stats.get_stats()，以字典的形式在任何时间访问它，并且可以通过p()函数打印更优雅的格式。 123456&gt; p(stats.get_stats())&gt; &#123;&#x27;downloader/request_bytes&#x27;: 558330, ... &#x27;item_scraped_count&#x27;: 2485, ... &#125; 1对我们来说，目前最感兴趣的度量是item_scraped_count，它可以通过stats.get_value(&#x27;item_scraped_count&#x27;)直接访问。该度量告知我们到目前为止有多少item已经被抓取，它应当以系统吞吐量（Item/秒）的速率增长。 有3个主要设置用于控制下载器能力 项目 描述 CONCURRENT_REQUESTS 其中第一个是粗调控制。无论如何都不会在同一时间有超过CONCURRENT_REQUESTS数量的请求处于活跃状态。下载器的并发数量可以完全由CONCURRENT_REQUESTS来控制 CONCURRENT_REQUESTS_PER_DOMAIN 而如果你的目标是单个域名或相对较少的几个域名，CONCURRENT_REQUESTS_PER_DOMAIN可能会进一步限制活跃请求的数量 CONCURRENT_REQUESTS_PER_IP 如果设置了CONCURRENT_REQUESTS_PER_IP，那么CONCURRENT_REQUESTS_PER_DOMAIN就会被忽略，此时有效的限制将会是针对单个（目标）IP的请求数 Scrapy在设计时就将下载器作为瓶颈。从一个低数值的CONCURRENT_REQUESTS开始，逐渐增加，直到触及下述限制之一：123CPU使用率大于80%～90%；源网站延迟过度增长；抓取程序中响应达到了5MB的内存限制。 同时，执行以下操作12始终保持调度器队列（mqs/dqs）中至少有一定量的请求，避免下载器出现URL饥饿；永远不要使用任何阻塞代码或CPU密集型代码 故障排除流程 Scrapyd scrapyd其实就是一个服务器端，真正在部署爬虫的时候，我们需要两个东西：scrapyd (安装在服务器端)scrapyd-client (客户端)scrapyd-client，它允许我们将本地的scrapy项目打包发送到scrapyd 这个服务端 安装： 12pip install scrapydpip install scrapyd-client 启动： 1scrapyd-deploy 浏览器查看 1http://localhost:6800/ 配置scrapy.cfg properties&#x2F;scrapy.cfg 123[deploy:properties]url = http://localhost:6800/project = properties 上传项目 scrapyd-deploy properties -p properties 12345678(spider-env) dbbruce@dbburce properties % pwd/Users/dbbruce/workspace/spider-project/scrapyDemo/03/properties(spider-env) dbbruce@dbburce properties % scrapyd-deploy properties -p propertiesPacking version 1741329244Deploying to project &quot;properties&quot; in http://localhost:6800/addversion.jsonServer response (200):&#123;&quot;project&quot;: &quot;properties&quot;, &quot;version&quot;: &quot;1741329244&quot;, &quot;spiders&quot;: 5, &quot;status&quot;: &quot;ok&quot;, &quot;node_name&quot;: &quot;dbburce.local&quot;&#125;","categories":[{"name":"读书笔记","slug":"读书笔记","permalink":"https://dbbruce.github.io/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"}],"tags":[]},{"title":"012-speed基准系统","slug":"爬虫/基础/012-scrapy-speed基准系统","date":"2025-03-07T07:04:52.000Z","updated":"2025-03-07T06:03:14.617Z","comments":true,"path":"2025/03/07/爬虫/基础/012-scrapy-speed基准系统/","link":"","permalink":"https://dbbruce.github.io/2025/03/07/%E7%88%AC%E8%99%AB/%E5%9F%BA%E7%A1%80/012-scrapy-speed%E5%9F%BA%E5%87%86%E7%B3%BB%E7%BB%9F/","excerpt":"speed基准系统代码示例","text":"speed基准系统代码示例 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248# -*- coding: utf-8 -*-import jsonimport timefrom treq import postfrom twisted.internet.task import deferLaterfrom twisted.internet import defer, reactor, taskimport scrapyfrom scrapy import FormRequestfrom scrapy.http import Requestfrom scrapy.linkextractors import LinkExtractorfrom scrapy.spiders import CrawlSpider, Rulefrom scrapy.exceptions import NotConfiguredfrom scrapy import signalssettings_to_url = &#123; # Website structure &quot;SPEED_TOTAL_ITEMS&quot;: &quot;ti&quot;, &quot;SPEED_DETAILS_PER_INDEX_PAGE&quot;: &quot;dp&quot;, &quot;SPEED_ITEMS_PER_DETAIL&quot;: &quot;id&quot;, &quot;SPEED_DETAIL_EXTRA_SIZE&quot;: &quot;ds&quot;, &quot;SPEED_INDEX_POINTAHEAD&quot;: &quot;ip&quot;, # Response times &quot;SPEED_T_RESPONSE&quot;: &quot;rr&quot;, &quot;SPEED_API_T_RESPONSE&quot;: &quot;ar&quot;, &quot;SPEED_DETAIL_T_RESPONSE&quot;: &quot;dr&quot;, &quot;SPEED_INDEX_T_RESPONSE&quot;: &quot;ir&quot;,&#125;def get_base_url(settings): port = settings.getint(&#x27;SPEED_PORT&#x27;, 9312) args = [] for (setting, arg_name) in settings_to_url.items(): arg_value = settings.get(setting) # If a setting is set, then reflect that to the URL if arg_value: args.append(&quot;/%s:%s&quot; % (arg_name, arg_value)) return &quot;http://web:%d%s/benchmark/&quot; % (port, &quot;&quot;.join(args))class DummyItem(scrapy.Item): id = scrapy.Field() info = scrapy.Field() translation = scrapy.Field()class SpeedSpider(CrawlSpider): name = &#x27;speed&#x27; @classmethod def from_crawler(cls, crawler, *args, **kwargs): if crawler.settings.getbool(&#x27;SPEED_INDEX_RULE_LAST&#x27;, False): cls.rules = (cls.rules[1], cls.rules[0]) spider = super(SpeedSpider, cls).from_crawler(crawler, *args, **kwargs) spider.blocking_delay = crawler.settings.getfloat( &#x27;SPEED_SPIDER_BLOCKING_DELAY&#x27;, 0.0) spider.base = get_base_url(crawler.settings) return spider def get_detail_requests(self): items_per_page = self.settings.getint(&#x27;SPEED_ITEMS_PER_DETAIL&#x27;, 1) total_items = self.settings.getint(&#x27;SPEED_TOTAL_ITEMS&#x27;, 1000) for i in range(1, total_items+1, items_per_page): yield Request(self.base + &quot;detail?id0=%d&quot; % i, callback=self.parse_item) def start_requests(self): start_requests_style = self.settings.get(&#x27;SPEED_START_REQUESTS_STYLE&#x27;, &#x27;Force&#x27;) if start_requests_style == &#x27;UseIndex&#x27;: # The requests out of the index page get processed in the same # parallel(... CONCURRENT_ITEMS) among regular Items. index_shards = self.settings.getint(&#x27;SPEED_INDEX_SHARDS&#x27;, 1) index_pages_count = self.get_index_pages_count() # Round up shard_length = (index_pages_count+index_shards-1) / index_shards for i in range(1, index_pages_count, shard_length): url = self.base + &quot;index?p=%d&quot; % i yield self.make_requests_from_url(url) elif start_requests_style == &#x27;Force&#x27;: # This is feeding those requests directly into the scheduler&#x27;s # queue. for request in self.get_detail_requests(): self.crawler.engine.crawl(request=request, spider=self) elif start_requests_style == &#x27;Iterate&#x27;: # start_requests are consumed &quot;on demand&quot; through yield for request in self.get_detail_requests(): yield request else: print(&quot;No start_requests.&quot;) def get_index_pages_count(self): details_per_index = self.settings.getint( &#x27;SPEED_DETAILS_PER_INDEX_PAGE&#x27;, 20) items_per_page = self.settings.getint(&#x27;SPEED_ITEMS_PER_DETAIL&#x27;, 1) page_worth = details_per_index * items_per_page total_items = self.settings.getint(&#x27;SPEED_TOTAL_ITEMS&#x27;, 1000) # Round up index_pages_count = (total_items + page_worth - 1) / page_worth return index_pages_count def my_process_request(self, r): if self.settings.getbool(&#x27;SPEED_INDEX_HIGHER_PRIORITY&#x27;, False): r.priority = 1 return r rules = ( Rule(LinkExtractor(restrict_xpaths=&#x27;//*[@class=&quot;nav&quot;]&#x27;), process_request=&quot;my_process_request&quot;), Rule(LinkExtractor(restrict_xpaths=&#x27;//*[@class=&quot;item&quot;]&#x27;), callback=&#x27;parse_item&#x27;) ) def parse_item(self, response): if self.blocking_delay &gt; 0.001: # This is a bad bad thing time.sleep(self.blocking_delay) for li in response.xpath(&#x27;//li&#x27;): i = DummyItem() id_phrase = li.xpath(&#x27;.//h3/text()&#x27;).extract()[0] i[&#x27;id&#x27;] = int(id_phrase.split()[1]) i[&#x27;info&#x27;] = li.xpath(&#x27;.//div[@class=&quot;info&quot;]/text()&#x27;).extract() yield iclass DummyPipeline(object): def __init__(self, crawler): self.crawler = crawler self.blocking_delay = crawler.settings.getfloat( &#x27;SPEED_PIPELINE_BLOCKING_DELAY&#x27;, 0.0) self.async_delay = crawler.settings.getfloat( &#x27;SPEED_PIPELINE_ASYNC_DELAY&#x27;, 0.0) self.downloader_api = crawler.settings.getbool( &#x27;SPEED_PIPELINE_API_VIA_DOWNLOADER&#x27;, False) self.treq_api = crawler.settings.getbool( &#x27;SPEED_PIPELINE_API_VIA_TREQ&#x27;, False) self.base = get_base_url(crawler.settings) @classmethod def from_crawler(cls, crawler): return cls(crawler) @defer.inlineCallbacks def process_item(self, item, spider): # If no processing is made, translation will # be N/A item[&#x27;translation&#x27;] = &quot;N/A&quot; if self.blocking_delay &gt; 0.001: # This is a bad bad thing time.sleep(self.blocking_delay) if self.async_delay &gt; 0.001: # Emulate an asynchronous call to a translation function delay = self.async_delay translate = lambda: &quot;calculated-%s&quot; % item[&#x27;info&#x27;] translation = yield deferLater(reactor, delay, translate) item[&#x27;translation&#x27;] = translation if self.downloader_api: # Do an API call using Scrapy&#x27;s downloader formdata = dict(text=item[&#x27;info&#x27;]) request = FormRequest(self.base + &quot;api&quot;, formdata=formdata) response = yield self.crawler.engine.download(request, spider) item[&#x27;translation&#x27;] = json.loads(response.body)[&#x27;translation&#x27;] if self.treq_api: # Do an API call using treq response = yield post(self.base + &quot;api&quot;, &#123;&quot;text&quot;: item[&#x27;info&#x27;]&#125;) json_response = yield response.json() item[&#x27;translation&#x27;] = json_response[&#x27;translation&#x27;] defer.returnValue(item)class PrintCoreMetrics(object): &quot;&quot;&quot; An extension that prints &quot;core metrics&quot; &quot;&quot;&quot; @classmethod def from_crawler(cls, crawler): return cls(crawler) def __init__(self, crawler): self.crawler = crawler self.interval = crawler.settings.getfloat(&#x27;CORE_METRICS_INTERVAL&#x27;, 1.0) self.first = True if not self.interval: raise NotConfigured cs = crawler.signals cs.connect(self._spider_opened, signal=signals.spider_opened) cs.connect(self._spider_closed, signal=signals.spider_closed) def _spider_opened(self, spider): self.task = task.LoopingCall(self._log, spider) self.task.start(self.interval) def _spider_closed(self, spider, reason): if self.task.running: self.task.stop() def _log(self, spider): engine = self.crawler.engine stats = self.crawler.stats if self.first: self.first = False spider.logger.info((&quot;%8s&quot;*5+&quot;%10s&quot;) % ( &quot;s/edule&quot;, &quot;d/load&quot;, &quot;scrape&quot;, &quot;p/line&quot;, &quot;done&quot;, &quot;mem&quot;, )) spider.logger.info((&quot;%8d&quot;*5+&quot;%10d&quot;) % ( len(engine.slot.scheduler.mqs), len(engine.downloader.active), len(engine.scraper.slot.active), engine.scraper.slot.itemproc_size, stats.get_value(&#x27;item_scraped_count&#x27;) or 0, engine.scraper.slot.active_size ))","categories":[{"name":"爬虫类","slug":"爬虫类","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/"},{"name":"基础","slug":"爬虫类/基础","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"10月份","slug":"每月概要/2023/202310","date":"2023-10-28T10:08:28.000Z","updated":"2024-06-26T02:44:40.000Z","comments":true,"path":"2023/10/28/每月概要/2023/202310/","link":"","permalink":"https://dbbruce.github.io/2023/10/28/%E6%AF%8F%E6%9C%88%E6%A6%82%E8%A6%81/2023/202310/","excerpt":"","text":"conda的基础使用 管理环境1234567891011121314151617181920212223242526272829303132获取版本号conda --version或 conda -V列出所有的环境conda env list创建环境conda create -n env-name [list of package]。-n env-name是设置新建环境的名字，list of package是可选项，选择要为该环境安装的包。如果我们没有指定安装python的版本，conda会安装我们最初安装conda时所装的那个版本的python。若创建特定python版本的包环境，需键入conda create -n env-name python=3.6激活环境Linux，OS X:source activate env-nameWindows：activate env-name切换到base环境如果要从你当前工作环境的路径切换到系统根目录时，键入：Linux，OS X:conda source deactivateWindows:conda deactivate复制一个环境通过克隆来复制一个环境。这儿将通过克隆snowfllakes来创建一个称为flowers的副本。conda create -n flowers --clone snowflakes通过conda env list来检查目前拥有的环境删除一个环境如果你不想要这个名为flowers的环境，就按照如下方法移除该环境：conda env remove -n flowers 管理包123456789101112131415161718（1）安装包 或 安装特定版本的包conda install package-nameconda install package-name==version（2）查看所有已安装包conda list（3）卸载包conda remove package-name（4）更新包更新一个包conda update package-name更新所有包conda update --all（5）搜索包conda search search-term，可以模糊搜索","categories":[{"name":"每月概要","slug":"每月概要","permalink":"https://dbbruce.github.io/categories/%E6%AF%8F%E6%9C%88%E6%A6%82%E8%A6%81/"},{"name":"2023","slug":"每月概要/2023","permalink":"https://dbbruce.github.io/categories/%E6%AF%8F%E6%9C%88%E6%A6%82%E8%A6%81/2023/"}],"tags":[]},{"title":"抽象类","slug":"python/基础/抽象类","date":"2023-10-12T09:14:52.000Z","updated":"2024-11-04T03:41:32.000Z","comments":true,"path":"2023/10/12/python/基础/抽象类/","link":"","permalink":"https://dbbruce.github.io/2023/10/12/python/%E5%9F%BA%E7%A1%80/%E6%8A%BD%E8%B1%A1%E7%B1%BB/","excerpt":"抽象类1、抽象类是一种特殊的类，它生下来就是作为父类存在的，一旦对象化就会报错。同样，抽象 函数定义在抽象类之中，子类必须重写该函数才能使用。相应的抽象函数，则是使用装饰器 @abstractmethod 来表示。这其实正是软件工程中一个很重要的概念，定义接口，抽象类就是这么一种存在，它是一种自上而下的设计风范，你只需要用少量的代码描述清楚 要做的事情，定义好接口，然后就可以交给不同开发人员去开发和对接。","text":"抽象类1、抽象类是一种特殊的类，它生下来就是作为父类存在的，一旦对象化就会报错。同样，抽象 函数定义在抽象类之中，子类必须重写该函数才能使用。相应的抽象函数，则是使用装饰器 @abstractmethod 来表示。这其实正是软件工程中一个很重要的概念，定义接口，抽象类就是这么一种存在，它是一种自上而下的设计风范，你只需要用少量的代码描述清楚 要做的事情，定义好接口，然后就可以交给不同开发人员去开发和对接。 12345678910111213141516171819from abc import ABCMeta, abstractmethodclass Entity(metaclass=ABCMeta): @abstractmethod def get_title(self): pass @abstractmethod def set_title(self, title): passclass Document(Entity): def get_title(self): return self.title def set_title(self, title): self.title = titledocument = Document()document.set_title(&#x27;Harry Potter&#x27;)print(document.get_title()) 实例化抽象类，e1 &#x3D; Entity()，报错：TypeError: Can’t instantiate abstract class Entity with abstract methods get_title, set_title","categories":[{"name":"Python基础","slug":"Python基础","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/"},{"name":"基础","slug":"Python基础/基础","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"TCP三次握手","slug":"python/基础/TCP三次握手","date":"2023-10-11T11:14:52.000Z","updated":"2024-11-04T02:37:20.000Z","comments":true,"path":"2023/10/11/python/基础/TCP三次握手/","link":"","permalink":"https://dbbruce.github.io/2023/10/11/python/%E5%9F%BA%E7%A1%80/TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B/","excerpt":"TCP&#x2F;IP的传输层 是网络中承上启下的关键一层，向上对应用层提供通信服务，向下将应用信息封装为网络信息。传输层连接主机之间的进程，同一主机中不同进程的网络通信通过端口（port）进行区分，所以传输层为主机提供的是端口到端口的服务 应用程序（调入内存运行后一般被称为进程） 通过系统调用与某端口建立连接（Binding，绑定）后，传输层传给该端口的数据都被相应的进程所接收，相应的进程发给传输层的数据都从该端口输出。由于TCP&#x2F;IP传输层的TCP和UDP是两个完全独立的软件模块，因此各自的端口号也相互独立","text":"TCP&#x2F;IP的传输层 是网络中承上启下的关键一层，向上对应用层提供通信服务，向下将应用信息封装为网络信息。传输层连接主机之间的进程，同一主机中不同进程的网络通信通过端口（port）进行区分，所以传输层为主机提供的是端口到端口的服务 应用程序（调入内存运行后一般被称为进程） 通过系统调用与某端口建立连接（Binding，绑定）后，传输层传给该端口的数据都被相应的进程所接收，相应的进程发给传输层的数据都从该端口输出。由于TCP&#x2F;IP传输层的TCP和UDP是两个完全独立的软件模块，因此各自的端口号也相互独立 TCP采用面向连接的方式收发数据，在收发数据之前需要先建立连接，在数据传输之后释放连接，建立连接的三次握手过程如下● 建立连接时，客户端发送SYN包到服务器，并进入SYN_SENT状态，等待服务器确认。● 服务器收到SYN包，反馈给客户端一个SYN+ACK包，此时服务器进入SYN_RECV状态。● 客户端收到服务器的SYN+ACK包，向服务器发送确认包ACK，客户端和服务器同时进入ESTABLISHED（TCP连接成功）状态，完成三次握手。 建立连接后双方可互相发送消息，消息完成后可由任意一方发起关闭连接请求。关闭连接的过程如下。● 关闭请求方（比如客户端）向另一方发送（比如服务器）一个带有FIN附加标记的报文段。● 服务器收到这个FIN报文段之后，并不立即用FIN报文段回复主机A，而是先向主机A发送一个确认序号ACK，同时通知自己的相应的应用程序：对方要求关闭连接，使应用程序做相应的清理工作。● 服务器的应用程序清理工作完成后，向客户端发送一个FIN报文段。● 客户端收到这个FIN报文段后，向服务器发送一个ACK，表示连接彻底释放。","categories":[{"name":"Python基础","slug":"Python基础","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/"},{"name":"基础","slug":"Python基础/基础","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"TCP/IP简介","slug":"python/基础/TCP-IP简介","date":"2023-10-10T11:14:52.000Z","updated":"2024-11-04T02:31:52.000Z","comments":true,"path":"2023/10/10/python/基础/TCP-IP简介/","link":"","permalink":"https://dbbruce.github.io/2023/10/10/python/%E5%9F%BA%E7%A1%80/TCP-IP%E7%AE%80%E4%BB%8B/","excerpt":"1. Internet是基于TCP&#x2F;IP网络而搭建的, TCP&#x2F;IP将网络分为4层结构，分别是应用层、传输层、网络层、接口层 层 功能 应用层 HTTP、SMTP等，是网络应用开发的重点 传输层 TCP或UDP，开发者需要了解其原理 网络层 IP，开发者需要了解其概念 接口层 处理物理细节，开发者无须关心","text":"1. Internet是基于TCP&#x2F;IP网络而搭建的, TCP&#x2F;IP将网络分为4层结构，分别是应用层、传输层、网络层、接口层 层 功能 应用层 HTTP、SMTP等，是网络应用开发的重点 传输层 TCP或UDP，开发者需要了解其原理 网络层 IP，开发者需要了解其概念 接口层 处理物理细节，开发者无须关心 应用层：Application Layer， 为用户的进程直接提供服务，应用层负责发送及接收什么数据、如何解释数据、如何呈现数据、如何加密数据等问题，是网络应用程序开发者重点打交道的对象。例如HTTPS定义了网络间数据加密及认证的标准方法、HTML定义了网页的解析方式等。 传输层：Transport Layer， 为两个主机的不同端口之间的通信提供服务。端口（Port）是一种在同一主机内的不同通道之间进行寻址的方式。传输层的发送方与接收方在物理上无须相邻。TCP&#x2F;IP的传输层包括两种协议：TCP和UDP。TCP提供可靠的有序传输，UDP提供非可靠的传输。 网络层：Network Layer， 为两个主机之间提供通信服务。网络层定义了数据如何被封装为传送包，并且定义了不同主机之间的寻址方式。主要由IP（Internet Protocol）组成，辅以ICMP、IGMP等路由协议。本书的Internet开发者只需了解IP协议即可。 接口层：Link Layer， 负责相邻物理设备之间的信息传输。接口层的工作非常多且复杂，它需要完成接口层的数据组装（形成Frame），加入必要的控制和校验数据，并且将二进制数据流（0&#x2F;1）转换为物理链路上的标准电平（高电平、低电平）。针对不同的物理传”“输介质，接口层定义了多套标准，并且这些标准随着电子技术的进步一直发展，例如802.3、802.11等。” 2．网络设备● 集线器：简称HUB，是接口层设备。 集线器是网络互连的最简单设备，它接收并识别网络信号，然后再生信号并将其发送到网络的其他分支上。 ● 交换机：即Switcher，是接口层设备， 也是网络互联中的最常用设备。它与集线器的差别是HUB本身不能识别目的地址，而交换机可以。当同一局域网内的A主机向B主机传输数据时，数据包在经过HUB时在网络上是以广播方式传输的，由每一台终端通过地址信息来确定数据包是否属于自己；数据包经过Switcher时，Switcher会根据Frame目的地址直接发送给B主机所在的链路。因此，在网络中用交换机替换集线器通常能提高网络的整体性能。 ● 网桥：Bridge，是接口层设备。 网桥通常用于物理异构的网络之间相互连接，例如以太网和令牌网之间。 ● 路由器：即Router，是网络层设备。 路由器是互联网的主要结点设备，通过发送者、接收者的IP地址和路由算法决定数据的收发路径，这一过程叫作Routing。 ● 网关：Gateway，是一个通用概念， 主要指不同网络环境之间的协议转换，一般为应用层设备，比如一个专用于数据存储转发的服务器。 ● 调试解调器：即Modem，俗称“猫”，是接口层设备， 用于连接计算机网络与传统通信网。Modem将计算机的数字信号转译成能够在常规电话线中传输的模拟信号。因为模拟信道的传输距离更长，所以长距离的网络传输一般都需要经过Modem转接。常见的家用Modem包括56k猫、ADSL猫、光纤猫等。 ● 无线接入点：即Wireless Access Point，是接口层设备。 将有线网络转为无线网络，最常用的无线接入点即WiFi。 ● 防火墙：即Firewall，是传输层及应用层的设备。 防火墙通常位于不同网络的边界处，主要用于防止恶意程序及数据进入内部网络，或者防止机密信息泄露到广域网中。企业级网络通常用防火墙抵御非法入侵。” ● URL 为统一资源定位符，是用来表示Internet上资源位置的标准。资源位置包括资源所在的主机及其在主机内的访问路径。这里所说的资源是指Internet上任何可访问的对象，包括文本、图像、视频流等。URL的标准形式如下： [协议]:&#x2F;&#x2F;[主机]:[端口]&#x2F;[路径]? [参数]","categories":[{"name":"Python基础","slug":"Python基础","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/"},{"name":"基础","slug":"Python基础/基础","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"odoo知识点(十一)-odoo快速入门与实践总结-第五篇","slug":"odoo/20231005-odoo快速入门与实践总结5","date":"2023-10-05T15:50:52.000Z","updated":"2024-12-06T08:56:57.345Z","comments":true,"path":"2023/10/05/odoo/20231005-odoo快速入门与实践总结5/","link":"","permalink":"https://dbbruce.github.io/2023/10/05/odoo/20231005-odoo%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E4%B8%8E%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%935/","excerpt":"第九章 ORM API基础","text":"第九章 ORM API基础","categories":[{"name":"odoo","slug":"odoo","permalink":"https://dbbruce.github.io/categories/odoo/"},{"name":"基础","slug":"odoo/基础","permalink":"https://dbbruce.github.io/categories/odoo/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"odoo知识点(十)-odoo快速入门与实践总结-第四篇","slug":"odoo/20231004-odoo快速入门与实践总结4","date":"2023-10-04T15:50:52.000Z","updated":"2024-12-09T05:52:16.855Z","comments":true,"path":"2023/10/04/odoo/20231004-odoo快速入门与实践总结4/","link":"","permalink":"https://dbbruce.github.io/2023/10/04/odoo/20231004-odoo%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E4%B8%8E%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%934/","excerpt":"第八章 文件相关数据操作8.1 外部ID外部ID也称为XML ID，该字符串能够唯一标示Odoo内的一条特殊记录外部ID为数据库的数据记录ID提供了一个别名，以方便我们在需要的时候通过外部ID查找一条记录Odoo模块数据文件中定义的记录使用的是外部ID。这样做的一个很重要的原因是，其可以避免在升级模块时创建重复记录，模块升级的时候会再次加载数据文件到数据库，这时候可通过外部ID确定数据库里面是否已经存在该记录，Odoo由此即可判断是更新还是新建使用外部ID的另一个原因是，可使用外部ID来支持互相关联的数据，在初始化的时候，毕竟有很多记录之间是有关联关系的,因为我们不知道记录未来在数据库中记录的ID，所以只能使用外部ID，然后由Odoo在进行数据加载时由外部ID翻译到数据库ID。这种翻译的机制是通过ir.model.data模型来实现的，该模型存储了外部ID与数据库记录ID的对照表","text":"第八章 文件相关数据操作8.1 外部ID外部ID也称为XML ID，该字符串能够唯一标示Odoo内的一条特殊记录外部ID为数据库的数据记录ID提供了一个别名，以方便我们在需要的时候通过外部ID查找一条记录Odoo模块数据文件中定义的记录使用的是外部ID。这样做的一个很重要的原因是，其可以避免在升级模块时创建重复记录，模块升级的时候会再次加载数据文件到数据库，这时候可通过外部ID确定数据库里面是否已经存在该记录，Odoo由此即可判断是更新还是新建使用外部ID的另一个原因是，可使用外部ID来支持互相关联的数据，在初始化的时候，毕竟有很多记录之间是有关联关系的,因为我们不知道记录未来在数据库中记录的ID，所以只能使用外部ID，然后由Odoo在进行数据加载时由外部ID翻译到数据库ID。这种翻译的机制是通过ir.model.data模型来实现的，该模型存储了外部ID与数据库记录ID的对照表 设置|序列与标识符|外部标示 页面搜索外部ID 编辑列表视图或者编辑搜索视图 8.3.2 XML数据文件 noupdate: 默认noupdate的值为0。若设置noupdate&#x3D;1，则意味着该文件的数据只在安装的时候加载一次，后续的应用更新不会再加载 在XML文件中可使用元素定义记录，每个至少有两个属性，id和model 使用元素来定义字段，并使用里面的name属性来引入数据模型的字段名 通过eval属性引入Python表达式，并且结果值会被赋予字段。一般表达式内可以使用Python的一些内置模块计算昨天的表达式1&lt;field name=&quot;change_date&quot; eval=&quot;(datetime.now()+timedelta(-1)).strftime (&#x27;%Y-%m-%d&#x27;)&quot;/&gt; 使用函数将外部ID转换成数据库记录的ID1&lt;field name=&quot;follower_id&quot; eval=&quot;ref(&#x27;base.group_user&#x27;)&quot;/&gt; 使用ref()函数可以为many2one关系赋值，我们使用的方式是为函数传递模型名称作为参数。其实还有另外一种使用方式，就是直接使用ref参数，为其赋值外部ID1&lt;field name=&quot;follower_id&quot; ref=&quot;base.user_root&quot;/&gt; 如果是one2many或many2many的关系，则在使用的时候需要传递多个外部ID。所以针对这种关联关系，语法上就有一些特别的语法。语法格式也是使用eval引入，形如eval&#x3D;””，不过等号右侧的表达式可以分为多种，具体可分为以下几种12345678（0，_，&#123;&#x27;field&#x27;：value&#125;）：这是创建一条新记录，并且将新记录关联到本记录。字典里面可以写多个键值对。（1，id，&#123;&#x27;field&#x27;：value&#125;）：更新已在关联记录字段上的值。（2，id，_）：断开与关联记录的关系，并且删除关联记录。（3，id，_）：断开与关联记录的关系，但是不删除关联记录。 原来关联的是一条记录（4，id，_）：关联已存在的记录。（5，_，_）：断开与关联记录的关系，但是不删除关联记录。 原来关联的是多条记录。（6，_，[ids]）：用所提供的列表内的id替换原来的关联记录。 上文介绍中的下划线（_）是一种替代表达，在真正使用的时候请换成0或者False 使用元素可以删除记录1&lt;delete model=&quot;ir.model.access&quot; search=&quot;[(&#x27;id&#x27;,&#x27;=&#x27;,ref(&#x27;bug-manage.user_rule&#x27;))]&quot;/&gt; 知道具体的ID，那么可以这样写1&lt;delete model=&quot;ir.model.access&quot; id=&quot;bug-manage.user_rule_demo&quot;/&gt; 触发函数：在XML加载的过程中，我们可以使用元素触发任何函数1&lt;function model=&quot;bm.bug&quot; name=&quot;bug_set&quot; eval=&quot;[ref(&#x27;bug_1&#x27;),ref(&#x27;bug_2&#x27;)],&#123;&#x27;install_mode&#x27;:True&#125;,&quot;/&gt; 修改数据：文件加载的时候对模型y执行新增或者修改操作，如果记录x已经存在则修改，如果不存在则新建1&lt;record id=&quot;x&quot; model=&quot;y&quot;&gt; 第九章 ORM API基础9.1.2 专有目的装饰器 @api.depends（字段1，字段2，…）装饰器用于计算字段（computed field），可以用于标示需要被触发的计算。使用此装饰器应该注意计算字段（computed field）必须被赋值，否则会就报错。 @api.constraints（字段1，字段2，…）用于评估和检查，当参数字段的值发生变化时，会进行检查，如果检查规则不通过，则字段值不会发生变化，并且会报出一个异常 @api.onchange（字段1，字段2，…）用于系统在与用户进行交互时自动更新相关联的字段，如果金额字段是根据单价和数量自动计算的，那么我们为金额设置自装饰器，当单价发生变化时，金额会自动重新计算。这种变换仅仅发生在用户的UI层面，并没有更新数据库，需要用户保存后才会更新数据库。另外需要注意的是，这种装饰器装饰的方法一般会对应于前端一个form的处理，所以其参数self往往对应于一条记录。 9.2.1 模型写入数据的方法 .create（values）方法可以创建新记录并且可以通过return方法返回。 .write（values）方法可用于更新记录，并且不需要返回值。 .unlink()方法可从数据库删除记录，不需要返回值。 1234@api.modeldef create(self, vals): new_record = super().create(vals) return new_record 以上调用父类的方法使用的是super()方法，这种写法只支持Python3，如果还想兼容Python 2.7，则需要使用super（模型名，self）的写法 9.2.2 使用RPC的网页端方法 read（[fields]）与browse方法类似，但是read方法返回的记录仅包括参数中包含的字段。返回数据的每一行记录都是字典的形式，这些数据可以使用RPC协议进行传输，一般是被客户端程序使用而不是服务器端程序。 search_read（[domain]，[fields]，offset&#x3D;0，limit&#x3D;None，order&#x3D;None）方法可以在结果记录集上面再次执行查找的操作。一般也是由RPC端调用执行的。本方法是被RPC客户端调用执行的，对于基于记录集的二次查找形成的子记录集会保存在客户端。 9.3 数据导入导出方法 load（[fields]，[data]）可用于从CSV文件导入数据。第一个参数列出需要的字段，列的名称直接使用CSV文件第一行的名称。而第二个参数则可以列出需要的记录，每一行记录都可以由其各列的数据组成。这一般是网页端导入数据时使用的方法。 export_data（[fields]，raw_data&#x3D;False）用于从页面端导出数据。这种方法将返回一个字典，字段的数值键包含一个行列表。字段的名称符合8.2节介绍的CSV文件字段的命名规则。比如，外键是在后面加了&#x2F;id后缀的，而且的CSV可以导出成导入兼容类型。 下列方法主要用于UI发起的交互： name_get()方法可返回（ID，name）元组组成的列表，每个元组代表一行记录。一般来说，该方法可默认用于获取display_name，该方法可以被继承增强以实现客制化的需求，比如可以同时显示code和display_name而不是仅显示display_name。 name_search（name&#x3D;’’，args&#x3D;None，operator&#x3D;’ilike’，limit&#x3D;100）可返回（ID，name）元组组成的列表，显示名称将会与参数name的文本进行匹配进而定位记录。一般应用会根据在UI上输入的一个字段去获取该记录的其他字段。 name_create（name）可用于根据名称快速创建一行新记录，该记录在创建时仅具有名称字段。使用的时候可以继承扩展此方法，用于在创建记录时为一些字段设置默认值 default_get（[fields]）可返回一个具有待创建新记录默认值的字典，很多时候默认值将会根据一些变量来生成，比如根据当前用户或者会话上下文的变量。 fields_get()可用于描述模型字段的定义，该定义可以在开发者模式的视图查看界面中看到。 fields_view_get()可用于获取UI视图的结构。使用时可以给出目标视图的ID或者目标视图类型作为参数 9.4 通信API—-mail应用Odoo提供了方便的全局通信和活动规划功能，要使用这些功能可以在Odoo内安装讨论（mail）应用","categories":[{"name":"odoo","slug":"odoo","permalink":"https://dbbruce.github.io/categories/odoo/"},{"name":"基础","slug":"odoo/基础","permalink":"https://dbbruce.github.io/categories/odoo/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"odoo知识点(九)-odoo快速入门与实践总结-第三篇","slug":"odoo/20231001-odoo快速入门与实践总结3","date":"2023-10-03T15:50:52.000Z","updated":"2024-12-06T07:26:07.855Z","comments":true,"path":"2023/10/03/odoo/20231001-odoo快速入门与实践总结3/","link":"","permalink":"https://dbbruce.github.io/2023/10/03/odoo/20231001-odoo%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E4%B8%8E%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%933/","excerpt":"第七章 自建应用进阶特别注意：xml id的名称，点(.)不要乱用，一般的表示点前为模块名，后面为xml id 123&lt;odoo&gt; &lt;data&gt; &lt;record model=&quot;ir.ui.view&quot; id=&quot;bug-manage.bug-manage_form2&quot;&gt; 7.1 模型属性以下划线（_）开头的属性不是普通的属性，我们称之为模型属性。也就是说这些属性的作用不是用于描述记录，而是描述整个模型。 _name：这是Odoo内模型的内部标示，如果我们创建的是一个新模型，则必须填写该属性 _description：是展示给用户看时该模型的一个标题，不是必需的，但推荐最好是使用该模型属性 _order：该属性设置的是该模型的记录集展示时默认的排序字段","text":"第七章 自建应用进阶特别注意：xml id的名称，点(.)不要乱用，一般的表示点前为模块名，后面为xml id 123&lt;odoo&gt; &lt;data&gt; &lt;record model=&quot;ir.ui.view&quot; id=&quot;bug-manage.bug-manage_form2&quot;&gt; 7.1 模型属性以下划线（_）开头的属性不是普通的属性，我们称之为模型属性。也就是说这些属性的作用不是用于描述记录，而是描述整个模型。 _name：这是Odoo内模型的内部标示，如果我们创建的是一个新模型，则必须填写该属性 _description：是展示给用户看时该模型的一个标题，不是必需的，但推荐最好是使用该模型属性 _order：该属性设置的是该模型的记录集展示时默认的排序字段 _rec_name：该模型属性是record name的缩写，可用来指定一个字段作为该记录的描述。一般来讲，Odoo默认使用name字段作为一条记录的描述，我们可以通过这个字段指定其他的字段 _table：是在模型里面制定后台存储数据的数据库表名，该数据库表名是更改模型的名称，把点（.）换成下划线，但是通过这个模型属性制定后，Odoo会根据该属性创建数据库表 7.1.2 self.env[‘x’] - 返回模型x的引用7.1.3 瞬态和抽象模型 瞬态模型：该类模型是基于models.TransientModel类的，一般可用于向导式用户交互，其数据也是存储于数据库表的，只不过是临时存储，会有作业定期从这些表中删除老数据 抽象模型：该类模型是基于models.AbstractModel类的，没有数据库表为其存储数据。抽象模型往往仅仅是为了方便子类复用其字段或方法，自己本身并不需要存储数据 7.1.4 前端页面查看模型结构的方法 设置|模型 如何查找模型的外部ID(或称为XML ID)在开发者模式中，点击debug图标然后选择“查看元数据” 7.1.5 字段属性关键字。 string：前端展现时的字段描述属性，除了Selection和关系字段之外，该属性都是出现在字段内的第一个位置，所以最常见的通过位置使用的属性就是该属性 default：字段的默认值属性，可以是静态值也可以是匿名函数等。上例中的create_on字段就是使用lambda函数给出默认值 size：仅在Char字段中有效，可用于限制最大字符数，比如身份证号的最大长度 translate：在Char、Text和Html字段中起作用，使本字段可翻译 help：进行前端展示时，发送给用户的提示信息 readonly：默认为False，如果设置为True则在前端不可编辑，在模型层通过函数更改数据不会受到影响 required：设置为True则表示在前端使用时本字段不可为空，此项设置对模型层也是有作用的，相当于是在数据库表的字段上进行了非空设置，使用函数在模型里面写入该字段为空的记录也会受到限制 index：如果设置为True则会在对应的数据库字段上添加索引，会提升按该字段进行查询时的效率，同时降低写数据库表的速度。 copy：默认非关系字段是True，如果设置为False则在复制记录时，该字段不被复制。 groups：该字段属性用于限定该字段的访问安全组，通过外部ID进行指定即可访问的安全组，多个外部id之间可以用逗号隔开，比如，groups&#x3D;’base.group_portal，base.group_user’。 states：该属性是通过字典来设置UI的相关属性，readonly、required和invisible三个属性都可以通过该属性进行设置，比如将字段设置为只读states&#x3D;{‘done’：[‘readonly’，True]}。视图中的attr属性与该属性类似，不过attr主要用于根据不同情况切换可见性等应用。 deprecated：如果设置为True，则一旦使用该字段，就会在日志中记录警告信息。 oldname：如果一个字段在新版本中更改了名字，则可以使用该属性记录老版本的名字，这种设置可以在复制记录时使得老版本的数据字段自动复制到对应的新名字字段。 7.2.3 特殊字段 active：是一个布尔类型字段，允许通过该字段将记录设置为非激活状态，如果设置了active&#x3D;False，则在前端查询时该记录会被自动排除在外，这一点类似于逻辑删除。当然也可以通过域（domain）设置查询active&#x3D;True的记录。 sequence：是Integer类型的字段，如果出现在列表视图则允许我们手动拖动记录来定义记录的顺序。如果要使用该字段，那么不要忘记在模型属性_order中引入该字段。 state：Selection类型，其代表了记录生命周期的基本状态，并且可以通过该属性来动态修改视图；一些表单视图字段可以在特定记录状态指定readonly、required和invisible的具体值。 parent_id、parent_left、parent_right：Integer类型，在层级关系中具有特殊的意义 7.2.4 many2one的关系真正的数据还是记录在多（many）一方的底层表中 1bug_ids = fields.One2many(&#x27;bm.bug&#x27;, &#x27;stage_id&#x27;, sting=&#x27;bug&#x27;) ondelete：该参数定义了删除关联记录时本字段的动作，默认是set null，也就是说当关联记录被删除时本字段将被赋值为空。第二个可以赋予的值是restricted，若设置该值则关联记录被删除时会报错进而阻止关联字段被删除。还有一个可选值是cascade，使用本值时关联字段若被删除则本记录也将被删除。 context：该参数是对前端使用具有实际意义的数据字典，用于在进行关系导航时携带信息，比如设置默认值。本参数在后续的章节中会有详细介绍domain：这是一个域表达式，在一个队列中可以使用元组设定查询条件以用于限定查询的数据，具体使用会在后续章节详细介绍。 auto_join：该参数可用于帮助ORM引擎在执行查询时进行一个SQL关联。如果使用，则其将会绕过访问安全规则，用户可以访问权限以外的数据，这将造成很大的风险，不过这样做可以让数据查询更加灵活 7.2.5 many2many关系1234567tag_ids = fields.many2many(&#x27;bm.bug.tag&#x27;, # 关联模型名&#x27;bug_tag_rel&#x27;, # 关联表名&#x27;bug_id&#x27;, # 存储本模型关联字段的字段名称&#x27;tag_id&#x27;, # 存储本模型关联字段的字段名称&#x27;标示&#x27;) 两个多对多关系的模型都不会增加字段。Odoo是通过自动增加第三个关系表来专门维护两个模型的关系。这个关系表中就包含了两个字段，分别存放两个模型里面记录的ID字段中。默认情况下，这个关系表的名称是两个模型表的名称用下划线连接并且在后面加上“_rel”的后缀 7.3.4 层级结构关系123456789101112# -*- coding: utf-8 -*-from odoo import models, fields, apiclass bugTagHierarchy(models.Model): _name = &#x27;bm.bug.tag_hierar&#x27; _description = &#x27;bug层级标示&#x27; _parent_store = True _parent_name = &#x27;parent_id&#x27; name = fields.Char(&#x27;名称&#x27;) parent_id = fields.Many2one(&#x27;bm.bug.tag_hierar&#x27;, &#x27;父标示&#x27;, ondelete=&#x27;restrict&#x27;) parent_left = fields.Integer(&#x27;父节点左侧&#x27;, index=True) parent_right = fields.Integer(&#x27;父节点右侧&#x27;, index=True) 7.3.5 使用引用字段的动态关系在前端的使用上，用户首先选择bug发现者是用户还是合作伙伴，然后再从对应的模型里面选择记录 1discovers = fields.Reference([(&#x27;res.user&#x27;, &#x27;用户&#x27;), (&#x27;res.partner&#x27;, &#x27;合作伙伴&#x27;)], &#x27;bug发现者&#x27;) 7.3.6 计算字段字段中可以使用根据函数自动计算所得的类型，计算字段的声明方式与常规字段是一样的，只是使用了compute参数，参数被赋值为一个函数的名称。 123456name = fields.Char(compute=&#x27;_compute_name&#x27;)@api.multi![ffc3c.png](..%2F..%2Fimages%2Fodoo%2Fffc3c.png)def _compute_name(self): for record in self: record.name = str(random.randint(1,1e6)) 7.4 更多模型继承机制 混合类（mixin classes） 原型继承_name 是模型标识符，修改会创建所继承模型的拷贝，成为一个新模型。这叫作原型继承。 委托继承：这种继承方式使用模型属性_inherits来完成使用代理继承时，原模型的方法并不能被继承。只能继承字段，可以读写子模型的字段","categories":[{"name":"odoo","slug":"odoo","permalink":"https://dbbruce.github.io/categories/odoo/"},{"name":"基础","slug":"odoo/基础","permalink":"https://dbbruce.github.io/categories/odoo/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"odoo知识点(八)-odoo快速入门与实践总结-第二篇","slug":"odoo/20231001-odoo快速入门与实践总结2","date":"2023-10-02T15:50:52.000Z","updated":"2024-12-06T01:41:19.101Z","comments":true,"path":"2023/10/02/odoo/20231001-odoo快速入门与实践总结2/","link":"","permalink":"https://dbbruce.github.io/2023/10/02/odoo/20231001-odoo%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E4%B8%8E%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%932/","excerpt":"第6章 自建应用入门6.1.文件__manifest__.py 该文件中列出了包含哪些视图、模型和演示数据，并且还可以配置本模块说明等基本信息，每个模块都必须包含这个文件 参数 说明 name 代表该模块（或应用）的名字 summary 该模块的简介。因为用的是三引号，文字描述是可以换行的。 description 模块描述，也是可以换行的 author 作者 website 可以写上本模块相关的网址 category 默认为Uncategorized。可以选择已有的分类，在前端页面设置，群组内打开一个群组，然后点开应用程序下拉框，使用里面 列举的分类 version 默认是0.1，可以辅助进行模块的版本管理 depends 默认是base模块，可以在后面继续添加依赖的其他模块，当本模块被安装时，Odoo也会自动安装此处的依赖，如果依赖安装报错则本模块也将无法安装，所以要仔细检查写在此处的模块是否已经准备好安装包 data 我们需要用到的views文件夹下的视图文件可以在这里配置 demo 如果选择了加载演示数据，则这部分配置将会起作用 installable 默认是True，如果不想从前端搜到，则可以设置为False auto_install 如果设置为True，则在depends参数的模块都安装完成之后，自动安装本模块，这种方式一般用于处理两个模块需要配合使用的情况 6.2.使用脚手架创建新模块","text":"第6章 自建应用入门6.1.文件__manifest__.py 该文件中列出了包含哪些视图、模型和演示数据，并且还可以配置本模块说明等基本信息，每个模块都必须包含这个文件 参数 说明 name 代表该模块（或应用）的名字 summary 该模块的简介。因为用的是三引号，文字描述是可以换行的。 description 模块描述，也是可以换行的 author 作者 website 可以写上本模块相关的网址 category 默认为Uncategorized。可以选择已有的分类，在前端页面设置，群组内打开一个群组，然后点开应用程序下拉框，使用里面 列举的分类 version 默认是0.1，可以辅助进行模块的版本管理 depends 默认是base模块，可以在后面继续添加依赖的其他模块，当本模块被安装时，Odoo也会自动安装此处的依赖，如果依赖安装报错则本模块也将无法安装，所以要仔细检查写在此处的模块是否已经准备好安装包 data 我们需要用到的views文件夹下的视图文件可以在这里配置 demo 如果选择了加载演示数据，则这部分配置将会起作用 installable 默认是True，如果不想从前端搜到，则可以设置为False auto_install 如果设置为True，则在depends参数的模块都安装完成之后，自动安装本模块，这种方式一般用于处理两个模块需要配合使用的情况 6.2.使用脚手架创建新模块 123456789101112131415161718192021./odoo-bin scaffold bug-manage custom_addons (odoo16) dbbruce@dbburce custom_addons % tree bug-manage bug-manage├── __init__.py├── __manifest__.py├── controllers│ ├── __init__.py│ └── controllers.py├── demo # 演示数据│ └── demo.xml├── models│ ├── __init__.py│ └── models.py├── security # 安全控制文件│ └── ir.model.access.csv└── views # views下面是XML文件，用于配置视图 ├── templates.xml └── views.xml6 directories, 10 files 6.3.安装步骤 1）点击设置界面右下角的激活开发者模式进入开发者模式 2）在应用界面点击左侧更新应用列表按钮，在弹出的对话框中点击更新按钮 3）然后在右上方的搜索框内搜索“bug” 安装使用的也是base模块，具体是ir.mudule.module这里可以安装和更新应用 安装的时候也可以将-u转换成-i 6.4.不重启代码生效 修改了Python代码之后不重启服务器就能让修改起作用，那么可以使用Odoo的服务器开发模式，只需要再加上一个参数 -dev&#x3D;all 即可 6.5.添加图标 创建路径&#x2F;static&#x2F;description，将图标命名为icon.png并且放在本路径下 6.6.模型12345678910111213141516# -*- coding: utf-8 -*-from odoo import models, fields, apiclass bug(models.Model): _name = &#x27;bm.bug&#x27; _description = &#x27;bug&#x27; name = fields.Char(&#x27;bug简述&#x27;, required=True) detail = fields.Text(size=150) is_closed = fields.Boolean(&#x27;是否关闭&#x27;) close_reason = fields.Selection([(&#x27;changed&#x27;, &#x27;已修改&#x27;), (&#x27;cannot&#x27;, &#x27;无法修改&#x27;), (&#x27;delay&#x27;, &#x27;推迟&#x27;)], string=&#x27;关闭理由&#x27;) user_id = fields.Many2one(&#x27;res.users&#x27;, string=&#x27;负责人&#x27;) follower_id = fields.Many2many(&#x27;res.partner&#x27;, string=&#x27;关注者&#x27;) 6.7.模型继承 Odoo提供了两种模型的继承机制，具体如下 传统继承机制：允许子类修改父类定义方法、字段，也允许新增字段和方法 委派：将子类中新增的字段与父类的字段进行关联，相当于保留了父类的字段和方法 12345678# -*- coding: utf-8 -*-from odoo import models, fields, api# 传统继承class follower(models.Model): _inherit = &#x27;res.partner&#x27; bug_ids = fields.Many2many(&#x27;bm.bug&#x27;, string=&#x27;bug&#x27;) 数据的存储方式也是不同的，可以分为两大类 使用_inherit指明父类的同时，若_name赋值为一个与父类不一样的名称，则存储在不同的底层表中，子类不能兼容使用父类的视图，子类复制父类的特征再加上自己扩展的特征重新建立一个对象。 _name赋值为一个与父类不同的名称，而且使用_inherits（注意这里多了一个“s”），则说明可以同时继承多个类，新的子类对象会关联父类的对象数据，如果父类有新增数据，那么子类对象也可以同步看到。这种方式也不能兼容使用父类的视图 在models&#x2F;init.py文件中引入这两个新文件 12345# -*- coding: utf-8 -*-from . import modelsfrom . import bugsfrom . import follower 6.8.新增菜单12345678910111213141516&lt;odoo&gt; &lt;data&gt; &lt;!-- actions opening views on models --&gt; &lt;record model=&quot;ir.actions.act_window&quot; id=&quot;bug-manage.action_window&quot;&gt; &lt;field name=&quot;name&quot;&gt;bug-manage window&lt;/field&gt; &lt;field name=&quot;res_model&quot;&gt;bm.bug&lt;/field&gt; &lt;field name=&quot;view_mode&quot;&gt;tree,form&lt;/field&gt; &lt;/record&gt; &lt;!-- Top menu item --&gt; &lt;menuitem name=&quot;bug管理系统&quot; id=&quot;bug-manage.menu_root&quot;/&gt; &lt;!-- menu categories --&gt; &lt;menuitem name=&quot;bug管理&quot; id=&quot;bug-manage.menu_1&quot; parent=&quot;bug-manage.menu_root&quot;/&gt; &lt;!-- actions --&gt; &lt;menuitem name=&quot;bug列表&quot; id=&quot;bug-manage.menu_1_list&quot; parent=&quot;bug-manage.menu_1&quot; action=&quot;bug-manage.action_window&quot;/&gt; &lt;/data&gt;&lt;/odoo&gt; 窗口动作（window action 用于将模型的数据显示出来，所有的窗口动作都存储在数据库的 “ir.actions.act_window”模型中 这里使用向该模型中新增我们定义的窗口动作记录。其中主要的属性有如下几个 model属性 标示该元素为窗口动作，标明本记录要插入的模型 id属性 必须在整个Odoo应用中唯一，如果不唯一则会在安装时报错，即便与之发生冲突的id所在的模块还没有安装也会报错。而且id的命名规则是最多只能有一个点（.） res_model 代表视图取数的模型 view_mode 代表按顺序展示的视图类型 可用于定义一个ir.ui.menu，不使用parent属性的时候则为顶级菜单 6.9.使用超级管理员查看应用，否则看不到应用6.10.列表视图 Tree custom_addons&#x2F;bug-manage&#x2F;views&#x2F;bugs.xml 1234567891011&lt;record model=&quot;ir.ui.view&quot; id=&quot;bug-manage.list&quot;&gt; &lt;field name=&quot;name&quot;&gt;bug列表&lt;/field&gt; &lt;field name=&quot;model&quot;&gt;bm.bug&lt;/field&gt; &lt;field name=&quot;arch&quot; type=&quot;xml&quot;&gt; &lt;tree&gt; &lt;field name=&quot;name&quot;/&gt; &lt;field name=&quot;is_closed&quot;/&gt; &lt;field name=&quot;user_id&quot;/&gt; &lt;/tree&gt; &lt;/field&gt;&lt;/record&gt; 6.11.列表视图 Form custom_addons&#x2F;bug-manage&#x2F;views&#x2F;bugs.xml odoo16版本：model里需要定义do_close方法，否则会报错12def do_close(self): pass 1234567891011121314151617181920212223242526272829&lt;record model=&quot;ir.ui.view&quot; id=&quot;bug-manage.form&quot;&gt; &lt;field name=&quot;name&quot;&gt;bug表单&lt;/field&gt; &lt;field name=&quot;model&quot;&gt;bm.bug&lt;/field&gt; &lt;field name=&quot;arch&quot; type=&quot;xml&quot;&gt; &lt;form&gt; &lt;header&gt; &lt;button name=&quot;do_close&quot; type=&quot;object&quot; string=&quot;关闭bug&quot;/&gt; &lt;/header&gt; &lt;sheet&gt; &lt;group name=&quot;group_top&quot; col=&quot;2&quot;&gt; &lt;group name=&quot;group_left&quot;&gt; &lt;field name=&quot;name&quot;/&gt; &lt;field name=&quot;user_id&quot;/&gt; &lt;field name=&quot;is_closed&quot;/&gt; &lt;/group&gt; &lt;group name=&quot;group_right&quot;&gt; &lt;field name=&quot;close_reason&quot; /&gt; &lt;field name=&quot;follower_id&quot; /&gt; &lt;/group&gt; &lt;/group&gt; &lt;notebook&gt; &lt;page string=&quot;详细内容&quot;&gt; &lt;field name=&quot;detail&quot;/&gt; &lt;/page&gt; &lt;/notebook&gt; &lt;/sheet&gt; &lt;/form&gt; &lt;/field&gt;&lt;/record&gt; 6.12.搜索视图 Search custom_addons&#x2F;bug-manage&#x2F;views&#x2F;bugs.xml 1234567891011&lt;record model=&quot;ir.ui.view&quot; id=&quot;bug-amnage.search&quot;&gt; &lt;field name=&quot;name&quot;&gt;bug搜索&lt;/field&gt; &lt;field name=&quot;model&quot;&gt;bm.bug&lt;/field&gt; &lt;field name=&quot;arch&quot; type=&quot;xml&quot;&gt; &lt;search&gt; &lt;field name=&quot;name&quot;/&gt; &lt;field name=&quot;is_closed&quot;/&gt; &lt;field name=&quot;user_id&quot;/&gt; &lt;/search&gt; &lt;/field&gt;&lt;/record&gt; 6.13.视图继承 inherit_id 第一步就是要确定具体继承自哪一个视图，进入设置|用户界面|视图界面，可以看到第一条记录就是“res.partner”的form视图，而且其序列是1，其外部ID是base.view_partner_form，在继承修改的时候一定要使用外部ID。 第二步需要找到具体的锚点，以此来确认我们的bug_ids最终会加在视图的哪个位置，通常是寻找一个有name属性的元素。这里我们以元素为锚点 视图继承：ref后是External ID : views&#x2F;follower.xml 1234567891011121314&lt;odoo&gt; &lt;data&gt; &lt;record model=&quot;ir.ui.view&quot; id=&quot;bug-manage.follower_form&quot;&gt; &lt;field name=&quot;name&quot;&gt;关注者&lt;/field&gt; &lt;field name=&quot;model&quot;&gt;res.partner&lt;/field&gt; &lt;field name=&quot;inherit_id&quot; ref=&quot;base.view_partner_form&quot;/&gt; &lt;field name=&quot;arch&quot; type=&quot;xml&quot;&gt; &lt;field name=&quot;mobile&quot; position=&quot;after&quot;&gt; &lt;field name=&quot;bug_ids&quot;/&gt; &lt;/field&gt; &lt;/field&gt; &lt;/record&gt; &lt;/data&gt;&lt;/odoo&gt; 6.14.访问控制 存储的数据表：ir.model.access ir.model.access.csv，文件名与模型名是一样的，名称不可以更改，Odoo会将文件的数据写入对应的模型中。 不要忘记到__manifest__.py文件中引入该csv文件 行级访问规则的具体记录是存在模型ir.rule模型中 字段名 描述 例子 id 是该记录的唯一标示，在模块内具有唯一性 access_bm_bug name 该记录的名称，也具有唯一性，一般的命名方法是用点 （.）连接模块名和安全组名 bm.bug model_id:id 是设置访问权限的模块_name，model_id的命名规则比较固定，比如我们的bug管理模型的_name是bm.bug，那么model_id就是model_bm_bug model_bm_bug group_id:id 这就是我们要授予权限的安全组的id，本处我们为员工组授权，其id是base.group_user base.group_user perm_read 读 1 perm_write 写 1 perm_create 新建 1 perm_unlink 删除 1 6.15.新建一个网页 编写controller bug-manage&#x2F;controllers&#x2F;controllers.py 123456789# -*- coding: utf-8 -*-from odoo import httpclass Bug(http.Controller): @http.route(&#x27;/bug-manage&#x27;) # 地址 def BugManage(self, **kwargs): bugs = http.request.env[&#x27;bm.bug&#x27;] domain_bug = [(&#x27;is_closed&#x27;, &#x27;=&#x27;, False)] bugs_open = bugs.search(domain_bug) return http.request.render(&#x27;bug-manage.bugs_template&#x27;, &#123;&#x27;bugs_open&#x27;: bugs_open&#125;) 编写模板，QWeb模板是视图,也是存储在base模块的ir.ui.view模型 bug-manage&#x2F;views&#x2F;bugs_template.xml 12345678910111213&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;odoo&gt; &lt;template id=&quot;bugs_template&quot; name=&quot;bugs&quot;&gt; # 这里对应上面的模板名称 &lt;div class=&quot;container&quot;&gt; &lt;h1&gt;未关闭bug&lt;/h1&gt; &lt;t t-foreach=&quot;bugs_open&quot; t-as=&quot;bug&quot;&gt; &lt;div class=&quot;row&quot;&gt; &lt;span t-field=&quot;bug.name&quot;/&gt; &lt;/div&gt; &lt;/t&gt; &lt;/div&gt; &lt;/template&gt;&lt;/odoo&gt; SELECT * FROM ir_ui_view ORDER BY id DESC; manifest.py引入xml 升级app 访问http://localhost:8069/bug-manage","categories":[{"name":"odoo","slug":"odoo","permalink":"https://dbbruce.github.io/categories/odoo/"},{"name":"基础","slug":"odoo/基础","permalink":"https://dbbruce.github.io/categories/odoo/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"odoo知识点(七)-odoo快速入门与实践总结-第一篇","slug":"odoo/20231001-odoo快速入门与实践总结1","date":"2023-10-01T15:50:52.000Z","updated":"2024-11-27T10:54:57.345Z","comments":true,"path":"2023/10/01/odoo/20231001-odoo快速入门与实践总结1/","link":"","permalink":"https://dbbruce.github.io/2023/10/01/odoo/20231001-odoo%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E4%B8%8E%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%931/","excerpt":"第一章 参考mac安装odoo16 第二章2.1.odoo shell 需要指定数据库：-d 数据库名1./odoo-bin shell -d odoo16_db","text":"第一章 参考mac安装odoo16 第二章2.1.odoo shell 需要指定数据库：-d 数据库名1./odoo-bin shell -d odoo16_db 2.2.配置文件中的参数 参数 参数名 作用 addons_path 使用逗号（，）分隔扩展路径，会在路径中寻找模块，从左至右阅读，最左侧拥有最高的优先级 admin_passwd 数据库管理页面操作的密码，访问时不需要密码，操作数据库备份，复制，删除时会用的这个密码 db_user 数据库实例，在服务器启动序列期间进行初始化 dbfilter 用于筛选可访问的数据库，它是Python interpreted正则表达式，用于不让用户选择数据库，以及使未验证的URL能够正常工作，它应该以^dbname$格式进行设置，例如dbfilter&#x3D;^odoo-prod$。它支持%h和%d占位符，可用来作为HTTP请求的主机名和子域名 logfile 日志文件，通常位于&#x2F;var&#x2F;log中，若留空，或者设置为False，则日志会以标准方式进行输出 logrotate&#x3D;True 表示按天存放日志 proxy_mode 当使用反向代理时，应将其设为True without_demo 在生产环境中应将其设为True，这样新的数据库中就不会再有演示数据 workers 其值为启用的处理器数量 xmlrpc_port 服务监听的端口号。默认使用8069 data_dir 会话数据和附件存储的位置，应记得备份它 xmlrpc-interface 设置监听的地址。默认值会监听所有端口0.0.0.0，在使用反向代理时，可以设置为127.0.0.1，目的是只对本地请求响应 日志格式123456789[options]is_upgrade = Falseadmin_passwd = xxxxxxdb_host = xxxxxxdb_port = 5432db_user = odoo db_password = xxxxxxxxxxlogfile = .db.log# log_level = debug_sql 2.3.pycharm支持远程开发 菜单Tools → Deployment → Configuration 2.4.odoo16 debug http://192.168.30.60:8069/web?debug=1#id=2&amp;cids=1&amp;menu_id=4&amp;action=70&amp;model=res.users&amp;view_type=form 第三章3.1.激活开发者模式(tests)和激活开发者模式(assets)1激活开发者模式(assets): 会加载页面需要的JS和CSS资源，但这会导致页面的浏览速度有所下降 3.2.res.parter1系统内人员相关的常用模型就是res.parter, Odoo系统内的客户、供应商、联系人等都继承使用了这个模型 3.3.安装 contacts(联系人) app步骤 1.搜索 → 安装 activate 2.update apps list 3.查看 3.4.model 添加字段 设置|技术|数据库结构|模型 前端创建的字段必须 x_ 开通，后端创建的字段没有这个限制123字段名称：x_is_teacher字段类型：boolean字段标签：是否教师 1此时，我们的字段就已被添加到字段列表中，但在第一个页面我们还无法看到，需要点击右上方的切换箭头来查看最后一页的信息 1修改了模型，但用户在前端却是看不到这个字段的，我们需要通过单独的视图修改步骤来让用户看到这个新增的字段 3.5.view 添加字段 view继承需要用到外部ID（External ID），本例的外部ID是base.view_partner_form，外部ID第一个点之前的字符代表模块插件的名称，可以看出，当前的视图属于base模块 切换tab到views 视图有多种类型，包括表单、树形&#x2F;列表、搜索（search）或看板 搜索视图实际上就是对顶部可用的过滤器的定义 树形&#x2F;列表的显示形式其实都是列表，在具体使用的时候可以用tree也可以用list，之所以这样是因为列表用的是tree。 视图可以继承基本视图进行扩展，一个扩展视图可以继承多个视图 编辑视图方法123首先，点击上方的联系人按钮（前面已经安装过），这时可以看到页面显示出了一些联系人的图标。然后，我们随便选择一个联系人，点击打开进入详细界面。第三步，点开右上角的调试按钮，并选择编辑表单视图按钮 加一个field12345678910111213&lt;group&gt; &lt;field name=&quot;function&quot; placeholder=&quot;e.g. Sales Director&quot; attrs=&quot;&#123;&#x27;invisible&#x27;: [(&#x27;is_company&#x27;,&#x27;=&#x27;, True)]&#125;&quot;/&gt; &lt;field name=&quot;phone&quot; widget=&quot;phone&quot;/&gt; &lt;field name=&quot;mobile&quot; widget=&quot;phone&quot;/&gt; &lt;field name=&quot;user_ids&quot; invisible=&quot;1&quot;/&gt; &lt;field name=&quot;email&quot; widget=&quot;email&quot; context=&quot;&#123;&#x27;gravatar_image&#x27;: True&#125;&quot; attrs=&quot;&#123;&#x27;required&#x27;: [(&#x27;user_ids&#x27;,&#x27;!=&#x27;, [])]&#125;&quot;/&gt; &lt;field name=&quot;website&quot; string=&quot;Website&quot; widget=&quot;url&quot; placeholder=&quot;e.g. https://www.odoo.com&quot;/&gt; &lt;field name=&quot;title&quot; options=&quot;&#123;&amp;quot;no_open&amp;quot;: True&#125;&quot; placeholder=&quot;e.g. Mister&quot; attrs=&quot;&#123;&#x27;invisible&#x27;: [(&#x27;is_company&#x27;, &#x27;=&#x27;, True)]&#125;&quot;/&gt; &lt;field name=&quot;active_lang_count&quot; invisible=&quot;1&quot;/&gt; &lt;field name=&quot;lang&quot; attrs=&quot;&#123;&#x27;invisible&#x27;: [(&#x27;active_lang_count&#x27;, &#x27;&amp;lt;=&#x27;, 1)]&#125;&quot;/&gt; &lt;field name=&quot;category_id&quot; widget=&quot;many2many_tags&quot; options=&quot;&#123;&#x27;color_field&#x27;: &#x27;color&#x27;, &#x27;no_create_edit&#x27;: True&#125;&quot; placeholder=&quot;e.g. &amp;quot;B2B&amp;quot;, &amp;quot;VIP&amp;quot;, &amp;quot;Consulting&amp;quot;, ...&quot;/&gt; &lt;field name=&quot;x_is_teacher&quot;/&gt;&lt;/group&gt; 3.6.新建菜单 设置|用户界面|菜单项目 3.7.动作 动作可分为多种类型，最重要的有Window Actions、Reports Actions和Server 123Window Actions用于处理在前端展示的视图Reports Actions用于运行报表Server Actions则用于定义自动执行的任务 windows action加domain 域值（domain）字段，该字段的值可以是一个表达式1[(&#x27;x_is_teacher&#x27;,&#x27;=&#x27;,True)] 复选框是默认选中的。可以使用上下文值（context）字段来完成该功能。context是Odoo传递会话消息的方式，包括默认值的处理。{‘default_x_is_teacher’:True}1&#123;&#x27;default_x_is_teacher&#x27;:True&#125; 3.8.新建自定义模型 设置|数据库结构|模型 保存这个模型，然后再编辑，可以看到在保存后系统自动为这个模型增加了多个字段，它们是ORM引擎为每个模型都会增加的字段 1[(&#x27;x_is_teacher&#x27;, &#x27;=&#x27;, True)] 3.9.新建课程前端界面 设置|用户界面|菜单项目12345菜单：课程上级菜单：教师授课（搜索找到）动作：下拉列表选择ir.actions.act_window，然后在右侧新出现的下拉框中选择创建并编辑按钮，在弹出的窗口中输入以下字段信息： 动作名称：课程 对象：x_course 3.7.新建视图 设置|用户界面|视图 Tree视图1234&lt;tree&gt; &lt;field name=&quot;x_name&quot;/&gt; &lt;field name=&quot;x_teacher_ids&quot; widget=&quot;many2many_tags&quot;/&gt;&lt;/tree&gt; Form视图123456&lt;form&gt; &lt;group&gt; &lt;field name=&quot;x_name&quot;/&gt; &lt;field name=&quot;x_teacher_ids&quot; widget=&quot;many2many_tags&quot; context=&quot;&#123;&#x27;default_x_is_teacher&#x27;:True&#125;&quot;/&gt; &lt;/group&gt;&lt;/form&gt; 3.8.安全性配置 Odoo有其内置的访问控制机制，可以通过这个机制来对用户进行授权管理，以确保用户只能访问被授权的应用。不过，admin用户是个例外，为了开发的方便，此用户不受该控制机制的限制。 访问控制机制是基于组的，对于该组授权的模型、菜单等可以被该组内的用户访问。 对于控制的粒度，这种机制可以支持的粒度细到字段甚至数据记录（具有记录规则）。 这种安全组也被用于应用插件访问的控制，并且每个应用插件一般至少会提供两个组：处理日常事务的用户组和管理该应用插件所有配置的管理组并且每个应用插件一般至少会提供两个组：处理日常事务的用户组和管理该应用插件所有配置的管理组。 设置|群组 选择权限tab12345对象：选择x_course应用读访问：选中写访问：选中创建访问：选中删除访问：选中 3.9.用户授权 3.10.base模块base模块中的模型主要可分为两种，具体如下： 信息资源库（Information Repository）：其模块的外部ID一般是以 “ir.” 开头1234567信息资源库可用于存储一些基础功能，Odoo使用这些基础功能来识别菜单、视图、模型和动作等.ir.action.act_window，作用是帮助设置窗口的动作。·ir.ui.menu，设置菜单。·ir.ui.view，用于处理视图。·ir.model，用于模型。·ir.model.fields，用于处理模型的字段。 资源（Resource）：其模块的外部ID一般是以 “res.” 开头12345678资源模块包含了与国际化相关的一些模型，所有的模型都提供了底层的服务，里面包含的主要模型具体如下·res.partner，诸如客户、供应商或联系人等都是基于这个模型。·res.company，设置与公司相关的信息。·res.currency，处理与货币相关的功能。·res.country，处理与国家相关的设置信息。·res.users，用于处理与用户相关的功能。·res.groups，与安全组相关的功能都是基于这个模型。 第4章4.1.self的运行机制123456789假如我们有一个类其名称为MyClass，该类有一个实例为MyObject，当我们通过对象调用方法的时候可使用如下示例方法：MyObject.method(arg1,arg2)Python在执行的时候会将该方法自动转换为:MyClass.method(MyObject,arg1,arg2)上面的MyObject可以转换成我们最常用的self，所以这也解释了为什么Python里面所有的方法都至少有一个self参数。哪怕不需要参数，也需要定义一个self参数 4.2.init12当类的一个对象被创建时，__init__方法马上就会运行，所以初始化需要做的事情都可以写在这个方法内。这里需要注意的是，init前后都是双下划线 4.3.基础重载方法12345.__init__（self[，args…]）：构造函数；简单的调用方法：obj=className（args）·__del__（self）：析构方法，删除一个对象；简单的调用方法：del obj·__repr__（self）：转化为供解释器读取的形式；简单的调用方法：repr（obj）·__str__（self）：用于将值转化为适合人阅读的形式；简单的调用方法：str（obj）·__cmp__（self，x）：对象比较；简单的调用方法：cmp（obj，x） 第5章5.1.查询同时保存1select * into new_table from old_table where ... 5.2.更新1update table_name set column1=value1 或者 column1=column2（用字段2的内容给字段1赋值） where ... 5.3.删除1delete from table_name where [condition];","categories":[{"name":"odoo","slug":"odoo","permalink":"https://dbbruce.github.io/categories/odoo/"},{"name":"基础","slug":"odoo/基础","permalink":"https://dbbruce.github.io/categories/odoo/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"9月份","slug":"每月概要/2023/202309","date":"2023-09-28T10:08:28.000Z","updated":"2024-06-16T14:21:46.000Z","comments":true,"path":"2023/09/28/每月概要/2023/202309/","link":"","permalink":"https://dbbruce.github.io/2023/09/28/%E6%AF%8F%E6%9C%88%E6%A6%82%E8%A6%81/2023/202309/","excerpt":"1.可变参数：*args 与 **kwargs的一些区别1*args 与 **kwargs 连用，*args必须放在前面 12def f1(*args, **kwargs): pass **kwargs的使用 1234567def keyFunc(**kwargs): print(type(kwargs)) print(kwargs)d1 = &#123;&#x27;a&#x27;:&#x27;a&#x27;, &#x27;2&#x27;:2, &#x27;c&#x27;:3&#125;keyFunc(**d1)&lt;class &#x27;dict&#x27;&gt;&#123;&#x27;a&#x27;: &#x27;a&#x27;, &#x27;2&#x27;: 2, &#x27;c&#x27;: 3&#125;","text":"1.可变参数：*args 与 **kwargs的一些区别1*args 与 **kwargs 连用，*args必须放在前面 12def f1(*args, **kwargs): pass **kwargs的使用 1234567def keyFunc(**kwargs): print(type(kwargs)) print(kwargs)d1 = &#123;&#x27;a&#x27;:&#x27;a&#x27;, &#x27;2&#x27;:2, &#x27;c&#x27;:3&#125;keyFunc(**d1)&lt;class &#x27;dict&#x27;&gt;&#123;&#x27;a&#x27;: &#x27;a&#x27;, &#x27;2&#x27;: 2, &#x27;c&#x27;: 3&#125; *args的使用 123456789101112131415161718def keyFunc2(*args): print(type(args)) print(args) print(args[0])l1 = [&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;, &#x27;d&#x27;]# 下面三种传值方式有区别keyFunc2(*l1) keyFunc2(l1)keyFunc2([1,2,3,4])# 三种结果&lt;class &#x27;tuple&#x27;&gt;(&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;, &#x27;d&#x27;)&lt;class &#x27;tuple&#x27;&gt;([&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;, &#x27;d&#x27;],)&lt;class &#x27;tuple&#x27;&gt;([&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;, &#x27;d&#x27;],) 2.匿名函数123lambda 参数1，参数2，参数3: 执行代码函数名 = lambda 参数1，参数2，参数3: 执行代码 3.递归函数: 函数内部调用自己1234567def factorial(n): &#x27;&#x27;&#x27; 求阶层：5! = 5*4*3*2*1 &#x27;&#x27;&#x27; if n == 1: return 1 return n * factorial(n-1) 4.可变数据（3 个）：List（列表）、Dictionary（字典）、Set（集合）5.init()内外的变量差异在init()方法内部定义的变量是实例属性，而在init()方法外部定义的变量是类属性。实例属性只能通过某个实例来访问，而类属性可以通过类名或实例来访问 123456789101112131415class Car: color = &quot;red&quot; def __init__(self, brand): self.brand = brand def get_color(self): return self.color def set_color(self, new_color): self.color = new_colorcar1 = Car(&quot;Toyota&quot;)print(car1.get_color()) # 输出：redcar2 = Car(&quot;BMW&quot;)car2.set_color(&quot;blue&quot;)print(car2.get_color()) # 输出：blueprint(car1.get_color()) # 输出：red 6.self和对象指向同一个内存地址，可以认为self就是对象引用12345678class Car: def get_color(self): print(id(self)) return self.colora = Car(&#x27;a&#x27;)print(a.get_color())print(id(a)) 7.单例模式123456789101112131415161718192021222324252627282930def Singleton(cls): _instance = &#123;&#125; def _singleton(*args, **kargs): if cls not in _instance: _instance[cls] = cls(*args, **kargs) return _instance[cls] return _singleton@Singletonclass Car: def __init__(self, args): self.color = args def get_color(self): print(id(self)) return self.colora = Car(&quot;green&quot;)print(a.get_color())print(id(a))b = Car(&quot;blue&quot;)print(b.get_color())print(id(b))green45623581284562358128green4562358128 8.继承D ,C 都继承B；mm继承D，C；广度优先；使用C里的eat方法 123456789101112131415class B: def eat(self): print(&quot;b.eat&quot;)class C(B): def eat(self): print(&quot;c.eat&quot;)class D(B): passclass mm(D, C): passm = mm()m.eat() D 继承B,C继承A；mm继承D，C；深度优先；使用B里的eat方法 123456789101112131415161718class A: def eat(self): print(&quot;a.eat&quot;)class B: def eat(self): print(&quot;b.eat&quot;)class C(A): def eat(self): print(&quot;c.eat&quot;)class D(B): passclass mm(D, C): passm = mm()m.eat() 9.多态：定义时的类型，和运行时的类型不一样10.property(), 顺序不能乱，123456class property([fget[, fset[, fdel[, doc]]]])参数fget -- 获取属性值的函数fset -- 设置属性值的函数fdel -- 删除属性值函数doc -- 属性描述信息 12345678910class C(object): def __init__(self): self._x = None def getx(self): return self._x def setx(self, value): self._x = value def delx(self): del self._x x = property(getx, setx, delx, &quot;I&#x27;m the &#x27;x&#x27; property.&quot;) 11.异常12345678try: 代码块except: 出错后执行的代码else: 没有出错执行的代码finally: 无论对错都执行的代码 12.slotspython支持动态添加属性和方法，为了限制，使用slots 12class Student(object): __slots__ = (&#x27;name&#x27;, &#x27;age&#x27;) # 用tuple定义允许绑定的属性名称 13.Python垃圾回收机制1详情看这个讲的非常好：https://www.jianshu.com/p/1e375fb40506 python采用的是引用计数机制为主，标记-清除和分代收集两种机制为辅的策略 引用计数机制：12345678910111213141516171819202122232425Python引用计数机制是一种内存管理技术，它通过计算对象的引用次数来判断该对象是否仍然在使用中。在Python中，每个对象都有一个引用计数器，用于记录当前有多少个变量指向该对象。当一个对象被创建时，它的引用计数器被初始化为1，每当一个变量指向该对象时，引用计数器增加1，当一个变量不再指向该对象时，引用计数器减少1。当一个对象的引用计数器为0时，Python将自动回收它所占用的内存空间。如何实现引用计数机制Python引用计数机制的实现方式很简单，当一个对象被创建时，Python会为该对象分配一块内存，并在这块内存中记录该对象的引用计数器。每当一个变量指向该对象时，该对象的引用计数器就会增加1，当一个变量不再指向该对象时，引用计数器就会减少1。当一个对象的引用计数器为0时，Python将自动回收它所占用的内存空间。引用计数机制的优点和缺点引用计数机制有以下优点：实现简单，执行速度快。内存管理方便，可以避免内存泄漏和垃圾回收问题。可以节省内存空间，减少系统开销。但引用计数机制也存在一些缺点：无法处理引用循环问题，需要使用其他机制来解决。频繁创建和销毁对象会影响性能。无法处理动态类型转换的问题。引用计数机制的使用场景在Python中，引用计数机制广泛应用于各种数据类型，如列表、字典、元组和类实例等。引用计数机制的优势在于可以及时释放不需要的内存空间，从而避免内存泄漏的问题。此外，由于引用计数机制的执行速度很快，因此它也被广泛应用于大型应用程序和框架中。如何处理引用循环问题引用循环指的是两个或多个对象相互引用，导致没有任何一个对象的引用计数器为0，从而无法自动回收内存空间。为了解决引用循环问题，Python使用了垃圾回收机制（Garbage Collection）。在Python中，垃圾回收机制会定期检查所有对象的引用计数器，并标记不再使用的对象。当所有引用计数器都为0时，即表示这些对象已经不再使用，垃圾回收机制会将它们从内存中删除。在Python中，垃圾回收机制主要有以下两种方式：标记清除：该方法会遍历所有对象，并标记不再使用的对象，之后再统一删除这些对象。分代回收：该方法将所有对象分为三代，每一代的对象都有不同的生命周期和垃圾回收方式。 1234567891011121314151617181920212223242526272829303132# 定义一个函数，返回一个列表对象def get_list(): return [1, 2, 3]# 获取列表对象，并打印它的引用计数器值lst = get_list()print(sys.getrefcount(lst)) # 输出2，因为lst和get_list()都指向该对象# 删除lst对象，再次打印引用计数器值del lstprint(sys.getrefcount(lst)) # 报错，因为该对象已经被删除# 定义两个类，模拟引用循环问题class A: def __init__(self): self.b = Noneclass B: def __init__(self): self.a = None# 创建两个对象，并相互引用a = A()b = B()a.b = bb.a = a# 手动删除对象a.b = Noneb.a = Nonedel adel b 14.小整数，大整数小整数 [-5, 256]:这些整数提前建好，放在内存中，不会被垃圾回收大整数 ：临时创建，垃圾回收 15.模块导入顺序1231.标准库导入2.相关的第三方进口3.本地应用程序/库特定的导入您应该在每组导入之间留出空行","categories":[{"name":"每月概要","slug":"每月概要","permalink":"https://dbbruce.github.io/categories/%E6%AF%8F%E6%9C%88%E6%A6%82%E8%A6%81/"},{"name":"2023","slug":"每月概要/2023","permalink":"https://dbbruce.github.io/categories/%E6%AF%8F%E6%9C%88%E6%A6%82%E8%A6%81/2023/"}],"tags":[]},{"title":"销售订单物料过滤函数","slug":"项目/医药公司ERP/20230927-销售订单物料过滤函数","date":"2023-09-27T15:50:52.000Z","updated":"2024-11-29T02:15:38.609Z","comments":true,"path":"2023/09/27/项目/医药公司ERP/20230927-销售订单物料过滤函数/","link":"","permalink":"https://dbbruce.github.io/2023/09/27/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/20230927-%E9%94%80%E5%94%AE%E8%AE%A2%E5%8D%95%E7%89%A9%E6%96%99%E8%BF%87%E6%BB%A4%E5%87%BD%E6%95%B0/","excerpt":"销售订单物料","text":"销售订单物料 物料过滤 物料库存信息要满足下面4个条件 库存组织，仓库，非代管可用数量,库存状态 [(‘stk_org_id’, ‘&#x3D;’, 5), (‘warehouse_id’, ‘&#x3D;’, 5), (‘available_no_escrow_stk_qty’, ‘&gt;’, 0), (‘stk_state_id’, ‘&#x3D;’, 1)] 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111def _set_material_domains(self, model_name, compute_field_name, depend_fields): &quot;&quot;&quot; @desc: 获取组织的范围 @params：model_name：要处理的对应的模型 compute_field_name：当前点击的字段 depend_fields：当前字段所需要依赖的字段 @return: domain条件 &quot;&quot;&quot; # 计算物料范围 material_obj = self.env[&#x27;mdm.material&#x27;] sal_org_data = depend_fields.get(&#x27;sal_org_id&#x27;, None) sal_org_id = sal_org_data.get(&#x27;id&#x27;, None) if sal_org_data else None sal_dept_data = depend_fields.get(&#x27;sal_dept_id&#x27;, None) sal_dept_id = sal_dept_data.get(&#x27;id&#x27;, None) if sal_dept_data else None # 销售组织下物料 if sal_org_id: self.env.cr.execute(&quot;SELECT master_id FROM mdm_material WHERE use_org_id = %s&quot;, (sal_org_id,)) sal_material_records = [x[0] for x in self.env.cr.fetchall()] else: sal_material_records = None material_ids = [] # 判断发料组织下的物料是否已分配到生产组织下，只有分配的才能选到 if sal_material_records: master_id_set = list(set(sal_material_records)) # 找出销售组织下都有的物料 material_ids = material_obj.search([(&#x27;master_id&#x27;, &#x27;in&#x27;, master_id_set)]).ids owner_type = self._context.get(&#x27;owner_type&#x27;, None) if self.owner_type: owner_type = str(owner_type._name) + &#x27;,&#x27; + str(owner_type.id) else: owner_type = &#x27;&#x27; # 计算专项库存取值范围 stk_org_data = depend_fields.get(&#x27;stk_org_id&#x27;, None) stk_org_id = stk_org_data.get(&#x27;id&#x27;, None) if stk_org_data else None warehouse_data = depend_fields.get(&#x27;warehouse_id&#x27;, None) warehouse_id = warehouse_data.get(&#x27;id&#x27;, None) if warehouse_data else None customer_data = depend_fields.get(&#x27;customer_id&#x27;, None) customer_id = customer_data.get(&#x27;id&#x27;, None) if customer_data else None module_id = self.env[&#x27;ir.module.module&#x27;].search([(&#x27;name&#x27;, &#x27;=&#x27;, &#x27;med_sale&#x27;)]).id if stk_org_id and warehouse_id and customer_id: # 专项库存参数 is_special_stock_control_obj = self.env[&#x27;sys.business.params&#x27;].search([ (&#x27;module_id&#x27;, &#x27;=&#x27;, module_id), (&#x27;org_id&#x27;, &#x27;=&#x27;, sal_org_id), (&#x27;key&#x27;, &#x27;=&#x27;, &#x27;special_stock_control&#x27;) ], limit=1) if is_special_stock_control_obj.value == &#x27;True&#x27;: cus_stk_domain = [ (&#x27;stk_org_id&#x27;, &#x27;=&#x27;, stk_org_id), (&#x27;warehouse_id&#x27;, &#x27;=&#x27;, warehouse_id), (&#x27;customer_id&#x27;, &#x27;=&#x27;, customer_id), (&#x27;special_stock&#x27;, &#x27;&gt;&#x27;, 0), (&#x27;stk_state_id&#x27;, &#x27;=&#x27;, 1) ] else: cus_stk_domain = [ (&#x27;stk_org_id&#x27;, &#x27;=&#x27;, stk_org_id), (&#x27;warehouse_id&#x27;, &#x27;=&#x27;, warehouse_id), (&#x27;special_stock&#x27;, &#x27;&gt;&#x27;, 0), (&#x27;stk_state_id&#x27;, &#x27;=&#x27;, 1) ] cus_stk = self.env[&#x27;med.stk.customer.inventory&#x27;].search(cus_stk_domain) cus_search_key = cus_stk.mapped(&#x27;search_key&#x27;) if cus_stk else [] cus_stk_ids_obj = self.env[&#x27;med.stk.instant.inventory&#x27;].search( [(&#x27;search_key_location&#x27;, &#x27;in&#x27;, cus_search_key)]) cus_stk_ids = cus_stk_ids_obj.ids if cus_stk_ids_obj else [] med_stk_domain = [ (&#x27;stk_org_id&#x27;, &#x27;=&#x27;, stk_org_id), (&#x27;warehouse_id&#x27;, &#x27;=&#x27;, warehouse_id), (&#x27;available_no_escrow_stk_qty&#x27;, &#x27;&gt;&#x27;, 0), (&#x27;stk_state_id&#x27;, &#x27;=&#x27;, 1) ] med_stk = self.env[&#x27;med.stk.instant.inventory&#x27;].search(med_stk_domain) med_stk_ids = med_stk.ids if med_stk else [] ids = list(set(med_stk_ids + cus_stk_ids)) domain = [ (&#x27;material_id.id&#x27;, &#x27;in&#x27;, material_ids), (&#x27;material_id.delete_state&#x27;, &#x27;=&#x27;, &#x27;normal&#x27;), (&#x27;id&#x27;, &#x27;in&#x27;, ids), (&#x27;material_id.forbid_state&#x27;, &#x27;=&#x27;, &#x27;normal&#x27;), (&#x27;material_id.state&#x27;, &#x27;=&#x27;, &#x27;audit&#x27;), (&#x27;material_id.is_inventory&#x27;, &#x27;=&#x27;, True) ] # 根据销售参数(销售其它部门品种设置domain) module_id = self.env[&#x27;ir.module.module&#x27;].search([(&#x27;name&#x27;, &#x27;=&#x27;, &#x27;med_sale&#x27;)]).id sale_dep_variety_obj = self.env[&#x27;sys.business.params&#x27;].search([ (&#x27;module_id&#x27;, &#x27;=&#x27;, module_id), (&#x27;org_id&#x27;, &#x27;=&#x27;, sal_org_id), (&#x27;key&#x27;, &#x27;=&#x27;, &#x27;sale_dep_variety&#x27;)], limit=1) # 控制（选择控制时一部的销售员选择商品时只能看到一部采购进的商品） if sale_dep_variety_obj.value == &quot;control&quot;: lot_ids = [i.lot for i in med_stk] lot_domian = [ (&#x27;name&#x27;, &#x27;in&#x27;, lot_ids), (&#x27;pur_dept_id&#x27;, &#x27;=&#x27;, sal_dept_id), (&#x27;biz_org_id&#x27;, &#x27;=&#x27;, sal_org_id), (&#x27;state&#x27;, &#x27;=&#x27;, &#x27;save&#x27;), (&#x27;delete_state&#x27;, &#x27;=&#x27;, &#x27;normal&#x27;) ] lot_main_obj = self.env[&#x27;mdm.lot.main&#x27;].with_context(&#123;&#x27;disable_state_filter&#x27;: True&#125;).search(lot_domian) lot_main_names = [x.name for x in lot_main_obj] domain.append((&#x27;lot&#x27;, &#x27;in&#x27;, lot_main_names)) material_ids = [x.material_id.id for x in lot_main_obj] domain.append((&#x27;material_id.id&#x27;, &#x27;in&#x27;, material_ids)) return domain 设计器中配置过滤函数后会在xml文件中生成 &#x2F;opt&#x2F;projects&#x2F;insuite&#x2F;biz&#x2F;med&#x2F;gsp&#x2F;med_sal_order&#x2F;generate&#x2F;views&#x2F;med_sal_order_views.xml 1&lt;field force_save=&quot;1&quot; domain=&quot;[&#x27;&amp;amp;&#x27;, &#x27;&amp;amp;&#x27;, &#x27;&amp;amp;&#x27;, (&#x27;stk_org_id&#x27;, &#x27;=&#x27;, stk_org_id), (&#x27;warehouse_id&#x27;, &#x27;=&#x27;, warehouse_id), (&#x27;stk_state_id&#x27;, &#x27;in&#x27;, stk_state_domain), (&#x27;id&#x27;, &#x27;in&#x27;, med_instant_domain)]&quot; name=&quot;med_instant_id&quot; widget=&quot;many2one&quot; context=&quot;&#123;&#x27;customer_id&#x27;:customer_id,&#x27;line_ids2&#x27;:line_ids2,&#x27;owner_type&#x27;:owner_type&#125;&quot; depend_method=&quot;_set_material_domains&quot; depend_fields=&quot;sal_org_id,stk_org_id,customer_id,warehouse_id,sal_dept_id&quot; attrs=&quot;&#123;&#x27;invisible&#x27;: [[&#x27;sale_type&#x27;, &#x27;=&#x27;, &#x27;no_stk_sale&#x27;]],&#x27;readonly&#x27;: [&#x27;|&#x27;, &#x27;|&#x27;, [&#x27;state&#x27;, &#x27;in&#x27;, [&#x27;submit&#x27;, &#x27;audit&#x27;]], [&#x27;is_convert&#x27;, &#x27;=&#x27;, True], [&#x27;sale_type&#x27;, &#x27;=&#x27;, &#x27;no_stk_sale&#x27;]]&#125;&quot; options=&quot;&#123;&#x27;filter_leaf&#x27;: False, &#x27;no_create&#x27;: True, &#x27;no_create_edit&#x27;: False, &#x27;no_open&#x27;: True, &#x27;quick_create&#x27;: False, &#x27;selected_filter&#x27;: True&#125;&quot; col=&quot;12&quot; colspan=&quot;12&quot; string=&quot;Material Name&quot;/&gt;","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"医药公司ERP","slug":"项目/医药公司ERP","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/"},{"name":"业务","slug":"项目/医药公司ERP/业务","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/%E4%B8%9A%E5%8A%A1/"}],"tags":[]},{"title":"API接口验证报错SHA512_init解决方法","slug":"项目/医药公司ERP/20230926-API接口验证报错","date":"2023-09-26T15:50:52.000Z","updated":"2024-11-29T02:15:38.579Z","comments":true,"path":"2023/09/26/项目/医药公司ERP/20230926-API接口验证报错/","link":"","permalink":"https://dbbruce.github.io/2023/09/26/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/20230926-API%E6%8E%A5%E5%8F%A3%E9%AA%8C%E8%AF%81%E6%8A%A5%E9%94%99/","excerpt":"inStudio API 调用时报错 &#x2F;opt&#x2F;projects&#x2F;insuite&#x2F;biz&#x2F;platform&#x2F;ps_studio&#x2F;models&#x2F;studio_api.py 报错方法：mac_key &#x3D; key_algorithm.new(sec_bytes).digest()","text":"inStudio API 调用时报错 &#x2F;opt&#x2F;projects&#x2F;insuite&#x2F;biz&#x2F;platform&#x2F;ps_studio&#x2F;models&#x2F;studio_api.py 报错方法：mac_key &#x3D; key_algorithm.new(sec_bytes).digest() 1234567891011121314151617181920212223242526272829def get_msg_auth_code(self, api_route=None, secret_key=None, timestamp=None, body_str=None, method=None, secret=None, key_algorithm=None, mac_algorithm=None): &#x27;&#x27;&#x27; @desc 获取消息授权码, 先哈希(默认SHA512)一把得到key, 然后用这个key去做HMAC(默认SHA256) @param api_route: str, 接口路径 @param secret_key: str, salt值 @param timestamp: int, 时间戳 @param body_str: str, 如果是json格式, 那不能有空格, e.g., json.dumps(jdict, separators=(&#x27;,&#x27;, &#x27;:&#x27;)) @param method: str, &#x27;post&#x27; or &#x27;get&#x27; @param key_algorithm: func, Crypto.Hash包里的哈希函数, 用来计算MAC用的key @param mac_algorithm: func, Crypto.Hash包里的哈希函数, 用来计算MAC @return: str, 16进制字符串 &#x27;&#x27;&#x27; # 拼接secret if not secret: secret = f&#x27;ts@&#123;timestamp&#125;|route@&#123;api_route&#125;|sec@&#123;secret_key&#125;|method@&#123;method&#125;&#x27; if not key_algorithm: key_algorithm = SHA512 if not mac_algorithm: mac_algorithm = SHA256 # 转为字节 sec_bytes = bytes(secret, encoding=&#x27;utf-8&#x27;) # 生成一个64字节的key，与sha256的分组长度相同 mac_key = key_algorithm.new(sec_bytes).digest() _logger.info(&#x27;MAC key is %s&#x27;, mac_key.hex()) # 入参转为字节 body_bytes = bytes(body_str, encoding=&#x27;utf-8&#x27;) # 执行HMAC msg_auth_code = HMAC.new(mac_key, body_bytes, mac_algorithm).hexdigest() return msg_auth_code 报错信息：AttributeError: function&#x2F;symbol ‘SHA512_init’AttributeError: function&#x2F;symbol ‘SHA512_init’ not found in library ‘&#x2F;usr&#x2F;local&#x2F;python3&#x2F;lib&#x2F;python3.7&#x2F;site-packages&#x2F;Crypto&#x2F;Util&#x2F;..&#x2F;Hash&#x2F;_SHA512.cpython-37m-x86_64-linux-gnu.so’: &#x2F;usr&#x2F;local&#x2F;python3&#x2F;lib&#x2F;python3.7&#x2F;site-packages&#x2F;Crypto&#x2F;Util&#x2F;..&#x2F;Hash&#x2F;_SHA512.cpython-37m-x86_64-linux-gnu.so: undefined symbol: SHA512_init 日志 1234567891011121314151617181920212223242526272829303132333435363738394041424344452024-11-26 02:15:18,445 587646 ERROR tjjr_yiyao_1120 odoo.addons.ps_admin.monkey_patch.http: Exception during JSON request handling. Traceback (most recent call last): File &quot;/opt/projects/insuite/sys/ps_admin/monkey_patch/http.py&quot;, line 42, in _handle_exception return super(JsonRequest, self)._handle_exception(exception) File &quot;/opt/projects/insuite/core/odoo/http.py&quot;, line 313, in _handle_exception raise pycompat.reraise(type(exception), exception, sys.exc_info()[2]) File &quot;/opt/projects/insuite/core/odoo/tools/pycompat.py&quot;, line 14, in reraise raise value File &quot;/opt/projects/insuite/core/odoo/http.py&quot;, line 668, in dispatch result = self._call_function(**self.params) File &quot;/opt/projects/insuite/core/odoo/http.py&quot;, line 349, in _call_function return checked_call(self.db, *args, **kwargs) File &quot;/opt/projects/insuite/core/odoo/service/model.py&quot;, line 98, in wrapper return f(dbname, *args, **kwargs) File &quot;/opt/projects/insuite/core/odoo/http.py&quot;, line 342, in checked_call result = self.endpoint(*a, **kw) File &quot;/opt/projects/insuite/core/odoo/http.py&quot;, line 913, in __call__ return self.method(*args, **kw) File &quot;/opt/projects/insuite/core/odoo/http.py&quot;, line 514, in response_wrap response = f(*args, **kw) File &quot;/opt/projects/insuite/biz/platform/ps_studio/controllers/studio_api_ctrl.py&quot;, line 1704, in api_special_execution return request.env[&#x27;studio.api&#x27;].call(path_project, path_first, path_second, kwargs, version=version) File &quot;/opt/projects/insuite/biz/platform/ps_studio/models/studio_api.py&quot;, line 890, in call result = self._check_api_param_and_auth(api, kwargs) File &quot;/opt/projects/insuite/biz/platform/ps_studio/models/studio_api.py&quot;, line 638, in _check_api_param_and_auth verify_auth_result = self._verify_auth(api,kwargs) File &quot;/opt/projects/insuite/biz/platform/ps_studio/models/studio_api.py&quot;, line 673, in _verify_auth verify_result = self._verify_signature(api_user_id, api, kwargs) File &quot;/opt/projects/insuite/biz/platform/ps_studio/models/studio_api.py&quot;, line 711, in _verify_signature return self._verify_HMAC_SHA256(api_user, api, sign, param, kwargs.get(&#x27;timestamp&#x27;, False), auth_type) File &quot;/opt/projects/insuite/biz/platform/ps_studio/models/studio_api.py&quot;, line 730, in _verify_HMAC_SHA256 mac = self.get_msg_auth_code(api_route, sec, timestamp, body, method) File &quot;/opt/projects/insuite/biz/platform/ps_studio/models/studio_api.py&quot;, line 1219, in get_msg_auth_code mac_key = key_algorithm.new(sec_bytes).digest() File &quot;/usr/local/python3/lib/python3.7/site-packages/Crypto/Hash/SHA512.py&quot;, line 177, in new return SHA512Hash(data, truncate) File &quot;/usr/local/python3/lib/python3.7/site-packages/Crypto/Hash/SHA512.py&quot;, line 85, in __init__ result = _raw_sha512_lib.SHA512_init(state.address_of(), File &quot;/usr/local/python3/lib/python3.7/site-packages/cffi/api.py&quot;, line 912, in __getattr__ make_accessor(name) File &quot;/usr/local/python3/lib/python3.7/site-packages/cffi/api.py&quot;, line 908, in make_accessor accessors[name](name) File &quot;/usr/local/python3/lib/python3.7/site-packages/cffi/api.py&quot;, line 838, in accessor_function value = backendlib.load_function(BType, name)AttributeError: function/symbol &#x27;SHA512_init&#x27; not found in library &#x27;/usr/local/python3/lib/python3.7/site-packages/Crypto/Util/../Hash/_SHA512.cpython-37m-x86_64-linux-gnu.so&#x27;: /usr/local/python3/lib/python3.7/site-packages/Crypto/Util/../Hash/_SHA512.cpython-37m-x86_64-linux-gnu.so: undefined symbol: SHA512_init 解决方法： 可能是root用户下安装了pycrypto&#x3D;&#x3D;2.6.1，odoo用户下安装了pycryptodome&#x3D;&#x3D;3.11.0，有冲突导致的，本地只有root用户，没复现出来，但都安装会有问题，可以先把两个卸载了然后安装新的 12pip3 show pycryptopip3 show pycryptodome 123pip3 uninstall pycryptopip3 uninstall pycryptodomepip3 install pycryptodome==3.11.0","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"医药公司ERP","slug":"项目/医药公司ERP","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/"},{"name":"业务","slug":"项目/医药公司ERP/业务","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/%E4%B8%9A%E5%8A%A1/"}],"tags":[]},{"title":"API接口调用表单里的方法","slug":"项目/医药公司ERP/20230924-API接口调用表单里的方法","date":"2023-09-24T15:50:52.000Z","updated":"2024-11-29T02:15:38.573Z","comments":true,"path":"2023/09/24/项目/医药公司ERP/20230924-API接口调用表单里的方法/","link":"","permalink":"https://dbbruce.github.io/2023/09/24/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/20230924-API%E6%8E%A5%E5%8F%A3%E8%B0%83%E7%94%A8%E8%A1%A8%E5%8D%95%E9%87%8C%E7%9A%84%E6%96%B9%E6%B3%95/","excerpt":"API接口调用表单里的方法 调用方法：reobj &#x3D; med_stk_cnt_obj.svc_count() 获取返回结果：xs_info &#x3D; reobj.get(‘notify_toast’)","text":"API接口调用表单里的方法 调用方法：reobj &#x3D; med_stk_cnt_obj.svc_count() 获取返回结果：xs_info &#x3D; reobj.get(‘notify_toast’) 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869import loggingimport jsonimport timeimport datetimefrom datetime import datefrom collections import OrderedDictfrom dateutil.relativedelta import relativedeltaimport odoofrom odoo import api, fields, models, _from odoo.http import Controller, request, routefrom odoo.addons.ps_studio.models.studio_service_config import transform_result_logger = logging.getLogger(__name__)class InsuiteMedInvStockCountController(Controller): @route(&#x27;/insuite/med.inv.stock.count/inventory_stock_count&#x27;, type=&#x27;json&#x27;, auth=&quot;user&quot;) def inventory_stock_count(self, **kwargs): &quot;&quot;&quot; args: id: str 库存盘点单ID &quot;&quot;&quot; env = request.env # 环境变量 results = [] # 存储成功和失败的结果 if &#x27;param&#x27; in kwargs: params = kwargs.get(&#x27;param&#x27;) # 库存盘点单 med_stk_cnt = env[&#x27;med.inv.stock.count&#x27;] # 检查每个订单 ID for param in params: order_id = param.get(&#x27;id&#x27;) _logger.info(&#x27;order_id: %s&#x27; % order_id) med_stk_cnt_obj = med_stk_cnt.search([(&#x27;id&#x27;, &#x27;=&#x27;, order_id)], limit=1) # 检查盘点单是否存在 if not med_stk_cnt_obj: results.append(&#123;&quot;order_id&quot;: order_id, &quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;订单不存在！&quot;&#125;) continue # 检查订单状态 if med_stk_cnt_obj.state != &quot;save&quot;: results.append(&#123;&quot;order_id&quot;: order_id, &quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;订单不是保存状态，请检查！&quot;&#125;) continue try: reobj = med_stk_cnt_obj.svc_count() _logger.info(&#x27;reobj: %s&#x27; % reobj) xs_info = reobj.get(&#x27;notify_toast&#x27;) # 获取提示信息 _logger.info(&#x27;xs_info: %s&#x27; % xs_info) if xs_info.get(&#x27;type&#x27;) == &#x27;success&#x27;: results.append(&#123;&quot;order_id&quot;: order_id, &quot;status&quot;: &quot;success&quot;, &quot;message&quot;: &quot;盘点成功！&quot;&#125;) else: results.append(&#123;&quot;order_id&quot;: order_id, &quot;status&quot;: &quot;error&quot;, &quot;message&quot;: xs_info.get(&#x27;message&#x27;)&#125;) except Exception as e: results.append(&#123;&quot;order_id&quot;: order_id, &quot;status&quot;: &quot;error&quot;, &quot;message&quot;: f&quot;盘点失败: &#123;str(e)&#125;&quot;&#125;) else: # 如果参数不正确，返回错误信息 return &#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;请求参数不正确！&quot;&#125; # 根据处理结果返回不同的 HTTP 状态码 _logger.info(&#x27;results: %s&#x27; % results) if all(result[&#x27;status&#x27;] == &#x27;success&#x27; for result in results): return results else: return results","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"医药公司ERP","slug":"项目/医药公司ERP","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/"},{"name":"业务","slug":"项目/医药公司ERP/业务","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/%E4%B8%9A%E5%8A%A1/"}],"tags":[]},{"title":"odoo知识点(六)-mac安装odoo16","slug":"odoo/20230923-mac安装odoo16","date":"2023-09-23T15:50:52.000Z","updated":"2025-08-19T07:11:04.345Z","comments":true,"path":"2023/09/23/odoo/20230923-mac安装odoo16/","link":"","permalink":"https://dbbruce.github.io/2023/09/23/odoo/20230923-mac%E5%AE%89%E8%A3%85odoo16/","excerpt":"1.virutalenv创建新环境:odoo16 mkvirtualenv -p &#x2F;usr&#x2F;bin&#x2F;python3 odoo16 1234567891011(odoo-17.0) dbbruce@dbburce odoo-project % mkvirtualenv -p /usr/bin/python3 odoo16created virtual environment CPython3.9.6.final.0-64 in 851ms creator CPython3macOsFramework(dest=/Users/dbbruce/.virtualenvs/odoo16, clear=False, no_vcs_ignore=False, global=False) seeder FromAppData(download=False, pip=bundle, setuptools=bundle, wheel=bundle, via=copy, app_data_dir=/Users/dbbruce/Library/Application Support/virtualenv) added seed packages: pip==24.0, setuptools==68.2.2, wheel==0.43.0 activators BashActivator,CShellActivator,FishActivator,NushellActivator,PowerShellActivator,PythonActivatorvirtualenvwrapper.user_scripts creating /Users/dbbruce/.virtualenvs/odoo16/bin/predeactivatevirtualenvwrapper.user_scripts creating /Users/dbbruce/.virtualenvs/odoo16/bin/postdeactivatevirtualenvwrapper.user_scripts creating /Users/dbbruce/.virtualenvs/odoo16/bin/preactivatevirtualenvwrapper.user_scripts creating /Users/dbbruce/.virtualenvs/odoo16/bin/postactivatevirtualenvwrapper.user_scripts creating /Users/dbbruce/.virtualenvs/odoo16/bin/get_env_details 2.安装pgsql https://www.enterprisedb.com/downloads/postgres-postgresql-downloads 配置请查考：https://dbbruce.github.io/2023/09/22/项目/佳业/20230922-odoo知识点5-PostgreSQL/ 3.下载odoo16源码 https://www.odoo.com/zh_CN","text":"1.virutalenv创建新环境:odoo16 mkvirtualenv -p &#x2F;usr&#x2F;bin&#x2F;python3 odoo16 1234567891011(odoo-17.0) dbbruce@dbburce odoo-project % mkvirtualenv -p /usr/bin/python3 odoo16created virtual environment CPython3.9.6.final.0-64 in 851ms creator CPython3macOsFramework(dest=/Users/dbbruce/.virtualenvs/odoo16, clear=False, no_vcs_ignore=False, global=False) seeder FromAppData(download=False, pip=bundle, setuptools=bundle, wheel=bundle, via=copy, app_data_dir=/Users/dbbruce/Library/Application Support/virtualenv) added seed packages: pip==24.0, setuptools==68.2.2, wheel==0.43.0 activators BashActivator,CShellActivator,FishActivator,NushellActivator,PowerShellActivator,PythonActivatorvirtualenvwrapper.user_scripts creating /Users/dbbruce/.virtualenvs/odoo16/bin/predeactivatevirtualenvwrapper.user_scripts creating /Users/dbbruce/.virtualenvs/odoo16/bin/postdeactivatevirtualenvwrapper.user_scripts creating /Users/dbbruce/.virtualenvs/odoo16/bin/preactivatevirtualenvwrapper.user_scripts creating /Users/dbbruce/.virtualenvs/odoo16/bin/postactivatevirtualenvwrapper.user_scripts creating /Users/dbbruce/.virtualenvs/odoo16/bin/get_env_details 2.安装pgsql https://www.enterprisedb.com/downloads/postgres-postgresql-downloads 配置请查考：https://dbbruce.github.io/2023/09/22/项目/佳业/20230922-odoo知识点5-PostgreSQL/ 3.下载odoo16源码 https://www.odoo.com/zh_CN 源码文件复制到项目目录 cp &#x2F;Users&#x2F;dbbruce&#x2F;我的资料&#x2F;odoo-16.0.zip &#x2F;Users&#x2F;dbbruce&#x2F;workspace&#x2F;odoo-project 1234(odoo16) dbbruce@dbburce odoo-project % cd /Users/dbbruce/workspace/odoo-project(odoo16) dbbruce@dbburce odoo-project % cp /Users/dbbruce/我的资料/odoo-16.0.zip ./(odoo16) dbbruce@dbburce odoo-project % lsodoo-16.0.zip 解压 unzip odoo-16.0.zip 12345(odoo16) dbbruce@dbburce odoo-project % unzip odoo-16.0.zipArchive: odoo-16.0.zip99e2b13416256a0a23a1a619b92873bcfe15b8a9 creating: odoo-16.0/ creating: odoo-16.0/.github/ 创建一个自定义addons目录1(odoo16) dbbruce@dbburce odoo16 % mkdir custom_addons 4.安装依赖包 切换环境： workon odoo16 12dbbruce@dbburce odoo-project % workon odoo16(odoo16) dbbruce@dbburce odoo-project % 安装pip包： pip install -r requirements.txt 123456789(odoo16) dbbruce@dbburce odoo16 % sudo pip install -r requirements.txtPassword:WARNING: The directory &#x27;/Users/dbbruce/Library/Caches/pip&#x27; or its parent directory is not owned or is not writable by the current user. The cache has been disabled. Check the permissions and owner of that directory. If executing pip with sudo, you should use sudo&#x27;s -H flag.Ignoring cryptography: markers &#x27;python_version &gt;= &quot;3.12&quot;&#x27; don&#x27;t match your environmentIgnoring freezegun: markers &#x27;python_version &lt; &quot;3.8&quot;&#x27; don&#x27;t match your environmentIgnoring gevent: markers &#x27;sys_platform != &quot;win32&quot; and python_version == &quot;3.7&quot;&#x27; don&#x27;t match your environmentIgnoring gevent: markers &#x27;sys_platform != &quot;win32&quot; and python_version &gt; &quot;3.9&quot; and python_version &lt;= &quot;3.10&quot;&#x27; don&#x27;t match your environmentIgnoring gevent: markers &#x27;sys_platform != &quot;win32&quot; and python_version &gt; &quot;3.10&quot; and python_version &lt; &quot;3.12&quot;&#x27; don&#x27;t match your environmentIgnoring gevent: markers &#x27;sys_platform != &quot;win32&quot; and python_version &gt;= &quot;3.12&quot;&#x27; don&#x27;t match your environment 5.配置文件 注意：addons_path使用逗号连接 12345678910(odoo16) dbbruce@dbburce odoo16 % cd /Users/dbbruce/workspace/odoo-project/odoo16(odoo16) dbbruce@dbburce odoo16 % vim odoo16.conf[options]admin_passwd = admin888 db_host = 127.0.0.1 db_port = 5432db_user = odoo16db_password = odoo16addons_path = /Users/dbbruce/workspace/odoo-project/odoo16/addons,/Users/dbbruce/workspace/odoo-project/odoo16/custom_addons 6.启动odoo cd &#x2F;Users&#x2F;dbbruce&#x2F;workspace&#x2F;odoo-project&#x2F;odoo16&#x2F; 初始化数据库 .&#x2F;odoo-bin -i base -d odoo16 –config&#x3D;odoo16.conf 启动odoo .&#x2F;odoo-bin -c odoo16.conf 7.pycharm配置启动参数 一定要配置绝对路径: &#x2F;Users&#x2F;dbbruce&#x2F;workspace&#x2F;odoo-project&#x2F;odoo16&#x2F;odoo-bin -c &#x2F;Users&#x2F;dbbruce&#x2F;workspace&#x2F;odoo-project&#x2F;odoo16&#x2F;odoo16.conf 8.web登录 地址：http://127.0.0.1:8069/ 用户名密码：admin&#x2F;admin 9.错误列表1.”CRITICAL ? odoo.modules.module: No module named ‘odoo.addons.web’” 123解决方法：检测配置文件中 addons_path1. 路径2. 多路径连接，是不是用逗号 2.”odoo.modules.loading: Database odoo16_db not initialized, you can force it with -i base“ 12解决方法：数据库没有初始化./odoo-bin -i base -d odoo16 --config=odoo16.conf 3.”odoo.addons.base.models.ir_actions_report: You need Wkhtmltopdf to print a pdf version of the reports.” 安装前 安装后 安装Wkhtmltopdf https://wkhtmltopdf.org/downloads.html mac安全性与隐私 查看版本12dbbruce@dbburce ~ % wkhtmltopdf --versionwkhtmltopdf 0.12.6 (with patched qt)","categories":[{"name":"odoo","slug":"odoo","permalink":"https://dbbruce.github.io/categories/odoo/"},{"name":"基础","slug":"odoo/基础","permalink":"https://dbbruce.github.io/categories/odoo/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"inStudio复制应用报order错误","slug":"项目/医药公司ERP/20230920-inStudio复制应用报order错误","date":"2023-09-20T15:50:52.000Z","updated":"2024-11-29T02:15:38.618Z","comments":true,"path":"2023/09/20/项目/医药公司ERP/20230920-inStudio复制应用报order错误/","link":"","permalink":"https://dbbruce.github.io/2023/09/20/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/20230920-inStudio%E5%A4%8D%E5%88%B6%E5%BA%94%E7%94%A8%E6%8A%A5order%E9%94%99%E8%AF%AF/","excerpt":"inStudio复制应用报order错误 在解析order属性时，找不到key为gsp.field_med_sal_order__number的字段","text":"inStudio复制应用报order错误 在解析order属性时，找不到key为gsp.field_med_sal_order__number的字段 1234567891011121314151617181920212223242526272829303132332024-11-21 07:33:06,285 475867 ERROR tjjr_yiyao_1120 odoo.addons.ps_admin.monkey_patch.http: (&#x27;在解析order属性时，找不到key为gsp.field_med_sal_order__number的字段&#x27;, None) Traceback (most recent call last): File &quot;/opt/projects/insuite/sys/ps_admin/monkey_patch/http.py&quot;, line 42, in _handle_exception return super(JsonRequest, self)._handle_exception(exception) File &quot;/opt/projects/insuite/core/odoo/http.py&quot;, line 313, in _handle_exception raise pycompat.reraise(type(exception), exception, sys.exc_info()[2]) File &quot;/opt/projects/insuite/core/odoo/tools/pycompat.py&quot;, line 14, in reraise raise value File &quot;/opt/projects/insuite/core/odoo/http.py&quot;, line 668, in dispatch result = self._call_function(**self.params) File &quot;/opt/projects/insuite/core/odoo/http.py&quot;, line 349, in _call_function return checked_call(self.db, *args, **kwargs) File &quot;/opt/projects/insuite/core/odoo/service/model.py&quot;, line 98, in wrapper return f(dbname, *args, **kwargs) File &quot;/opt/projects/insuite/core/odoo/http.py&quot;, line 342, in checked_call result = self.endpoint(*a, **kw) File &quot;/opt/projects/insuite/core/odoo/http.py&quot;, line 913, in __call__ return self.method(*args, **kw) File &quot;/opt/projects/insuite/core/odoo/http.py&quot;, line 514, in response_wrap response = f(*args, **kw) File &quot;/opt/projects/insuite/biz/platform/ps_studio/publish_application/controllers/studio_publish_ctrl.py&quot;, line 627, in export_from_json_to_ide return self.export_from_json(is_export_to_ide=True, *args, **kwargs) File &quot;/opt/projects/insuite/biz/platform/ps_studio/publish_application/controllers/studio_publish_ctrl.py&quot;, line 375, in export_from_json export_dict=view_data_dict File &quot;/opt/projects/insuite/biz/platform/ps_studio/services/view_service.py&quot;, line 562, in publish_view save_view_res = self._save_publish_view(view_key, view_json, module, field_dict, model_type, export_dict) File &quot;/opt/projects/insuite/biz/platform/ps_studio/services/view_service.py&quot;, line 1512, in _save_publish_view self._parse_json_to_xml(view, root, label, field_dict, model_type, export_dict, module, main_table=True) File &quot;/opt/projects/insuite/biz/platform/ps_studio/services/view_service.py&quot;, line 2130, in _parse_json_to_xml fieldName = &#x27;&#x27;.join(key2Name([opt.get(&#x27;fieldKey&#x27;)], field_dict, &#x27;order&#x27;)) File &quot;/opt/projects/insuite/biz/platform/ps_studio/services/view_service.py&quot;, line 116, in key2Name raise ValidationError(_(&#x27;While parsing the &#123;&#125; attribute, the field with key &#123;&#125; could not be found&#x27;).format(attr, key))odoo.exceptions.ValidationError: (&#x27;在解析order属性时，找不到key为gsp.field_med_sal_order__number的字段 现象 原因，inStudio 复制应用时，order字段里的内容没有替换成新的模块名和模型名1select * from studio_app_version where model_key=&#x27;med.sale.application.order&#x27; and json_type=&#x27;tree&#x27; and id=7779; 解决方法：1UPDATE studio_app_version SET json_data = REPLACE(json_data, &#x27;gsp.field_med_sal_order__number&#x27;, &#x27;med_sale.field_med_sale_application_order__number&#x27;) where model_key=&#x27;med.sale.application.order&#x27; and json_type=&#x27;tree&#x27; and id=7779;","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"医药公司ERP","slug":"项目/医药公司ERP","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/"},{"name":"业务","slug":"项目/医药公司ERP/业务","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/%E4%B8%9A%E5%8A%A1/"}],"tags":[]},{"title":"接口开发流程","slug":"项目/医药公司ERP/20230911-接口开发流程","date":"2023-09-11T15:50:52.000Z","updated":"2024-11-29T02:15:38.595Z","comments":true,"path":"2023/09/11/项目/医药公司ERP/20230911-接口开发流程/","link":"","permalink":"https://dbbruce.github.io/2023/09/11/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/20230911-%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B/","excerpt":"接口配置流程1.设计器配置接口 API 开放平台 下面的是model名 med.inv.stock.count 请求路径 &#x2F;studio&#x2F;api_special&#x2F;v1.0.1&#x2F;insuite &#x2F;med_inv_stock_count&#x2F;inventory_stock_count 关联类型 调用API &#x2F;insuite&#x2F;med.inv.stock.count&#x2F;inventory_stock_count","text":"接口配置流程1.设计器配置接口 API 开放平台 下面的是model名 med.inv.stock.count 请求路径 &#x2F;studio&#x2F;api_special&#x2F;v1.0.1&#x2F;insuite &#x2F;med_inv_stock_count&#x2F;inventory_stock_count 关联类型 调用API &#x2F;insuite&#x2F;med.inv.stock.count&#x2F;inventory_stock_count 2.新增Controllers文件 odoo route type&#x3D;’json’ jsonrpc接口 注意路径：&#x2F;med_inv_stock_count&#x2F;development&#x2F;models &#x2F;opt&#x2F;projects&#x2F;insuite&#x2F;biz&#x2F;med&#x2F;med_inv&#x2F;med_inv_stock_count&#x2F;development&#x2F;models&#x2F;med_inv_stock_count_controllers.py 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960# -*- coding: utf-8 -*-&#x27;&#x27;&#x27;==================================================@创建人 ：bruce D@当前维护人 ：bruce D@Desc ：库存盘点单盘点功能================================================== &#x27;&#x27;&#x27;from odoo import api, fields, models, _from odoo.http import Controller, request, routefrom odoo.addons.ps_studio.models.studio_service_config import transform_resultclass InsuiteMedInvStockCountController(Controller): @route(&#x27;/insuite/med.inv.stock.count/inventory_stock_count&#x27;, type=&#x27;json&#x27;, auth=&quot;user&quot;) def inventory_stock_count(self, **kwargs): &quot;&quot;&quot; args: id: str 库存盘点单ID &quot;&quot;&quot; env = request.env # 环境变量 results = [] # 存储成功和失败的结果 if &#x27;param&#x27; in kwargs: params = kwargs.get(&#x27;param&#x27;) # 库存盘点单 med_stk_cnt = env[&#x27;med.inv.stock.count&#x27;] # 检查每个订单 ID for param in params: order_id = param.get(&#x27;id&#x27;) med_stk_cnt_obj = med_stk_cnt.search([(&#x27;id&#x27;, &#x27;=&#x27;, order_id)], limit=1) # 检查盘点单是否存在 if not med_stk_cnt_obj: results.append(&#123;&quot;order_id&quot;: order_id, &quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;订单不存在！&quot;&#125;) continue # 检查订单状态 if med_stk_cnt_obj.state != &quot;save&quot;: results.append(&#123;&quot;order_id&quot;: order_id, &quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;订单不是保存状态，请检查！&quot;&#125;) continue try: reobj = med_stk_cnt.svc_count(med_stk_cnt_obj) xs_info = reobj.get(&#x27;notify_toast&#x27;) # 获取提示信息 if xs_info.get(&#x27;status&#x27;) == &#x27;success&#x27;: results.append(&#123;&quot;order_id&quot;: order_id, &quot;status&quot;: &quot;success&quot;, &quot;message&quot;: &quot;盘点成功！&quot;&#125;) else: results.append(&#123;&quot;order_id&quot;: order_id, &quot;status&quot;: &quot;error&quot;, &quot;message&quot;: xs_info.get(&#x27;message&#x27;)&#125;) except Exception as e: results.append(&#123;&quot;order_id&quot;: order_id, &quot;status&quot;: &quot;error&quot;, &quot;message&quot;: f&quot;盘点失败: &#123;str(e)&#125;&quot;&#125;) else: # 如果参数不正确，返回错误信息 return &#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;请求参数不正确！&quot;&#125; # 根据处理结果返回不同的 HTTP 状态码 if all(result[&#x27;status&#x27;] == &#x27;success&#x27; for result in results): return results else: return results 3.init文件添加py引用 &#x2F;opt&#x2F;projects&#x2F;insuite&#x2F;biz&#x2F;med&#x2F;med_inv&#x2F;med_inv_stock_count&#x2F;development&#x2F;models&#x2F;init.py 12345# -*- coding: utf-8 -*-from . import med_inv_stock_countfrom . import med_inv_stock_count_line1from . import med_inv_stock_count_line1_line1from . import med_inv_stock_count_controllers 4.新增xml文件 &#x2F;opt&#x2F;projects&#x2F;insuite&#x2F;biz&#x2F;med&#x2F;med_inv&#x2F;med_inv_stock_count&#x2F;development&#x2F;data&#x2F;med_inventory_stock_count.xml 5.manifest文件添加xml引用 &#x2F;opt&#x2F;projects&#x2F;insuite&#x2F;biz&#x2F;med&#x2F;med_inv&#x2F;manifest.py 123456&quot;med_inv_stock_count/generate/data/ps_netcontrol_config.xml&quot;,&quot;med_inv_stock_count/development/data/med_inv_stock_count_org_data.xml&quot;,&quot;med_inv_stock_count/development/data/document_type.xml&quot;,# 接口&quot;med_inv_stock_count/development/data/med_inventory_stock_count.xml&quot;, 6.删除配置的api，升级后会再次自动生成 7.重启服务，升级 8.自动生成API接口 再次自动生成API 生成API文档 9.设计器授权 API 开放平台 → 用户管理 10.postman接口测试","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"医药公司ERP","slug":"项目/医药公司ERP","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/"},{"name":"业务","slug":"项目/医药公司ERP/业务","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/%E4%B8%9A%E5%8A%A1/"}],"tags":[]},{"title":"盘点单库存变化","slug":"项目/医药公司ERP/20230910-盘点单库存变化","date":"2023-09-10T15:50:52.000Z","updated":"2024-11-29T02:15:38.634Z","comments":true,"path":"2023/09/10/项目/医药公司ERP/20230910-盘点单库存变化/","link":"","permalink":"https://dbbruce.github.io/2023/09/10/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/20230910-%E7%9B%98%E7%82%B9%E5%8D%95%E5%BA%93%E5%AD%98%E5%8F%98%E5%8C%96/","excerpt":"盘点单业务流程","text":"盘点单业务流程 盘点单，生产日期 生产日期，第一次盘点 医药即时库存：新增一条记录 即时库存：新增一条记录 生产日期，非第一盘点 医药即时库存：占用数量变化，库存数量变化 即时库存：库存数量变化","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"医药公司ERP","slug":"项目/医药公司ERP","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/"},{"name":"业务","slug":"项目/医药公司ERP/业务","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/%E4%B8%9A%E5%8A%A1/"}],"tags":[]},{"title":"Pycharm分行或分块执行","slug":"python/基础/Pycharm分行或分块执行","date":"2023-09-10T02:14:52.000Z","updated":"2024-05-23T03:01:46.000Z","comments":true,"path":"2023/09/10/python/基础/Pycharm分行或分块执行/","link":"","permalink":"https://dbbruce.github.io/2023/09/10/python/%E5%9F%BA%E7%A1%80/Pycharm%E5%88%86%E8%A1%8C%E6%88%96%E5%88%86%E5%9D%97%E6%89%A7%E8%A1%8C/","excerpt":"介绍Pycharm中其实也可以使用类似于Spyder和Jupyter中的分行或分块执行，主要可以使用两种方法。需要注意的是，下面两种方法的本质都是在控制台执行，要注意文件的路径问题。","text":"介绍Pycharm中其实也可以使用类似于Spyder和Jupyter中的分行或分块执行，主要可以使用两种方法。需要注意的是，下面两种方法的本质都是在控制台执行，要注意文件的路径问题。 个人认为：这种比较适用于，前部分数据比较大，时间长，后面使用处理这些大数据；那么使用分块后，只需要执行后面的代码，调试大大节省时间 方法一，选中按住Shift+Alt+E方法是选中要执行的行或快，按住Shift+Alt+E，这样就可以自动调出Python Console进行执行，但这种方法每次都需要同时按三个键，较为麻烦，不推荐 方法二，使用Pycharm的科学模式 在要分块的地方 插入 “#%%” 然后在View下找到将Scientific Mode选中 在#%%定位的地方，就出现了绿色的小箭头，点击绿色小箭头就可以执行这一行或这一块了","categories":[{"name":"Python基础","slug":"Python基础","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/"},{"name":"基础","slug":"Python基础/基础","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"销售订单表头字段说明","slug":"项目/医药公司ERP/20230831-销售订单表头字段说明","date":"2023-08-31T15:50:52.000Z","updated":"2024-11-29T02:15:38.638Z","comments":true,"path":"2023/08/31/项目/医药公司ERP/20230831-销售订单表头字段说明/","link":"","permalink":"https://dbbruce.github.io/2023/08/31/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/20230831-%E9%94%80%E5%94%AE%E8%AE%A2%E5%8D%95%E8%A1%A8%E5%A4%B4%E5%AD%97%E6%AE%B5%E8%AF%B4%E6%98%8E/","excerpt":"销售订单表头","text":"销售订单表头 单据类型，多对一 关联数据表：mdm.document.type xml 文件：&#x2F;opt&#x2F;projects&#x2F;insuite&#x2F;biz&#x2F;med&#x2F;gsp&#x2F;med_sal_order&#x2F;development&#x2F;data&#x2F;gsp_document_type.xml1234567891011121314151617181920212223242526272829303132333435363738394041424344&lt;data noupdate=&quot;0&quot;&gt; &lt;!-- 销售订单单据列表 --&gt; &lt;record id=&quot;mdm_document_list_med_sal_order&quot; model=&quot;mdm.document.list&quot;&gt; &lt;field name=&quot;name&quot;&gt;销售订单&lt;/field&gt; &lt;field name=&quot;add_option&quot;&gt;non_stk&lt;/field&gt; &lt;field name=&quot;sub_system&quot; ref=&quot;ps_admin.ps_ir_domain_med&quot;/&gt; &lt;field name=&quot;module_id&quot; search=&quot;[(&#x27;name&#x27;,&#x27;=&#x27;,&#x27;gsp&#x27;)]&quot; model=&quot;ir.module.module&quot;/&gt; &lt;field name=&quot;model_id&quot; search=&quot;[(&#x27;model&#x27;,&#x27;=&#x27;,&#x27;med.sal.order&#x27;)]&quot; model=&quot;ir.model&quot;/&gt; &lt;field name=&quot;is_sys_default&quot; eval=&quot;True&quot;/&gt; &lt;field name=&quot;is_biz_hide&quot; eval=&quot;True&quot;/&gt; &lt;field name=&quot;is_red&quot; eval=&quot;False&quot;/&gt; &lt;field name=&quot;state&quot;&gt;audit&lt;/field&gt; &lt;/record&gt; &lt;!-- 销售订单业务类型 --&gt; &lt;record id=&quot;mdm_business_type_med_sal_order&quot; model=&quot;mdm.business.type&quot;&gt; &lt;field name=&quot;name&quot;&gt;销售订单&lt;/field&gt; &lt;field name=&quot;corespond_doc_id&quot; ref=&quot;mdm_document_list_med_sal_order&quot; /&gt; &lt;field name=&quot;state&quot;&gt;audit&lt;/field&gt; &lt;field name=&quot;is_sys_default&quot; eval=&quot;True&quot;/&gt; &lt;/record&gt; &lt;!-- 销售订单单据类型 --&gt; &lt;record id=&quot;mdm_document_type_med_sal_order&quot; model=&quot;mdm.document.type&quot;&gt; &lt;field name=&quot;name&quot;&gt;销售订单&lt;/field&gt; &lt;field name=&quot;corespond_doc_id&quot; ref=&quot;mdm_document_list_med_sal_order&quot;/&gt; &lt;field name=&quot;code_rule_id&quot; ref=&quot;gsp.med_sal_order_code_rule_XMiJLH5oQfWs&quot;/&gt; &lt;field name=&quot;biz_type_id&quot; ref=&quot;mdm_business_type_med_sal_order&quot;/&gt; &lt;field name=&quot;number&quot;&gt;MED_SAL_000001&lt;/field&gt; &lt;field name=&quot;is_default&quot; eval=&quot;True&quot;/&gt; &lt;field name=&quot;state&quot;&gt;audit&lt;/field&gt; &lt;field name=&quot;is_sys_default&quot; eval=&quot;True&quot;/&gt; &lt;/record&gt; &lt;!-- 无库存销售订单单据类型 --&gt; &lt;record id=&quot;mdm_document_type_unstk_med_sal_order&quot; model=&quot;mdm.document.type&quot;&gt; &lt;field name=&quot;name&quot;&gt;无库存销售订单&lt;/field&gt; &lt;field name=&quot;corespond_doc_id&quot; ref=&quot;mdm_document_list_med_sal_order&quot;/&gt; &lt;field name=&quot;code_rule_id&quot; ref=&quot;gsp.med_sal_order_code_rule_XMiJLH5oQfWs&quot;/&gt; &lt;field name=&quot;biz_type_id&quot; ref=&quot;mdm_business_type_med_sal_order&quot;/&gt; &lt;field name=&quot;number&quot;&gt;MED_SAL_000003&lt;/field&gt; &lt;field name=&quot;is_default&quot; eval=&quot;False&quot;/&gt; &lt;field name=&quot;state&quot;&gt;audit&lt;/field&gt; &lt;field name=&quot;is_sys_default&quot; eval=&quot;True&quot;/&gt; &lt;/record&gt;&lt;/data&gt; 销售组织，多对一 组织机构: sys.admin.orgs orgs.config xml文件1234567891011121314151617&lt;odoo&gt; &lt;data noupdate=&quot;0&quot;&gt; &lt;record id=&quot;gsp.med_sal_order_stk_org_id&quot; model=&quot;orgs.config&quot;&gt; &lt;field name=&quot;model_id&quot; search=&quot;[(&#x27;model&#x27;, &#x27;=&#x27;, &#x27;med.sal.order&#x27;)]&quot;/&gt; &lt;field name=&quot;field_id&quot; search=&quot;[(&#x27;model&#x27;, &#x27;=&#x27;, &#x27;med.sal.order&#x27;), (&#x27;name&#x27;, &#x27;=&#x27;, &#x27;stk_org_id&#x27;)]&quot;/&gt; &lt;field name=&quot;is_main_org&quot; eval=&quot;False&quot;/&gt; &lt;field name=&quot;direction&quot;&gt;consignee&lt;/field&gt; &lt;field name=&quot;business_domain&quot; ref=&quot;ps_admin.1003_stock_field&quot;/&gt; &lt;field name=&quot;consign_rela_id&quot; ref=&quot;ps_admin.ps_admin_category_data_001&quot;/&gt; &lt;field name=&quot;opposite_org_id&quot; search=&quot;[(&#x27;model&#x27;, &#x27;=&#x27;, &#x27;med.sal.order&#x27;), (&#x27;name&#x27;, &#x27;=&#x27;, &#x27;sal_org_id&#x27;)]&quot;/&gt; &lt;/record&gt; &lt;function model=&quot;ir.model&quot; name=&quot;write&quot;&gt; &lt;value model=&quot;ir.model&quot; search=&quot;[(&#x27;model&#x27;, &#x27;=&#x27;, &#x27;med.sal.order&#x27;)]&quot;/&gt; &lt;value eval=&quot;&#123;&#x27;orgs_config_ids&#x27;: [(4, ref(&#x27;med_sal_order_stk_org_id&#x27;))]&#125;&quot;/&gt; &lt;/function&gt; &lt;/data&gt;&lt;/odoo&gt; 销售部门采购部门开票员库存组织仓库客户销售员物料名称","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"医药公司ERP","slug":"项目/医药公司ERP","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/"},{"name":"业务","slug":"项目/医药公司ERP/业务","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/%E4%B8%9A%E5%8A%A1/"}],"tags":[]},{"title":"销售流程","slug":"项目/医药公司ERP/20230830-销售流程","date":"2023-08-30T15:50:52.000Z","updated":"2024-11-29T02:15:38.606Z","comments":true,"path":"2023/08/30/项目/医药公司ERP/20230830-销售流程/","link":"","permalink":"https://dbbruce.github.io/2023/08/30/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/20230830-%E9%94%80%E5%94%AE%E6%B5%81%E7%A8%8B/","excerpt":"流程","text":"流程","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"医药公司ERP","slug":"项目/医药公司ERP","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/"},{"name":"业务","slug":"项目/医药公司ERP/业务","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/%E4%B8%9A%E5%8A%A1/"}],"tags":[]},{"title":"采购入库单-审核-入库","slug":"项目/医药公司ERP/20230829-采购入库单-审核-入库","date":"2023-08-29T15:34:52.000Z","updated":"2024-11-29T02:15:38.627Z","comments":true,"path":"2023/08/29/项目/医药公司ERP/20230829-采购入库单-审核-入库/","link":"","permalink":"https://dbbruce.github.io/2023/08/29/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/20230829-%E9%87%87%E8%B4%AD%E5%85%A5%E5%BA%93%E5%8D%95-%E5%AE%A1%E6%A0%B8-%E5%85%A5%E5%BA%93/","excerpt":"流程 do_inventory_record_audit p_get_record_rule p_instant_inventory_record _p_instant_inventory_record p_stk_tran_detail_done _p_iis_not_record_qty_release p_get_is_piece_manage _p_instant_inventory_piece_record _p_add_mdm_piece_number _p_update_piece_number_state_detail _p_clear_bak","text":"流程 do_inventory_record_audit p_get_record_rule p_instant_inventory_record _p_instant_inventory_record p_stk_tran_detail_done _p_iis_not_record_qty_release p_get_is_piece_manage _p_instant_inventory_piece_record _p_add_mdm_piece_number _p_update_piece_number_state_detail _p_clear_bak 文件源文件 &#x2F;opt&#x2F;projects&#x2F;insuite&#x2F;biz&#x2F;scm&#x2F;ps_stk&#x2F;stk_tran_detail&#x2F;development&#x2F;models&#x2F;stk_tran_config.py继承文件 &#x2F;opt&#x2F;projects&#x2F;insuite&#x2F;biz&#x2F;med&#x2F;gsp&#x2F;mdm&#x2F;models&#x2F;stk_tran_config.py 库存参数 记账规则为审核时保存操作是否校验负库存: is_check_negative_stock_on_save_when_record_rule_audit 预计可出库数量包含未记账入库: is_est_available_qty_includes_not_record_in_qty 入库单据记账规则: record_rule_in 出库单据记账规则: record_rule_out 1.do_inventory_record_audit 配置位置: 设计器→服务调用→审核后执行的函数1234567891011121314151617def do_inventory_record_audit(self, env, model_key, operation, origin_args, timing, single_record, arg_dict): &quot;&quot;&quot;登记库存账 前提条件需要设置为：非期初单据 and 状态不是暂存 Args: env ([type]): [description] model_key ([type]): [description] operation ([type]): [description] origin_args ([type]): [description] timing ([type]): [description] single_record ([type]): [description] arg_dict ([type]): [description] &quot;&quot;&quot; # 获取采购库存参数 # &#123;&#x27;direction&#x27;: &#x27;in&#x27;, &#x27;record_rule&#x27;: &#x27;audit&#x27;, &#x27;is_check_negative_stock_on_save_when_record_rule_audit&#x27;: &#x27;True&#x27;, &#x27;is_est_available_qty_includes_not_record_in_qty&#x27;: &#x27;False&#x27;&#125; stk_parms = env[&#x27;stk.tran.config&#x27;].p_get_record_rule(model_key, single_record.id) # 开始入库 env[&#x27;stk.tran.config&#x27;].p_instant_inventory_record(model_key, single_record.id, operation=&#x27;audit&#x27;, **stk_parms) 2.p_get_record_rule 查询库存参数 配置位置：查询供应链→库存管理→库存参数123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263def p_get_record_rule(self, doc_model, doc_id): &quot;&quot;&quot; 获取记账规则 doc_model: 模型名，采购入库单: doc_model = med.gsp.pur.receipt doc_id： 单据id，采购入库单: doc_id = 24 返回：&#123;&#125; &#123; &#x27;direction&#x27;: &#x27;in&#x27;, &#x27;record_rule&#x27;: &#x27;audit&#x27;, &#x27;is_check_negative_stock_on_save_when_record_rule_audit&#x27;: &#x27;True&#x27;, &#x27;is_est_available_qty_includes_not_record_in_qty&#x27;: &#x27;False&#x27; &#125; &quot;&quot;&quot; # 根据模型名查询表单是出库还是入库，1为入库，-1为出库 self.env.cr.execute( &quot;select direction from stk_tran_config where parent_model=%s order by direction asc&quot;, (doc_model,)) res = self.env.cr.fetchone() direction = &#x27;in&#x27; if res and res[0] == &#x27;1&#x27; else &#x27;out&#x27; # 查询采购入库表，主组织字段名，关键字段是is_main_org，is_main_org设置字段为主组织 sql = &quot;&quot;&quot; select name from ir_model_fields where id =( select field_id from orgs_config where model_id = ( select id from ir_model where model=%s) and is_main_org=true) &quot;&quot;&quot; self._execute(sql, (doc_model,)) row = self.env.cr.fetchone() # 表体主组织列，执行的结果看下面的SQL stk_org_id_col = row[0] sql = &quot;&quot;&quot; select keys.key,coalesce(vals.value,keys.value) as value from ( select &#x27;record_rule_&#123;direction&#125;&#x27; as key, &#x27;save&#x27; as value union all select &#x27;is_check_negative_stock_on_save_when_record_rule_audit&#x27; as key, &#x27;True&#x27; as value union all select &#x27;is_est_available_qty_includes_not_record_in_qty&#x27; as key, &#x27;False&#x27; as value ) keys left join ( select key,value from sys_business_params where org_id=( select &#123;stk_org_id_col&#125; from &#123;doc_model&#125; where id=%s ) and key in (&#x27;record_rule_&#123;direction&#125;&#x27;,&#x27;is_check_negative_stock_on_save_when_record_rule_audit&#x27;,&#x27;is_est_available_qty_includes_not_record_in_qty&#x27;) ) vals on keys.key = vals.key &quot;&quot;&quot;.format( stk_org_id_col=stk_org_id_col, doc_model=doc_model.replace(&#x27;.&#x27;, &#x27;_&#x27;), direction=direction, ) self._execute(sql, (doc_id,)) res = &#123; &quot;direction&quot;: direction, &#125; rows = self.env.cr.dictfetchall() # [&#123;&#x27;key&#x27;: &#x27;record_rule_in&#x27;, &#x27;value&#x27;: &#x27;audit&#x27;&#125;, &#123;&#x27;key&#x27;: &#x27;is_check_negative_stock_on_save_when_record_rule_audit&#x27;, &#x27;value&#x27;: &#x27;True&#x27;&#125;, &#123;&#x27;key&#x27;: &#x27;is_est_available_qty_includes_not_record_in_qty&#x27;, &#x27;value&#x27;: &#x27;False&#x27;&#125;] for row in rows: key = row[&#x27;key&#x27;] if key in (&#x27;record_rule_in&#x27;, &#x27;record_rule_out&#x27;): key = &#x27;record_rule&#x27; res[key] = row[&#x27;value&#x27;] return res 最后执行的SQL12345678910111213select keys.key,coalesce(vals.value,keys.value) as valuefrom ( select &#x27;record_rule_in&#x27; as key, &#x27;save&#x27; as value union all select &#x27;is_check_negative_stock_on_save_when_record_rule_audit&#x27; as key, &#x27;True&#x27; as value union all select &#x27;is_est_available_qty_includes_not_record_in_qty&#x27; as key, &#x27;False&#x27; as value) keysleft join ( select key,value from sys_business_params where org_id=( select stk_org_id from med_gsp_pur_receipt where id= 24) and key in (&#x27;record_rule_in&#x27;,&#x27;is_check_negative_stock_on_save_when_record_rule_audit&#x27;,&#x27;is_est_available_qty_includes_not_record_in_qty&#x27;)) vals on keys.key = vals.key; 123456 key | value --------------------------------------------------------+------- record_rule_in | save is_check_negative_stock_on_save_when_record_rule_audit | True is_est_available_qty_includes_not_record_in_qty | False(3 rows) 3.p_instant_inventory_record123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566def p_instant_inventory_record(self, doc_model: str, doc_id: int, **kwargs): &quot;&quot;&quot;记录库存账 : 单据保存后调用,需要先恢复库存账，在重新记录 Args: doc_model (str): 单据模型：&#x27;med.gsp.pur.receipt&#x27; doc_ids (int): 单据id：24 **kwargs:入库的一些参数：&#123;&#x27;operation&#x27;: &#x27;save&#x27;, &#x27;direction&#x27;: &#x27;in&#x27;, &#x27;record_rule&#x27;: &#x27;audit&#x27;, &#x27;is_check_negative_stock_on_save_when_record_rule_audit&#x27;: &#x27;True&#x27;, &#x27;is_est_available_qty_includes_not_record_in_qty&#x27;: &#x27;False&#x27;&#125; &quot;&quot;&quot; direction = kwargs.get(&#x27;direction&#x27;) record_rule = kwargs.get(&#x27;record_rule&#x27;) operation = kwargs.get(&#x27;operation&#x27;) is_check_negative_stock_on_save_when_record_rule_audit = kwargs.get(&#x27;is_check_negative_stock_on_save_when_record_rule_audit&#x27;) == &#x27;True&#x27; # 采购入库单保存 if operation == &#x27;save&#x27;: if record_rule == &#x27;save&#x27;: self.p_instant_inventory_restore(doc_model, doc_id, from_record=True, **kwargs) self._p_instant_inventory_record(doc_model, doc_id, **kwargs) self.p_stk_tran_detail_done(doc_model, doc_id) # 占用，默认direction=1 obj = self.env[doc_model] f = getattr(obj, &#x27;inventory_add_after&#x27;, None) if f: f(doc_id) # 校验一下负库存 if direction == &#x27;out&#x27;: self._check_negative_stock(doc_model, doc_id) # 处理单件 self._p_instant_inventory_piece_record(doc_model, doc_id) # 校验一下单件负库存 if direction == &#x27;out&#x27;: self._check_negative_piece(doc_model, doc_id, &quot;save&quot;) # 插入单件主档 self._p_add_mdm_piece_number(doc_model, doc_id) # 更新单件主档状态 self._p_update_piece_number_state_detail(doc_model, doc_id) else: self._p_iis_not_record_qty(doc_model, doc_id, **kwargs) if direction == &#x27;out&#x27; and is_check_negative_stock_on_save_when_record_rule_audit: self._check_negative_stock(doc_model, doc_id) self._check_negative_piece(doc_model, doc_id, &quot;save&quot;) elif operation == &#x27;audit&#x27;: if record_rule == &#x27;save&#x27;: pass else: self._p_instant_inventory_record(doc_model, doc_id, **kwargs) self.p_stk_tran_detail_done(doc_model, doc_id) # 释放 not_record_in_qty self._p_iis_not_record_qty_release(doc_model, doc_id, **kwargs) # 占用 obj = self.env[doc_model] f = getattr(obj, &#x27;inventory_add_after&#x27;, None) if f: f(doc_id) # 校验一下负库存 if direction == &#x27;out&#x27;: self._check_negative_stock(doc_model, doc_id) self._p_instant_inventory_piece_record(doc_model, doc_id) # 校验一下单件负库存 if direction == &#x27;out&#x27;: self._check_negative_piece(doc_model, doc_id, &quot;save&quot;) # 插入单件主档 self._p_add_mdm_piece_number(doc_model, doc_id) # 更新单件主档状态 self._p_update_piece_number_state_detail(doc_model, doc_id) # 清空bak表 self._p_clear_bak(doc_model, doc_id, is_piece=False) self._p_clear_bak(doc_model, doc_id, is_piece=True) 4._p_instant_inventory_record123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330def _p_instant_inventory_record(self, doc_model: str, doc_id: int, **kwargs): # 将stk_tran_detail中的记录计算到即时库存表中 direction = kwargs.get(&#x27;direction&#x27;) record_rule = kwargs.get(&#x27;record_rule&#x27;) operation = kwargs.get(&#x27;operation&#x27;) is_est_available_qty_includes_not_record_in_qty = kwargs.get(&#x27;is_est_available_qty_includes_not_record_in_qty&#x27;) == &#x27;True&#x27; uid = self.env.uid or 1 DBTYPE = self.env.cr.dbtype if DBTYPE in (&#x27;postgres&#x27;, &#x27;opengauss&#x27;): flex_str = &quot;max(coalesce(cast(flex as text), &#x27;&#123;&#125;&#x27;))::jsonb as flex&quot; else: flex_str = &quot;max(coalesce(cast(flex as text), &#x27;&#123;&#125;&#x27;)) as flex&quot; middle = f&quot;&quot;&quot; (select max(tenant_id) as tenant_id, max(material_id) as material_id, max(material_master_id) as material_master_id, max(auxiliary) as auxiliary, &#123;flex_str&#125;, max(stk_org_id) as stk_org_id, max(owner_type) as owner_type, max(uom_id) as uom_id, max(material_stk_uom_id) as stk_uom_id, max(material_aux_uom_id) as aux_uom_id, sum(qty * cast(qty_option as int)) as qty, sum(material_stk_qty * cast(qty_option as int)) as stk_qty, sum(material_aux_qty * cast(qty_option as int)) as aux_qty, sum(qty * cast(qty_option as int)) as available_qty, sum(material_stk_qty * cast(qty_option as int)) as available_stk_qty, sum(material_aux_qty * cast(qty_option as int)) as available_aux_qty, 0 as occupied_qty, 0 as occupied_stk_qty, 0 as occupied_aux_qty, max(lot) as lot, max(produce_date) as produce_date, max(valid_date) as valid_date, max(warehouse_id) as warehouse_id, max(location_id) as location_id, max(stk_state_id) as stk_state_id, max(bom_version_id) as bom_version_id, max(bom_version_master_id) as bom_version_master_id, max(material_number) as material_number, max(material_specification) as material_specification, max(mto_num) as mto_num, search_key from stk_tran_detail where src_parent_model = %s and src_parent_id = %s group by search_key) &quot;&quot;&quot; # search_key存在的则更新 update_sql = f&quot;&quot;&quot; update stk_instant_inventory set qty = coalesce(stk_instant_inventory.qty,0) + detail.qty, stk_qty = coalesce(stk_instant_inventory.stk_qty,0) + detail.stk_qty, aux_qty = coalesce(stk_instant_inventory.aux_qty,0) + detail.aux_qty, available_qty = coalesce(stk_instant_inventory.available_qty,0) + detail.qty, available_stk_qty = coalesce(stk_instant_inventory.available_stk_qty,0) + detail.stk_qty, available_aux_qty = coalesce(stk_instant_inventory.available_aux_qty,0) + detail.aux_qty, write_uid = &#123;uid&#125;, &quot;&quot;&quot; if direction == &#x27;out&#x27;: update_sql += &quot;&quot;&quot; not_record_out_qty = 0, not_record_out_stk_qty = 0, not_record_out_aux_qty = 0, &quot;&quot;&quot; else: update_sql += &quot;&quot;&quot; not_record_in_qty = 0, not_record_in_stk_qty = 0, not_record_in_aux_qty = 0, &quot;&quot;&quot; if is_est_available_qty_includes_not_record_in_qty: update_sql += &quot;&quot;&quot; est_available_qty = coalesce(stk_instant_inventory.available_qty,0) + detail.qty - coalesce(stk_instant_inventory.not_record_out_qty,0) + coalesce(stk_instant_inventory.not_record_in_qty,0), est_available_stk_qty = coalesce(stk_instant_inventory.available_stk_qty,0) + detail.stk_qty - coalesce(stk_instant_inventory.not_record_out_stk_qty,0) + coalesce(stk_instant_inventory.not_record_in_stk_qty,0), est_available_aux_qty = coalesce(stk_instant_inventory.available_aux_qty,0) + detail.aux_qty - coalesce(stk_instant_inventory.not_record_out_aux_qty,0) + coalesce(stk_instant_inventory.not_record_in_aux_qty,0), &quot;&quot;&quot; else: update_sql += &quot;&quot;&quot; est_available_qty = coalesce(stk_instant_inventory.available_qty,0) + detail.qty - coalesce(stk_instant_inventory.not_record_out_qty,0), est_available_stk_qty = coalesce(stk_instant_inventory.available_stk_qty,0) + detail.stk_qty - coalesce(stk_instant_inventory.not_record_out_stk_qty,0), est_available_aux_qty = coalesce(stk_instant_inventory.available_aux_qty,0) + detail.aux_qty - coalesce(stk_instant_inventory.not_record_out_aux_qty,0), &quot;&quot;&quot; update_sql += f&quot;&quot;&quot; write_date = localtimestamp(6) from &#123;middle&#125; detail where stk_instant_inventory.search_key=detail.search_key &quot;&quot;&quot; self._execute(update_sql, (doc_model, doc_id)) # search_key不存在的则插入 insert_sql = f&quot;&quot;&quot; insert into stk_instant_inventory ( tenant_id, material_id, material_master_id, auxiliary, flex, stk_org_id, owner_type, uom_id, stk_uom_id, aux_uom_id, qty, stk_qty, aux_qty, available_qty, available_stk_qty, available_aux_qty, occupied_qty, occupied_stk_qty, occupied_aux_qty, est_available_qty, est_available_stk_qty, est_available_aux_qty, lot, produce_date, valid_date, warehouse_id, location_id, stk_state_id, bom_version_id, bom_version_master_id, material_number, material_specification, mto_num, search_key, delete_state, create_uid, create_date, write_uid, write_date ) select tenant_id, material_id, material_master_id, auxiliary, flex, stk_org_id, owner_type, uom_id, stk_uom_id, aux_uom_id, qty, stk_qty, aux_qty, available_qty, available_stk_qty, available_aux_qty, occupied_qty, occupied_stk_qty, occupied_aux_qty, available_qty, available_stk_qty, available_aux_qty, lot, produce_date, valid_date, warehouse_id, location_id, stk_state_id, bom_version_id, bom_version_master_id, material_number, material_specification, mto_num, search_key, &#x27;normal&#x27;, &#123;uid&#125;, localtimestamp(6), &#123;uid&#125;, localtimestamp(6) &quot;&quot;&quot; + f&quot;&quot;&quot; from &#123;middle&#125; detail where not exists(select * from stk_instant_inventory where stk_instant_inventory.search_key=detail.search_key) &quot;&quot;&quot; self._execute(insert_sql, (doc_model, doc_id)) # 将stk_tran_detail中的记录计算到医药即时库存表中 sql_update = &quot;&quot;&quot; --sql update stk_tran_detail set search_key_location = regexp_replace(search_key,&#x27;([^_]*)_([^_]*)_([^_]*)(.*)&#x27;,&#x27;\\\\1_\\\\2_False\\\\4&#x27;) where src_parent_model = %s and src_parent_id = %s; &quot;&quot;&quot; self._execute(sql_update, (doc_model, doc_id)) sql_med = &quot;&quot;&quot; --sql with detail as (select max(tenant_id) as tenant_id, max(material_id) as material_id, max(material_master_id) as material_master_id, max(auxiliary) as auxiliary, max(coalesce(flex::text, &#x27;&#123;&#123;&#125;&#125;&#x27;))::jsonb as flex, max(stk_org_id) as stk_org_id, max(owner_type) as owner_type, max(uom_id) as uom_id, max(stk_uom_id) as stk_uom_id, max(aux_uom_id) as aux_uom_id, sum(qty * qty_option::int * 1) as qty, sum(stk_qty * qty_option::int * 1) as stk_qty, sum(aux_qty * qty_option::int * 1) as aux_qty, sum(qty * qty_option::int * 1) as available_qty, sum(stk_qty * qty_option::int * 1) as available_stk_qty, sum(aux_qty * qty_option::int * 1) as available_aux_qty, 0 as occupied_qty, 0 as occupied_stk_qty, 0 as occupied_aux_qty, sum(case area_type when &#x27;escrow&#x27; then stk_qty * qty_option::int * 1 else 0 end) as escrow_stk_qty, max(lot) as lot, max(produce_date) as produce_date, max(valid_date) as valid_date, max(warehouse_id) as warehouse_id, max(location_id) as location_id, max(stk_state_id) as stk_state_id, max(bom_version_id) as bom_version_id, max(material_number) as material_number, max(material_specification) as material_specification, max(mto_num) as mto_num, &#x27;search_key&#x27; as search_key, search_key_location, min(biz_date) as biz_date from stk_tran_detail where src_parent_model = %s and src_parent_id = %s group by search_key_location) insert into med_stk_instant_inventory ( tenant_id, material_id, material_master_id, auxiliary, flex, stk_org_id, owner_type, uom_id, stk_uom_id, aux_uom_id, qty, stk_qty, aux_qty, available_qty, available_stk_qty, available_aux_qty, occupied_qty, occupied_stk_qty, occupied_aux_qty, escrow_stk_qty, available_no_escrow_stk_qty, lot, produce_date, valid_date, warehouse_id, location_id, stk_state_id, bom_version_id, mto_num, search_key, material_number, material_specification, search_key_location, delete_state, create_uid, create_date, write_uid, write_date, biz_date, curing_time, state ) select tenant_id, material_id, material_master_id, auxiliary, flex, stk_org_id, owner_type, uom_id, stk_uom_id, aux_uom_id, qty, stk_qty, aux_qty, available_qty, available_stk_qty, available_aux_qty, occupied_qty, occupied_stk_qty, occupied_aux_qty, escrow_stk_qty, available_stk_qty - escrow_stk_qty, lot, produce_date, valid_date, warehouse_id, location_id, stk_state_id, bom_version_id, mto_num, search_key, material_number, material_specification, search_key_location, &#x27;normal&#x27;, &#123;create_uid&#125;, localtimestamp(6), &#123;write_uid&#125;, localtimestamp(6), biz_date, biz_date, &#x27;audit&#x27; from detail on conflict (search_key_location) do update set qty = med_stk_instant_inventory.qty + excluded.qty, stk_qty = med_stk_instant_inventory.stk_qty + excluded.stk_qty, aux_qty = med_stk_instant_inventory.aux_qty + excluded.aux_qty, available_qty = med_stk_instant_inventory.available_qty + excluded.qty, available_stk_qty = med_stk_instant_inventory.available_stk_qty + excluded.stk_qty, available_aux_qty = med_stk_instant_inventory.available_aux_qty + excluded.aux_qty, escrow_stk_qty = med_stk_instant_inventory.escrow_stk_qty +excluded.escrow_stk_qty, available_no_escrow_stk_qty = med_stk_instant_inventory.available_no_escrow_stk_qty + excluded.stk_qty - excluded.escrow_stk_qty, write_date = localtimestamp(6), write_uid = &#123;write_uid&#125; ; &quot;&quot;&quot;.format(create_uid=uid, write_uid=uid) self._execute(sql_med, (doc_model, doc_id)) 5.p_stk_tran_detail_done123456def p_stk_tran_detail_done(self, doc_model, doc_id, is_done=True): &quot;&quot;&quot; 设置台账记账标志 &quot;&quot;&quot; return self._execute(&quot;&quot;&quot; update stk_tran_detail set is_done=%s where src_parent_model = %s and src_parent_id = %s&quot;&quot;&quot;, (is_done, doc_model, doc_id)) 6._p_iis_not_record_qty_release123456789101112131415161718192021222324252627282930313233343536373839404142def _p_iis_not_record_qty_release(self, doc_model: str, doc_id: int, **kwargs): # 将stk_tran_detail中的记录计算到即时库存表中 uid = self.env.uid or 1 release = kwargs.get(&#x27;release&#x27;, &#x27;&#x27;) is_est_available_qty_includes_not_record_in_qty = kwargs.get(&#x27;is_est_available_qty_includes_not_record_in_qty&#x27;) == &#x27;True&#x27; sql = f&quot;&quot;&quot; update stk_instant_inventory set not_record_in_qty = coalesce(stk_instant_inventory.not_record_in_qty,0) - detail.not_record_in_qty, not_record_in_stk_qty = coalesce(stk_instant_inventory.not_record_in_stk_qty,0) - detail.not_record_in_stk_qty, not_record_in_aux_qty = coalesce(stk_instant_inventory.not_record_in_aux_qty,0) - detail.not_record_in_aux_qty, not_record_out_qty = coalesce(stk_instant_inventory.not_record_out_qty,0) - detail.not_record_out_qty, not_record_out_stk_qty = coalesce(stk_instant_inventory.not_record_out_stk_qty,0) - detail.not_record_out_stk_qty, not_record_out_aux_qty = coalesce(stk_instant_inventory.not_record_out_aux_qty,0) - detail.not_record_out_aux_qty, write_date = localtimestamp(6), write_uid = &#123;uid&#125;, &quot;&quot;&quot; if is_est_available_qty_includes_not_record_in_qty: sql = sql + &quot;&quot;&quot; est_available_qty = coalesce(stk_instant_inventory.available_qty,0) - (coalesce(stk_instant_inventory.not_record_out_qty,0) - detail.not_record_out_qty) + (coalesce(stk_instant_inventory.not_record_in_qty,0) - detail.not_record_in_qty), est_available_stk_qty = coalesce(stk_instant_inventory.available_stk_qty,0) - (coalesce(stk_instant_inventory.not_record_out_stk_qty,0) - detail.not_record_out_stk_qty) + (coalesce(stk_instant_inventory.not_record_in_stk_qty,0) - detail.not_record_in_stk_qty), est_available_aux_qty = coalesce(stk_instant_inventory.available_aux_qty,0) - (coalesce(stk_instant_inventory.not_record_out_aux_qty,0) - detail.not_record_out_aux_qty) + (coalesce(stk_instant_inventory.not_record_in_aux_qty,0) - detail.not_record_in_aux_qty) &quot;&quot;&quot; else: sql = sql + &quot;&quot;&quot; est_available_qty = coalesce(stk_instant_inventory.available_qty,0) - (coalesce(stk_instant_inventory.not_record_out_qty,0) - detail.not_record_out_qty), est_available_stk_qty = coalesce(stk_instant_inventory.available_stk_qty,0) - (coalesce(stk_instant_inventory.not_record_out_stk_qty,0) - detail.not_record_out_stk_qty), est_available_aux_qty = coalesce(stk_instant_inventory.available_aux_qty,0) - (coalesce(stk_instant_inventory.not_record_out_aux_qty,0) - detail.not_record_out_aux_qty) &quot;&quot;&quot; sql += f&quot;&quot;&quot; from (select sum(case when qty_option=&#x27;1&#x27; then 0 else 0 end) as not_record_in_qty, sum(case when qty_option=&#x27;1&#x27; then 0 else 0 end) as not_record_in_stk_qty, sum(case when qty_option=&#x27;1&#x27; then 0 else 0 end) as not_record_in_aux_qty, sum(case when qty_option=&#x27;-1&#x27; then 0 else 0 end) as not_record_out_qty, sum(case when qty_option=&#x27;-1&#x27; then 0 else 0 end) as not_record_out_stk_qty, sum(case when qty_option=&#x27;-1&#x27; then 0 else 0 end) as not_record_out_aux_qty, search_key from stk_tran_detail&#123;release&#125; where src_parent_model = %s and src_parent_id = %s group by search_key) detail where stk_instant_inventory.search_key = detail.search_key&quot;&quot;&quot; self._execute(sql, (doc_model, doc_id)) 7.p_get_is_piece_manage1234def p_get_is_piece_manage(cls, env): &quot;&quot;&quot;是否启用单件号&quot;&quot;&quot; piece_reuse_config = env[&#x27;ir.config_parameter&#x27;].get_param(key=&#x27;is_piece_number_management&#x27;, default=&#x27;False&#x27;) return piece_reuse_config == &#x27;True&#x27; 8._p_instant_inventory_piece_record123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145def _p_instant_inventory_piece_record(self, doc_model: str, doc_id: int, **kwargs): &quot;&quot;&quot;记录库存账 单据保存后调用,需要先恢复库存账，在重新记录 Args: doc_model (str): 单据模型 doc_ids (int): 单据id &quot;&quot;&quot; if not self.p_get_is_piece_manage(self.env): return direction = kwargs.get(&#x27;direction&#x27;) record_rule = kwargs.get(&#x27;record_rule&#x27;) operation = kwargs.get(&#x27;operation&#x27;) # 将stk_tran_detail中的记录计算到即时库存表中 DBTYPE = self.env.cr.dbtype if DBTYPE in (&#x27;postgres&#x27;, &#x27;opengauss&#x27;): flex_str = &quot;max(coalesce(cast(flex as text), &#x27;&#123;&#125;&#x27;))::jsonb as flex&quot; else: flex_str = &quot;max(coalesce(cast(flex as text), &#x27;&#123;&#125;&#x27;)) as flex&quot; middle= f&quot;&quot;&quot; (select max(tenant_id) as tenant_id, max(material_id) as material_id, max(material_master_id) as material_master_id, max(auxiliary) as auxiliary, &#123;flex_str&#125;, max(stk_org_id) as stk_org_id, max(owner_type) as owner_type, max(uom_id) as uom_id, max(material_stk_uom_id) as stk_uom_id, max(material_aux_uom_id) as aux_uom_id, sum(qty * cast(qty_option as int)) as qty, sum(material_stk_qty * cast(qty_option as int)) as stk_qty, sum(material_aux_qty * cast(qty_option as int)) as aux_qty, sum(qty * cast(qty_option as int)) as available_qty, sum(material_stk_qty * cast(qty_option as int)) as available_stk_qty, sum(material_aux_qty * cast(qty_option as int)) as available_aux_qty, 0 as occupied_qty, 0 as occupied_stk_qty, 0 as occupied_aux_qty, max(lot) as lot, max(produce_date) as produce_date, max(valid_date) as valid_date, max(warehouse_id) as warehouse_id, max(location_id) as location_id, max(stk_state_id) as stk_state_id, max(bom_version_id) as bom_version_id, max(bom_version_master_id) as bom_version_master_id, max(material_number) as material_number, max(material_specification) as material_specification, max(mto_num) as mto_num, search_key,piece_number from stk_tran_detail_piece where src_parent_model = %s and src_parent_id = %s and piece_number is not null group by search_key,piece_number) &quot;&quot;&quot; update_sql = f&quot;&quot;&quot; update stk_instant_inventory_piece set qty = coalesce(stk_instant_inventory_piece.qty,0) + detail.qty, stk_qty = coalesce(stk_instant_inventory_piece.stk_qty,0) + detail.stk_qty, aux_qty = coalesce(stk_instant_inventory_piece.aux_qty,0) + detail.aux_qty, available_qty = coalesce(stk_instant_inventory_piece.available_qty,0) + detail.qty, available_stk_qty = coalesce(stk_instant_inventory_piece.available_stk_qty,0) + detail.stk_qty, available_aux_qty = coalesce(stk_instant_inventory_piece.available_aux_qty,0) + detail.aux_qty from &#123;middle&#125; detail where stk_instant_inventory_piece.search_key=detail.search_key and stk_instant_inventory_piece.piece_number = detail.piece_number &quot;&quot;&quot; self._execute(update_sql, (doc_model, doc_id)) insert_sql = f&quot;&quot;&quot; insert into stk_instant_inventory_piece ( tenant_id, material_id, material_master_id, auxiliary, flex, stk_org_id, owner_type, uom_id, stk_uom_id, aux_uom_id, qty, stk_qty, aux_qty, available_qty, available_stk_qty, available_aux_qty, occupied_qty, occupied_stk_qty, occupied_aux_qty, lot, produce_date, valid_date, warehouse_id, location_id, stk_state_id, bom_version_id, bom_version_master_id, material_number, material_specification, mto_num, search_key, piece_number, delete_state ) select tenant_id, material_id, material_master_id, auxiliary, flex, stk_org_id, owner_type, uom_id, stk_uom_id, aux_uom_id, qty, stk_qty, aux_qty, available_qty, available_stk_qty, available_aux_qty, occupied_qty, occupied_stk_qty, occupied_aux_qty, lot, produce_date, valid_date, warehouse_id, location_id, stk_state_id, bom_version_id, bom_version_master_id, material_number, material_specification, mto_num, search_key, piece_number, &#x27;normal&#x27; from &#123;middle&#125; detail where not exists(select 1 from stk_instant_inventory_piece where stk_instant_inventory_piece.search_key=detail.search_key and stk_instant_inventory_piece.piece_number = detail.piece_number) &quot;&quot;&quot; self._execute(insert_sql, (doc_model, doc_id)) 9._p_add_mdm_piece_number1234567891011121314151617181920212223def _p_add_mdm_piece_number(self, doc_model: str, doc_id: int): &quot;&quot;&quot;根据台账插入件号主档 Args: doc_model (str): 单据模型 doc_ids (int): 单据id &quot;&quot;&quot; if not self.p_get_is_piece_manage(self.env): return # 直接调拨单调用时不生成件号 if doc_model == &#x27;stk.direct.trans&#x27;: self._execute(&quot;&quot;&quot;select transfer_type from stk_direct_trans where id=%s&quot;&quot;&quot;, (doc_id,)) row = self.env.cr.fetchone() if row and row[0] == &#x27;mono-orgnization transfer&#x27;: return # 插入主档 sql = &quot;&quot;&quot; --sql insert into mdm_piece_number(biz_org_id,instock_date,material_master_id,material_id,name,piece_number_state,state,tenant_id,delete_state,create_uid,create_date,write_uid,write_date) select stk_org_id,biz_date,m.master_id,material_id,piece_number,&#x27;has_been_stored&#x27;,&#x27;save&#x27;,stdp.tenant_id,&#x27;normal&#x27;,stdp.create_uid,stdp.create_date,stdp.write_uid,stdp.write_date from stk_tran_detail_piece stdp left join mdm_material m on stdp.material_id = m.id where src_parent_model = %s and src_parent_id= %s and qty_option=&#x27;1&#x27; and not exists( select * from mdm_piece_number p where p.material_id = stdp.material_id and p.name = stdp.piece_number and p.delete_state =&#x27;normal&#x27;); &quot;&quot;&quot; self._execute(sql, (doc_model, doc_id)) 10._p_update_piece_number_state_detail123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104def _p_update_piece_number_state_detail(self, doc_model: str, doc_id: int): &quot;&quot;&quot;根据台账表中的数据更新状态 1 unused-&gt;has_been_stored -1 has_been_stored-&gt;out_of_stock Args: doc_model (str): [description] doc_id (int): [description] &quot;&quot;&quot; if not self.p_get_is_piece_manage(self.env): return sql = &quot;&quot;&quot; --sql 性能有问题TODO update mdm_piece_number p set piece_number_state = (case when data3.qty_option=&#x27;1&#x27; then &#x27;has_been_stored&#x27; else &#x27;out_of_stock&#x27; end), instock_date = (case when data3.qty_option=&#x27;1&#x27; then data3.biz_date else p.instock_date end) from ( select qty_option,stk_qty,material_id,piece_number,biz_date from stk_tran_detail_piece where src_parent_model = %s and src_parent_id = %s ) data3 where p.material_id = data3.material_id and p.name = data3.piece_number and p.delete_state=&#x27;normal&#x27; ; &quot;&quot;&quot; self._execute(sql, (doc_model, doc_id)) if self.p_get_is_barcode_manage(self.env): # 更新条码主档 sql = &quot;&quot;&quot; update mdm_barcode_main mbm set barcode_state = mpn.piece_number_state from mdm_piece_number mpn where mbm.barcode_type_number = &#x27;BCT000003&#x27; and mbm.material_id = mpn.material_id and mbm.name = mpn.name and (mbm.material_id,mbm.name) in (select material_id,piece_number from stk_tran_detail_piece where src_parent_model = %s and src_parent_id = %s ) &quot;&quot;&quot; self._execute(sql, (doc_model, doc_id)) # 单件码的时候 if self.p_get_direction(doc_model) == &#x27;out&#x27;: sql = &quot;&quot;&quot; update mdm_barcode_main mbm set qty=stdp.qty, stk_qty=stdp.stk_qty, aux_qty=stdp.aux_qty, amount=stdp.stk_qty * price from stk_instant_inventory_piece stdp where mbm.barcode_type_number = &#x27;BCT000003&#x27; and mbm.material_id=stdp.material_id and mbm.name=stdp.piece_number and mbm.search_key=stdp.search_key &quot;&quot;&quot; self._execute(sql) # 1.入库时更新条码主档上所有其他字段；出库从库存上改数量 sql = &quot;&quot;&quot; update mdm_barcode_main mbm set uom_id=stdp.uom_id, stk_uom_id=stdp.stk_uom_id, aux_uom_id=stdp.aux_uom_id, qty=stdp.qty, stk_qty=stdp.stk_qty, aux_qty=stdp.aux_qty, bom_version_id=stdp.bom_version_id, flex=stdp.flex, auxiliary=stdp.auxiliary, warehouse_id=stdp.warehouse_id, location_id=stdp.location_id, stk_state_id=stdp.stk_state_id, mto_num=stdp.mto_num, owner_type=stdp.owner_type, lot=stdp.lot, produce_date=stdp.produce_date, valid_date=stdp.valid_date, search_key=stdp.search_key from stk_tran_detail_piece stdp where mbm.barcode_type_number = &#x27;BCT000003&#x27; and mbm.material_id=stdp.material_id and mbm.name=stdp.piece_number and stdp.src_parent_model = %s and stdp.src_parent_id = %s and stdp.qty_option=&#x27;1&#x27; &quot;&quot;&quot; self._execute(sql, (doc_model, doc_id)) # 单件码的时候 if self.p_get_direction(doc_model) == &#x27;out&#x27;: sql = &quot;&quot;&quot; update mdm_barcode_main mbm set qty=stdp.qty, stk_qty=stdp.stk_qty, aux_qty=stdp.aux_qty, amount=stdp.stk_qty * price from stk_instant_inventory_piece stdp where mbm.barcode_type_number = &#x27;BCT000003&#x27; and mbm.material_id=stdp.material_id and mbm.name=stdp.piece_number and mbm.search_key=stdp.search_key &quot;&quot;&quot; self._execute(sql) # 1.入库时更新条码主档上所有其他字段；出库从库存上改数量 sql = &quot;&quot;&quot; update mdm_barcode_main mbm set uom_id=stdp.uom_id, stk_uom_id=stdp.stk_uom_id, aux_uom_id=stdp.aux_uom_id, qty=stdp.qty, stk_qty=stdp.stk_qty, aux_qty=stdp.aux_qty, bom_version_id=stdp.bom_version_id, flex=stdp.flex, auxiliary=stdp.auxiliary, warehouse_id=stdp.warehouse_id, location_id=stdp.location_id, stk_state_id=stdp.stk_state_id, mto_num=stdp.mto_num, owner_type=stdp.owner_type, lot=stdp.lot, produce_date=stdp.produce_date, valid_date=stdp.valid_date, search_key=stdp.search_key from stk_tran_detail_piece stdp where mbm.barcode_type_number = &#x27;BCT000003&#x27; and mbm.material_id=stdp.material_id and mbm.name=stdp.piece_number and stdp.src_parent_model = %s and stdp.src_parent_id = %s and stdp.qty_option=&#x27;1&#x27; &quot;&quot;&quot; self._execute(sql, (doc_model, doc_id)) 11._p_clear_bak1234567891011def _p_clear_bak(self, doc_model: str, doc_id: int, is_piece=False): &quot;&quot;&quot;删除台账备份 Args: doc_model (str): 单据模型 doc_ids (int): 单据id is_piece (bool): 是否单件表 &quot;&quot;&quot; if is_piece and not self.p_get_is_piece_manage(self.env): return bak_table = [&#x27;stk_tran_detail_bak&#x27;, &#x27;stk_tran_detail_piece_bak&#x27;][is_piece] self._execute(&quot;&quot;&quot; delete from &#123;table&#125; where src_parent_model = %s and src_parent_id = %s &quot;&quot;&quot;.format(table=bak_table), (doc_model, doc_id))","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"医药公司ERP","slug":"项目/医药公司ERP","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/"},{"name":"业务","slug":"项目/医药公司ERP/业务","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/%E4%B8%9A%E5%8A%A1/"}],"tags":[]},{"title":"采购入库单-保存","slug":"项目/医药公司ERP/20230828-采购入库单-保存","date":"2023-08-28T14:14:52.000Z","updated":"2024-11-29T02:15:38.588Z","comments":true,"path":"2023/08/28/项目/医药公司ERP/20230828-采购入库单-保存/","link":"","permalink":"https://dbbruce.github.io/2023/08/28/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/20230828-%E9%87%87%E8%B4%AD%E5%85%A5%E5%BA%93%E5%8D%95-%E4%BF%9D%E5%AD%98/","excerpt":"保存流程 do_inventory_record p_get_record_rule p_instant_inventory_record _p_iis_not_record_qty _p_clear_bak","text":"保存流程 do_inventory_record p_get_record_rule p_instant_inventory_record _p_iis_not_record_qty _p_clear_bak do_inventory_record123456789101112131415def do_inventory_record(self, env, model_key, operation, origin_args, timing, single_record, arg_dict): &quot;&quot;&quot;登记库存账 前提条件需要设置为：非期初单据 and 状态不是暂存 Args: env ([type]): [description] model_key ([type]): [description] operation ([type]): [description] origin_args ([type]): [description] timing ([type]): [description] single_record ([type]): [description] arg_dict ([type]): [description] &quot;&quot;&quot; # 获取库存配置参数 stk_parms = env[&#x27;stk.tran.config&#x27;].p_get_record_rule(model_key, single_record.id) env[&#x27;stk.tran.config&#x27;].p_instant_inventory_record(model_key, single_record.id, operation=&#x27;save&#x27;, **stk_parms) _p_iis_not_record_qty123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360@api.modeldef _p_iis_not_record_qty(self, doc_model: str, doc_id: int, **kwargs): uid = self.env.uid or 1 operation = kwargs.get(&#x27;operation&#x27;) is_est_available_qty_includes_not_record_in_qty = kwargs.get(&#x27;is_est_available_qty_includes_not_record_in_qty&#x27;) == &#x27;True&#x27; DBTYPE = self.env.cr.dbtype if DBTYPE in (&#x27;postgres&#x27;, &#x27;opengauss&#x27;): flex_str = &quot;max(coalesce(cast(flex as text), &#x27;&#123;&#125;&#x27;))::jsonb as flex&quot; else: flex_str = &quot;max(coalesce(cast(flex as text), &#x27;&#123;&#125;&#x27;)) as flex&quot; if &#x27;audit&#x27; not in operation: middle = f&quot;&quot;&quot; (select max(tenant_id) as tenant_id, max(material_id) as material_id, max(material_master_id) as material_master_id, max(auxiliary) as auxiliary, &#123;flex_str&#125;, max(stk_org_id) as stk_org_id, max(owner_type) as owner_type, max(uom_id) as uom_id, max(material_stk_uom_id) as stk_uom_id, max(material_aux_uom_id) as aux_uom_id, sum(case when qty_option=&#x27;1&#x27; then 0 else 0 end) as not_record_in_qty, sum(case when qty_option=&#x27;1&#x27; then 0 else 0 end) as not_record_in_stk_qty, sum(case when qty_option=&#x27;1&#x27; then 0 else 0 end) as not_record_in_aux_qty, sum(case when qty_option=&#x27;-1&#x27; then 0 else 0 end) as not_record_out_qty, sum(case when qty_option=&#x27;-1&#x27; then 0 else 0 end) as not_record_out_stk_qty, sum(case when qty_option=&#x27;-1&#x27; then 0 else 0 end) as not_record_out_aux_qty, max(lot) as lot, max(produce_date) as produce_date, max(valid_date) as valid_date, max(warehouse_id) as warehouse_id, max(location_id) as location_id, max(stk_state_id) as stk_state_id, max(bom_version_id) as bom_version_id, max(bom_version_master_id) as bom_version_master_id, max(material_number) as material_number, max(material_specification) as material_specification, max(mto_num) as mto_num, search_key from stk_tran_detail_bak where src_parent_model = %s and src_parent_id = %s group by search_key) &quot;&quot;&quot; update_sql = f&quot;&quot;&quot; update stk_instant_inventory set not_record_in_qty = coalesce(stk_instant_inventory.not_record_in_qty,0) - detail.not_record_in_qty, not_record_in_stk_qty = coalesce(stk_instant_inventory.not_record_in_stk_qty,0) - detail.not_record_in_stk_qty, not_record_in_aux_qty = coalesce(stk_instant_inventory.not_record_in_aux_qty,0) - detail.not_record_in_aux_qty, not_record_out_qty = coalesce(stk_instant_inventory.not_record_out_qty,0) - detail.not_record_out_qty, not_record_out_stk_qty = coalesce(stk_instant_inventory.not_record_out_stk_qty,0) - detail.not_record_out_stk_qty, not_record_out_aux_qty = coalesce(stk_instant_inventory.not_record_out_aux_qty,0) - detail.not_record_out_aux_qty, write_date = localtimestamp(6), write_uid = &#123;uid&#125;, &quot;&quot;&quot; if is_est_available_qty_includes_not_record_in_qty: update_sql += &quot;&quot;&quot; est_available_qty = coalesce(stk_instant_inventory.available_qty,0) - (coalesce(stk_instant_inventory.not_record_out_qty,0) - detail.not_record_out_qty) + (coalesce(stk_instant_inventory.not_record_in_qty,0) - detail.not_record_in_qty), est_available_stk_qty = coalesce(stk_instant_inventory.available_stk_qty,0) - (coalesce(stk_instant_inventory.not_record_out_stk_qty,0) - detail.not_record_out_stk_qty) + (coalesce(stk_instant_inventory.not_record_in_stk_qty,0) - detail.not_record_in_stk_qty), est_available_aux_qty = coalesce(stk_instant_inventory.available_aux_qty,0) - (coalesce(stk_instant_inventory.not_record_out_aux_qty,0) - detail.not_record_out_aux_qty) + (coalesce(stk_instant_inventory.not_record_in_aux_qty,0) - detail.not_record_in_aux_qty) &quot;&quot;&quot; else: update_sql += &quot;&quot;&quot; est_available_qty = coalesce(stk_instant_inventory.available_qty,0) - (coalesce(stk_instant_inventory.not_record_out_qty,0) - detail.not_record_out_qty), est_available_stk_qty = coalesce(stk_instant_inventory.available_stk_qty,0) - (coalesce(stk_instant_inventory.not_record_out_stk_qty,0) - detail.not_record_out_stk_qty), est_available_aux_qty = coalesce(stk_instant_inventory.available_aux_qty,0) - (coalesce(stk_instant_inventory.not_record_out_aux_qty,0) - detail.not_record_out_aux_qty) &quot;&quot;&quot; update_sql += f&quot;&quot;&quot; from &#123;middle&#125; detail where stk_instant_inventory.search_key=detail.search_key &quot;&quot;&quot; self._execute(update_sql, (doc_model, doc_id)) insert_sql = &quot;&quot;&quot; insert into stk_instant_inventory ( tenant_id, material_id, material_master_id, auxiliary, flex, stk_org_id, owner_type, uom_id, stk_uom_id, aux_uom_id, qty, stk_qty, aux_qty, available_qty, available_stk_qty, available_aux_qty, occupied_qty, occupied_stk_qty, occupied_aux_qty, not_record_in_qty, not_record_in_stk_qty, not_record_in_aux_qty, not_record_out_qty, not_record_out_stk_qty, not_record_out_aux_qty, est_available_qty, est_available_stk_qty, est_available_aux_qty, lot, produce_date, valid_date, warehouse_id, location_id, stk_state_id, bom_version_id, bom_version_master_id, material_number, material_specification, mto_num, search_key, delete_state, create_uid, create_date, write_uid, write_date ) select tenant_id, material_id, material_master_id, auxiliary, flex, stk_org_id, owner_type, uom_id, stk_uom_id, aux_uom_id, 0, 0, 0, 0, 0, 0, 0, 0, 0, not_record_in_qty, not_record_in_stk_qty, not_record_in_aux_qty, not_record_out_qty, not_record_out_stk_qty, not_record_out_aux_qty, &quot;&quot;&quot; if is_est_available_qty_includes_not_record_in_qty: insert_sql += &quot;&quot;&quot; not_record_in_qty-not_record_out_qty, not_record_in_stk_qty-not_record_out_stk_qty, not_record_in_aux_qty-not_record_out_aux_qty, &quot;&quot;&quot; else: insert_sql += &quot;&quot;&quot; -not_record_out_qty, -not_record_out_stk_qty, -not_record_out_aux_qty, &quot;&quot;&quot; insert_sql += f&quot;&quot;&quot; lot, produce_date, valid_date, warehouse_id, location_id, stk_state_id, bom_version_id, bom_version_master_id, material_number, material_specification, mto_num, search_key, &#x27;normal&#x27;, &#123;uid&#125;, localtimestamp(6), &#123;uid&#125;, localtimestamp(6) from &#123;middle&#125; detail where not exists(select * from stk_instant_inventory where stk_instant_inventory.search_key=detail.search_key) &quot;&quot;&quot; self._execute(insert_sql, (doc_model, doc_id)) middle = f&quot;&quot;&quot; (select max(tenant_id) as tenant_id, max(material_id) as material_id, max(material_master_id) as material_master_id, max(auxiliary) as auxiliary, &#123;flex_str&#125;, max(stk_org_id) as stk_org_id, max(owner_type) as owner_type, max(uom_id) as uom_id, max(material_stk_uom_id) as stk_uom_id, max(material_aux_uom_id) as aux_uom_id, sum(case when qty_option=&#x27;1&#x27; then 0 else 0 end) as not_record_in_qty, sum(case when qty_option=&#x27;1&#x27; then 0 else 0 end) as not_record_in_stk_qty, sum(case when qty_option=&#x27;1&#x27; then 0 else 0 end) as not_record_in_aux_qty, sum(case when qty_option=&#x27;-1&#x27; then 0 else 0 end) as not_record_out_qty, sum(case when qty_option=&#x27;-1&#x27; then 0 else 0 end) as not_record_out_stk_qty, sum(case when qty_option=&#x27;-1&#x27; then 0 else 0 end) as not_record_out_aux_qty, max(lot) as lot, max(produce_date) as produce_date, max(valid_date) as valid_date, max(warehouse_id) as warehouse_id, max(location_id) as location_id, max(stk_state_id) as stk_state_id, max(bom_version_id) as bom_version_id, max(bom_version_master_id) as bom_version_master_id, max(material_number) as material_number, max(material_specification) as material_specification, max(mto_num) as mto_num, search_key from stk_tran_detail where src_parent_model = %s and src_parent_id = %s group by search_key) &quot;&quot;&quot; update_sql = f&quot;&quot;&quot; update stk_instant_inventory set not_record_in_qty = coalesce(stk_instant_inventory.not_record_in_qty,0) + detail.not_record_in_qty, not_record_in_stk_qty = coalesce(stk_instant_inventory.not_record_in_stk_qty,0) + detail.not_record_in_stk_qty, not_record_in_aux_qty = coalesce(stk_instant_inventory.not_record_in_aux_qty,0) + detail.not_record_in_aux_qty, not_record_out_qty = coalesce(stk_instant_inventory.not_record_out_qty,0) + detail.not_record_out_qty, not_record_out_stk_qty = coalesce(stk_instant_inventory.not_record_out_stk_qty,0) + detail.not_record_out_stk_qty, not_record_out_aux_qty = coalesce(stk_instant_inventory.not_record_out_aux_qty,0) + detail.not_record_out_aux_qty, write_date = localtimestamp(6), write_uid = &#123;uid&#125;, &quot;&quot;&quot; if is_est_available_qty_includes_not_record_in_qty: update_sql += &quot;&quot;&quot; est_available_qty = coalesce(stk_instant_inventory.available_qty,0) - (coalesce(stk_instant_inventory.not_record_out_qty,0) + detail.not_record_out_qty) + (coalesce(stk_instant_inventory.not_record_in_qty,0) + detail.not_record_in_qty), est_available_stk_qty = coalesce(stk_instant_inventory.available_stk_qty,0) - (coalesce(stk_instant_inventory.not_record_out_stk_qty,0) + detail.not_record_out_stk_qty) + (coalesce(stk_instant_inventory.not_record_in_stk_qty,0) + detail.not_record_in_stk_qty), est_available_aux_qty = coalesce(stk_instant_inventory.available_aux_qty,0) - (coalesce(stk_instant_inventory.not_record_out_aux_qty,0) + detail.not_record_out_aux_qty) + (coalesce(stk_instant_inventory.not_record_in_aux_qty,0) + detail.not_record_in_aux_qty) &quot;&quot;&quot; else: update_sql += &quot;&quot;&quot; est_available_qty = coalesce(stk_instant_inventory.available_qty,0) - (coalesce(stk_instant_inventory.not_record_out_qty,0) + detail.not_record_out_qty), est_available_stk_qty = coalesce(stk_instant_inventory.available_stk_qty,0) - (coalesce(stk_instant_inventory.not_record_out_stk_qty,0) + detail.not_record_out_stk_qty), est_available_aux_qty = coalesce(stk_instant_inventory.available_aux_qty,0) - (coalesce(stk_instant_inventory.not_record_out_aux_qty,0) + detail.not_record_out_aux_qty) &quot;&quot;&quot; update_sql += f&quot;&quot;&quot; from &#123;middle&#125; detail where stk_instant_inventory.search_key=detail.search_key &quot;&quot;&quot; self._execute(update_sql, (doc_model, doc_id)) insert_sql = &quot;&quot;&quot; insert into stk_instant_inventory ( tenant_id, material_id, material_master_id, auxiliary, flex, stk_org_id, owner_type, uom_id, stk_uom_id, aux_uom_id, qty, stk_qty, aux_qty, available_qty, available_stk_qty, available_aux_qty, occupied_qty, occupied_stk_qty, occupied_aux_qty, not_record_in_qty, not_record_in_stk_qty, not_record_in_aux_qty, not_record_out_qty, not_record_out_stk_qty, not_record_out_aux_qty, est_available_qty, est_available_stk_qty, est_available_aux_qty, lot, produce_date, valid_date, warehouse_id, location_id, stk_state_id, bom_version_id, bom_version_master_id, material_number, material_specification, mto_num, search_key, delete_state, create_uid, create_date, write_uid, write_date ) select tenant_id, material_id, material_master_id, auxiliary, flex, stk_org_id, owner_type, uom_id, stk_uom_id, aux_uom_id, 0, 0, 0, 0, 0, 0, 0, 0, 0, not_record_in_qty, not_record_in_stk_qty, not_record_in_aux_qty, not_record_out_qty, not_record_out_stk_qty, not_record_out_aux_qty, &quot;&quot;&quot; if is_est_available_qty_includes_not_record_in_qty: insert_sql += &quot;&quot;&quot; not_record_in_qty-not_record_out_qty, not_record_in_stk_qty-not_record_out_stk_qty, not_record_in_aux_qty-not_record_out_aux_qty, &quot;&quot;&quot; else: insert_sql += &quot;&quot;&quot; -not_record_out_qty, -not_record_out_stk_qty, -not_record_out_aux_qty, &quot;&quot;&quot; insert_sql += f&quot;&quot;&quot; lot, produce_date, valid_date, warehouse_id, location_id, stk_state_id, bom_version_id, bom_version_master_id, material_number, material_specification, mto_num, search_key, &#x27;normal&#x27;, &#123;uid&#125;, localtimestamp(6), &#123;uid&#125;, localtimestamp(6) from &#123;middle&#125; detail where not exists(select * from stk_instant_inventory where stk_instant_inventory.search_key=detail.search_key) &quot;&quot;&quot; self._execute(insert_sql, (doc_model, doc_id)) _p_clear_bak12345678910111213141516@api.modeldef _p_clear_bak(self, doc_model: str, doc_id: int, is_piece=False): &quot;&quot;&quot;删除台账备份 Args: doc_model (str): 单据模型 doc_ids (int): 单据id is_piece (bool): 是否单件表 &quot;&quot;&quot; if is_piece and not self.p_get_is_piece_manage(self.env): return bak_table = [&#x27;stk_tran_detail_bak&#x27;, &#x27;stk_tran_detail_piece_bak&#x27;][is_piece] self._execute(&quot;&quot;&quot; delete from &#123;table&#125; where src_parent_model = %s and src_parent_id = %s &quot;&quot;&quot;.format(table=bak_table), (doc_model, doc_id))","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"医药公司ERP","slug":"项目/医药公司ERP","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/"},{"name":"业务","slug":"项目/医药公司ERP/业务","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/%E4%B8%9A%E5%8A%A1/"}],"tags":[]},{"title":"8月份","slug":"每月概要/2023/202308","date":"2023-08-28T10:08:28.000Z","updated":"2024-06-15T04:17:16.000Z","comments":true,"path":"2023/08/28/每月概要/2023/202308/","link":"","permalink":"https://dbbruce.github.io/2023/08/28/%E6%AF%8F%E6%9C%88%E6%A6%82%E8%A6%81/2023/202308/","excerpt":"1.快速打开指定的文件夹：打开访达-&gt;按住command+shift+G-&gt;输入&#x2F;usr&#x2F;local 就可以找到","text":"1.快速打开指定的文件夹：打开访达-&gt;按住command+shift+G-&gt;输入&#x2F;usr&#x2F;local 就可以找到 2.enumerate()enumerate() 是一个 Python 内置函数，用于将一个可遍历的数据对象(如列表、元组或字符串)组合为一个索引序列，同时列出数据和数据下标，一般用在 for 循环当中语法：enumerate(sequence, [start&#x3D;0]) 123456789101112131415161718192021222324s1 = &#x27;123456&#x27;for i,s in enumerate(s1): print(i,s)0 11 22 33 44 55 6l1=[1,2,3,4]for i,s in enumerate(l1): print(i,s)0 11 22 33 4for i,s in enumerate(l1, 1): print(i,s)1 12 23 34 4 使用list显示&lt;class ‘enumerate’&gt;内容 1234567891011121314e1 = enumerate(l1)type(e1)&lt;class &#x27;enumerate&#x27;&gt;print(e1) &lt;enumerate object at 0x10d931580&gt;# 使用list显示值print(list(e1))[(0, 1), (1, 2), (2, 3), (3, 4)]# 输出一次后对象清空，上面print一次了，再次print为空print(list(e1))[] 3.print 输出不换行若想使我们print后的输出不自动补充换行符，那么应该在结尾加上end&#x3D;“” 12345a = &quot;早晨&quot;b = &quot;下午&quot;print(a,end=&quot;&quot;)print(b)早晨下午 4.f”{}”的用法:快速嵌入变量该方法很快捷地放入我们想要的内容，很符合python语言的风格 12345a = &quot;早晨&quot;b = &quot;下午&quot;c = 2print(f&quot;从&#123;a&#125;起床到&#123;b&#125;,我一共只吃了&#123;c&#125;个苹果&quot;)从早晨起床到下午,我一共只吃了2个苹果 5.requests json content 与 text 区别json() 必须加括号text 代表返回的数据是文字content 代表返回的数据是多媒体，图片，音乐，视频 6.小细节，list insert函数，返回none的问题12345user_info = [&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;]ps = 12345result = user_info.insert(0, ps) # 错误的写法 正确的写法为： user_info.insert(0, ps) 不需要赋值就可以了print(result)None # 打印none，这个是由于列表调用insert方法后，没有返回值，result设置默认none 7.小技巧，sublime快速添加双引号 (.):(.)“$1”:”$2” 8.Python中普通方法、静态方法、类方法的区别1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591601611621631641651661671681691701711721731741751761771781791801811821831841851861871881891901911921931941951961971981992002012022032042052062072082.@staticmethod装饰器 @staticmethod 修饰的方法称为：静态方法，和普通的函数没有什么区别下面将聊聊实际项目中几种应用场景1、要调用一个静态方法，一般使用形式是：「 类名.方法名() 」class Web(object): @staticmethod def foo_staticmethod(): &quot;&quot;&quot;静态方法&quot;&quot;&quot; passif __name__ == &#x27;__main__&#x27;: # 直接使用类名+方法名调用 Web.foo_staticmethod()当然，也可以实例化一个类对象，通过这个对象去调用静态方法，但是不建议使用这种方式# 实例化一个对象instance = Web()# 使用实例对象去调用静态方法（不建议）instance.foo_staticmethod()2、针对类中定义的静态变量，可以使用「 类名.变量名 」 的形式去访问class Web(object): # 静态变量（类变量） name = &quot;Python_Web&quot; @staticmethod def foo_staticmethod(): &quot;&quot;&quot;静态方法&quot;&quot;&quot; # 引用静态变量 print(Web.name)3、静态方法内部使用其他静态方法、类方法，同样是使用「 类名.方法名() 」去调用class Web(object): # 静态变量（类变量） name = &quot;Python_Web&quot; # 类方法 @classmethod def foo_classmethod_other(cls): print(&#x27;类方法被调用！&#x27;) # 另外一个静态方法 @staticmethod def foo_staticmethod_other(): print(&#x27;另外一个静态方法被调用！&#x27;) @staticmethod def foo_staticmethod(): &quot;&quot;&quot;静态方法&quot;&quot;&quot; # 调用其他静态方法 print(Web.foo_staticmethod_other()) # 调用类方法 print(Web.foo_classmethod_other())4、静态方法内部调用普通方法，访问实例属性普通方法和实例属性都必须通过实例对象去引用，不能直接使用类名去访问class Web(object): def __init__(self): self.desc = &quot;实例属性，不共享&quot; def norm_method(self): &quot;&quot;&quot;普通方法&quot;&quot;&quot; print(&#x27;普通方法被调用！&#x27;) @staticmethod def foo_staticmethod(): &quot;&quot;&quot;静态方法&quot;&quot;&quot; instance = Web() # 获取实例属性 print(instance.desc) # 调用普通方法 instance.norm_method()5、子类的使用在子类中调用父类定义好的静态方法，只需要将类名替换为子类名称即可class Web(object): @staticmethod def foo_staticmethod(arg1, arg2): passclass Django(Web): &quot;&quot;&quot;子类&quot;&quot;&quot; passif __name__ == &#x27;__main__&#x27;: # 1、使用类名（父类）去调用静态方法 Web.foo_staticmethod(&quot;Hello&quot;, &quot;,AirPython&quot;) # 2、使用类名（子类）去调用静态方法 Django.foo_staticmethod(&quot;Hello&quot;, &quot;,AirPython&quot;)3.@classmethod装饰器 @classmethod 修饰的方法称为：类方法，在使用的时候，会将类本身作为第一个参数 cls 传递给类方法# 类方法，第一个参数为cls，代表类本身@classmethoddef foo_classmethod(cls): pass其中，cls 代表外层类本身，可以实例化，也可以直接调用静态方法、类方法、静态变量下面逐一进行说明1、要调用一个类方法，一般使用形式是：「 类名.方法名() 」class Web(object): # 类方法，第一个参数为cls，代表类本身 @classmethod def foo_classmethod(cls): passif __name__ == &#x27;__main__&#x27;: # 使用类名去调用类方法 Web.foo_classmethod()和静态方法类似，也可以实例化一个类对象，通过这个对象去调用静态方法，但是不建议使用这种方式2、调用静态变量静态方法内部引用静态变量有两种方式，分别是：「 类名.变量名 」「 cls.变量名 」注意：由于 cls 代表就是外层类本身，所以这两种方式等效class Web(object): # 静态变量（类变量） name = &quot;Python_Web&quot; # 类方法，第一个参数为cls，代表类本身 @classmethod def foo_classmethod(cls): # 调用静态变量方式一 print(cls.name) # 调用静态变量方式二 print(Web.name)3、类方法内部调用其他类方法、静态方法在一个类方法内部，可以使用「 类名.类方法名() 」、「 类名.静态方法名() 」的形式去调用方法class Web(object): # 静态方法 @staticmethod def foo_staticmethod(): print(&#x27;静态方法被调用！&#x27;) # 其他类方法 @classmethod def foo_classmethod_other(cls): print(&#x27;另外一个类方法被调用！&#x27;) # 类方法，第一个参数为cls，代表类本身 @classmethod def foo_classmethod(cls): # 调用其他类方法 cls.foo_classmethod_other() # 调用静态方法 cls.foo_staticmethod()if __name__ == &#x27;__main__&#x27;: Web.foo_classmethod()4、类方法内部调用普通方法，访问实例属性需要通过 cls 变量实例化一个类对象，然后通过这个对象去调用普通方法和实例属性class Web(object): def __init__(self): self.desc = &quot;实例属性，不共享&quot; def norm_method(self): &quot;&quot;&quot;普通方法&quot;&quot;&quot; print(&#x27;普通方法被调用！&#x27;) # 类方法，第一个参数为cls，代表类本身 @classmethod def foo_classmethod(cls): # 如果要调用实例属性，必须使用cls实例化一个对象，然后再去引用 print(cls().desc) # 如果要调用普通方法，必须使用cls实例化一个对象，然后再去引用 cls().norm_method()5、子类的使用在子类中调用父类定义好的类方法，只需要将类名替换为子类名称即可，代码和静态方法类似4.区别下面总结一下普通方法、静态方法、类方法的区别普通方法：第一个参数 self 代表实例对象本身，可以使用 self 直接引用定义的实例属性和普通方法；如果需要调用静态方法和类方法，通过「 类名.方法名() 」调用即可静态方法：使用「 类名.静态变量 」引用静态变量，利用「 类名.方法名() 」调用其他静态方法和类方法；如果需要调用普通方法，需要先实例化一个对象，然后利用对象去调用普通方法类方法：第一个参数 cls 代表类本身（等价），通过「 cls.静态变量 」或「 类名.静态变量 」引用静态变量，利用「 cls.方法名() 」或「 类名.方法名() 」去调用静态方法和类方法；如果需要调用普通方法，需要先实例化一个对象，然后利用对象去调用普通方法静态方法和类方法是针对类定义的，除了可以使用类名去调用，也可以使用实例对象去调用，但是不建议5.最后一般来说，如果方法内部涉及到实例对象属性的操作，建议用普通方法；如果方法内部没有操作实例属性的操作，仅仅包含一些工具性的操作，建议使用静态方法；而如果需要对类属性，即静态变量进行限制性操作，则建议使用类方法 9.三方包的位置 10.pycharm设置目录为根目录","categories":[{"name":"每月概要","slug":"每月概要","permalink":"https://dbbruce.github.io/categories/%E6%AF%8F%E6%9C%88%E6%A6%82%E8%A6%81/"},{"name":"2023","slug":"每月概要/2023","permalink":"https://dbbruce.github.io/categories/%E6%AF%8F%E6%9C%88%E6%A6%82%E8%A6%81/2023/"}],"tags":[]},{"title":"采购流程-库存变化","slug":"项目/医药公司ERP/20230827-采购流程-库存变化","date":"2023-08-27T14:14:52.000Z","updated":"2024-11-29T02:15:38.630Z","comments":true,"path":"2023/08/27/项目/医药公司ERP/20230827-采购流程-库存变化/","link":"","permalink":"https://dbbruce.github.io/2023/08/27/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/20230827-%E9%87%87%E8%B4%AD%E6%B5%81%E7%A8%8B-%E5%BA%93%E5%AD%98%E5%8F%98%E5%8C%96/","excerpt":"采购流程","text":"采购流程 库存功能库存表 即时库存表(stk.instant.inventory) 医药即时库存表(med.stk.instant.inventory) 涉及字段1234567891011121314# 未记账入库数量not_record_in_qty not_record_in_stk_qtynot_record_in_aux_qty# 未记账出库数量not_record_out_qtynot_record_out_stk_qtynot_record_out_aux_qty# 预计可出库数量,一直等于(可用库存数量-未记账出库数量)est_available_qtyest_available_stk_qtyest_available_aux_qty 库存单位 库存单位 - stk_uom_id_name 库存数量 - stk_qty 库存单位可用量 - available_stk_qty 未登记入库数量 - not_record_in_stk_qty 未登记出库数量 - not_record_out_stk_qty 预计可用数量 - est_available_stk_qty 库存占用数量 - occupied_stk_qty 辅助单位 辅助单位 - aux_uom_id_name 辅助数量 - aux_qty 辅助单位可用量 - available_aux_qty 未登记入库数量 - not_record_in_aux_qty 未登记出库数量 - not_record_out_aux_qty 预计可用数量 - est_available_aux_qty 辅助占用数量 - occupied_aux_qty 采购入库单 - 增加库存 审核后,增加库存 调用系统插件，插件的方法名可以在json文件中查看 &#x2F;opt&#x2F;projects&#x2F;insuite&#x2F;biz&#x2F;med&#x2F;gsp&#x2F;med_gsp_pur_receipt&#x2F;json&#x2F;model__med_gsp_pur_receipt.json123&quot;service_type&quot;: &quot;plugin&quot;,&quot;svc_method&quot;: &quot;scm,do_inventory_record_audit&quot;,&quot;svc_name&quot;: &quot;登记库存账&quot; 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105&quot;svc_std_pre_audit_after&quot;: &#123; &quot;business&quot;: [ &#123; &quot;api_type&quot;: &quot;odooService&quot;, &quot;args_config&quot;: [], &quot;button_func_name&quot;: &quot;svc_std_pre_audit&quot;, &quot;custom_func&quot;: &quot;tentative_assessment_rule&quot;, &quot;custom_name&quot;: &quot;Tentative Assessment Rule&quot;, &quot;effect_condition&quot;: [ [ &quot;is_auto_generate&quot;, &quot;=&quot;, false, &quot;0&quot; ] ], &quot;is_forbidden&quot;: false, &quot;key&quot;: &quot;1NWobY66z5vfu5x61Gr4250BpRWPwSy2&quot;, &quot;preset_svc_id&quot;: 0, &quot;sequence&quot;: 0, &quot;service_type&quot;: &quot;custom&quot;, &quot;svc_method&quot;: &quot;&quot;, &quot;svc_name&quot;: &quot;&quot; &#125;, &#123; &quot;api_type&quot;: &quot;odooService&quot;, &quot;args_config&quot;: [], &quot;button_func_name&quot;: &quot;svc_std_pre_audit&quot;, &quot;custom_func&quot;: &quot;&quot;, &quot;custom_name&quot;: &quot;&quot;, &quot;effect_condition&quot;: [ &quot;&amp;&quot;, [ &quot;is_initial&quot;, &quot;=&quot;, false, &quot;0&quot; ], [ &quot;is_auto_generate&quot;, &quot;=&quot;, false, &quot;0&quot; ] ], &quot;is_forbidden&quot;: false, &quot;key&quot;: &quot;AI20Erf2qR0k5gU1qDg1ZYo8gewHZcqY&quot;, &quot;preset_svc_id&quot;: 0, &quot;sequence&quot;: 1, &quot;service_type&quot;: &quot;plugin&quot;, &quot;svc_method&quot;: &quot;scm,do_add_audit&quot;, &quot;svc_name&quot;: &quot;登记台账&quot; &#125;, &#125;, &#123; &quot;api_type&quot;: &quot;odooService&quot;, &quot;args_config&quot;: [], &quot;button_func_name&quot;: &quot;svc_std_pre_audit&quot;, &quot;custom_func&quot;: &quot;&quot;, &quot;custom_name&quot;: &quot;&quot;, &quot;effect_condition&quot;: [ &quot;&amp;&quot;, [ &quot;is_initial&quot;, &quot;=&quot;, false, &quot;0&quot; ], [ &quot;is_auto_generate&quot;, &quot;=&quot;, false, &quot;0&quot; ] ], &quot;is_forbidden&quot;: false, &quot;key&quot;: &quot;ixeHOV2fkS940nOiDq0Y2H0BsTRQIR7b&quot;, &quot;preset_svc_id&quot;: 0, &quot;sequence&quot;: 2, &quot;service_type&quot;: &quot;plugin&quot;, &quot;svc_method&quot;: &quot;scm,do_inventory_record_audit&quot;, &quot;svc_name&quot;: &quot;登记库存账&quot; &#125;, &#123; &quot;api_type&quot;: &quot;odooService&quot;, &quot;args_config&quot;: [], &quot;button_func_name&quot;: &quot;svc_std_pre_audit&quot;, &quot;custom_func&quot;: &quot;refresh_batch_no&quot;, &quot;custom_name&quot;: &quot;Refresh Batch No&quot;, &quot;effect_condition&quot;: [], &quot;is_forbidden&quot;: false, &quot;key&quot;: &quot;7kdmoP&quot;, &quot;preset_svc_id&quot;: 0, &quot;service_type&quot;: &quot;custom&quot;, &quot;svc_method&quot;: &quot;&quot;, &quot;svc_name&quot;: &quot;&quot; &#125; ], &quot;validation&quot;: []&#125;,&quot;svc_std_pre_audit_before&quot;: &#123; &quot;business&quot;: [], &quot;noPreset&quot;: false, &quot;validation&quot;: []&#125;, 登记库存账插件方法 &#x2F;opt&#x2F;projects&#x2F;insuite&#x2F;biz&#x2F;platform&#x2F;ps_studio_plugin&#x2F;service&#x2F;service_plugin.py1234567891011121314151617def do_inventory_record_audit(self, env, model_key, operation, origin_args, timing, single_record, arg_dict): &quot;&quot;&quot;登记库存账 前提条件需要设置为：非期初单据 and 状态不是暂存 Args: env ([type]): [description] model_key ([type]): [description] operation ([type]): [description] origin_args ([type]): [description] timing ([type]): [description] single_record ([type]): [description] arg_dict ([type]): [description] &quot;&quot;&quot; # 获取一些库存需要的参数 # &#123;&#x27;direction&#x27;: &#x27;in&#x27;, &#x27;record_rule&#x27;: &#x27;audit&#x27;, &#x27;is_check_negative_stock_on_save_when_record_rule_audit&#x27;: &#x27;True&#x27;, &#x27;is_est_available_qty_includes_not_record_in_qty&#x27;: &#x27;False&#x27;&#125; stk_parms = env[&#x27;stk.tran.config&#x27;].p_get_record_rule(model_key, single_record.id) # 开始入库 env[&#x27;stk.tran.config&#x27;].p_instant_inventory_record(model_key, single_record.id, operation=&#x27;audit&#x27;, **stk_parms) p_get_record_rule方法，p_instant_inventory_record方法请参考，库存方法: https://dbbruce.github.io/2023/08/26/项目/佳业/20230826-库存方法/","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"医药公司ERP","slug":"项目/医药公司ERP","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/"},{"name":"业务","slug":"项目/医药公司ERP/业务","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/%E4%B8%9A%E5%8A%A1/"}],"tags":[]},{"title":"库存配置表","slug":"项目/医药公司ERP/20230826-库存配置表","date":"2023-08-26T14:34:52.000Z","updated":"2024-11-29T02:15:38.644Z","comments":true,"path":"2023/08/26/项目/医药公司ERP/20230826-库存配置表/","link":"","permalink":"https://dbbruce.github.io/2023/08/26/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/20230826-%E5%BA%93%E5%AD%98%E9%85%8D%E7%BD%AE%E8%A1%A8/","excerpt":"模型名 stk.tran.config 文件原文件 &#x2F;opt&#x2F;projects&#x2F;insuite&#x2F;biz&#x2F;scm&#x2F;ps_stk&#x2F;stk_tran_detail&#x2F;development&#x2F;models&#x2F;stk_tran_config.py继承文件 &#x2F;opt&#x2F;projects&#x2F;insuite&#x2F;biz&#x2F;med&#x2F;gsp&#x2F;mdm&#x2F;models&#x2F;stk_tran_config.py","text":"模型名 stk.tran.config 文件原文件 &#x2F;opt&#x2F;projects&#x2F;insuite&#x2F;biz&#x2F;scm&#x2F;ps_stk&#x2F;stk_tran_detail&#x2F;development&#x2F;models&#x2F;stk_tran_config.py继承文件 &#x2F;opt&#x2F;projects&#x2F;insuite&#x2F;biz&#x2F;med&#x2F;gsp&#x2F;mdm&#x2F;models&#x2F;stk_tran_config.py 字段列表12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273# 物料material_id = fields.Char(string=&#x27;Material ID&#x27;,required=True, default=&#x27;line.material_id&#x27;)# 名称name = fields.Char(string=&#x27;Name&#x27;, required=True)# 模型model = fields.Char(string=&#x27;Model&#x27;, required=True)# 上级模型parent_model = fields.Char(string=&#x27;Parent Model&#x27;, required=True)# 表头字段名parent_o2m_field_name = fields.Char(string=&#x27;Parent O2M Field Name&#x27;, required=True, default=&#x27;line_ids1&#x27;)# 明细模型child_model = fields.Char(string=&#x27;Child Model&#x27;, required=True)# 方向 出库 入库direction = fields.Char(string=&#x27;Direction&#x27;, required=True)# 条件condition = fields.Char(default=&#x27;&#x27;, string=&#x27;Condition&#x27;)sql = fields.Text(default=&#x27;&#x27;, string=&#x27;Sql&#x27;)# 批量执行的SQLsql_batch = fields.Text(default=&#x27;&#x27;, string=&#x27;Sql Batch&#x27;)# 租户tenant_id = fields.Integer(string=&#x27;Tenant&#x27;, default=lambda self: self.env.user.tenant_id)# 弹性域flex = fields.Char(default=&#x27;line.flex&#x27;, string=&#x27;Flex&#x27;)# 辅助属性auxiliary = fields.Text(default=&#x27;line.auxiliary&#x27;, string=&#x27;Auxiliary Properties&#x27;)# 发料组织stk_org_id = fields.Char(default=&#x27;line.stk_org_id&#x27;,string=&#x27;Stock Organization&#x27;, required=True)# 货主owner_type = fields.Char(default=&#x27;line.owner_type&#x27;, string=&#x27;Owner Type&#x27;)# 内部交易逻辑补充，存货货主取结算组织/生产组织/成本货主等# 存货货主ia_owner_type = fields.Char(default=&#x27;line.owner_type&#x27;, string=&#x27;Ia Owner Type&#x27;)# 基本单位uom_id = fields.Char(default=&#x27;line.uom_id&#x27;, string=&#x27;Uom ID&#x27;)# 库存单位stk_uom_id = fields.Char(default=&#x27;line.stk_uom_id&#x27;, string=&#x27;Stock Uom ID&#x27;)# 辅助单位aux_uom_id = fields.Char(default=&#x27;line.aux_uom_id&#x27;,string=&#x27;Auxiliary Uom ID&#x27;)# 基本数量qty = fields.Char(default=&#x27;line.qty&#x27;, string=&#x27;Qty&#x27;)# 库存数量stk_qty = fields.Char(default=&#x27;line.stk_qty&#x27;, string=&#x27;Stock Qty&#x27;)# 辅助数量aux_qty = fields.Char(default=&#x27;line.aux_qty&#x27;, string=&#x27;Auxiliary Qty&#x27;)# 批号lot = fields.Char(default=&#x27;line.lot&#x27;, string=&#x27;Lot&#x27;)# 生产日期produce_date = fields.Char(default=&#x27;line.produce_date&#x27;, string=&#x27;Produce Date&#x27;)# 有效期至valid_date = fields.Char(default=&#x27;line.valid_date&#x27;, string=&#x27;Valid Date&#x27;)# BOM版本bom_version_id = fields.Char(default=&#x27;line.bom_version_id&#x27;, string=&#x27;Bom Version ID&#x27;)# 计划跟踪号mto_num = fields.Char(default=&#x27;line.mto_num&#x27;, string=&#x27;Mto Num&#x27;)# 仓库warehouse_id = fields.Char(default=&#x27;line.warehouse_id&#x27;, string=&#x27;Warehouse ID&#x27;)# 仓位location_id = fields.Char(default=&#x27;line.location_id&#x27;, string=&#x27;Location ID&#x27;)# 库存状态stk_state_id = fields.Char(default=&#x27;line.stk_state_id&#x27;, string=&#x27;Stock State ID&#x27;)note = fields.Text(default=&#x27;line.note&#x27;, string=&#x27;Note&#x27;)# 供应商supplier_id = fields.Char(default=&#x27;&#x27;, string=&#x27;Supplier ID&#x27;)# 客户customer_id = fields.Char(default=&#x27;&#x27;, string=&#x27;customer ID&#x27;)# 部门department_id = fields.Char(default=&#x27;&#x27;, string=&#x27;Department ID&#x27;)# 业务组织biz_org_id = fields.Char(default=&#x27;&#x27;, string=&#x27;Biz Organization ID&#x27;)# 工单编号(成本计算用)work_order_number = fields.Char(default=&#x27;&#x27;, string=&#x27;Work Order Number&#x27;)# 工单行号(成本计算用)work_order_sequence = fields.Char(default=&#x27;&#x27;, string=&#x27;Work Order Sequence&#x27;) 翻译文件 &#x2F;opt&#x2F;projects&#x2F;insuite&#x2F;biz&#x2F;scm&#x2F;ps_stk&#x2F;i18n&#x2F;zh_CN.csv stk_tran_config表 字段名 值 id 40 material_id line.material_id name 门店收货单 model med.store.receipt.line1 parent_model med.store.receipt parent_o2m_field_name line_ids1 child_model ‘’ direction 1 condition sql –sql insert into stk_tran_detail(material_id,flex,auxiliary,stk_org_id,owner_type,ia_owner_type,uom_id,stk_uom_id,aux_uom_id,qty,stk_qty,aux_qty,lot,produce_date,valid_date,bom_version_id,mto_num,warehouse_id,location_id,stk_state_id,note,work_order_sequence,src_id,state,material_master_id,bom_version_master_id,number,document_type_id,biz_date,src_parent_model,src_child_model,src_model,sequence,src_parent_id,tenant_id,biz_type_id,is_stock_update_flag,close_state,qty_option,delete_state,create_uid,write_uid,create_date,write_date,origin_order_lineid,source_line1_model,source_line1_id,source_id,source_model,source_number,material_stk_uom_id,material_aux_uom_id,is_material_floating,doc_create_date,barcode,barcode_type_id,project_id,project_number,is_material_manage_piece,is_done,reservation_type,material_number,material_specification,search_key) select line.material_id,line.flex,line.auxiliary,line.stk_org_id,line.owner_type,line.owner_type,line.uom_id,line.stk_uom_id,line.aux_uom_id,line.qty,line.stk_qty,line.aux_qty,line.lot,line.produce_date,line.valid_date,line.bom_version_id,line.mto_num,line.warehouse_id,line.location_id,line.stk_state_id,line.note,0,line.id,parent.state,m.master_id,bom.master_id,parent.number,parent.document_type_id,parent.biz_date,’med.store.receipt’,’’’’,’med.store.receipt.line1’,line.sequence,parent.id,line.tenant_id,parent.biz_type_id,false,’normal’,’1’,’normal’,’1’,’1’,parent.create_date,localtimestamp(6),line.origin_order_lineid,line.source_line1_model,line.source_line1_id,line.source_id,line.source_model,line.source_number,m.stk_uom_id,m.aux_uom_id,m.is_floating,parent.create_date,line.barcode,line.barcode_type_id,line.project_id,line.project_number,m.is_piece_manage,false,line.reservation_type,m.number,m.specification,concat_ws(‘_’, m.master_id,case when line.auxiliary is null or line.auxiliary&#x3D;’’ then ‘False’ else cast(line.auxiliary as text) end, case when line.location_id is null then ‘False’ else cast(line.location_id as text) end, cast(line.warehouse_id as text), regexp_replace(line.owner_type ,’(.*),(\\d)’,’\\1(\\2,)’), cast(line.stk_state_id as text) case when line.lot is null or line.lot&#x3D;’’ then ‘False’ else cast(line.lot as text) end case when line.produce_date is null or cast(line.produce_date as text) &#x3D;’’ then ‘False’ else cast(line.produce_date as text) end, case when line.valid_date is null or cast(line.valid_date as text)&#x3D;’’ then ‘False’ else cast(line.valid_date as text) end, case when bom.master_id is null then ‘False’ else cast(bom.master_id as text) end, case when line.mto_num is null or line.mto_num&#x3D;’’ then ‘False’ else cast(line.mto_num as text) end, cast(line.uom_id as text), case when m.is_floating&#x3D;true then cast(line.stk_uom_id as text) else ‘False’ end, case when m.is_floating&#x3D;true and line.aux_uom_id is not null then cast(line.aux_uom_id as text) else ‘False’ end, cast(line.stk_org_id as text) ) from med_store_receipt_line1 line left join med_store_receipt parent on line.parent_id &#x3D; parent.id left join mdm_material m on line.material_id &#x3D; m.id left join mdm_product_bom bom on line.bom_version_id &#x3D; bom.id where line.parent_id &#x3D; %s and parent.state not in (‘creating’,’temporary’) and (parent.is_auto_generate&#x3D;false or parent.is_auto_generate is null) and parent.delete_state&#x3D;’normal’; sql_batch –sql insert into stk_tran_detail(material_id,flex,auxiliary,stk_org_id,owner_type,ia_owner_type,uom_id,stk_uom_id,aux_uom_id,qty,stk_qty,aux_qty,lot,produce_date,valid_date,bom_version_id,mto_num,warehouse_id,location_id,stk_state_id,note,work_order_sequence,src_id,state,material_master_id,bom_version_master_id,number,document_type_id,biz_date,src_parent_model,src_child_model,src_model,sequence,src_parent_id,tenant_id,biz_type_id,is_stock_update_flag,close_state,qty_option,delete_state,create_uid,write_uid,create_date,write_date,origin_order_lineid,source_line1_model,source_line1_id,source_id,source_model,source_number,material_stk_uom_id,material_aux_uom_id,is_material_floating,doc_create_date,barcode,barcode_type_id,project_id,project_number,is_material_manage_piece,is_done,reservation_type,material_number,material_specification,search_key,record_rule) select line.material_id,line.flex,line.auxiliary,line.stk_org_id,line.owner_type,line.owner_type,line.uom_id,line.stk_uom_id,line.aux_uom_id,line.qty,line.stk_qty,line.aux_qty,line.lot,line.produce_date,line.valid_date,line.bom_version_id,line.mto_num,line.warehouse_id,line.location_id,line.stk_state_id,line.note,0,line.id,parent.state,m.master_id,bom.master_id,parent.number,parent.document_type_id,parent.biz_date,’med.store.receipt’,’’’’,’med.store.receipt.line1’,line.sequence,parent.id,line.tenant_id,parent.biz_type_id,false,’normal’,’1’,’normal’,’1’,’1’,parent.create_date,localtimestamp(6),line.origin_order_lineid,line.source_line1_model,line.source_line1_id,line.source_id,line.source_model,line.source_number,m.stk_uom_id,m.aux_uom_id,m.is_floating,parent.create_date,line.barcode,line.barcode_type_id,line.project_id,line.project_number,m.is_piece_manage, case when iis_rule.record_rule&#x3D;’save’ and parent.state in (‘save’,’submit’,’audit’) then true when iis_rule.record_rule&#x3D;’save’ and parent.state not in (‘save’,’submit’,’audit’) then false when iis_rule.record_rule&#x3D;’audit’ and parent.state &#x3D;’audit’ then true when iis_rule.record_rule&#x3D;’audit’ and parent.state !&#x3D;’audit’ then false end,line.reservation_type,m.number,m.specification,concat_ws(‘_’,m.master_id, case when line.auxiliary is null or line.auxiliary&#x3D;’’ then ‘False’ else cast(line.auxiliary as text) end, case when line.location_id is null then ‘False’ else cast(line.location_id as text) end, cast(line.warehouse_id as text), regexp_replace(line.owner_type ,’(.*),(\\d)’,’\\1(\\2,)’), cast(line.stk_state_id as text), case when line.lot is null or line.lot&#x3D;’’ then ‘False’ else cast(line.lot as text) end, case when line.produce_date is null or cast(line.produce_date as text) &#x3D;’’ then ‘False’ else cast(line.produce_date as text) end, case when line.valid_date is null or cast(line.valid_date as text)&#x3D;’’ then ‘False’ else cast(line.valid_date as text) end, case when bom.master_id is null then ‘False’ else cast(bom.master_id as text) end, case when line.mto_num is null or line.mto_num&#x3D;’’ then ‘False’ else cast(line.mto_num as text) end, cast(line.uom_id as text), case when m.is_floating&#x3D;true then cast(line.stk_uom_id as text) else ‘False’ end, case when m.is_floating&#x3D;true and line.aux_uom_id is not null then cast(line.aux_uom_id as text) else ‘False’ end, cast(line.stk_org_id as text)),iis_rule.record_rule from med_store_receipt_line1 line left join med_store_receipt parent on line.parent_id &#x3D; parent.id left join mdm_material m on line.material_id &#x3D; m.id left join mdm_product_bom bom on line.bom_version_id &#x3D; bom.id left join (select a.id as org_id,a.key as qty_option,coalesce(value,’save’) as record_rule from (select id,’1’ as key from sys_admin_orgs where state&#x3D;’audit’ union select id,’-1’ as key from sys_admin_orgs where state&#x3D;’audit’) a left join sys_business_params b on a.id &#x3D; b.org_id and a.key&#x3D;(case when b.key&#x3D;’record_rule_in’ then ‘1’ when b.key&#x3D;’record_rule_out’ then ‘-1’ else b.key end)) iis_rule on line.stk_org_id&#x3D;iis_rule.org_id and ‘1’ &#x3D; iis_rule.qty_option where line.stk_org_id &#x3D; %s and parent.biz_date &gt;&#x3D; %s and parent.biz_date &lt;&#x3D; %s and parent.state not in (‘creating’,’temporary’) and (parent.is_auto_generate&#x3D;false or parent.is_auto_generate is null) and parent.delete_state&#x3D;’normal’ ; tenant_id 1 flex line.flex auxiliary line.auxiliary stk_org_id line.stk_org_id owner_type line.owner_type ia_owner_type line.owner_type uom_id line.uom_id stk_uom_id line.stk_uom_id aux_uom_id line.aux_uom_id qty line.qty stk_qty line.stk_qty aux_qty line.aux_qty lot line.lot produce_date line.produce_date valid_date line.valid_date bom_version_id line.bom_version_id mto_num line.mto_num warehouse_id line.warehouse_id location_id line.location_id stk_state_id line.stk_state_id note line.note supplier_id customer_id department_id biz_org_id work_order_number work_order_sequence 0 create_uid 1 create_date 2024-07-01 03:40:00 write_uid 1 write_date 2024-11-07 07:25:03","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"医药公司ERP","slug":"项目/医药公司ERP","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/"},{"name":"业务","slug":"项目/医药公司ERP/业务","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/%E4%B8%9A%E5%8A%A1/"}],"tags":[]},{"title":"如何重载预制数据","slug":"项目/医药公司ERP/20230826-如何重载预制数据","date":"2023-08-26T14:14:52.000Z","updated":"2024-11-29T02:15:38.621Z","comments":true,"path":"2023/08/26/项目/医药公司ERP/20230826-如何重载预制数据/","link":"","permalink":"https://dbbruce.github.io/2023/08/26/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/20230826-%E5%A6%82%E4%BD%95%E9%87%8D%E8%BD%BD%E9%A2%84%E5%88%B6%E6%95%B0%E6%8D%AE/","excerpt":"涉及的知识点 1、模型表: ir_model select * from ir_model where model &#x3D;’med.pur.request.line1’; 2、模型字段表: ir_model_fields select * from ir_model_fields where model &#x3D;’med.pur.request.line1’ and name&#x3D;’request_org_id’ ; 3、预制数据表: ir_model_data；注意name字段，对应xml文件中的id内容 select * from ir_model_data where name &#x3D; ‘med_pur_request_line1_request_org’;","text":"涉及的知识点 1、模型表: ir_model select * from ir_model where model &#x3D;’med.pur.request.line1’; 2、模型字段表: ir_model_fields select * from ir_model_fields where model &#x3D;’med.pur.request.line1’ and name&#x3D;’request_org_id’ ; 3、预制数据表: ir_model_data；注意name字段，对应xml文件中的id内容 select * from ir_model_data where name &#x3D; ‘med_pur_request_line1_request_org’; 预制数据文件 会在orgs_config表中写入5条数据 model - 数据表名 name - 表字段名 …&#x2F;data&#x2F;xxx_data.xml 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;odoo&gt; &lt;data noupdate=&quot;0&quot;&gt; &lt;!-- 请购组织 --&gt; &lt;record id=&quot;med_pur_request_line1_request_org&quot; model=&quot;orgs.config&quot;&gt; &lt;field name=&quot;field_id&quot; search=&quot;[(&#x27;model&#x27;, &#x27;=&#x27;, &#x27;med.pur.request.line1&#x27;), (&#x27;name&#x27;, &#x27;=&#x27;, &#x27;request_org_id&#x27;)]&quot;/&gt; &lt;field name=&quot;is_main_org&quot; eval=&quot;True&quot;/&gt; &lt;field name=&quot;business_domain&quot; eval=&quot;ref(&#x27;ps_admin.1000_demand_field&#x27;)&quot;/&gt; &lt;/record&gt; &lt;!-- 需求组织 --&gt; &lt;record id=&quot;med_pur_request_line1_demand_org&quot; model=&quot;orgs.config&quot;&gt; &lt;field name=&quot;field_id&quot; search=&quot;[(&#x27;model&#x27;, &#x27;=&#x27;, &#x27;med.pur.request.line1&#x27;), (&#x27;name&#x27;, &#x27;=&#x27;, &#x27;demand_org_id&#x27;)]&quot;/&gt; &lt;field name=&quot;is_main_org&quot; eval=&quot;False&quot;/&gt; &lt;field name=&quot;business_domain&quot; eval=&quot;ref(&#x27;ps_admin.1000_demand_field&#x27;)&quot;/&gt; &lt;/record&gt; &lt;!-- 采购组织 --&gt; &lt;record id=&quot;med_pur_request_line1_pur_org&quot; model=&quot;orgs.config&quot;&gt; &lt;field name=&quot;field_id&quot; search=&quot;[(&#x27;model&#x27;, &#x27;=&#x27;, &#x27;med.pur.request.line1&#x27;), (&#x27;name&#x27;, &#x27;=&#x27;, &#x27;pur_org_id&#x27;)]&quot;&gt;&lt;/field&gt; &lt;field name=&quot;is_main_org&quot; eval=&quot;False&quot;/&gt; &lt;field name=&quot;business_domain&quot; eval=&quot;ref(&#x27;ps_admin.1002_purchase_field&#x27;)&quot;/&gt; &lt;field name=&quot;direction&quot;&gt;consignee&lt;/field&gt; &lt;field name=&quot;consign_rela_id&quot; eval=&quot;ref(&#x27;ps_admin.ps_admin_category_data_004&#x27;)&quot;&gt;&lt;/field&gt; &lt;field name=&quot;opposite_org_id&quot; search=&quot;[(&#x27;model&#x27;, &#x27;=&#x27;, &#x27;med.pur.request.line1&#x27;), (&#x27;name&#x27;, &#x27;=&#x27;, &#x27;demand_org_id&#x27;)]&quot;&gt;&lt;/field&gt; &lt;/record&gt; &lt;!-- 结算组织 --&gt; &lt;record id=&quot;med_pur_request_line1_settle_org&quot; model=&quot;orgs.config&quot;&gt; &lt;field name=&quot;field_id&quot; search=&quot;[(&#x27;model&#x27;, &#x27;=&#x27;, &#x27;med.pur.request.line1&#x27;), (&#x27;name&#x27;, &#x27;=&#x27;, &#x27;settle_org_id&#x27;)]&quot;/&gt; &lt;field name=&quot;is_main_org&quot; eval=&quot;False&quot;/&gt; &lt;field name=&quot;business_domain&quot; eval=&quot;ref(&#x27;ps_admin.1006_settlement_field&#x27;)&quot;/&gt; &lt;field name=&quot;direction&quot;&gt;consignee&lt;/field&gt; &lt;field name=&quot;consign_rela_id&quot; eval=&quot;ref(&#x27;ps_admin.ps_admin_category_data_005&#x27;)&quot;&gt;&lt;/field&gt; &lt;field name=&quot;opposite_org_id&quot; search=&quot;[(&#x27;model&#x27;, &#x27;=&#x27;, &#x27;med.pur.request.line1&#x27;), (&#x27;name&#x27;, &#x27;=&#x27;, &#x27;pur_org_id&#x27;)]&quot;&gt;&lt;/field&gt; &lt;/record&gt; &lt;!-- 收料组织 --&gt; &lt;record id=&quot;med_pur_request_line1_receive_org&quot; model=&quot;orgs.config&quot;&gt; &lt;field name=&quot;field_id&quot; search=&quot;[(&#x27;model&#x27;, &#x27;=&#x27;, &#x27;med.pur.request.line1&#x27;), (&#x27;name&#x27;, &#x27;=&#x27;, &#x27;receive_org_id&#x27;)]&quot;&gt;&lt;/field&gt; &lt;field name=&quot;is_main_org&quot; eval=&quot;False&quot;/&gt; &lt;field name=&quot;business_domain&quot; eval=&quot;ref(&#x27;ps_admin.1003_stock_field&#x27;)&quot;/&gt; &lt;field name=&quot;direction&quot;&gt;consignee&lt;/field&gt; &lt;field name=&quot;consign_rela_id&quot; eval=&quot;ref(&#x27;ps_admin.ps_admin_category_data_008&#x27;)&quot;&gt;&lt;/field&gt; &lt;field name=&quot;opposite_org_id&quot; search=&quot;[(&#x27;model&#x27;, &#x27;=&#x27;, &#x27;med.pur.request.line1&#x27;), (&#x27;name&#x27;, &#x27;=&#x27;, &#x27;demand_org_id&#x27;)]&quot;&gt;&lt;/field&gt; &lt;/record&gt; &lt;!-- 触发ir.model中write方法 --&gt; &lt;function model=&quot;ir.model&quot; name=&quot;write&quot;&gt; &lt;value model=&quot;ir.model&quot; search=&quot;[(&#x27;model&#x27;, &#x27;=&#x27;, &#x27;med.pur.request.line1&#x27;)]&quot;/&gt; &lt;value eval=&quot;&#123;&#x27;orgs_config_ids&#x27;: [(4, ref(&#x27;med_pur_request_line1_request_org&#x27;)),(4, ref(&#x27;med_pur_request_line1_demand_org&#x27;)),(4, ref(&#x27;med_pur_request_line1_pur_org&#x27;)),(4, ref(&#x27;med_pur_request_line1_settle_org&#x27;)),(4, ref(&#x27;med_pur_request_line1_receive_org&#x27;))]&#125;&quot;/&gt; &lt;/function&gt; &lt;/data&gt;&lt;/odoo&gt; 重载预制数据步骤 1、noupdate&#x3D;0，如果为1，xml中的record的更新并不会更新到数据库中123&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;odoo&gt; &lt;data noupdate=&quot;0&quot;&gt; 2、删除 ir_model_data 表中涉及的数据 DELETE from ir_model_data where name &#x3D; ‘med_pur_request_line1_request_org’; 3、删除涉及数据的表 select * from ir_model where model&#x3D; ‘med.pur.request.line1’; select id from orgs_config where model_id&#x3D;’3583’; delete from orgs_config where id in (1068,1067,1066,1065); 4、升级模块","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"医药公司ERP","slug":"项目/医药公司ERP","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/"},{"name":"业务","slug":"项目/医药公司ERP/业务","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/%E4%B8%9A%E5%8A%A1/"}],"tags":[]},{"title":"库存占用逻辑","slug":"项目/医药公司ERP/20230825-库存占用逻辑","date":"2023-08-25T14:14:52.000Z","updated":"2024-11-29T02:15:38.599Z","comments":true,"path":"2023/08/25/项目/医药公司ERP/20230825-库存占用逻辑/","link":"","permalink":"https://dbbruce.github.io/2023/08/25/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/20230825-%E5%BA%93%E5%AD%98%E5%8D%A0%E7%94%A8%E9%80%BB%E8%BE%91/","excerpt":"采购退货申请 med.purchase.return.application1.获取记账规则 p_get_record_rule 0.stk.tran.config 采购入、采购退库存配置数据 1.判断模式是出库还是入库，返回in、out 2.获取模型主组织，field字段名称 3.获取系统业务参数表，key参数键 , value参数值123record_rule_out 出库单据记账规则is_check_negative_stock_on_save_when_record_rule_audit 记账规则为审核时保存操作是否校验负库存is_est_available_qty_includes_not_record_in_qty 预计可出库数量包含未记账入库","text":"采购退货申请 med.purchase.return.application1.获取记账规则 p_get_record_rule 0.stk.tran.config 采购入、采购退库存配置数据 1.判断模式是出库还是入库，返回in、out 2.获取模型主组织，field字段名称 3.获取系统业务参数表，key参数键 , value参数值123record_rule_out 出库单据记账规则is_check_negative_stock_on_save_when_record_rule_audit 记账规则为审核时保存操作是否校验负库存is_est_available_qty_includes_not_record_in_qty 预计可出库数量包含未记账入库 4.返回字典123456&#123; &quot;direction&quot;: &quot;out&quot;, &quot;is_check_negative_stock_on_save_when_record_rule_audit&quot;: True, &quot;is_est_available_qty_includes_not_record_in_qty&quot;: False, &quot;record_rule&quot;: &quot;audit&quot;,&#125; 5.代码 &#x2F;opt&#x2F;projects&#x2F;insuite&#x2F;biz&#x2F;scm&#x2F;ps_stk&#x2F;stk_tran_detail&#x2F;development&#x2F;models&#x2F;stk_tran_config.py 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152def p_get_record_rule(self, doc_model, doc_id): &quot;&quot;&quot; 获取记账规则 doc_model: 模型，表头模型名 doc_id： 单据id，表头id 返回： &#123;&#125; &quot;&quot;&quot; self.env.cr.execute( &quot;select direction from stk_tran_config where parent_model=%s order by direction asc&quot;, (doc_model,)) res = self.env.cr.fetchone() direction = &#x27;in&#x27; if res and res[0] == &#x27;1&#x27; else &#x27;out&#x27; sql = &quot;&quot;&quot; select name from ir_model_fields where id =( select field_id from orgs_config where model_id = ( select id from ir_model where model=%s) and is_main_org=true) &quot;&quot;&quot; self._execute(sql, (doc_model,)) row = self.env.cr.fetchone() # 表体主组织列 stk_org_id_col = row[0] sql = &quot;&quot;&quot; select keys.key,coalesce(vals.value,keys.value) as value from ( select &#x27;record_rule_&#123;direction&#125;&#x27; as key, &#x27;save&#x27; as value union all select &#x27;is_check_negative_stock_on_save_when_record_rule_audit&#x27; as key, &#x27;True&#x27; as value union all select &#x27;is_est_available_qty_includes_not_record_in_qty&#x27; as key, &#x27;False&#x27; as value ) keys left join ( select key,value from sys_business_params where org_id=( select &#123;stk_org_id_col&#125; from &#123;doc_model&#125; where id=%s ) and key in (&#x27;record_rule_&#123;direction&#125;&#x27;,&#x27;is_check_negative_stock_on_save_when_record_rule_audit&#x27;,&#x27;is_est_available_qty_includes_not_record_in_qty&#x27;) ) vals on keys.key = vals.key &quot;&quot;&quot;.format( stk_org_id_col=stk_org_id_col, doc_model=doc_model.replace(&#x27;.&#x27;, &#x27;_&#x27;), direction=direction, ) self._execute(sql, (doc_id,)) res = &#123; &quot;direction&quot;: direction, &#125; rows = self.env.cr.dictfetchall() for row in rows: key = row[&#x27;key&#x27;] if key in (&#x27;record_rule_in&#x27;, &#x27;record_rule_out&#x27;): key = &#x27;record_rule&#x27; res[key] = row[&#x27;value&#x27;] return res 2.公共占用方法 p_occupied_instant_inventory 1._generate_line_key生成一个值，用于即时库存字段search_key，查询 2.med.purchase.return.application 123基本数量 qty库存数量 stk_qty辅助数量 aux_qty 3.即时库存表 stk.instant.inventory，计算公式123456789101112基本单位占用量 occupied_qty库存单位占用量 occupied_stk_qty辅助单位占用量 occupied_aux_qty 基本单位可用量 available_qty 库存单位可用量 available_stk_qty 辅助单位可用量 available_aux_qty 未记账入库基本数量 not_record_in_qty未记账入库库存数量not_record_in_stk_qty未记账入库辅助数量 not_record_in_aux_qty未记账出库基本数量 not_record_out_qty未记账出库库存数量 not_record_out_stk_qty未记账出库辅助数量 not_record_out_aux_qty 4.float_compare , 小于 -1， 相等 0， 大于 1 5.代码 &#x2F;opt&#x2F;projects&#x2F;insuite&#x2F;biz&#x2F;med&#x2F;gsp&#x2F;mdm&#x2F;models&#x2F;stk_instant_inventory.py 1234567891011121314151617181920212223242526272829303132333435363738394041def p_occupied_instant_inventory(self, line_records, operation_direction=1, is_out_stock=False, key_dict = &#123;&#125;): &quot;&quot;&quot; 即时库存表&#x27;公共占用方法 占用数量 = 原占用数量+单据明细数量 可用数量数量 = 原可用数量 - 单据明细 :param line_records: 占用单据信息 :param operation_direction: 1占用 -1释放 &quot;&quot;&quot; if not line_records: return params = self.env[&#x27;stk.tran.config&#x27;].p_get_record_rule(line_records.parent_id._name, line_records.parent_id.id) is_est_available_qty_includes_not_record_in_qty = params[&#x27;is_est_available_qty_includes_not_record_in_qty&#x27;] == &#x27;True&#x27; instant_list = self.search([]) for line in line_records: # 通过维度查询即时库存 line_key = self._generate_line_key(line, key_dict) instant = None for instant_line in instant_list: if instant_line.search_key == line_key: instant = instant_line if instant and len(instant) == 1: param = &#123;&#125; line_base_qty = line.qty line_stk_qty = line.stk_qty line_aux_qty = line.aux_qty param[&quot;occupied_qty&quot;] = instant.occupied_qty + operation_direction * line.qty param[&quot;occupied_stk_qty&quot;] = instant.occupied_stk_qty + operation_direction * line.stk_qty param[&quot;occupied_aux_qty&quot;] = instant.occupied_aux_qty + operation_direction * line.aux_qty if not is_out_stock: if is_est_available_qty_includes_not_record_in_qty: param[&quot;available_qty&quot;] = instant.available_qty - operation_direction * line_base_qty + instant.not_record_in_qty - instant.not_record_out_qty param[&quot;available_stk_qty&quot;] = instant.available_stk_qty - operation_direction * line_stk_qty + instant.not_record_in_stk_qty - instant.not_record_out_stk_qty param[&quot;available_aux_qty&quot;] = instant.available_aux_qty - operation_direction * line_aux_qty + instant.not_record_in_aux_qty - instant.not_record_out_aux_qty else: param[&quot;available_qty&quot;] = instant.available_qty - operation_direction * line_base_qty - instant.not_record_out_qty param[&quot;available_stk_qty&quot;] = instant.available_stk_qty - operation_direction * line_stk_qty - instant.not_record_out_stk_qty param[&quot;available_aux_qty&quot;] = instant.available_aux_qty - operation_direction * line_aux_qty - instant.not_record_out_aux_qty if float_compare(param[&quot;available_qty&quot;], 0, curr.get_scm_precision()[1]) == -1 or float_compare(param[&quot;available_stk_qty&quot;], 0, curr.get_scm_precision()[1]) == -1: # param[&quot;available_qty&quot;] &lt; 0 or param[&quot;available_stk_qty&quot;] &lt; 0 # 编码为%s的%s保存之后,库存单位数量为%d,其所在仓库不允许负库存,不允许取消确认 raise ValidationError(_(&#x27;After the %s coded as %s is saved, the number of inventory units is %f, and the warehouse where it is located does not allow negative inventory.&#x27;) %(instant.material_id.number, instant.material_id.name, param[&quot;available_stk_qty&quot;])) instant.write(param) 3.’库存占用明细表’公共增加占用 p_add_occupied_by_source_document 1.occupied_type12(&#x27;lock&#x27;, &#x27;Lock&#x27;), (&#x27;count&#x27;, &#x27;Count&#x27;), (&#x27;reserved&#x27;, &#x27;Reserved&#x27;), (&#x27;check&#x27;, &#x27;Check&#x27;), (&#x27;occupied_material_details&#x27;, &#x27;Occupied by material details&#x27;)已占用,个数,保留,校验,生产订单预留 2.代码1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950def p_add_occupied(self, lines, **kwargs): &quot;&quot;&quot; &#x27;库存占用明细表&#x27;公共增加占用 :param lines: 库存占用明细 :param occupied_type:(&#x27;lock&#x27;, &#x27;Lock&#x27;), (&#x27;count&#x27;, &#x27;Count&#x27;), (&#x27;reserved&#x27;, &#x27;Reserved&#x27;), (&#x27;check&#x27;, &#x27;Check&#x27;) :return: &quot;&quot;&quot; lines = lines.sorted(lambda l: l.parent_id.biz_date) occupied_list = [] for line in lines: occupied = &#123; &quot;occupied_type&quot;: kwargs.get(&#x27;occupied_type&#x27;), # 占用类型 &quot;source_model&quot;: kwargs.get(&#x27;source_model&#x27;), # 来源单据 # 来源单据 &quot;source_line1_model&quot;: kwargs.get(&#x27;source_line1_model&#x27;, line._name), &quot;source_id&quot;: line.parent_id.id, # 单据内码 &quot;source_number&quot;: line.parent_id.number, # 单据编号 &quot;biz_date&quot;: line.parent_id.biz_date, # 单据业务日期 &quot;document_type_id&quot;: line.parent_id.document_type_id.id, # 单据类型 &quot;source_document_type_id&quot;: line.parent_id.document_type_id.id, # 单据类型 &quot;source_line1_id&quot;: line.id, # 明细内码 &quot;stk_org_id&quot;: line.stk_org_id.id, # 库存组织 &quot;owner_type&quot;: line.owner_type, # 货主类型 &quot;occupied_date&quot;: fields.Date.context_today(self), # 占用日期 &quot;occupied_uid&quot;: self.env.uid, # 占用人 &quot;search_key&quot;: line.search_key, # 即时库存内码 &quot;material_id&quot;: line.material_id.id, # 物料名称 &quot;material_number&quot;: line.material_number, # 物料编码 &quot;material_specification&quot;: line.material_specification, # 规格型号 &quot;auxiliary&quot;: line.auxiliary, # 辅助属性 &quot;stk_state_id&quot;: line.stk_state_id.id, # 库存状态 &#x27;lot&#x27;: line.lot, # 批号 &#x27;produce_date&#x27;: line.produce_date, # 生产日期 &#x27;valid_date&#x27;: line.valid_date, # 有效期至 &quot;bom_version_id&quot;: line.bom_version_id.id, # BOM版本 &quot;mto_num&quot;: line.mto_num, # 计划跟踪号 &quot;base_uom_id&quot;: line.uom_id.id, # 基本单位 # &quot;sal_uom_id&quot;:line.sal_uom_id.id, # 销售单位 &quot;stk_uom_id&quot;: line.stk_uom_id.id, # 库存单位 &quot;aux_uom_id&quot;: line.aux_uom_id.id, # 辅助单位 # 占用基本数量 &quot;occupied_qty&quot;: kwargs.get(&#x27;occupied_qty_lambda&#x27;, lambda x: x.occupied_qty)(line), # 占用库存数量 &quot;occupied_stk_qty&quot;: kwargs.get(&#x27;occupied_stk_qty_lambda&#x27;, lambda x: x.occupied_stk_qty)(line), # 占用辅助数量 &quot;occupied_aux_qty&quot;: kwargs.get(&#x27;occupied_aux_qty_lambda&#x27;, lambda x: x.occupied_aux_qty)(line), &#125; occupied_list.append(occupied) self.create(occupied_list)","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"医药公司ERP","slug":"项目/医药公司ERP","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/"},{"name":"业务","slug":"项目/医药公司ERP/业务","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/%E4%B8%9A%E5%8A%A1/"}],"tags":[]},{"title":"组装sql方法-p_get_query_sql","slug":"项目/医药公司ERP/20230824-组装sql方法-p_get_query_sql","date":"2023-08-24T12:14:52.000Z","updated":"2024-11-29T02:15:38.648Z","comments":true,"path":"2023/08/24/项目/医药公司ERP/20230824-组装sql方法-p_get_query_sql/","link":"","permalink":"https://dbbruce.github.io/2023/08/24/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/20230824-%E7%BB%84%E8%A3%85sql%E6%96%B9%E6%B3%95-p_get_query_sql/","excerpt":"1.参数讲解1.1.table_list12数据格式：[(&#x27;实际表名&#x27;, &#x27;表别名&#x27;, &#x27;表关联关系&#x27;),()][(&#x27;ia_out_result&#x27;, &#x27;i1&#x27;), (&#x27;mdm_material&#x27;, &#x27;m1&#x27;, &#x27;m1.id = i1.material_id&#x27;), (&#x27;stk_delivery_line1&#x27;, &#x27;l1&#x27;, &quot;l1.id = i1.doc_line_id and i1.doc_line_model = &#x27;stk.delivery.line1&#x27;&quot;), (&#x27;stk_delivery&#x27;, &#x27;p1&#x27;, &#x27;p1.id=l1.parent_id&#x27;), (&#x27;sys_admin_orgs&#x27;, &#x27;o1&#x27;, &#x27;o1.id=p1.sal_org_id&#x27;), (&#x27;mdm_customer&#x27;, &#x27;s1&#x27;, &#x27;s1.id=p1.customer_id&#x27;), (&#x27;mdm_product_bom&#x27;, &#x27;b1&#x27;, &#x27;b1.id=l1.bom_version_id&#x27;), (&#x27;sys_admin_orgs&#x27;, &#x27;o2&#x27;, &#x27;o2.id=p1.stk_org_id&#x27;), (&#x27;mdm_warehouse&#x27;, &#x27;w1&#x27;, &#x27;w1.id=l1.warehouse_id&#x27;), (&#x27;mdm_unit&#x27;, &#x27;u1&#x27;, &#x27;u1.id=l1.uom_id&#x27;), (&#x27;ar_receivable_line1_material&#x27;, &#x27;arl&#x27;, &quot;arl.source_line1_model=&#x27;stk.delivery.line1&#x27; and arl.source_line1_id=l1.id and arl.delete_state = &#x27;normal&#x27;&quot;)]","text":"1.参数讲解1.1.table_list12数据格式：[(&#x27;实际表名&#x27;, &#x27;表别名&#x27;, &#x27;表关联关系&#x27;),()][(&#x27;ia_out_result&#x27;, &#x27;i1&#x27;), (&#x27;mdm_material&#x27;, &#x27;m1&#x27;, &#x27;m1.id = i1.material_id&#x27;), (&#x27;stk_delivery_line1&#x27;, &#x27;l1&#x27;, &quot;l1.id = i1.doc_line_id and i1.doc_line_model = &#x27;stk.delivery.line1&#x27;&quot;), (&#x27;stk_delivery&#x27;, &#x27;p1&#x27;, &#x27;p1.id=l1.parent_id&#x27;), (&#x27;sys_admin_orgs&#x27;, &#x27;o1&#x27;, &#x27;o1.id=p1.sal_org_id&#x27;), (&#x27;mdm_customer&#x27;, &#x27;s1&#x27;, &#x27;s1.id=p1.customer_id&#x27;), (&#x27;mdm_product_bom&#x27;, &#x27;b1&#x27;, &#x27;b1.id=l1.bom_version_id&#x27;), (&#x27;sys_admin_orgs&#x27;, &#x27;o2&#x27;, &#x27;o2.id=p1.stk_org_id&#x27;), (&#x27;mdm_warehouse&#x27;, &#x27;w1&#x27;, &#x27;w1.id=l1.warehouse_id&#x27;), (&#x27;mdm_unit&#x27;, &#x27;u1&#x27;, &#x27;u1.id=l1.uom_id&#x27;), (&#x27;ar_receivable_line1_material&#x27;, &#x27;arl&#x27;, &quot;arl.source_line1_model=&#x27;stk.delivery.line1&#x27; and arl.source_line1_id=l1.id and arl.delete_state = &#x27;normal&#x27;&quot;)] 1.2.query_list1234数据格式： [(&#x27;查询字段 as 别名&#x27; , &#x27;分组或者排序标志&#x27;, &#x27;字段的中文翻译&#x27; ),()]排序规则：asc/desc 将字段加入排序分组规则：1、不是排序字段且不为空加入分组 2、整个元组里的元素大于4，将第5个元素(xxx[4])加入分组[(&#x27;max(i1.document_type_id) as document_type&#x27;, &#x27;&#x27;, &#x27;单据类型&#x27;), (&#x27;max(p1.number) as doc_number&#x27;, &#x27;i1.id&#x27;, &#x27;单据编号&#x27;), (&#x27;max(i1.biz_date) as biz_date&#x27;, &#x27;l1.id&#x27;, &#x27;业务日期&#x27;), (&#x27;max(s1.name) as customer&#x27;, &#x27;&#x27;, &#x27;客户&#x27;), (&#x27;max(o1.name) as sal_org&#x27;, &#x27;&#x27;, &#x27;销售组织&#x27;), (&#x27;max(m1.category_id) as category&#x27;, &#x27;m1.number&#x27;, &#x27;存货类别&#x27;), (&#x27;max(m1.number) as material_number&#x27;, &#x27;&#x27;, &#x27;物料编号&#x27;), (&#x27;max(m1.name) as material&#x27;, &#x27;&#x27;, &#x27;物料名称&#x27;), (&#x27;max(m1.specification) as specification&#x27;, &#x27;&#x27;, &#x27;规格型号&#x27;), (&#x27;max(l1.auxiliary) as auxiliary&#x27;, &#x27;&#x27;, &#x27;辅助属性&#x27;), (&#x27;max(l1.lot) as lot&#x27;, &#x27;&#x27;, &#x27;批号&#x27;), (&#x27;max(b1.version_number) as bom&#x27;, &#x27;&#x27;, &#x27;BOM版本号&#x27;), (&#x27;max(l1.mto_num) as mto&#x27;, &#x27;&#x27;, &#x27;计划跟踪号&#x27;), (&#x27;max(p1.owner_type) as owner_type&#x27;, &#x27;&#x27;, &#x27;货主&#x27;), ...] 1.3.query_domains_in_med12根据form字段取值，组装查询条件[(&#x27;i1.accting_sys_id&#x27;, &#x27;=&#x27;, 1), (&#x27;i1.accting_org_id&#x27;, &#x27;=&#x27;, 1), (&#x27;i1.accting_policy_id&#x27;, &#x27;=&#x27;, 1), (&#x27;i1.biz_date&#x27;, &#x27;&gt;=&#x27;, datetime.date(2024, 8, 1)), (&#x27;i1.biz_date&#x27;, &#x27;&lt;=&#x27;, datetime.date(2024, 8, 31)), (&#x27;i1.document_type_id&#x27;, &#x27;in&#x27;, [...])] 2、源码123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106def p_get_query_sql(self,table_list,query_list,query_domains): &quot;&quot;&quot; @desc: 组装sql公共方法 @params: self: 当前示例对象 @params: table_list: 数据库数据查询所需表名相关数据 @params: query_list: 数据库数据查询所需查询字段相关数据 @params: query_domains: 数据库数据查询所需查询条件 @return: None &quot;&quot;&quot; # 查询部分sql select_sql = &quot;&quot; # 查询表相关sql table_sql = &quot;&quot; # 查询条件相关sql where_sql = &quot;&quot; # 查询分组相关sql group_sql = &quot;&quot; # 查询分组字段列表 group_list = list() # 查询排序相关sql order_sql = &quot;&quot; # 查询排序字段列表 order_list = list() # 组装查询字段相关sql for query_trup in query_list: name = query_trup[0] # 组装一个字段的别名如客户表c1中客户名称name字段max(c1.name)则简化为c1_name，销售订单表体sum(l1.price)则为l1_price,加减乘除运算替换为英文字母sum(t1.a)/sum(t2.b) = t1_a_div_t2_b # 如果传入别名，则直接使用传入的别名 if re.search(r&#x27; as .*?$&#x27;,name): name_str = &#x27;&#x27; else: # 没有传入别名则通过get_col_name生成别名 name_str = self.get_col_name(name) # 拼接查询字段sql，并拼接字段别名 select_sql += name + &quot; &quot; + name_str + &quot;,&quot; # 从查询字段sql中，取出需要进行排序的字段 if query_trup[1] and (query_trup[1] == &quot;asc&quot; or query_trup[1] == &quot;desc&quot;): order_list.append(name_str + &quot; &quot; + query_trup[1]) # 从查询字段sql中，取出需要进行分组的字段，分组的同时，需要查询这些字段 elif query_trup[1] and query_trup[1] != &quot;&quot; and query_trup[1] not in group_list: group_list.append(query_trup[1]) # 如果长度大于4，即为传了计量单位或币种，则查出单位或币种 if len(query_trup) &gt; 4 and query_trup[4] not in group_list: group_list.append(query_trup[4]) # 将需要group by的且未查询的字段加入查询列表。因为点击穿透时，可能会需要这些字段 for key in group_list: if key not in select_sql: # 获取别名 key_str = self.get_col_name(key) # 在查询中拼入group by字段，方便后续获取 select_sql += key + &quot; &quot; + key_str + &quot;,&quot; # 拼接开始 sql = &quot;select &quot; # 拼接查询字段，去除最后一个标点符号 sql += select_sql[0:-1] # 拼接主表表名 sql += &quot; from &quot; + table_list[0][0] + &quot; &quot; + table_list[0][1] # 遍历完成表连接 for i in range(1,len(table_list)): table_sql += &quot; left join &quot; + table_list[i][0] + &quot; &quot; + table_list[i][1] table_sql += &quot; on &quot; + table_list[i][2] sql += table_sql # 存在查询条件时，拼接where条件 if len(query_domains) != 0: sql += &quot; where &quot; for domain in query_domains: # 查询条件为多选时，需要通过in并遍历拼接 if domain and domain[1] == &quot;in&quot;: if domain[2] != []: where_sql += str(domain[0]) + &quot; in (&quot; for where_value in domain[2]: if isinstance(where_value, tuple): where_sql += &quot; &quot; + str(where_value) + &quot;,&quot; else: where_sql += &quot;&#x27;&quot; + str(where_value) +&quot;&#x27;&quot; + &quot;,&quot; where_sql = re.sub(r&#x27;,$&#x27;, &#x27;&#x27;, where_sql) where_sql += &quot;) and &quot; else: where_sql += str(domain[0]) + &quot; is null and &quot; elif domain: if domain[1] == &#x27;is not null&#x27;: where_sql += str(domain[0]) + &quot; is not null and &quot; else: # 查询条件为&quot;=&quot;、&quot;&gt;=&quot;、&quot;&lt;=&quot; 时，统一进行拼接 where_sql += str(domain[0]) + str(domain[1]) + &quot;&#x27;&quot; + str(domain[2]) +&quot;&#x27;&quot; + &quot; and &quot; # 拼接时，移除最后的&quot;and &quot; sql += where_sql[0:-4] # 存在需要分组字段时，拼接group by字段 if len(group_list) != 0: sql += &quot; group by &quot; for key in group_list: group_sql += key + &quot;,&quot; sql += group_sql[0:-1] # 存在需要排序字段时，拼接order by字段 if len(order_list) != 0: sql += &quot; order by &quot; for key in order_list: order_sql += key + &quot;,&quot; order_sql = order_sql[0:-1] # 如需复杂排序方法，自行书写，重写_get_muli_order方法，若重写，则调用 if hasattr(self, &#x27;_get_muli_order&#x27;): # 调用复杂排序方法，覆盖原排序 order_sql = &quot; &quot; + self._get_muli_order() sql += order_sql return sql","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"医药公司ERP","slug":"项目/医药公司ERP","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/"},{"name":"业务","slug":"项目/医药公司ERP/业务","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/%E4%B8%9A%E5%8A%A1/"}],"tags":[]},{"title":"GSP销售订单反写实现","slug":"项目/医药公司ERP/20230823-GSP销售订单反写实现","date":"2023-08-23T14:14:52.000Z","updated":"2024-11-29T02:15:38.591Z","comments":true,"path":"2023/08/23/项目/医药公司ERP/20230823-GSP销售订单反写实现/","link":"","permalink":"https://dbbruce.github.io/2023/08/23/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/20230823-GSP%E9%94%80%E5%94%AE%E8%AE%A2%E5%8D%95%E5%8F%8D%E5%86%99%E5%AE%9E%E7%8E%B0/","excerpt":"1.GSP销售订单反写累计退货数量的实现 退货入库单保存后，会反写累计退货数量，这里需要反写累计退货数量","text":"1.GSP销售订单反写累计退货数量的实现 退货入库单保存后，会反写累计退货数量，这里需要反写累计退货数量 2.业务逻辑图 3.配置方法 4.代码实现 &#x2F;opt&#x2F;projects&#x2F;insuite&#x2F;biz&#x2F;scm&#x2F;scm_base&#x2F;models&#x2F;scm_base.py 123456789101112131415161718192021222324252627282930313233def botp_hook_after_reverse(self, **kwargs): &quot;&quot;&quot; @desc: 反写成功的数据更新销售订单跟踪表 @params: kwargs: after_cancel_reverse_data dict: &#123; &#x27;model_served&#x27;: 对应服务模型名 str &#x27;operation&#x27;: 服务名称 str &#x27;origin_args&#x27;: 操作明细 dict（服务为保存时为write函数的val，服务为删除时参数有args及kwargs为空） &#x27;record_ids&#x27;: 操作对象记录集 obj &#x27;timing&#x27;: 服务时机（before为操作前的服务，after为操作后的服务） str &#125; source_model_key str: 源单模型名 @return: &quot;&quot;&quot; after_reverse_data = kwargs.get(&#x27;after_reverse_data&#x27;, &#123;&#125;) if not after_reverse_data: return False # 单据自定义钩子 if hasattr(self, &#x27;botp_after_reverse_hooker&#x27;): getattr(self, &#x27;botp_after_reverse_hooker&#x27;)(**kwargs) # 当前单据记录 doc_ids = after_reverse_data[&#x27;record_ids&#x27;].filtered(lambda x: x.is_convert) # 获取单据信息，对应link表模型名，主表体o2m字段名 doc_info = self._get_doc_info(doc_model=self._name) # 当前单据明细记录 for rec in doc_ids[doc_info[0]]: # 更新销售订单跟踪表 if hasattr(doc_ids, &#x27;botp_update_order_track&#x27;): getattr(doc_ids, &#x27;botp_update_order_track&#x27;)(modify_line=rec, is_cancel_reverse=False) &#x2F;opt&#x2F;projects&#x2F;insuite&#x2F;biz&#x2F;med&#x2F;med_inv&#x2F;med_inv_sal_return&#x2F;development&#x2F;models&#x2F;med_inv_sal_return.py 12345678910111213141516171819def botp_update_order_track(self, modify_line=None, is_cancel_reverse=None): &quot;&quot;&quot; @desc: 更新销售订单明细及跟踪表 更新发货通知单累计出库数量 @params: modify_line obj: 销售退库单明细 is_cancel_reverse bool: 是否撤销反写 @return: &quot;&quot;&quot; # 反写跟踪表 if modify_line.origin_order_lineid and modify_line.origin_order_lineid._name == &#x27;med.sal.order.line2&#x27;: sal_order_line = self.env[&#x27;med.sal.order.line2&#x27;].browse(modify_line.origin_order_lineid.id) # 更新累计退库数量 sal_order_line.write(&#123; &#x27;return_qty_total&#x27;: sal_order_line.return_qty_total - modify_line.qty if is_cancel_reverse else sal_order_line.return_qty_total + modify_line.qty, &#x27;return_sal_qty_total&#x27;: sal_order_line.return_sal_qty_total - modify_line.sal_qty if is_cancel_reverse else sal_order_line.return_sal_qty_total + modify_line.sal_qty, &#125;)","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"医药公司ERP","slug":"项目/医药公司ERP","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/"},{"name":"业务","slug":"项目/医药公司ERP/业务","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/%E4%B8%9A%E5%8A%A1/"}],"tags":[]},{"title":"存货占比分析(ia.occupied.detail.query)","slug":"项目/医药公司ERP/20230822-存货占比分析","date":"2023-08-22T14:14:52.000Z","updated":"2024-11-29T02:15:38.652Z","comments":true,"path":"2023/08/22/项目/医药公司ERP/20230822-存货占比分析/","link":"","permalink":"https://dbbruce.github.io/2023/08/22/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/20230822-%E5%AD%98%E8%B4%A7%E5%8D%A0%E6%AF%94%E5%88%86%E6%9E%90/","excerpt":"1.sql 查询存货余额表，物料表，组织机构表，获取到物料名称，物料编码，所属组织，所属分类，期初数量，期初金额，占比，物料ID，组织ID，核算政策ID，单位ID，币种ID","text":"1.sql 查询存货余额表，物料表，组织机构表，获取到物料名称，物料编码，所属组织，所属分类，期初数量，期初金额，占比，物料ID，组织ID，核算政策ID，单位ID，币种ID 123456789101112131415161718192021222324252627282930313233343536373839SELECT MAX( m1.NUMBER ) AS material_number, MAX ( m1.NAME ) AS material_name, MAX ( m1.category_id ) AS category, MAX ( o1.NAME ) AS owner_type, SUM ( i1.init_qty ) AS qty, SUM ( i1.init_amount ) AS amount, 0 AS proportion, i1.material_id i1_material_id, i1.accting_org_id i1_accting_org_id, i1.accting_sys_id i1_accting_sys_id, o1.ID o1_id, i1.accting_policy_id i1_accting_policy_id, i1.uom_id i1_uom_id, i1.local_currency_id i1_local_currency_id FROM ia_balance i1 LEFT JOIN mdm_material m1 ON m1.ID = i1.material_id LEFT JOIN sys_admin_orgs o1 ON o1.ID=i1.accting_org_id AND o1.ID = to_number( REPLACE ( COALESCE ( i1.owner_type, &#x27;0&#x27; ), &#x27;sys.admin.orgs,&#x27;, &#x27;&#x27; ), &#x27;9999999&#x27; ) WHERE i1.accting_sys_id = &#x27;1&#x27; AND i1.accting_org_id = &#x27;1&#x27; AND i1.accting_policy_id = &#x27;1&#x27; AND ( i1.accting_year, i1.accting_period ) IN ( ( &#x27;2024&#x27;, &#x27;08&#x27; ) ) GROUP BY i1.material_id, i1.accting_org_id, i1.accting_sys_id, o1.ID, i1.accting_policy_id, i1.uom_id, i1.local_currency_id; 2.sql 查询存货入库表，物料，存货管理，库存台账，内部交易，组织结构12345678910111213141516171819202122232425262728293031323334353637383940414243444546SELECT MAX( m1.NUMBER ) AS material_number, MAX ( m1.NAME ) AS material_name, MAX ( m1.category_id ) AS category, MAX ( o1.NAME ) AS owner_type, SUM ( i1.qty ) AS qty, SUM ( i1.cost_amount ) AS amount, 0 AS proportion, i1.material_id i1_material_id, o1.ID o1_id, m1.uom_id m1_uom_id, i1.accting_currency_id i1_accting_currency_id FROM ia_in_result i1 LEFT JOIN mdm_material m1 ON m1.ID = i1.material_id LEFT JOIN ia_accting_dimensions dim ON i1.accting_dimensions_id = dim.ID LEFT JOIN stk_tran_detail d1 ON d1.src_id = i1.doc_line_id AND d1.src_model = i1.doc_line_model AND ( CASE WHEN d1.src_model = &#x27;stk.direct.trans.line1&#x27; AND d1.source_line1_model IS NULL THEN d1.qty_option = &#x27;1&#x27; WHEN d1.src_model = &#x27;stk.direct.trans.line1&#x27; AND d1.source_line1_model IS NOT NULL THEN d1.qty_option = &#x27;-1&#x27; WHEN d1.src_model = &#x27;medinv.direct.trans.line1&#x27; THEN d1.qty_option = &#x27;1&#x27; ELSE TRUE END ) LEFT JOIN ia_inter_transaction i2 ON i2.src_id = i1.doc_line_id AND i2.src_model = i1.doc_line_model LEFT JOIN sys_admin_orgs o1 ON o1.ID = to_number( CASE WHEN dim.owner_type_value != &#x27;0&#x27; THEN dim.owner_type_value ELSE REPLACE ( COALESCE ( d1.ia_owner_type, i2.ia_owner_type ), &#x27;sys.admin.orgs,&#x27;, &#x27;&#x27; ) END, &#x27;9999999&#x27; ) WHERE i1.accting_sys_id = &#x27;1&#x27; AND i1.accting_org_id = &#x27;1&#x27; AND i1.accting_policy_id = &#x27;1&#x27; AND i1.biz_date &gt;= &#x27;2024-08-01&#x27; AND i1.biz_date &lt;= &#x27;2024-08-31&#x27; GROUP BY i1.material_id, o1.ID, m1.uom_id, i1.accting_currency_id 3.sql 查询存货出库表，物料，存货管理，库存台账，内部交易，组织结构123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354SELECT MAX( m1.NUMBER ) AS material_number, MAX ( m1.NAME ) AS material_name, MAX ( m1.category_id ) AS category, MAX ( o1.NAME ) AS owner_type, SUM ( i1.qty ) AS qty, SUM ( i1.cost_amount ) AS amount, 0 AS proportion, i1.material_id i1_material_id, o1.ID o1_id, m1.uom_id m1_uom_id, i1.accting_currency_id i1_accting_currency_id FROM ia_out_result i1 LEFT JOIN mdm_material m1 ON m1.ID = i1.material_id LEFT JOIN ia_accting_dimensions dim ON i1.accting_dimensions_id = dim.ID LEFT JOIN stk_tran_detail d1 ON d1.src_id = i1.doc_line_id AND d1.src_model = i1.doc_line_model AND ( CASE WHEN d1.src_model = &#x27;stk.direct.trans.line1&#x27; AND d1.source_line1_model IS NULL THEN d1.qty_option = &#x27;-1&#x27; WHEN d1.src_model = &#x27;stk.direct.trans.line1&#x27; AND d1.source_line1_model IS NOT NULL THEN d1.qty_option = &#x27;1&#x27; WHEN d1.src_model = &#x27;medinv.direct.trans.line1&#x27; THEN d1.qty_option = &#x27;-1&#x27; ELSE TRUE END ) LEFT JOIN ia_inter_transaction i2 ON i2.src_id = i1.doc_line_id AND i2.src_model = i1.doc_line_model LEFT JOIN sys_admin_orgs o1 ON o1.ID = to_number( CASE WHEN dim.owner_type_value != &#x27;0&#x27; THEN dim.owner_type_value ELSE REPLACE ( COALESCE ( d1.ia_owner_type, i2.ia_owner_type ), &#x27;sys.admin.orgs,&#x27;, &#x27;&#x27; ) END, &#x27;9999999&#x27; ) WHERE i1.accting_sys_id = &#x27;1&#x27; AND i1.accting_org_id = &#x27;1&#x27; AND i1.accting_policy_id = &#x27;1&#x27; AND i1.biz_date &gt;= &#x27;2024-08-01&#x27; AND i1.biz_date &lt;= &#x27;2024-08-31&#x27; GROUP BY i1.material_id, o1.ID, m1.uom_id, i1.accting_currency_id 4.库存数量计算方法 涉及字段： 表 字段 ia_balance init_qty ia_out_result qty ia_in_result qty 分组12345GROUP BY i1.material_id, o1.ID, m1.uom_id, i1.accting_currency_id 聚会1SUM ( i1.qty ) AS qty 5.库存金额计算方法 涉及字段： 表 字段 ia_balance init_amount ia_out_result cost_amount ia_in_result cost_amount 分组12345GROUP BY i1.material_id, o1.ID, m1.uom_id, i1.accting_currency_id 聚会1SUM ( i1.cost_amount ) AS amount 6.占总存货比例 results列表包含3部分数据,[[初始库存],[新入库],[出库]] 总库存数量：[初始库存].库存量 + [新入库].库存量 - [出库].库存量 占总存货比例 &#x3D; 每个库存量 &#x2F; 总库存量1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162def process_results(self, results): &quot;&quot;&quot; 处理多个结果集 将多个结果集按照维度汇总起来，并计算占比 &quot;&quot;&quot; # 计算当前全部物料的总金额 total_amount = 0 print(results) for row, result in enumerate(results): if result: for line in result: if row != 2: total_amount += line.get(&#x27;amount&#x27;) if line.get(&#x27;amount&#x27;) else 0 elif row == 2: # row 2是出库，减去库存量 total_amount -= line.get(&#x27;amount&#x27;) if line.get(&#x27;amount&#x27;) else 0 # 存货类别名称字典 CATEGORY_DICT = self._get_category_dict() # 将多个记录集按照维度汇总起来 final_results_dict = &#123;&#125; for row, result in enumerate(results): for line in result: if not line.get(self.get_col_name(&#x27;i1.material_id&#x27;), False): continue # 维度key 通过物料id+货主确定唯一key key = str(line.get(self.get_col_name(&#x27;i1.material_id&#x27;))) # 物料id key += &#x27;+&#x27;+str(line.get(self.get_col_name(&#x27;o1.id&#x27;))) if line.get(self.get_col_name(&#x27;o1.id&#x27;)) else &#x27;+@&#x27; # 货主id accumulative_line = final_results_dict.get(key,&#123;&#125;) # 三个结果集分别为查询 存货余额表、入库成本结果表、出库成本结果表 if row != 2: # 该维度物料不存在则新建 if not accumulative_line: accumulative_line = line # 防止值为NULL时后续运算报错 accumulative_line[&#x27;qty&#x27;] = line.get(&#x27;qty&#x27;,0) accumulative_line[&#x27;amount&#x27;] = line.get(&#x27;amount&#x27;,0) # 该维度物料存在则累加 else: accumulative_line[&#x27;qty&#x27;] += line.get(&#x27;qty&#x27;,0) accumulative_line[&#x27;amount&#x27;] += line.get(&#x27;amount&#x27;,0) # 出库结果表数据，需要将数量和金额减掉 elif row ==2: if not accumulative_line: accumulative_line = line accumulative_line[&#x27;qty&#x27;] = -line.get(&#x27;qty&#x27;,0) accumulative_line[&#x27;amount&#x27;] = -line.get(&#x27;amount&#x27;,0) else: accumulative_line[&#x27;qty&#x27;] -= line.get(&#x27;qty&#x27;,0) accumulative_line[&#x27;amount&#x27;] -= line.get(&#x27;amount&#x27;,0) if not accumulative_line.get(&#x27;precision_currency_id&#x27;): # 使用统一key‘precision_currency_id’记录本位币，方便计算精度时取用 accumulative_line[&#x27;precision_currency_id&#x27;] = line.get(self.get_col_name(&#x27;i1.local_currency_id&#x27;),False) or line.get(self.get_col_name(&#x27;i1.accting_currency_id&#x27;),False) if not accumulative_line.get(&#x27;precision_uom_id&#x27;): # 使用统一key‘precision_uom_id’记录单位，方便计算精度时取用 accumulative_line[&#x27;precision_uom_id&#x27;] = line.get(self.get_col_name(&#x27;m1.uom_id&#x27;),False) or line.get(self.get_col_name(&#x27;i1.uom_id&#x27;),False) # 计算存货占比 accumulative_line[&#x27;proportion&#x27;] = accumulative_line[&#x27;amount&#x27;]/total_amount*100 if total_amount else 0 # 将存货类别key替换成可翻译的字段 accumulative_line[&#x27;category&#x27;] = CATEGORY_DICT.get(accumulative_line[&#x27;category&#x27;], accumulative_line[&#x27;category&#x27;]) final_results_dict[key] = accumulative_line final_results = list(final_results_dict.values()) return final_results","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"医药公司ERP","slug":"项目/医药公司ERP","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/"},{"name":"业务","slug":"项目/医药公司ERP/业务","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/%E4%B8%9A%E5%8A%A1/"}],"tags":[]},{"title":"存货收发存汇总表(ia.transaction.summary.query)","slug":"项目/医药公司ERP/20230821-存货收发存汇总表","date":"2023-08-21T14:14:52.000Z","updated":"2024-11-29T02:15:38.602Z","comments":true,"path":"2023/08/21/项目/医药公司ERP/20230821-存货收发存汇总表/","link":"","permalink":"https://dbbruce.github.io/2023/08/21/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/20230821-%E5%AD%98%E8%B4%A7%E6%94%B6%E5%8F%91%E5%AD%98%E6%B1%87%E6%80%BB%E8%A1%A8/","excerpt":"1、超级复杂SQL（SQL套娃） 1.sql","text":"1、超级复杂SQL（SQL套娃） 1.sql 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128SELECT CASE WHEN stk.ID IS NOT NULL THEN concat_ws( &#x27;_&#x27;, stk.material_id, stk.uom_id, COALESCE(stk.lot, &#x27;null&#x27;), COALESCE(stk.auxiliary, &#x27;null&#x27;), COALESCE(stk.bom_version_id, 0), COALESCE(stk.warehouse_id, 0), COALESCE(stk.location_id, 0), COALESCE(stk.stk_org_id, 0), COALESCE(&#x27;sys.admin.orgs,&#x27; || CASE WHEN dim.owner_type_value != &#x27;0&#x27; THEN dim.owner_type_value ELSE REPLACE(stk.ia_owner_type, &#x27;sys.admin.orgs,&#x27;, &#x27;&#x27;) END, &#x27;null&#x27; ), COALESCE(stk.mto_num, &#x27;null&#x27;), ia_in.accting_dimensions_id ) ELSE concat_ws( &#x27;_&#x27;, ia_in.material_id, mat.uom_id, COALESCE(inter_doc.lot, &#x27;null&#x27;), COALESCE(inter_doc.auxiliary, &#x27;null&#x27;), COALESCE(inter_doc.bom_version_id, 0), COALESCE(inter_doc.warehouse_id, 0), COALESCE(inter_doc.location_id, 0), COALESCE(inter_doc.stk_org_id, 0), COALESCE(&#x27;sys.admin.orgs,&#x27; || CASE WHEN dim.owner_type_value != &#x27;0&#x27; THEN dim.owner_type_value ELSE REPLACE(inter_doc.ia_owner_type, &#x27;sys.admin.orgs,&#x27;, &#x27;&#x27;) END, &#x27;null&#x27; ), COALESCE(inter_doc.mto_num, &#x27;null&#x27;), ia_in.accting_dimensions_id ) END AS KEY, ia_in.material_id, mat.uom_id, COALESCE ( stk.lot, inter_doc.lot ) lot, COALESCE ( stk.auxiliary, inter_doc.auxiliary ) auxiliary, COALESCE ( stk.bom_version_id, inter_doc.bom_version_id ) bom_version_id, COALESCE ( stk.warehouse_id, inter_doc.warehouse_id ) warehouse_id, COALESCE ( stk.location_id, inter_doc.location_id ) location_id, COALESCE ( stk.stk_org_id, inter_doc.stk_org_id ) stk_org_id, &#x27;sys.admin.orgs,&#x27; || case when dim.owner_type_value != &#x27;0&#x27; then dim.owner_type_value else replace(COALESCE(stk.ia_owner_type, inter_doc.ia_owner_type),&#x27;sys.admin.orgs,&#x27;,&#x27;&#x27;) end owner_type, COALESCE ( stk.mto_num, inter_doc.mto_num ) mto_num, ia_in.qty, 0 AS cost_price, ia_in.cost_amount, ia_in.accting_dimensions_id, ia_in.accting_currency_id, ia_in.accting_sys_id, ia_in.accting_org_id, ia_in.accting_policy_idFROM ia_in_result ia_in LEFT JOIN ia_accting_dimensions dim ON ia_in.accting_dimensions_id = dim.ID LEFT JOIN stk_tran_detail stk ON stk.src_id = ia_in.doc_line_id -- 库存台账明细表 AND stk.src_model = ia_in.doc_line_model AND ( CASE -- 直接调拨单 src_model 单据模型名， source_line1_model line1模型名 WHEN stk.src_model = &#x27;stk.direct.trans.line1&#x27; AND stk.source_line1_model IS NULL THEN stk.qty_option = &#x27;1&#x27; WHEN stk.src_model = &#x27;stk.direct.trans.line1&#x27; AND stk.source_line1_model IS NOT NULL THEN stk.qty_option = &#x27;-1&#x27; -- 手工移库单 WHEN stk.src_model = &#x27;medinv.direct.trans.line1&#x27; THEN stk.qty_option = &#x27;1&#x27; ELSE TRUE END ) LEFT JOIN ia_inter_transaction inter_doc ON inter_doc.src_id = ia_in.doc_line_id AND inter_doc.src_model = ia_in.doc_line_model LEFT JOIN mdm_material mat ON ia_in.material_id = mat.IDWHERE ia_in.biz_date &gt;= &#x27;2024-08-01&#x27; AND ia_in.biz_date &lt;= &#x27;2024-08-31&#x27; AND ia_in.doc_line_model != &#x27;ia.cost.adjustment.line1&#x27;UNION ALLSELECT concat_ws( &#x27;_&#x27;, adj.material_id, mat1.uom_id, COALESCE(adj.lot, &#x27;null&#x27;), COALESCE(adj.auxiliary, &#x27;null&#x27;), COALESCE(adj.bom_version_id, 0), COALESCE(adj.warehouse_id, 0), COALESCE(adj.location_id, 0), COALESCE(adj.stk_org_id, 0), COALESCE(adj.owner_type, &#x27;null&#x27;), COALESCE(adj.mto_number, &#x27;null&#x27;), ia_in.accting_dimensions_id ) AS KEY, adj.material_id, mat1.uom_id, adj.lot, adj.auxiliary, adj.bom_version_id, adj.warehouse_id, adj.location_id, adj.stk_org_id, adj.owner_type, adj.mto_number, ia_in.qty, 0 AS cost_price, ia_in.cost_amount, ia_in.accting_dimensions_id, ia_in.accting_currency_id, ia_in.accting_sys_id, ia_in.accting_org_id, ia_in.accting_policy_idFROM ia_cost_adjustment_line1 adj JOIN ia_in_result ia_in ON ia_in.doc_line_id = adj.ID AND ia_in.doc_line_model = &#x27;ia.cost.adjustment.line1&#x27; LEFT JOIN mdm_material mat1 ON adj.material_id = mat1.IDWHERE ia_in.biz_date &gt;= &#x27;2024-08-01&#x27; AND ia_in.biz_date &lt;= &#x27;2024-08-31&#x27; 2.sql 12345678910111213141516171819202122232425262728293031323334353637383940414243-- 将1.sql 查出的结果，group by分组SELECT MAX( KEY ) AS KEY, material_id, uom_id, lot, auxiliary, bom_version_id, warehouse_id, location_id, stk_org_id, owner_type, mto_num, SUM ( qty ) AS qty, CASE WHEN COALESCE ( SUM ( qty ), 0 ) = 0 THEN 0 ELSE SUM ( cost_amount ) / SUM ( qty ) END AS cost_price, SUM ( cost_amount ) AS cost_amount, accting_dimensions_id, accting_currency_id, accting_sys_id, accting_org_id, accting_policy_idFROM ( 替换成1.sql的内容 ) AS in_iaGROUP BY material_id, uom_id, lot, auxiliary, bom_version_id, warehouse_id, location_id, stk_org_id, owner_type, mto_num, accting_dimensions_id, accting_currency_id, accting_sys_id, accting_org_id, accting_policy_id 3.sql 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220SELECT CASE WHEN in_cost.accting_sys_id IS NOT NULL THEN concat_ws ( &#x27;_&#x27;, in_cost.accting_sys_id, in_cost.accting_org_id, in_cost.accting_policy_id, 2024, 08, in_cost.KEY ) ELSE concat_ws ( &#x27;_&#x27;, out_cost.accting_sys_id, out_cost.accting_org_id, out_cost.accting_policy_id, 2024, 08, out_cost.KEY ) END stk_ia_dimension, COALESCE ( in_cost.material_id, out_cost.material_id ) material_id, COALESCE ( in_cost.uom_id, out_cost.uom_id ) uom_id, COALESCE ( in_cost.lot, out_cost.lot ) lot, COALESCE ( in_cost.auxiliary, out_cost.auxiliary ) auxiliary, COALESCE ( in_cost.bom_version_id, out_cost.bom_version_id ) bom_version_id, COALESCE ( in_cost.warehouse_id, out_cost.warehouse_id ) warehouse_id, COALESCE ( in_cost.location_id, out_cost.location_id ) location_id, COALESCE ( in_cost.stk_org_id, out_cost.stk_org_id ) stk_org_id, COALESCE ( in_cost.owner_type, out_cost.owner_type ) owner_type, COALESCE ( in_cost.mto_num, out_cost.mto_num ) mto_num, COALESCE ( in_cost.accting_dimensions_id, out_cost.accting_dimensions_id ) accting_dimensions_id, COALESCE ( in_cost.qty, 0 ) - COALESCE ( out_cost.qty, 0 ) AS end_period_qty, COALESCE ( in_cost.cost_amount, 0 ) - COALESCE ( out_cost.cost_amount, 0 ) AS end_period_amount, COALESCE ( in_cost.accting_currency_id, out_cost.accting_currency_id ) accting_currency_idFROM ( 替换成2.sql的内容 ) AS in_costFULL OUTER JOIN( SELECT MAX ( KEY ) AS KEY, material_id, uom_id, lot, auxiliary, bom_version_id, warehouse_id, location_id, stk_org_id, owner_type, mto_num, SUM ( qty ) AS qty, CASE WHEN COALESCE ( SUM ( qty ), 0 ) = 0 THEN 0 ELSE SUM ( cost_amount ) / SUM ( qty ) END AS cost_price, SUM ( cost_amount ) AS cost_amount, accting_dimensions_id, accting_currency_id, accting_sys_id, accting_org_id, accting_policy_id FROM ( SELECT CASE WHEN stk.ID IS NOT NULL THEN concat_ws ( &#x27;_&#x27;, stk.material_id, stk.uom_id, COALESCE ( stk.lot, &#x27;null&#x27; ), COALESCE ( stk.auxiliary, &#x27;null&#x27; ), COALESCE ( stk.bom_version_id, 0 ), COALESCE ( stk.warehouse_id, 0 ), COALESCE ( stk.location_id, 0 ), COALESCE ( stk.stk_org_id, 0 ), COALESCE ( &#x27;sys.admin.orgs,&#x27; || CASE WHEN dim.owner_type_value != &#x27;0&#x27; THEN dim.owner_type_value ELSE REPLACE ( stk.ia_owner_type, &#x27;sys.admin.orgs,&#x27;, &#x27;&#x27; ) END, &#x27;null&#x27; ), COALESCE ( stk.mto_num, &#x27;null&#x27; ), ia_out.accting_dimensions_id ) ELSE concat_ws ( &#x27;_&#x27;, ia_out.material_id, mat.uom_id, COALESCE ( inter_doc.lot, &#x27;null&#x27; ), COALESCE ( inter_doc.auxiliary, &#x27;null&#x27; ), COALESCE ( inter_doc.bom_version_id, 0 ), COALESCE ( inter_doc.warehouse_id, 0 ), COALESCE ( inter_doc.location_id, 0 ), COALESCE ( inter_doc.stk_org_id, 0 ), COALESCE ( &#x27;sys.admin.orgs,&#x27; || CASE WHEN dim.owner_type_value != &#x27;0&#x27; THEN dim.owner_type_value ELSE REPLACE ( inter_doc.ia_owner_type, &#x27;sys.admin.orgs,&#x27;, &#x27;&#x27; ) END, &#x27;null&#x27; ), COALESCE ( inter_doc.mto_num, &#x27;null&#x27; ), ia_out.accting_dimensions_id ) END AS KEY, ia_out.material_id, mat.uom_id, COALESCE ( stk.lot, inter_doc.lot ) lot, COALESCE ( stk.auxiliary, inter_doc.auxiliary ) auxiliary, COALESCE ( stk.bom_version_id, inter_doc.bom_version_id ) bom_version_id, COALESCE ( stk.warehouse_id, inter_doc.warehouse_id ) warehouse_id, COALESCE ( stk.location_id, inter_doc.location_id ) location_id, COALESCE ( stk.stk_org_id, inter_doc.stk_org_id ) stk_org_id, &#x27;sys.admin.orgs,&#x27; || CASE WHEN dim.owner_type_value != &#x27;0&#x27; THEN dim.owner_type_value ELSE REPLACE ( COALESCE ( stk.ia_owner_type, inter_doc.ia_owner_type ), &#x27;sys.admin.orgs,&#x27;, &#x27;&#x27; ) END owner_type, COALESCE ( stk.mto_num, inter_doc.mto_num ) mto_num, ia_out.qty, 0 AS cost_price, ia_out.cost_amount, ia_out.accting_dimensions_id, ia_out.accting_currency_id, ia_out.accting_sys_id, ia_out.accting_org_id, ia_out.accting_policy_id FROM ia_out_result ia_out LEFT JOIN ia_accting_dimensions dim ON ia_out.accting_dimensions_id = dim.ID LEFT JOIN stk_tran_detail stk ON stk.src_id = ia_out.doc_line_id AND stk.src_model = ia_out.doc_line_model AND ( CASE WHEN stk.src_model = &#x27;stk.direct.trans.line1&#x27; AND stk.source_line1_model IS NULL THEN stk.qty_option = &#x27;-1&#x27; WHEN stk.src_model = &#x27;stk.direct.trans.line1&#x27; AND stk.source_line1_model IS NOT NULL THEN stk.qty_option = &#x27;1&#x27; WHEN stk.src_model = &#x27;medinv.direct.trans.line1&#x27; THEN stk.qty_option = &#x27;-1&#x27; ELSE TRUE END ) LEFT JOIN ia_inter_transaction inter_doc ON inter_doc.src_id = ia_out.doc_line_id AND inter_doc.src_model = ia_out.doc_line_model LEFT JOIN mdm_material mat ON ia_out.material_id = mat.ID WHERE ia_out.biz_date &gt;= &#x27;2024-08-01&#x27; AND ia_out.biz_date &lt;= &#x27;2024-08-31&#x27; AND ia_out.doc_line_model != &#x27;ia.cost.adjustment.line1&#x27; UNION ALL SELECT concat_ws ( &#x27;_&#x27;, adj.material_id, mat1.uom_id, COALESCE ( adj.lot, &#x27;null&#x27; ), COALESCE ( adj.auxiliary, &#x27;null&#x27; ), COALESCE ( adj.bom_version_id, 0 ), COALESCE ( adj.warehouse_id, 0 ), COALESCE ( adj.location_id, 0 ), COALESCE ( adj.stk_org_id, 0 ), COALESCE ( adj.owner_type, &#x27;null&#x27; ), COALESCE ( adj.mto_number, &#x27;null&#x27; ), ia_out.accting_dimensions_id ) AS KEY, adj.material_id, mat1.uom_id, adj.lot, adj.auxiliary, adj.bom_version_id, adj.warehouse_id, adj.location_id, adj.stk_org_id, adj.owner_type, adj.mto_number, ia_out.qty, 0 AS cost_price, ia_out.cost_amount, ia_out.accting_dimensions_id, ia_out.accting_currency_id, ia_out.accting_sys_id, ia_out.accting_org_id, ia_out.accting_policy_id FROM ia_cost_adjustment_line1 adj LEFT JOIN ia_out_result ia_out ON ia_out.doc_line_id = adj.ID AND ia_out.doc_line_model = &#x27;ia.cost.adjustment.line1&#x27; LEFT JOIN mdm_material mat1 ON adj.material_id = mat1.ID WHERE ia_out.biz_date &gt;= &#x27;2024-08-01&#x27; AND ia_out.biz_date &lt;= &#x27;2024-08-31&#x27; ) AS out_iaGROUP BY material_id, uom_id, lot, auxiliary, bom_version_id, warehouse_id, location_id, stk_org_id, owner_type, mto_num, accting_dimensions_id, accting_currency_id, accting_sys_id, accting_org_id, accting_policy_id ) AS out_cost ON in_cost.KEY = out_cost.KEY AND in_cost.accting_sys_id = out_cost.accting_sys_id AND in_cost.accting_org_id = out_cost.accting_org_id AND in_cost.accting_policy_id = out_cost.accting_policy_idWHERE ( in_cost.accting_sys_id = 1 OR out_cost.accting_sys_id = 1 ) AND ( in_cost.accting_org_id = 1 OR out_cost.accting_org_id = 1 ) AND ( in_cost.accting_policy_id = 1 OR out_cost.accting_policy_id = 1 ) 4.sql12345678910111213141516171819202122232425262728293031323334SELECT COALESCE ( in_out_cost.material_id, balance.material_id ) AS material_id, COALESCE ( in_out_cost.accting_currency_id, balance.local_currency_id ) AS local_currency_id, COALESCE ( in_out_cost.auxiliary, balance.auxiliary ) AS auxiliary, COALESCE ( in_out_cost.lot, balance.lot ) AS lot, COALESCE ( in_out_cost.bom_version_id, balance.bom_version_id ) AS bom_version_id, COALESCE ( in_out_cost.mto_num, balance.mto_num ) AS mto_num, COALESCE ( in_out_cost.owner_type, balance.owner_type ) AS owner_type, COALESCE ( in_out_cost.stk_org_id, balance.stk_org_id ) AS stk_org_id, COALESCE ( in_out_cost.warehouse_id, balance.warehouse_id ) AS warehouse_id, COALESCE ( in_out_cost.location_id, balance.location_id ) AS location_id, COALESCE ( in_out_cost.uom_id, balance.uom_id ) AS uom_id, COALESCE ( in_out_cost.accting_dimensions_id, balance.accting_dimensions_id ) AS accting_dimensions_id, COALESCE ( balance.init_qty, 0 ) + COALESCE ( in_out_cost.end_period_qty, 0 ) AS qty, CASE WHEN round( COALESCE ( balance.init_qty, 0 ) + COALESCE ( in_out_cost.end_period_qty, 0 ) :: NUMERIC, 10) = 0 THEN 0 ELSE (COALESCE ( balance.init_amount, 0 ) + COALESCE ( in_out_cost.end_period_amount, 0 ) ) / (COALESCE ( balance.init_qty, 0 ) + COALESCE ( in_out_cost.end_period_qty, 0 ) ) END AS price, COALESCE ( balance.init_amount, 0 ) + COALESCE ( in_out_cost.end_period_amount, 0 ) AS amountFROM ( 替换成 3.sql的内容 ) in_out_costFULL OUTER JOIN (SELECT *FROM ia_balanceWHERE accting_sys_id = 1 AND accting_org_id = 1 AND accting_policy_id = 1 AND accting_year = &#x27;2024&#x27; AND accting_period = &#x27;08&#x27;) balance ON in_out_cost.stk_ia_dimension = balance.stk_ia_dimension 5.sql1234567891011121314151617181920212223242526272829303132333435363738SELECT MAX( mat.NUMBER ) material_number, MAX ( mat.NAME ) material_name, MAX ( mat.specification ) specification, MAX ( end_period.auxiliary ) auxiliary, MAX ( end_period.lot ) lot, MAX ( b1.version_number ) bom_version_id, MAX ( end_period.mto_num ) mto_num, MAX ( o1.NAME ) owner_type, MAX ( o2.NAME ) stk_org_id, MAX ( w1.NAME ) warehouse_id, MAX ( u1.NAME ) uom_name, MAX ( end_period.uom_id ) uom_id, MAX ( end_period.local_currency_id ) local_currency_id, SUM ( end_period.qty ) qty, CASE WHEN round( COALESCE ( SUM ( end_period.qty ), 0 ) :: NUMERIC, 10 ) = 0 THEN 0 ELSE COALESCE ( SUM ( end_period.amount ), 0 ) / SUM ( end_period.qty ) END AS price, SUM ( end_period.amount ) amountFROM ( 替换成 4.sql的内容 ) end_periodLEFT JOIN ia_accting_dimensions dimension ON end_period.accting_dimensions_id = dimension.IDLEFT JOIN mdm_material mat ON end_period.material_id = mat.ID AND mat.master_id = dimension.material_masterid_valueLEFT JOIN sys_admin_orgs o1 ON CAST ( o1.ID AS VARCHAR ) = dimension.owner_type_valueLEFT JOIN mdm_product_bom b1 ON CAST ( b1.ID AS VARCHAR ) = dimension.bom_version_id_valueLEFT JOIN sys_admin_orgs o2 ON CAST ( o2.ID AS VARCHAR ) = dimension.stk_org_id_valueLEFT JOIN mdm_warehouse w1 ON CAST ( w1.ID AS VARCHAR ) = dimension.warehouse_id_valueLEFT JOIN mdm_unit u1 ON u1.ID = end_period.uom_idGROUP BY dimension.IDHAVING ( SUM ( end_period.qty ) &lt;= 0 OR SUM ( end_period.amount ) &lt;= 0 ) AND NOT (SUM ( end_period.qty ) = 0 AND SUM ( end_period.amount ) = 0)","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"医药公司ERP","slug":"项目/医药公司ERP","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/"},{"name":"业务","slug":"项目/医药公司ERP/业务","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/%E4%B8%9A%E5%8A%A1/"}],"tags":[]},{"title":"爬虫运行框架","slug":"爬虫/基础/021-爬虫运行框架","date":"2023-08-21T14:04:52.000Z","updated":"2025-04-16T09:12:12.212Z","comments":true,"path":"2023/08/21/爬虫/基础/021-爬虫运行框架/","link":"","permalink":"https://dbbruce.github.io/2023/08/21/%E7%88%AC%E8%99%AB/%E5%9F%BA%E7%A1%80/021-%E7%88%AC%E8%99%AB%E8%BF%90%E8%A1%8C%E6%A1%86%E6%9E%B6/","excerpt":"运行框架","text":"运行框架 URL管理器：待抓取URL，已抓取URL，处理循环抓取，处理xuanh 1、URL管理器实现方式 网络下载器，将网页下载到本地，输入URL，输出html代码网页解析器，输入html代码，输出需要的数据 1、正则表达式 - 模糊匹配 2、html.parser - 结构化解析 3、BeautifulSoup - 结构化解析 4、lxml - 结构化解析 1、结构化解析将网页解析成DOM树，Document object model BS4语法1、html元素解析为3部分：1、节点名称2、节点属性3、节点内容 2、语法2.1、解析html字符串 - BeautifulSoup html_doc html字符串 html.parser 解析器 from_encoding 指定编码12from bs4 import BeautifulSoupsoup = BeautifulSoup(html_doc, &#x27;html.parser&#x27;, from_encoding=&#x27;utf-8&#x27;) 2.2、生成一个bs4对象 - find_all、findnode &#x3D; soup.find_all(节点名称，节点属性，节点内容)node &#x3D; soup.find_all(‘a’, href&#x3D;re.compile(r’^&#x2F;view&#x2F;\\d+.html’), text&#x3D;re.compile(‘新闻’)) 注意class，因为class为Python关键字，在bs4中作为属性名，需要加下划线soup.find_all(‘a’, class_&#x3D;’abc’, text&#x3D;re.compile(‘新闻’)) 2.3、获取内容 标签名称node.name 标签href属性node.[‘href’] 标签文字内容node.get_text() socket","categories":[{"name":"爬虫类","slug":"爬虫类","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/"},{"name":"基础","slug":"爬虫类/基础","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"015-scrapy下载图片文件","slug":"爬虫/基础/015-scrapy下载图片文件","date":"2023-08-21T08:04:52.000Z","updated":"2024-06-01T02:02:27.000Z","comments":true,"path":"2023/08/21/爬虫/基础/015-scrapy下载图片文件/","link":"","permalink":"https://dbbruce.github.io/2023/08/21/%E7%88%AC%E8%99%AB/%E5%9F%BA%E7%A1%80/015-scrapy%E4%B8%8B%E8%BD%BD%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6/","excerpt":"Scrapy提供了一个item pipeline，来下载属于某个特定项目的图片123456避免重新下载最近已经下载过的文件可以方下便的指定文件存储路径可以将下载的图片转换成通用的图片格式(JPG等)可以方便 的生成缩略图可以方便 的检测图片的宽和高，确保他们满足最小限制异步下载，效率非常高","text":"Scrapy提供了一个item pipeline，来下载属于某个特定项目的图片123456避免重新下载最近已经下载过的文件可以方下便的指定文件存储路径可以将下载的图片转换成通用的图片格式(JPG等)可以方便 的生成缩略图可以方便 的检测图片的宽和高，确保他们满足最小限制异步下载，效率非常高 ImagesPipeline 默认2个字段，image_urls 填写url；images获取图形信息 123使用ImagesPipeline与使用FilesPipeline非常相似，只是使用的默认字段名不同：您使用image_urls作为项目的图像URL，它将填充一个images字段以获取有关下载图像的信息。 1234定义一个item,上面有两个字段，一个 是image_urls，-个是images。image urls用来存储图片的链接，images是由开发者把数据爬取下来后添加的使用scrapy.pipelines.images.lmagesPipeline来作为数据保存的pipeline在settings.py中设置IMAGES STORE来定义图片下载的路径如果想要有更复杂的图片保存的路径，可以重写ImagePipeline的file_path方法这个方法用来返回每个图片的保存路径 Scrapy提供了一个item pipeline，来下载属于某个特定项目的图片123456·避免重新下载最近已经下载过的文件·可以方下便的指定文件存储路径·可以将下载的图片转换成通用的图片格式(JPG等)·可以方便 的生成缩略图·可以方便 的检测图片的宽和高，确保他们满足最小限制·异步下载，效率非常高 项目设置1234567891011# settings# 开启ImagesPipelinefrom scrapy.pipelines.images import ImagesPipelineITEM_PIPELINES = &#123; # &quot;zcool.pipelines.ZcoolPipeline&quot;: 300, &#x27;scrapy.pipelines.images.ImagesPipeline&#x27;: 300,&#125;# 设置存储路径IMAGES_STORE = &quot;./pic&quot; 123456789# items.pyimport scrapyclass ZcoolItem(scrapy.Item): image_urls = scrapy.Field() title = scrapy.Field() images = scrapy.Field() 123456789101112131415161718192021222324252627# zcoolspider.pyimport scrapyfrom scrapy.linkextractors import LinkExtractorfrom scrapy.spiders import CrawlSpider, Rulefrom ..items import ZcoolItemclass ZcoolspiderSpider(CrawlSpider): name = &quot;zcoolspider&quot; allowed_domains = [&quot;zcool.com.cn&quot;] start_urls = [&quot;https://www.zcool.com.cn/?page=1#tab_anchor&quot;] rules = ( Rule(LinkExtractor(allow=r&quot;/?page=\\d+#tab_ancho&quot;), follow=True), Rule(LinkExtractor(allow=r&quot;/work/.+=.html&quot;), callback=&#x27;parse_item&#x27;, follow=False), ) def parse_item(self, response): img_urls = response.xpath(&#x27;//div[contains(@class,&quot;imgbox&quot;)]//img/@src&#x27;).getall() title_lst = response.xpath(&#x27;//h1/text()&#x27;).getall() title = &#x27;&#x27;.join(title_lst).strip() # image_urls必须叫这个名字 item = ZcoolItem(image_urls=img_urls, title=title) yield item 123456789101112131415161718192021222324# pipelines.pyimport osfrom zcool import settingsfrom scrapy.pipelines.images import ImagesPipelinefrom scrapy import Requestclass ZcoolPipeline: def get_media_requests(self, item, info): # 获取图片连接请求添加一个item属性 image_requests = super().get_media_requests(item, info) # 对每一个图片连接请求都添加一个item属性 for img_req in image_requests: img_req.item=item return image_requests # 重写这个方法，改变存储路径 def file_path(self, request, response=None, info=None, *, item=None): old_path = super().file_path(request, response, info) # 获取图片title title=request.item[&#x27;title&#x27;] save_path=os.path.join(settings.IMAGES_STORE, title) image_name = old_path.replace(&#x27;full/&#x27;, &#x27;&#x27;) return os.path.join(save_path, image_name) 123456789# settings.py# 重写imagepipeline方法后，就可以用默认的pipelinefrom scrapy.pipelines.images import ImagesPipelineITEM_PIPELINES = &#123; &quot;zcool.pipelines.ZcoolPipeline&quot;: 300, # &#x27;scrapy.pipelines.images.ImagesPipeline&#x27;: 300,&#125;","categories":[{"name":"爬虫类","slug":"爬虫类","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/"},{"name":"基础","slug":"爬虫类/基础","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"异常余额汇总表","slug":"项目/医药公司ERP/20230820","date":"2023-08-20T14:14:52.000Z","updated":"2024-11-29T02:15:38.615Z","comments":true,"path":"2023/08/20/项目/医药公司ERP/20230820/","link":"","permalink":"https://dbbruce.github.io/2023/08/20/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/20230820/","excerpt":"1、超级复杂SQL（SQL套娃） 1.sql","text":"1、超级复杂SQL（SQL套娃） 1.sql 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128SELECT CASE WHEN stk.ID IS NOT NULL THEN concat_ws( &#x27;_&#x27;, stk.material_id, stk.uom_id, COALESCE(stk.lot, &#x27;null&#x27;), COALESCE(stk.auxiliary, &#x27;null&#x27;), COALESCE(stk.bom_version_id, 0), COALESCE(stk.warehouse_id, 0), COALESCE(stk.location_id, 0), COALESCE(stk.stk_org_id, 0), COALESCE(&#x27;sys.admin.orgs,&#x27; || CASE WHEN dim.owner_type_value != &#x27;0&#x27; THEN dim.owner_type_value ELSE REPLACE(stk.ia_owner_type, &#x27;sys.admin.orgs,&#x27;, &#x27;&#x27;) END, &#x27;null&#x27; ), COALESCE(stk.mto_num, &#x27;null&#x27;), ia_in.accting_dimensions_id ) ELSE concat_ws( &#x27;_&#x27;, ia_in.material_id, mat.uom_id, COALESCE(inter_doc.lot, &#x27;null&#x27;), COALESCE(inter_doc.auxiliary, &#x27;null&#x27;), COALESCE(inter_doc.bom_version_id, 0), COALESCE(inter_doc.warehouse_id, 0), COALESCE(inter_doc.location_id, 0), COALESCE(inter_doc.stk_org_id, 0), COALESCE(&#x27;sys.admin.orgs,&#x27; || CASE WHEN dim.owner_type_value != &#x27;0&#x27; THEN dim.owner_type_value ELSE REPLACE(inter_doc.ia_owner_type, &#x27;sys.admin.orgs,&#x27;, &#x27;&#x27;) END, &#x27;null&#x27; ), COALESCE(inter_doc.mto_num, &#x27;null&#x27;), ia_in.accting_dimensions_id ) END AS KEY, ia_in.material_id, mat.uom_id, COALESCE ( stk.lot, inter_doc.lot ) lot, COALESCE ( stk.auxiliary, inter_doc.auxiliary ) auxiliary, COALESCE ( stk.bom_version_id, inter_doc.bom_version_id ) bom_version_id, COALESCE ( stk.warehouse_id, inter_doc.warehouse_id ) warehouse_id, COALESCE ( stk.location_id, inter_doc.location_id ) location_id, COALESCE ( stk.stk_org_id, inter_doc.stk_org_id ) stk_org_id, &#x27;sys.admin.orgs,&#x27; || case when dim.owner_type_value != &#x27;0&#x27; then dim.owner_type_value else replace(COALESCE(stk.ia_owner_type, inter_doc.ia_owner_type),&#x27;sys.admin.orgs,&#x27;,&#x27;&#x27;) end owner_type, COALESCE ( stk.mto_num, inter_doc.mto_num ) mto_num, ia_in.qty, 0 AS cost_price, ia_in.cost_amount, ia_in.accting_dimensions_id, ia_in.accting_currency_id, ia_in.accting_sys_id, ia_in.accting_org_id, ia_in.accting_policy_idFROM ia_in_result ia_in LEFT JOIN ia_accting_dimensions dim ON ia_in.accting_dimensions_id = dim.ID LEFT JOIN stk_tran_detail stk ON stk.src_id = ia_in.doc_line_id -- 库存台账明细表 AND stk.src_model = ia_in.doc_line_model AND ( CASE -- 直接调拨单 src_model 单据模型名， source_line1_model line1模型名 WHEN stk.src_model = &#x27;stk.direct.trans.line1&#x27; AND stk.source_line1_model IS NULL THEN stk.qty_option = &#x27;1&#x27; WHEN stk.src_model = &#x27;stk.direct.trans.line1&#x27; AND stk.source_line1_model IS NOT NULL THEN stk.qty_option = &#x27;-1&#x27; -- 手工移库单 WHEN stk.src_model = &#x27;medinv.direct.trans.line1&#x27; THEN stk.qty_option = &#x27;1&#x27; ELSE TRUE END ) LEFT JOIN ia_inter_transaction inter_doc ON inter_doc.src_id = ia_in.doc_line_id AND inter_doc.src_model = ia_in.doc_line_model LEFT JOIN mdm_material mat ON ia_in.material_id = mat.IDWHERE ia_in.biz_date &gt;= &#x27;2024-08-01&#x27; AND ia_in.biz_date &lt;= &#x27;2024-08-31&#x27; AND ia_in.doc_line_model != &#x27;ia.cost.adjustment.line1&#x27;UNION ALLSELECT concat_ws( &#x27;_&#x27;, adj.material_id, mat1.uom_id, COALESCE(adj.lot, &#x27;null&#x27;), COALESCE(adj.auxiliary, &#x27;null&#x27;), COALESCE(adj.bom_version_id, 0), COALESCE(adj.warehouse_id, 0), COALESCE(adj.location_id, 0), COALESCE(adj.stk_org_id, 0), COALESCE(adj.owner_type, &#x27;null&#x27;), COALESCE(adj.mto_number, &#x27;null&#x27;), ia_in.accting_dimensions_id ) AS KEY, adj.material_id, mat1.uom_id, adj.lot, adj.auxiliary, adj.bom_version_id, adj.warehouse_id, adj.location_id, adj.stk_org_id, adj.owner_type, adj.mto_number, ia_in.qty, 0 AS cost_price, ia_in.cost_amount, ia_in.accting_dimensions_id, ia_in.accting_currency_id, ia_in.accting_sys_id, ia_in.accting_org_id, ia_in.accting_policy_idFROM ia_cost_adjustment_line1 adj JOIN ia_in_result ia_in ON ia_in.doc_line_id = adj.ID AND ia_in.doc_line_model = &#x27;ia.cost.adjustment.line1&#x27; LEFT JOIN mdm_material mat1 ON adj.material_id = mat1.IDWHERE ia_in.biz_date &gt;= &#x27;2024-08-01&#x27; AND ia_in.biz_date &lt;= &#x27;2024-08-31&#x27; 2.sql 12345678910111213141516171819202122232425262728293031323334353637383940414243-- 将1.sql 查出的结果，group by分组SELECT MAX( KEY ) AS KEY, material_id, uom_id, lot, auxiliary, bom_version_id, warehouse_id, location_id, stk_org_id, owner_type, mto_num, SUM ( qty ) AS qty, CASE WHEN COALESCE ( SUM ( qty ), 0 ) = 0 THEN 0 ELSE SUM ( cost_amount ) / SUM ( qty ) END AS cost_price, SUM ( cost_amount ) AS cost_amount, accting_dimensions_id, accting_currency_id, accting_sys_id, accting_org_id, accting_policy_idFROM ( 替换成1.sql的内容 ) AS in_iaGROUP BY material_id, uom_id, lot, auxiliary, bom_version_id, warehouse_id, location_id, stk_org_id, owner_type, mto_num, accting_dimensions_id, accting_currency_id, accting_sys_id, accting_org_id, accting_policy_id 3.sql 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220SELECT CASE WHEN in_cost.accting_sys_id IS NOT NULL THEN concat_ws ( &#x27;_&#x27;, in_cost.accting_sys_id, in_cost.accting_org_id, in_cost.accting_policy_id, 2024, 08, in_cost.KEY ) ELSE concat_ws ( &#x27;_&#x27;, out_cost.accting_sys_id, out_cost.accting_org_id, out_cost.accting_policy_id, 2024, 08, out_cost.KEY ) END stk_ia_dimension, COALESCE ( in_cost.material_id, out_cost.material_id ) material_id, COALESCE ( in_cost.uom_id, out_cost.uom_id ) uom_id, COALESCE ( in_cost.lot, out_cost.lot ) lot, COALESCE ( in_cost.auxiliary, out_cost.auxiliary ) auxiliary, COALESCE ( in_cost.bom_version_id, out_cost.bom_version_id ) bom_version_id, COALESCE ( in_cost.warehouse_id, out_cost.warehouse_id ) warehouse_id, COALESCE ( in_cost.location_id, out_cost.location_id ) location_id, COALESCE ( in_cost.stk_org_id, out_cost.stk_org_id ) stk_org_id, COALESCE ( in_cost.owner_type, out_cost.owner_type ) owner_type, COALESCE ( in_cost.mto_num, out_cost.mto_num ) mto_num, COALESCE ( in_cost.accting_dimensions_id, out_cost.accting_dimensions_id ) accting_dimensions_id, COALESCE ( in_cost.qty, 0 ) - COALESCE ( out_cost.qty, 0 ) AS end_period_qty, COALESCE ( in_cost.cost_amount, 0 ) - COALESCE ( out_cost.cost_amount, 0 ) AS end_period_amount, COALESCE ( in_cost.accting_currency_id, out_cost.accting_currency_id ) accting_currency_idFROM ( 替换成2.sql的内容 ) AS in_costFULL OUTER JOIN( SELECT MAX ( KEY ) AS KEY, material_id, uom_id, lot, auxiliary, bom_version_id, warehouse_id, location_id, stk_org_id, owner_type, mto_num, SUM ( qty ) AS qty, CASE WHEN COALESCE ( SUM ( qty ), 0 ) = 0 THEN 0 ELSE SUM ( cost_amount ) / SUM ( qty ) END AS cost_price, SUM ( cost_amount ) AS cost_amount, accting_dimensions_id, accting_currency_id, accting_sys_id, accting_org_id, accting_policy_id FROM ( SELECT CASE WHEN stk.ID IS NOT NULL THEN concat_ws ( &#x27;_&#x27;, stk.material_id, stk.uom_id, COALESCE ( stk.lot, &#x27;null&#x27; ), COALESCE ( stk.auxiliary, &#x27;null&#x27; ), COALESCE ( stk.bom_version_id, 0 ), COALESCE ( stk.warehouse_id, 0 ), COALESCE ( stk.location_id, 0 ), COALESCE ( stk.stk_org_id, 0 ), COALESCE ( &#x27;sys.admin.orgs,&#x27; || CASE WHEN dim.owner_type_value != &#x27;0&#x27; THEN dim.owner_type_value ELSE REPLACE ( stk.ia_owner_type, &#x27;sys.admin.orgs,&#x27;, &#x27;&#x27; ) END, &#x27;null&#x27; ), COALESCE ( stk.mto_num, &#x27;null&#x27; ), ia_out.accting_dimensions_id ) ELSE concat_ws ( &#x27;_&#x27;, ia_out.material_id, mat.uom_id, COALESCE ( inter_doc.lot, &#x27;null&#x27; ), COALESCE ( inter_doc.auxiliary, &#x27;null&#x27; ), COALESCE ( inter_doc.bom_version_id, 0 ), COALESCE ( inter_doc.warehouse_id, 0 ), COALESCE ( inter_doc.location_id, 0 ), COALESCE ( inter_doc.stk_org_id, 0 ), COALESCE ( &#x27;sys.admin.orgs,&#x27; || CASE WHEN dim.owner_type_value != &#x27;0&#x27; THEN dim.owner_type_value ELSE REPLACE ( inter_doc.ia_owner_type, &#x27;sys.admin.orgs,&#x27;, &#x27;&#x27; ) END, &#x27;null&#x27; ), COALESCE ( inter_doc.mto_num, &#x27;null&#x27; ), ia_out.accting_dimensions_id ) END AS KEY, ia_out.material_id, mat.uom_id, COALESCE ( stk.lot, inter_doc.lot ) lot, COALESCE ( stk.auxiliary, inter_doc.auxiliary ) auxiliary, COALESCE ( stk.bom_version_id, inter_doc.bom_version_id ) bom_version_id, COALESCE ( stk.warehouse_id, inter_doc.warehouse_id ) warehouse_id, COALESCE ( stk.location_id, inter_doc.location_id ) location_id, COALESCE ( stk.stk_org_id, inter_doc.stk_org_id ) stk_org_id, &#x27;sys.admin.orgs,&#x27; || CASE WHEN dim.owner_type_value != &#x27;0&#x27; THEN dim.owner_type_value ELSE REPLACE ( COALESCE ( stk.ia_owner_type, inter_doc.ia_owner_type ), &#x27;sys.admin.orgs,&#x27;, &#x27;&#x27; ) END owner_type, COALESCE ( stk.mto_num, inter_doc.mto_num ) mto_num, ia_out.qty, 0 AS cost_price, ia_out.cost_amount, ia_out.accting_dimensions_id, ia_out.accting_currency_id, ia_out.accting_sys_id, ia_out.accting_org_id, ia_out.accting_policy_id FROM ia_out_result ia_out LEFT JOIN ia_accting_dimensions dim ON ia_out.accting_dimensions_id = dim.ID LEFT JOIN stk_tran_detail stk ON stk.src_id = ia_out.doc_line_id AND stk.src_model = ia_out.doc_line_model AND ( CASE WHEN stk.src_model = &#x27;stk.direct.trans.line1&#x27; AND stk.source_line1_model IS NULL THEN stk.qty_option = &#x27;-1&#x27; WHEN stk.src_model = &#x27;stk.direct.trans.line1&#x27; AND stk.source_line1_model IS NOT NULL THEN stk.qty_option = &#x27;1&#x27; WHEN stk.src_model = &#x27;medinv.direct.trans.line1&#x27; THEN stk.qty_option = &#x27;-1&#x27; ELSE TRUE END ) LEFT JOIN ia_inter_transaction inter_doc ON inter_doc.src_id = ia_out.doc_line_id AND inter_doc.src_model = ia_out.doc_line_model LEFT JOIN mdm_material mat ON ia_out.material_id = mat.ID WHERE ia_out.biz_date &gt;= &#x27;2024-08-01&#x27; AND ia_out.biz_date &lt;= &#x27;2024-08-31&#x27; AND ia_out.doc_line_model != &#x27;ia.cost.adjustment.line1&#x27; UNION ALL SELECT concat_ws ( &#x27;_&#x27;, adj.material_id, mat1.uom_id, COALESCE ( adj.lot, &#x27;null&#x27; ), COALESCE ( adj.auxiliary, &#x27;null&#x27; ), COALESCE ( adj.bom_version_id, 0 ), COALESCE ( adj.warehouse_id, 0 ), COALESCE ( adj.location_id, 0 ), COALESCE ( adj.stk_org_id, 0 ), COALESCE ( adj.owner_type, &#x27;null&#x27; ), COALESCE ( adj.mto_number, &#x27;null&#x27; ), ia_out.accting_dimensions_id ) AS KEY, adj.material_id, mat1.uom_id, adj.lot, adj.auxiliary, adj.bom_version_id, adj.warehouse_id, adj.location_id, adj.stk_org_id, adj.owner_type, adj.mto_number, ia_out.qty, 0 AS cost_price, ia_out.cost_amount, ia_out.accting_dimensions_id, ia_out.accting_currency_id, ia_out.accting_sys_id, ia_out.accting_org_id, ia_out.accting_policy_id FROM ia_cost_adjustment_line1 adj LEFT JOIN ia_out_result ia_out ON ia_out.doc_line_id = adj.ID AND ia_out.doc_line_model = &#x27;ia.cost.adjustment.line1&#x27; LEFT JOIN mdm_material mat1 ON adj.material_id = mat1.ID WHERE ia_out.biz_date &gt;= &#x27;2024-08-01&#x27; AND ia_out.biz_date &lt;= &#x27;2024-08-31&#x27; ) AS out_iaGROUP BY material_id, uom_id, lot, auxiliary, bom_version_id, warehouse_id, location_id, stk_org_id, owner_type, mto_num, accting_dimensions_id, accting_currency_id, accting_sys_id, accting_org_id, accting_policy_id ) AS out_cost ON in_cost.KEY = out_cost.KEY AND in_cost.accting_sys_id = out_cost.accting_sys_id AND in_cost.accting_org_id = out_cost.accting_org_id AND in_cost.accting_policy_id = out_cost.accting_policy_idWHERE ( in_cost.accting_sys_id = 1 OR out_cost.accting_sys_id = 1 ) AND ( in_cost.accting_org_id = 1 OR out_cost.accting_org_id = 1 ) AND ( in_cost.accting_policy_id = 1 OR out_cost.accting_policy_id = 1 ) 4.sql12345678910111213141516171819202122232425262728293031323334SELECT COALESCE ( in_out_cost.material_id, balance.material_id ) AS material_id, COALESCE ( in_out_cost.accting_currency_id, balance.local_currency_id ) AS local_currency_id, COALESCE ( in_out_cost.auxiliary, balance.auxiliary ) AS auxiliary, COALESCE ( in_out_cost.lot, balance.lot ) AS lot, COALESCE ( in_out_cost.bom_version_id, balance.bom_version_id ) AS bom_version_id, COALESCE ( in_out_cost.mto_num, balance.mto_num ) AS mto_num, COALESCE ( in_out_cost.owner_type, balance.owner_type ) AS owner_type, COALESCE ( in_out_cost.stk_org_id, balance.stk_org_id ) AS stk_org_id, COALESCE ( in_out_cost.warehouse_id, balance.warehouse_id ) AS warehouse_id, COALESCE ( in_out_cost.location_id, balance.location_id ) AS location_id, COALESCE ( in_out_cost.uom_id, balance.uom_id ) AS uom_id, COALESCE ( in_out_cost.accting_dimensions_id, balance.accting_dimensions_id ) AS accting_dimensions_id, COALESCE ( balance.init_qty, 0 ) + COALESCE ( in_out_cost.end_period_qty, 0 ) AS qty, CASE WHEN round( COALESCE ( balance.init_qty, 0 ) + COALESCE ( in_out_cost.end_period_qty, 0 ) :: NUMERIC, 10) = 0 THEN 0 ELSE (COALESCE ( balance.init_amount, 0 ) + COALESCE ( in_out_cost.end_period_amount, 0 ) ) / (COALESCE ( balance.init_qty, 0 ) + COALESCE ( in_out_cost.end_period_qty, 0 ) ) END AS price, COALESCE ( balance.init_amount, 0 ) + COALESCE ( in_out_cost.end_period_amount, 0 ) AS amountFROM ( 替换成 3.sql的内容 ) in_out_costFULL OUTER JOIN (SELECT *FROM ia_balanceWHERE accting_sys_id = 1 AND accting_org_id = 1 AND accting_policy_id = 1 AND accting_year = &#x27;2024&#x27; AND accting_period = &#x27;08&#x27;) balance ON in_out_cost.stk_ia_dimension = balance.stk_ia_dimension 5.sql1234567891011121314151617181920212223242526272829303132333435363738SELECT MAX( mat.NUMBER ) material_number, MAX ( mat.NAME ) material_name, MAX ( mat.specification ) specification, MAX ( end_period.auxiliary ) auxiliary, MAX ( end_period.lot ) lot, MAX ( b1.version_number ) bom_version_id, MAX ( end_period.mto_num ) mto_num, MAX ( o1.NAME ) owner_type, MAX ( o2.NAME ) stk_org_id, MAX ( w1.NAME ) warehouse_id, MAX ( u1.NAME ) uom_name, MAX ( end_period.uom_id ) uom_id, MAX ( end_period.local_currency_id ) local_currency_id, SUM ( end_period.qty ) qty, CASE WHEN round( COALESCE ( SUM ( end_period.qty ), 0 ) :: NUMERIC, 10 ) = 0 THEN 0 ELSE COALESCE ( SUM ( end_period.amount ), 0 ) / SUM ( end_period.qty ) END AS price, SUM ( end_period.amount ) amountFROM ( 替换成 4.sql的内容 ) end_periodLEFT JOIN ia_accting_dimensions dimension ON end_period.accting_dimensions_id = dimension.IDLEFT JOIN mdm_material mat ON end_period.material_id = mat.ID AND mat.master_id = dimension.material_masterid_valueLEFT JOIN sys_admin_orgs o1 ON CAST ( o1.ID AS VARCHAR ) = dimension.owner_type_valueLEFT JOIN mdm_product_bom b1 ON CAST ( b1.ID AS VARCHAR ) = dimension.bom_version_id_valueLEFT JOIN sys_admin_orgs o2 ON CAST ( o2.ID AS VARCHAR ) = dimension.stk_org_id_valueLEFT JOIN mdm_warehouse w1 ON CAST ( w1.ID AS VARCHAR ) = dimension.warehouse_id_valueLEFT JOIN mdm_unit u1 ON u1.ID = end_period.uom_idGROUP BY dimension.IDHAVING ( SUM ( end_period.qty ) &lt;= 0 OR SUM ( end_period.amount ) &lt;= 0 ) AND NOT (SUM ( end_period.qty ) = 0 AND SUM ( end_period.amount ) = 0)","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"医药公司ERP","slug":"项目/医药公司ERP","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/"},{"name":"业务","slug":"项目/医药公司ERP/业务","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/%E4%B8%9A%E5%8A%A1/"}],"tags":[]},{"title":"phantomjs与selenium的使用","slug":"爬虫/基础/020-phantomjs与selenium的使用","date":"2023-08-20T14:04:52.000Z","updated":"2025-04-16T05:36:39.487Z","comments":true,"path":"2023/08/20/爬虫/基础/020-phantomjs与selenium的使用/","link":"","permalink":"https://dbbruce.github.io/2023/08/20/%E7%88%AC%E8%99%AB/%E5%9F%BA%E7%A1%80/020-phantomjs%E4%B8%8Eselenium%E7%9A%84%E4%BD%BF%E7%94%A8/","excerpt":"Phantomjs 安装 下载地址：https://phantomjs.org/download.html mac 安装： 解压文件下载好之后，解压文件，将解压后的目录移动到应用的目录中：","text":"Phantomjs 安装 下载地址：https://phantomjs.org/download.html mac 安装： 解压文件下载好之后，解压文件，将解压后的目录移动到应用的目录中： 配置环境变量zsh1234dbbruce@dbburce ~ % vim ~/.bash_profile# phantomjsexport PATH=$&#123;PATH&#125;:/Applications/phantomjs-2.1.1-macosx/bin bash1234dbbruce@dbburce ~ % cat ~/.zshrc# phantomjsexport PATH=$&#123;PATH&#125;:/Applications/phantomjs-2.1.1-macosx/bin 生效配置123source ~/.bash_profile source ~/.zshrc 测试1phantomjs --version","categories":[{"name":"爬虫类","slug":"爬虫类","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/"},{"name":"基础","slug":"爬虫类/基础","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"020-scrapy与selenium的使用","slug":"爬虫/基础/020-scrapy与selenium的使用","date":"2023-08-20T14:04:52.000Z","updated":"2024-06-03T13:34:41.000Z","comments":true,"path":"2023/08/20/爬虫/基础/020-scrapy与selenium的使用/","link":"","permalink":"https://dbbruce.github.io/2023/08/20/%E7%88%AC%E8%99%AB/%E5%9F%BA%E7%A1%80/020-scrapy%E4%B8%8Eselenium%E7%9A%84%E4%BD%BF%E7%94%A8/","excerpt":"","text":"","categories":[{"name":"爬虫类","slug":"爬虫类","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/"},{"name":"基础","slug":"爬虫类/基础","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"019-selenium的使用","slug":"爬虫/基础/019-selenium的使用","date":"2023-08-20T13:50:52.000Z","updated":"2024-06-07T09:13:51.000Z","comments":true,"path":"2023/08/20/爬虫/基础/019-selenium的使用/","link":"","permalink":"https://dbbruce.github.io/2023/08/20/%E7%88%AC%E8%99%AB/%E5%9F%BA%E7%A1%80/019-selenium%E7%9A%84%E4%BD%BF%E7%94%A8/","excerpt":"mac安装selenium pip install selenium","text":"mac安装selenium pip install selenium 安装chromedriver注意ChromeDriver版本号： webdriver下载地址： https://getwebdriver.com/chromedriver 添加环境变量 1234vim ~/.zshrc# selenium webdirverexport PATH=$&#123;PATH&#125;:/Users/dbbruce/workspace/seleniumdriver 123echo $path/usr/local/opt/protobuf@3/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/Applications/VMware Fusion.app/Contents/Public:/usr/local/go/bin:/usr/local/aria2/bin:/Library/Apple/usr/bin:/Users/dbbruce/workspace/seleniumdriver:/usr/local/mysql/bin 1234567891011121314151617181920212223import timefrom selenium import webdriverfrom selenium.webdriver.common.by import Byoptions = webdriver.ChromeOptions()options.add_experimental_option(&quot;detach&quot;, True)driver = webdriver.Chrome(options=options)driver.get(&quot;http://baidu.com&quot;)# 截图driver.save_screenshot(&#x27;baidu.png&#x27;)# 获取html源码html = driver.page_sourceprint(html)# id查找，输入内容input_tag = driver.find_element(By.ID, &quot;kw&quot;)input_tag.send_keys(&#x27;python&#x27;)time.sleep(5000)# 关闭当前页driver.close()# 退出浏览器driver.quit() selenium的基本使用-定位元素 find_element()获取满足条件的第一个元素 find_elements()获取满足条件的所有元素 浏览器选项12options = webdriver.ChromeOptions()driver = webdriver.Chrome(options=options) 页面加载策略(pageLoadStrategy) 如果由于下载对自动化不重要的资源(例如, 图像、css、js) 而需要很长时间才能加载页面, 您可以将默认参数normal更改为 eager 或 none 以加快会话加载速度. 此值适用于整个会话, 因此请确保您的 等待策略 足够普适. 策略 就绪状态 备注 normal complete 默认值, 等待所有资源下载 eager interactive DOM 访问已准备就绪, 但诸如图像的其他资源可能仍在加载 none Any 完全不会阻塞 WebDriver 12options.page_load_strategy = &#x27;normal&#x27;driver = webdriver.Chrome(options=options) platformName 这标识了远端的操作系统, 获取 platformName 将返回操作系统的名称. acceptInsecureCerts 此功能检查在会话期间导航时 是否使用了过期的 (或) 无效的 TLS Certificate .如果将功能设置为 false, 则页面浏览遇到任何域证书问题时, 将返回insecure certificate error . 如果设置为 true, 则浏览器将信任无效证书. 1options.accept_insecure_certs = True timeouts指定在当前浏览上下文中, 中断正在执行脚本的时机. WebDriver创建新会话时, 将设置默认的超时时间为 30,000 . 1options.timeouts = 3000000 add_argument args参数用于启动浏览器时要使用的命令行开关列表Chromium命令行开关列表: https://peter.sh/experiments/chromium-command-line-switches/ 1options.add_argument(&quot;--start-maximized&quot;) binary_location 从指定位置启动浏览器 1options.binary_location = chrome_bin 文件上传123file_input = driver.find_element(By.CSS_SELECTOR, &quot;input[type=&#x27;file&#x27;]&quot;)file_input.send_keys(upload_file)driver.find_element(By.ID, &quot;file-submit&quot;).click() 查询网络元素1234567891011&lt;ol id=&quot;vegetables&quot;&gt; &lt;li class=&quot;potatoes&quot;&gt;… &lt;li class=&quot;onions&quot;&gt;… &lt;li class=&quot;tomatoes&quot;&gt;&lt;span&gt;Tomato is a Vegetable&lt;/span&gt;…&lt;/ol&gt;&lt;ul id=&quot;fruits&quot;&gt; &lt;li class=&quot;bananas&quot;&gt;… &lt;li class=&quot;apples&quot;&gt;… &lt;li class=&quot;tomatoes&quot;&gt;&lt;span&gt;Tomato is a Fruit&lt;/span&gt;…&lt;/ul&gt; 1234567891011121314151617181920from selenium.webdriver.common.by import Byfruits = driver.find_element(By.ID, &quot;fruits&quot;)fruit = fruits.find_element(By.CLASS_NAME,&quot;tomatoes&quot;)# 查找fruits元素下的tomatoesfruit = driver.find_element(By.CSS_SELECTOR,&quot;#fruits .tomatoes&quot;)plants = driver.find_elements(By.TAG_NAME, &quot;li&quot;)fruit = driver.find_element(By.CSS_SELECTOR,&quot;#fruits .tomatoes&quot;)elements = element.find_elements(By.TAG_NAME, &#x27;p&#x27;)for e in elements: print(e.text)attr = driver.switch_to.active_element.get_attribute(&quot;title&quot;)print(attr) 点击1driver.find_element(By.NAME, &quot;color_input&quot;).click() 发送键位1driver.find_element(By.NAME, &quot;email_input&quot;).send_keys(&quot;admin@localhost.dev&quot; ) 清除1driver.find_element(By.NAME, &quot;email_input&quot;).clear() 定位策略123456789101112131415161718192021222324252627282930&lt;html&gt;&lt;body&gt;&lt;style&gt;.information &#123; background-color: white; color: black; padding: 10px;&#125;&lt;/style&gt;&lt;h2&gt;Contact Selenium&lt;/h2&gt;&lt;form action=&quot;/action_page.php&quot;&gt; &lt;input type=&quot;radio&quot; name=&quot;gender&quot; value=&quot;m&quot; /&gt;Male &amp;nbsp; &lt;input type=&quot;radio&quot; name=&quot;gender&quot; value=&quot;f&quot; /&gt;Female &lt;br&gt; &lt;br&gt; &lt;label for=&quot;fname&quot;&gt;First name:&lt;/label&gt;&lt;br&gt; &lt;input class=&quot;information&quot; type=&quot;text&quot; id=&quot;fname&quot; name=&quot;fname&quot; value=&quot;Jane&quot;&gt;&lt;br&gt;&lt;br&gt; &lt;label for=&quot;lname&quot;&gt;Last name:&lt;/label&gt;&lt;br&gt; &lt;input class=&quot;information&quot; type=&quot;text&quot; id=&quot;lname&quot; name=&quot;lname&quot; value=&quot;Doe&quot;&gt;&lt;br&gt;&lt;br&gt; &lt;label for=&quot;newsletter&quot;&gt;Newsletter:&lt;/label&gt; &lt;input type=&quot;checkbox&quot; name=&quot;newsletter&quot; value=&quot;1&quot; /&gt;&lt;br&gt;&lt;br&gt; &lt;input type=&quot;submit&quot; value=&quot;Submit&quot;&gt;&lt;/form&gt; &lt;p&gt;To know more about Selenium, visit the official page &lt;a href =&quot;www.selenium.dev&quot;&gt;Selenium Official Page&lt;/a&gt; &lt;/p&gt;&lt;/body&gt;&lt;/html&gt; 1234567891011121314151617181920212223242526from selenium.webdriver.common.by import Bydriver = webdriver.Chrome()# class namedriver.find_element(By.CLASS_NAME, &quot;information&quot;)# css selector #代表id .代表classdriver.find_element(By.CSS_SELECTOR, &quot;#fname&quot;) # iddriver.find_element(By.ID, &quot;lname&quot;)# namedriver.find_element(By.NAME, &quot;newsletter&quot;)# link textdriver.find_element(By.LINK_TEXT, &quot;Selenium Official Page&quot;)# partial部分 link textdriver.find_element(By.PARTIAL_LINK_TEXT, &quot;Official Page&quot;)# tag namedriver.find_element(By.TAG_NAME, &quot;a&quot;)# xpathdriver.find_element(By.XPATH, &quot;//input[@value=&#x27;f&#x27;]&quot;) 显示 是否显示 此方法用于检查连接的元素是否正确显示在网页上. 返回一个 Boolean 值， 如果连接的元素显示在当前的浏览器上下文中，则为True，否则返回false。 1value = driver.find_element(By.NAME, &#x27;button_input&#x27;).is_enabled() 是否启用 此方法用于检查所连接的元素在网页上是启用还是禁用状态。 返回一个布尔值，如果在当前浏览上下文中是 启用 状态，则返回 true，否则返回 false。 1value = driver.find_element(By.NAME, &#x27;button_input&#x27;).is_enabled() 是否被选定 此方法确认相关的元素是否 已选定，常用于复选框、单选框、输入框和选择元素中。 该方法返回一个布尔值，如果在当前浏览上下文中 选择了 引用的元素，则返回 True，否则返回 False。 1value = driver.find_element(By.NAME, &quot;checkbox_input&quot;).is_selected() 获取元素标签名1attr = driver.find_element(By.NAME, &quot;email_input&quot;).tag_name 位置和大小 用于获取参照元素的尺寸和坐标。元素左上角的X轴位置元素左上角的y轴位置元素的高度元素的宽度 1res = driver.find_element(By.NAME, &quot;range_input&quot;).rect 获取元素CSS值1cssValue = driver.find_element(By.ID, &quot;namedColor&quot;).value_of_css_property(&#x27;background-color&#x27;) 文本内容1text = driver.find_element(By.ID, &quot;justanotherlink&quot;).text 获取特性或属性12email_txt = driver.find_element(By.NAME, &quot;email_input&quot;)value_info = email_txt.get_attribute(&quot;value&quot;) 浏览器交互12345678title = driver.titleurl = driver.current_url# 按下浏览器的后退按钮driver.back()# 按下浏览器的前进键driver.forward()# 刷新当前页面driver.refresh() Alerts 警告框1234567element = driver.find_element(By.LINK_TEXT, &quot;See an example alert&quot;)element.click()wait = WebDriverWait(driver, timeout=2)alert = wait.until(lambda d : d.switch_to.alert)text = alert.textalert.accept() Confirm 确认框1234567element = driver.find_element(By.LINK_TEXT, &quot;See a sample confirm&quot;)driver.execute_script(&quot;arguments[0].click();&quot;, element)wait = WebDriverWait(driver, timeout=2)alert = wait.until(lambda d : d.switch_to.alert)text = alert.textalert.dismiss() Prompt 提示框12345678element = driver.find_element(By.LINK_TEXT, &quot;See a sample prompt&quot;)driver.execute_script(&quot;arguments[0].click();&quot;, element)wait = WebDriverWait(driver, timeout=2)alert = wait.until(lambda d : d.switch_to.alert)alert.send_keys(&quot;Selenium&quot;)text = alert.textalert.accept() cookiesCookie是从网站发送并存储在您的计算机中的一小段数据. Cookies主要用于识别用户并加载存储的信息. 123456789101112131415161718192021222324# 添加 Cookiedriver.add_cookie(&#123;&quot;name&quot;: &quot;key&quot;, &quot;value&quot;: &quot;value&quot;&#125;)# 获取命名的 Cookieprint(driver.get_cookie(&quot;foo&quot;))# 获取全部 Cookiesdriver.add_cookie(&#123;&quot;name&quot;: &quot;test1&quot;, &quot;value&quot;: &quot;cookie1&quot;&#125;)driver.add_cookie(&#123;&quot;name&quot;: &quot;test2&quot;, &quot;value&quot;: &quot;cookie2&quot;&#125;)# Get all available cookiesprint(driver.get_cookies())# 删除 Cookiedriver.add_cookie(&#123;&quot;name&quot;: &quot;test1&quot;, &quot;value&quot;: &quot;cookie1&quot;&#125;)driver.add_cookie(&#123;&quot;name&quot;: &quot;test2&quot;, &quot;value&quot;: &quot;cookie2&quot;&#125;)# Delete a cookie with name &#x27;test1&#x27;driver.delete_cookie(&quot;test1&quot;)#删除所有 Cookiesdriver.delete_all_cookies() 同窗口和标签一起工作12# 可以使用以下方法获得当前窗口的窗口句柄driver.current_window_handle 切换窗口或标签页1234567891011121314151617181920212223242526272829303132from selenium import webdriverfrom selenium.webdriver.support.ui import WebDriverWaitfrom selenium.webdriver.support import expected_conditions as EC # 启动驱动程序with webdriver.Firefox() as driver: # 打开网址driver.get(&quot;https://seleniumhq.github.io&quot;) # 设置等待 wait = WebDriverWait(driver, 10) # 存储原始窗口的 ID original_window = driver.current_window_handle # 检查一下，我们还没有打开其他的窗口 assert len(driver.window_handles) == 1 # 单击在新窗口中打开的链接 driver.find_element(By.LINK_TEXT, &quot;new window&quot;).click() # 等待新窗口或标签页 wait.until(EC.number_of_windows_to_be(2)) # 循环执行，直到找到一个新的窗口句柄 for window_handle in driver.window_handles: if window_handle != original_window: driver.switch_to.window(window_handle) break # 等待新标签页完成加载内容 wait.until(EC.title_is(&quot;SeleniumHQ Browser Automation&quot;)) 创建新窗口(或)新标签页并且切换 创建一个新窗口 (或) 标签页，屏幕焦点将聚焦在新窗口或标签在上。您不需要切换到新窗口 (或) 标签页。如果除了新窗口之外， 您打开了两个以上的窗口 (或) 标签页，您可以通过遍历 WebDriver 看到两个窗口或选项卡，并切换到非原始窗口。 注意: 该特性适用于 Selenium 4 及其后续版本。 12345 # 打开新标签页并切换到新标签页driver.switch_to.new_window(&#x27;tab&#x27;)# 打开一个新窗口并切换到新窗口driver.switch_to.new_window(&#x27;window&#x27;) 关闭窗口或标签页 当你完成了一个窗口或标签页的工作时，_并且_它不是浏览器中最后一个打开的窗口或标签页时，你应该关闭它并切换回你之前使用的窗口 12345#关闭标签页或窗口driver.close()#切回到之前的标签页或窗口driver.switch_to.window(original_window) 1如果在关闭一个窗口后忘记切换回另一个窗口句柄，WebDriver 将在当前关闭的页面上执行，并触发一个 No Such Window Exception 无此窗口异常。必须切换回有效的窗口句柄才能继续执行。 退出 Python 的 WebDriver 现在支持 Python 上下文管理器，当使用 with 关键字时，可以在执行结束时自动退出驱动程序。 1234with webdriver.Firefox() as driver: # WebDriver 代码…# 在此缩进位置后 WebDriver 会自动退出 窗口管理 获取窗口大小1234567width = driver.get_window_size().get(&quot;width&quot;)height = driver.get_window_size().get(&quot;height&quot;)# 或者存储尺寸并在以后查询它们size = driver.get_window_size()width1 = size.get(&quot;width&quot;)height1 = size.get(&quot;height&quot;) 设置窗口大小1driver.set_window_size(1024, 768) 得到窗口的位置12345678 # 分别获取每个尺寸x = driver.get_window_position().get(&#x27;x&#x27;)y = driver.get_window_position().get(&#x27;y&#x27;) # 或者存储尺寸并在以后查询它们position = driver.get_window_position()x1 = position.get(&#x27;x&#x27;)y1 = position.get(&#x27;y&#x27;) 设置窗口位置1driver.set_window_position(0, 0) 最大化窗口1driver.maximize_window() 最小化窗口1driver.minimize_window() 全屏窗口1driver.fullscreen_window() 屏幕截图1driver.save_screenshot(&#x27;./image.png&#x27;) 元素屏幕截图123ele = driver.find_element(By.CSS_SELECTOR, &#x27;h1&#x27;)# Returns and base64 encoded string into imageele.screenshot(&#x27;./image.png&#x27;) 执行脚本 在当前frame或者窗口的上下文中，执行JavaScript代码片段. 12345 # Stores the header elementheader = driver.find_element(By.CSS_SELECTOR, &quot;h1&quot;) # Executing JavaScript to capture innerText of header elementdriver.execute_script(&#x27;return arguments[0].innerText&#x27;, header) Actions接口1除了高级元素交互之外, Actions 接口 还提供了对指定输入设备 可以执行的确切操作的精细控制. Selenium为3种输入源提供了接口： 键盘设备的键输入, 鼠标, 笔或触摸设备的输入, 以及滚轮设备的滚轮输入 (在Selenium 4.2中引入). Selenium允许您构建分配给特定输入的独立操作命令, 会将他们链接在一起, 并调用关联的执行方法以一次执行它们. 暂停 12345678clickable = driver.find_element(By.ID, &quot;clickable&quot;)ActionChains(driver)\\ .move_to_element(clickable)\\ .pause(1)\\ .click_and_hold()\\ .pause(1)\\ .send_keys(&quot;abc&quot;)\\ .perform() 释放所有Actions 1ActionBuilder(driver).clear_actions() 按下按键 1234ActionChains(driver)\\ .key_down(Keys.SHIFT)\\ .send_keys(&quot;abc&quot;)\\ .perform() 释放按键 123456ActionChains(driver)\\ .key_down(Keys.SHIFT)\\ .send_keys(&quot;a&quot;)\\ .key_up(Keys.SHIFT)\\ .send_keys(&quot;b&quot;)\\ .perform() 键入 123ActionChains(driver)\\ .send_keys(&quot;abc&quot;)\\ .perform() 指定元素 1234text_input = driver.find_element(By.ID, &quot;textInput&quot;)ActionChains(driver)\\ .send_keys_to_element(text_input, &quot;abc&quot;)\\ .perform() 复制粘贴 123456789101112cmd_ctrl = Keys.COMMAND if sys.platform == &#x27;darwin&#x27; else Keys.CONTROLActionChains(driver)\\ .send_keys(&quot;Selenium!&quot;)\\ .send_keys(Keys.ARROW_LEFT)\\ .key_down(Keys.SHIFT)\\ .send_keys(Keys.ARROW_UP)\\ .key_up(Keys.SHIFT)\\ .key_down(cmd_ctrl)\\ .send_keys(&quot;xvv&quot;)\\ .key_up(cmd_ctrl)\\ .perform() 按住鼠标左键这个方法包含2个操作，首先将光标移动到被操作元素的正中心，然后按下鼠标左键不松开。 这对于聚焦一个特殊元素很有用： 1234clickable = driver.find_element(By.ID, &quot;clickable&quot;)ActionChains(driver)\\ .click_and_hold(clickable)\\ .perform() 点击鼠标左键这个方法包含2个操作，首先将光标移动到被操作元素的正中心，然后按下鼠标左键后再松开。 另一种叫法“点击”： 1234clickable = driver.find_element(By.ID, &quot;click&quot;)ActionChains(driver)\\ .click(clickable)\\ .perform() 点击鼠标备用按钮鼠标一共有5个定义好的按钮: 0 — 左键 (默认值)1 — 中间键 (当前不支持)2 — 右键3 — X1 (返回) 按钮4 — X2 (前进) 按钮点击鼠标右键这个方法包含2个操作，首先将光标移动到被操作元素的正中心，然后点击鼠标右键。 另一种叫法“点击右键”： 1234clickable = driver.find_element(By.ID, &quot;clickable&quot;)ActionChains(driver)\\ .context_click(clickable)\\ .perform() 点击鼠标回退键除了这个没有更方便的方法，只是点击鼠标回退按1234action = ActionBuilder(driver)action.pointer_action.pointer_down(MouseButton.BACK)action.pointer_action.pointer_up(MouseButton.BACK)action.perform() 点击鼠标前进键除了这个没有更方便的方法，只是点击鼠标前进按钮1234action = ActionBuilder(driver)action.pointer_action.pointer_down(MouseButton.FORWARD)action.pointer_action.pointer_up(MouseButton.FORWARD)action.perform() 双击鼠标左键这个方法包含2个操作，首先将光标移动到被操作元素的正中心，然后双击鼠标左键。1234clickable = driver.find_element(By.ID, &quot;clickable&quot;)ActionChains(driver)\\ .double_click(clickable)\\ .perform() 移动光标到元素上这个方法是将光标移动到元素的中心点。 另一种叫法“悬停”。 元素必须在可视窗口范围内否则这条命令将会报错。1234hoverable = driver.find_element(By.ID, &quot;hover&quot;)ActionChains(driver)\\ .move_to_element(hoverable)\\ .perform() 通过偏移量移动动光标这些方法让光标先移动到指定的坐标原点，然后通过单位为px的偏移量进行光标相对原点的偏移移动。 注意光标位置必须在可视窗口区域否则会报错。从元素中心点（原点）偏移这个方法是指先将光标移动到元素中心点（原点），然后通过偏移量进行光标相对原点的偏移。1234567891011mouse_tracker = driver.find_element(By.ID, &quot;mouse-tracker&quot;) ActionChains(driver)\\ .move_to_element_with_offset(mouse_tracker, 8, 0)\\ .perform()``` - 从视窗左上角（原点）偏移这个方法是指先将光标移动到视窗左上角（原点），然后通过偏移量进行光标相对原点的偏移。```python action = ActionBuilder(driver) action.pointer_action.move_to_location(8, 0) action.perform() 从当前光标位置（原点）偏移这个方法是指光标位于当前位置（原点），然后通过偏移量进行光标相对原点的偏移。 如果之前没有移动过光标位置，则这个位置是视窗左上角（原点）。 注意当页面发生滚动后光标位置不会发生变化。注意第一个参数指定为正数时向右移动，第二个参数指定为正数时向下移动。所以 moveByOffset(30, -10) 是指从当前光标位置向右移动30个像素位置和向上移动10个像素位置。123ActionChains(driver)\\ .move_by_offset( 13, 15)\\ .perform() 拖放元素这个方法首先在原元素上提交执行按下鼠标左键，移动到目标元素位置后是释放鼠标左键。12345draggable = driver.find_element(By.ID, &quot;draggable&quot;)droppable = driver.find_element(By.ID, &quot;droppable&quot;)ActionChains(driver)\\ .drag_and_drop(draggable, droppable)\\ .perform() 通过偏移量拖放元素这个方法首先在原元素上提交执行按下鼠标左键，通过给出的偏移量移动元素后释放鼠标左键。123456draggable = driver.find_element(By.ID, &quot;draggable&quot;)start = draggable.locationfinish = driver.find_element(By.ID, &quot;droppable&quot;).locationActionChains(driver)\\ .drag_and_drop_by_offset(draggable, finish[&#x27;x&#x27;] - start[&#x27;x&#x27;], finish[&#x27;y&#x27;] - start[&#x27;y&#x27;])\\ .perform() 滚动到元素1234iframe = driver.find_element(By.TAG_NAME, &quot;iframe&quot;)ActionChains(driver)\\ .scroll_to_element(iframe)\\ .perform() 按给定数量滚动12345footer = driver.find_element(By.TAG_NAME, &quot;footer&quot;)delta_y = footer.rect[&#x27;y&#x27;]ActionChains(driver)\\ .scroll_by_amount(0, delta_y)\\ .perform() 从一个元素滚动给定的量12345iframe = driver.find_element(By.TAG_NAME, &quot;iframe&quot;)scroll_origin = ScrollOrigin.from_element(iframe)ActionChains(driver)\\ .scroll_from_origin(scroll_origin, 0, 200)\\ .perform() 从具有偏移的元素滚动12345footer = driver.find_element(By.TAG_NAME, &quot;footer&quot;)scroll_origin = ScrollOrigin.from_element(footer, 0, -50)ActionChains(driver)\\ .scroll_from_origin(scroll_origin, 0, 200)\\ .perform() 从原点（元素）的偏移量滚动给定的量12345scroll_origin = ScrollOrigin.from_viewport(10, 10)ActionChains(driver)\\ .scroll_from_origin(scroll_origin, 0, 200)\\ .perform() 操作Cookie12345678910获取所有cookie信息driver.get_cookies()获取指定cookie信息driver.get_cookie(&#x27;BAIDUID&#x27;)·添加cookiedriver.add_cookie(&#123;&#x27;name&#x27;:&#x27;zhangsan&#x27;,&#x27;value&#x27;:&#x27;88888&#x27;&#125;)删除cookiedriver.delete_cookie(&#x27;zhangsan&#x27;)driver.delete_all_cookies() 123456789101112131415from selenium import webdriverdriver = webdriver.Chrome()driver.get(&quot;https://www.zhipin.com/web/geek/job?query=python&amp;city=101010100&amp;page=1&quot;)driver.add_cookie(&#123;&#x27;name&#x27;:&#x27;zhangshan&#x27;,&#x27;value&#x27;:&#x27;8888&#x27;&#125;)cookies = driver.get_cookies()for cookie in cookies: print(cookie)driver.delete_cookie(&#x27;zhangshan&#x27;)driver.delete_all_cookies()driver.close()driver.quit() 等待隐式等待:调用 driver.implicitly_wait.那么在获取不可用的元素之前，会先等待N秒钟的时间显示等待:显示等待是表明某个条件成立后才执行获取元素的操作。也可以在等待的时候指定一个最大的时间，如果超过这个时间那么就会抛出一个异常显示等待应用selenmm.webdriver.support.excepted_conditions 期望的条件selenium.welJebDriverWait","categories":[{"name":"爬虫类","slug":"爬虫类","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/"},{"name":"基础","slug":"爬虫类/基础","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"018-动态网页爬虫","slug":"爬虫/基础/018-动态网页爬虫","date":"2023-08-20T13:30:52.000Z","updated":"2024-06-01T06:15:57.000Z","comments":true,"path":"2023/08/20/爬虫/基础/018-动态网页爬虫/","link":"","permalink":"https://dbbruce.github.io/2023/08/20/%E7%88%AC%E8%99%AB/%E5%9F%BA%E7%A1%80/018-%E5%8A%A8%E6%80%81%E7%BD%91%E9%A1%B5%E7%88%AC%E8%99%AB/","excerpt":"动态网页1是在网站不重新加载的情况下，通过aiax技术动态更新网站中的局部数据","text":"动态网页1是在网站不重新加载的情况下，通过aiax技术动态更新网站中的局部数据 AJAX(Asynchronouse JavaScript AndXML)1异步JavaScrip和XML前端与服务器进行少量数据交换，Ajax可以使用网页实现异更新这意吁着可以在不重新加载整个网页的情况下，对网页的某部分进行更新。 动态网页爬虫的解决方案12直接分析Aiax调用的接口。然后通过代码请求这个接口使用selenium+chromedirver模拟浏览器行为获取数据 方式 优点 缺点 分析接口 直接可以请求到数据。不需要做一 些解析工作。代码量少，性能高 分析接口比较复杂，特别是一些通过JS混 淆的接口，需要一定的JS功底，容易被发现是爬虫 selenium 直接模块浏览器的行为。浏览器能请求到的，使用selenium也能请求到，爬虫更稳定 代码量多，性能低","categories":[{"name":"爬虫类","slug":"爬虫类","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/"},{"name":"基础","slug":"爬虫类/基础","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"017-scrapy动态设置UA","slug":"爬虫/基础/017-scrapy动态设置UA","date":"2023-08-20T13:04:52.000Z","updated":"2024-06-01T05:42:57.000Z","comments":true,"path":"2023/08/20/爬虫/基础/017-scrapy动态设置UA/","link":"","permalink":"https://dbbruce.github.io/2023/08/20/%E7%88%AC%E8%99%AB/%E5%9F%BA%E7%A1%80/017-scrapy%E5%8A%A8%E6%80%81%E8%AE%BE%E7%BD%AEUA/","excerpt":"Scrapy动态UA的设置fake-useragent一个可以频繁更换User-Agent的防反扒利器·fake-useragent为第三方模块，需安装才能使用在线安装方式 pip install fake-usergent查看文档 :https://github.com/NunchakusHuang/fake-useragent","text":"Scrapy动态UA的设置fake-useragent一个可以频繁更换User-Agent的防反扒利器·fake-useragent为第三方模块，需安装才能使用在线安装方式 pip install fake-usergent查看文档 :https://github.com/NunchakusHuang/fake-useragent 用法1234567891011121314151617181920212223242526from fake_useragent import UserAgentua = UserAgent()ua.ie# Mozilla/5.0 (Windows; U; MSIE 9.0; Windows NT 9.0; en-US);ua.msie# Mozilla/5.0 (compatible; MSIE 10.0; Macintosh; Intel Mac OS X 10_7_3; Trident/6.0)&#x27;ua[&#x27;Internet Explorer&#x27;]# Mozilla/5.0 (compatible; MSIE 8.0; Windows NT 6.1; Trident/4.0; GTB7.4; InfoPath.2; SV1; .NET CLR 3.3.69573; WOW64; en-US)ua.opera# Opera/9.80 (X11; Linux i686; U; ru) Presto/2.8.131 Version/11.11ua.chrome# Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.2 (KHTML, like Gecko) Chrome/22.0.1216.0 Safari/537.2&#x27;ua.google# Mozilla/5.0 (Macintosh; Intel Mac OS X 10_7_4) AppleWebKit/537.13 (KHTML, like Gecko) Chrome/24.0.1290.1 Safari/537.13ua[&#x27;google chrome&#x27;]# Mozilla/5.0 (X11; CrOS i686 2268.111.0) AppleWebKit/536.11 (KHTML, like Gecko) Chrome/20.0.1132.57 Safari/536.11ua.firefox# Mozilla/5.0 (Windows NT 6.2; Win64; x64; rv:16.0.1) Gecko/20121011 Firefox/16.0.1ua.ff# Mozilla/5.0 (X11; Ubuntu; Linux i686; rv:15.0) Gecko/20100101 Firefox/15.0.1ua.safari# Mozilla/5.0 (iPad; CPU OS 6_0 like Mac OS X) AppleWebKit/536.26 (KHTML, like Gecko) Version/6.0 Mobile/10A5355d Safari/8536.25# and the best one, random via real world browser usage statisticua.random 使用中间件动态设置UA12345678910111213141516test1 % scrapy startproject httpuatest1 % cd httpua httpua % scrapy genspider httpuaspider httpbin.org httpua├── httpua│ ├── __init__.py│ ├── items.py│ ├── middlewares.py│ ├── pipelines.py│ ├── settings.py│ └── spiders│ ├── __init__.py│ └── httpuaspider.py├── scrapy.cfg└── start.py 1234567891011121314# spiders/httpuaspider.pyimport scrapyclass HttpuaspiderSpider(scrapy.Spider): name = &quot;httpuaspider&quot; allowed_domains = [&quot;httpbin.org&quot;] start_urls = [&quot;https://httpbin.org/get&quot;] def parse(self, response): print(response.text) # scrapy.Request(url):参数必须是一个字符串 # dont_filter: 忽略重复过滤 yield scrapy.Request(self.start_urls[0], dont_filter=True ) 1234567# middlewares.pyfrom fake_useragent import UserAgentclass HttpuaDownloaderMiddleware: def process_request(self, request, spider): request.headers[&#x27;User-Agent&#x27;]=UserAgent().random return None 12345# settings.pyDOWNLOADER_MIDDLEWARES = &#123; &quot;httpua.middlewares.HttpuaDownloaderMiddleware&quot;: 300,&#125;","categories":[{"name":"爬虫类","slug":"爬虫类","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/"},{"name":"基础","slug":"爬虫类/基础","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"016-scrapy下载中间件","slug":"爬虫/基础/016-scrapy下载中间件","date":"2023-08-20T12:04:52.000Z","updated":"2024-06-01T03:05:21.000Z","comments":true,"path":"2023/08/20/爬虫/基础/016-scrapy下载中间件/","link":"","permalink":"https://dbbruce.github.io/2023/08/20/%E7%88%AC%E8%99%AB/%E5%9F%BA%E7%A1%80/016-scrapy%E4%B8%8B%E8%BD%BD%E4%B8%AD%E9%97%B4%E4%BB%B6/","excerpt":"下载器中间件（Downloader Middleware） 位于引擎和下载器之间通信的中间件。 作用：更换代理IP，更换Cookies，更换User-Agent，自动重试 设置代码、更换请求头等来达到反反爬虫的目的 编写下载器中间件,需要下载器中实现两个方法 process_request(self,request,spider),在请求发送之前会执行 process_response(self,request,response,spider)，数据下载到引擎之前执行","text":"下载器中间件（Downloader Middleware） 位于引擎和下载器之间通信的中间件。 作用：更换代理IP，更换Cookies，更换User-Agent，自动重试 设置代码、更换请求头等来达到反反爬虫的目的 编写下载器中间件,需要下载器中实现两个方法 process_request(self,request,spider),在请求发送之前会执行 process_response(self,request,response,spider)，数据下载到引擎之前执行 下载中间件实际上是一个类（process_request）中间件可以有多个 下载中间件request返回值1234# - return None: continue processing this request# - or return a Response object# - or return a Request object# - or raise IgnoreRequest: process_exception() methods of 下载中间件response返回值","categories":[{"name":"爬虫类","slug":"爬虫类","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/"},{"name":"基础","slug":"爬虫类/基础","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"014-scrapy模拟登录","slug":"爬虫/基础/014-scrapy模拟登录","date":"2023-08-20T07:04:52.000Z","updated":"2024-05-31T08:27:53.000Z","comments":true,"path":"2023/08/20/爬虫/基础/014-scrapy模拟登录/","link":"","permalink":"https://dbbruce.github.io/2023/08/20/%E7%88%AC%E8%99%AB/%E5%9F%BA%E7%A1%80/014-scrapy%E6%A8%A1%E6%8B%9F%E7%99%BB%E5%BD%95/","excerpt":"Request子 类FormRequest对象 FormRequest类扩展了Request，具有处理HTML表单的功能scrapy. FormRequest (url, formdata-form_data, callback&#x3D;self. parse)formdata：是一个包含HTML Form数据的字典，它将被URL编码并分配给请求的主体","text":"Request子 类FormRequest对象 FormRequest类扩展了Request，具有处理HTML表单的功能scrapy. FormRequest (url, formdata-form_data, callback&#x3D;self. parse)formdata：是一个包含HTML Form数据的字典，它将被URL编码并分配给请求的主体 1234567891011121314151617181920212223242526import scrapyfrom bs4 import BeautifulSoupfrom ..items import Doubanitemclass DoubanSpider(scrapy.Spider): name = &#x27;xslou&#x27; # 爬虫名称 allowed_domains =[&#x27;xslou.com&#x27;] # 定义运行爬取的域名 start_urls = [&#x27;https://www.xslou.com&#x27;] # 定义起始的网址 def start_requests(self): url = &#x27;https://www.xslou.com/login.php&#x27; form_data = &#123; &#x27;username&#x27;: &#x27;12312312&#x27;, &#x27;password&#x27;: &#x27;1231231&#x27;, &#x27;usecookie&#x27;: &#x27;0&#x27;, &#x27;action&#x27;: &#x27;login&#x27;, &#x27;submit&#x27;: &#x27;(123123)&#x27;, &#125; yield scrapy.FormRequest(url, form_data=form_data, callback=self.parse) def parse(self, response): yield scrapy.Request(&#x27;https://www.xslou.com/modules/article/uservote.php?id=3&#x27;, callback=self.parse_article) def parse_article(self, response): print(response.text)","categories":[{"name":"爬虫类","slug":"爬虫类","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/"},{"name":"基础","slug":"爬虫类/基础","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"存货收发存汇总(ia.transaction.summary.query)","slug":"项目/医药公司ERP/20230819","date":"2023-08-19T14:14:52.000Z","updated":"2024-11-29T02:15:38.584Z","comments":true,"path":"2023/08/19/项目/医药公司ERP/20230819/","link":"","permalink":"https://dbbruce.github.io/2023/08/19/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/20230819/","excerpt":"1、项目结构 &#x2F;opt&#x2F;projects&#x2F;insuite&#x2F;biz&#x2F;cost&#x2F;ps_ia&#x2F;ia_report&#x2F;ia_transaction_summary_query&#x2F;report&#x2F;ia_transaction_summary_query.py 12345678910111213ia_transaction_summary_query |____report | |____ia_transaction_summary_query.xml | |____ele_ctrl_config_data.xml | |______init__.py | |______pycache__ | | |____ia_transaction_summary_query.cpython-37.pyc | | |______init__.cpython-37.pyc | |____ia_transaction_summary_query.py | |____ia_transaction_summary_query_org_data.xml |______init__.py |______pycache__ | |______init__.cpython-37.pyc","text":"1、项目结构 &#x2F;opt&#x2F;projects&#x2F;insuite&#x2F;biz&#x2F;cost&#x2F;ps_ia&#x2F;ia_report&#x2F;ia_transaction_summary_query&#x2F;report&#x2F;ia_transaction_summary_query.py 12345678910111213ia_transaction_summary_query |____report | |____ia_transaction_summary_query.xml | |____ele_ctrl_config_data.xml | |______init__.py | |______pycache__ | | |____ia_transaction_summary_query.cpython-37.pyc | | |______init__.cpython-37.pyc | |____ia_transaction_summary_query.py | |____ia_transaction_summary_query_org_data.xml |______init__.py |______pycache__ | |______init__.cpython-37.pyc 2、模型继承关系 3、专业术语 3.1、会计日历：是用户根据实际业务需要，自定义企业经营活动的会计期间 3.2、核算体系：从不同的视角，账务处理的业务范围划分有所不同，不同的划分标准即形成不同的会计主体体系——核算体系 3.3、核算组织即财务核算主体，是会计记账、财务报告的主体。通过业务组织－核算组织的关系来确定业务的财务归属，用户可以从不同的管理维度，将业务组织划分为不同的核算组织 3.4、账簿，是一套财务数据的归集 4、PGSQL 4.1、 COALESCE 函数语法: 参数可以有无限个，总是返回第一个非空参数，如果所有参数都是null，则返回null1COALESCE (argument_1, argument_2, …); 4.2、concat_ws函数允许您，将多个字符串连接成一个由指定分隔符分隔的字符串 4.3、replace(字段名,’替换前的内容’,’替换后的内容’) 5、代码分析123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567def _create_table(self, _line_table, unique=True, domain_fields=None, unit_type=&#x27;&#x27;, price_precision=6): &quot;&quot;&quot; 创建临时表，插入数据 :param _line_table: 临时表对象 :param unique: 是否唯一 :param domain_fields: 查询条件 :param unit_type: 计量单位 :param price_precision: 价格精度 &quot;&quot;&quot; name = &quot;query_ia_transaction_summary&quot; + str(self.env.uid) # 获取会计日历表数据 calendar_line1_obj = self.env[&#x27;mdm.account.calendar.line1&#x27;] # sql条件 # 核算体系 acct_sys_id = self.env[&#x27;mdm.accounting.system&#x27;].browse(domain_fields.get(&#x27;accting_sys_id&#x27;,&#x27;&#x27;)).id # 核算组织 acct_org_id = self.env[&#x27;sys.admin.orgs&#x27;].browse(domain_fields.get(&#x27;accting_org_id&#x27;,&#x27;&#x27;)).id # 会计政策 acct_policy_id = self.env[&#x27;mdm.accounting.policy&#x27;].browse(domain_fields.get(&#x27;accting_policy_id&#x27;,&#x27;&#x27;)).id # 会计日历 calendar_id = self.env[&#x27;mdm.account.calendar&#x27;].browse(domain_fields.get(&#x27;calendar_id&#x27;,&#x27;&#x27;)).id # 会计期间从 多对一 acct_period_id_from = calendar_line1_obj.browse(domain_fields.get(&#x27;acct_period_id_from&#x27;,&#x27;&#x27;)) # 会计年度 acct_year = acct_period_id_from.acct_year # 会计期间 acct_period = acct_period_id_from.acct_period # 会计期间至 acct_period_id_to = calendar_line1_obj.browse(domain_fields.get(&#x27;acct_period_id_to&#x27;,&#x27;&#x27;)) # 开始日期 start_date = str(acct_period_id_from.start_date) # 结束日期 end_date = str(acct_period_id_to.end_date) # 核算单位展示类型 unit_type = domain_fields.get(&#x27;unit_type&#x27;) # 显示维度 display_dimensions = domain_fields.get(&#x27;display_dimensions&#x27;) # 展示时间维度 presentation_time_dimension = domain_fields.get(&#x27;presentation_time_dimension&#x27;) # select * from mdm_account_calendar_line1 where start_date&gt;=&#x27;2024-08-01&#x27; and end_date&lt;= &#x27;2024-08-31&#x27; and parent_id=&#x27;1&#x27; order by start_date; period_range_list = calendar_line1_obj.search([ (&#x27;start_date&#x27;, &#x27;&gt;=&#x27;, start_date), (&#x27;end_date&#x27;, &#x27;&lt;=&#x27;, end_date), (&#x27;parent_id&#x27;,&#x27;=&#x27;,calendar_id) ],order=&#x27;start_date&#x27;) # where条件 _where = &#x27;&#x27; # 货主 if domain_fields.get(&#x27;owner_type_id&#x27;): _where += &quot; and case when dim.owner_type_value != &#x27;0&#x27; then dim.owner_type_value = &#x27;&#123;owner&#125;&#x27; else replace(coalesce(tran.ia_owner_type, inter_doc.ia_owner_type),&#x27;sys.admin.orgs,&#x27;,&#x27;&#x27;) = &#x27;&#123;owner&#125;&#x27; END&quot;.format(owner=domain_fields.get(&#x27;owner_type_id&#x27;)) # 库存组织 if domain_fields.get(&#x27;stk_org_id&#x27;): _where += &quot; and coalesce(tran.stk_org_id, inter_doc.stk_org_id) = &#123;&#125;&quot;.format(domain_fields.get(&#x27;stk_org_id&#x27;)) # 仓库 warehouse_id_list = domain_fields.get(&#x27;warehouse_ids&#x27;) if warehouse_id_list: if len(warehouse_id_list) == 1: param = &#x27;(&#123;&#125;)&#x27;.format(warehouse_id_list[0]) else: param = tuple(warehouse_id_list) _where += &quot; and coalesce(tran.warehouse_id, inter_doc.warehouse_id) in &#123;&#125;&quot;.format(param) # 物料分组 material_group_id_list = domain_fields.get(&#x27;material_group_ids&#x27;) if material_group_id_list: if len(material_group_id_list) == 1: param = &#x27;(&#123;&#125;)&#x27;.format(material_group_id_list[0]) else: param = tuple(material_group_id_list) _where += &quot; and mat.material_group in &#123;&#125;&quot;.format(param) # 存货类别 if domain_fields.get(&#x27;category_id&#x27;): _where += &quot; and mat.category_id = &#x27;&#123;&#125;&#x27;&quot;.format(domain_fields.get(&#x27;category_id&#x27;)) # 物料 material_id_list = domain_fields.get(&#x27;material_ids&#x27;) if material_id_list: if len(material_id_list) == 1: param = &#x27;(&#123;&#125;)&#x27;.format(material_id_list[0]) else: param = tuple(material_id_list) _where += &quot; and ia.material_id in &#123;&#125;&quot;.format(param) # 重新查询删除临时表 # drop table if exists query_ia_transaction_summary2; self.env.cr.execute(&quot;drop table if exists &#123;table&#125;;&quot;.format(table=name)) # 1.创建临时表 query_table = &quot;&quot;&quot; create unlogged table &#123;table&#125; ( src_parent_model text, src_parent_id int, acct_year text, acct_period text, category_id text, material_group_name text, material_id int, material_number text, material_name text, specification text, auxiliary text, lot text, bom_version_name text, mto_num text, owner_type text, stk_org_name text, warehouse_name text, location_name text, uom_id int, uom_precision int, uom_name text, accting_dimensions_id int, stk_key text, init_qty float default(0), init_amount float default(0), in_qty float default(0), in_amount float default(0), out_qty float default(0), out_amount float default(0), balance_qty float default(0), balance_amount float default(0), in_pur_qty float default(0), in_pur_amount float default(0), in_pro_qty float default(0), in_pro_amount float default(0), in_count_qty float default(0), in_count_amount float default(0), in_trans_qty float default(0), in_trans_amount float default(0), in_adjust_qty float default(0), in_adjust_amount float default(0), in_other_qty float default(0), in_other_amount float default(0), out_sal_qty float default(0), out_sal_amount float default(0), out_pro_qty float default(0), out_pro_amount float default(0), out_count_qty float default(0), out_count_amount float default(0), out_trans_qty float default(0), out_trans_amount float default(0), out_adjust_qty float default(0), out_adjust_amount float default(0), out_other_qty float default(0), out_other_amount float default(0), first_init_qty float default(0), first_init_amount float default(0) )&quot;&quot;&quot;.format(table=name) self.env.cr.execute(query_table) # 2.插入期初 _init_where = _where.replace(&#x27;coalesce(tran.ia_owner_type, inter_doc.ia_owner_type)&#x27;,&#x27;tran.owner_type&#x27;).replace(&#x27;coalesce(tran.stk_org_id, inter_doc.stk_org_id)&#x27;,&#x27;tran.stk_org_id&#x27;).replace(&#x27;coalesce(tran.warehouse_id, inter_doc.warehouse_id)&#x27;,&#x27;tran.warehouse_id&#x27;).replace(&#x27;ia.material_id&#x27;,&#x27;tran.material_id&#x27;) for i,v in enumerate(period_range_list): # 查询存货余额表， sql = &quot;&quot;&quot; insert into &#123;table&#125; ( acct_year, acct_period, category_id, material_group_name, material_id, material_number, material_name, specification, auxiliary, lot, bom_version_name, mto_num, owner_type, stk_org_name, warehouse_name, location_name, uom_id, uom_precision, uom_name, accting_dimensions_id, init_qty, init_amount, stk_key, first_init_qty, first_init_amount ) select tran.accting_year acct_year, tran.accting_period acct_period, mat.category_id, gro.name, mat.id, mat.number, mat.name, mat.specification, tran.auxiliary, tran.lot, bom.version_number, tran.mto_num, owner.name, org.name, ware.name, loca.name, tran.uom_id, unit.precision, unit.name, tran.accting_dimensions_id, tran.init_qty, tran.init_amount, concat_ws( &#x27;_&#x27;, tran.material_id, tran.uom_id, COALESCE(tran.lot, &#x27;null&#x27;), COALESCE(tran.auxiliary, &#x27;null&#x27;), COALESCE(tran.bom_version_id, 0), COALESCE(tran.mto_num, &#x27;null&#x27;), COALESCE(tran.warehouse_id, 0), COALESCE(tran.location_id, 0), COALESCE(tran.stk_org_id, 0), COALESCE(tran.owner_type, &#x27;null&#x27;) ), case when tran.accting_year = &#x27;&#123;accting_year&#125;&#x27; and tran.accting_period = &#x27;&#123;accting_period&#125;&#x27; then tran.init_qty else 0 end, case when tran.accting_year = &#x27;&#123;accting_year&#125;&#x27; and tran.accting_period = &#x27;&#123;accting_period&#125;&#x27; then tran.init_amount else 0 end from ia_balance tran left join ia_accting_dimensions dim on tran.accting_dimensions_id = dim.id left join mdm_material mat on tran.material_id = mat.id left join mdm_material_group gro on mat.material_group = gro.id left join mdm_product_bom bom on tran.bom_version_id = bom.id left join sys_admin_orgs owner on owner.id = to_number(replace(COALESCE(tran.owner_type,&#x27;0&#x27;),&#x27;sys.admin.orgs,&#x27;,&#x27;&#x27;),&#x27;9999999&#x27;) left join sys_admin_orgs org on org.id = tran.stk_org_id left join mdm_warehouse ware on tran.warehouse_id = ware.id left join mdm_warehouse_line1 loca on tran.location_id = loca.id left join mdm_unit unit on tran.uom_id = unit.id where tran.accting_sys_id = &#123;sys&#125; and tran.accting_org_id = &#123;org&#125; and tran.accting_policy_id = &#123;policy&#125; and tran.accting_year = &#x27;&#123;year&#125;&#x27; and tran.accting_period = &#x27;&#123;period&#125;&#x27; &#123;_init_where&#125; &quot;&quot;&quot;.format( table=name, sys=acct_sys_id, org=acct_org_id, policy=acct_policy_id, year=v.acct_year, period=v.acct_period, _init_where=_init_where,accting_year=acct_year,accting_period=acct_period ) self.env.cr.execute(sql) # 报表展示单位，按基本单位展示与按库存单位展示 uom = &#x27;mat.uom_id&#x27; qty = &#x27;case when tran.id is not null then tran.qty * cast(tran.qty_option as int) else inter_doc.qty * cast(inter_doc.qty_option as int) end&#x27; if unit_type == &#x27;display_in_stk_units&#x27;: uom = &#x27;mat.stk_uom_id&#x27; qty = &#x27;case when tran.id is not null then tran.material_stk_qty * cast(tran.qty_option as int) else inter_doc.material_stk_qty * cast(inter_doc.qty_option as int) end&#x27; # 2.插入入库成本结果表数据 sql = &quot;&quot;&quot; insert into &#123;table&#125; ( src_parent_model, src_parent_id, acct_year, acct_period, category_id, material_group_name, material_id, material_number, material_name, specification, auxiliary, lot, bom_version_name, mto_num, owner_type, stk_org_name, warehouse_name, location_name, uom_id, uom_precision, uom_name, accting_dimensions_id, in_qty, in_amount, stk_key ) select COALESCE(tran.src_parent_model, inter_doc.src_parent_model) src_parent_model, COALESCE(tran.src_parent_id, inter_doc.src_parent_id) src_parent_id, period.acct_year, period.acct_period, mat.category_id, gro.name, ia.material_id, mat.number, mat.name, mat.specification, COALESCE(tran.auxiliary, inter_doc.auxiliary) auxiliary, COALESCE(tran.lot, inter_doc.lot) lot, bom.version_number, COALESCE(tran.mto_num, inter_doc.mto_num) mto_num, owner.name, org.name, ware.name, loca.name, &#123;uom&#125;, unit.precision, unit.name, ia.accting_dimensions_id, &#123;qty&#125;, ia.cost_amount, case when tran.id is not null then concat_ws( &#x27;_&#x27;, tran.material_id, tran.uom_id, COALESCE(tran.lot, &#x27;null&#x27;), COALESCE(tran.auxiliary, &#x27;null&#x27;), COALESCE(tran.bom_version_id, 0), COALESCE(tran.mto_num, &#x27;null&#x27;), COALESCE(tran.warehouse_id, 0), COALESCE(tran.location_id, 0), COALESCE(tran.stk_org_id, 0), COALESCE(&#x27;sys.admin.orgs,&#x27; || case when dim.owner_type_value != &#x27;0&#x27; then dim.owner_type_value else replace(tran.ia_owner_type,&#x27;sys.admin.orgs,&#x27;,&#x27;&#x27;) end, &#x27;null&#x27;) ) else concat_ws( &#x27;_&#x27;, ia.material_id, mat.uom_id, COALESCE(inter_doc.lot, &#x27;null&#x27;), COALESCE(inter_doc.auxiliary, &#x27;null&#x27;), COALESCE(inter_doc.bom_version_id, 0), COALESCE(inter_doc.mto_num, &#x27;null&#x27;), COALESCE(inter_doc.warehouse_id, 0), COALESCE(inter_doc.location_id, 0), COALESCE(inter_doc.stk_org_id, 0), COALESCE(&#x27;sys.admin.orgs,&#x27; || case when dim.owner_type_value != &#x27;0&#x27; then dim.owner_type_value else replace(inter_doc.ia_owner_type,&#x27;sys.admin.orgs,&#x27;,&#x27;&#x27;) end, &#x27;null&#x27;) ) end from ia_in_result ia left join ia_accting_dimensions dim on ia.accting_dimensions_id = dim.id left join stk_tran_detail tran on tran.src_id = ia.doc_line_id and tran.src_model = ia.doc_line_model and (case when tran.src_model = &#x27;stk.direct.trans.line1&#x27; and tran.source_line1_model is null then tran.qty_option = &#x27;1&#x27; when tran.src_model = &#x27;stk.direct.trans.line1&#x27; and tran.source_line1_model is not null then tran.qty_option = &#x27;-1&#x27; when tran.src_model = &#x27;medinv.direct.trans.line1&#x27; then tran.qty_option = &#x27;1&#x27; else true end) left join ia_inter_transaction inter_doc on inter_doc.src_id = ia.doc_line_id and inter_doc.src_model = ia.doc_line_model left join mdm_account_calendar_line1 period on period.parent_id = &#123;calendar&#125; and period.start_date &lt;= ia.biz_date and period.end_date &gt;= ia.biz_date left join mdm_material mat on ia.material_id = mat.id left join mdm_material_group gro on mat.material_group = gro.id left join mdm_product_bom bom on bom.id = COALESCE(tran.bom_version_id, inter_doc.bom_version_id) left join sys_admin_orgs owner on owner.id = to_number(case when dim.owner_type_value != &#x27;0&#x27; then dim.owner_type_value else replace(COALESCE(tran.ia_owner_type, inter_doc.ia_owner_type),&#x27;sys.admin.orgs,&#x27;,&#x27;&#x27;) end,&#x27;9999999&#x27;) left join sys_admin_orgs org on org.id = COALESCE(tran.stk_org_id, inter_doc.stk_org_id) left join mdm_warehouse ware on ware.id = COALESCE(tran.warehouse_id, inter_doc.warehouse_id) left join mdm_warehouse_line1 loca on loca.id = COALESCE(tran.location_id, inter_doc.location_id) left join mdm_unit unit on &#123;uom&#125; = unit.id where ia.accting_sys_id = &#123;sys&#125; and ia.accting_org_id = &#123;org&#125; and ia.accting_policy_id = &#123;policy&#125; and ia.biz_date &gt;= &#x27;&#123;start_date&#125;&#x27; and ia.biz_date &lt;= &#x27;&#123;end_date&#125;&#x27; and ia.doc_line_model != &#x27;ia.cost.adjustment.line1&#x27; &#123;_where&#125; union all select &#x27;ia.cost.adjustment&#x27;, tran.parent_id, period.acct_year, period.acct_period, mat.category_id, gro.name, ia.material_id, mat.number, mat.name, mat.specification, tran.auxiliary, tran.lot, bom.version_number, tran.mto_number, owner.name, org.name, ware.name, loca.name, &#123;uom&#125;, unit.precision, unit.name, ia.accting_dimensions_id, 0, ia.cost_amount, concat_ws( &#x27;_&#x27;, tran.material_id, tran.uom_id, COALESCE(tran.lot, &#x27;null&#x27;), COALESCE(tran.auxiliary, &#x27;null&#x27;), COALESCE(tran.bom_version_id, 0), COALESCE(tran.mto_number, &#x27;null&#x27;), COALESCE(tran.warehouse_id, 0), COALESCE(tran.location_id, 0), COALESCE(tran.stk_org_id, 0), COALESCE(tran.owner_type, &#x27;null&#x27;) ) from ia_in_result ia left join ia_accting_dimensions dim on ia.accting_dimensions_id = dim.id left join ia_cost_adjustment_line1 tran on tran.id = ia.doc_line_id left join mdm_account_calendar_line1 period on period.parent_id = &#123;calendar&#125; and period.start_date &lt;= ia.biz_date and period.end_date &gt;= ia.biz_date left join mdm_material mat on ia.material_id = mat.id left join mdm_material_group gro on mat.material_group = gro.id left join mdm_product_bom bom on tran.bom_version_id = bom.id left join sys_admin_orgs owner on owner.id = to_number(replace(COALESCE(tran.owner_type,&#x27;0&#x27;),&#x27;sys.admin.orgs,&#x27;,&#x27;&#x27;),&#x27;9999999&#x27;) left join sys_admin_orgs org on org.id = tran.stk_org_id left join mdm_warehouse ware on tran.warehouse_id = ware.id left join mdm_warehouse_line1 loca on tran.location_id = loca.id left join mdm_unit unit on &#123;uom&#125; = unit.id where ia.accting_sys_id = &#123;sys&#125; and ia.accting_org_id = &#123;org&#125; and ia.accting_policy_id = &#123;policy&#125; and ia.biz_date &gt;= &#x27;&#123;start_date&#125;&#x27; and ia.biz_date &lt;= &#x27;&#123;end_date&#125;&#x27; and ia.doc_line_model = &#x27;ia.cost.adjustment.line1&#x27; &#123;_init_where&#125; &quot;&quot;&quot;.format( table=name, uom=uom, qty=qty, calendar=calendar_id, sys=acct_sys_id, org=acct_org_id, policy=acct_policy_id, start_date=start_date, end_date=end_date, _where=_where, _init_where=_init_where ) self.env.cr.execute(sql) # 出库数量取值 qty = &#x27;case when tran.id is not null then tran.qty * cast(tran.qty_option as int) * -1 else inter_doc.qty * cast(inter_doc.qty_option as int) * -1 end&#x27; if unit_type == &#x27;display_in_stk_units&#x27;: qty = &#x27;case when tran.id is not null then tran.material_stk_qty * cast(tran.qty_option as int) * -1 else inter_doc.material_stk_qty * cast(inter_doc.qty_option as int) * -1 end&#x27; # 3.插入出库成本结果表数据 sql = &quot;&quot;&quot; insert into &#123;table&#125; ( src_parent_model, src_parent_id, acct_year, acct_period, category_id, material_group_name, material_id, material_number, material_name, specification, auxiliary, lot, bom_version_name, mto_num, owner_type, stk_org_name, warehouse_name, location_name, uom_id, uom_precision, uom_name, accting_dimensions_id, out_qty, out_amount, stk_key ) select COALESCE(tran.src_parent_model, inter_doc.src_parent_model) src_parent_model, COALESCE(tran.src_parent_id, inter_doc.src_parent_id) src_parent_id, period.acct_year, period.acct_period, mat.category_id, gro.name, ia.material_id, mat.number, mat.name, mat.specification, COALESCE(tran.auxiliary, inter_doc.auxiliary) auxiliary, COALESCE(tran.lot, inter_doc.lot) lot, bom.version_number, COALESCE(tran.mto_num, inter_doc.mto_num) mto_num, owner.name, org.name, ware.name, loca.name, &#123;uom&#125;, unit.precision, unit.name, ia.accting_dimensions_id, &#123;qty&#125;, ia.cost_amount, case when tran.id is not null then concat_ws( &#x27;_&#x27;, tran.material_id, tran.uom_id, COALESCE(tran.lot, &#x27;null&#x27;), COALESCE(tran.auxiliary, &#x27;null&#x27;), COALESCE(tran.bom_version_id, 0), COALESCE(tran.mto_num, &#x27;null&#x27;), COALESCE(tran.warehouse_id, 0), COALESCE(tran.location_id, 0), COALESCE(tran.stk_org_id, 0), COALESCE(&#x27;sys.admin.orgs,&#x27; || case when dim.owner_type_value != &#x27;0&#x27; then dim.owner_type_value else replace(tran.ia_owner_type,&#x27;sys.admin.orgs,&#x27;,&#x27;&#x27;) end, &#x27;null&#x27;) ) else concat_ws( &#x27;_&#x27;, ia.material_id, mat.uom_id, COALESCE(inter_doc.lot, &#x27;null&#x27;), COALESCE(inter_doc.auxiliary, &#x27;null&#x27;), COALESCE(inter_doc.bom_version_id, 0), COALESCE(inter_doc.mto_num, &#x27;null&#x27;), COALESCE(inter_doc.warehouse_id, 0), COALESCE(inter_doc.location_id, 0), COALESCE(inter_doc.stk_org_id, 0), COALESCE(&#x27;sys.admin.orgs,&#x27; || case when dim.owner_type_value != &#x27;0&#x27; then dim.owner_type_value else replace(inter_doc.ia_owner_type,&#x27;sys.admin.orgs,&#x27;,&#x27;&#x27;) end, &#x27;null&#x27;) ) end from ia_out_result ia left join ia_accting_dimensions dim on ia.accting_dimensions_id = dim.id left join stk_tran_detail tran on tran.src_id = ia.doc_line_id and tran.src_model = ia.doc_line_model and (case when tran.src_model = &#x27;stk.direct.trans.line1&#x27; and tran.source_line1_model is null then tran.qty_option = &#x27;-1&#x27; when tran.src_model = &#x27;stk.direct.trans.line1&#x27; and tran.source_line1_model is not null then tran.qty_option = &#x27;1&#x27; when tran.src_model = &#x27;medinv.direct.trans.line1&#x27; then tran.qty_option = &#x27;-1&#x27; else true end) left join ia_inter_transaction inter_doc on inter_doc.src_id = ia.doc_line_id and inter_doc.src_model = ia.doc_line_model left join mdm_account_calendar_line1 period on period.parent_id = &#123;calendar&#125; and period.start_date &lt;= ia.biz_date and period.end_date &gt;= ia.biz_date left join mdm_material mat on ia.material_id = mat.id left join mdm_material_group gro on mat.material_group = gro.id left join mdm_product_bom bom on bom.id = COALESCE(tran.bom_version_id, inter_doc.bom_version_id) left join sys_admin_orgs owner on owner.id = to_number(case when dim.owner_type_value != &#x27;0&#x27; then dim.owner_type_value else replace(COALESCE(tran.ia_owner_type, inter_doc.ia_owner_type),&#x27;sys.admin.orgs,&#x27;,&#x27;&#x27;) end,&#x27;9999999&#x27;) left join sys_admin_orgs org on org.id = COALESCE(tran.stk_org_id, inter_doc.stk_org_id) left join mdm_warehouse ware on ware.id = COALESCE(tran.warehouse_id, inter_doc.warehouse_id) left join mdm_warehouse_line1 loca on loca.id = COALESCE(tran.location_id, inter_doc.location_id) left join mdm_unit unit on &#123;uom&#125; = unit.id where ia.accting_sys_id = &#123;sys&#125; and ia.accting_org_id = &#123;org&#125; and ia.accting_policy_id = &#123;policy&#125; and ia.biz_date &gt;= &#x27;&#123;start_date&#125;&#x27; and ia.biz_date &lt;= &#x27;&#123;end_date&#125;&#x27; and ia.doc_line_model != &#x27;ia.cost.adjustment.line1&#x27; &#123;_where&#125; union all select &#x27;ia.cost.adjustment&#x27;, tran.parent_id, period.acct_year, period.acct_period, mat.category_id, gro.name, ia.material_id, mat.number, mat.name, mat.specification, tran.auxiliary, tran.lot, bom.version_number, tran.mto_number, owner.name, org.name, ware.name, loca.name, &#123;uom&#125;, unit.precision, unit.name, ia.accting_dimensions_id, 0, ia.cost_amount, concat_ws( &#x27;_&#x27;, tran.material_id, tran.uom_id, COALESCE(tran.lot, &#x27;null&#x27;), COALESCE(tran.auxiliary, &#x27;null&#x27;), COALESCE(tran.bom_version_id, 0), COALESCE(tran.mto_number, &#x27;null&#x27;), COALESCE(tran.warehouse_id, 0), COALESCE(tran.location_id, 0), COALESCE(tran.stk_org_id, 0), COALESCE(tran.owner_type, &#x27;null&#x27;) ) from ia_out_result ia left join ia_accting_dimensions dim on ia.accting_dimensions_id = dim.id left join ia_cost_adjustment_line1 tran on tran.id = ia.doc_line_id left join mdm_account_calendar_line1 period on period.parent_id = &#123;calendar&#125; and period.start_date &lt;= ia.biz_date and period.end_date &gt;= ia.biz_date left join mdm_material mat on ia.material_id = mat.id left join mdm_material_group gro on mat.material_group = gro.id left join mdm_product_bom bom on tran.bom_version_id = bom.id left join sys_admin_orgs owner on owner.id = to_number(replace(COALESCE(tran.owner_type,&#x27;0&#x27;),&#x27;sys.admin.orgs,&#x27;,&#x27;&#x27;),&#x27;9999999&#x27;) left join sys_admin_orgs org on org.id = tran.stk_org_id left join mdm_warehouse ware on tran.warehouse_id = ware.id left join mdm_warehouse_line1 loca on tran.location_id = loca.id left join mdm_unit unit on &#123;uom&#125; = unit.id where ia.accting_sys_id = &#123;sys&#125; and ia.accting_org_id = &#123;org&#125; and ia.accting_policy_id = &#123;policy&#125; and ia.biz_date &gt;= &#x27;&#123;start_date&#125;&#x27; and ia.biz_date &lt;= &#x27;&#123;end_date&#125;&#x27; and ia.doc_line_model = &#x27;ia.cost.adjustment.line1&#x27; &#123;_init_where&#125; &quot;&quot;&quot;.format( table=name, uom=uom, qty=qty, calendar=calendar_id, sys=acct_sys_id, org=acct_org_id, policy=acct_policy_id, start_date=start_date, end_date=end_date, _where=_where, _init_where=_init_where ) self.env.cr.execute(sql) # 库存单位为基准，存货余额表只存基本单位数量，期初数量更新为库存数量 if unit_type == &#x27;display_in_stk_units&#x27;: # 更新成本调整单及期初的库存单位名称，期初的期初数量 update_sql = &quot;&quot;&quot; update &#123;table&#125; tab set uom_id = stk_unit.id, uom_precision = stk_unit.precision, uom_name = stk_unit.name, init_qty = ( case when stk_unit.group_id = unit.group_id then init_qty * stk_unit.convert_denominator / stk_unit.convert_numerator else ( case when stk_unit.is_datum_unit = &#x27;t&#x27; then init_qty * con.convert_denominator / con.convert_numerator else init_qty * con.convert_denominator / con.convert_numerator * stk_unit.convert_denominator / stk_unit.convert_numerator end ) end ), first_init_qty = ( case when stk_unit.group_id = unit.group_id then first_init_qty * stk_unit.convert_denominator / stk_unit.convert_numerator else ( case when stk_unit.is_datum_unit = &#x27;t&#x27; then first_init_qty * con.convert_denominator / con.convert_numerator else first_init_qty * con.convert_denominator / con.convert_numerator * stk_unit.convert_denominator / stk_unit.convert_numerator end ) end ) from mdm_material mat left join mdm_unit stk_unit on mat.stk_uom_id = stk_unit.id left join mdm_unit_group gro on stk_unit.group_id = gro.id left join mdm_unit unit on mat.uom_id = unit.id left join mdm_unit_conversion con on con.material_id = mat.id and con.dest_unit_id = gro.datum_unit_id where tab.material_id = mat.id and mat.uom_id != mat.stk_uom_id &quot;&quot;&quot;.format(table=name,org_id=acct_org_id) self.env.cr.execute(update_sql) # 更新不同分类的数量金额 in_pur_model = &quot;(&#x27;stk.pur.receipt&#x27;, &#x27;stk.pur.return&#x27;, &#x27;med.gsp.pur.receipt&#x27;, &#x27;med.gsp.purchase.return&#x27;)&quot; in_pro_model = &quot;(&#x27;stk.pro.in&#x27;, &#x27;stk.pro.out&#x27;, &#x27;stk.simple.pro.in&#x27;, &#x27;stk.simple.pro.out&#x27;)&quot; in_trans_model = &quot;(&#x27;stk.direct.trans&#x27;, &#x27;stk.step.trans.in&#x27;, &#x27;medinv.direct.trans&#x27;)&quot; in_other_model = &quot;(&#x27;stk.form.conversion&#x27;, &#x27;stk.mis.in&#x27;, &#x27;stk.pack&#x27;, &#x27;stk.unpack&#x27;, &#x27;stk.count&#x27;)&quot; out_sal_model = &quot;(&#x27;stk.delivery&#x27;, &#x27;stk.return&#x27;, &#x27;med.stk.delivery&#x27;, &#x27;med.inv.sal.return&#x27;)&quot; out_pro_model = &quot;(&#x27;stk.pro.pick&#x27;, &#x27;stk.pro.material.return&#x27;, &#x27;stk.pro.feed&#x27;, &#x27;stk.sub.pick&#x27;, &#x27;stk.sub.return&#x27;, &#x27;stk.sub.supplement&#x27;, &#x27;stk.simple.pro.pick&#x27;, &#x27;stk.simple.pro.return&#x27;)&quot; out_trans_model = &quot;(&#x27;stk.direct.trans&#x27;, &#x27;stk.step.trans.out&#x27;, &#x27;medinv.direct.trans&#x27;)&quot; out_other_model = &quot;(&#x27;stk.form.conversion&#x27;, &#x27;stk.mis.out&#x27;, &#x27;stk.pack&#x27;, &#x27;stk.unpack&#x27;, &#x27;stk.count&#x27;,&#x27;med.unqualified.comm.bookkeeping&#x27;)&quot; update_sql = &quot;&quot;&quot; update &#123;table&#125; tab set in_pur_qty = case when src_parent_model in &#123;in_pur_model&#125; then in_qty else 0 end, in_pur_amount = case when src_parent_model in &#123;in_pur_model&#125; then in_amount else 0 end, in_pro_qty = case when src_parent_model in &#123;in_pro_model&#125; then in_qty else 0 end, in_pro_amount = case when src_parent_model in &#123;in_pro_model&#125; then in_amount else 0 end, in_trans_qty = case when src_parent_model in &#123;in_trans_model&#125; then in_qty else 0 end, in_trans_amount = case when src_parent_model in &#123;in_trans_model&#125; then in_amount else 0 end, in_adjust_qty = case when src_parent_model = &#x27;ia.cost.adjustment&#x27; then in_qty else 0 end, in_adjust_amount = case when src_parent_model = &#x27;ia.cost.adjustment&#x27; then in_amount else 0 end, in_count_qty = case when src_parent_model = &#x27;stk.inventory.profit&#x27; then in_qty else 0 end, in_count_amount = case when src_parent_model = &#x27;stk.inventory.profit&#x27; then in_amount else 0 end, in_other_qty = case when src_parent_model in &#123;in_other_model&#125; then in_qty else 0 end, in_other_amount = case when src_parent_model in &#123;in_other_model&#125; then in_amount else 0 end, out_sal_qty = case when src_parent_model in &#123;out_sal_model&#125; then out_qty else 0 end, out_sal_amount = case when src_parent_model in &#123;out_sal_model&#125; then out_amount else 0 end, out_pro_qty = case when src_parent_model in &#123;out_pro_model&#125; then out_qty else 0 end, out_pro_amount = case when src_parent_model in &#123;out_pro_model&#125; then out_amount else 0 end, out_count_qty = case when src_parent_model = &#x27;stk.inventory.loss&#x27; then out_qty else 0 end, out_count_amount = case when src_parent_model = &#x27;stk.inventory.loss&#x27; then out_amount else 0 end, out_trans_qty = case when src_parent_model in &#123;out_trans_model&#125; then out_qty else 0 end, out_trans_amount = case when src_parent_model in &#123;out_trans_model&#125; then out_amount else 0 end, out_adjust_qty = case when src_parent_model = &#x27;ia.cost.adjustment&#x27; then out_qty else 0 end, out_adjust_amount = case when src_parent_model = &#x27;ia.cost.adjustment&#x27; then out_amount else 0 end, out_other_qty = case when src_parent_model in &#123;out_other_model&#125; then out_qty else 0 end, out_other_amount = case when src_parent_model in &#123;out_other_model&#125; then out_amount else 0 end where src_parent_model is not null &quot;&quot;&quot;.format( table=name, in_pur_model=in_pur_model, in_pro_model=in_pro_model, in_trans_model=in_trans_model,in_other_model=in_other_model, out_sal_model=out_sal_model, out_pro_model=out_pro_model, out_trans_model=out_trans_model,out_other_model=out_other_model ) self.env.cr.execute(update_sql) # group by 之后将数据插入临时表 self.env.cr.execute(&quot;drop table if exists &#123;table&#125;;&quot;.format(table=_line_table)) if display_dimensions == &#x27;storge_dimension&#x27;: sql = &quot;&quot;&quot; create unlogged table &#123;_line_table&#125; as select acct_year, max(acct_period) acct_period, max(category_id) category_id, max(material_group_name) material_group_name, max(material_id) material_id, max(material_number) material_number, max(material_name) material_name, max(specification) specification, max(auxiliary) auxiliary, max(lot) lot, max(bom_version_name) bom_version_name, max(mto_num) mto_num, max(owner_type) owner_type, max(stk_org_name) stk_org_name, max(warehouse_name) warehouse_name, max(location_name) location_name, max(uom_id) uom_id, max(uom_precision) uom_precision, max(uom_name) uom_name, max(accting_dimensions_id) accting_dimensions_id, sum(init_qty) init_qty, sum(init_amount) init_amount, sum(in_qty) in_qty, sum(in_amount) in_amount, sum(out_qty) out_qty, sum(out_amount) out_amount, sum(in_pur_qty) in_pur_qty, sum(in_pur_amount) in_pur_amount, sum(in_pro_qty) in_pro_qty, sum(in_pro_amount) in_pro_amount, sum(in_count_qty) in_count_qty, sum(in_count_amount) in_count_amount, sum(in_trans_qty) in_trans_qty, sum(in_trans_amount) in_trans_amount, sum(in_adjust_qty) in_adjust_qty, sum(in_adjust_amount) in_adjust_amount, sum(in_other_qty) in_other_qty, sum(in_other_amount) in_other_amount, sum(out_sal_qty) out_sal_qty, sum(out_sal_amount) out_sal_amount, sum(out_pro_qty) out_pro_qty, sum(out_pro_amount) out_pro_amount, sum(out_count_qty) out_count_qty, sum(out_count_amount) out_count_amount, sum(out_trans_qty) out_trans_qty, sum(out_trans_amount) out_trans_amount, sum(out_adjust_qty) out_adjust_qty, sum(out_adjust_amount) out_adjust_amount, sum(out_other_qty) out_other_qty, sum(out_other_amount) out_other_amount, sum(init_qty) + sum(in_qty) - sum(out_qty) balance_qty, sum(init_amount) + sum(in_amount) - sum(out_amount) balance_amount, stk_key, 0 sort_sign, sum(first_init_qty) first_init_qty, sum(first_init_amount) first_init_amount from &#123;table&#125; group by stk_key, acct_year&#123;is_group_year&#125; &quot;&quot;&quot;.format(_line_table=_line_table, table=name, is_group_year=(&#x27;&#x27; if presentation_time_dimension == &#x27;acct_year&#x27; else &#x27;, acct_period&#x27;)) else: sql = &quot;&quot;&quot; create unlogged table &#123;_line_table&#125; as select acct_year, max(acct_period) acct_period, max(category_id) category_id, max(material_group_name) material_group_name, max(material_id) material_id, max(material_number) material_number, max(material_name) material_name, max(specification) specification, case when max(dim.auxiliary_value) not in (&#x27;0&#x27;, &#x27;@@&#x27;) then max(auxiliary) else &#x27;&#x27; end as auxiliary, case when max(dim.lot_value) not in (&#x27;0&#x27;, &#x27;@@&#x27;) then max(lot) else &#x27;&#x27; end as lot, case when max(dim.bom_version_id_value) not in (&#x27;0&#x27;, &#x27;@@&#x27;) then max(bom_version_name) else &#x27;&#x27; end as bom_version_name, case when max(dim.mto_number_value) not in (&#x27;0&#x27;, &#x27;@@&#x27;) then max(mto_num) else &#x27;&#x27; end as mto_num, case when max(dim.owner_type_value) not in (&#x27;0&#x27;, &#x27;@@&#x27;) then max(owner_type) else &#x27;&#x27; end as owner_type, case when max(dim.stk_org_id_value) not in (&#x27;0&#x27;, &#x27;@@&#x27;) then max(stk_org_name) else &#x27;&#x27; end as stk_org_name, case when max(dim.warehouse_id_value) not in (&#x27;0&#x27;, &#x27;@@&#x27;) then max(warehouse_name) else &#x27;&#x27; end as warehouse_name, case when max(dim.location_id_value) not in (&#x27;0&#x27;, &#x27;@@&#x27;) then max(location_name) else &#x27;&#x27; end as location_name, max(uom_id) uom_id, max(uom_precision) uom_precision, max(uom_name) uom_name, accting_dimensions_id, sum(init_qty) init_qty, sum(init_amount) init_amount, sum(in_qty) in_qty, sum(in_amount) in_amount, sum(out_qty) out_qty, sum(out_amount) out_amount, sum(in_pur_qty) in_pur_qty, sum(in_pur_amount) in_pur_amount, sum(in_pro_qty) in_pro_qty, sum(in_pro_amount) in_pro_amount, sum(in_count_qty) in_count_qty, sum(in_count_amount) in_count_amount, sum(in_trans_qty) in_trans_qty, sum(in_trans_amount) in_trans_amount, sum(in_adjust_qty) in_adjust_qty, sum(in_adjust_amount) in_adjust_amount, sum(in_other_qty) in_other_qty, sum(in_other_amount) in_other_amount, sum(out_sal_qty) out_sal_qty, sum(out_sal_amount) out_sal_amount, sum(out_pro_qty) out_pro_qty, sum(out_pro_amount) out_pro_amount, sum(out_count_qty) out_count_qty, sum(out_count_amount) out_count_amount, sum(out_trans_qty) out_trans_qty, sum(out_trans_amount) out_trans_amount, sum(out_adjust_qty) out_adjust_qty, sum(out_adjust_amount) out_adjust_amount, sum(out_other_qty) out_other_qty, sum(out_other_amount) out_other_amount, sum(init_qty) + sum(in_qty) - sum(out_qty) balance_qty, sum(init_amount) + sum(in_amount) - sum(out_amount) balance_amount, max(stk_key) stk_key, 0 sort_sign, sum(first_init_qty) first_init_qty, sum(first_init_amount) first_init_amount from &#123;table&#125; tab left join ia_accting_dimensions dim on tab.accting_dimensions_id = dim.id group by accting_dimensions_id, acct_year&#123;is_group_year&#125; &quot;&quot;&quot;.format(_line_table=_line_table, table=name, is_group_year=(&#x27;&#x27; if presentation_time_dimension == &#x27;acct_year&#x27; else &#x27;, acct_period&#x27;)) self.env.cr.execute(sql) # 插入合计行 self.env.cr.execute(&quot;&quot;&quot;select 1 from &#123;_line_table&#125; limit 1&quot;&quot;&quot;.format(_line_table=_line_table)) tab_count = self.env.cr.fetchone() if tab_count: query = &quot;&quot;&quot; insert into &#123;_line_table&#125; ( acct_year, init_qty, init_amount, in_qty, in_amount, out_qty, out_amount, balance_qty, balance_amount, in_pur_qty, in_pur_amount, in_pro_qty, in_pro_amount, in_count_qty, in_count_amount, in_trans_qty, in_trans_amount, in_adjust_qty, in_adjust_amount, in_other_qty, in_other_amount, out_sal_qty, out_sal_amount, out_pro_qty, out_pro_amount, out_count_qty, out_count_amount, out_trans_qty, out_trans_amount, out_adjust_qty, out_adjust_amount, out_other_qty, out_other_amount, sort_sign ) select &#x27;合计&#x27;, sum(first_init_qty), sum(first_init_amount), sum(in_qty), sum(in_amount), sum(out_qty), sum(out_amount), sum(first_init_qty)+sum(in_qty)-sum(out_qty), sum(first_init_amount)+sum(in_amount)-sum(out_amount), sum(in_pur_qty), sum(in_pur_amount), sum(in_pro_qty), sum(in_pro_amount), sum(in_count_qty), sum(in_count_amount), sum(in_trans_qty), sum(in_trans_amount), sum(in_adjust_qty), sum(in_adjust_amount), sum(in_other_qty), sum(in_other_amount), sum(out_sal_qty), sum(out_sal_amount), sum(out_pro_qty), sum(out_pro_amount), sum(out_count_qty), sum(out_count_amount), sum(out_trans_qty), sum(out_trans_amount), sum(out_adjust_qty), sum(out_adjust_amount), sum(out_other_qty), sum(out_other_amount), 1 from &#123;_line_table&#125; &quot;&quot;&quot;.format(_line_table=_line_table) self.env.cr.execute(query) # 汇总依据 summary_basis = domain_fields.get(&#x27;summary_basis&#x27;) if summary_basis: if summary_basis == &#x27;material_group_ids&#x27;: _group = &#x27;material_group_name&#x27; _group_by = &#x27;group by material_group_name&#x27; else: _group = &#x27;category_id&#x27; _group_by = &#x27;group by category_id&#x27; # 插入小计行 query = &quot;&quot;&quot; insert into &#123;_line_table&#125; ( acct_year, &#123;_group&#125;, init_qty, init_amount, in_qty, in_amount, out_qty, out_amount, balance_qty, balance_amount, in_pur_qty, in_pur_amount, in_pro_qty, in_pro_amount, in_count_qty, in_count_amount, in_trans_qty, in_trans_amount, in_adjust_qty, in_adjust_amount, in_other_qty, in_other_amount, out_sal_qty, out_sal_amount, out_pro_qty, out_pro_amount, out_count_qty, out_count_amount, out_trans_qty, out_trans_amount, out_adjust_qty, out_adjust_amount, out_other_qty, out_other_amount, sort_sign ) select &#x27;小计&#x27;, &#123;_group&#125;, sum(init_qty), sum(init_amount), sum(in_qty), sum(in_amount), sum(out_qty), sum(out_amount), sum(balance_qty), sum(balance_amount), sum(in_pur_qty), sum(in_pur_amount), sum(in_pro_qty), sum(in_pro_amount), sum(in_count_qty), sum(in_count_amount), sum(in_trans_qty), sum(in_trans_amount), sum(in_adjust_qty), sum(in_adjust_amount), sum(in_other_qty), sum(in_other_amount), sum(out_sal_qty), sum(out_sal_amount), sum(out_pro_qty), sum(out_pro_amount), sum(out_count_qty), sum(out_count_amount), sum(out_trans_qty), sum(out_trans_amount), sum(out_adjust_qty), sum(out_adjust_amount), sum(out_other_qty), sum(out_other_amount), 0 from &#123;_line_table&#125; where acct_year != &#x27;合计&#x27; &#123;_group_by&#125; &quot;&quot;&quot;.format(_line_table=_line_table, _group=_group, _group_by=_group_by) self.env.cr.execute(query) 查询数据 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667SELECT tran.accting_year acct_year, tran.accting_period acct_period, mat.category_id, gro.NAME, mat.ID, mat.NUMBER, mat.NAME, mat.specification, tran.auxiliary, tran.lot, BOM.version_number, tran.mto_num, OWNER.NAME, org.NAME, ware.NAME, loca.NAME, tran.uom_id, unit.PRECISION, unit.NAME, tran.accting_dimensions_id, tran.init_qty, tran.init_amount, concat_ws ( &#x27;_&#x27;, tran.material_id, tran.uom_id, COALESCE ( tran.lot, &#x27;null&#x27; ), COALESCE ( tran.auxiliary, &#x27;null&#x27; ), COALESCE ( tran.bom_version_id, 0 ), COALESCE ( tran.mto_num, &#x27;null&#x27; ), COALESCE ( tran.warehouse_id, 0 ), COALESCE ( tran.location_id, 0 ), COALESCE ( tran.stk_org_id, 0 ), COALESCE ( tran.owner_type, &#x27;null&#x27; ) ), CASE WHEN tran.accting_year = &#x27;2024&#x27; AND tran.accting_period = &#x27;08&#x27; THEN tran.init_qty ELSE 0 END, CASE WHEN tran.accting_year = &#x27;2024&#x27; AND tran.accting_period = &#x27;08&#x27; THEN tran.init_amount ELSE 0 END FROM ia_balance tran --存货余额表 LEFT JOIN ia_accting_dimensions dim ON tran.accting_dimensions_id = dim.ID --存货管理存货核算维度表 LEFT JOIN mdm_material mat ON tran.material_id = mat.ID -- 物料 LEFT JOIN mdm_material_group gro ON mat.material_group = gro.ID -- 物料组 LEFT JOIN mdm_product_bom BOM ON tran.bom_version_id = BOM.ID -- 物料清单 LEFT JOIN sys_admin_orgs OWNER ON OWNER.ID = to_number( -- 组织机构 REPLACE ( COALESCE ( tran.owner_type, &#x27;0&#x27; ), &#x27;sys.admin.orgs,&#x27;, &#x27;&#x27; ), &#x27;9999999&#x27; ) LEFT JOIN sys_admin_orgs org ON org.ID = tran.stk_org_id -- 组织机构 LEFT JOIN mdm_warehouse ware ON tran.warehouse_id = ware.ID -- 仓库 LEFT JOIN mdm_warehouse_line1 loca ON tran.location_id = loca.ID -- 仓库表体 LEFT JOIN mdm_unit unit ON tran.uom_id = unit.ID -- 计量单位WHERE tran.accting_sys_id = 1 AND tran.accting_org_id = 1 AND tran.accting_policy_id = 1 AND tran.accting_year = &#x27;2024&#x27; AND tran.accting_period = &#x27;08&#x27;;","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"医药公司ERP","slug":"项目/医药公司ERP","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/"},{"name":"业务","slug":"项目/医药公司ERP/业务","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/%E4%B8%9A%E5%8A%A1/"}],"tags":[]},{"title":"odoo知识点(五)-PostgreSQL","slug":"odoo/odoo知识点5-PostgreSQL","date":"2023-08-19T12:50:52.000Z","updated":"2025-08-19T08:09:56.941Z","comments":true,"path":"2023/08/19/odoo/odoo知识点5-PostgreSQL/","link":"","permalink":"https://dbbruce.github.io/2023/08/19/odoo/odoo%E7%9F%A5%E8%AF%86%E7%82%B95-PostgreSQL/","excerpt":"1.进入psql psql (本机数据库，直接进入) psql -h 地址 -p 端口 -U 用户名 -d 数据库名1psql -h localhost -p 5432 -U postgres runoobdb","text":"1.进入psql psql (本机数据库，直接进入) psql -h 地址 -p 端口 -U 用户名 -d 数据库名1psql -h localhost -p 5432 -U postgres runoobdb 1.创建数据库1CREATE DATABASE runoobdb; 123$ cd /Library/PostgreSQL/11/bin/$ createdb -h localhost -p 5432 -U postgres runoobdbpassword ****** 2.创建角色 查看角色： \\du 创建角色： CREATE USER 角色名 WITH PASSWORD ‘密码’ create user odoo15 with password ‘odoo15’; 超级权限： alter role odoo15 with superuser; 删除用户 drop role odoo15; 3.创建数据库 查看数据库： \\l 创建数据库： CREATE DATABASE 数据库名 WITH OWNER 角色名; create database odoo15_db owner odoo15; 数据库权限： grant all privileges on database odoo15_db to odoo15; 删除数据库 drop database odoo15_db; 4.修改PG配置文件12345678910(odoo16) dbbruce@dbburce var-14 % pwd/Users/dbbruce/Library/Application Support/Postgres/var-14(odoo16) dbbruce@dbburce var-14 % vim pg_hba.conf 88 # &quot;local&quot; is for Unix domain socket connections only 89 local all all trust 90 # IPv4 local connections: 91 host all all 127.0.0.1/32 trust 92 # IPv6 local connections: 93 host all all ::1/128 trust 5.数据导入 psql -d yiyao -h 127.0.0.1 -p 5432 -U odoo17 -f &#x2F;Users&#x2F;dbbruce&#x2F;Downloads&#x2F;yiyao&#x2F;dump.sql 6.进入数据库 \\c + 数据库名12postgres=# \\c runoobdbYou are now connected to database &quot;runoobdb&quot; as user &quot;postgres&quot;. 7.查看已经存在的数据库 \\l12345678910runoobdb=# \\l dbbruce | dbbruce | UTF8 | en_US.UTF-8 | en_US.UTF-8 | odoo16_db | odoo16 | UTF8 | en_US.UTF-8 | en_US.UTF-8 | =Tc/odoo16 + | | | | | odoo16=CTc/odoo16 postgres | postgres | UTF8 | en_US.UTF-8 | en_US.UTF-8 | runoobdb | dbbruce | UTF8 | en_US.UTF-8 | en_US.UTF-8 | template0 | postgres | UTF8 | en_US.UTF-8 | en_US.UTF-8 | =c/postgres + | | | | | postgres=CTc/postgres template1 | postgres | UTF8 | en_US.UTF-8 | en_US.UTF-8 | =c/postgres + | | | | | postgres=CTc/postgres 8.删除数据库1DROP DATABASE runoobdb; 123$ cd /Library/PostgreSQL/11/bin/$ dropdb -h localhost -p 5432 -U postgres runoobdbpassword ****** 9.查询表 - \\d12345678910runoobdb=# \\d public | company | table | dbbrucerunoobdb=# \\d company id | integer | | not null | name | text | | not null | age | integer | | not null | address | character(50) | | | salary | real | | | 10.创建表123456789101112runoobdb=# CREATE TABLE COMPANY( CREATE TABLE COMPANY( ID INT PRIMARY KEY NOT NULL, NAME TEXT NOT NULL, AGE INT NOT NULL, ADDRESS CHAR(50), SALARY REAL);CREATE TABLErunoobdb=# \\d public | company | table | dbbruce 11.删除表12runoobdb=# drop table department, company;DROP TABLE 12.查看表结构123456runoobdb=# \\d company; id | integer | | not null | name | text | | not null | age | integer | | not null | address | character(50) | | | salary | real | | | 13.PostgreSQL 模式（SCHEMA） CREATE SCHEMA myschema ( … ); 123PostgreSQL 模式（SCHEMA）可以看着是一个表的集合。一个模式可以包含视图、索引、数据类型、函数和操作符等。相同的对象名称可以被用于不同的模式中而不会出现冲突，例如 schema1 和 myschema 都可以包含名为 mytable 的表 接下来我们连接到 runoobdb 来创建模式 myschema：1234runoobdb=# create schema myschema;CREATE SCHEMA#输出结果 &quot;CREATE SCHEMA&quot; 就代表模式创建成功。 接下来我们再创建一个表格：12345678runoobdb=# create table myschema.company( ID INT NOT NULL, NAME VARCHAR (20) NOT NULL, AGE INT NOT NULL, ADDRESS CHAR (25), SALARY DECIMAL (18, 2), PRIMARY KEY (ID)); 14.删除模式 删除一个为空的模式（其中的所有对象已经被删除）：1DROP SCHEMA myschema; 删除一个模式以及其中包含的所有对象：1DROP SCHEMA myschema CASCADE; 15.with123WITH 子句有助于将复杂的大型查询分解为更简单的表单，便于阅读。这些语句通常称为通用表表达式（Common Table Express， CTE），也可以当做一个为查询而存在的临时表。WITH 子句是在多次执行子查询时特别有用，允许我们在查询中通过它的名称(可能是多次)引用它。WITH 子句在使用前必须先定义。 1With CTE AS (Select ID , NAME , AGE , ADDRESS , SALARY FROM COMPANY ) Select * From CTE; 16.HAVING 子句可以让我们筛选分组后的各组数据。1SELECT NAME FROM COMPANY GROUP BY name HAVING count(name) &lt; 2; 17.PostgreSQL 约束12345678910PostgreSQL 约束用于规定表中的数据规则。如果存在违反约束的数据行为，行为会被约束终止。以下是在 PostgreSQL 中常用的约束。NOT NULL：指示某列不能存储 NULL 值。UNIQUE：确保某列的值都是唯一的。PRIMARY Key：NOT NULL 和 UNIQUE 的结合。确保某列（或两个列多个列的结合）有唯一标识，有助于更容易更快速地找到表中的一个特定的记录。。FOREIGN Key： 通常一个表中的 FOREIGN KEY 指向另一个表中的 UNIQUE KEY(唯一约束的键)，即维护了两个相关表之间的引用完整性。CHECK： 保证列中的值符合指定的条件。EXCLUSION ：排他约束，保证如果将任何两行的指定列或表达式使用指定操作符进行比较，至少其中一个操作符比较将会返回 false 或空值。 1234567runoobdb=# \\d company id | integer | | not null | name | text | | not null | age | integer | | not null | address | character(50) | | | salary | real | | | join_date | date | | | CHECK 约束1234567CREATE TABLE COMPANY5( ID INT PRIMARY KEY NOT NULL, NAME TEXT NOT NULL, AGE INT NOT NULL, ADDRESS CHAR(50), SALARY REAL CHECK(SALARY &gt; 0)); EXCLUSION 约束12345678910CREATE TABLE COMPANY7( ID INT PRIMARY KEY NOT NULL, NAME TEXT, AGE INT , ADDRESS CHAR(50), SALARY REAL, EXCLUDE USING gist (NAME WITH =, -- 如果满足 NAME 相同，AGE 不相同则不允许插入，否则允许插入 AGE WITH &lt;&gt;) -- 其比较的结果是如果整个表达式返回 true，则不允许插入，否则允许); 18.PostgreSQL 连接(JOIN)在 PostgreSQL 中，JOIN 有五种连接类型： 连接类型 中文 描述 CROSS JOIN 交叉连接 (a表与b表，交叉组合) 把第一个表的每一行与第二个表的每一行进行匹配。如果两个输入表分别有 x 和 y 行，则结果表有 x*y 行。 INNER JOIN 内连接 根据连接谓词结合两个表（table1 和 table2）的列值来创建一个新的结果表。查询会把 table1 中的每一行与 table2 中的每一行进行比较，找到所有满足连接谓词的行的匹配对 LEFT OUTER JOIN 左外连接 已左表为基准，左表中每一行至少有一行，右表没有匹配的，使用null匹配 RIGHT OUTER JOIN 右外连接 对于表T2中不满足表T1中连接条件的每一行，其中T1列中的值为空也会添加一个连接行 FULL OUTER JOIN 全外连接 对于表 T1 中不满足表 T2 中任何行连接条件的每一行，如果 T2 的列中有 null 值也会添加一个到结果中。此外，对于 T2 中不满足与 T1 中的任何行连接条件的每一行，将会添加 T1 列中包含 null 值的到结果中 CROSS JOIN1SELECT EMP_ID, NAME, DEPT FROM COMPANY CROSS JOIN DEPARTMENT; INNER JOIN1234SELECT table1.column1, table2.column2FROM table1INNER JOIN table2ON table1.common_filed = table2.common_field; LEFT OUTER JOIN1SELECT EMP_ID, NAME, DEPT FROM COMPANY LEFT OUTER JOIN DEPARTMENT ON COMPANY.ID = DEPARTMENT.EMP_ID; RIGHT OUTER JOIN1SELECT EMP_ID, NAME, DEPT FROM COMPANY RIGHT OUTER JOIN DEPARTMENT ON COMPANY.ID = DEPARTMENT.EMP_ID; FULL OUTER JOIN1SELECT EMP_ID, NAME, DEPT FROM COMPANY FULL OUTER JOIN DEPARTMENT ON COMPANY.ID = DEPARTMENT.EMP_ID; 19.UNION 操作符合并两个或多个 SELECT 语句的结果注意：重复项会被删除，只保留一条 12345SELECT EMP_ID, NAME, DEPT FROM COMPANY INNER JOIN DEPARTMENT ON COMPANY.ID = DEPARTMENT.EMP_ID UNIONSELECT EMP_ID, NAME, DEPT FROM COMPANY LEFT OUTER JOIN DEPARTMENT ON COMPANY.ID = DEPARTMENT.EMP_ID; 20.UNION ALL连接两个有重复行的 SELECT 语句，默认地，UNION 操作符选取不同的值。如果允许重复的值，请使用 UNION ALL。注意：重复项会被保留 12345SELECT EMP_ID, NAME, DEPT FROM COMPANY INNER JOIN DEPARTMENT ON COMPANY.ID = DEPARTMENT.EMP_ID UNION ALLSELECT EMP_ID, NAME, DEPT FROM COMPANY LEFT OUTER JOIN DEPARTMENT ON COMPANY.ID = DEPARTMENT.EMP_ID; 21.IS NULL 用来查找为 NULL 值的字段。22.索引索引是加速搜索引擎检索数据的一种特殊表查询。简单地说，索引是一个指向表中数据的指针。一个数据库中的索引与一本书的索引目录是非常相似的。 索引类型 key 描述 单列索引 CREATE INDEX index_name ON table_name (column_name); 单列索引是一个只基于表的一个列上创建的索引 组合索引 CREATE INDEX index_name ON table_name (column1_name, column2_name); 组合索引是基于表的多列上创建的索引 唯一索引 CREATE UNIQUE INDEX index_name on table_name (column_name); 使用唯一索引不仅是为了性能，同时也为了数据的完整性。唯一索引不允许任何重复的值插入到表中 局部索引 CREATE INDEX index_name ON table_name(column_list) WHERE condition; 在表的子集上构建的索引；子集由一个条件表达式上定义。索引只包含满足条件的行 隐式索引 创建表时自动创建 隐式索引是在创建对象时，由数据库服务器自动创建的索引。这类索引通常为主键约束和唯一约束自动创建。当在创建表时声明一个列为主键、唯一约束或外键时，PostgreSQL 会自动为该列创建一个隐式索引 CREATE INDEX index_name ON table_name; 1234567891011121314151617181920212223242526CREATE INDEX salary_index ON COMPANY (salary);-- 用 \\d company 命令列出 COMPANY 表的所有索引：-- 得到的结果如下，company_pkey 是隐式索引 ，是表创建表时创建的：runoobdb=# \\d company Table &quot;public.company&quot; Column | Type | Collation | Nullable | Default ---------+---------------+-----------+----------+--------- id | integer | | not null | name | text | | not null | age | integer | | not null | address | character(50) | | | salary | real | | | Indexes: &quot;company_pkey&quot; PRIMARY KEY, btree (id) &quot;salary_index&quot; btree (salary) -- 你可以使用 \\di 命令列出数据库中所有索引：runoobdb=# \\di List of relations Schema | Name | Type | Owner | Table --------+-----------------+-------+----------+------------ public | company_pkey | index | postgres | company public | department_pkey | index | postgres | department public | salary_index | index | postgres | company 查看索引 12345runoobdb=# select * from pg_indexes WHERErunoobdb-# tablename = &#x27;company&#x27;; public | company | company_pkey | | CREATE UNIQUE INDEX company_pkey ON public.company USING btree (id) public | company | salary_index | | CREATE INDEX salary_index ON public.company USING btree (salary) public | company | myuniqueconstraint | | CREATE UNIQUE INDEX myuniqueconstraint ON public.company USING btree (name) 避免使用索引 1234索引不应该使用在较小的表上。索引不应该使用在有频繁的大批量的更新或插入操作的表上。索引不应该使用在含有大量的 NULL 值的列上。索引不应该使用在频繁操作的列上。 23.ALTER TABLE 命令ALTER TABLE 命令用于添加，修改，删除一张已经存在表的列，添加和删除约束 添加字段1ALTER TABLE COMPANY ADD AGE int default 18; 删除字段1ALTER TABLE table_name DROP COLUMN column_name; 修改字段类型1ALTER TABLE table_name ALTER COLUMN column_name TYPE datatype; 添加 NOT NULL 约束1ALTER TABLE table_name ALTER column_name datatype NOT NULL; 添加 UNIQUE 约束12ALTER TABLE table_nameADD CONSTRAINT MyUniqueConstraint UNIQUE(column1, column2...); 添加 CHECK 约束12ALTER TABLE table_nameADD CONSTRAINT MyUniqueConstraint CHECK (CONDITION); 添加主键12ALTER TABLE table_nameADD CONSTRAINT MyPrimaryKey PRIMARY KEY (column1, column2...); 删除约束12ALTER TABLE table_nameDROP CONSTRAINT MyUniqueConstraint; 24.TRUNCATE TABLE 命令TRUNCATE TABLE 用于删除表的数据，但不删除表结构。也可以用 DROP TABLE 删除表，但是这个命令会连表的结构一起删除，如果想插入数据，需要重新建立这张表。TRUNCATE TABLE 与 DELETE 具有相同的效果，但是由于它实际上并不扫描表，所以速度更快。 此外，TRUNCATE TABLE 可以立即释放表空间，而不需要后续 VACUUM 操作，这在大型表上非常有用。 1TRUNCATE TABLE table_name; 25.View（视图）View（视图）是一张假表，只不过是通过相关的名称存储在数据库中的一个 PostgreSQL 语句。 CREATE VIEW （创建视图）12345678910runoobdb=# CREATE VIEW COMPANY_VIEW AS SELECT ID, NAME, AGE FROM COMPANY runoobdb=# SELECT * FROM COMPANY_VIEW;-- 得到结果如下：id | name | age----+-------+----- 1 | Paul | 32 2 | Allen | 25 3 | Teddy | 23 DROP VIEW （删除视图）1runoobdb=# DROP VIEW view_name; 26.TRANSACTION（事务）TRANSACTION（事务）是数据库管理系统执行过程中的一个逻辑单位，由一个有限的数据库操作序列构成。 事务的属性事务具有以下四个标准属性，通常根据首字母缩写为 ACID 属性 描述 原子性（Atomicity） 事务作为一个整体被执行，包含在其中的对数据库的操作要么全部被执行，要么都不执行。 一致性（Consistency） 事务应确保数据库的状态从一个一致状态转变为另一个一致状态。一致状态的含义是数据库中的数据应满足完整性约束。 隔离性（Isolation） 多个事务并发执行时，一个事务的执行不应影响其他事务的执行。 持久性（Durability） 已被提交的事务对数据库的修改应该永久保存在数据库中 事务控制使用下面的命令来控制事务：事务控制命令只与 INSERT、UPDATE 和 DELETE 一起使用。他们不能在创建表或删除表时使用，因为这些操作在数据库中是自动提交的。 属性 描述 BEGIN TRANSACTION 开始一个事务。 COMMIT 事务确认，或者可以使用 END TRANSACTION 命令。 ROLLBACK 事务回滚。 BEGIN TRANSACTION 命令事务可以使用 BEGIN TRANSACTION 命令或简单的 BEGIN 命令来启动。此类事务通常会持续执行下去，直到遇到下一个 COMMIT 或 ROLLBACK 命令。不过在数据库关闭或发生错误时，事务处理也会回滚。以下是启动一个事务的简单语法：123BEGIN;或者BEGIN TRANSACTION; COMMIT 命令COMMIT 命令是用于把事务调用的更改保存到数据库中的事务命令，即确认事务。123COMMIT;或者END TRANSACTION; 12345678910111213141516runoobdb=# select * from company; 1 | Paul | California | 20000 | 2001-07-13 | 18 4 | Mark | Rich-Mond | 65000 | 2007-12-13 | 18 5 | David | Texas | 85000 | 2007-12-13 | 18 2 | Allen | Texas | 15000 | 2007-12-13 | 18 3 | Teddy | Norway | 15000 | 2025-08-19 | 18runoobdb=# begin; delete from company where id=5;commit;BEGINDELETE 1COMMITrunoobdb=# select * from company; 1 | Paul | California | 20000 | 2001-07-13 | 18 4 | Mark | Rich-Mond | 65000 | 2007-12-13 | 18 2 | Allen | Texas | 15000 | 2007-12-13 | 18 3 | Teddy | Norway | 15000 | 2025-08-19 | 18 ROLLBACK 命令ROLLBACK 命令是用于撤消尚未保存到数据库的事务命令，即回滚事务。1ROLLBACK; 1234567891011121314151617runoobdb=# select * from company; 1 | Paul | California | 20000 | 2001-07-13 | 18 4 | Mark | Rich-Mond | 65000 | 2007-12-13 | 18 5 | David | Texas | 85000 | 2007-12-13 | 18 2 | Allen | Texas | 15000 | 2007-12-13 | 18 3 | Teddy | Norway | 15000 | 2025-08-19 | 18runoobdb=# begin; delete from company where id=5;rollback;BEGINDELETE 1ROLLBACKrunoobdb=# select * from company; 1 | Paul | California | 20000 | 2001-07-13 | 18 4 | Mark | Rich-Mond | 65000 | 2007-12-13 | 18 5 | David | Texas | 85000 | 2007-12-13 | 18 2 | Allen | Texas | 15000 | 2007-12-13 | 18 3 | Teddy | Norway | 15000 | 2025-08-19 | 18 27.LOCK（锁）锁主要是为了保持数据库数据的一致性，可以阻止用户修改一行或整个表，一般用在并发较高的数据库中。数据库中有两种基本的锁：排它锁（Exclusive Locks）和共享锁（Share Locks）。 排它锁，则其他的事务不能对它读取和修改。 共享锁，则该数据库对象可以被其他事务读取，但不能修改。123456789LOCK 命令语法LOCK 命令基础语法如下：LOCK [ TABLE ]name INlock_modename：要锁定的现有表的名称（可选模式限定）。如果只在表名之前指定，则只锁定该表。如果未指定，则锁定该表及其所有子表（如果有）。lock_mode：锁定模式指定该锁与哪个锁冲突。如果没有指定锁定模式，则使用限制最大的访问独占模式。可能的值是：ACCESS SHARE，ROW SHARE， ROW EXCLUSIVE， SHARE UPDATE EXCLUSIVE， SHARE，SHARE ROW EXCLUSIVE，EXCLUSIVE，ACCESS EXCLUSIVE。 死锁当两个事务彼此等待对方完成其操作时，可能会发生死锁。 28.AUTO INCREMENT（自动增长）AUTO INCREMENT（自动增长） 会在新记录插入表中时生成一个唯一的数字。 29.PRIVILEGES（权限） 权限12345678910111213在 PostgreSQL 中，权限分为以下几种：SELECTINSERTUPDATEDELETETRUNCATEREFERENCESTRIGGERCREATECONNECTTEMPORARYEXECUTEUSAGE GRANT 语法1234567GRANT privilege [, ...] ON object [, ...] TO &#123; PUBLIC | GROUP group | username &#125;privilege − 值可以为：SELECT，INSERT，UPDATE，DELETE， RULE，ALL。object − 要授予访问权限的对象名称。可能的对象有： table， view，sequence。PUBLIC − 表示所有用户。GROUP group − 为用户组授予权限。username − 要授予权限的用户名。PUBLIC 是代表所有用户的简短形式。 1GRANT ALL ON COMPANY TO runoob; 撤销1REVOKE ALL ON COMPANY FROM runoob;","categories":[{"name":"odoo","slug":"odoo","permalink":"https://dbbruce.github.io/categories/odoo/"},{"name":"基础","slug":"odoo/基础","permalink":"https://dbbruce.github.io/categories/odoo/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"012-scrapy基础","slug":"爬虫/基础/012-scrapy基础","date":"2023-08-19T07:04:52.000Z","updated":"2024-08-05T14:30:38.000Z","comments":true,"path":"2023/08/19/爬虫/基础/012-scrapy基础/","link":"","permalink":"https://dbbruce.github.io/2023/08/19/%E7%88%AC%E8%99%AB/%E5%9F%BA%E7%A1%80/012-scrapy%E5%9F%BA%E7%A1%80/","excerpt":"最新版 pip install scrapy 框架结构Scrapy Engin(引擎):Scrapy框架的核心部分负责在Spider和ltem Pipeline、Downloader、Scheduler中间通信、传递数据等。Spider(爬虫):发送需要爬取的链接给引擎，最后引擎把其他模块请求回来的数据再发送给爬虫，爬虫就去解析想要的数据。Scheduler(调度器):负责接收引擎发送过来的请求，并按照一定的方式进行排列和整理，负责调度请求的顺序等Downloader(下载器):负责接收引擎过来的下载请求，然后去网络上下载对应的数据再交给引擎Item Pipeline(管道):负责将爬虫传递过来的数据进行保存。Downloader Middlewares(下载中间件):可以扩展下载器和引擎之间通信功能的中间件Spider Middlewares(Spider中间件):可以扩展引擎和爬虫之间通信功能的中间件","text":"最新版 pip install scrapy 框架结构Scrapy Engin(引擎):Scrapy框架的核心部分负责在Spider和ltem Pipeline、Downloader、Scheduler中间通信、传递数据等。Spider(爬虫):发送需要爬取的链接给引擎，最后引擎把其他模块请求回来的数据再发送给爬虫，爬虫就去解析想要的数据。Scheduler(调度器):负责接收引擎发送过来的请求，并按照一定的方式进行排列和整理，负责调度请求的顺序等Downloader(下载器):负责接收引擎过来的下载请求，然后去网络上下载对应的数据再交给引擎Item Pipeline(管道):负责将爬虫传递过来的数据进行保存。Downloader Middlewares(下载中间件):可以扩展下载器和引擎之间通信功能的中间件Spider Middlewares(Spider中间件):可以扩展引擎和爬虫之间通信功能的中间件 创建项目 scrapy startproject douban(项目名) 123456789101112(spider-env) dbbruce@dbburce test1 % tree douban douban├── douban│ ├── __init__.py│ ├── items.py # 定义数据│ ├── middlewares.py│ ├── pipelines.py # 处理数据│ ├── settings.py # 各种设置 │ └── spiders # 爬虫目录│ └── __init__.py└── scrapy.cfg 1、创建一个爬虫文件（进入项目） cd doubanscrapy genspider 爬虫名 域名(限定域名，只抓取这个域名) 1234567891011douban├── douban│ ├── __init__.py│ ├── items.py│ ├── middlewares.py│ ├── pipelines.py│ ├── settings.py│ └── spiders│ ├── __init__.py│ └── xiao.py└── scrapy.cfg 12345678910import scrapyclass XiaoSpider(scrapy.Spider): name = &quot;xiao&quot; allowed_domains = [&quot;douban.com&quot;] start_urls = [&quot;https://douban.com&quot;] def parse(self, response): pass 12# 运行爬虫scrapy crawl xiao 12345678910# /douban/douban/spiders/top250book.pyimport scrapyclass DoubanSpider(scrapy.Spider): name = &#x27;xiao&#x27; # 爬虫名称 allowed_domains =[&#x27;book.douban.com/top250&#x27;] # 定义运行爬取的域名 start_urls = [&#x27;https://book.douban.com/top250&#x27;] # 定义起始的网址 def parse(self, response): # 解析函数 print(response.text) 2、修改请求头 12345678# /douban/douban/settings.pyDEFAULT_REQUEST_HEADERS = &#123; &#x27;Accept&#x27;: &#x27; text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7&#x27;, &#x27;Accept-Language&#x27;: &#x27; zh-CN,zh;q=0.9,en;q=0.8&#x27;, &#x27;Host&#x27;: &#x27; book.douban.com&#x27;, &#x27;User-Agent&#x27;: &#x27; Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36&#x27;,&#125; 3、遵守robots协议 True遵守协议，False不遵守，一般都是不遵守 123# /douban/douban/settings.pyROBOTSTXT_OBEY = False 4、创建一个启动脚本 scrapy crawl 爬虫名 1234# start.pyfrom scrapy import cmdlinecmdline.execute([ &quot;scrapy&quot;, &quot;crawl&quot;, &quot;douban&quot;]) 5、使用pipeline后需要修改配置文件，管道要好使，必须启用这里 300是优先级，数越大优先级越低 1234567# /douban/douban/settings.pyITEM_PIPELINES = &#123; # key管道的路径，value 管道优先级，数越小，优先级越高 &quot;douban.pipelines.DoubanPipeline&quot;: 300,&#125; douban的一个实例项目结构 12345678910111213douban├── book.xlsx├── douban│ ├── __init__.py│ ├── items.py│ ├── middlewares.py│ ├── pipelines.py│ ├── settings.py│ └── spiders│ ├── __init__.py│ └── top250book.py├── scrapy.cfg└── start.py 爬虫 : top250book.py 12345678910111213141516171819202122import scrapyfrom bs4 import BeautifulSoupfrom ..items import DoubanItemclass DoubanSpider(scrapy.Spider): name = &#x27;douban&#x27; # 爬虫名称 allowed_domains =[&#x27;book.douban.com/top250&#x27;] # 定义运行爬取的域名 start_urls = [&#x27;https://book.douban.com/top250&#x27;] # 定义起始的网址 def parse(self, response): bs = BeautifulSoup(response.text, &#x27;html.parser&#x27;) tr_tag = bs.find_all(&#x27;tr&#x27;, class_=&#x27;item&#x27;) for tr in tr_tag: item = DoubanItem() title = tr.find_all(&#x27;a&#x27;)[1][&#x27;title&#x27;] publish = tr.find(&#x27;p&#x27;, class_=&#x27;pl&#x27;).text score = tr.find(&#x27;span&#x27;, class_=&#x27;rating_nums&#x27;).text item[&#x27;title&#x27;] = title item[&#x27;publish&#x27;] = publish item[&#x27;score&#x27;] = score yield item 存储对象：items.py 12345678910import scrapyclass Doubanitem(scrapy.Item): # define the fields for your item here like: # name = scrapy.Field() title = scrapy.Field() publish = scrapy.Field() score = scrapy.Field() 执行存储：pipelines.py 12345678910111213141516import openpyxlclass DoubanPipeline: def __init__(self): self.wb = openpyxl.Workbook() self.ws = self.wb.active self.ws.append([&#x27;名称&#x27;,&#x27;出版信息&#x27;,&#x27;评分&#x27;]) def process_item(self, item, spider): line = [item[&#x27;title&#x27;],item[&#x27;publish&#x27;],item[&#x27;score&#x27;]] self.ws.append(line) return item def close_spider(self, spider): #注意spider这个参数，要写 self.wb.save(&#x27;book.xlsx&#x27;) self.wb.close() 配置文件 ： settings.py &#x3D; 请求头 、pipeline、robots协议 123456DEFAULT_REQUEST_HEADERS = &#123; &#x27;Accept&#x27;: &#x27; text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7&#x27;, &#x27;Accept-Language&#x27;: &#x27; zh-CN,zh;q=0.9,en;q=0.8&#x27;, &#x27;Host&#x27;: &#x27; book.douban.com&#x27;, &#x27;User-Agent&#x27;: &#x27; Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36&#x27;,&#125; 1ROBOTSTXT_OBEY = True 123ITEM_PIPELINES = &#123; &quot;douban.pipelines.DoubanPipeline&quot;: 300,&#125; yield 推送数据 yield 的三种数据 123yield&#123;&#125; 字典推送给pipelineyield item 对象 推送给pipelineyield scrap.Request()Request对象 ,谁送给调度器 创建项目和爬虫123# scrapy startproject story# cd story # scrapy genspider qustory qu.la # 爬虫文件名 域名 scrapy提取数据的方法注意：scrapy xpath获取的是一个selector对象，使用extract或者extract first获取数据 方法&#x2F;函数 描述 xpath() 它返回选择器列表，它代表由指定的Xpath表达式参数选择的节点 css() 它返回选择器列表，代表由指定CSS表达式作为参数所选择的节点 re() 它返回Unicode字符串列表，当正则表达式被赋予作为参数时提取 extract() 它返回一个Unicode字符串以及所选择数据 ，返回列表 extract first() 它返回第一个Unicode字符串以及所选数据 ，返回字符串 使用string()，可以只取元素对象中的文字 extract 返回列表，extract_first 返回字符串 yield 直接返回一个字典，直接将数据推送个pipeline，可以直接在pipeline文件中操作123456789101112131415161718192021# qustory.pyimport scrapyclass QustorySpider(scrapy.Spider): name = &quot;qustory&quot; allowed_domains = [&quot;qu.la&quot;] start_urls = [&quot;https://qu.la&quot;] def parse(self, response): title = response.xpath(&#x27;//h1[@class=&quot;title&quot;]/text()&#x27;).extract() content = response.xpath(&#x27;string(//div[@id=&quot;content&quot;])&#x27;).extract_first() next_url = response.xpath(&#x27;//div[@class=&quot;section-opt&quot;]/a[3]/@href&#x27;).extract_first() # 返回数据给pipline，其实先给引擎，再给pipline yield &#123; &#x27;title&#x27;: title, &#x27;content&#x27;: content, &#125; yield scrapy.Request(next_url, callback=self.parse()) 直接在pipeline中操作数据12345678910111213141516171819# pipelines.pyclass StoryPipeline: # 这个类随意定义 def process_item(self, item, spider): # 这个方法定死的， item是数据 info = &#x27;&#x27;.join([item[&#x27;title&#x27;], item[&#x27;content&#x27;], &#x27;\\n&#x27;]) self.file.write(info) return item # 给下一个管道 def open_spider(self, spider): self.file = open(&#x27;story.txt&#x27;, &#x27;w&#x27;, encoding=&#x27;utf-8&#x27;) def close_spider(self, spider): self.file.close()# 自己新加一个Pipeline，需要加settingsclass NewTestPipeline: def process_item(self, item, spider): # 这个方法定死的， item是数据 print(&quot;test&quot;) return item # 必须return东西，否则下一个管道收不到数据了 1234ITEM_PIPELINES = &#123; &quot;douban.pipelines.DoubanPipeline&quot;: 300, &quot;douban.pipelines.NewTestPipeline&quot;: 200, # 先执行这个&#125; settings 配置文件12345BOT_NAME=&#x27;story&#x27;爬虫的名字，在使用startproject命令创建时自动被赋值CONCURRENT_REQUESTS =32 并发请求的最大值，默认为16DEFAULT_REOUEST_HEADERS 默认的请求头DOWNLOAD_DELAY =3 下载延迟、秒LOG_ENABLED=False 默认为True,显示日志信息，需要自己写 不显示运行时看到很多调试信息1234vim settings.py# 日志级别：DEBUG，INFO, WARNING, ERROR , CRITICALLOG_LEVEL = &quot;WARNING&quot; selector提取内容extract(),没有内容会报错 1response.xpath(&quot;//ul.text()&quot;).extract() extract_first(),没有内容返回None,这个比较好 1response.xpath(&quot;//ul.text()&quot;).extract_first()","categories":[{"name":"爬虫类","slug":"爬虫类","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/"},{"name":"基础","slug":"爬虫类/基础","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"013-CrawlSpider基础","slug":"爬虫/基础/013-CrawlSpider基础","date":"2023-08-19T07:04:52.000Z","updated":"2024-05-31T08:06:55.000Z","comments":true,"path":"2023/08/19/爬虫/基础/013-CrawlSpider基础/","link":"","permalink":"https://dbbruce.github.io/2023/08/19/%E7%88%AC%E8%99%AB/%E5%9F%BA%E7%A1%80/013-CrawlSpider%E5%9F%BA%E7%A1%80/","excerpt":"CrawlSpider CrawlSpider 是 Scrapy 框架提供的一个特殊的 Spider 类型，在Scrapy中Spider是所有爬虫的基类，而CrawSpiders就是Spider的派生类，用于处理那些需要遵循特定规则和链接提取的网站。它是基于广度优先算法构建的，可以自动发现并跟踪网页上的链接，并根据预定义的规则提取数据。","text":"CrawlSpider CrawlSpider 是 Scrapy 框架提供的一个特殊的 Spider 类型，在Scrapy中Spider是所有爬虫的基类，而CrawSpiders就是Spider的派生类，用于处理那些需要遵循特定规则和链接提取的网站。它是基于广度优先算法构建的，可以自动发现并跟踪网页上的链接，并根据预定义的规则提取数据。 CrawlSpider 提供了一种更高级的方法来定义爬取规则，而无需编写大量的重复代码。它基于规则系统工作，其中每个规则由一个或多个链接提取器（LinkExtractor）和一个回调函数（callback）组成。规则定义了要提取的链接和如何处理这些链接的方法。 创建一个crawl模板的爬虫 scrapy genspider -t crawl XXX爬虫名 XXXX域名 linkExtractors链接提取器 使用LinkExtractors可以不用程序员自己提取想要的url，然后发送请求。这些工作都可以交给LinkExtractors. 他会在所有爬的页面中找到满足规则的url.实现自动爬取。 123456主要参数allow:允许的url。所有满足这个正则表达式的url都会被提取deny:禁止的url。 所有满足这个正则表达式的url都不会被提取allow domains:允许的域名。只有在这个里面指定的域名的url才会被提取deny domains:禁止的域名，所有在这个里面指定的域名的url都不会被提取restrict xpaths:严格的xpath。和allow共同过滤链接 1234567# scrapy startproject lieyun # cd lieyun (spider-env) dbbruce@dbburce lieyun % scrapy genspider -t crawl lieyunpro lieyunpro.com Created spider &#x27;lieyunpro&#x27; using template &#x27;crawl&#x27; in module: lieyun.spiders.lieyunpro 12345678910111213# tree lieyunlieyun├── lieyun│ ├── __init__.py│ ├── items.py│ ├── middlewares.py│ ├── pipelines.py│ ├── settings.py│ └── spiders│ ├── __init__.py│ └── lieyunpro.py└── scrapy.cfg 1234567891011121314151617181920# lieyunpro.pyimport scrapyfrom scrapy.linkextractors import LinkExtractorfrom scrapy.spiders import CrawlSpider, Ruleclass LieyunproSpider(CrawlSpider): name = &quot;lieyunpro&quot; allowed_domains = [&quot;lieyunpro.com&quot;] start_urls = [&quot;https://lieyunpro.com&quot;] rules = (Rule(LinkExtractor(allow=r&quot;Items/&quot;), callback=&quot;parse_item&quot;, follow=True),) def parse_item(self, response): item = &#123;&#125; #item[&quot;domain_id&quot;] = response.xpath(&#x27;//input[@id=&quot;sid&quot;]/@value&#x27;).get() #item[&quot;name&quot;] = response.xpath(&#x27;//div[@id=&quot;name&quot;]&#x27;).get() #item[&quot;description&quot;] = response.xpath(&#x27;//div[@id=&quot;description&quot;]&#x27;).get() return item 12345链接提取器（LinkExtractor）：链接提取器用于从网页中提取链接。CrawlSpider 提供了几种内置的链接提取器，如基于正则表达式、基于 CSS 选择器、基于 XPath 等，你可以根据需求选择合适的链接提取器。规则（Rule）：规则定义了要提取的链接和如何处理这些链接的方法。每个规则由一个链接提取器和一个回调函数组成。链接提取器用于提取链接，回调函数定义了如何处理这些链接。可以定义多个规则来处理不同类型的链接。回调函数（callback）：回调函数是指定规则要调用的方法。当链接提取器提取到链接时，将会调用相应的回调函数来处理提取到的链接。在回调函数中，你可以编写解析页面和提取数据的逻辑。follow 参数：在规则中，可以设置 follow 参数来决定是否继续跟踪从链接提取器提取的链接。如果设置为 True，则会继续跟踪这些链接并提取数据；如果设置为 False，则不会跟踪这些链接。allowed_domains 参数：allowed_domains 参数用于限制爬取的域名。只有在 allowed_domains 列表中的域名下的链接才会被跟踪和提取数据，其他域名下的链接将被忽略。 callback 进行解析follow 是否继续爬allow 运行爬取的网页 scrapy 提供的调试方式 scrapy shell url地址 12345678910&gt;&gt;&gt; scrapy shell https://lieyunpro.com/archives/493159&gt;&gt;&gt; response.url&#x27;https://lieyunpro.com/archives/493159&#x27;&gt;&gt;&gt; response.xpath(&#x27;//h1[@class=&quot;lyw-article-title-inner&quot;]/text()&#x27;)[&lt;Selector query=&#x27;//h1[@class=&quot;lyw-article-title-inner&quot;]/text()&#x27; data=&#x27;\\r\\n &#x27;&gt;, &lt;Selector query=&#x27;//h1[@class=&quot;lyw-article-title-inner&quot;]/text()&#x27; data=&#x27;\\r\\n ...&#x27;&gt;]&gt;&gt;&gt; response.xpath(&#x27;//h1[@class=&quot;lyw-article-title-inner&quot;]/text()&#x27;).getall()[&#x27;\\r\\n &#x27;, &#x27;\\r\\n 衡道医学完成B+轮融资，提升 &#x27;]&gt;&gt;&gt; &#x27;&#x27;.join(response.xpath(&#x27;//h1[@class=&quot;lyw-article-title-inner&quot;]/text()&#x27;).getall()).strip()&#x27;衡道医学完成B+轮融资，提升数智化病理综合解决能力&#x27; 获取元素内容方法的区别 注意：scrapy的xpath方法只能获取到元素，得到的是一个selector选择器，不能获取到内容，如果要获取内容需要用到下面方法 方法 区别 extract() 返回列表 getall() 返回列表 extract_first() 返回字符串，区别是不能用于选择器，也就是单个元素，可以用于列表 get() 返回字符串 1234567891011121314151617181920212223242526272829303132333435# xpath方法获取的是列selector对象列表&gt;&gt;&gt; response.xpath(&#x27;//h1[@class=&quot;lyw-article-title-inner&quot;]/text()&#x27;)[&lt;Selector query=&#x27;//h1[@class=&quot;lyw-article-title-inner&quot;]/text()&#x27; data=&#x27;\\r\\n &#x27;&gt;, &lt;Selector query=&#x27;//h1[@class=&quot;lyw-article-title-inner&quot;]/text()&#x27; data=&#x27;\\r\\n ...&#x27;&gt;]# getall 获取的是内容列表&gt;&gt;&gt; response.xpath(&#x27;//h1[@class=&quot;lyw-article-title-inner&quot;]/text()&#x27;).getall()[&#x27;\\r\\n &#x27;, &#x27;\\r\\n 衡道医学完成B+轮融资，提升 &#x27;]# extract 获取的是内容列表&gt;&gt;&gt; response.xpath(&#x27;//h1[@class=&quot;lyw-article-title-inner&quot;]/text()&#x27;).extract()[&#x27;\\r\\n &#x27;, &#x27;\\r\\n 衡道医学完成B+轮融资，提升 &#x27;]# get获取的是内容字符串，获取一个&gt;&gt;&gt; response.xpath(&#x27;//h1[@class=&quot;lyw-article-title-inner&quot;]/text()&#x27;).get()&#x27;\\r\\n &#x27;# extract_first获取的是内容字符串，获取一个&gt;&gt;&gt; response.xpath(&#x27;//h1[@class=&quot;lyw-article-title-inner&quot;]/text()&#x27;).extract_first()&#x27;\\r\\n &#x27;# get与extract_first唯一区别，单元素不能用extract_first&gt;&gt;&gt; response.xpath(&#x27;//h1[@class=&quot;lyw-article-title-inner&quot;]/text()&#x27;)[0].get()&#x27;\\r\\n &#x27;&gt;&gt;&gt; response.xpath(&#x27;//h1[@class=&quot;lyw-article-title-inner&quot;]/text()&#x27;)[0].extract_first()Traceback (most recent call last): File &quot;&lt;console&gt;&quot;, line 1, in &lt;module&gt;AttributeError: &#x27;Selector&#x27; object has no attribute &#x27;extract_first&#x27;# getall 和 extract 对单元素也是一样的&gt;&gt;&gt; response.xpath(&#x27;//h1[@class=&quot;lyw-article-title-inner&quot;]/text()&#x27;)[0].extract()&#x27;\\r\\n &#x27;&gt;&gt;&gt; response.xpath(&#x27;//h1[@class=&quot;lyw-article-title-inner&quot;]/text()&#x27;)[0].getall()[&#x27;\\r\\n &#x27;] 项目信息1234567891011lieyun├── lieyun│ ├── __init__.py│ ├── items.py│ ├── middlewares.py│ ├── pipelines.py│ ├── settings.py│ └── spiders│ ├── __init__.py│ └── lieyunpro.py└── scrapy.cfg 12345678create table article( id smallint(5) primary key auto_increment comment &#x27;主键id&#x27;, title varchar(45) not null, author varchar(45) not null, pub_time varchar(45) not null, content varchar(10240) not null, article_url varchar(20) not null)ENGINE=INNODB AUTO_INCREMENT=1 DEFAULT charset=utf8; settings中新增 12345678MYSQL_DB_CONFIG = &#123; &#x27;driver&#x27;:&#x27;mysql.connector&#x27;, &#x27;host&#x27;:&#x27;127.0.0.1&#x27;, &#x27;user&#x27;:&#x27;root&#x27;, &#x27;password&#x27;:&#x27;123456&#x27;, &#x27;database&#x27;:&#x27;test&#x27;, &#x27;auth_plugin&#x27;:&#x27;mysql_native_password&#x27;,&#125; 爬虫123456789101112131415161718192021222324252627282930313233import scrapyfrom scrapy.linkextractors import LinkExtractorfrom scrapy.spiders import CrawlSpider, Rulefrom ..items import LieyunItemclass LieyunproSpider(CrawlSpider): name = &quot;lieyunpro&quot; allowed_domains = [&quot;lieyunpro.com&quot;] start_urls = [&quot;https://lieyunpro.com/latest/p1.html&quot;] rules = ( Rule(LinkExtractor(allow=r&quot;/latest/p1\\d+.html&quot;), follow=True), Rule(LinkExtractor(allow=r&quot;/archives/\\d+&quot;), callback=&quot;parse_item&quot;, follow=False), ) def parse_item(self, response): title_lst = response.xpath(&#x27;//h1[@class=&quot;lyw-article-title-inner&quot;]/text()&#x27;).getall() title = &#x27;&#x27;.join(title_lst).strip() publish_time = response.xpath(&#x27;//h1[@class=&quot;lyw-article-title-inner&quot;]/span/text()&#x27;).get() author_name = response.xpath(&#x27;//a[contains(@class, &quot;author-name&quot;)]/text()&#x27;).get() content = response.xpath(&#x27;//div[@class=&quot;main-text&quot;]//text()&#x27;).getall() content = &#x27;&#x27;.join(content).strip() article_url = response.url item = LieyunItem() item[&#x27;title&#x27;] = title item[&#x27;publish_time&#x27;] = publish_time item[&#x27;author_name&#x27;] = author_name item[&#x27;content&#x27;] = content item[&#x27;article_url&#x27;] = article_url yield item item12345678910import scrapyclass LieyunItem(scrapy.Item): title = scrapy.Field() publish_time = scrapy.Field() author_name = scrapy.Field() content = scrapy.Field() article_url = scrapy.Field() pipeline12345678910111213141516171819202122232425262728293031323334from itemadapter import ItemAdapterfrom twisted.enterprise import adbapiclass LieyunPipeline: def __init__(self, mysql_config): self.dbpool = adbapi.ConnectionPool( mysql_config[&#x27;driver&#x27;], host=mysql_config[&#x27;host&#x27;], user=mysql_config[&#x27;user&#x27;], password=mysql_config[&#x27;password&#x27;], database=mysql_config[&#x27;database&#x27;], charset=&#x27;utf8&#x27; ) @classmethod def from_crawler(cls, crawler): mysql_config=crawler.settings[&#x27;MYSQL_DB_CONFIG&#x27;] return cls(mysql_config) def process_item(self, item, spider): result = self.dbpool.runInteraction(self.insert_item, item) result.addErrback(self.insert_error) return item def insert_item(self, cursor, item): sql =&#x27;insert into article(id, title,author, pub_time,content,article_url) values(null,%s,%s,%s,%s,%s)&#x27; args =(item[&#x27;title&#x27;],item[&#x27;publish_time&#x27;],item[&#x27;author_name&#x27;],item[&#x27;content&#x27;],item[&#x27;article_url&#x27;] ) cursor.execute(sql, args) def insert_error(self, failure): print(&quot;++++++++++++++++++&quot;) print(failure) print(&quot;++++++++++++++++++&quot;) settings1234567891011121314151617# 数据库配置MYSQL_DB_CONFIG = &#123; &#x27;driver&#x27;:&#x27;mysql.connector&#x27;, &#x27;host&#x27;:&#x27;127.0.0.1&#x27;, &#x27;user&#x27;:&#x27;root&#x27;, &#x27;password&#x27;:&#x27;123456&#x27;, &#x27;database&#x27;:&#x27;test&#x27;,&#125;# 开启pipelineITEM_PIPELINES = &#123; &quot;lieyun.pipelines.LieyunPipeline&quot;: 300,&#125;# robots协议ROBOTSTXT_OBEY = False start文件，start.py123from scrapy import cmdlinecmdline.execute(&#x27;scrapy crawl lieyunpro&#x27;.split(&#x27; &#x27;))","categories":[{"name":"爬虫类","slug":"爬虫类","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/"},{"name":"基础","slug":"爬虫类/基础","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"odoo知识点(四)","slug":"odoo/odoo知识点4","date":"2023-08-18T15:50:52.000Z","updated":"2024-11-27T01:31:45.405Z","comments":true,"path":"2023/08/18/odoo/odoo知识点4/","link":"","permalink":"https://dbbruce.github.io/2023/08/18/odoo/odoo%E7%9F%A5%E8%AF%86%E7%82%B94/","excerpt":"1、查看ORM执行的原始SQL 修改配置文件，添加如下配置1log_level = debug_sql 123456logfile： 日志文件名。如果没有设置，请使用stdoutlogrotate： True/False。如果为True，则创建每日日志文件并保留30个文件log_db： True/False。如果是Ture，也将日志写入数据库中的&#x27;ir_logging&#x27;表log_level： [&#x27;debug_rpc_answer&#x27;、&#x27;debug_rpc&#x27;、&#x27;debug&#x27;、&#x27;ddebug_sql&#x27;、&#x27;info&#x27;、&#x27;warn&#x27;、&#x27;error&#x27;、&#x27;critical&#x27;列表中的任何值]。Odoo更改了这里的log_level含义，因为此级别值映射到一组预定义的“模块：log_level”对。即使未设置此选项，也有一组预定义的设置。详细信息请参见以下实现部分。log_handler： 可以是“模块：log_level”对的列表。默认值为“：INFO”——这意味着所有模块的默认日志记录级别为“INFO”。log_handler = openerp.addons.my_addon1:DEBUG,openerp.addons.my_addon2:DEBUG 2、auto_join auto_join – 在搜索该字段时是否自动生成JOIN条件，默认False True，使用left join查询数据1publisher_id = fields.Many2one(comodel_name= &#x27;res.partner&#x27;, domain=&#x27;&#x27;,context=&#123;&#125;,ondelete=&#x27;&#x27;,auto_join=&#x27;&#x27;,delegate=&#x27;&#x27;,string=&#x27;Publisher&#x27;)","text":"1、查看ORM执行的原始SQL 修改配置文件，添加如下配置1log_level = debug_sql 123456logfile： 日志文件名。如果没有设置，请使用stdoutlogrotate： True/False。如果为True，则创建每日日志文件并保留30个文件log_db： True/False。如果是Ture，也将日志写入数据库中的&#x27;ir_logging&#x27;表log_level： [&#x27;debug_rpc_answer&#x27;、&#x27;debug_rpc&#x27;、&#x27;debug&#x27;、&#x27;ddebug_sql&#x27;、&#x27;info&#x27;、&#x27;warn&#x27;、&#x27;error&#x27;、&#x27;critical&#x27;列表中的任何值]。Odoo更改了这里的log_level含义，因为此级别值映射到一组预定义的“模块：log_level”对。即使未设置此选项，也有一组预定义的设置。详细信息请参见以下实现部分。log_handler： 可以是“模块：log_level”对的列表。默认值为“：INFO”——这意味着所有模块的默认日志记录级别为“INFO”。log_handler = openerp.addons.my_addon1:DEBUG,openerp.addons.my_addon2:DEBUG 2、auto_join auto_join – 在搜索该字段时是否自动生成JOIN条件，默认False True，使用left join查询数据1publisher_id = fields.Many2one(comodel_name= &#x27;res.partner&#x27;, domain=&#x27;&#x27;,context=&#123;&#125;,ondelete=&#x27;&#x27;,auto_join=&#x27;&#x27;,delegate=&#x27;&#x27;,string=&#x27;Publisher&#x27;) 3、form_view_ref &amp; tree_view_ref odoo中many2one字段当候选项太多的时候,点击搜索更多会跳转到tree视图中,这个时候目标tree视图是可以指定的 odoo提供了指定视图的方法,在form视图中该字段中添加context参数,context中指定”tree_view_ref”属性,即可指定跳转的目标视图1234&lt;field name=&quot;employee_id&quot; options=&quot;&#123;&#x27;no_create_edit&#x27;: True,&#x27;no_open&#x27;: True, &#x27;no_create&#x27;:True&#125;&quot; context=&quot;&#123;&#x27;tree_view_ref&#x27;: &#x27;lintong_employee.lintong_employee_search_list&#x27;&#125;&quot;/&gt; 此外还有”form_view_ref”以及”search_view_ref”两个属性可以指定 指定目标form视图以及搜索视图 4、Qweb123456789101112131415&#123;% echarts %&#125;&#123; xAxis: &#123; type: &#x27;category&#x27;, data: [&#x27;Mon&#x27;, &#x27;Tue&#x27;, &#x27;Wed&#x27;, &#x27;Thu&#x27;, &#x27;Fri&#x27;, &#x27;Sat&#x27;, &#x27;Sun&#x27;] &#125;, yAxis: &#123; type: &#x27;value&#x27; &#125;, series: [&#123; data: [820, 932, 901, 934, 1290, 1330, 1320], type: &#x27;line&#x27; &#125;]&#125;&#123;% endecharts %&#125;","categories":[{"name":"odoo","slug":"odoo","permalink":"https://dbbruce.github.io/categories/odoo/"},{"name":"基础","slug":"odoo/基础","permalink":"https://dbbruce.github.io/categories/odoo/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"odoo知识点(三)","slug":"odoo/odoo知识点3","date":"2023-08-18T15:34:52.000Z","updated":"2024-11-26T06:04:25.828Z","comments":true,"path":"2023/08/18/odoo/odoo知识点3/","link":"","permalink":"https://dbbruce.github.io/2023/08/18/odoo/odoo%E7%9F%A5%E8%AF%86%E7%82%B93/","excerpt":"1、hierarchy 阶层 hierarchy, model自己关联自己 index&#x3D;True为字段添加数据库索引，让搜索更快速，但同时也会部分降低写操作速度 related:字面意思-关联字段，表示本字段引用关联表中的某字段 parent_id, child_ids 关联自己123456789class Partner(models.Model): _name = &#x27;res.partner&#x27; name = fields.Char(string=&#x27;Name&#x27;, index=True) parent_id = fields.Many2one(&#x27;demo.hierarch&#x27;, string=&#x27;Parent&#x27;, index=True) parent_name = fields.Char(relation=&#x27;parent_id.name&#x27;, string=&#x27;Parent Name&#x27;, readonly=True) child_ids = fields.One2many(&#x27;demo.hierarch&#x27;, &#x27;parent_id&#x27;, string=&#x27;Children&#x27;) active = fields.Boolean(default=True) 通过下面方法查找，父亲或者儿子12self.env[&#x27;res.partner&#x27;].search([(&#x27;id&#x27;, &#x27;child_of&#x27;, [11])]) self.env[&#x27;res.partner&#x27;].search([(&#x27;id&#x27;, &#x27;parent_of&#x27;, [68])])","text":"1、hierarchy 阶层 hierarchy, model自己关联自己 index&#x3D;True为字段添加数据库索引，让搜索更快速，但同时也会部分降低写操作速度 related:字面意思-关联字段，表示本字段引用关联表中的某字段 parent_id, child_ids 关联自己123456789class Partner(models.Model): _name = &#x27;res.partner&#x27; name = fields.Char(string=&#x27;Name&#x27;, index=True) parent_id = fields.Many2one(&#x27;demo.hierarch&#x27;, string=&#x27;Parent&#x27;, index=True) parent_name = fields.Char(relation=&#x27;parent_id.name&#x27;, string=&#x27;Parent Name&#x27;, readonly=True) child_ids = fields.One2many(&#x27;demo.hierarch&#x27;, &#x27;parent_id&#x27;, string=&#x27;Children&#x27;) active = fields.Boolean(default=True) 通过下面方法查找，父亲或者儿子12self.env[&#x27;res.partner&#x27;].search([(&#x27;id&#x27;, &#x27;child_of&#x27;, [11])]) self.env[&#x27;res.partner&#x27;].search([(&#x27;id&#x27;, &#x27;parent_of&#x27;, [68])]) 2、search_read search_read: 搜索并返回记录，返回的字段可以指定，默认返回全部字段12self.env[&#x27;hr.expense&#x27;].search_read([], [&#x27;id&#x27;, &#x27;name&#x27;]) # 只返回：字段id和nameself.env[&#x27;hr.expense&#x27;].search_read([&#x27;name&#x27;, &#x27;=&#x27;, &#x27;dong&#x27;], [&#x27;id&#x27;, &#x27;name&#x27;]) # 只返回：字段id和name 3、xmlrpc 连接odooxmlrpc是一种远程过程调用方法，使用http协议传递xml格式的数据，客户端可以在远程服务器上调用带参数的方法获取结构化的数据。 4、_auto &#x3D; False _auto 默认是True，自动创建表 _auto &#x3D; False表示该模型不会自动创建表，需要手动创建表12class Demo1(models.Model): _auto = False 5、implied_group （group_bar &#x3D; fields.Boolean(group &#x3D;’base.group_user’, implied_group&#x3D;’my.group’)） implied_group: 这个功能主要用来管理user拥有哪些groups的权限 implied_ids: 功能类似，使用的是ids， 上面的使用的是group 6、eval eval 是一个常用于 XML 记录文件中的属性，它允许开发者在 XML 定义中嵌入 Python 表达式，并在 Odoo 模块加载或更新时计算这些表达式的结果 在这个例子中，number_of_items 设置为默认值 10，is_active 设置为 True，reference_id 设置为引用其他模块中的记录 ID。 12345&lt;record id=&quot;example_record&quot; model=&quot;example.model&quot;&gt; &lt;field name=&quot;number_of_items&quot; eval=&quot;10&quot;/&gt; &lt;field name=&quot;is_active&quot; eval=&quot;True&quot;/&gt; &lt;field name=&quot;reference_id&quot; eval=&quot;ref(&#x27;module.record_xml_id&#x27;)&quot;/&gt;&lt;/record&gt; 这里 attrs 属性定义了字段的可视性和只读属性，这些属性基于其他字段的值。eval 同时设置了一个默认值。 1&lt;field name=&quot;some_field&quot; attrs=&quot;&#123;&#x27;invisible&#x27;: [(&#x27;state&#x27;, &#x27;=&#x27;, &#x27;done&#x27;)], &#x27;readonly&#x27;: [(&#x27;user_id&#x27;, &#x27;!=&#x27;, uid)]&#125;&quot; eval=&quot;&#123;&#x27;default_code&#x27;: &#x27;NEW&#x27;&#125;&quot;/&gt; 在这个例子中，partner_ids 字段是一个多对多关系，通过 eval 动态关联到已定义的两个合作伙伴记录。 123&lt;record id=&quot;example_record&quot; model=&quot;example.model&quot;&gt; &lt;field name=&quot;partner_ids&quot; eval=&quot;[(6, 0, [ref(&#x27;base.main_partner&#x27;), ref(&#x27;base.secondary_partner&#x27;)])]&quot; /&gt;&lt;/record&gt; 7、hook pre_init_hook : 安装addons前，会先执行它，执行完毕才安装addons（更新不会生效） post_init_hook : 安装addons后，才会执行它（更新不会生效） uninstall_hook :移除addons后，才会执行 post_load: 这个比较特殊，使用odoo-bin cli安装或者更新时，优先于pre_init_hook 方法配置在 manifest.py123456&#123; &#x27;pre_init_hook&#x27;：&#x27;test_pre_init_hook&#x27;， &#x27;post_init_hook&#x27;：&#x27;test_post_init_hook&#x27;， &#x27;uninstall_hook&#x27;：&#x27;test_uninstall_hook&#x27;， &#x27;post_load&#x27;：&#x27;test_post_load&#x27;，&#125; 实现方法，一般写在__init__.py1234567891011def test_pre_init_hook(): passdef test_post_init_hook(): passdef test_uninstall_hook(): passdef test_post_load(): pass odoo 使用命令安装app1Python3 odoo-bin -i app3 -d odoo2 -c odoo.conf 8、odoo继承的写法 python3,推荐，写法简单1res = super( ).父类方法名(arg1, arg2) python21res = super(本类名, self).父类方法名(arg1, arg2) 9、fields_view_get fields_view_get: 获取视图，返回一个字典，包含视图的xml，以及视图的id，name等属性，用于动态生成视图 简单来说就是动态修改xml文件 10、docker 限制logging 大小12345logging: driver: &quot;json-file&quot; options: max-size: &quot;100m&quot; # 默认-1，没有限制 max-file: &quot;1&quot; # 默认1 11、raw sql 跳过ORM，所以权限不生效 self.env.cr.execute(sql) self.env.cr.fetchall() 把所有结果取出来, 返回一个列表 [(1,’dong’),(2,’x1’),(3,’d1’)] self.env.cr.fetchone() 只取出第一行，返回一个元组 (1, ‘dong’) self.env.cr.fetchmany(2) 取出前2行，返回一个列表 [1,’dong’),(2,’x1’)] self.env.cr.dictfetchall() 取出全部, 返回一个列表 [{‘id’:1,’name’:’aa’},{‘id’:2,’name’:’bb’}] 12、orm cache orm的缓存，默认是开启的，但是可以关闭，关闭后，每次查询都会从数据库中查询，不会使用缓存，但是可以手动清除缓存，清除缓存后，下次查询会从数据库中查询，而不是从缓存中查询 清除缓存：self.env.cache.clear() 清除某个对象的缓存：self.env.cache.clear(model) 清除某个对象的某个字段的缓存：self.env.cache.clear(model, field) 获取缓存：self.env.cache.get(model, field) 获取某个对象的缓存：self.env.cache.get(model) 获取某个对象的某个字段的缓存：self.env.cache.get(model, field) 获取全部缓存：self.env.cache.get_all() 获取全部对象的缓存：self.env.cache.get_all_models() 获取全部对象的某个字段的缓存：self.env.cache.get_all_fields(model) 获取全部字段的缓存：self.env.cache.get_all_fields() 获取全部对象的缓存：self.env.cache.get_all_models() 13、read_group domain: 过滤条件 fields: 需要聚合的字段，可以多个，格式为：[‘字段名’, ‘字段名:聚合函数’] groupby: 需要聚合的字段，可以多个，格式为：[‘字段名’] 返回值：返回一个列表，每个元素是一个字典，包含聚合后的字段的值，以及聚合后的数量，以及聚合后的总和，以及聚合后的平均值，以及聚合后的最小值，以及聚合后的最大值，以及聚合后的标准差，以及聚合后的方差，以及聚合后的方差，以及聚合后的方差，以及聚合后的方差，以及聚合后的方差，以及聚合后的方差，以及聚合后的方差，以及聚合后的方差，以及聚合后的方差，以及聚合后的方差，以及聚合后的方差，以及聚合后的方差，以及聚合后的方差，以及聚合后的方差，以及聚合后的格式：self.env[‘sale.order’].read_group([domain], [‘partner_id’, ‘amount_total:avg’], [‘partner_id’])1234self.env[&#x27;sale.order&#x27;].read_group([], [&#x27;partner_id&#x27;, &#x27;amount_total:avg&#x27;], [&#x27;partner_id&#x27;])self.env[&#x27;sale.order&#x27;].read_group([], [&#x27;partner_id&#x27;, &#x27;total:sum(amount_total)&#x27;, &#x27;avg_total:avg(amount_total)&#x27;], [&#x27;partner_id&#x27;]) 14、image mixin 产生不同尺寸的图片 只有image_1920：可以编辑123456class LibraryBook(models.Model): _name = &#x27;library.book&#x27; _description = &#x27;Library Book&#x27; _inherit = [&#x27;image.mixin&#x27;] name = fields.Char(&#x27;Title&#x27;, required=True) 123&lt;field name=&quot;image_1920&quot; widget=&#x27;image&#x27; class=&quot;oe_avatar&quot; options=&#x27;&#123;&quot;zoom&quot;: true, &quot;preview_image&quot;:&quot;image_128&quot;&#125;&#x27;/&gt;&lt;field name=&quot;image_256&quot; widget=&#x27;image&#x27; /&gt;&lt;field name=&quot;image_128&quot; widget=&#x27;image&#x27; /&gt; 15、tree decoration tree decoration: 树形视图的装饰，用于装饰树形视图的行，比如加颜色，加图标，加样式，加链接，加提示 16、_rec_name _rec_name: 树形视图的列名，默认是name，可以修改为其他字段，比如id，name，或者自定义的字段，比如title 默认是name 17、copy override12345678910111213141516171819from odoo import fields, models, api, _ class mygrandson(models.Model): _name = &quot;mygrandson.mygrandson&quot; _description = &quot;mygrandson模块&quot; _rec_name = &quot;test_one&quot; test_one = fields.Char() test_two = fields.Char() test_three = fields.Char(copy=False) test_mygrandson = fields.Many2one(&#x27;mykid.mykid&#x27;, string=&quot;测试多对一&quot;) def copy(self, default=None): if default is None: default = &#123;&#125; if not default.get(&#x27;test_one&#x27;): default[&#x27;test_one&#x27;] = _(&quot;%s (Copy)&quot;) % self.test_one default[&#x27;test_two&#x27;] = &quot;&quot; return super(mygrandson, self).copy(default) 1test_three = fields.Char(copy=False) 18、move position move position: 移动位置，用于移动位置，比如将某个字段放在某个位置，比如放在某个字段的上面，比如放在某个字段的下面 在age字段前插入gender字段 position为move1234567891011121314&lt;odoo&gt; &lt;data&gt; &lt;record model=&quot;ir.ui.view&quot; id=&quot;view_partner_tree&quot;&gt; &lt;field name=&quot;name&quot;&gt;mysale_partner&lt;/field&gt; &lt;field name=&quot;model&quot;&gt;mysale.mysale&lt;/field&gt; &lt;field name=&quot;inherit_id&quot; ref=&quot;mysale.mysale_tree&quot;/&gt; &lt;field name=&quot;arch&quot; type=&quot;xml&quot;&gt; &lt;xpath expr=&quot;//field[@name=&#x27;age&#x27;]&quot; position=&quot;before&quot;&gt; &lt;field name=&quot;gender&quot; position=&quot;move&quot;/&gt; &lt;/xpath&gt; &lt;/field&gt; &lt;/record&gt; &lt;/data&gt;&lt;/odoo&gt; 19、smart button smart button: 就是一个button，上面有数字，用于显示一些信息1234567total_invoiced = fields.Monetary(compute=&#x27;_invoice_total&#x27;, string=&quot;Total Invoiced&quot;, groups=&#x27;account.group_account_invoice&#x27;)@api.multidef _invoice_total(self): account_invoice_report = self.env[&#x27;account.invoice.report&#x27;] ... return result 123&lt;button type=&quot;action&quot; class=&quot;oe_stat_butto&quot; icon=&quot;fa-pencil-square-o&quot; name=&quot;...&quot; context=&quot;...&quot;&gt; &lt;field name=&quot;total_invoiced&quot; widget=&quot;statinfo&quot;/&gt;&lt;/button&gt; 20、 active archive ribbon 从odoo14开始有这个功能123456from odoo import models, fields, api, _class ChangeStatus(models.Model): ... active = fields.Boolean(default=True) 12345678&lt;record model=&quot;ir.ui.view&quot; id=&quot;change_status_form&quot;&gt; &lt;field name=&quot;name&quot;&gt;Change Status Form&lt;/field&gt; &lt;field name=&quot;model&quot;&gt;certificate_planer.change_status&lt;/field&gt; &lt;field name=&quot;arch&quot; type=&quot;xml&quot;&gt; &lt;form string=&quot;Change Status Form&quot;&gt; &lt;sheet&gt; &lt;widget name=&quot;web_ribbon&quot; title=&quot;Archived&quot; bg_color=&quot;bg-danger&quot; attrs=&quot;&#123;&#x27;invisible&#x27;: [(&#x27;active&#x27;, &#x27;=&#x27;, True)]&#125;&quot;/&gt; &lt;field name=&quot;active&quot; invisible=&quot;1&quot;/&gt; 21、search panel1234567891011121314151617181920212223&lt;record model=&quot;ir.ui.view&quot; id=&quot;mysale_search&quot;&gt; &lt;field name=&quot;name&quot;&gt;mysale_search&lt;/field&gt; &lt;field name=&quot;model&quot;&gt;mysale.mysale&lt;/field&gt; &lt;field name=&quot;arch&quot; type=&quot;xml&quot;&gt; &lt;search string=&quot;search_field&quot;&gt; &lt;field name=&quot;name&quot;/&gt; &lt;field name=&quot;age&quot;/&gt; &lt;field name=&quot;note&quot;/&gt; &lt;separator/&gt; &lt;filter string=&quot;男生&quot; name=&quot;male&quot; domain=&quot;[(&#x27;gender&#x27;,&#x27;=&#x27;,&#x27;male&#x27;)]&quot;/&gt; &lt;filter string=&quot;女生&quot; name=&quot;female&quot; domain=&quot;[(&#x27;gender&#x27;,&#x27;=&#x27;,&#x27;female&#x27;)]&quot;/&gt; &lt;group expand=&quot;1&quot; string=&quot;性别组&quot;&gt; &lt;filter string=&quot;性别组&quot; name=&quot;gender&quot; context=&quot;&#123;&#x27;group_by&#x27;:&#x27;gender&#x27;&#125;&quot;/&gt; &lt;filter string=&quot;姓名组&quot; name=&quot;name&quot; context=&quot;&#123;&#x27;group_by&#x27;:&#x27;name&#x27;&#125;&quot;/&gt; &lt;/group&gt; &lt;searchpanel&gt; &lt;field name=&quot;gender&quot; string=&quot;性别&quot; icon=&quot;fa-exchange&quot;/&gt; &lt;field name=&quot;state&quot; string=&quot;状态&quot; select=&quot;multi&quot; enable_counters=&quot;1&quot;/&gt; &lt;/searchpanel&gt; &lt;/search&gt; &lt;/field&gt; &lt;/record&gt; 22、ondelete cascade set null: 当b中删除记录时，modelA中相关记录的a&#x3D;null cascade: 当b中删除记录时，modelA中相关记录也全部删除 restrict: 当b中删除记录时，如果modelA中存在对应记录，则无法操作 b 的删除1a = fields.Many2one(&#x27;b&#x27;, string=&#x27;b&#x27;, ondelete=&#x27;set null&#x27;) 23、options create_edit","categories":[{"name":"odoo","slug":"odoo","permalink":"https://dbbruce.github.io/categories/odoo/"},{"name":"基础","slug":"odoo/基础","permalink":"https://dbbruce.github.io/categories/odoo/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"odoo知识点(二)","slug":"odoo/odoo知识点2","date":"2023-08-18T15:14:52.000Z","updated":"2024-11-26T06:04:25.841Z","comments":true,"path":"2023/08/18/odoo/odoo知识点2/","link":"","permalink":"https://dbbruce.github.io/2023/08/18/odoo/odoo%E7%9F%A5%E8%AF%86%E7%82%B92/","excerpt":"1、One2many和Many2many对象，有几种特殊的操作命令, 具体如下列表: 命令符 解释 举例 命令结构* CREATE 根据values里的值创建一条新记录 Command.create({‘name’:’张三’}) (0,0,{values}) UPDATE 根据values的值更新id对应的记录 Command.update(1,{‘name’:’王心怡’}) (1,ID,{values}) DELETE 删除id&#x3D;ID的这条记录 Command.delete(1) (2,ID) UNLINK 切断主从关系,但不删除该数据 Command.unlink(1) (3,ID) LINK 为id&#x3D;ID的数据添加关联关系,3的反向操作 Command.link(1) (4,ID) CLEAR 删除所有的主从关系,等价于循环调用记录集中的UNLINK方法 Command.clear() (5,) SET 用IDS中的记录替换原来的记录, 等价于先使用CLEAR命令再循环调用LINK命令 Command.set([1,2,3]) (6,0,[IDS])","text":"1、One2many和Many2many对象，有几种特殊的操作命令, 具体如下列表: 命令符 解释 举例 命令结构* CREATE 根据values里的值创建一条新记录 Command.create({‘name’:’张三’}) (0,0,{values}) UPDATE 根据values的值更新id对应的记录 Command.update(1,{‘name’:’王心怡’}) (1,ID,{values}) DELETE 删除id&#x3D;ID的这条记录 Command.delete(1) (2,ID) UNLINK 切断主从关系,但不删除该数据 Command.unlink(1) (3,ID) LINK 为id&#x3D;ID的数据添加关联关系,3的反向操作 Command.link(1) (4,ID) CLEAR 删除所有的主从关系,等价于循环调用记录集中的UNLINK方法 Command.clear() (5,) SET 用IDS中的记录替换原来的记录, 等价于先使用CLEAR命令再循环调用LINK命令 Command.set([1,2,3]) (6,0,[IDS]) 2.在视图控制 create&#x3D;”0” delete&#x3D;”false” edit&#x3D;”1”12345678910&lt;record id=&quot;view tree demo expense tutorial no create&quot; &lt;field name=&quot;name&quot;&gt;Demo Expense Tutorial List No create&lt;/field&gt; &lt;field name=&quot;model&quot;&gt;demo.expense.tutorial&lt;/field&gt; &lt;field name=&quot;arch&quot; type=&quot;xml&quot;&gt; &lt;tree string=&quot;no_create_tree&quot; create=&quot;0&quot; delete=&quot;false&quot; edit=&quot;1&quot; editable=&quot;top&quot;&gt; &lt;field name=&quot;name&quot;/&gt; &lt;field name=&quot;employee_id&quot;/&gt; &lt;/tree&gt; &lt;/field&gt;&lt;/record&gt; 3、sudo使用不同用户的权限查看数据12345&gt;&gt;&gt; self.env[&#x27;res.users&#x27;].search([])res.users(7, 6, 2)&gt;&gt;&gt; self.env[&#x27;res.users&#x27;].sudo().search([])res.users(7, 6, 2)&gt;&gt;&gt; self.env[&#x27;res.users&#x27;].sudo(users=2).search([]) # 切换到用户2的权限，查询数据 4、使用cli 还原db 以及filestore 1、还原db12createdb 数据库名称 -U 用户名 -W 密码psql -U 用户名 -d 数据库名 &lt; dump.sql 2、还原filestore，filestore一般存储图片最终成为 odoo-web-data&#x2F;filestore&#x2F;db_数据库名1234cd odoo-web-data/filestorecp -r backup/filestore ./mv filestore db_数据库名chmod 777 -R db_数据库名 5、_inherits123456789class StockManufacturerSon(models.Model): _name = &#x27;stock.manufacturer.grandson&#x27; _inherits = &#123;&#x27;stock.manufacturer.son&#x27;: &#x27;grand_id&#x27;&#125; _description = &#x27;Stock Manufacturer Grand Son&#x27; _order = &#x27;id asc&#x27; grandson = fields.Char(&#x27;Son&#x27;) granddaughter = fields.Char(&#x27;Daughter&#x27;) 这里注意 {‘stock.manufacturer.son’: ‘grand_id’}，其中**’grand_id’字段作为stock_manufacturer_grandson表与stock_manufacturer_son的关联字段。这里的 “_inherits” 也类似与将两个模型字段结合形成新表的感觉，但是不同的是stock_manufacturer_grandson表不会存储stock_manufacturer_son表的字段，而是在odoo模型对象中可以直接通过对象点”.”** 的方式直接访问stock.manufacturer.son对象的数据，其中stock.manufacturer.grandson对象直接操作stock.manufacturer.son对象数据，是会影响stock.manufacturer.son的对象数据的 6、action.server 执行Python的代码 model_id 绑定的modelbingding_model_id 绑定的model 命名规则：模块名.model_model名state 使用的方式 code &#x3D;&#x3D;&#x3D; python codecode 执行的python方法，绑定model的方法 1234567&lt;record id=&quot;action action demo&quot; model=&quot;ir.actions.server&quot;&gt; &lt;field name=&quot;name&quot;&gt;Action Demo&lt;/field&gt; &lt;field name=&quot;model_id&quot; ref=&quot;model_demo_actions_singleton&quot;/&gt; &lt;field name=&quot;binding_model_id&quot; ref=&quot;demo_actions_singleton.model_demo_actions_singleton&quot;/&gt; &lt;field name=&quot;state&quot;&gt;code&lt;/field&gt; &lt;field name=&quot;code&quot;&gt;action_demo()&lt;/field&gt;&lt;/record&gt; 7、ensure_one() 检查是否单例，返回false123def action_demo(self): self.ensure_one() return True 8、定时任务 定义model 12345678910from odoo import models,api,fieldsimport logging_logger = logging.getLogger(__name__)class DemoScheduler(models.Model): _name = &#x27;demo.scheduler&#x27; _description = &#x27;Demo Scheduler&#x27; def action_scheduler(self): _logger.info(&quot;定时任务执行了&quot;) 权限 ir.model.access.csv security.xml xml views&#x2F;scheduler.xml Odoo中内置了一个定时任务模型 ir.cron ，它定义了一套 定时、自动执行的规则interval_type 分，时，天，周，月，最小单位1分钟interval_number 次数，实例1天1次numbercall -1 表示无限， 2 只执行2次model_id 指定modelstate 使用Python codecode 执行的python方法priority 优先级，0 优先，10最后 1234567891011121314151617&lt;?xml version=&quot;1.◎&quot; ?&gt;&lt;odoo&gt; &lt;data noupdate=&quot;0&quot;&gt; &lt;record id=&quot;demo_scheduler&quot; model=&quot;ir.cron&quot;&gt; &lt;field name=&quot;interval_type&quot;&gt;days&lt;/field&gt; &lt;field name=&quot;name&quot;&gt;demo_scheduler&lt;/field&gt; &lt;fieldI name=&quot;numbercall&quot;&gt;-1&lt;/field&gt; &lt;field name=&quot;priority&quot;&gt;5&lt;/field&gt; &lt;field name=&quot;doall&quot;&gt;False&lt;/field&gt; &lt;field name=&quot;active&quot;&gt;True&lt;/field&gt; &lt;field name=&quot;interval_number&quot;&gt;1&lt;/field&gt; &lt;fieldi name=&quot;model_id&quot; ref=&quot;model_demo_scheduler&quot;/&gt; &lt;fieldI name=&quot;state&quot;&gt;code&lt;/field&gt; &lt;field name=&quot;code&quot;&gt;model.action_schedule()&lt;/field&gt; &lt;/record&gt; &lt;/data&gt;&lt;/odoo&gt; 后台查看定时任务 点击一条记录，可以手动触发，用于测试 9、序列号生成工具ir.sequence name 序列名称code - 调用生成编码的 Key，需保证唯一性（self.env[‘ir.sequence’].next_by_code(‘sequence.supplier_management’)可获取注册序列号）prefix - 前缀padding - 序列递增的位数 ，表示序列号数字部分的位数number_next表示序列号的递增数，比如number_next&#x3D;1，则下一个序列号比上一个序列号增1suffix -后缀 123456789&lt;record id=&quot;sequence_supplier_management_sn&quot; model=&quot;ir.sequence&quot;&gt; &lt;field name=&quot;name&quot;&gt;supplier_management&lt;/field&gt; &lt;field name=&quot;code&quot;&gt;sequence.supplier_management&lt;/field&gt; &lt;field name=&quot;active&quot;&gt;True&lt;/field&gt; &lt;field name=&quot;prefix&quot;&gt;%(year)s%(month)s%(day)s&lt;/field&gt; &lt;field name=&quot;padding&quot;&gt;5&lt;/field&gt; &lt;field name=&quot;number_next&quot;&gt;1&lt;/field&gt; &lt;field name=&quot;number_increment&quot;&gt;1&lt;/field&gt;&lt;/record&gt; 后台查看 12345@api.modeldef create(self, vals_list): # numbers是序列号字段，self.env[&#x27;ir.sequence&#x27;].next_by_code(&#x27;sequence.supplier_management&#x27;)可获取注册序列号。 vals_list[&#x27;numbers&#x27;] = self.env[&#x27;ir.sequence&#x27;].next_by_code(&#x27;sequence.supplier_management&#x27;) return super(SupplierManagement, self).create(vals_list) 10、activity 提醒 data&#x2F;mail_data.xml 定义一个activity的data name activity名称icon 图标res_model_id 绑定的model 格式：模块名.model_模型名 12345&lt;record id=&quot;mail_act_approval&quot; model=&quot;mail.activity.type&quot;&gt; &lt;field name=&quot;name&quot;&gt;Activity Approval&lt;/field&gt; &lt;field name=&quot;icon&quot;&gt;fa-dollar&lt;/field&gt; &lt;field name=&quot;res_model_id&quot; ref=&quot;demo_activity.model_demo_activity&quot;/&gt;&lt;/record&gt; 1234567891011121314151617181920212223class DemoActivity(models.Model): _name =&quot;demo.activity&quot; _description =&quot;Demo Activity&quot; _inherit =[&#x27;mail.thread&#x27;,&#x27;mail.activity.mixin&#x27;] name = fields.char(string=&#x27;name&#x27;,required=True) employee_id = fields.Many2one(&#x27;hr.employee&#x27;,string=&quot;Employee&quot;,required=True) # 指定activity_schedule给特定的人,类似发一个消息 def button_activity_schedule(self): self.activity_schedule(&#x27;demo_activity.mail_act_approval&#x27;, # model.xmlid==模型名.xmlid user_id = self.sudo().employee_id.user_id.id, # 指定给的用户id note =&#x27;my note&#x27;, # 消息 summary = &#x27;my summary&#x27; # 主题 ) # 类似回复消息 def button_activity_feedback(self): self.activity_feedback([&#x27;demo_activity.mail_act_approval&#x27;]) # 取消activity def button_activity_unlink(self): self.activity_unlink([&#x27;demo_activity.mail_act_approval&#x27;]) 注意加了xml就一定要修改权限文件 xml需要继承下面的代码才会显示 manifest文件里，加继承mail 1&#x27;depends&#x27;: [&#x27;base&#x27;,&#x27;mail&#x27;] 11、transientModel 暂时性记录的模型超类，意在暂时持久化，并定期进行真空清洗 _transient: 设置为True，标记模型为临时模型 1234567891011121314from odoo import models, fields, apiclass FeedbackWizard(models.TransientModel): _name = &#x27;feedback.wizard&#x27; _description = &#x27;Feedback Wizard&#x27; name = fields.Char(&#x27;Name&#x27;) email = fields.Char(&#x27;Email&#x27;) feedback = fields.Text(&#x27;Feedback&#x27;) def action_submit_feedback(self): # 这里可以添加将反馈记录到数据库或发送邮件的逻辑 # 举个例子，这里我们只是打印反馈 print(f&#x27;Received feedback from &#123;self.name&#125;: &#123;self.feedback&#125;&#x27;) transientModel 不需要加 access rule123456789101112131415161718192021&lt;record id=&quot;view_form_demo odoo_tutorial&quot; model=&quot;ir.ui.view&quot;&gt; &lt;field name=&quot;name&quot;&gt;Demo Odoo Tutorial Form&lt;/field&gt; &lt;field name=&quot;model&quot;&gt;demo.odoo.wizard.tutorial&lt;/field&gt; &lt;field name=&quot;arch&quot; type=&quot;xml&quot;&gt; &lt;form string=&quot;Demo odoo Tutorial&quot;&gt; &lt;header&gt; &lt;button name=&quot;%(demo_odoo_tutorial_wizard.demo_wizard_action)d&quot; type=&quot;action&quot; string=&quot;call wizard&quot; class=&quot;oe_highlight&quot; context=&quot;&#123;&#x27;default_partner_id&#x27;: partner_id&#125;&quot;/&gt; &lt;/header&gt; &lt;sheet&gt; &lt;group&gt; &lt;field name=&quot;name&quot;/&gt; &lt;field name=&quot;partner_id&quot;/&gt; &lt;/group&gt; &lt;/sheet&gt; &lt;/form&gt; &lt;/field&gt;&lt;/record&gt; 123456789&lt;record id=&quot;demo_wizard_action&quot; model=&quot;ir.actions.act_window&quot;&gt; &lt;field name=&quot;name&quot;&gt;Demo Wizard Action&lt;/field&gt; &lt;field name=&quot;res model&quot;&gt;demo.wizard&lt;/field&gt; &lt;field name=&quot;view_type&quot;&gt;form&lt;/field&gt; &lt;field name=&quot;view mode&quot;&gt;form&lt;/field&gt; &lt;field name=&quot;view_id&quot; ref=&quot;demo_wizard view form&quot;/&gt; &lt;field name=&quot;target&quot;&gt;new&lt;/field&gt; &lt;field name=&quot;context&quot;&gt;&#123;&#x27;default_test_pass_data&#x27;: &#x27;hello_123&#x27;&#125;&lt;/field&gt;&lt;/record&gt; 12、abstractModel 抽象模型，不可被实例化，仅供继承使用 不生成数据表 13、config settings _inherit &#x3D; ‘res.config.settings’ get_param() 取值 set_param() 设置值 14、datetime odoo date 和 datetime都是使用UTC的时区1234567import datetimenow = datetime.datetime.now()# 时间转字符串now.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;)# 字符串转时间datetime.datetime.strptime(&quot;2022-01-01 00:00:00&quot;, &quot;%Y-%m-%d %H:%M:%S&quot;) timedelta 时间上加加减减123456&gt;&gt;&gt; from datetime import timedelta&gt;&gt;&gt; from datetime import date&gt;&gt;&gt; date.today()datetime.date(2024, 9, 5)&gt;&gt;&gt; date.today() + timedelta(days=7)datetime.date(2024, 9, 12) odoo.tools.date_utils 1234567&gt;&gt;&gt; from datetime import date&gt;&gt;&gt; date.today()datetime.date(2024, 9, 5)&gt;&gt;&gt; date_utils.add(date.today(), days=2)datetime.date(2024, 9, 7)&gt;&gt;&gt; date_utils.subtract(date.today(), months=2)datetime.date(2024, 7, 5) fields.Date.today() fields.Datetime.now()12345&gt;&gt;&gt; from odoo import fields&gt;&gt;&gt; fields.Date.today()datetime.date(2024, 9, 5)&gt;&gt;&gt; fields.Datetime.now()datetime.datetime(2024, 9, 5, 15, 43, 10) 时区转换 15、barcodes 扫码 depends &#x3D; [‘barcodes’]","categories":[{"name":"odoo","slug":"odoo","permalink":"https://dbbruce.github.io/categories/odoo/"},{"name":"基础","slug":"odoo/基础","permalink":"https://dbbruce.github.io/categories/odoo/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"核算明细报告(ia.detail.report.query)","slug":"项目/医药公司ERP/20230818","date":"2023-08-18T14:14:52.000Z","updated":"2024-11-29T02:15:38.641Z","comments":true,"path":"2023/08/18/项目/医药公司ERP/20230818/","link":"","permalink":"https://dbbruce.github.io/2023/08/18/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/20230818/","excerpt":"1、项目结构 &#x2F;opt&#x2F;projects&#x2F;insuite&#x2F;biz&#x2F;cost&#x2F;ps_ia&#x2F;ia_report&#x2F;ia_detail_report_query&#x2F; 1234567891011121314ia_detail_report_query |____report | |____ia_detail_report_query.xml | |____ia_detail_report_query.py | |____ele_ctrl_config_data.xml # 按钮信息，操作按钮管理 | |______init__.py # 引入model文件 | |______pycache__ | | |____ia_detail_report.cpython-37.pyc | | |______init__.cpython-37.pyc | | |____ia_detail_report_query.cpython-37.pyc #cpython代表的是c语言实现的Python解释器，-37代表的是版本为3.7版 | |____ia_detail_report.py |______init__.py |______pycache__ | |______init__.cpython-37.pyc","text":"1、项目结构 &#x2F;opt&#x2F;projects&#x2F;insuite&#x2F;biz&#x2F;cost&#x2F;ps_ia&#x2F;ia_report&#x2F;ia_detail_report_query&#x2F; 1234567891011121314ia_detail_report_query |____report | |____ia_detail_report_query.xml | |____ia_detail_report_query.py | |____ele_ctrl_config_data.xml # 按钮信息，操作按钮管理 | |______init__.py # 引入model文件 | |______pycache__ | | |____ia_detail_report.cpython-37.pyc | | |______init__.cpython-37.pyc | | |____ia_detail_report_query.cpython-37.pyc #cpython代表的是c语言实现的Python解释器，-37代表的是版本为3.7版 | |____ia_detail_report.py |______init__.py |______pycache__ | |______init__.cpython-37.pyc 顺便讲下 __pycache__ 这个文件夹的作用： Python 解释器的工作流程： 完成模块的加载和链接； 将源代码编译为 PyCodeObject 对象（即字节码），存储在内存中供 CPU 执行； 从内存中读取并执行字节码，结束后将 PyCodeObject 写回硬盘，保存为 .pyc 或 .pyo 文件。 源更改 ：Python 自动检查源和字节码文件的最后修改时间戳来知道什么时候必须重新编译 —— 如果你编辑并重新保存了源码，字节码在下一次运行程序时就会自动重新创建 当再次执行同一脚本时，解释器会先检查： 当前目录下是否存在对应的 .pyc 文件； 该 .pyc 文件的修改时间是否晚于其源文件。 如果条件满足，则直接执行 .pyc 文件；否则，重复上述编译过程。 Python 解释器会将编译后的字节码存放在 __pycache__ 文件夹中。这样，在后续运行时，如果被调用的模块没有发生变化，解释器会直接从 __pycache__ 文件夹中读取并执行相关的 *.pyc 文件，从而大大缩短项目的启动时间。 2、模型继承关系 3、代码分析3.1 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187def _set_query_cells_igix(self, header_dict, query_rows, domain_fields, event_data, double_click_event_params): &quot;&quot;&quot; @desc: 查询数据组装报表信息-根据工单进行组织 @params: query_rows: 组装的表格数据 @params: domain_fields: 字段选择过滤条件 @return: 返回调用组织数据到表格中 &quot;&quot;&quot; # 单据类型，供翻译使用 doc_type_dict = &#123; &#x27;init&#x27;: _(&#x27;Initial&#x27;), # 期初 &#x27;acct_result&#x27;: _(&#x27;Accounting Result&#x27;), # 核算结果 &#x27;balance&#x27;: _(&#x27;Amount Balance&#x27;), # 余额 &#x27;stk.pur.receipt.line&#x27;: _(&#x27;Stock Purchase Receipt&#x27;), # 采购入库单 &#x27;stk.pur.return.line&#x27;: _(&#x27;Purchase Return&#x27;), # 采购退库单 &#x27;stk.pro.in.line1&#x27;: _(&#x27;Stk Pro In&#x27;), # 生产入库单 &#x27;stk.pro.out.line1&#x27;: _(&#x27;Stk Pro Out&#x27;), # 生产退库单 &#x27;stk.mis.in.line1&#x27;: _(&#x27;Stock Miscellaneous In&#x27;), # 其他入库单 &#x27;stk.inventory.profit.line1&#x27;: _(&#x27;Stock Inventory Profit&#x27;), # 盘盈单 &#x27;stk.inventory.loss.line1&#x27;: _(&#x27;Stock Inventory Loss&#x27;), # 盘亏单 &#x27;ia.cost.adjustment.line1&#x27;: _(&#x27;Cost Adjustment&#x27;), # 成本调整单 &#x27;stk.simple.pro.in.line1&#x27;: _(&#x27;Simple Production Receipt&#x27;), # 简单生产入库单 &#x27;stk.simple.pro.out.line1&#x27;: _(&#x27;Simple Production Return&#x27;), # 简单生产退库单 &#x27;stk.delivery.line1&#x27;: _(&#x27;Stock Delivery&#x27;), # 销售出库单 &#x27;stk.return.line1&#x27;: _(&#x27;Stock Return&#x27;), # 销售退库单 &#x27;stk.pro.pick.line1&#x27;: _(&#x27;Stk Pro Pick&#x27;), # 生产领料单 &#x27;stk.pro.material.return.line1&#x27;: _(&#x27;Product Material Return&#x27;), # 生产退料单 &#x27;stk.mis.out.line1&#x27;: _(&#x27;Stock Miscellaneous Out&#x27;), # 其他出库单 &#x27;stk.direct.trans.line1&#x27;: _(&#x27;Stock Direct Transfer&#x27;), # 直接调拨单 &#x27;medinv.direct.trans.line1&#x27;: &#x27;手工移库单&#x27;, &#x27;stk.pro.feed.line1&#x27;: _(&#x27;Production Feeding&#x27;), # 生产补料单 &#x27;stk.simple.pro.pick.line1&#x27;: _(&#x27;Simple Product Pick&#x27;), # 简单生产领料单 &#x27;stk.simple.pro.return.line1&#x27;: _(&#x27;Simple Product Return&#x27;), # 简单生产退料单 &#x27;stk.sub.pick.line1&#x27;: _(&#x27;Subcontract Pick&#x27;), # 委外领料单 &#x27;stk.sub.return.line1&#x27;: _(&#x27;Subcontract Return&#x27;), # 委外退料单 &#x27;stk.sub.supplement.line1&#x27;: _(&#x27;Subcontract Supplement&#x27;), # 委外补料单 &#x27;stk.step.trans.in.line1&#x27;: _(&#x27;Stock Step Trans In&#x27;), # 分步式调入单 &#x27;stk.step.trans.out.line1&#x27;: _(&#x27;Stock Step Trans Out&#x27;), # 分步式调出单 &#x27;stk.form.conversion.line1&#x27;: _(&#x27;Form Conversion&#x27;), # 形态转换单 &#x27;stk.pack.line1&#x27;: _(&#x27;Stock Pack&#x27;), # 库存组装单 &#x27;stk.unpack.line1&#x27;: _(&#x27;Stock Unpack&#x27;), # 库存拆卸单 #########################医药新加单据########################################### &#x27;med.gsp.pur.receipt.line&#x27;: _(&#x27;Stock Purchase Receipt&#x27;), # 采购入库单 &#x27;med.gsp.purchase.return.line&#x27;: _(&#x27;Purchase Return&#x27;), # 采购退库单 &#x27;med.stk.delivery.line1&#x27;: _(&#x27;Stock Delivery&#x27;), # 销售出库单 &#x27;med.inv.sal.return.line1&#x27;: _(&#x27;Sale Return Receipt&#x27;), # 销售退货入库单 &#x27;med.unqualified.comm.bookkeeping.line1&#x27;: _(&#x27;Unqualified Comm Bookkeeping&#x27;), # 不合格报损记账 &#x27;med.inv.loss.reporting.documents.line1&#x27; : _(&#x27;Loss reporting documents&#x27;), # 报损单 &#x27;med.inv.overflow.report.line1&#x27; : _(&#x27;Overflow Report&#x27;), # 报溢单 &#x27;medinv.direct.trans.line1&#x27; : _(&#x27;Med Stock Direct Tranfer&#x27;), # 手工移库单 &#125; # 计价方法 val_method = &#123; &#x27;monthly_cost&#x27;: _(&#x27;Monthly Cost&#x27;), # 全月一次 &#x27;avg_cost&#x27;: _(&#x27;Average Cost&#x27;), # 移动加权 &#x27;fifo&#x27;: _(&#x27;First In First Out&#x27;) # 先进先出 &#125; # 获取核算明细报告数据 domain = [ (&#x27;accting_sys_id&#x27;, &#x27;=&#x27;, domain_fields.get(&#x27;accting_sys_id&#x27;, False)), (&#x27;accting_org_id&#x27;, &#x27;=&#x27;, domain_fields.get(&#x27;accting_org_id&#x27;, False)), (&#x27;accting_policy_id&#x27;, &#x27;=&#x27;, domain_fields.get(&#x27;accting_policy_id&#x27;, False)), (&#x27;accting_period_id&#x27;, &#x27;=&#x27;, domain_fields.get(&#x27;accting_period_id&#x27;, False)) ] # 根据筛选条件（物料、核算范围、货主、库存组织、仓库）组织domain过滤条件 if domain_fields.get(&#x27;material_ids&#x27;, False): material_master_ids = self.env[&#x27;mdm.material&#x27;].browse(domain_fields[&#x27;material_ids&#x27;]) master_id_list = [int(rec.master_id) for rec in material_master_ids] domain.append((&#x27;material_id&#x27;, &#x27;in&#x27;, master_id_list)) if domain_fields.get(&#x27;accting_range_ids&#x27;, False): domain.extend([&#x27;|&#x27;, (&#x27;accting_dimensions_id.accting_range_id&#x27;, &#x27;in&#x27;, domain_fields[&#x27;accting_range_ids&#x27;]), (&#x27;document_type&#x27;, &#x27;in&#x27;, [&#x27;acct_result&#x27;, &#x27;balance&#x27;])]) else: domain.extend([&#x27;|&#x27;, (&#x27;accting_dimensions_id.accting_range_id.forbid_state&#x27;, &#x27;=&#x27;, &#x27;normal&#x27;), (&#x27;document_type&#x27;, &#x27;in&#x27;, [&#x27;acct_result&#x27;, &#x27;balance&#x27;])]) if domain_fields.get(&#x27;owner_ids&#x27;, False): owner_range = [&#x27;sys.admin.orgs,%s&#x27; % x for x in domain_fields[&#x27;owner_ids&#x27;]] domain.extend([&#x27;|&#x27;, (&#x27;owner_type&#x27;, &#x27;in&#x27;, owner_range), (&#x27;document_type&#x27;, &#x27;in&#x27;, [&#x27;acct_result&#x27;, &#x27;balance&#x27;])]) if domain_fields.get(&#x27;stk_org_ids&#x27;, False): domain.extend([&#x27;|&#x27;, (&#x27;stk_org_id&#x27;, &#x27;in&#x27;, domain_fields[&#x27;stk_org_ids&#x27;]), (&#x27;document_type&#x27;, &#x27;in&#x27;, [&#x27;acct_result&#x27;, &#x27;balance&#x27;])]) else: domain.extend([&#x27;|&#x27;, (&#x27;stk_org_id&#x27;, &#x27;in&#x27;, domain_fields[&#x27;stk_org_domain&#x27;]), (&#x27;document_type&#x27;, &#x27;in&#x27;, [&#x27;acct_result&#x27;, &#x27;balance&#x27;])]) if domain_fields.get(&#x27;warehouse_ids&#x27;, False): domain.extend([&#x27;|&#x27;, (&#x27;warehouse_id&#x27;, &#x27;in&#x27;, domain_fields[&#x27;warehouse_ids&#x27;]), (&#x27;document_type&#x27;, &#x27;in&#x27;, [&#x27;acct_result&#x27;, &#x27;balance&#x27;])]) # 搜索核算明细报告，组织报表数据 acct_detail_report = self.env[&#x27;ia.detail.report&#x27;].search(domain, order=&#x27;accting_dimensions_id, sequence&#x27;) # 没有出库单据数据时，不显示核算结果与余额 out_dimension = acct_detail_report.filtered(lambda x: x.qty_option == &#x27;-1&#x27;).accting_dimensions_id.ids acct_detail_report = acct_detail_report.filtered(lambda x: x.material_val_method in [&#x27;avg_cost&#x27;, &#x27;fifo&#x27;] or x.document_type == &#x27;init&#x27; or x.qty_option == &#x27;1&#x27; or x.accting_dimensions_id.id in out_dimension) acct_demision = False qty = 0.0 amount = 0.0 qty_str = &#x27;0&#x27; amount_str = &#x27;0&#x27; qty_precision_dict, price_precision_dict, amount_precision_dict = self._get_precision_dict() for row, val in enumerate(acct_detail_report): uom_id = val.material_id.uom_id.id currency_id = val.accting_currency_id.id qty_precision = qty_precision_dict.get(uom_id) price_precision = price_precision_dict.get(currency_id) amount_precision = amount_precision_dict.get(currency_id) query_row = QueryRow() if not acct_demision or acct_demision != val.accting_dimensions_id.id: query_row[&#x27;material_number&#x27;] = val.material_id.number query_row[&#x27;material_name&#x27;] = val.material_id.name query_row[&#x27;specification&#x27;] = val.material_id.specification or &#x27;&#x27; query_row[&#x27;accting_range_id&#x27;] = val.accting_dimensions_id.accting_range_id.name query_row[&#x27;material_val_method&#x27;] = val_method.get(val.material_val_method) # 维度改变，清空数量单价金额 qty = 0.0 amount = 0.0 qty_str = &#x27;0&#x27; amount_str = &#x27;0&#x27; # 记录本次核算维度id acct_demision = val.accting_dimensions_id.id query_row[&#x27;document_type&#x27;] = doc_type_dict.get(val.document_type, &#x27;&#x27;) query_row[&#x27;doc_number&#x27;] = val.doc_number or &#x27;&#x27; query_row[&#x27;owner_type&#x27;] = val.owner_type.name if val.owner_type else &#x27;&#x27; query_row[&#x27;stk_org_id&#x27;] = val.stk_org_id.name or &#x27;&#x27; query_row[&#x27;warehouse_id&#x27;] = val.warehouse_id.name or &#x27;&#x27; # 移动加权 &amp; 全月一次 if val.material_val_method in [&#x27;avg_cost&#x27;, &#x27;fifo&#x27;]: query_row[&#x27;qty&#x27;] = val.qty or &#x27;&#x27; query_row[&#x27;income&#x27;] = val.income query_row[&#x27;expenses&#x27;] = val.expenses query_row[&#x27;balance&#x27;] = val.balance # 全月一次 elif val.material_val_method == &#x27;monthly_cost&#x27;: report_qty = val.qty report_income = &#x27;&#x27; # 收入 report_expenses = &#x27;&#x27; # 发出 report_balance = &#x27;&#x27; # 结存 # 数量、单价累加 if val.qty_option == &#x27;1&#x27; or val.document_type == &#x27;init&#x27;: qty = self.env[&#x27;mdm.unit&#x27;].p_qty_float_round(qty + val.qty, val.material_id.uom_id.id) amount = self.env[&#x27;mdm.currency&#x27;].p_amount_float_round(amount + val.cost_amount, val.accting_currency_id.id) elif val.qty_option == &#x27;-1&#x27;: qty = self.env[&#x27;mdm.unit&#x27;].p_qty_float_round(qty - val.qty, val.material_id.uom_id.id) amount = self.env[&#x27;mdm.currency&#x27;].p_amount_float_round(amount - val.cost_amount, val.accting_currency_id.id) # 数量、单价字符串 qty_str = self.env[&#x27;mdm.unit&#x27;].p_qty_float_repr(qty, val.material_id.uom_id.id) # 本条数据数量、单价、金额字符串 cost_qty_str = self.env[&#x27;mdm.unit&#x27;].p_qty_float_repr(val.qty, val.material_id.uom_id.id) cost_price_str = self.env[&#x27;mdm.currency&#x27;].p_price_float_repr(val.cost_price, val.accting_currency_id.id) cost_amount_str = self.env[&#x27;mdm.currency&#x27;].p_amount_float_repr(val.cost_amount, val.accting_currency_id.id) # 总金额字符串 total_amount_str = self.env[&#x27;mdm.currency&#x27;].p_amount_float_repr(amount, val.accting_currency_id.id) # 期初单据结存 if val.document_type == &#x27;init&#x27;: init_qty_str = self.env[&#x27;mdm.unit&#x27;].p_qty_float_repr(val.qty, val.material_id.uom_id.id) # 期初数量 init_price_str = self.env[&#x27;mdm.currency&#x27;].p_price_float_repr(val.cost_price, val.accting_currency_id.id) # 期初单价 report_balance = &#x27;%s = %s * %s&#x27; % (cost_amount_str, init_qty_str, init_price_str) # 入库单据结存 elif val.qty_option == &#x27;1&#x27;: report_income = &#x27;%s * %s = %s&#x27; % (cost_qty_str, cost_price_str, cost_amount_str) report_balance = &#x27;%s = %s + %s&#x27; % (total_amount_str, amount_str, cost_amount_str) # 出库单据结存 elif val.qty_option == &#x27;-1&#x27;: if float_compare(val.residual_val, 1, 2) != 0 and float_compare(val.residual_val, 0, 2) != 0: report_expenses = &#x27;%s * %s * %s = %s&#x27; % (cost_qty_str, acct_result_price, val.residual_val, cost_amount_str) else: report_expenses = &#x27;%s * %s = %s&#x27; % (cost_qty_str, cost_price_str, cost_amount_str) report_balance = &#x27;%s = %s - %s&#x27; % (total_amount_str, amount_str, cost_amount_str) # 核算结果 elif val.document_type == &#x27;acct_result&#x27;: report_qty = &#x27;&#x27; acct_result_price = cost_price_str if float_compare(val.residual_val, 1, 2) != 0 and float_compare(val.residual_val, 0, 2) != 0: report_income = &#x27;%s = %s / %s * %s&#x27; % (cost_price_str, total_amount_str, qty_str, val.residual_val) else: report_income = &#x27;%s = %s / %s&#x27; % (cost_price_str, total_amount_str, qty_str) # 余额 elif val.document_type == &#x27;balance&#x27;: report_qty = qty report_balance = &#x27;%s&#x27; % total_amount_str # 上次金额字符串 amount_str = total_amount_str query_row[&#x27;qty&#x27;] = report_qty query_row[&#x27;income&#x27;] = report_income query_row[&#x27;expenses&#x27;] = report_expenses query_row[&#x27;balance&#x27;] = report_balance query_row[&quot;qty_precision&quot;] = qty_precision query_row[&quot;price_precision&quot;] = price_precision query_row[&quot;amount_precision&quot;] = amount_precision query_rows.append(query_row)","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"医药公司ERP","slug":"项目/医药公司ERP","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/"},{"name":"业务","slug":"项目/医药公司ERP/业务","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/%E4%B8%9A%E5%8A%A1/"}],"tags":[]},{"title":"odoo知识点(一)","slug":"odoo/odoo知识点1","date":"2023-08-18T14:14:52.000Z","updated":"2024-11-26T06:04:25.836Z","comments":true,"path":"2023/08/18/odoo/odoo知识点1/","link":"","permalink":"https://dbbruce.github.io/2023/08/18/odoo/odoo%E7%9F%A5%E8%AF%86%E7%82%B91/","excerpt":"1、增 create参数解释： vals_list：字典类型，添加数据时，数据还未保存到数据库中时，数据保存在此，字典的key为模型字段名，字典的value为模型的字段值。vals_list[‘字段名’]&#x3D;字段值 res：成功创建后，即为数据已经保存到数据库中。返回的数据记录集。res.字段名&#x3D;字段值 super(模型类名,self)。第一个参数为模型类名，而不是模型名。在点击保存时触发此方法，而不是点击创建时触发此方法。1234@api.modeldef create(self, vals_list): res = super(EpidemicRecord, self).create(vals_list) return res","text":"1、增 create参数解释： vals_list：字典类型，添加数据时，数据还未保存到数据库中时，数据保存在此，字典的key为模型字段名，字典的value为模型的字段值。vals_list[‘字段名’]&#x3D;字段值 res：成功创建后，即为数据已经保存到数据库中。返回的数据记录集。res.字段名&#x3D;字段值 super(模型类名,self)。第一个参数为模型类名，而不是模型名。在点击保存时触发此方法，而不是点击创建时触发此方法。1234@api.modeldef create(self, vals_list): res = super(EpidemicRecord, self).create(vals_list) return res 2、改 write参数解释： self：为对象，当前正在修改的数据集的元数据，可以为多条数据 vals：为字典类型，我们所修改字段的数据，key为字段名，value为字段值 res：返回值为布尔类型，修改成功返回True，修改失败返回False创建记录保存时，只执行create方法，不执行write方法，只要在修改数据后，保存数据才会执行write方法，且create方法只会在创建时执行一次。1234@api.multidef write(self, vals): res = super(EpidemicRecord, self).write(vals) return res 3、删除 unlink参数解释： self：当前操作的数据集 删除当前数据集的所有记录，并返回一个布尔值，true删除成功，false删除失败。 可以在重写此方法，来达到假删除的，而不是直接从数据库中删除。1234@api.multidef unlink(self): res = super(EpidemicRecord, self).unlink() return res 4、查 browse self.browse(ids) 方法，ids是一个列表 self.search(domain, order&#x3D;’id’, limit&#x3D;1) 方法，domain 是查询条件, limit 取前limit个，order排序方式 5、Many2many12345678tag_ids = fields.Many2many( comodel_name=&#x27;todo.task.tag&#x27;, # 关联 model relation=&#x27;todo_task_tag_rel&#x27;, # 关联表名称 column1=&#x27;task_id&#x27;, # 当前model id column2=&#x27;tag_id&#x27;, # 关联表 id string=&#x27;Tags&#x27; # 显示标签) 6、xml options小总结：Options : 您可以使用此小部件的其他可能选项no_quick_create - 它将删除创建和编辑…选项。no_create_edit - 它将删除创建“输入文本”选项。no_create - 无快速创建和无创建编辑组合。no_open - 在读取模式下：不作为链接渲染。 1&lt;field name=&quot;product_id&quot; options=&quot;&#123;&#x27;no_open&#x27;: True,&#x27;no_create&#x27;: True&#125;&quot;/&gt; 7、multi装饰器 ，参数vals是一个list8、定义按钮，type&#x3D;object, 可以调用Python方法 9、权限规则 ir.model.access.csv 文件设置权限，权限管理核心是权限组，每个权限组，可以设置权限组的访问权限（perm_create、perm_read、perm_write、perm_unlink，如果用户没有（通过其组）对模型的操作相匹配的访问权限，则该用户不能对模型读取、编辑、创建、删除。1234id,name,model_id/id,group_id/id,perm_read,perm_write,perm_create,perm_unlinkaccess_work_plan_group_base,work.plan,model_work_plan,work_plan.group_base,1,1,1,0access_work_plan_group_director,work.plan,model_work_plan,work_plan.group_director,0,1,0,1access_work_plan_group_manager,work.plan,model_work_plan,work_plan.group_manager,0,0,0,1 表级别权限(访问权限) 1234567891011121314151617181920&lt;record id=&quot;work_plan.group_base&quot; model=&quot;res.groups&quot;&gt; &lt;!--组标识--&gt; &lt;field name=&quot;name&quot;&gt;用户&lt;/field&gt; &lt;field name=&quot;category_id&quot; ref=&quot;work_plan.module_category&quot;/&gt;&lt;!--模块类别，指定group属于哪一个category--&gt; &lt;field name=&quot;implied_ids&quot; eval=&quot;[(4,ref(&#x27;base.group_user&#x27;))]&quot;/&gt;&lt;!--implied_ids：伪继承，后面跟本组要继承的其他组,继承后本组用户具备其他组权限--&gt; &lt;field name=&quot;comment&quot;&gt;用户可以增、改、查工作计划记录&lt;/field&gt;&lt;!--组的附加说明--&gt;&lt;/record&gt;&lt;record id=&quot;work_plan.group_director&quot; model=&quot;res.groups&quot;&gt; &lt;field name=&quot;category_id&quot; ref=&quot;work_plan.module_category&quot;/&gt; &lt;field name=&quot;name&quot;&gt;主管&lt;/field&gt; &lt;field name=&quot;implied_ids&quot; eval=&quot;[(4,ref(&#x27;work_plan.group_base&#x27;))]&quot;/&gt; &lt;field name=&quot;comment&quot;&gt;主管可以增、删、改、查自己部门及其子部门的记录&lt;/field&gt;&lt;/record&gt;&lt;record id=&quot;work_plan.group_manager&quot; model=&quot;res.groups&quot;&gt; &lt;field name=&quot;category_id&quot; ref=&quot;work_plan.module_category&quot;/&gt; &lt;field name=&quot;name&quot;&gt;管理员&lt;/field&gt; &lt;field name=&quot;implied_ids&quot; eval=&quot;[(4,ref(&#x27;work_plan.group_director&#x27;))]&quot;/&gt; &lt;field name=&quot;comment&quot;&gt;管理员可以增、删、改、查工作计划记录&lt;/field&gt;&lt;/record&gt; 10、视图继承 position定位有如下选择inside 在内部结尾插入元素replace 替换元素before 在之前插入元素after 在其后插入元素attributes 修改xml的属性 123456789101112131415&lt;record id=&quot;building_list_view&quot; model=&quot;ir.ui.view&quot;&gt; &lt;field name=&quot;name&quot;&gt;building.list.view&lt;/field&gt; &lt;field name=&quot;model&quot;&gt;ibuilding.list&lt;/field&gt; &lt;field name=&quot;inherit_id&quot; ref=&quot;building_list&quot;/&gt; &lt;field name=&quot;arch&quot; type=&quot;xml&quot;&gt; &lt;!-- 找到ids字段，在其后添加idea_id字段 --&gt; &lt;xpath expr=&quot;//field[@name=&#x27;ids&#x27;]&quot; position=&quot;after&quot;&gt; &lt;field name=&quot;idea_id&quot; string=&quot;Number of ideas&quot;/&gt; &lt;/xpath&gt; &lt;!-- 找到 upload 字段，在其后添加download字段 --&gt; &lt;xpath expr=&quot;//field[@name=&#x27;upload&#x27;]&quot; position=&quot;replace&quot;&gt; &lt;field name=&quot;download&quot; string=&quot;下载一个文件&quot;/&gt; &lt;/xpath&gt; &lt;/field&gt;&lt;/record&gt; 11、限制 装饰器约束(字段约束)12345@api.constrains(&#x27;instructor_id&#x27;, &#x27;attendee_ids&#x27;)def _check_instructor_not_in_attendees(self): for r in self: if r.instructor_id and r.instructor_id in r.attendee_ids: raise exceptions.ValidationError(&quot;A session&#x27;s instructor can&#x27;t be an attendee&quot;) sql约束1234_sql_constraints = [ (&#x27;name_uniq&#x27;, &#x27;unique(name, company_id)&#x27;, &#x27;Reference must be unique per Company!&#x27;), (&#x27;qty_positive&#x27;, &#x27;check(product_qty &gt; 0)&#x27;, &#x27;The quantity to produce must be positive!&#x27;), ] 12、odoo shell1python3 odoo-bin shell -c odoo.conf 13、视图注意：图中注释有误，priority为优先级，eval赋值，优先等级赋值为16； 14、search12345678910111213# 多条件默认是and， id=3 and id=1self.env[&#x27;meet.meet_room&#x27;].search([(&#x27;id&#x27;,&#x27;=&#x27;,&#x27;3&#x27;),(&#x27;id&#x27;,&#x27;=&#x27;, &#x27;1&#x27;)])#与的方式self.env[&#x27;meet.meet_room&#x27;].search([&#x27;|&#x27;, (&#x27;id&#x27;,&#x27;=&#x27;,&#x27;3&#x27;),(&#x27;id&#x27;,&#x27;=&#x27;, &#x27;1&#x27;)])#likeself.env[&#x27;meet.meet_room&#x27;].search([(&#x27;name&#x27;,&#x27;like&#x27;,&#x27;大&#x27;)])meet.meet_room(1,)#inself.env[&#x27;meet.meet_room&#x27;].search([(&#x27;id&#x27;,&#x27;in&#x27;,[1,3])])meet.meet_room(3, 1) 15、ids12mt = self.env[&#x27;meet.meet_room&#x27;].search([])mt.ids 16、filter(func)123&gt;&gt;&gt; mt = self.env[&#x27;meet.meet_room&#x27;].search([])&gt;&gt;&gt; mt.filtered(lambda r: r.name.startswith(&#x27;大&#x27;))meet.meet_room(5, 1) 17、map(func)123#指定字段的名查询出来，返回一个list&gt;&gt;&gt; mt.mapped(&#x27;name&#x27;)[&#x27;大厅&#x27;, &#x27;台球厅888&#x27;, &#x27;多媒体&#x27;, &#x27;大礼堂&#x27;] 18、sorted12&gt;&gt;&gt; mt.sorted(key=lambda r: r.id, reverse=True)meet.meet_room(5, 3, 2, 1) 19、One2manyone2many是一个虚拟栏，不会在表上出现任何字段，但是你在related表中看到，也就是说A表没有expense_line_ids字段，但是B表上会有sheet_id字段 20、name_get _name_search 21、tree视图中隐藏特定列您可以使用以下 XML 仅在 status 字段的值为 done 时隐藏 description 字段该attrs属性用于指定一个域，该域确定何时应隐藏 description 字段。该域的语法与 column_invisible 属性中使用的域相同，其中包含一个元组列表，指定要隐藏该字段必须满足的条件 1&lt;field name=&quot;description&quot; column_invisible=&quot;1&quot; attrs=&quot;&#123;&#x27;invisible&#x27;: [(&#x27;status&#x27;, &#x27;=&#x27;, &#x27;done&#x27;)]&#125;&quot; /&gt; 22、权限文件，ir.models.access.csv 23、self 24、buttontype object ，调用py方法 name &#x3D; 方法名type action ，调用视图，name &#x3D; %(xml action id)d 25、active_id 当前记录的id 26、指定表名_table &#x3D; 指定表名，默认用_name 27、横向排列,4列12345&lt;group col=&quot;4&quot;&gt; &lt;field name=&quot;name&quot;/&gt; &lt;field name=&quot;parent_id&quot;/&gt; &lt;field name=&quot;sequence&quot;/&gt;&lt;/group&gt; 28、form优先级 &lt;field name&#x3D;”priority”eval&#x3D;’1’&#x2F;&gt; eval越小，优先级越高12345678910&lt;record id=&quot;estate_property_offer_view_form&quot; model=&quot;ir.ui.view&quot;&gt; &lt;field name=&quot;name&quot;&gt;estate property tag view form&lt;/field&gt; &lt;field name=&quot;model&quot;&gt;estate.property.offer&lt;/field&gt; &lt;field name=&quot;priority&quot; eval=&quot;1&quot;&gt;&lt;/field&gt; &lt;field name=&quot;arch&quot; type=&quot;xml&quot;&gt; &lt;form&gt; &lt;field name=&quot;price&quot;/&gt; &lt;form&gt; &lt;/field&gt;&lt;/record&gt; 29、noupdate&#x3D;0&#x2F;1 生效1一次，0是多次1：只生效一次0：多次生效 1&lt;data noupdate=&quot;1&quot;&gt; 30、odoo后台调试工具 31、权限限制，设置权限，1&#x3D;1是全部有权限 32、name_get规定name的格式，但是数据库只保存name的值，每次会动态生成新name，例如下面：name输入cccc，数据库只保存cccc，名字会动态变成了2020-07-cccc 33、_name_search例如上例：name是动态生成的，数据库只会存储cccc，查询只能查到cccc，动态生成的name不能查询，使用_name_search解决这个问题。 34、Command.create(xxxx) &#x3D; (0,0,xxxx)123456789101112131415161718192021def do_sold(self): self.env[&#x27;account.move&#x27;].create( &#123; &#x27;partner_id&#x27;: self.buyer_id.id, &#x27;move_type&#x27;: &#x27;out_invoice&#x27;, &#x27;journal_id&#x27;: 1, &#x27;invoice_line_ids&#x27;: [ (0, 0, &#123; &#x27;name&#x27;: &quot;营业税&quot;, &#x27;quantity&#x27;: 1, &#x27;price_unit&#x27;: self.selling_price*0.06, &#125;), Command.create(&#123; &#x27;name&#x27;: &quot;行政费用&quot;, &#x27;quantity&#x27;: 1, &#x27;price_unit&#x27;: 100, &#125; ) ] &#125; )","categories":[{"name":"odoo","slug":"odoo","permalink":"https://dbbruce.github.io/categories/odoo/"},{"name":"基础","slug":"odoo/基础","permalink":"https://dbbruce.github.io/categories/odoo/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"011-python连接mysql","slug":"爬虫/基础/011-python连接mysql","date":"2023-08-18T07:04:52.000Z","updated":"2024-05-31T01:46:58.000Z","comments":true,"path":"2023/08/18/爬虫/基础/011-python连接mysql/","link":"","permalink":"https://dbbruce.github.io/2023/08/18/%E7%88%AC%E8%99%AB/%E5%9F%BA%E7%A1%80/011-python%E8%BF%9E%E6%8E%A5mysql/","excerpt":"最新版 pip install mysql-connector-python 连接","text":"最新版 pip install mysql-connector-python 连接 12345678910111213141516171819202122232425262728293031import mysql.connectorfrom mysql.connector import errorcodeimport configparser# 创建配置解析器对象config = configparser.ConfigParser()# 读取配置文件config.read(&#x27;config.ini&#x27;)try: # 配置连接信息 conn = mysql.connector.connect( host=config.get(&#x27;mysql&#x27;, &#x27;host&#x27;), port=config.get(&#x27;mysql&#x27;, &#x27;port&#x27;), user=config.get(&#x27;mysql&#x27;, &#x27;user&#x27;), password=config.get(&#x27;mysql&#x27;, &#x27;password&#x27;), database=config.get(&#x27;mysql&#x27;, &#x27;database&#x27;) ) # 当前 mysql 版本号 print(conn.get_server_version()) # 捕获异常except mysql.connector.Error as err: if err.errno == errorcode.ER_ACCESS_DENIED_ERROR: print(&#x27;账号或密码错误！&#x27;) elif err.errno == errorcode.ER_BAD_DB_ERROR: print(&#x27;数据库不存在！&#x27;) else: print(err)else: # 关闭连接 conn.close() 插入、更新、删除 execute()：用来执行 sql 语句，如：增删改查，存储过程等 commit()：用来提交事务 executemany：批量操作123456789101112131415161718192021222324252627282930313233import mysql.connector# 配置连接信息conn = mysql.connector.connect( host=&#x27;127.0.0.1&#x27;, port=&#x27;3306&#x27;, user=&#x27;root&#x27;, password=&#x27;12345&#x27;, database=&#x27;python_demo&#x27;)# 创建游标对象cursor = conn.cursor()# 操作数据：插入、修改、删除 同理，注：数据类型均可用 %s# 操作一条数据sql = &#x27;insert into student(sname, age, birthday) values(%s, %s, %s);&#x27;param = (&#x27;张三&#x27;, &#x27;18&#x27;, &#x27;1994-12-08&#x27;)cursor.execute(sql, param)# 操作多条数据sql = &#x27;insert into student(sname, age, birthday) values(%s, %s, %s);&#x27;param = [(&#x27;李四&#x27;, &#x27;20&#x27;, &#x27;1992-10-05&#x27;), (&#x27;王五&#x27;, &#x27;16&#x27;, &#x27;1996-05-26&#x27;), (&#x27;赵六&#x27;, &#x27;08&#x27;, &#x27;1994-05-26&#x27;)]cursor.executemany(sql, param)# 提交数据conn.commit()# 关闭游标和数据库连接cursor.close()conn.close() 12345678910111213141516171819202122232425262728import mysql.connector# 配置连接信息conn = mysql.connector.connect( host=&#x27;127.0.0.1&#x27;, port=&#x27;3306&#x27;, user=&#x27;root&#x27;, password=&#x27;12345&#x27;, database=&#x27;python_demo&#x27;)# 创建游标对象cursor = conn.cursor()# 查询数据sql = &#x27;select sno, sname, age, birthday from student where sno &gt;= %s&#x27;param = (1,)cursor.execute(sql, param)result = cursor.fetchall()# 打印结果for row in result: print(row)# 关闭游标和数据库连接cursor.close()conn.close()","categories":[{"name":"爬虫类","slug":"爬虫类","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/"},{"name":"基础","slug":"爬虫类/基础","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"订单中涉及的库存数量名词","slug":"项目/医药公司ERP/20230817-涉及的库存名称","date":"2023-08-17T14:14:52.000Z","updated":"2024-11-29T02:15:38.612Z","comments":true,"path":"2023/08/17/项目/医药公司ERP/20230817-涉及的库存名称/","link":"","permalink":"https://dbbruce.github.io/2023/08/17/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/20230817-%E6%B6%89%E5%8F%8A%E7%9A%84%E5%BA%93%E5%AD%98%E5%90%8D%E7%A7%B0/","excerpt":"1、词汇汇总","text":"1、词汇汇总 英文 中文 字段名 解释 Auxiliary Unit Quantity 辅助数量 aux_qty 辅助数量 Available Escrow No Quantity(Stock Unit) 非代管可用数量 available_no_escrow_stk_qty 非代管可用数量 Available Quantity(Aux Unit) 可用量（辅助单位） available_aux_qty 可用量（辅助单位） Available Quantity(Base Unit) 可用量（基本单位） available_qty 可用量（基本单位） Available Quantity(Stock Unit) 可用量（库存单位） available_stk_qty 可用量（库存单位） Base Unit Quantity 基本数量 qty 基本数量 Escrow Quantity(Stock Unit) 代管数量 escrow_stk_qty 代管数量 Occupied Quantity(Aux Unit) 占用量（辅助单位） occupied_aux_qty 占用量（辅助单位） Occupied Quantity(Base Unit) 占用量（基本单位） occupied_qty 占用量（基本单位） Occupied Quantity(Stock Unit) 占用量（库存单位） occupied_stk_qty 占用量（库存单位） Operation Direction 运算方向 qty_option 运算方向 Stock Quantity 库存数量 stk_qty 库存数量 Inbound 入库 qty_option__1 入库 Outbound 出库 qty_option__-1 出库 Estimated Available Auxiliary Quantity 预计可出库辅助数量 est_available_aux_qty 预计可出库辅助数量 Estimated Available Quantity 预计可出库数量 est_available_qty 预计可出库数量 Estimated Available Stock Quantity 预计可出库库存数量 est_available_stk_qty 预计可出库库存数量 Not Record In Quantity 未记账入库数量 not_record_in_qty 未记账入库数量 Not Record In Stock Quantity 未记账入库库存数量 not_record_in_stk_qty 未记账入库库存数量 Not Record In Auxiliary Quantity 未记账入库辅助数量 not_record_in_aux_qty 未记账入库辅助数量 Not Record Out Quantity 未记账出库数量 not_record_out_qty 未记账出库数量 Not Record Out Stock Quantity 未记账出库库存数量 not_record_out_stk_qty 未记账出库库存数量 Not Record Out Auxiliary Quantity 未记账出库辅助数量 not_record_out_aux_qty 未记账出库辅助数量 Estimated Available Quantity 预计可出库数量 est_available_qty 预计可出库数量 Estimated Available Auxiliary Quantity 预计可出库辅助数量 est_available_aux_qty 预计可出库辅助数量 Stock Quantity 库存数量 stk_qty 库存数量 Auxiliary Quantity 辅助数量 aux_qty 辅助数量 Base Unit Quantity 基本数量 qty 基本数量 Purchase Quantity 采购数量 pur_qty 采购数量 Purchase Value Quantity 计价数量 pur_value_qty 计价数量 Push Base Unit Quantity 下推基本数量 push_qty 下推基本数量 Returnable Quantity 可退数量 returnable_qty 可退数量 2.计算公式 2.1.预计可出库数量 : 一直等于(可用库存数量-未记账出库数量)","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"医药公司ERP","slug":"项目/医药公司ERP","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/"},{"name":"业务","slug":"项目/医药公司ERP/业务","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/%E4%B8%9A%E5%8A%A1/"}],"tags":[]},{"title":"项目的一些知识","slug":"项目/医药公司ERP/20230817基础","date":"2023-08-17T14:14:52.000Z","updated":"2024-11-29T02:15:04.627Z","comments":true,"path":"2023/08/17/项目/医药公司ERP/20230817基础/","link":"","permalink":"https://dbbruce.github.io/2023/08/17/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/20230817%E5%9F%BA%E7%A1%80/","excerpt":"1、确认代码模块与升级模块关系 1.1. 背景 在修改了Py文件中的model字段后，需要更新设计时的模块。那么，如何确认特定模块与设计时的关联呢？ 1.2. 方法 查看修改的 Python 文件路径：gsp就是目录名 1/opt/xx/xx/biz/med/gsp/xx/xx/xx/report.py","text":"1、确认代码模块与升级模块关系 1.1. 背景 在修改了Py文件中的model字段后，需要更新设计时的模块。那么，如何确认特定模块与设计时的关联呢？ 1.2. 方法 查看修改的 Python 文件路径：gsp就是目录名 1/opt/xx/xx/biz/med/gsp/xx/xx/xx/report.py 1.3. 查看设计时的模块信息： 2、项目代码结构 3、创建应用流程3.1、需要进入菜单创建应用 “医药管理”， 点击“采购管理”，进入“采购管理” 进入“采购管理后”，点击“创建”，创建“应用” 选择“熟练模式” 3.2、创建应用流程 应用名称：菜单中显示的名称 模型key：代码目录名称 所属模块: 显示菜单的位置 文件路径：&#x2F;med&#x2F;med_pur 继承模板: 继承模板后，会自动带来一个字段 保存，同步IDE后，只会生成代码目录，不会生成PG数据表 3.3、生成PG数据表 4、目录结构 custom：看了几个项目都是空着的，后期补充下 development：研发修改的目录 generate： i18n： 页面上设置的多语言配置，都会写在这个目录下的zh_CN.CSV文件里 json： init.py: 用来引用自动生成的3个目录，custom，development，generate 4.1、 init.py 引用自动生成的3个目录 4.2、generate 文件 描述 studio_app_version.xml 包含表单的信息 studio_default.xml 默认值管理 studio_onchange_config.xml 值更新事件管理，配置的信息 studio_button_action_config.xml 操作按钮管理，涉及按钮的一些信 studio_fields_config.xml 视图中的字段，表的字段信息 sys_ele_ctrl_config.xml 按钮信息，操作按钮管理 studio_compute_config.xml 计算字段配置 studio_model_fields.xml 视图中的字段，表的字段信息 studio_service_config.xml 服务调用管理 ir_model_extension.xml 过滤配置 studio_botp.xml 流程设置中单据转换的相关配置 studio_botp_version.xml 流程设置中单据转换的相关配置 4.3、views:前端视图 5、i18n &lt; &#x3D;&#x3D;&#x3D; &gt; 多语言翻译对应的文档 应用下i18n的，zh_CN.CSV 6、视图，模型属性 6.1、默认值管理 默认值配置后关联的2个文件 1.应用名&#x2F;generate&#x2F;data&#x2F;studio_default.xml 2.应用名&#x2F;json&#x2F;model__pur_noun_case0806.json [pur.noun.case0806这个是表单视图名称] &#x2F;med&#x2F;med_pur&#x2F;pur_noun_case0806&#x2F;generate&#x2F;data&#x2F;studio_default.xml &#x2F;med&#x2F;med_pur&#x2F;pur_noun_case0806&#x2F;json&#x2F;model__pur_noun_case0806.json 6.2、值更新事件管理 studio_onchange_config.xml文件 &#x2F;med&#x2F;med_pur&#x2F;pur_noun_case0806&#x2F;generate&#x2F;data&#x2F;studio_onchange_config.xml json文件中的onchange&#x2F;med&#x2F;med_pur&#x2F;pur_noun_case0806&#x2F;json&#x2F;model__pur_noun_case0806.json 自定义方法编写的位置&#x2F;med&#x2F;med_pur&#x2F;pur_noun_case0806&#x2F;development&#x2F;models&#x2F;pur_noun_case0806.py 1234567891011121314151617class MedPurOrder(models.Model): _inherit = &#x27;pur.noun.case0806&#x27; ################################ 其他方法区 start ################################ def _filter_pur_org(self): &quot;&quot;&quot; 高级筛选视图采购组织改变触发函数 :params: self: 当前模型对象(obj) :return: &quot;&quot;&quot; # 清空采购部门、采购员、供应商 self.pur_dept_id = False self.pur_id = False self.supplier_id = False # 过滤采购组织 org_list = self.p_get_org_domain(&#x27;purchase&#x27;) return &#123;&#x27;domain&#x27;: &#123;&#x27;pur_org_id&#x27;: [(&#x27;id&#x27;, &#x27;in&#x27;, org_list)]&#125;&#125; 6.3、计算字段配置 文件：generate&#x2F;data&#x2F;studio_compute_config.xml &#x2F;med&#x2F;med_pur&#x2F;pur_noun_case0806&#x2F;generate&#x2F;data&#x2F;studio_compute_config.xml 6.4、服务调用管理 &#x2F;med&#x2F;med_pur&#x2F;pur_noun_case0806&#x2F;generate&#x2F;data&#x2F;studio_service_config.xml &#x2F;med&#x2F;med_pur&#x2F;pur_noun_case0806&#x2F;development&#x2F;models&#x2F;pur_noun_case0806.py 123456789101112131415161718192021222324252627282930313233343536373839404142class MedPurOrder(models.Model): _inherit = &#x27;pur.noun.case0806&#x27; ################################ 约束方法区 start ################################ def _check_pur_order_line2_ids(self, **kwargs): &quot;&quot;&quot; 付款计划明细行应付金额总和应等于订单总金额 :param: self: 当前模型对象(obj) :return: &quot;&quot;&quot; record_ids = kwargs.get(&#x27;record_ids&#x27;, False) message1 = _(&#x27;Only one payable business is allowed on a single purchase order&#x27;) message2 = _(&#x27;The total payable amount of the payment plan must equal the total amount of the purchase order&#x27;) for rec in record_ids: line_pay_amount_total = 0 # 明细行总金额 material_line_amount = 0 # 物料明细行总含税金额 for material_line in rec.pur_order_line1_ids: # 计算物料明细行总含税金额 material_line_amount += material_line.amount_tax for line in rec.pur_order_line2_ids: # 计算付款计划明细行总应付金额 line_pay_amount_total += line.payable_amount if not line.is_need_payadvance and line.pay_date and line.pay_date &lt; rec.biz_date: # 应付日期不允许小于业务日期 message = _( &#x27;The due date of the %s line cannot be less than the business date&#x27;) % (line.sequence) raise ValidationError(message) # 按项目分组计算is_need_payadvance=True的个数，只能有一个 temp = rec.pur_order_line2_ids.sorted(key=lambda x: str(x.project_id.id or &#x27;&#x27;)) for k, items in groupby(temp, key=lambda x: str(x.project_id.id or &#x27;&#x27;)): if sum([row.is_need_payadvance for row in items] or [0, ]) &gt; 1: # 一张采购订单仅允许有一项应付业务 message = message1 raise ValidationError(message) if rec.env[&#x27;mdm.currency&#x27;].p_amount_float_compare(material_line_amount, line_pay_amount_total, rec.currency_id.id) != 0: # 付款计划应付金额合计需等于采购订单总含税金额 message = message2 raise ValidationError(message) 6.5、过滤配置 &#x2F;med&#x2F;med_pur&#x2F;pur_noun_case0806&#x2F;generate&#x2F;data&#x2F;ir_model_extension.xml 7、视图，操作按钮管理 &#x2F;med&#x2F;med_pur&#x2F;pur_noun_case0806&#x2F;generate&#x2F;data&#x2F;studio_button_action_config.xml 7、视图，流程设置7.1、流程设置 &#x2F;opt&#x2F;projects&#x2F;insuite&#x2F;biz&#x2F;platform&#x2F;ps_studio&#x2F;controllers&#x2F;studio_botp_ctrl.py &#x2F;opt&#x2F;projects&#x2F;insuite&#x2F;biz&#x2F;platform&#x2F;ps_studio&#x2F;models&#x2F;studio_botp_rule_version.py 7.2、单据转换涉及的文件 &#x2F;opt&#x2F;projects&#x2F;insuite&#x2F;biz&#x2F;med&#x2F;gsp&#x2F;med_pur_order&#x2F;generate&#x2F;data&#x2F;studio_botp_rule_version.xml &#x2F;opt&#x2F;projects&#x2F;insuite&#x2F;biz&#x2F;med&#x2F;gsp&#x2F;med_pur_order&#x2F;generate&#x2F;data&#x2F;studio_botp_rule.xml &#x2F;opt&#x2F;projects&#x2F;insuite&#x2F;biz&#x2F;med&#x2F;gsp&#x2F;med_pur_order&#x2F;generate&#x2F;data&#x2F;studio_botp_version.xml &#x2F;opt&#x2F;projects&#x2F;insuite&#x2F;biz&#x2F;med&#x2F;gsp&#x2F;med_pur_order&#x2F;generate&#x2F;data&#x2F;studio_botp.xml 将配置信息存储在数据表里 ‘studio_botp_version’ # 单据转换 流程中间表 1234567891011121314151617class StudioBotpRuleVersion(models.Model): _name = &#x27;studio.botp.version&#x27; _description = &#x27;Studio Botp Version&#x27; # 单据转换 流程中间表 tenant_id = fields.Integer(string=&quot;Tenant&quot;, default=lambda self: self.env.user.tenant_id) # 租户 config_uuid = fields.Char(string=&#x27;Service UUID&#x27;, copy=False) # 服务 UUID botp_key = fields.Char(string=&#x27;Botp Key&#x27;) # 生成规则 &quot;&#123;&#125;_&#123;&#125;&quot;.format(source_model_key, target_model_key) source_model_key = fields.Char(string=&#x27;Source Model Key&#x27;, index=True) # 来源单模型名 target_model_key = fields.Char(string=&#x27;Target Model Key&#x27;, index=True) # 目标单模型名 source_seq = fields.Integer(string=&quot;Source Seq&quot;) # 来源单流程排序权重 target_seq = fields.Integer(string=&quot;Target Seq&quot;) # 目标单流程排序权重 is_no_preset = fields.Boolean(string=&#x27;Is No Preset&#x27;, default=False) # 客开判断是否预置字段 默认为 False 系统预置 launch_condition = fields.Text(string=&#x27;Launch Condition&#x27;) # 俩个单据下推的启动条件 delete_state = fields.Boolean(string=&#x27;Delete State&#x27;, default=False) # 删除状态(正常/删除) is_publish = fields.Boolean(string=&#x27;Is Publish&#x27;, default=False) # 是否发布 publish_date = fields.Datetime(string=&quot;Publish Date&quot;) # 发布时间 未发布则为空 partner = fields.Char(string=&#x27;Partner&#x27;) # 伙伴标识 此条记录是哪个伙伴生成的 如果为空则是标准产品 ‘studio_botp_rule_version’ # 单据转换规则 中间表 1234567891011121314151617181920class StudioBotpRuleVersionLine(models.Model): _name = &#x27;studio.botp.rule.version&#x27; # 单据转换规则 中间表 _description = &#x27;Studio Botp Rule Version&#x27; tenant_id = fields.Integer(string=&quot;Tenant&quot;, default=lambda self: self.env.user.tenant_id) # 租户 config_uuid = fields.Char(string=&#x27;Service UUID&#x27;, copy=False) # 服务 UUID botp_key = fields.Char(string=&#x27;Botp Key&#x27;) # 生成规则 &quot;&#123;&#125;_&#123;&#125;&quot;.format(source_model_key, target_model_key) rule_key = fields.Char(string=&#x27;Rule Key&#x27;, index=True) # 单据转换规则唯一标识 前端生成 parent_rule_key = fields.Char(string=&#x27;Parent Rule Key&#x27;, index=True, copy=False) # 单据转换规则父级标识 用于转换规则的复制 记录被复制规则key rule_name = fields.Char(string=&#x27;Rule Name&#x27;, translate=True) # 单据转换规则名称 rule_seq = fields.Integer(string=&quot;Rule Seq&quot;) # 单据转换规则排序权重 source_model_key = fields.Char(string=&#x27;Source Model Key&#x27;, index=True) # 来源单模型名 target_model_key = fields.Char(string=&#x27;Target Model Key&#x27;, index=True) # 目标单模型名 json_data = fields.Text(string=&#x27;Botp Rule Json&#x27;) # 保存的 json 数据 path = fields.Char(string=&#x27;Json Path&#x27;) # json 数据的路径 is_no_preset = fields.Boolean(string=&#x27;Is No Preset&#x27;, default=False) # 客开判断是否预置字段 默认为 False 系统预置 delete_state = fields.Boolean(string=&#x27;Delete State&#x27;, default=False) # 删除状态(正常/删除) forbid_state = fields.Boolean(string=&#x27;Forbid State&#x27;, default=False) # 禁用状态(正常/已禁用) is_publish = fields.Boolean(string=&#x27;Is Publish&#x27;, default=False) # 是否发布 publish_date = fields.Datetime(string=&quot;Publish Date&quot;) # 发布时间 未发布则为空 partner = fields.Char(string=&#x27;Partner&#x27;) # 伙伴标识 此条记录是哪个伙伴生成的 如果为空则是标准产品 config_uuid从xml文件中获取 select * from studio_botp_rule_version where config_uuid in (‘243b43b8880f11edafa802420a0001a9’,’697ec59c31da11eeb41e02420a0001aa’,’940a60a2b28f11ed849a02420a000191’); select * from studio_botp_version where config_uuid in (‘243b43b8880f11edafa802420a0001a9’,’697ec59c31da11eeb41e02420a0001aa’,’940a60a2b28f11ed849a02420a000191’); 8、IDE 9、单据转换 映射关系模型映射：指定推数据的模型之间关系 分单合并规则 选单依据，过滤数据 反写规则，数据生成后的一些动作 服务调用 目标单服务 场景：字段对应的单位不同，换算数量 10、单据转换 整单：表头 分录：表体","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"医药公司ERP","slug":"项目/医药公司ERP","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/"},{"name":"基础","slug":"项目/医药公司ERP/基础","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"010-openpyxl库处理Excel文件","slug":"爬虫/基础/010-openpyxl库处理Excel文件","date":"2023-08-17T07:04:52.000Z","updated":"2024-05-31T01:46:23.000Z","comments":true,"path":"2023/08/17/爬虫/基础/010-openpyxl库处理Excel文件/","link":"","permalink":"https://dbbruce.github.io/2023/08/17/%E7%88%AC%E8%99%AB/%E5%9F%BA%E7%A1%80/010-openpyxl%E5%BA%93%E5%A4%84%E7%90%86Excel%E6%96%87%E4%BB%B6/","excerpt":"1.创建一个xlsx格式的excel文件并保存12345from openpyxl import Workbook# 创建一个工作表wb = Workbook()# 保存为本地excel文件wb.save(&quot;1.xlsx&quot;)","text":"1.创建一个xlsx格式的excel文件并保存12345from openpyxl import Workbook# 创建一个工作表wb = Workbook()# 保存为本地excel文件wb.save(&quot;1.xlsx&quot;) 2.保存成流(stream) 例如当使用 Pyramid, Flask 或 Django 等 web 应用程序时，如果想把文件保存成流，可以使用 NamedTemporaryFile( )方法 12345678from tempfile import NamedTemporaryFilefrom openpyxl import Workbook wb = Workbook()with NamedTemporaryFile() as tmp: wb.save(tmp.name) tmp.seek(0) stream = tmp.read() 3.写入单元格123456789101112131415from openpyxl import Workbook wb = Workbook()# 创建第一个sheetsheet = wb.active # 方式一 在第1行第1列的单元格写入111sheet[&#x27;A1&#x27;] = 111# 方式二 在第1行第1列的单元格写入111# sheet.cell(row=1, column=1, value=111)# 方式三 先获取到单元格，再将数据写入value属性# cell = sheet[&#x27;A1&#x27;]# cell.value = 111 wb.save(&quot;1.xlsx&quot;) 12345678910111213141516171819202122from openpyxl import Workbook # 初始化wb = Workbook() # 创建第一个sheetsheet = wb.active# 在第1行第1列的单元格写入111sheet[&#x27;A1&#x27;] = 111 # 创建一个新的sheetsheet1 = wb.create_sheet()# 在这个新的sheet中第2行第2列的单元格写入222sheet1[&#x27;B2&#x27;] = 222 # 创建一个叫&quot;第3个工作表&quot;的新sheetsheet3 = wb.create_sheet(&quot;第3个工作表&quot;)# 在这个新的sheet中第3行第3列的单元格写入333sheet3[&#x27;C3&#x27;] = 333 # 保存本地excel文件中wb.save(&quot;F:\\pythonTest\\sample.xlsx&quot;) 1.创建新的工作表123456# 在结尾插入一个叫 &quot;我的sheet1&quot; 的sheetsheet1 = wb.create_sheet(&quot;我的sheet1&quot;) # 或者在最开始插入一个叫 &quot;我的sheet12&quot; 的sheetsheet2 = wb.create_sheet(&quot;我的sheet12&quot;, 0)# 或者在倒数第二的位置插入一个叫 &quot;我的sheet13&quot; 的sheetsheet3 = wb.create_sheet(&quot;我的sheet13&quot;, -1) 2.删除指定工作表12# 删除名字是 &quot;我的sheet13&quot; 的工作表wb.remove(wb[&#x27;3号sheet&#x27;]) 3.修改sheet工作表的名称1234# 在结尾插入一个叫 &quot;我的sheet1&quot; 的工作表sheet1 = wb.create_sheet(&quot;我的sheet1&quot;) # 将&quot;我的sheet1&quot; 的工作表名字改为&quot;first&quot;sheet1.title = &quot;first&quot; 4.获取所有工作表的名称1print(wb.sheetnames) #[&#x27;Sheet&#x27;, &#x27;我的sheet1&#x27;, &#x27;first&#x27;, &#x27;second&#x27;] 5.切换工作表123current = wb[&quot;first&quot;]# 切换到 &quot;second&quot; 工作表current = wb[&quot;second&quot;] 6.遍历所有sheet工作表12for s in wb: print(s.title) 7.复制sheet工作表12sheet = wb.activesheetNew = wb.copy_worksheet(sheet) 1.读取 excel 文件12345读取 excel 文件并打印所有的 sheet 工作表名称from openpyxl import load_workbook wb = load_workbook(&quot;F:\\pythonTest\\sample.xlsx&quot;)print(wb.sheetnames) # [&#x27;Sheet&#x27;, &#x27;Sheet1&#x27;, &#x27;New Title&#x27;] 2.读取单元格12345678910111213from openpyxl import load_workbook wb = load_workbook(&quot;F:\\pythonTest\\sample.xlsx&quot;)# 获取&quot;New Title&quot; 这个sheet工作表sheet = wb[&quot;第3个工作表&quot;] # 方式一 获取 &quot;C3&quot;这个单元格cell = sheet[&quot;C3&quot;]# 方式二 获取 第3行3列 这个单元格# cell = sheet.cell(row=3, column=3) # 打印单元格的值print(cell.value) 3.获取某一行某一列的数据1234567891011121314151617from openpyxl import load_workbook wb = load_workbook(&quot;1.xlsx&quot;)sheet = wb[&quot;Sheet&quot;]# 获取第2行的单元格数据并打印row = sheet[&#x27;2&#x27;]row_data = []for cell in row: row_data.append(cell.value)print(row_data) # 获取第3列的单元格数据并打印col = sheet[&#x27;C&#x27;]col_data = []for cell in col: col_data.append(cell.value)print(col_data) 4.遍历所有单元格12345678910111213from openpyxl import load_workbook wb = load_workbook(&quot;F:\\pythonTest\\sample.xlsx&quot;)# 遍历所有的sheet工作表for sheet in wb: # 获取当前sheet工作表的行数据 rows = tuple(sheet.rows) # 遍历每一行 for row in rows: # 遍历每一个单元格 for cell in row: print(cell.value)# 上面使用了sheet.rows 获取行数据，如果要获取列数据可以使用 sheet.columns 5.遍历指定行列范围的单元格方式一：使用切片方式 1234567891011from openpyxl import load_workbook wb = load_workbook(&quot;F:\\pythonTest\\sample.xlsx&quot;)# 获取叫&quot;Sheet&quot;的工作表sheet = wb[&quot;Sheet&quot;]# 获取叫&#x27;A2&#x27;到&#x27;C4&#x27;范围的所有单元格rows = sheet[&#x27;A2&#x27;:&#x27;C4&#x27;]for cells in rows: for cell in cells: print(cell.value, end=&quot; &quot;) print() 方式二：使用iter_rows方法 12345678910from openpyxl import load_workbook wb = load_workbook(&quot;F:\\pythonTest\\sample.xlsx&quot;)# 获取叫&quot;Sheet&quot;的工作表sheet = wb[&quot;Sheet&quot;]# 获取 2到4行，1到3列 范围的所有单元格for row in sheet.iter_rows(min_row=2, min_col=1, max_col=3, max_row=4): for cell in row: print(cell.value, end=&quot; &quot;) print() 1.合并单元格合并单元格时，除了左上角的单元格内容，其他都选中范围单元格将从工作表中删除 123456789101112from openpyxl import load_workbook wb = load_workbook(&quot;F:\\pythonTest\\sample.xlsx&quot;)# 获取叫&quot;Sheet&quot;的工作表sheet = wb[&quot;Sheet&quot;] # 方式一 合并 A2到C4 范围的单元格sheet.merge_cells(&#x27;A2:C4&#x27;)# 方式二 合并 2到4行，1到3列 范围的所有单元格# sheet.merge_cells(start_row=2, start_column=1, end_row=4, end_column=3) wb.save(&quot;F:\\pythonTest\\sample.xlsx&quot;) 2.拆分合并的单元格123456789101112from openpyxl import load_workbook wb = load_workbook(&quot;F:\\pythonTest\\sample.xlsx&quot;)# 获取叫&quot;Sheet&quot;的工作表sheet = wb[&quot;Sheet&quot;] # 方式一 拆分 A2到C4 范围的单元格sheet.unmerge_cells(&#x27;A2:C4&#x27;)# 方式二 拆分 2到4行，1到3列 范围的所有单元格ws.unmerge_cells(start_row=2, start_column=1, end_row=4, end_column=4) wb.save(&quot;F:\\pythonTest\\sample.xlsx&quot;) 3.插入行和列(1)插入单行单列 123456789from openpyxl import load_workbook wb = load_workbook(&quot;F:\\pythonTest\\sample.xlsx&quot;)sheet = wb[&quot;Sheet&quot;]# 在第3行前插入一行sheet.insert_rows(3)# 在第2列前插入一列sheet.insert_cols(2)wb.save(&quot;F:\\pythonTest\\sample.xlsx&quot;) (2)插入多行多列123456789from openpyxl import load_workbook wb = load_workbook(&quot;F:\\pythonTest\\sample.xlsx&quot;)sheet = wb[&quot;Sheet&quot;]# 在第3行前插入四行sheet.insert_rows(3, 4)# 在第2列前插入五列sheet.insert_cols(2, 5)wb.save(&quot;F:\\pythonTest\\sample.xlsx&quot;) 4.删除行和列(1)删除单行单列 123456789from openpyxl import load_workbook wb = load_workbook(&quot;F:\\pythonTest\\sample.xlsx&quot;)sheet = wb[&quot;Sheet&quot;]# 删除第3行sheet.delete_rows(3)# 删除第2列sheet.delete_cols(2)wb.save(&quot;F:\\pythonTest\\sample.xlsx&quot;) (2)删除多行多列 123456789from openpyxl import load_workbook wb = load_workbook(&quot;F:\\pythonTest\\sample.xlsx&quot;)sheet = wb[&quot;Sheet&quot;]# 从第3行前开始删除四行sheet.delete_rows(3, 4)# 从第2列开始删除五列sheet.delete_cols(2, 5)wb.save(&quot;F:\\pythonTest\\sample.xlsx&quot;) 1. 对齐方式与换行1234567891011121314151617181920212223# horizontal是水平方向，vertical 是垂直方向Alignment(horizontal=&quot;center&quot;, vertical=&quot;center&quot;)# 默认单元格填满了是不换行的，如果要自动换行可使用 wrap_text=TrueAlignment(horizontal=&quot;center&quot;, vertical=&quot;center&quot;, wrap_text=True)horizontal 水平对齐可选值如下参数值 对齐方式left 左对齐center 左右居中right 右对齐fill 填满对齐distributed 分散对齐centerContinously 连续居中justify 两端对齐general 一般对齐vertical 垂直对齐可选值如下参数值 对齐方式top 上对齐center 左右居中bottom 下对齐distributed 分散对齐justify 两端对齐 2.单元格对齐12345678910111213from openpyxl import Workbookfrom openpyxl.styles import Alignment wb = Workbook()sheet = wb.active # 在第1行第1列的那个单元格写入123546cell = sheet[&#x27;A1&#x27;]cell.value = 123546# 将该单元格对齐方式设置为水平和垂直都居中cell.alignment = Alignment(horizontal=&quot;center&quot;, vertical=&quot;center&quot;) wb.save(&quot;F:\\pythonTest\\sample.xlsx&quot;) 3.合并后的单元格设置对齐方式可以改变左上单元格的对齐方式、边框等属性来改变整个合并单元格的对齐方式、边框等属性。 1234567891011121314151617from openpyxl.styles import Alignmentfrom openpyxl import load_workbook wb = load_workbook(&quot;F:\\pythonTest\\sample.xlsx&quot;)# 获取叫&quot;Sheet&quot;的工作表sheet = wb[&quot;Sheet&quot;] # 合并 A2到C4 范围的单元格sheet.merge_cells(&#x27;A2:C4&#x27;)# 改变左上单元格的对齐方式来改变合并单元格的对齐方式cell = sheet[&#x27;A2&#x27;]cell.alignment = Alignment(horizontal=&quot;center&quot;, vertical=&quot;center&quot;) wb.save(&quot;F:\\pythonTest\\sample.xlsx&quot;) 1. 边框线条粗细、颜色设置（1）你可以对单元格上下左右的边框进行设置虚线和实线 123456Border( left=Side(style=&#x27;thick&#x27;), bottom=Side(style=&#x27;mediumDashed&#x27;), right=Side(style=&#x27;thin&#x27;), top=Side(style=&#x27;dashed&#x27;))其中thin是细实线，thick是粗实线，dashed是细虚线，mediumDashed是粗虚线. 全部边框线条可选的有如下： 1234&#x27;dashDot&#x27;,&#x27;dashDotDot&#x27;, &#x27;dashed&#x27;,&#x27;dotted&#x27;,&#x27;double&#x27;,&#x27;hair&#x27;, &#x27;medium&#x27;, &#x27;mediumDashDot&#x27;, &#x27;mediumDashDotDot&#x27;,&#x27;mediumDashed&#x27;, &#x27;slantDashDot&#x27;,&#x27;thick&#x27;, &#x27;thin&#x27; （2）你还可以使用 color 参数调整单元格上下左右边框的颜色 12345Border( left=Side(style=&#x27;thick&#x27;, color=&#x27;00000000&#x27;), bottom=Side(style=&#x27;mediumDashed&#x27;, color=&#x27;00000000&#x27;), right=Side(style=&#x27;thin&#x27;, color=&#x27;00000000&#x27;), top=Side(style=&#x27;dashed&#x27;, color=&#x27;00000000&#x27;)) 可取的颜色参考如下： 2.设置单个单元格边框和颜色1234567891011121314151617from openpyxl import Workbookfrom openpyxl.styles import Border, Side wb = Workbook()sheet = wb.active # 在第1行第1列的那个单元格写入123546cell = sheet[&#x27;B2&#x27;]cell.value = 123546# 设置该单元格边框和颜色cell.border = Border( left=Side(style=&#x27;thick&#x27;, color=&#x27;00000000&#x27;), bottom=Side(style=&#x27;mediumDashed&#x27;, color=&#x27;00000000&#x27;), right=Side(style=&#x27;thin&#x27;, color=&#x27;00000000&#x27;), top=Side(style=&#x27;dashed&#x27;, color=&#x27;00000000&#x27;)) wb.save(&quot;1.xlsx&quot;) 3.设置多个单元格整体边框和颜色想要整体添加边框，有两种方式：（1） 先合并单元格再对左上角的单元格进行操作，但往往这些单元格都有不同的数据，难以进行合并。（2） 遍历所有的单元格，分别赋予属性。这种方法比较适用于为所有的单元格赋予相同的属性。 1.设置单元格背景颜色12345678910111213from openpyxl import Workbookfrom openpyxl.styles import PatternFill wb = Workbook()sheet = wb.active # 在第1行第1列的那个单元格写入123546cell = sheet[&#x27;B2&#x27;]cell.value = 123546# 使用fgColor属性16进制颜色填充cell.fill = PatternFill(&#x27;solid&#x27;, fgColor=&quot;FF00FF&quot;) wb.save(&quot;1.xlsx&quot;) 2.设置字体、字体的粗细、大小、颜色12345678910111213from openpyxl import Workbookfrom openpyxl.styles import Font wb = Workbook()sheet = wb.active # 在第1行第1列的那个单元格写入123546cell = sheet[&#x27;B2&#x27;]cell.value = 123546# 设置字体样式： 字体大小为30， bold加粗,字体颜色 00FFFF 16进制颜色cell.font = Font(u&#x27;微软雅黑&#x27;, size=30, bold=True, color=&quot;00FFFF&quot;) wb.save(&quot;1.xlsx&quot;) 九、设置行高和列宽1234567891011from openpyxl import Workbook wb = Workbook()sheet = wb.active # 设置第1行高度为60sheet.row_dimensions[1].height = 60# 设置B列宽度为30sheet.column_dimensions[&quot;B&quot;].width = 30 wb.save(&quot;1.xlsx&quot;)","categories":[{"name":"爬虫类","slug":"爬虫类","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/"},{"name":"基础","slug":"爬虫类/基础","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"一些专业词汇与git命令","slug":"项目/医药公司ERP/20230816基础","date":"2023-08-16T14:14:52.000Z","updated":"2024-11-29T02:15:04.621Z","comments":true,"path":"2023/08/16/项目/医药公司ERP/20230816基础/","link":"","permalink":"https://dbbruce.github.io/2023/08/16/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/20230816%E5%9F%BA%E7%A1%80/","excerpt":"业务 期初库存，是指在一个库存会计时期开始时，可供使用或出售的存货（如货品、物资或原料）的账面价值。 期末库存，是指在一个库存会计时期结束时，可供使用或出售的货品、物资或原料的账面价值。 月末加权平均法，加权平均成本的计算方式是将期初存货的成本乘以期初存货的数量，再加上本期进货的成本乘以本期进货的数量，然后将得到的总成本除以期初存货的数量与本期进货的数量之和 移动加权平均法，在财务会计领域中，移动加权平均法是一种常用的存货计价方法。这种方法通过计算每次进货后的平均成本来确定销售成本和期末存货价值。移动加权平均法的核心在于其计算公式，该公式能够确保存货成本反映最新的市场情况。计算公式为：移动加权平均单价 &#x3D; (现有存货成本+新进货成本) &#x2F; (现有存货数量+ 新进货数量)。每当有新的存货购入时，都需要重新计算移动加权平均单价，以此来更新存货的成本。这种方法虽然计算较为复杂，但能够更准确地反映存货的真实成本。 先进先出法，收入存货时，逐笔登记收入存货的数量、单价和金额；发出存货时，按照先进先出的原则逐笔登记存货的发出成本和结存金额。 两票制是指药品生产企业到流通企业开一次发票,流通企业到医疗机构开一次发票。 药厂GMP认证指的是药品生产企业获得的一种质量管理认证，其中GMP代表“Good Manufacturing Practice”（良好生产规范）","text":"业务 期初库存，是指在一个库存会计时期开始时，可供使用或出售的存货（如货品、物资或原料）的账面价值。 期末库存，是指在一个库存会计时期结束时，可供使用或出售的货品、物资或原料的账面价值。 月末加权平均法，加权平均成本的计算方式是将期初存货的成本乘以期初存货的数量，再加上本期进货的成本乘以本期进货的数量，然后将得到的总成本除以期初存货的数量与本期进货的数量之和 移动加权平均法，在财务会计领域中，移动加权平均法是一种常用的存货计价方法。这种方法通过计算每次进货后的平均成本来确定销售成本和期末存货价值。移动加权平均法的核心在于其计算公式，该公式能够确保存货成本反映最新的市场情况。计算公式为：移动加权平均单价 &#x3D; (现有存货成本+新进货成本) &#x2F; (现有存货数量+ 新进货数量)。每当有新的存货购入时，都需要重新计算移动加权平均单价，以此来更新存货的成本。这种方法虽然计算较为复杂，但能够更准确地反映存货的真实成本。 先进先出法，收入存货时，逐笔登记收入存货的数量、单价和金额；发出存货时，按照先进先出的原则逐笔登记存货的发出成本和结存金额。 两票制是指药品生产企业到流通企业开一次发票,流通企业到医疗机构开一次发票。 药厂GMP认证指的是药品生产企业获得的一种质量管理认证，其中GMP代表“Good Manufacturing Practice”（良好生产规范） 技术 查看仓库123git remote tjjryy 仓库名对应的仓库地址1234git remote -vtjjryy git@gitlab.insuite.net:sunqibing/op-tjjryy.git (fetch)tjjryy git@gitlab.insuite.net:sunqibing/op-tjjryy.git (push) 分支12345678910111213141516171819202122232425262728293031# 查看本地分支git branch13.0-dev-tjjryy-231031* jugl-yiyao-dev# 查看远程分支git branch -rtjjryy/13.0-dev-tjjryy-231031tjjryy/jugl-yiyao-dev# 查看所有分支git branch -a13.0-dev-tjjryy-231031* jugl-yiyao-devremotes/tjjryy/13.0-dev-tjjryy-231031remotes/tjjryy/jugl-yiyao-dev# 创建新分支并切换到该分支git checkout -b feature-xyz# 切换分支git checkout main# 将其他分支合并到当前分支git merge &lt;branchname&gt;# 删除分支git branch -d &lt;branchname&gt; 文件的修改添加到暂存区1git add . 暂存1234567891011121314# 查看暂存git stash list stash@&#123;0&#125;: WIP on master: 049d078 added the index filestash@&#123;1&#125;: WIP on master: c264051 Revert &quot;added file_size&quot;stash@&#123;2&#125;: WIP on master: 21d80a5 added number to log# 删除暂存git stash drop stash@&#123;0&#125;# 暂存git stash save &quot;注释内容&quot;# 重新应用暂存git stash pop 拉取代码12345git pull [远程仓库名] [分支名]# 将远程主机 origin 的 master 分支拉取过来，与本地的 brantest 分支合并git pull origin master:brantest# 如果远程分支是与当前分支合并，则冒号后面的部分可以省略git pull origin master 推送代码123git push &lt;远程主机名&gt; &lt;本地分支名&gt;:&lt;远程分支名&gt;# 如果本地分支名与远程分支名相同git push &lt;远程主机名&gt; &lt;本地分支名&gt;","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"医药公司ERP","slug":"项目/医药公司ERP","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/"},{"name":"基础","slug":"项目/医药公司ERP/基础","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"009-json存储","slug":"爬虫/基础/009-json存储","date":"2023-08-16T07:04:52.000Z","updated":"2024-05-31T01:46:23.000Z","comments":true,"path":"2023/08/16/爬虫/基础/009-json存储/","link":"","permalink":"https://dbbruce.github.io/2023/08/16/%E7%88%AC%E8%99%AB/%E5%9F%BA%E7%A1%80/009-json%E5%AD%98%E5%82%A8/","excerpt":"json模块1234567函数 描述类型转换json.dumps() 将 Python 对象编码成 JSON 字符串json.loads() 将已编码的 JSON 字符串解码为 Python 对象文件操作json.dump() 将 Python内置类型序列化为json对象后陷入文件json.load() 读取文件中json形式的字符串转化为Python类型","text":"json模块1234567函数 描述类型转换json.dumps() 将 Python 对象编码成 JSON 字符串json.loads() 将已编码的 JSON 字符串解码为 Python 对象文件操作json.dump() 将 Python内置类型序列化为json对象后陷入文件json.load() 读取文件中json形式的字符串转化为Python类型 ensure_ascii&#x3D;False12345678910111213141516171819202122import jsons = &#x27;&#123;&quot;name&quot;:&quot;张三&quot;&#125;&#x27;# 字符串转jsonobj = json.loads(s)print(obj)# &#123;&#x27;name&#x27;: &#x27;张三&#x27;&#125;# json转字符串ss = json.dumps(obj)print(ss)# &#123;&quot;name&quot;: &quot;\\u5f20\\u4e09&quot;&#125;ss2 = json.dumps(obj, ensure_ascii=False)print(ss2)# &#123;&quot;name&quot;: &quot;张三&quot;&#125;# 写入文件json.dump(obj, open(&#x27;1.txt&#x27;, &#x27;w&#x27;, encoding=&#x27;utf-8&#x27;), ensure_ascii=False)# 从文件读取json.load(open(&#x27;1.txt&#x27;, &#x27;w&#x27;, encoding=&#x27;utf-8&#x27;))","categories":[{"name":"爬虫类","slug":"爬虫类","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/"},{"name":"基础","slug":"爬虫类/基础","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"Websocket","slug":"python/异步编程/Websocket","date":"2023-08-15T13:50:10.000Z","updated":"2025-07-22T02:02:46.097Z","comments":true,"path":"2023/08/15/python/异步编程/Websocket/","link":"","permalink":"https://dbbruce.github.io/2023/08/15/python/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/Websocket/","excerpt":"一. 概念为了实现推动技术,传统的使用ajax轮询,设置特定的间隔时间由浏览器不断向服务器发送请求,获取到服务器返回的最新数据.消耗资源过多.WebSocket 是 HTML5 开始提供的一种在单个 TCP 连接上进行全双工通讯的协议。websocket允许服务端主动向客户端推送数据,浏览器和服务器只需完成一次握手,两者之间就可以创建持久性的连接,并进行双向数据传输.为了建立一个 WebSocket 连接，客户端浏览器首先要向服务器发起一个 HTTP 请求，这个请求和通常的 HTTP 请求不同，包含了一些附加头信息，其中附加头信息”Upgrade: WebSocket”表明这是一个申请协议升级的 HTTP 请求，服务器端解析这些附加的头信息然后产生应答信息返回给客户端，客户端和服务器端的 WebSocket 连接就建立起来了，双方就可以通过这个连接通道自由的传递信息，并且这个连接会持续存在直到客户端或者服务器端的某一方主动的关闭连接。","text":"一. 概念为了实现推动技术,传统的使用ajax轮询,设置特定的间隔时间由浏览器不断向服务器发送请求,获取到服务器返回的最新数据.消耗资源过多.WebSocket 是 HTML5 开始提供的一种在单个 TCP 连接上进行全双工通讯的协议。websocket允许服务端主动向客户端推送数据,浏览器和服务器只需完成一次握手,两者之间就可以创建持久性的连接,并进行双向数据传输.为了建立一个 WebSocket 连接，客户端浏览器首先要向服务器发起一个 HTTP 请求，这个请求和通常的 HTTP 请求不同，包含了一些附加头信息，其中附加头信息”Upgrade: WebSocket”表明这是一个申请协议升级的 HTTP 请求，服务器端解析这些附加的头信息然后产生应答信息返回给客户端，客户端和服务器端的 WebSocket 连接就建立起来了，双方就可以通过这个连接通道自由的传递信息，并且这个连接会持续存在直到客户端或者服务器端的某一方主动的关闭连接。 二. 前端调用方法 创建一个websocket对象,并向后端发送连接请求Var ws &#x3D; new websocket(url,[protocol,] )第一个参数为连接的url,第二个参数是可选的,指定了可接受的子协议 Websocket事件Ws.onopen():连接建立时触发Ws.onmessage() :客户端接受服务端数据时触发Ws.onerror(): 通信发生错误时触发Ws.onclose():连接关闭时触发 Websocket方法Ws.send()使用连接发送数据Ws.close()关闭连接 三. 后端调用方法(tornado)Tornado提供支持WebSocket的模块是tornado.websocket，其中提供了一个WebSocketHandler类用来处理通讯。 Websockethandler.open():当一个websocket连接建立后被调用 Web.sockethandler.on_message(message):当客户端发动消息过来时被调用,此方法必须被重写 -Web.sockethandler.on_close():当websocket连接关闭后被调用 Websockethandle.write_message(message,binary&#x3D; False): 向客户端发送消息messagea，message可以是字符串或字典（字典会被转为json字符串）。若binary为False，则message以utf8编码发送；二进制模式（binary&#x3D;True）时，可发送任何字节码。 Websockethandler.close():关闭websocket连接 WebSocketHandler.check_origin(origin)：判断源origin，对于符合条件（返回判断结果为True）的请求源origin允许其连接，否则返回403。可以重写此方法来解决WebSocket的跨域请求（如始终return True）。注意：WebSocket可以共用Http对端口的监听和路由的配置。 四. 代码应用实例(报表刷新数据)1. 前端12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061callHcmOpenWebSocket: function (api_name, api_params) &#123; var defer = $q.defer(); var _host = window.wss_host || &#x27;&#x27;; if (_host === &#x27;&#x27;) &#123; _host = window.location.protocol === &#x27;http:&#x27; ? &#x27;ws://&#x27; + window.location.host : &#x27;wss://&#x27; + window.location.host; &#125; var _auth = contextService.getContext(&#x27;auth&#x27;); var ws = new WebSocket(_host + &quot;/ws/&quot; + api_name + &#x27;?token=&#x27; + (_auth[&#x27;token&#x27;] || &#x27;&#x27;)); ws.onopen = function () &#123; ws.send(JSON.stringify(&#123; &quot;command&quot;: &quot;exec&quot;, &quot;data&quot;: api_params &#125;)); &#125;; ws.onmessage = function (evt) &#123; var _data = JSON.parse(evt.data); if (_data[&#x27;command&#x27;] === &#x27;notify&#x27;) &#123; defer.notify(_data.data); &#125; if (_data[&#x27;command&#x27;] === &#x27;success&#x27;) &#123; defer.resolve(_data.data.result); &#125; if (_data[&#x27;command&#x27;] === &#x27;error&#x27;) &#123; defer.reject(_data.data); &#125; &#125;; ws.onerror = function (e) &#123; defer.reject(e); &#125;; return defer.promise;&#125; 在我们的代码中,websocket的调用url,统一通过&#x2F;ws&#x2F;进行拼接前端首先创建了一个websocket对后端发起了连接请求.然后分别定义了三种触发事件的方法.当前后端连接建立后,前端通过send()方法,向后端发送请求参数,然后针对后端不同的返回回结果.通过onmessage()和onerror()分别进行响应处理.在这里,前端通过创建一个$q.defer()的延迟对象进行处理,通过后端的不同返回结果,延迟对象调用不同的方法,修改defer对象的状态值.三种状态: resolve(解决), reject(拒绝), notify(通知)。当状态一旦更改成resolve或者reject,就无法再更改为其他状态了. 2. 后端后端代码中的handler通过&#x2F;ws&#x2F;(.*)对前端的websocket请求进行匹配,首先定义了一个basewebsockethandler的基类,然后专门写了一个handler继承基类进行处理,这里整合到一起便于理解. 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100@open_handler(path=&#x27;/ws/(.*)&#x27;, index=900)class OpenAPIWebSocketServiceHandler(BaseHandler): &quot;&quot;&quot; @path /api/(.*) @group api_service @desc 调用OpenAPI服务 &quot;&quot;&quot; def check_origin(self, origin): # 默认允许连接 return Truedef open(self, *args, **kwargs): self.__dict__[&#x27;open_api&#x27;] = args[0] logging.info(&#x27;Begin WS api:&#123;&#125;&#x27;.format(args[0]))@tornado.gen.coroutinedef on_message(self, message): try: data = json.loads(message) if &#x27;command&#x27; in data: self.on_json_data(data[&#x27;command&#x27;], data.get(&#x27;data&#x27;, None)) else: self.on_json_data(None, data) except ValueError: self.on_json_data(None, &#123; &#x27;data&#x27;: message &#125;)def send_command(self, command, data):self.write_message(&#123; &quot;command&quot;: command, &quot;data&quot;: data&#125;)if command == &#x27;success&#x27; or command == &#x27;error&#x27;: self.close()def set_notify(self, data): try: self.send_command(&#x27;notify&#x27;, data) except Exception as e: # TODO 兼容websocket多线程write_message报错 logging.exception(e)def on_json_data(self, command, data=None): if command == &#x27;exec&#x27;: try: result = dict(srv_begin=int(time.time() * 1000)) result[&#x27;result&#x27;] = OpenApiFactory.execute_open_api( context=self.get_context(), name=self.__dict__[&#x27;open_api&#x27;], param=data, request=self.request, notify=self.set_notify) self.send_command(&#x27;success&#x27;, result) except Exception as e: logging.exception(e) self.send_command(&#x27;error&#x27;, str(e)) finally: environment.db.remove() 后端在前后端连接建立成功之后,首先添加了open_api的类属性,值为匹配到的api_name.当前端传入api的参数之后,在self.on_json_data里面调用相应的api,并将set_notify作为一个参数传入api,从而可以在api里面进行websocket通信,将api的执行进度返回给前端,前端通过defer.notify(),将后端进度返回给调用的位置进行展示.当api执行完成,或者报错的时候,通过返回执行结果,并关闭本次连接.前端接收到success或者error参数,或者通信失败时,会调用defer对象的resove或者reject方法,修改状态并返回后端的处理结果. 注:为了兼容浏览器,在http协议下的websocket使用ws协议,在https协议下,应使用wss协议.","categories":[{"name":"Python基础","slug":"Python基础","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/"},{"name":"异步编程","slug":"Python基础/异步编程","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/"}],"tags":[]},{"title":"celery","slug":"python/异步编程/celery","date":"2023-08-15T12:50:10.000Z","updated":"2025-07-22T01:33:14.920Z","comments":true,"path":"2023/08/15/python/异步编程/celery/","link":"","permalink":"https://dbbruce.github.io/2023/08/15/python/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/celery/","excerpt":"一、celeryCelery 是一个强大的 分布式任务队列 的 异步处理框架，它可以让任务的执行完全脱离主程序，甚至可以被分配到其他主机上运行。我们通常使用它来实现异步任务（async task）和定时任务（crontab）.可以看到，Celery 主要包含以下几个模块： 任务模块 Task:包含异步任务和定时任务。其中，异步任务通常在业务逻辑中被触发并发往任务队列，而定时任务由 Celery Beat 进程周期性地将任务发往任务队列。 消息中间件 Broker: Broker，即为任务调度队列，接收任务生产者发来的消息（即任务），将任务存入队列。Celery 本身不提供队列服务，官方推荐使用 RabbitMQ 和 Redis 等。 任务执行单元 Worker: Worker 是执行任务的处理单元，它实时监控消息队列，获取队列中调度的任务，并执行它。 任务结果存储 Backend: Backend 用于存储任务的执行结果，以供查询。同消息中间件一样，存储也可使用 RabbitMQ, redis 和 MongoDB 等。","text":"一、celeryCelery 是一个强大的 分布式任务队列 的 异步处理框架，它可以让任务的执行完全脱离主程序，甚至可以被分配到其他主机上运行。我们通常使用它来实现异步任务（async task）和定时任务（crontab）.可以看到，Celery 主要包含以下几个模块： 任务模块 Task:包含异步任务和定时任务。其中，异步任务通常在业务逻辑中被触发并发往任务队列，而定时任务由 Celery Beat 进程周期性地将任务发往任务队列。 消息中间件 Broker: Broker，即为任务调度队列，接收任务生产者发来的消息（即任务），将任务存入队列。Celery 本身不提供队列服务，官方推荐使用 RabbitMQ 和 Redis 等。 任务执行单元 Worker: Worker 是执行任务的处理单元，它实时监控消息队列，获取队列中调度的任务，并执行它。 任务结果存储 Backend: Backend 用于存储任务的执行结果，以供查询。同消息中间件一样，存储也可使用 RabbitMQ, redis 和 MongoDB 等。 二、创建异步任务 创建一个celery实例创建一个celery实例，并指定broker和backend，添加celery任务（用@app.task装饰函数即可） 启动celery worker Celery worker -A tasks –loglevel&#x3D;info参数： -A 指定了celery 实例的位置，celery 会自动在该文件中寻找celery实例参数–loglevel 指定了日志级别，默认为warning,也可以 -l info来表示。 调用任务可以通过调用delay()方法和apply_async()方法来调用任务。Delay可以理解为apply_async()的快捷方式，appy_async支持更多的参数，一般形式如下：apply_async(args&#x3D;(), kwargs&#x3D;{}, route_name&#x3D;None, **options) 常用参数：countdown:指定多少秒后执行任务eta: 指定任务的具体被调度时间，参数类型为datetimeexpires: 任务过期时间，参数类型可以是int，也可以是datetime 三、配置文件和定时任务Celery 除了可以执行异步任务，也支持执行周期性任务（Periodic Tasks），或者说定时任务。Celery Beat 进程通过读取配置文件的内容，周期性地将定时任务发往任务队列。 BROKER_URL: 指定broker CELERY_RESULT_BACKEND: 指定 backend CELERY_TIMEZONE: 制定时区 CELERY_IMPORTS &#x3D; (,): 指定导入的任务模块 CELERYBEAT_SCHEDULE: 定时任务， 可以指定间隔时间发送，也可以指定固定时间发送。通过开启celery beat 进程，定时任务将在对应时刻发送到broker:Celery beat -A celery_app 四、代码应用 配置文件(解释见) 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051# -*- coding: utf-8 -*-from __future__ import absolute_importimport sysfrom celery import platformsfrom apps.task.models import ScheduleTaskfrom environment import environment# 允许root用户启动platforms.C_FORCE_ROOT = True# Disable UTC user 是否自动转换utc时间CELERY_ENABLE_UTC = False# Set Broken urlif environment.get_conf(&quot;celery&quot;, &quot;broker_url&quot;, default=&#x27;&#x27;) is None or environment.get_conf(&quot;celery&quot;, &quot;broker_url&quot;,default=&#x27;&#x27;) == &#x27;&#x27;:BROKER_URL = environment.get_conf(&quot;hcm_cloud&quot;, &quot;redis&quot;)else:BROKER_URL = environment.get_conf(&quot;celery&quot;, &quot;broker_url&quot;)# Disable Hijack 默认情况下将删除日志配置，禁用后可以自定义日志CELERYD_HIJACK_ROOT_LOGGER = False# Enable Poll Restart 可以通过远程命令重启workerCELERYD_POOL_RESTARTS = True# 每个worker执行了多少任务就会死掉，默认是无限的 杀掉是解决celery内存泄露问题CELERYD_MAX_TASKS_PER_CHILD = 20# Set Pool Limit to 100连接池最大连接数BROKER_POOL_LIMIT = 10Redis最大连接数CELERY_REDIS_MAX_CONNECTIONS = 10BROKER_TRANSPORT_OPTIONS = &#123;&quot;max_connections&quot;: 400&#125;# Set SerializersCELERY_ACCEPT_CONTENT = [&#x27;json&#x27;, &#x27;pickle&#x27;]CELERY_TASK_SERIALIZER = &#x27;json&#x27;CELERY_RESULT_SERIALIZER = &#x27;json&#x27;# Set ImportsCELERY_IMPORTS = [&#x27;apps.insight.services_kanban_schedule&#x27;,&#x27;apps.circle.circle_article.services_article&#x27;,&#x27;core.base.message.send&#x27;,&#x27;apps.task.service&#x27;]if len(sys.argv) &gt; 1 and sys.argv[1] == &#x27;beat&#x27;: CELERYBEAT_SCHEDULE = ScheduleTask.get_schedule_task() 启动方法 12345678910111213141516171819app = celery.Celery(&#x27;hcm_cloud&#x27;)app_celery.config_from_object(&#x27;apps.task.celery_config&#x27;)def start_worker():from celery.bin import workeroptions = &#123;&#x27;hostname&#x27;: environment.get_conf(&#x27;celery&#x27;, &#x27;host_name&#x27;),&#x27;loglevel&#x27;: &#x27;INFO&#x27;,&#x27;traceback&#x27;: True,&#x27;queues&#x27;: environment.get_conf(&#x27;celery&#x27;, &#x27;queues&#x27;)&#125;worker.worker(app=app_celery).run(**options)def start_beat():from celery.bin import beatoptions = &#123;&#x27;loglevel&#x27;: &#x27;INFO&#x27;&#125;beat.beat(app=app_celery).run(**options) 首先创建一个celery对象,通过app.config_from_object 方法加载配置文件.代码中启动celery的方法通过celery.bin模块来启动一个celery实例.在run方法里面传入启动时的参数,hostname:主机名loglevel:日志级别traceback:是否返回处理结果queues:该woker对应的消息队列注:celery是一个分布式的任务调度模块，支持多台不同的计算机执行不同的任务或者相同的任务,简单理解就是celery可以创建多个消息队列,通过配置,不同的消息队列可以对应一个或多个woker.而这是通过Exchange来实现的，发送消息到”消息队列”中时，可以指定routiing_key，Exchange通过routing_key来把消息路由（routes）到不同的”消息队列”中去,然后由该消息队列对应的woker来执行任务.我们代码中有default, monitor,syn,appoint,time五种任务队列. 异步任务 1234567891011121314@app.task(queue=&#x27;syn&#x27;, routing_key=&#x27;syn&#x27;)def call_open_api_asynchronous(token, emp_id, company_id, api_name, api_param):setattr(context, &#x27;token&#x27;, token)OpenApiFactory.execute_open_api(context=context, name=api_name, param=api_param)finally:environment.db.remove()call_open_api_asynchronous.apply_async([getattr(self.context, &#x27;token&#x27;),self.context.employee.id,self.context.company.id,&#x27;motion.add.middle.document&#x27;,&#123;&#x27;motion_id&#x27;: _items[0].get(&quot;motion_id&quot;)&#125;],queue=&#x27;syn&#x27;,routing_key=&#x27;syn&#x27;) 我们通过app.task装饰器,将一个函数定义为一个异步任务,然后通过func.apply_async()来发布任务,其中app为一开始创建的那个celery对象.func.apply_async(*args, **kwargs)第一个参数接受一个元祖或者列表,依次传入该方法对应的参数.这里有不管装饰器和apply_async()方法中,都分别定义了queue 和routing_key两个参数,我的理解是将任务发布到某一个队列中.经测试,queue是发布队列的参数,当去掉所有参数,只留apply_async(queue&#x3D; “syn”)或者只保留task(queue &#x3D; “syn”)时,syn对应的worker都能顺利的接受到任务并执行.##4. 定时任务定时任务通过celery_beat进行发布,当启动celery-beat之后,会自动获取配置文件中CELERYBEAT_SCHEDULE的值,进行定时的任务发布.业务中通过back_ground_schedule_task 这张表保存需要执行的定时任务. 123456789101112_rows = cls.db().query(cls).filter(cls.enabled == True).all()_ret = &#123;&#125;for row in _rows:domain = row.domain if row.domain else &#x27;main&#x27;_ret[row.schedule_number] = &#123;&#x27;task&#x27;: &quot;apps.task.service.process_schedule_task_&quot; + domain,&#x27;schedule&#x27;: eval(row.schedule),&#x27;args&#x27;: (row.task,) + eval(&quot;()&quot; if (row.args is None or row.args == &quot;&quot;) else row.args)&#125;logging.info(&quot;&#123;&#125;:&#123;&#125;:&#123;&#125;&quot;.format(&quot;apps.task.service.process_schedule_task_&quot; + domain, row.schedule, row.task))return _ret task:要执行的任务的的函数schedule:执行时间,可以是一个timedelta表示每间隔多久执行一次,也可以是一个crontab指定固定的时间去执行args:传入的参数.代码中每个队列执行的任务都是由一个统一的函数进行分发,比如 12345678910111213@app.task(bind=True, queue=&#x27;syn&#x27;, routing_key=&#x27;syn&#x27;)def process_schedule_task_syn(self, *args):full_method_name = args[0]full_path = full_method_name.split(&quot;.&quot;)new_args = args[1:]sys.path.append(os.path.abspath(os.path.join(os.path.join(os.path.dirname(__file__), os.path.pardir), os.path.pardir)))temp_class_name = full_path[len(full_path) - 2]module = importlib.import_module(&quot;.&quot;.join(full_path[:-2]))_class = getattr(module, temp_class_name)_class = _class()_method = getattr(_class, full_path[len(full_path) - 1])apply(_method, new_args) 在配置文件中传入的参数有两个,一个是该任务对应的函数,另一个是函数需传入的参数.因此在统一发布的函数中,解析出该任务对应执行的函数及参数,然后通过apply方法调用函数. 添加flower监控安装flower包 终端输入 celery flower –address&#x3D;127.0.0.1 –port&#x3D;5555 –broker&#x3D;redis:&#x2F;&#x2F;127.0.0.1:6379&#x2F;","categories":[{"name":"Python基础","slug":"Python基础","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/"},{"name":"异步编程","slug":"Python基础/异步编程","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/"}],"tags":[]},{"title":"爬虫","slug":"python/异步编程/爬虫","date":"2023-08-15T11:50:10.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2023/08/15/python/异步编程/爬虫/","link":"","permalink":"https://dbbruce.github.io/2023/08/15/python/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/%E7%88%AC%E8%99%AB/","excerpt":"1.爬虫1pip3 install aiohttp","text":"1.爬虫1pip3 install aiohttp 2.实例1123456789101112131415161718192021222324import aiohttpimport asyncioasync def fetch(session, url): print(&quot;发送请求:&quot;, url) async with session.get(url, verify_ssl=False) as response: text = await response.textO print(&quot;得到结果:&quot;,url, len(text)) return text async def main(): async with aiohttp.clientsession() as session: url_list= [ &quot;https://python.org&quot;, &quot;https://www.baidu.com&quot;, &quot;https://www.pythonav.com&quot; ] tasks = [ asyncio.create_task(fetch(session, url)) for url in url_list] done,pending = await asyncio.wait(tasks) if __name__ == &#x27;__main__&#x27;: asyncio.run( main() )","categories":[{"name":"Python基础","slug":"Python基础","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/"},{"name":"异步编程","slug":"Python基础/异步编程","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/"}],"tags":[]},{"title":"异步mysql","slug":"python/异步编程/异步mysql","date":"2023-08-15T11:30:10.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2023/08/15/python/异步编程/异步mysql/","link":"","permalink":"https://dbbruce.github.io/2023/08/15/python/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/%E5%BC%82%E6%AD%A5mysql/","excerpt":"1.异步mysql1pip3 install aiomysql","text":"1.异步mysql1pip3 install aiomysql 2.实例11234567891011121314151617181920212223242526272829303132#!/usr/bin/env pythor# -*- coding;utf-8 -*import asyncioimport aiomysqlasync def execute(host, password): print(&quot;开始&quot;, host) #网络I0操作: 先去连接 47.93,40.197、遇到IO则自动切换任务，去连接47.93.40.198:6379 conn = await aiomysql.connect(host=host, port=3306, user=&#x27;root&#x27;, password=password, db=&#x27;mysql&#x27;) # 网络IO操作: 遇到I0会自动切换任务 cur = await conn.cursor() # 网络TO操作: 遇到I0会自动切换任务 await cur.execute(&quot;SELECT Host,,user FRoM user&quot;) #网络TO操作: 遇到I0会自动切换任务 result = await cur.fetchall() print(result) # 网络IO操作: 遇到I0会自动切换任务 await cur.close() conn.close() print(&quot;结来&quot;, host) task_list = [ execute(&#x27;47.93.40.197&#x27;, &quot;root!2345&quot;), execute(&#x27;47.93.40.197&#x27;, &quot;root!2345&quot;) ]asyncio. run(asyncio.wait(task_list)) 3.实例2123456789101112131415161718192021222324252627282930313233343536373839404142#!/usr/bin/env python# -*- coding;utf-8 -*.import asyncioimport uvicornimport aioredisfrom aioredis import Redisfrom fastapi import Fastapiapp = Fastapi()# 创道一个redis连接池REDIS_POOL = aioredis.ConnectionsPoo1(&quot;redis: //47.193.14.198:6379&quot; , password=&quot;root123&quot;, minsize=1, maxsize=10)@app.get(&quot;/&quot;)def index(): &quot;&quot;&quot;普操作接口&quot;&quot;&quot; return &#123;&quot;message&quot;: &quot;Hello world&quot;&#125;@app.get(&quot;/red&quot;)async def red(): &quot;&quot;&quot;异作接口&quot;&quot;&quot; print(&quot;请求来了&quot;) await asyncio. sleep(3) # 连接池获取一个连接 conn = await REDIS_POOL.acquire() redis = Redis(conn) # 设置值 await redis.hmset_dict(&#x27;car&#x27; , key1=1, key2=2, key3=3) # 读取值 result = await redis.getal1(&#x27;car&#x27;, encoding=&#x27;utf-8&#x27;) print(result) # 连接归还连接泄 REDIS_POOL.release(conn) return resultif __name__ == &#x27;__main__&#x27;: uvicorn.run(&quot;luffy:app&quot;, host=&quot;127.0.0.1&quot;, port=5000, log_level=&quot;info&quot;)","categories":[{"name":"Python基础","slug":"Python基础","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/"},{"name":"异步编程","slug":"Python基础/异步编程","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/"}],"tags":[]},{"title":"异步redis","slug":"python/异步编程/异步redis","date":"2023-08-15T11:00:10.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2023/08/15/python/异步编程/异步redis/","link":"","permalink":"https://dbbruce.github.io/2023/08/15/python/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/%E5%BC%82%E6%AD%A5redis/","excerpt":"1.异步redis在使用python代码操作redis时，链接&#x2F;操作&#x2F;断开都是网络10。 1pip3 install aioredis","text":"1.异步redis在使用python代码操作redis时，链接&#x2F;操作&#x2F;断开都是网络10。 1pip3 install aioredis 2.实例1123456789101112131415161718192021222324#!/usr/bin/env python# -*- coding;utf-8 -import asyncioimport aioredisasync def execute(address, password): print(&quot;开始执行&quot;, address) # 网络IO操作: 创建redis连接 redis = await aioredis.create_redis(address, password=password) # 网络IO操作: 在redis中设置哈希值car，内部在设三个键值对，即: redis = [ car:[key1:1,key2:2, key3:33] await redis.hmset_dict(&#x27;car&#x27; , key1= 1, key2= 2, key3= 3) # 网络IO操作:去redis中获取值 result = await redis.hgetall(&#x27;car&#x27; , encoding=&#x27;utf-8&#x27;) print(result) redis.close() # 网络IO操作: 关闭redis连接 await redis.wait_closed() print(&quot;结束&quot;, address)asyncio.run(execute(&#x27;redis://47.93.4.198:6379&#x27;, &quot;root!2345&quot;)) 3.实例2123456789101112131415161718192021222324252627import asyncioimport aioredisasync def execute(address, password): print(&quot;开始执行&quot;, address) # 网络IO操作:先去连接 47,93,4,197:6379，遇到I0则自动切换任务，去连接47,93,4,198:6379 redis = await aioredis.create_redis_pool(address, password=password) # 网络I0操作: 遇到IO会自动切换任务 await redis.hmset_dict(&#x27;car&#x27;, key1= 1, key2= 2, key3= 3) # 网络TO操作:遇到IO会自动切换任务 result = await redis.hgetal1(&#x27;car&#x27; , encoding= &#x27;utf-8&#x27;) print(result) redis.close() #网络I0操作:遇到IO会自动切换任务 await redis.wait_closed() print(&quot;结束&quot;, address) task_list = [ execute(&#x27;redis://47.93.4.197:6379&#x27;, &quot;root!23457&quot;), execute(&#x27;redis://47.93.4.198:6379&#x27;, &quot;root!2345&quot;) ]asyncio.run(asyncio.wait(task_list))","categories":[{"name":"Python基础","slug":"Python基础","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/"},{"name":"异步编程","slug":"Python基础/异步编程","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/"}],"tags":[]},{"title":"008-pyquery解析数据","slug":"爬虫/基础/008-pyquery解析数据","date":"2023-08-15T05:04:52.000Z","updated":"2024-05-31T01:46:23.000Z","comments":true,"path":"2023/08/15/爬虫/基础/008-pyquery解析数据/","link":"","permalink":"https://dbbruce.github.io/2023/08/15/%E7%88%AC%E8%99%AB/%E5%9F%BA%E7%A1%80/008-pyquery%E8%A7%A3%E6%9E%90%E6%95%B0%E6%8D%AE/","excerpt":"pyqueryPyQuery是一个Python库，它提供了一种用于解析HTML、XML和JSON文档的非常直观和方便的方式。它基于jQuery库的选择器语法，并支持类似于XPath的表达式。PyQuery可以轻松地在Python程序中实现Web爬虫，从而使数据挖掘变得非常容易。","text":"pyqueryPyQuery是一个Python库，它提供了一种用于解析HTML、XML和JSON文档的非常直观和方便的方式。它基于jQuery库的选择器语法，并支持类似于XPath的表达式。PyQuery可以轻松地在Python程序中实现Web爬虫，从而使数据挖掘变得非常容易。 pyquery初始化 字符串方式123456789101112131415161718192021222324from pyquery import PyQuery as pqstr = &quot;&quot;&quot;&lt;!DOCTYPE html&gt;&lt;html&gt; &lt;head&gt; &lt;title&gt;Header&lt;/title&gt; &lt;meta charset=&quot;utf-8&quot;&gt; &lt;/head&gt; &lt;body&gt; &lt;h2&gt;Operating systems&lt;/h2&gt; &lt;ul id=&quot;mylist&quot; style=&quot;width:150px&quot;&gt; &lt;li&gt;Solaris&lt;/li&gt; &lt;li&gt;FreeBSD&lt;/li&gt; &lt;li&gt;Debian&lt;/li&gt; &lt;li&gt;NetBSD&lt;/li&gt; &lt;li&gt;Windows&lt;/li&gt; &lt;/ul&gt; &lt;/body&gt; &lt;/html&gt;&quot;&quot;&quot;doc = pq(str)print(doc(&quot;h2&quot;).text()) url方式123from pyquery import PyQuery as pqdoc = pq(url=&#x27;http://www.baidu.com&#x27;, encoding=&#x27;utf-8&#x27;)print(doc(&quot;h2&quot;).text()) 文件123from pyquery import PyQuery as pqdoc = pq(filename=&#x27;index.html&#x27;)print(doc(&quot;h2&quot;).text()) 选择元素12345要选择元素，可以使用标签名称、类、ID等。以下是一些选择器示例：doc(&#x27;div&#x27;) # 选择所有div元素doc(&#x27;.item&#x27;) # 选择所有类为item的元素doc(&#x27;#container&#x27;) # 选择具有ID为container的元素doc(&#x27;ul li&#x27;) # 选择所有ul下的li元素 选择属性123可以使用.attr()方法来选择元素的属性，例如：doc(&#x27;a&#x27;).attr(&#x27;href&#x27;) # 选择所有a元素的href属性值doc(&#x27;img&#x27;).attr(&#x27;src&#x27;) # 选择所有img元素的src属性值 选择文本123456可以使用.text()方法来选择元素的文本内容，例如：doc(&#x27;title&#x27;).text() # 选择标题标签的文如果要选择多个元素的文本内容，可以使用循环来逐个获取它们的文本内容，例如：items = doc(&#x27;.item&#x27;)for item in items: print(pq(item).text()) 操作元素 PyQuery支持许多jQuery的操作方法，如添加、删除、修改元素的类、属性等。以下是一些常用的方法： 添加类 doc(‘.item’).addClass(‘active’) 删除类 doc(‘.item’).removeClass(‘active’) 修改属性 doc(‘a’).attr(‘href’, ‘http://www.example.com/‘) 删除属性 doc(‘a’).removeAttr(‘href’) 修改文本内容 doc(‘p’).text(‘This is a new paragraph.’) 在元素中插入HTML doc(‘#container’).html(‘item1 item2’) 在元素前插入HTML doc(‘#container’).before(‘This is a new paragraph.’) 在元素后插入HTML doc(‘#container’).after(‘This is a new paragraph.’) 删除元素 doc(‘.item’).remove() 异常处理123PyQuery库的常见异常包括：requests.exceptions.RequestException：网络请求异常。pyquery.pyquery.PyQueryException：PyQuery解析异常。 123456789101112131415161718192021import requestsfrom pyquery import PyQuery as pqurl = &#x27;https://www.example.com/&#x27;try: response = requests.get(url) response.raise_for_status() # 抛出HTTPError异常（状态码不为200）except requests.exceptions.RequestException as e: print(&#x27;Error:&#x27;, e) exit()doc = pq(response.text)try: title = doc(&#x27;title&#x27;).text()except pq.PyQueryException as e: print(&#x27;Error:&#x27;, e) exit()print(title) html和text有区别，html获取标签里的内容，包含标签，text只获取标签里的文本","categories":[{"name":"爬虫类","slug":"爬虫类","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/"},{"name":"基础","slug":"爬虫类/基础","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"uvloop","slug":"python/异步编程/uvloop","date":"2023-08-14T15:00:10.000Z","updated":"2024-02-06T13:26:05.000Z","comments":true,"path":"2023/08/14/python/异步编程/uvloop/","link":"","permalink":"https://dbbruce.github.io/2023/08/14/python/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/uvloop/","excerpt":"1.uvloopasyncio的事件循环的替代方案。事件循环—&gt;默认asyncio的事件循环","text":"1.uvloopasyncio的事件循环的替代方案。事件循环—&gt;默认asyncio的事件循环 1pip3 insta17 uvloop 12345678import asyncioimport uvloopasyncio.set_event_loop_policy(uvloop.EventLoopPolicy())# 编写asyncio的代码，与之前写的代码一致# 内部的事件循环自动化会变为uvloopasyncio.run(...) 注意: 一个asgi –&gt; uvicorn 内部使用的就是uvloop","categories":[{"name":"Python基础","slug":"Python基础","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/"},{"name":"异步编程","slug":"Python基础/异步编程","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/"}],"tags":[]},{"title":"异步迭代器","slug":"python/异步编程/异步迭代器","date":"2023-08-14T13:25:10.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2023/08/14/python/异步编程/异步迭代器/","link":"","permalink":"https://dbbruce.github.io/2023/08/14/python/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/%E5%BC%82%E6%AD%A5%E8%BF%AD%E4%BB%A3%E5%99%A8/","excerpt":"1.异步迭代器实现了__aiter__()和__anext__()方法的对象。anext()必须返回一个awaitable 对象。async for 会处理异步选代器的__anext__()方法所返回的可等待对象，直到其引发一个 StopAsyncIteration 异常。什么是异步可迭代对象?可在 async for 语句中被使用的对象。必须通过它的 aiter()方法返回一个asynchronous_iterator。","text":"1.异步迭代器实现了__aiter__()和__anext__()方法的对象。anext()必须返回一个awaitable 对象。async for 会处理异步选代器的__anext__()方法所返回的可等待对象，直到其引发一个 StopAsyncIteration 异常。什么是异步可迭代对象?可在 async for 语句中被使用的对象。必须通过它的 aiter()方法返回一个asynchronous_iterator。 2.实现123456789101112131415161718192021222324252627import asyncioclass Reader(object): &quot;&quot;&quot;自定义异步迭代器 (同时也是异步可选代对象) &quot;&quot;&quot; def _init_ (self): self.count = 0 async def readline(self): # await asyncio,sleep(1) self.count += 1 if self.count == 100: return None return self.count def __aiter__(self): return self async def anext (self): val = await self.readline() if val == None: raise StopAsyncIteration return val async def func(): obj = Reader() async for item in obj: print(item)asyncio.run( func() ) 3.异步上下文管理器此种对象通过定义__aenter__()和 aexit() 方法来对async with 语句中的环境进行控制。 12345678910111213141516171819202122232425import asyncioclass Asynccontextanager: def _init_(self, conn): self.conn = conn async def do_something(self): # 异步操作数据库 return 666 async def _aenter_(self): # 异步接数据库# # self.conn = await asyncio.sleep(1) return self async def __aexit__(self, exc_type, exc, tb): # 异步关闭数据库 await asyncio.sleep(1) async def func(): async with Asynccontextanager() as f: result = await f.do_something() print(result)asyncio.run( func() )","categories":[{"name":"Python基础","slug":"Python基础","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/"},{"name":"异步编程","slug":"Python基础/异步编程","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/"}],"tags":[]},{"title":"007-正则表达式","slug":"爬虫/基础/007-正则表达式","date":"2023-08-14T05:04:52.000Z","updated":"2024-05-31T01:46:23.000Z","comments":true,"path":"2023/08/14/爬虫/基础/007-正则表达式/","link":"","permalink":"https://dbbruce.github.io/2023/08/14/%E7%88%AC%E8%99%AB/%E5%9F%BA%E7%A1%80/007-%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/","excerpt":"正则表达式模式","text":"正则表达式模式 1234567891011121314151617181920212223242526272829303132333435363738模式 描述^ 匹配字符串的开头$ 匹配字符串的末尾。. 匹配任意字符，除了换行符，当re.DOTALL标记被指定时，则可以匹配包括换行符的任意字符。[...] 用来表示一组字符,单独列出：[amk] 匹配 &#x27;a&#x27;，&#x27;m&#x27;或&#x27;k&#x27;[^...] 不在[]中的字符：[^abc] 匹配除了a,b,c之外的字符。re* 匹配0个或多个的表达式。re+ 匹配1个或多个的表达式。re? 匹配0个或1个由前面的正则表达式定义的片段，非贪婪方式re&#123; n&#125; 精确匹配 n 个前面表达式。例如， o&#123;2&#125; 不能匹配 &quot;Bob&quot; 中的 &quot;o&quot;，但是能匹配 &quot;food&quot; 中的两个 o。re&#123; n,&#125; 匹配 n 个前面表达式。例如， o&#123;2,&#125; 不能匹配&quot;Bob&quot;中的&quot;o&quot;，但能匹配 &quot;foooood&quot;中的所有 o。&quot;o&#123;1,&#125;&quot; 等价于 &quot;o+&quot;。&quot;o&#123;0,&#125;&quot; 则等价于 &quot;o*&quot;。re&#123; n, m&#125; 匹配 n 到 m 次由前面的正则表达式定义的片段，贪婪方式a| b 匹配a或b(re) 对正则表达式分组并记住匹配的文本(?imx) 正则表达式包含三种可选标志：i, m, 或 x 。只影响括号中的区域。(?-imx) 正则表达式关闭 i, m, 或 x 可选标志。只影响括号中的区域。(?: re) 类似 (...), 但是不表示一个组(?imx: re) 在括号中使用i, m, 或 x 可选标志(?-imx: re) 在括号中不使用i, m, 或 x 可选标志(?#...) 注释.(?= re) 前向肯定界定符。如果所含正则表达式，以 ... 表示，在当前位置成功匹配时成功，否则失败。但一旦所含表达式已经尝试，匹配引擎根本没有提高；模式的剩余部分还要尝试界定符的右边。(?! re) 前向否定界定符。与肯定界定符相反；当所含表达式不能在字符串当前位置匹配时成功(?&gt; re) 匹配的独立模式，省去回溯。\\w 匹配字母数字及下划线\\W 匹配非字母数字及下划线\\s 匹配任意空白字符，等价于 [ \\t\\n\\r\\f]。\\S 匹配任意非空字符\\d 匹配任意数字，等价于 [0-9].\\D 匹配任意非数字\\A 匹配字符串开始\\Z 匹配字符串结束，如果是存在换行，只匹配到换行前的结束字符串。\\z 匹配字符串结束\\G 匹配最后匹配完成的位置。\\b 匹配一个单词边界，也就是指单词和空格间的位置。例如， &#x27;er\\b&#x27; 可以匹配&quot;never&quot; 中的 &#x27;er&#x27;，但不能匹配 &quot;verb&quot; 中的 &#x27;er&#x27;。\\B 匹配非单词边界。&#x27;er\\B&#x27; 能匹配 &quot;verb&quot; 中的 &#x27;er&#x27;，但不能匹配 &quot;never&quot; 中的 &#x27;er&#x27;。\\n, \\t, 等. 匹配一个换行符。匹配一个制表符。等\\1...\\9 匹配第n个分组的内容。\\10 匹配第n个分组的内容，如果它经匹配。否则指的是八进制字符码的表达式。 re.match123456789re.match 尝试从字符串的起始位置匹配一个模式，如果不是起始位置匹配成功的话，match() 就返回 none。匹配成功 re.match 方法返回一个匹配的对象，否则返回 None。re.match(pattern, string, flags=0)参数 描述pattern 匹配的正则表达式string 要匹配的字符串。flags 标志位，用于控制正则表达式的匹配方式，如：是否区分大小写，多行匹配等等。参见：正则表达式修饰符 - 可选标志 123456789101112131415import reline = &quot;Cats are smarter than dogs&quot;matchObj = re.match(r&#x27;(.*) are (.*?) .*&#x27;, line, re.M | re.I)print(matchObj)if matchObj: print(&quot;matchObj.group() : &quot;, matchObj.group()) print(&quot;matchObj.group(1) : &quot;, matchObj.group(1)) print(&quot;matchObj.group(2) : &quot;, matchObj.group(2))else: print(&quot;No match!!&quot;)# &lt;re.Match object; span=(0, 26), match=&#x27;Cats are smarter than dogs&#x27;&gt;# matchObj.group() : Cats are smarter than dogs# matchObj.group(1) : Cats# matchObj.group(2) : smarter re.search123456789re.search 扫描整个字符串并返回第一个成功的匹配。匹配成功re.search方法返回一个匹配的对象，否则返回None。re.search(pattern, string, flags=0)参数 描述pattern 匹配的正则表达式string 要匹配的字符串。flags 标志位，用于控制正则表达式的匹配方式，如：是否区分大小写，多行匹配等等。 123456789101112131415import reline = &quot;Cats are smarter than dogs&quot;searchObj = re.search(r&#x27;(.*) are (.*?) .*&#x27;, line, re.M | re.I)print(searchObj)if searchObj: print(&quot;matchObj.group() : &quot;, searchObj.group()) print(&quot;matchObj.group(1) : &quot;, searchObj.group(1)) print(&quot;matchObj.group(2) : &quot;, searchObj.group(2))else: print(&quot;No match!!&quot;) # &lt;re.Match object; span=(0, 26), match=&#x27;Cats are smarter than dogs&#x27;&gt;# matchObj.group() : Cats are smarter than dogs# matchObj.group(1) : Cats# matchObj.group(2) : smarter re.match与re.search的区别12re.match只匹配字符串的开始，如果字符串开始不符合正则表达式，则匹配失败，函数返回None；而re.search匹配整个字符串，直到找到一个匹配 检索和替换123456789Python 的 re 模块提供了re.sub用于替换字符串中的匹配项。re.sub(pattern, repl, string, count=0, flags=0)参数：pattern : 正则中的模式字符串。repl : 替换的字符串，也可为一个函数。string : 要被查找替换的原始字符串。count : 模式匹配后替换的最大次数，默认 0 表示替换所有的匹配。 1234567891011121314import rephone = &quot;2004-959-559 # 这是一个国外电话号码&quot;# 删除字符串中的 Python注释num = re.sub(r&#x27;#.*$&#x27;, &quot;&quot;, phone)print(&quot;电话号码是: &quot;, num)# 删除非数字(-)的字符串num = re.sub(r&#x27;\\D&#x27;, &quot;&quot;, phone)print(&quot;电话号码是 : &quot;, num)# 电话号码是: 2004-959-559 # 电话号码是 : 2004959559 repl 参数是一个函数 12345678910# 将匹配的数字乘以 2def double(matched): value = int(matched.group(&#x27;value&#x27;)) return str(value * 2)s = &#x27;A23G4HFD567&#x27;# 匹配的数字，传入double函数，print(re.sub(&#x27;(?P&lt;value&gt;\\d+)&#x27;, double, s)) # A46G8HFD1134 re.compile 函数123456789101112compile 函数用于编译正则表达式，生成一个正则表达式（ Pattern ）对象，供 match() 和 search() 这两个函数使用。re.compile(pattern[, flags])参数：pattern : 一个字符串形式的正则表达式flags : 可选，表示匹配模式，比如忽略大小写，多行模式等，具体参数为： re.I 忽略大小写 re.L 表示特殊字符集 \\w, \\W, \\b, \\B, \\s, \\S 依赖于当前环境 re.M 多行模式 re.S 即为 . 并且包括换行符在内的任意字符（. 不包括换行符） re.U 表示特殊字符集 \\w, \\W, \\b, \\B, \\d, \\D, \\s, \\S 依赖于 Unicode 字符属性数据库 re.X 为了增加可读性，忽略空格和 # 后面的注释 12345678910111213141516171819&gt;&gt;&gt;import re&gt;&gt;&gt; pattern = re.compile(r&#x27;\\d+&#x27;) # 用于匹配至少一个数字&gt;&gt;&gt; m = pattern.match(&#x27;one12twothree34four&#x27;) # 查找头部，没有匹配&gt;&gt;&gt; print mNone&gt;&gt;&gt; m = pattern.match(&#x27;one12twothree34four&#x27;, 2, 10) # 从&#x27;e&#x27;的位置开始匹配，没有匹配&gt;&gt;&gt; print mNone&gt;&gt;&gt; m = pattern.match(&#x27;one12twothree34four&#x27;, 3, 10) # 从&#x27;1&#x27;的位置开始匹配，正好匹配&gt;&gt;&gt; print m # 返回一个 Match 对象&lt;_sre.SRE_Match object at 0x10a42aac0&gt;&gt;&gt;&gt; m.group(0) # 可省略 0&#x27;12&#x27;&gt;&gt;&gt; m.start(0) # 可省略 03&gt;&gt;&gt; m.end(0) # 可省略 05&gt;&gt;&gt; m.span(0) # 可省略 0(3, 5) 12345group([group1, …]) 方法用于获得一个或多个分组匹配的字符串，当要获得整个匹配的子串时，可直接使用 group() 或 group(0)；start([group]) 方法用于获取分组匹配的子串在整个字符串中的起始位置（子串第一个字符的索引），参数默认值为 0；end([group]) 方法用于获取分组匹配的子串在整个字符串中的结束位置（子串最后一个字符的索引+1），参数默认值为 0；span([group]) 方法返回 (start(group), end(group))。 findall123456789在字符串中找到正则表达式所匹配的所有子串，并返回一个列表，如果有多个匹配模式，则返回元组列表，如果没有找到匹配的，则返回空列表。注意： match 和 search 是匹配一次 findall 匹配所有。语法格式为：findall(string[, pos[, endpos]])参数：string : 待匹配的字符串。pos : 可选参数，指定字符串的起始位置，默认为 0。endpos : 可选参数，指定字符串的结束位置，默认为字符串的长度。 1234567891011import repattern = re.compile(r&#x27;\\d+&#x27;) # 查找数字result1 = pattern.findall(&#x27;runoob 123 google 456&#x27;)result2 = pattern.findall(&#x27;run88oob123google456&#x27;, 0, 10)print(result1)print(result2)# [&#x27;123&#x27;, &#x27;456&#x27;]# [&#x27;88&#x27;, &#x27;12&#x27;] re.finditer1234567和 findall 类似，在字符串中找到正则表达式所匹配的所有子串，并把它们作为一个迭代器返回。re.finditer(pattern, string, flags=0)参数 描述pattern 匹配的正则表达式string 要匹配的字符串。flags 标志位，用于控制正则表达式的匹配方式，如：是否区分大小写，多行匹配等等。参见：正则表达式修饰符 - 可选标志 12345678910import reit = re.finditer(r&quot;\\d+&quot;, &quot;12a32bc43jf3&quot;)for match in it: print(match.group()) # 12# 32# 43# 3 re.split12345678split 方法按照能够匹配的子串将字符串分割后返回列表，它的使用形式如下：re.split(pattern, string[, maxsplit=0, flags=0])参数 描述pattern 匹配的正则表达式string 要匹配的字符串。maxsplit 分隔次数，maxsplit=1 分隔一次，默认为 0，不限制次数。flags 标志位，用于控制正则表达式的匹配方式，如：是否区分大小写，多行匹配等等。参见：正则表达式修饰符 - 可选标志 12345678910&gt;&gt;&gt;import re&gt;&gt;&gt; re.split(&#x27;\\W+&#x27;, &#x27;runoob, runoob, runoob.&#x27;)[&#x27;runoob&#x27;, &#x27;runoob&#x27;, &#x27;runoob&#x27;, &#x27;&#x27;]&gt;&gt;&gt; re.split(&#x27;(\\W+)&#x27;, &#x27; runoob, runoob, runoob.&#x27;) [&#x27;&#x27;, &#x27; &#x27;, &#x27;runoob&#x27;, &#x27;, &#x27;, &#x27;runoob&#x27;, &#x27;, &#x27;, &#x27;runoob&#x27;, &#x27;.&#x27;, &#x27;&#x27;]&gt;&gt;&gt; re.split(&#x27;\\W+&#x27;, &#x27; runoob, runoob, runoob.&#x27;, 1) [&#x27;&#x27;, &#x27;runoob, runoob, runoob.&#x27;] &gt;&gt;&gt; re.split(&#x27;a*&#x27;, &#x27;hello world&#x27;) # 对于一个找不到匹配的字符串而言，split 不会对其作出分割[&#x27;hello world&#x27;] 正则表达式修饰符 - 可选标志12345678修饰符 描述re.I 使匹配对大小写不敏感re.L 做本地化识别（locale-aware）匹配re.M 多行匹配，影响 ^ 和 $re.S 使 . 匹配包括换行在内的所有字符re.U 根据Unicode字符集解析字符。这个标志影响 \\w, \\W, \\b, \\B.re.X 该标志通过给予你更灵活的格式以便你将正则表达式写得更易于理解","categories":[{"name":"爬虫类","slug":"爬虫类","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/"},{"name":"基础","slug":"爬虫类/基础","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"async&await实现协程","slug":"python/异步编程/async&await实现协程","date":"2023-08-13T14:25:10.000Z","updated":"2024-02-07T03:47:57.000Z","comments":true,"path":"2023/08/13/python/异步编程/async&await实现协程/","link":"","permalink":"https://dbbruce.github.io/2023/08/13/python/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/async&await%E5%AE%9E%E7%8E%B0%E5%8D%8F%E7%A8%8B/","excerpt":"1.注意async, await只能用于python3.5及之后的版本","text":"1.注意async, await只能用于python3.5及之后的版本 2.普通方式下载图片123456789101112131415161718192021import requestsdef download_image(url): print(&quot;开始下载:&quot;, url) #发送网络请求，下载图片 response = requests.get(url) print(&quot;下载完成&quot;) #图片保存到本地文件 file_name = url.rsplit(&#x27;_&#x27;)[-1] with open(file_name, mode=&#x27;wb&#x27;) as file_object: file_object.write(response.content)if __name__ == &#x27;__main__&#x27;: url_list = [ &quot;https: //ww3.autoimg.cn/newsdfs/g26/M02/35/A9/120x90_0_autohomecar_chsEe12AX06A00H_AAFocMs8nzu621.jpg&quot;, &quot;https://ww2autoimg.cn/newsdfs/g30/M01/3C/E2/120x900 autohomecar chcCSV2BBICAUntfAAdiJFd6800429.jpg&quot;, &quot;https://www3.autoimg.cn/newsdfs/g26/M0B/3c/65/120x90_0_autohomecar_chcCP12BFCmAIO83AA(q7vK0SGY193.jpg&quot; ] for item in url_list: download_image(item) 3.异步方式下载图片1234567891011121314151617181920212223import aiohttpimport asyncioasync def fetch(session, url): print(&quot;发送请求:&quot;, url) async with session.get(url, verify_ssl=False) as response: content = await response.content.read() file_name = url.rsplit(&#x27; &#x27;)[-1] with open(file_name, mode= &quot;wb&quot;) as file_object: file_object.write(content)async def main(): async with aiohttp.clientsession() as session: url_list = [ &quot;https://www3.autoimg.cn/newsdfs/g26/M02/35/A9/120x90_0_autohomecar-chsEe12AX06A0OH_AAocMs8nzu621.jpg&quot;, &quot;https://ww2.autoimg.cn/newsdfs/g30/M01/3C/E2/120x90_0_autohomecar_chcCSV28BICAUntfAADjJFd6800429.jpg&quot;, &quot;https://ww3.autoimg.cn/newsdfs/g26/M0B/3C/65/120x90 0 autohomecar ChcCP12BFC ATO83AAq7VK05GY193.jpg&quot; ] tasks = [asyncio.create_task(fetch(session, url)) for url in url_list] await asyncio.wait(tasks) if __name__ == &#x27;__main__&#x27;: asyncio.run(main()) 4.名称解析协程函数：用 async def开头 定义函数协程对象：协程函数+(),就是协程对象 5. 细节讲解asyncio.run是一种简写的方式，但是只能用于python3.7后 1234567891011import asyncioasync def func(): print(&#x27;...&#x27;)result = func()# 去生成或获取一个事件循环loop = asyncio.get_event_loop()#将任务放到“任务列表“loop.run_until_complete(result) 等同于 12345678import asyncioasync def func(): print(&#x27;...&#x27;)result = func()asyncio.run(result) 5.awaitawait + 可等待对象（协程对象，future，task对象 –&gt;IO等待）await就是等待对象的值得到结果之后再继续向下走 1234567import asyncioasync def func(): print(&quot;来玩呀&quot;) response = await asyncio.sleep(2) print(&quot;结束&quot;, response) asyncio.run(func()) 6.task对象在事件循环中添加多个任务的。Tasks用于并发调度协程，通过asyncio.create_task(协程对象)的方式创建Task对象，这样可以让协程加入事件循环中等待被调度执行。除了使用 asyncio.create_task() 函数以外，还可以用低层级的loop.create_task() 或 ensure_future() 函数。不建议手动实例化 Task 对象。注意: asyncio.create_task() 函数在Python3.7 中被加入。在Python 3.7之前，可以改用低层级的asyncio.ensure future()函数 12345678910111213141516171819202122232425import asyncioasync def func(): print(1) await asyncio.sleep(2) print(2) return &quot;返回值&quot;async def main(): print(&quot;main开始&quot;) #创建Task对象，将当前执行func函数任务添加到事件通环 task1 = asyncio.create_task(func()) #创建Task对象，将当前执行func函数任务添加到事件备环 task2 = asyncio.create_task(func()) print(&quot;main结束&quot;) # 当执行某协程遇到IO操作时，会自动化切换执行其他任务 # #此处的await是雾待相对应的协程全都执行完毕并获取结狐 retl = await task1 ret2 = await task2 print(retl, ret2) asyncio.run(main()) 实例2注意：task写函数外，必须这么写，必须在创建一个异步函数 123456789101112131415161718import asyncioasync def func(): print(1) await asyncio.sleep(2) print(2) return &quot;返回值&quot;async def main(): print(&quot;main开始&quot;) task_list = [ asyncio.create_task( func() ), asyncio.create_task( func() ) ] print(&quot;main结束&quot;) done,pending = await asyncio.wait(task_list,timeout=None) print(done) asyncio.run( main() ) 7.Future对象Task继承Future，Task对象内部await结果的处理基于Future对象来的 1234567891011import asyncioasync def main(): # 获取当前事件循环 loop = asyncio.get_running_loop() # # 创建一个任务 (future对象) ，这个任务什么都不干 fut = loop.create_future() # 等待任务最终结果 (future对象) ，没有结果则会一直等下去 await futasyncio.run(main()) 实例2 123456789101112131415161718import asyncioasync def set_after(fut): await asyncio.sleep(2) fut.set_result(&quot;666&quot;)async def main(): #获取当前事件循环 loop = asyncio.get_running_loop() #创建一个任务(Future对象) ，没狮定任何行为，则这个任务永远不知道什么时候结束 fut = loop.create_future() #创建一个任务 (Task对象) ，绑定了set_after函数，函数内部在2s之后，会给fut财值 # 即手动设置future任务的最终结果，那么fut就可以结束了。 await loop.create_task(set_after(fut)) # 等待 Future对象获取 最终结果，否则一直等下去 data = await fut print(data)asyncio.run(main()) 8.concurrent.futures.Future对象使用线程池、进程池实现异步提作时用到的对象 12345678910111213141516171819import timefrom concurrent.futures import futurefrom concurrent.futures.thread import Threadpoolexecutorfrom concurrent.futures.process import ProcessPoolExecutordef func(value): time.sleep(1) print(value) return 123# 创建线程池pool = Threadpoolexecutor(max_workers=5)# 创建进程池pool = ProcessPoolExecutor(max_workers=5)for i in range(10): fut = pool.submit(func, i) print(fut) 8.案例: asyncio + 不支持异步的模块123456789101112131415161718192021222324import asyncioimport requestsasync def download_image(url): # 发送网络请，下数图片(遇到网络下图片的IO请，自动化切换到其他任务) print(&quot;开始下载:&quot;, url) loop = asyncio.get_event_loop() # requests模块默认不支持异步操作 future = loop.run_in_executor(None, requests.get, url) response = await future print(&quot;下载完成&quot;) # 图片保存到本地文件 file_name = url.rsplit(&#x27;-&#x27;)[-1] with open(file_name, mode=&#x27;wb&#x27;) as file_object: file_object.write(response.content)if __name__ == &#x27;__main__&#x27;: url_list = [ &quot;https: //www.autoimg.cn/newsdfs/g26/M02/35/A9/120x90_0 _autohomecar-chsEel2AX06A00H_AAFOCnzu621.jpg&quot;, &quot;https: //www.autoimg.cn/newsdfs/g30/M01/3C/E2/120x90_0_-autohomecar_chcCSV2BBICAUntfAADjJFd6800429.jpg&quot;, &quot;https://www.autoimg.cn/newsdfs/g26/M0B/3C/65/120x90_0_autohomecar-chcCP128FCMAIO83AAGq7vt0sGY193.jpg&quot; ] tasks = [ download_image(url) for url in url_list] loop = asyncio.get_event_loop() loop.run_until_complete( asyncio.wait(tasks) )","categories":[{"name":"Python基础","slug":"Python基础","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/"},{"name":"异步编程","slug":"Python基础/异步编程","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/"}],"tags":[]},{"title":"006-BeautifullSoup数据解析","slug":"爬虫/基础/006-BeautifullSoup数据解析","date":"2023-08-13T02:04:52.000Z","updated":"2024-05-31T01:46:23.000Z","comments":true,"path":"2023/08/13/爬虫/基础/006-BeautifullSoup数据解析/","link":"","permalink":"https://dbbruce.github.io/2023/08/13/%E7%88%AC%E8%99%AB/%E5%9F%BA%E7%A1%80/006-BeautifullSoup%E6%95%B0%E6%8D%AE%E8%A7%A3%E6%9E%90/","excerpt":"Beautiful Soup 是一个可以从HTML或XML文件中提取数据的Python库安装 Beautiful Soup1$ pip install beautifulsoup4","text":"Beautiful Soup 是一个可以从HTML或XML文件中提取数据的Python库安装 Beautiful Soup1$ pip install beautifulsoup4 主要的解析器 解析器 使用方法 优势 劣势 Python标准库 BeautifulSoup(markup, “html.parser”) Python的内置标准库 执行速度适中 文档容错能力强 Python 2.7.3 or 3.2.2)前 的版本中文档容错能力差 lxml HTML 解析器 BeautifulSoup(markup, “lxml”) 速度快 文档容错能力强 需要安装C语言库 lxml XML 解析器 BeautifulSoup(markup, [“lxml-xml”]) BeautifulSoup(markup, “xml”) 速度快 唯一支持XML的解析器 需要安装C语言库 html5lib BeautifulSoup(markup, “html5lib”) 最好的容错性 以浏览器的方式解析文档 生成HTML5格式的文档 速度慢 不依赖外部扩展 对象的种类Beautiful Soup将复杂HTML文档转换成一个复杂的树形结构,每个节点都是Python对象,所有对象可以归纳为4种: Tag , NavigableString , BeautifulSoup , Comment . 1234Tag 对象与XML或HTML原生文档中的tag相同NavigableString 字符串常被包含在tag内.Beautiful Soup用 NavigableString 类来包装tag中的字符串BeautifulSoup 对象表示的是一个文档的全部内容.大部分时候,可以把它当作 Tag 对象,它支持 遍历文档树 和 搜索文档树 中描述的大部分的方法.Comment 对象是一个特殊类型的 NavigableString 对象: 注释及特殊字符串 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576from bs4 import BeautifulSouphtml =&#x27;&#x27;&#x27;&lt;html&gt; &lt;head&gt; &lt;title&gt; The Dormouse&#x27;s story &lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;p class=&quot;title&quot;&gt; &lt;b&gt; The Dormouse&#x27;s story &lt;/b&gt; &lt;/p&gt; &lt;p class=&quot;story&quot;&gt; Once upon a time there were three little sisters; and their names were &lt;a class=&quot;sister&quot; href=&quot;http://example.com/elsie&quot; id=&quot;link1&quot;&gt; Elsie &lt;/a&gt; , &lt;a class=&quot;sister&quot; href=&quot;http://example.com/lacie&quot; id=&quot;link2&quot;&gt; Lacie &lt;/a&gt; and &lt;a class=&quot;sister&quot; href=&quot;http://example.com/tillie&quot; id=&quot;link2&quot;&gt; Tillie &lt;/a&gt; ; and they lived at the bottom of a well. &lt;/p&gt; &lt;p class=&quot;story&quot;&gt; ... &lt;/p&gt; &lt;/body&gt;&lt;/html&gt;&#x27;&#x27;&#x27;soup = BeautifulSoup(html, &#x27;html.parser&#x27;)# soup = BeautifulSoup(html, &#x27;lxml&#x27;)soup.title# &lt;title&gt;The Dormouse&#x27;s story&lt;/title&gt;soup.title.name# u&#x27;title&#x27;soup.title.string# u&#x27;The Dormouse&#x27;s story&#x27;soup.title.string# u&#x27;The Dormouse&#x27;s story&#x27;soup.title.parent.name# u&#x27;head&#x27;soup.p# &lt;p class=&quot;title&quot;&gt;&lt;b&gt;The Dormouse&#x27;s story&lt;/b&gt;&lt;/p&gt;soup.p[&#x27;class&#x27;]# u&#x27;title&#x27;soup.a# &lt;a class=&quot;sister&quot; href=&quot;http://example.com/elsie&quot; id=&quot;link1&quot;&gt;Elsie&lt;/a&gt;soup.find_all(&#x27;a&#x27;)# [&lt;a class=&quot;sister&quot; href=&quot;http://example.com/elsie&quot; id=&quot;link1&quot;&gt;Elsie&lt;/a&gt;,# &lt;a class=&quot;sister&quot; href=&quot;http://example.com/lacie&quot; id=&quot;link2&quot;&gt;Lacie&lt;/a&gt;,# &lt;a class=&quot;sister&quot; href=&quot;http://example.com/tillie&quot; id=&quot;link3&quot;&gt;Tillie&lt;/a&gt;]soup.find(id=&quot;link3&quot;)# &lt;a class=&quot;sister&quot; href=&quot;http://example.com/tillie&quot; id=&quot;link3&quot;&gt;Tillie&lt;/a&gt;link_tags = soup.select(&#x27;.sister&#x27;)for tag in link_tags: print(tag.text)# Elsie# Lacie# Tillie 注意文本中如果有注释123&lt;title&gt; The Dormouse&#x27;s story&lt;!--这里是注释--&gt;&lt;/title&gt; 12345print(soup.title.text) # 可以获取到内容 The Dormouse&#x27;s storyprint(&#x27;=======&#x27;,soup.title.string) # 获取不到内容======= None find ，find_all， 返回类型标签tag css选择器,返回列表，获取文本需要循环 tag对象","categories":[{"name":"爬虫类","slug":"爬虫类","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/"},{"name":"基础","slug":"爬虫类/基础","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"asyncio实现协程","slug":"python/异步编程/asyncio实现协程","date":"2023-08-12T14:25:10.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2023/08/12/python/异步编程/asyncio实现协程/","link":"","permalink":"https://dbbruce.github.io/2023/08/12/python/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/asyncio%E5%AE%9E%E7%8E%B0%E5%8D%8F%E7%A8%8B/","excerpt":"1.注意asyncio只有在python3.4及之后的版本才能使用","text":"1.注意asyncio只有在python3.4及之后的版本才能使用 2.实现123456789101112131415161718192021222324注意：遇到IO阻塞自动切换import asyncio@asyncio.coroutinedef func1() : print(1) yield from asyncio,sleep(2) # 遇到IO耗时操作，自动化切换到tasks中的其他任务 print(2) @asyncio.coroutinedef func2(): print(3) yield from asyncio.sleep(2) # 遇到IO耗时操作，自动化切换到tasks中的其他任务 print(4)tasks = [ asyncio.ensure_future( func1() ), asyncio.ensure_future( func2() )]loop = asyncio.get_event_loop()loop.run_until_complete(asyncio.wait(tasks))","categories":[{"name":"Python基础","slug":"Python基础","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/"},{"name":"异步编程","slug":"Python基础/异步编程","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/"}],"tags":[]},{"title":"005-requests与urllib3版本报错","slug":"爬虫/基础/005-requests与urllib3版本报错","date":"2023-08-12T02:04:52.000Z","updated":"2024-05-31T01:43:27.000Z","comments":true,"path":"2023/08/12/爬虫/基础/005-requests与urllib3版本报错/","link":"","permalink":"https://dbbruce.github.io/2023/08/12/%E7%88%AC%E8%99%AB/%E5%9F%BA%E7%A1%80/005-requests%E4%B8%8Eurllib3%E7%89%88%E6%9C%AC%E6%8A%A5%E9%94%99/","excerpt":"NotOpenSSLWarning: urllib3 v2 only supports OpenSSL 1.1.1+, currently the ‘ssl’ module is compiled with ‘LibreSSL 2.8.3’. 报错时环境信息：Python 3.9.6urllib3 2.2.1","text":"NotOpenSSLWarning: urllib3 v2 only supports OpenSSL 1.1.1+, currently the ‘ssl’ module is compiled with ‘LibreSSL 2.8.3’. 报错时环境信息：Python 3.9.6urllib3 2.2.1 报错分析：https://github.com/urllib3/urllib3/issues/3020urllib3&gt;&#x3D;2.0不适用于macOS#3020上的系统Python 解决方法： pip install urllib3&#x3D;&#x3D;1.26.14 123456(spider-env) dbbruce@192 MyWorldTree % pip install urllib3==1.26.14Collecting urllib3==1.26.14 Downloading urllib3-1.26.14-py2.py3-none-any.whl.metadata (47 kB) ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 47.7/47.7 kB 138.5 kB/s eta 0:00:00Downloading urllib3-1.26.14-py2.py3-none-any.whl (140 kB) ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 140.6/140.6 kB 16.7 kB/s eta 0:00:00","categories":[{"name":"爬虫类","slug":"爬虫类","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/"},{"name":"基础","slug":"爬虫类/基础","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"004-XPath页面解析和数据提取","slug":"爬虫/基础/004-XPath页面解析和数据提取","date":"2023-08-12T01:04:52.000Z","updated":"2024-05-31T01:43:27.000Z","comments":true,"path":"2023/08/12/爬虫/基础/004-XPath页面解析和数据提取/","link":"","permalink":"https://dbbruce.github.io/2023/08/12/%E7%88%AC%E8%99%AB/%E5%9F%BA%E7%A1%80/004-XPath%E9%A1%B5%E9%9D%A2%E8%A7%A3%E6%9E%90%E5%92%8C%E6%95%B0%E6%8D%AE%E6%8F%90%E5%8F%96/","excerpt":"数据类型 结构化 ： json 非结构化","text":"数据类型 结构化 ： json 非结构化 xml树形结构 XPathXPath使用路径表达式来获取XML文档中的节点或者节点集合 XPath：XML path language 一门在xml文档中查找信息的语言 chrome：XPath helperfirefox： XPath checker 这些XPath语法内容，运用到python抓取时要先转换为xml 选取节点 表达式 描述 nodename 选取节点的所有子节点 &#x2F; 从根节点选取 &#x2F;&#x2F; 从匹配选择的节点选择文档的节点，不考虑他们的位置 . 选取当前节点 .. 选取当前节点的父节点 @ 选取属性 谓语（predicates）: 查找某个特定的节点或者包含某个指定的值得节点，被嵌在方括号中 路径表达式 结果 &#x2F;bookstore&#x2F;book[1] 选取属于bookstore子元素的第一个book元素 &#x2F;bookstore&#x2F;book[last()] 选取属于bookstore子元素的最后一个book元素 &#x2F;bookstore&#x2F;book[last()-1] 选取属于bookstore子元素的倒数第二个book元素 &#x2F;bookstore&#x2F;book[position()&lt;3] 选取最前面2个属于bookstore子元素的book元素 &#x2F;&#x2F;title[@lang] 选取所有拥有名为lang的属性的title元素 &#x2F;&#x2F;title[@lang&#x3D;’eng’] 选取所有title元素，且这些元素拥有值为eng的lang元素 &#x2F;bookstore&#x2F;book[price&gt;35.00] 选取bookstore元素的book元素，且price元素的值必须大于35.00 &#x2F;bookstore&#x2F;book[price&gt;35.00]&#x2F;title 选取bookstore元素的book元素的所有title元素，且price元素的值必须大于35.00 选取未知节点 通配符 描述 * 匹配任何元素节点 @* 匹配任何属性节点 node() 匹配任何类型的节点 选取若干路径 路径表达式 描述 &#x2F;&#x2F;book&#x2F;title|&#x2F;&#x2F;book&#x2F;price 选取book元素的所有title和price元素 &#x2F;&#x2F;tilte|&#x2F;&#x2F;price 选取文档中所有的title和price元素 &#x2F;bookstore&#x2F;book&#x2F;title|&#x2F;&#x2F;price 选取属于bookstore元素的book元素所有title元素，以及文档中所有的price元素 运算符 运算符 描述 实例 返回值 | 集合 &#x2F;&#x2F;book|&#x2F;&#x2F;cd 所有book cd的节点集合 + 加 6+4 10 - 减 6-4 2 * 乘 6*4 24 div 除 6 div 3 2 &#x3D; 等于 price&#x3D;9.8 等于返回true，不等于返回false !&#x3D; 不等于 price!&#x3D;9.8 不等于返回true，等于返回false &lt; 小于 price&lt;9.8 小于返回true，不小于返回false &lt;&#x3D; 小于等于 price&lt;&#x3D;9.8 小于等于返回true，大于返回false &gt; 大于 price&gt;9.8 大于返回true，不大于返回false &gt;&#x3D; 大于等于 price&gt;&#x3D;9.8 大于等于返回true，小于返回false or 或 price&#x3D;9.80 or price&#x3D;9.90 成立返回true， 不成立返回false and 与 price&gt;9.80 and price&lt;9.90 成立返回true， 不成立返回false mode 余数 5 mod 2 成立返回true， 不成立返回false XPath 轴:轴可定义相对于当前节点的节点集。 轴名称 结果 ancestor 选取当前节点的所有先辈（父、祖父等）。 ancestor-or-self 选取当前节点的所有先辈（父、祖父等）以及当前节点本身。 attribute 选取当前节点的所有属性。 child 选取当前节点的所有子元素。 descendant 选取当前节点的所有后代元素（子、孙等）。 descendant-or-self 选取当前节点的所有后代元素（子、孙等）以及当前节点本身。 following 选取文档中当前节点的结束标签之后的所有节点。 namespace 选取当前节点的所有命名空间节点。 parent 选取当前节点的父节点。 preceding 选取文档中当前节点的开始标签之前的所有节点。 preceding-sibling 选取当前节点之前的所有同级节点。 self 选取当前节点。 位置路径表达式 位置路径可以是绝对的，也可以是相对的。绝对路径起始于正斜杠( &#x2F; )，而相对路径不会这样。在两种情况中，位置路径均包括一个或多个步，每个步均被斜杠分割：绝对位置路径： &#x2F;step&#x2F;step&#x2F;…相对位置路径： step&#x2F;step&#x2F;… 步（step）包括： 轴（axis） : 定义所选节点与当前节点之间的树关系 节点测试（node-test） : 识别某个轴内部的节点 零个或者更多谓语（predicate）: 更深入地提炼所选的节点集 步的语法：轴名称::节点测试[谓语] 例子 结果 child::book 选取所有属于当前节点的子元素的 book 节点。 attribute::lang 选取当前节点的 lang 属性。 child::* 选取当前节点的所有子元素。 attribute::* 选取当前节点的所有属性。 child::text() 选取当前节点的所有文本子节点。 child::node() 选取当前节点的所有子节点。 descendant::book 选取当前节点的所有 book 后代。 ancestor::book 选择当前节点的所有 book 先辈。 ancestor-or-self::book 选取当前节点的所有 book 先辈以及当前节点（如果此节点是 book 节点） child::*&#x2F;child::price 选取当前节点的所有 price 孙节点。 一些函数 函数 描述 例子 starts-with 顾名思义，匹配一个属性开始位置的关键字 &#x2F;&#x2F;a[starts-with(@name,’tj_lo’)] contains 匹配一个属性值中包含的字符串 &#x2F;&#x2F;a[contains(@name,’tj_lo’)] text() 匹配的是显示文本信息，此处也可以用来做定位用 &#x2F;&#x2F;a[text()&#x3D;’百度搜索’] lxml安装 lxml pip install lxml 一个例子123456789101112131415161718192021222324252627282930313233343536373839404142html_doc = &quot;&quot;&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;The Dormouse&#x27;s story&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;a href=&quot;http://example.com/tillie&quot; class=&quot;sister1&quot; id=&quot;link3&quot;&gt;Tillie0000000000000&lt;/a&gt;;&lt;p class=&quot;title&quot;&gt;&lt;b&gt;The Dormouse&#x27;s story&lt;/b&gt;&lt;/p&gt;&lt;p class=&quot;story&quot;&gt;Once upon a time there were three little sisters; and their names were&lt;a href=&quot;http://example.com/elsie&quot; class=&quot;sister1&quot; id=&quot;link1&quot;&gt;Elsie&lt;/a&gt;,&lt;a href=&quot;http://example.com/lacie&quot; class=&quot;sister2&quot; id=&quot;link2&quot;&gt;Lacie&lt;/a&gt; and&lt;a href=&quot;http://example.com/tillie&quot; class=&quot;sister3&quot; id=&quot;link3&quot;&gt;Tillie&lt;/a&gt;;&lt;a href=&quot;http://example.com/tillie&quot; class=&quot;sister31&quot; id=&quot;link3&quot;&gt;Tillie1&lt;/a&gt;;&lt;a href=&quot;http://example.com/tillie&quot; class=&quot;sister32&quot; id=&quot;link3&quot;&gt;Tillie2&lt;/a&gt;;and they lived at the bottom of a well.&lt;/p&gt;&lt;p class=&quot;story&quot;&gt;...&lt;/p&gt;&quot;&quot;&quot;from lxml import etreehtml = etree.HTML(html_doc)print(etree.tostring(html))# 获取a标签class信息result = html.xpath(&#x27;//a/@class&#x27;)print(result)# 获取a class信息是sister3的元素result2 = html.xpath(&#x27;//a[@class=&quot;sister3&quot;]&#x27;)print(result2)# 文本获取result3 = html.xpath(&#x27;//a/text()&#x27;)print(result3)# 根据文本内容获取标签result4 = html.xpath(&#x27;//a[text()=&quot;Elsie&quot;]&#x27;)print(result4)# a包含class属性包含sister3，获取多个元素result5 = html.xpath(&#x27;//a[contains(@class, &quot;sister3&quot;)]&#x27;)print(result5)# a包含文本包含Tillie，获取多个元素result6 = html.xpath(&#x27;//a[contains(text(), &quot;Tillie&quot;)]&#x27;)print(result6)","categories":[{"name":"爬虫类","slug":"爬虫类","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/"},{"name":"基础","slug":"爬虫类/基础","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"yield实现协程","slug":"python/异步编程/yield实现协程","date":"2023-08-11T15:15:10.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2023/08/11/python/异步编程/yield实现协程/","link":"","permalink":"https://dbbruce.github.io/2023/08/11/python/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/yield%E5%AE%9E%E7%8E%B0%E5%8D%8F%E7%A8%8B/","excerpt":"1.实现","text":"1.实现 12345678910111213def func1() : yield 1 yield from func2() yield 2def func2() : yield 3 yield 4 f1 = func1() for item in f1: print(item)","categories":[{"name":"Python基础","slug":"Python基础","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/"},{"name":"异步编程","slug":"Python基础/异步编程","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/"}],"tags":[]},{"title":"003-requests相关知识","slug":"爬虫/基础/003-requests相关知识","date":"2023-08-11T04:04:52.000Z","updated":"2024-05-31T01:43:27.000Z","comments":true,"path":"2023/08/11/爬虫/基础/003-requests相关知识/","link":"","permalink":"https://dbbruce.github.io/2023/08/11/%E7%88%AC%E8%99%AB/%E5%9F%BA%E7%A1%80/003-requests%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86/","excerpt":"用法方法12345678910111213r = requests.get(&#x27;https://api.github.com/events&#x27;)r = requests.post(&#x27;http://httpbin.org/post&#x27;, data = &#123;&#x27;key&#x27;:&#x27;value&#x27;&#125;)r = requests.put(&#x27;http://httpbin.org/put&#x27;, data = &#123;&#x27;key&#x27;:&#x27;value&#x27;&#125;)r = requests.delete(&#x27;http://httpbin.org/delete&#x27;)r = requests.head(&#x27;http://httpbin.org/get&#x27;) # 获得报文首部# HEAD方法和GET方法一样，知识不返回豹纹的主体部分，用于确认URI的有效性及资源更新的日期时间等。# 具体来说：1、判断类型； 2、查看响应中的状态码，看对象是否存在（响应：请求执行成功了，但无数据返回）； 3、测试资源是否被修改过# HEAD方法和GET方法的区别： GET方法有实体，HEAD方法无实体。r = requests.options(&#x27;http://httpbin.org/get&#x27;) # 询问支持的方法# OPTIONS方法用来查询针对请求URI指定资源支持的方法（客户端询问服务器可以提交哪些请求方法）","text":"用法方法12345678910111213r = requests.get(&#x27;https://api.github.com/events&#x27;)r = requests.post(&#x27;http://httpbin.org/post&#x27;, data = &#123;&#x27;key&#x27;:&#x27;value&#x27;&#125;)r = requests.put(&#x27;http://httpbin.org/put&#x27;, data = &#123;&#x27;key&#x27;:&#x27;value&#x27;&#125;)r = requests.delete(&#x27;http://httpbin.org/delete&#x27;)r = requests.head(&#x27;http://httpbin.org/get&#x27;) # 获得报文首部# HEAD方法和GET方法一样，知识不返回豹纹的主体部分，用于确认URI的有效性及资源更新的日期时间等。# 具体来说：1、判断类型； 2、查看响应中的状态码，看对象是否存在（响应：请求执行成功了，但无数据返回）； 3、测试资源是否被修改过# HEAD方法和GET方法的区别： GET方法有实体，HEAD方法无实体。r = requests.options(&#x27;http://httpbin.org/get&#x27;) # 询问支持的方法# OPTIONS方法用来查询针对请求URI指定资源支持的方法（客户端询问服务器可以提交哪些请求方法） 响应内容1r.text Requests 会自动解码来自服务器的内容。大多数 unicode 字符集都能被无缝地解码。 请求发出后，Requests 会基于 HTTP 头部对响应的编码作出有根据的推测。当你访问 r.text 之时，Requests 会使用其推测的文本编码。你可以找出 Requests 使用了什么编码，并且能够使用 r.encoding 属性来改变它： 编码123r.encoding&#x27;utf-8&#x27;r.encoding = &#x27;ISO-8859-1&#x27; 如果你改变了编码，每当你访问 r.text ，Request 都将会使用 r.encoding 的新值。你可能希望在使用特殊逻辑计算出文本的编码的情况下来修改编码。比如 HTTP 和 XML 自身可以指定编码。这样的话，你应该使用 r.content 来找到编码，然后设置 r.encoding 为相应的编码。这样就能使用正确的编码解析 r.text 了。在你需要的情况下，Requests 也可以使用定制的编码。如果你创建了自己的编码，并使用 codecs 模块进行注册，你就可以轻松地使用这个解码器名称作为 r.encoding 的值， 然后由 Requests 来为你处理编码。 二进制响应内容你也能以字节的方式访问请求响应体，对于非文本请求： 1r.content Requests 会自动为你解码 gzip 和 deflate 传输编码的响应数据。 例如，以请求返回的二进制数据创建一张图片，你可以使用如下代码： 123from PIL import Imagefrom io import BytesIOi = Image.open(BytesIO(r.content)) JSON 响应内容Requests 中也有一个内置的 JSON 解码器，助你处理 JSON 数据： 123import requestsr = requests.get(&#x27;https://api.github.com/events&#x27;)r.json() 如果 JSON 解码失败， r.json() 就会抛出一个异常。例如，响应内容是 401 (Unauthorized)，尝试访问 r.json() 将会抛出 ValueError: No JSON object could be decoded 异常。需要注意的是，成功调用 r.json() 并不意味着响应的成功。有的服务器会在失败的响应中包含一个 JSON 对象（比如 HTTP 500 的错误细节）。这种 JSON 会被解码返回。要检查请求是否成功，请使用 r.raise_for_status() 或者检查 r.status_code 是否和你的期望相同。 原始响应内容在罕见的情况下，你可能想获取来自服务器的原始套接字响应，那么你可以访问 r.raw。 如果你确实想这么干，那请你确保在初始请求中设置了 stream&#x3D;True。具体你可以这么做： 1234r = requests.get(&#x27;https://api.github.com/events&#x27;, stream=True)r.raw&gt;&lt;requests.packages.urllib3.response.HTTPResponse object at 0x101194810&gt;r.raw.read(10) 定制请求头123url = &#x27;https://api.github.com/some/endpoint&#x27;headers = &#123;&#x27;user-agent&#x27;: &#x27;my-app/0.0.1&#x27;&#125;r = requests.get(url, headers=headers) 如果在 .netrc 中设置了用户认证信息，使用 headers&#x3D; 设置的授权就不会生效。而如果设置了 auth&#x3D; 参数，.netrc 的设置就无效了。如果被重定向到别的主机，授权 header 就会被删除。代理授权 header 会被 URL 中提供的代理身份覆盖掉。在我们能判断内容长度的情况下，header 的 Content-Length 会被改写。 POST一个多部分编码(Multipart-Encoded)的文件12345678910url = &#x27;http://httpbin.org/post&#x27;files = &#123;&#x27;file&#x27;: open(&#x27;report.xls&#x27;, &#x27;rb&#x27;)&#125;r = requests.post(url, files=files)r.texturl = &#x27;http://httpbin.org/post&#x27;files = &#123;&#x27;file&#x27;: (&#x27;report.xls&#x27;, open(&#x27;report.xls&#x27;, &#x27;rb&#x27;), &#x27;application/vnd.ms-excel&#x27;, &#123;&#x27;Expires&#x27;: &#x27;0&#x27;&#125;)&#125;r = requests.post(url, files=files)r.text 响应状态码12r = requests.get(&#x27;http://httpbin.org/get&#x27;)r.status_code 响应头1r.headers Cookie123456789101112131415161718url = &#x27;http://example.com/some/cookie/setting/url&#x27;r = requests.get(url)r.cookies[&#x27;example_cookie_name&#x27;]要想发送你的cookies到服务器，可以使用 cookies 参数：url = &#x27;http://httpbin.org/cookies&#x27;cookies = dict(cookies_are=&#x27;working&#x27;)r = requests.get(url, cookies=cookies)r.textCookie 的返回对象为 RequestsCookieJar，它的行为和字典类似，但接口更为完整，适合跨域名跨路径使用。你还可以把 Cookie Jar 传到 Requests 中：jar = requests.cookies.RequestsCookieJar()jar.set(&#x27;tasty_cookie&#x27;, &#x27;yum&#x27;, domain=&#x27;httpbin.org&#x27;, path=&#x27;/cookies&#x27;)jar.set(&#x27;gross_cookie&#x27;, &#x27;blech&#x27;, domain=&#x27;httpbin.org&#x27;, path=&#x27;/elsewhere&#x27;)url = &#x27;http://httpbin.org/cookies&#x27;r = requests.get(url, cookies=jar)r.text 重定向与请求历史Response.history 是一个 Response 对象的列表，为了完成请求而创建了这些对象。这个对象列表按照从最老到最近的请求进行排序。 1234567r = requests.get(&#x27;http://github.com&#x27;)r.url&#x27;https://github.com/&#x27;r.status_code200r.history[&lt;Response [301]&gt;] 超时你可以告诉 requests 在经过以 timeout 参数设定的秒数时间之后停止等待响应。基本上所有的生产代码都应该使用这一参数。如果不使用，你的程序可能会永远失去响应： 12345requests.get(&#x27;http://github.com&#x27;, timeout=0.001)Traceback (most recent call last): File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;requests.exceptions.Timeout: HTTPConnectionPool(host=&#x27;github.com&#x27;, port=80): Request timed out. (timeout=0.001) 注意 : timeout 仅对连接过程有效，与响应体的下载无关。 timeout 并不是整个下载响应的时间限制，而是如果服务器在 timeout 秒内没有应答，将会引发一个异常（更精确地说，是在 timeout 秒内没有从基础套接字上接收到任何字节的数据时）If no timeout is specified explicitly, requests do not time out. 错误与异常遇到网络问题（如：DNS 查询失败、拒绝连接等）时，Requests 会抛出一个 ConnectionError 异常。如果 HTTP 请求返回了不成功的状态码， Response.raise_for_status() 会抛出一个 HTTPError 异常。若请求超时，则抛出一个 Timeout 异常。若请求超过了设定的最大重定向次数，则会抛出一个 TooManyRedirects 异常。所有Requests显式抛出的异常都继承自 requests.exceptions.RequestException 。 会话对象会话对象让你能够跨请求保持某些参数。它也会在同一个 Session 实例发出的所有请求之间保持 cookie， 期间使用 urllib3 的 connection pooling 功能。所以如果你向同一主机发送多个请求，底层的 TCP 连接将会被重用，从而带来显著的性能提升。 12345s = requests.Session()s.get(&#x27;http://httpbin.org/cookies/set/sessioncookie/123456789&#x27;)r = s.get(&quot;http://httpbin.org/cookies&quot;)print(r.text)# &#x27;&#123;&quot;cookies&quot;: &#123;&quot;sessioncookie&quot;: &quot;123456789&quot;&#125;&#125;&#x27; 1234567s = requests.Session()r = s.get(&#x27;http://httpbin.org/cookies&#x27;, cookies=&#123;&#x27;from-my&#x27;: &#x27;browser&#x27;&#125;)print(r.text)# &#x27;&#123;&quot;cookies&quot;: &#123;&quot;from-my&quot;: &quot;browser&quot;&#125;&#125;&#x27;r = s.get(&#x27;http://httpbin.org/cookies&#x27;)print(r.text)# &#x27;&#123;&quot;cookies&quot;: &#123;&#125;&#125;&#x27; 前后文管理器： 12with requests.Session() as s: s.get(&#x27;http://httpbin.org/cookies/set/sessioncookie/123456789&#x27;) 请求头与响应头服务器返回给我们的响应头部信息 12345678910r.headers&#123;&#x27;content-length&#x27;: &#x27;56170&#x27;, &#x27;x-content-type-options&#x27;: &#x27;nosniff&#x27;, &#x27;x-cache&#x27;:&#x27;HIT from cp1006.eqiad.wmnet, MISS from cp1010.eqiad.wmnet&#x27;, &#x27;content-encoding&#x27;:&#x27;gzip&#x27;, &#x27;age&#x27;: &#x27;3080&#x27;, &#x27;content-language&#x27;: &#x27;en&#x27;, &#x27;vary&#x27;: &#x27;Accept-Encoding,Cookie&#x27;,&#x27;server&#x27;: &#x27;Apache&#x27;, &#x27;last-modified&#x27;: &#x27;Wed, 13 Jun 2012 01:33:50 GMT&#x27;,&#x27;connection&#x27;: &#x27;close&#x27;, &#x27;cache-control&#x27;: &#x27;private, s-maxage=0, max-age=0,must-revalidate&#x27;, &#x27;date&#x27;: &#x27;Thu, 14 Jun 2012 12:59:39 GMT&#x27;, &#x27;content-type&#x27;:&#x27;text/html; charset=UTF-8&#x27;, &#x27;x-cache-lookup&#x27;: &#x27;HIT from cp1006.eqiad.wmnet:3128,MISS from cp1010.eqiad.wmnet:80&#x27;&#125; 发送到服务器的请求的头部 123r.request.headers&#123;&#x27;Accept-Encoding&#x27;: &#x27;identity, deflate, compress, gzip&#x27;,&#x27;Accept&#x27;: &#x27;*/*&#x27;, &#x27;User-Agent&#x27;: &#x27;python-requests/0.13.1&#x27;&#125; 准备的请求 （Prepared Request）当你从 API 或者会话调用中收到一个 Response 对象时，request 属性其实是使用了 PreparedRequest。有时在发送请求之前，你需要对 body 或者 header （或者别的什么东西）做一些额外处理，下面演示了一个简单的做法： 123456789101112131415161718192021from requests import Request, Sessions = Session()req = Request(&#x27;GET&#x27;, url, data=data, headers=header)prepped = req.prepare()# do something with prepped.body# do something with prepped.headersresp = s.send(prepped, stream=stream, verify=verify, proxies=proxies, cert=cert, timeout=timeout)print(resp.status_code) 由于你没有对 Request 对象做什么特殊事情，你立即准备和修改了 PreparedRequest 对象，然后把它和别的参数一起发送到 requests.* 或者 Session.*。 然而，上述代码会失去 Requests Session 对象的一些优势， 尤其 Session 级别的状态，例如 cookie 就不会被应用到你的请求上去。要获取一个带有状态的 PreparedRequest， 请用 Session.prepare_request() 取代 Request.prepare() 的调用，如下所示： 12345678910111213141516171819202122from requests import Request, Sessions = Session()req = Request(&#x27;GET&#x27;, url, data=data headers=headers)prepped = s.prepare_request(req)# do something with prepped.body# do something with prepped.headersresp = s.send(prepped, stream=stream, verify=verify, proxies=proxies, cert=cert, timeout=timeout)print(resp.status_code) SSL 证书验证Requests 可以为 HTTPS 请求验证 SSL 证书，就像 web 浏览器一样。SSL 验证默认是开启的，如果证书验证失败，Requests 会抛出 SSLError: 12requests.get(&#x27;https://requestb.in&#x27;)requests.exceptions.SSLError: hostname &#x27;requestb.in&#x27; doesn&#x27;t match either of &#x27;*.herokuapp.com&#x27;, &#x27;herokuapp.com&#x27; 在该域名上我没有设置 SSL，所以失败了。但 Github 设置了 SSL: 12requests.get(&#x27;https://github.com&#x27;, verify=True)&lt;Response [200]&gt; 你可以为 verify 传入 CA_BUNDLE 文件的路径，或者包含可信任 CA 证书文件的文件夹路径： 1requests.get(&#x27;https://github.com&#x27;, verify=&#x27;/path/to/certfile&#x27;) 或者将其保持在会话中： 12s = requests.Session()s.verify = &#x27;/path/to/certfile&#x27; 注解如果 verify 设为文件夹路径，文件夹必须通过 OpenSSL 提供的 c_rehash 工具处理。 你还可以通过 REQUESTS_CA_BUNDLE 环境变量定义可信任 CA 列表。 如果你将 verify 设置为 False，Requests 也能忽略对 SSL 证书的验证。 12 requests.get(&#x27;https://kennethreitz.org&#x27;, verify=False)&lt;Response [200]&gt; 默认情况下， verify 是设置为 True 的。选项 verify 仅应用于主机证书。对于私有证书，你也可以传递一个 CA_BUNDLE 文件的路径给 verify。你也可以设置 # REQUEST_CA_BUNDLE 环境变量。 客户端证书你也可以指定一个本地证书用作客户端证书，可以是单个文件（包含密钥和证书）或一个包含两个文件路径的元组： 12 requests.get(&#x27;https://kennethreitz.org&#x27;, cert=(&#x27;/path/client.cert&#x27;, &#x27;/path/client.key&#x27;))&lt;Response [200]&gt; 或者保持在会话中： 12s = requests.Session()s.cert = &#x27;/path/client.cert&#x27; 如果你指定了一个错误路径或一个无效的证书: 12 requests.get(&#x27;https://kennethreitz.org&#x27;, cert=&#x27;/wrong_path/client.pem&#x27;)SSLError: [Errno 336265225] _ssl.c:347: error:140B0009:SSL routines:SSL_CTX_use_PrivateKey_file:PEM lib 警告 ：本地证书的私有 key 必须是解密状态。目前，Requests 不支持使用加密的 k 响应体内容工作流默认情况下，当你进行网络请求后，响应体会立即被下载。你可以通过 stream 参数覆盖这个行为，推迟下载响应体直到访问 Response.content 属性： 12345678910111213tarball_url = &#x27;https://github.com/kennethreitz/requests/tarball/master&#x27;r = requests.get(tarball_url, stream=True)此时仅有响应头被下载下来了，连接保持打开状态，因此允许我们根据条件获取内容：if int(r.headers[&#x27;content-length&#x27;]) &lt; TOO_LONG: content = r.content ...你可以进一步使用 Response.iter_content 和 Response.iter_lines 方法来控制工作流，或者以 Response.raw 从底层 urllib3 的 urllib3.HTTPResponse &lt;urllib3.response.HTTPResponse 读取未解码的响应体。如果你在请求中把 stream 设为 True，Requests 无法将连接释放回连接池，除非你 消耗了所有的数据，或者调用了 Response.close。 这样会带来连接效率低下的问题。如果你发现你在使用 stream=True 的同时还在部分读取请求的 body（或者完全没有读取 body），那么你就应该考虑使用 with 语句发送请求，这样可以保证请求一定会被关闭：with requests.get(&#x27;http://httpbin.org/get&#x27;, stream=True) as r: # 在此处理响应。 流式上传Requests支持流式上传，这允许你发送大的数据流或文件而无需先把它们读入内存。要使用流式上传，仅需为你的请求体提供一个类文件对象即可： 12with open(&#x27;massive-body&#x27;) as f: requests.post(&#x27;http://some.url/streamed&#x27;, data=f) 警告 ：我们强烈建议你用二进制模式（binary mode）打开文件。这是因为 requests 可能会为你提供 header 中的 Content-Length，在这种情况下该值会被设为文件的字节数。如果你用文本模式打开文件，就可能碰到错误。 块编码请求对于出去和进来的请求，Requests 也支持分块传输编码。要发送一个块编码的请求，仅需为你的请求体提供一个生成器（或任意没有具体长度的迭代器）： 对于分块的编码请求，我们最好使用 Response.iter_content() 对其数据进行迭代。在理想情况下，你的 request 会设置 stream&#x3D;True，这样你就可以通过调用 iter_content 并将分块大小参数设为 None，从而进行分块的迭代。如果你要设置分块的最大体积，你可以把分块大小参数设为任意整数。 12345def gen(): yield &#x27;hi&#x27; yield &#x27;there&#x27;requests.post(&#x27;http://some.url/chunked&#x27;, data=gen()) POST 多个分块编码的文件你可以在一个请求中发送多个文件。例如，假设你要上传多个图像文件到一个 HTML 表单，使用一个多文件 field 叫做 “images”: 1&lt;input type=&quot;file&quot; name=&quot;images&quot; multiple=&quot;true&quot; required=&quot;true&quot;/&gt; 要实现，只要把文件设到一个元组的列表中，其中元组结构为 (form_field_name, file_info): 123456789101112 url = &#x27;http://httpbin.org/post&#x27; multiple_files = [ (&#x27;images&#x27;, (&#x27;foo.png&#x27;, open(&#x27;foo.png&#x27;, &#x27;rb&#x27;), &#x27;image/png&#x27;)), (&#x27;images&#x27;, (&#x27;bar.png&#x27;, open(&#x27;bar.png&#x27;, &#x27;rb&#x27;), &#x27;image/png&#x27;))] r = requests.post(url, files=multiple_files) r.text&#123; ... &#x27;files&#x27;: &#123;&#x27;images&#x27;: &#x27;data:image/png;base64,iVBORw ....&#x27;&#125; &#x27;Content-Type&#x27;: &#x27;multipart/form-data; boundary=3131623adb2043caaeb5538cc7aa0b3a&#x27;, ...&#125; 警告 ：我们强烈建议你用二进制模式（binary mode）打开文件。这是因为 requests 可能会为你提供 header 中的 Content-Length，在这种情况下该值会被设为文件的字节数。如果你用文本模式打开文件，就可能碰到错误。 事件挂钩Requests有一个钩子系统，你可以用来操控部分请求过程，或信号事件处理。 可用的钩子: response:从一个请求产生的响应你可以通过传递一个 {hook_name: callback_function} 字典给 hooks 请求参数为每个请求分配一个钩子函数： 1hooks=dict(response=print_url) callback_function 会接受一个数据块作为它的第一个参数。 12def print_url(r, *args, **kwargs): print(r.url) 若执行你的回调函数期间发生错误，系统会给出一个警告。 若回调函数返回一个值，默认以该值替换传进来的数据。若函数未返回任何东西，也没有什么其他的影响。 我们来在运行期间打印一些请求方法的参数： 123 requests.get(&#x27;http://httpbin.org&#x27;, hooks=dict(response=print_url))http://httpbin.org&lt;Response [200]&gt; 自定义身份验证Requests 允许你使用自己指定的身份验证机制。 任何传递给请求方法的 auth 参数的可调用对象，在请求发出之前都有机会修改请求。 自定义的身份验证机制是作为 requests.auth.AuthBase 的子类来实现的，也非常容易定义。Requests 在 requests.auth 中提供了两种常见的的身份验证方案： HTTPBasicAuth 和 HTTPDigestAuth 。 假设我们有一个web服务，仅在 X-Pizza 头被设置为一个密码值的情况下才会有响应。虽然这不太可能，但就以它为例好了 123456789101112from requests.auth import AuthBaseclass PizzaAuth(AuthBase): &quot;&quot;&quot;Attaches HTTP Pizza Authentication to the given Request object.&quot;&quot;&quot; def __init__(self, username): # setup any auth-related data here self.username = username def __call__(self, r): # modify and return the request r.headers[&#x27;X-Pizza&#x27;] = self.username return r 然后就可以使用我们的PizzaAuth来进行网络请求: 12 requests.get(&#x27;http://pizzabin.org/admin&#x27;, auth=PizzaAuth(&#x27;kenneth&#x27;))&lt;Response [200]&gt; 流式请求使用 Response.iter_lines() 你可以很方便地对流式 API （例如 Twitter 的流式 API ） 进行迭代。简单地设置 stream 为 True 便可以使用 iter_lines 对相应进行迭代： 1234567891011import jsonimport requestsr = requests.get(&#x27;http://httpbin.org/stream/20&#x27;, stream=True)for line in r.iter_lines(): # filter out keep-alive new lines if line: decoded_line = line.decode(&#x27;utf-8&#x27;) print(json.loads(decoded_line)) 当使用 decode_unicode&#x3D;True 在 Response.iter_lines() 或 Response.iter_content() 中时，你需要提供一个回退编码方式，以防服务器没有提供默认回退编码，从而导致错误： 12345678r = requests.get(&#x27;http://httpbin.org/stream/20&#x27;, stream=True)if r.encoding is None: r.encoding = &#x27;utf-8&#x27;for line in r.iter_lines(decode_unicode=True): if line: print(json.loads(line)) 警告 iter_lines 不保证重进入时的安全性。多次调用该方法 会导致部分收到的数据丢失。如果你要在多处调用它，就应该使用生成的迭代器对象: lines &#x3D; r.iter_lines()保存第一行以供后面使用，或者直接跳过 1234first_line = next(lines)for line in lines: print(line) 代理如果需要使用代理，你可以通过为任意请求方法提供 proxies 参数来配置单个请求: 123456789import requestsproxies = &#123; &quot;http&quot;: &quot;http://10.10.1.10:3128&quot;, &quot;https&quot;: &quot;http://10.10.1.10:1080&quot;,&#125;requests.get(&quot;http://example.org&quot;, proxies=proxies) 你也可以通过环境变量 HTTP_PROXY 和 HTTPS_PROXY 来配置代理。 123456$ export HTTP_PROXY=&quot;http://10.10.1.10:3128&quot;$ export HTTPS_PROXY=&quot;http://10.10.1.10:1080&quot;$ python import requests requests.get(&quot;http://example.org&quot;) 若你的代理需要使用HTTP Basic Auth，可以使用 http://user:password@host/ 语法： 1234proxies = &#123; &quot;http&quot;: &quot;http://user:pass@10.10.1.10:3128/&quot;,&#125; 要为某个特定的连接方式或者主机设置代理，使用 scheme:&#x2F;&#x2F;hostname 作为 key， 它会针对指定的主机和连接方式进行匹配。 1proxies = &#123;&#x27;http://10.20.1.128&#x27;: &#x27;http://10.10.1.10:5323&#x27;&#125; 注意，代理 URL 必须包含连接方式。 SOCKS除了基本的 HTTP 代理，Request 还支持 SOCKS 协议的代理。这是一个可选功能，若要使用， 你需要安装第三方库。 你可以用 pip 获取依赖: HTTP动词Requests 提供了几乎所有HTTP动词的功能：GET、OPTIONS、HEAD、POST、PUT、PATCH、DELETE 定制动词有时候你会碰到一些服务器，处于某些原因，它们允许或者要求用户使用上述 HTTP 动词之外的定制动词。比如说 WEBDAV 服务器会要求你使用 MKCOL 方法。别担心，Requests 一样可以搞定它们。你可以使用内建的 .request 方法，例如： 123 r = requests.request(&#x27;MKCOL&#x27;, url, data=data) r.status_code200 # Assuming your call was correct 这样你就可以使用服务器要求的任意方法动词了。 响应头链接字段许多 HTTP API 都有响应头链接字段的特性，它们使得 API 能够更好地自我描述和自我显露。 1234 url = &#x27;https://api.github.com/users/kennethreitz/repos?page=1&amp;per_page=10&#x27; r = requests.head(url=url) r.headers[&#x27;link&#x27;]&#x27;&lt;https://api.github.com/users/kennethreitz/repos?page=2&amp;per_page=10&gt;; rel=&quot;next&quot;, &lt;https://api.github.com/users/kennethreitz/repos?page=6&amp;per_page=10&gt;; rel=&quot;last&quot;&#x27; Requests 会自动解析这些响应头链接字段，并使得它们非常易于使用: 12345 r.links[&quot;next&quot;]&#123;&#x27;url&#x27;: &#x27;https://api.github.com/users/kennethreitz/repos?page=2&amp;per_page=10&#x27;, &#x27;rel&#x27;: &#x27;next&#x27;&#125; r.links[&quot;last&quot;]&#123;&#x27;url&#x27;: &#x27;https://api.github.com/users/kennethreitz/repos?page=7&amp;per_page=10&#x27;, &#x27;rel&#x27;: &#x27;last&#x27;&#125; 传输适配器传输适配器提供了一个机制，让你可以为 HTTP 服务定义交互方法。尤其是它允许你应用服务前的配置。 Requests 自带了一个传输适配器，也就是 HTTPAdapter。 这个适配器使用了强大的 urllib3，为 Requests 提供了默认的 HTTP 和 HTTPS 交互。每当 Session 被初始化，就会有适配器附着在 Session 上，其中一个供 HTTP 使用，另一个供 HTTPS 使用。 Request 允许用户创建和使用他们自己的传输适配器，实现他们需要的特殊功能。创建好以后，传输适配器可以被加载到一个会话对象上，附带着一个说明，告诉会话适配器应该应用在哪个 web 服务上。 12s = requests.Session()s.mount(&#x27;http://www.github.com&#x27;, MyAdapter()) 这个 mount 调用会注册一个传输适配器的特定实例到一个前缀上面。加载以后，任何使用该会话的 HTTP 请求，只要其 URL 是以给定的前缀开头，该传输适配器就会被使用到。 传输适配器的众多实现细节不在本文档的覆盖范围内，不过你可以看看接下来这个简单的 SSL 用例。更多的用法，你也许该考虑为 BaseAdapter 创建子类 阻塞和非阻塞使用默认的传输适配器，Requests 不提供任何形式的非阻塞 IO。 Response.content 属性会阻塞，直到整个响应下载完成。如果你需要更多精细控制，该库的数据流功能（见 流式请求） 允许你每次接受少量的一部分响应，不过这些调用依然是阻塞式的。 如果你对于阻塞式 IO 有所顾虑，还有很多项目可以供你使用，它们结合了 Requests 和 Python 的某个异步框架。典型的优秀例子是 grequests 和 requests-futures。 Header 排序在某些特殊情况下你也许需要按照次序来提供 header，如果你向 headers 关键字参数传入一个 OrderedDict，就可以向提供一个带排序的 header。然而，Requests 使用的默认 header 的次序会被优先选择，这意味着如果你在 headers 关键字参数中覆盖了默认 header，和关键字参数中别的 header 相比，它们也许看上去会是次序错误的。 如果这个对你来说是个问题，那么用户应该考虑在 Session 对象上面设置默认 header，只要将 Session 设为一个定制的 OrderedDict 即可。这样就会让它成为优选的次序。 超时（timeout）如果你制订了一个单一的值作为 timeout，如下所示： 1r = requests.get(&#x27;https://github.com&#x27;, timeout=5) 这一 timeout 值将会用作 connect 和 read 二者的 timeout。如果要分别制定，就传入一个元组： 1r = requests.get(&#x27;https://github.com&#x27;, timeout=(3.05, 27)) 如果远端服务器很慢，你可以让 Request 永远等待，传入一个 None 作为 timeout 值，然后就冲咖啡去吧。 1r = requests.get(&#x27;https://github.com&#x27;, timeout=None) 身份认证基本身份认证许多要求身份认证的web服务都接受 HTTP Basic Auth。这是最简单的一种身份认证，并且 Requests 对这种认证方式的支持是直接开箱即可用。 以 HTTP Basic Auth 发送请求非常简单： 123 from requests.auth import HTTPBasicAuth requests.get(&#x27;https://api.github.com/user&#x27;, auth=HTTPBasicAuth(&#x27;user&#x27;, &#x27;pass&#x27;))&lt;Response [200]&gt; 事实上，HTTP Basic Auth 如此常见，Requests 就提供了一种简写的使用方式： 12 requests.get(&#x27;https://api.github.com/user&#x27;, auth=(&#x27;user&#x27;, &#x27;pass&#x27;))&lt;Response [200]&gt; 像这样在一个元组中提供认证信息与前一个 HTTPBasicAuth 例子是完全相同的。 netrc 认证如果认证方法没有收到 auth 参数，Requests 将试图从用户的 netrc 文件中获取 URL 的 hostname 需要的认证身份。The netrc file overrides raw HTTP authentication headers set with headers&#x3D;. 如果找到了 hostname 对应的身份，就会以 HTTP Basic Auth 的形式发送请求。 摘要式身份认证另一种非常流行的 HTTP 身份认证形式是摘要式身份认证，Requests 对它的支持也是开箱即可用的： 1234 from requests.auth import HTTPDigestAuth url = &#x27;http://httpbin.org/digest-auth/auth/user/pass&#x27; requests.get(url, auth=HTTPDigestAuth(&#x27;user&#x27;, &#x27;pass&#x27;))&lt;Response [200]&gt; OAuth 1 认证Oauth 是一种常见的 Web API 认证方式。 requests-oauthlib 库可以让 Requests 用户简单地创建 OAuth 认证的请求： 1234567 import requests from requests_oauthlib import OAuth1 url = &#x27;https://api.twitter.com/1.1/account/verify_credentials.json&#x27; auth = OAuth1(&#x27;YOUR_APP_KEY&#x27;, &#x27;YOUR_APP_SECRET&#x27;,... &#x27;USER_OAUTH_TOKEN&#x27;, &#x27;USER_OAUTH_TOKEN_SECRET&#x27;) requests.get(url, auth=auth)&lt;Response [200]&gt; 新的身份认证形式如果你找不到所需要的身份认证形式的一个良好实现，你也可以自己实现它。Requests 非常易于添加你自己的身份认证形式。 要想自己实现，就从 AuthBase 继承一个子类，并实现 call() 方法： 123456789 import requests class MyAuth(requests.auth.AuthBase):... def __call__(self, r):... # Implement my authentication... return r... url = &#x27;http://httpbin.org/get&#x27; requests.get(url, auth=MyAuth())&lt;Response [200]&gt; 当一个身份认证模块被附加到一个请求上，在设置 request 期间就会调用该模块。因此 call 方法必须完成使得身份认证生效的所有事情。一些身份认证形式会额外地添加钩子来提供进一步的功能。 json content 与 text 区别json() 必须加括号text 代表返回的数据是文字content 代表返回的数据是多媒体，图片，音乐，视频","categories":[{"name":"爬虫类","slug":"爬虫类","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/"},{"name":"基础","slug":"爬虫类/基础","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"100个网络基础知识，看完成半个网络高手","slug":"网络/100 个网络基础知识，看完成半个网络高手","date":"2023-08-11T03:14:52.000Z","updated":"2024-11-04T03:36:13.000Z","comments":true,"path":"2023/08/11/网络/100 个网络基础知识，看完成半个网络高手/","link":"","permalink":"https://dbbruce.github.io/2023/08/11/%E7%BD%91%E7%BB%9C/100%20%E4%B8%AA%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%EF%BC%8C%E7%9C%8B%E5%AE%8C%E6%88%90%E5%8D%8A%E4%B8%AA%E7%BD%91%E7%BB%9C%E9%AB%98%E6%89%8B/","excerpt":"","text":"1、什么是链接?链接是指两个设备之间的连接。它包括用于一个设备能够与另一个设备通信的电缆类型和协议。 2、OSI 参考模型的层次是什么?有 7 个 OSI 层：物理层，数据链路层，网络层，传输层，会话层，表示层和应用层。 3、什么是骨干网?骨干网络是集中的基础设施，旨在将不同的路由和数据分发到各种网络。它还处理带宽管理和各种通道。 4、什么是 LAN?LAN 是局域网的缩写。它是指计算机与位于小物理位置的其他网络设备之间的连接。 5、什么是节点?节点是指连接发生的点。它可以是作为网络一部分的计算机或设备。为了形成网络连接，需要两个或更多个节点。 6、什么是路由器?路由器可以连接两个或更多网段。这些是在其路由表中存储信息的智能网络设备，例如路径，跳数等。有了这个信息，他们就可以确定数据传输的最佳路径。路由器在 OSI 网络层运行。 7、什么是点对点链接?它是指网络上两台计算机之间的直接连接。除了将电缆连接到两台计算机的 NIC卡之外，点对点连接不需要任何其他网络设备。 8、什么是匿名 FTP?匿名 FTP 是授予用户访问公共服务器中的文件的一种方式。允许访问这些服务器中的数据的用户不需要识别自己，而是以匿名访客身份登录。 9、什么是子网掩码?子网掩码与 IP 地址组合，以识别两个部分：扩展网络地址和主机地址。像 IP 地址一样，子网掩码由 32 位组成。 10、UTP 电缆允许的最大长度是多少?UTP 电缆的单段具有 90 到 100 米的允许长度。这种限制可以通过使用中继器和开关来克服 11、什么是数据封装?数据封装是在通过网络传输信息之前将信息分解成更小的可管理块的过程。在这个过程中，源和目标地址与奇偶校验一起附加到标题中。 12、描述网络拓扑网络拓扑是指计算机网络的布局。它显示了设备和电缆的物理布局，以及它们如何连接到彼此。 13、什么是 VPN? VPN 意味着虚拟专用网络，这种技术允许通过网络(如 Internet、创建安全通道。例如，VPN 允许您建立到远程服务器的安全拨号连接。 14、什么是 NAT？NAT 是网络地址转换。这是一种协议，为公共网络上的多台计算机提供一种方式来共享到 Internet 的单一连接。 15、OSI 参考模型下网络层的工作是什么?网络层负责数据路由，分组交换和网络拥塞控制。路由器在此层下运行。 16、网络拓扑如何影响您在建立网络时的决策?网络拓扑决定了互连设备必须使用什么媒介。它还作为适用于设置的材料，连接器和终端的基础。 17、什么是 RIP?RIP，路由信息协议的简称由路由器用于将数据从一个网络发送到另一个网络。它通过将其路由表广播到网络中的所有其他路由器来有效地管理路由数据。它以跳数为单位确定网络距离。 18、什么是不同的方式来保护计算机网络?有几种方法可以做到这一点。在所有计算机上安装可靠和更新的防病毒程序。确保防火墙的设置和配置正确。用户认证也将有很大的帮助。所有这些组合将构成一个高度安全的网络。 19、什么是 NIC? NIC 是网络接口卡(网卡、的缩写。这是连接到 PC 以连接到网络沈北。每个 NIC都有自己的 MAC 地址，用于标识网络上的 PC。 20、什么是 WAN?WAN 代表广域网。它是地理上分散的计算机和设备的互连。它连接位于不同地区和国家&#x2F;地区的网络。 21、OSI 物理层的重要性是什么?物理层进行从数据位到电信号的转换，反之亦然。这是网络设备和电缆类型的考虑和设置。 22、TCP&#x2F;IP 下有多少层?有四层：网络层，互联网层，传输层和应用层。 23、什么是代理服务器，它们如何保护计算机网络?代理服务器主要防止外部用户识别内部网络的 IP 地址。不知道正确的 IP 地址，甚至无法识别网络的物理位置。代理服务器可以使外部用户几乎看不到网络。 24、OSI 会话层的功能是什么?该层为网络上的两个设备提供协议和方法，通过举行会话来相互通信。这包括设置会话，管理会话期间的信息交换以及终止会话时的解除过程。 25、实施容错系统的重要性是什么?有限吗?容错系统确保持续的数据可用性。这是通过消除单点故障来实现的。但是，在某些情况下，这种类型的系统将无法保护数据，例如意外删除。 26、10Base-T 是什么意思?10 是指数据传输速率，在这种情况下是 10Mbps。“Base”是指基带。T 表示双绞线，这是用于该网络的电缆。 27、什么是私有 IP 地址?专用 IP 地址被分配用于内部网。这些地址用于内部网络，不能在外部公共网络上路由。这些确保内部网络之间不存在任何冲突，同时私有 IP 地址的范围同样可重复使用于多个内部网络，因为它们不会“看到”彼此。 28、什么是 NOS?NOS 或网络操作系统是专门的软件，其主要任务是向计算机提供网络连接，以便能够与其他计算机和连接的设备进行通信。 29、什么是 DoS?DoS 或拒绝服务攻击是试图阻止用户访问互联网或任何其他网络服务。这种攻击可能有不同的形式，由一群永久者组成。这样做的一个常见方法是使系统服务器过载，使其无法再处理合法流量，并将被强制重置。 30、什么是 OSI，它在电脑网络中扮演什么角色? OSI(开放系统互连、作为数据通信的参考模型。它由 7 层组成，每层定义了网络设备如何相互连接和通信的特定方面。一层可以处理所使用的物理介质，而另一层则指示如何通过网络实际传输数据。 31、电缆被屏蔽并具有双绞线的目的是什么?其主要目的是防止串扰。串扰是电磁干扰或噪声，可能影响通过电缆传输的数据。 32、地址共享的优点是什么?通过使用地址转换而不是路由，地址共享提供了固有的安全性优势。这是因为互联网上的主机只能看到提供地址转换的计算机上的外部接口的公共 IP 地址，而不是内部网络上的私有 IP 地址。 33、什么是 MAC 地址?MAC 或媒介访问控制，可以唯一地标识网络上的设备。它也被称为物理地址或以太网地址。MAC 地址由 6 个字节组成。 34、在 OSI 参考模型方面，TCP&#x2F;IP 应用层的等同层或多层是什么?TCP&#x2F;IP 应用层实际上在 OSI 模型上具有三个对等体：会话层，表示层和应用层。 35、如何识别给定 IP 地址的 IP 类?通过查看任何给定 IP 地址的第一个八位字节，您可以识别它是 A 类，B 类还是 C类。如果第一个八位字节以 0 位开头，则该地址为 Class A.如果以位 10 开头，则该地址为 B 类地址。如果从 110 开始，那么它是 C 类网络。 36、OSPF 的主要目的是什么?OSPF 或开放最短路径优先，是使用路由表确定数据交换的最佳路径的链路状态路由协议。 37、什么是防火墙?防火墙用于保护内部网络免受外部攻击。这些外部威胁可能是黑客谁想要窃取数据或计算机病毒，可以立即消除数据。它还可以防止来自外部网络的其他用户访问专用网络。 38、描述星形拓扑星形拓扑由连接到节点的中央集线器组成。这是最简单的设置和维护之一。 39、什么是网关?网关提供两个或多个网段之间的连接。它通常是运行网关软件并提供翻译服务的计算机。该翻译是允许不同系统在网络上通信的关键。 40、星型拓扑的缺点是什么?星形拓扑的一个主要缺点是，一旦中央集线器或交换机被损坏，整个网络就变得不可用了。 41、什么是 SLIP?SLIP 或串行线路接口协议实际上是在 UNIX 早期开发的旧协议。这是用于远程访问的协议之一。 42、给出一些私有网络地址的例子。10.0.0.0，子网掩码为 255.0.0.0172.16.0.0，子网掩码为 255.240.0.0 43、什么是 tracert?Tracert 是一个 Windows 实用程序，可用于跟踪从路由器到目标网络的数据采集的路由。它还显示了在整个传输路由期间采用的跳数。 44、网络管理员的作用是什么?网络管理员有许多责任，可以总结为 3 个关键功能：安装网络，配置网络设置以及网络的维护&#x2F;故障排除。 45、描述对等网络的一个缺点。当您正在访问由网络上的某个工作站共享的资源时，该工作站的性能会降低。 46、什么是混合网络?混合网络是利用客户端 - 服务器和对等体系结构的网络设置。 47、什么是 DHCP?DHCP 是动态主机配置协议的缩写。其主要任务是自动为网络上的设备分配 IP 地址。它首先检查任何设备尚未占用的下一个可用地址，然后将其分配给网络设备。 48、ARP 的主要工作是什么?ARP 或地址解析协议的主要任务是将已知的 IP 地址映射到 MAC 层地址。 49、什么是 TCP&#x2F;IP? TCP&#x2F;IP 是传输控制协议&#x2F;互联网协议的缩写。这是一组协议层，旨在在不同类型的计算机网络(也称为异构网络、上进行数据交换。 50、如何使用路由器管理网络?路由器内置了控制台，可让您配置不同的设置，如安全和数据记录。您可以为计算机分配限制，例如允许访问的资源，或者可以浏览互联网的某一天的特定时间。您甚至可以对整个网络中看不到的网站施加限制。 51、当您希望在不同平台(如 UNIX 系统和 Windows 服务器之间、传输文件时，可以应用什么协议? 使用 FTP(文件传输协议、在这些不同的服务器之间进行文件传输。这是可能的，因为 FTP 是平台无关的。 52、默认网关的使用是什么?默认网关提供了本地网络连接到外部网络的方法。用于连接外部网络的默认网关通常是外部路由器端口的地址。 53、保护网络的一种方法是使用密码。什么可以被认为是好的密码?良好的密码不仅由字母组成，还包括字母和数字的组合。结合大小写字母的密码比使用所有大写字母或全部小写字母的密码有利。密码必须不能被黑客很容易猜到，比如日期，姓名，收藏夹等等。 54、UTP 电缆的正确终止率是多少?非屏蔽双绞线网线的正常终止是 100 欧姆。 55、什么是 netstat?Netstat 是一个命令行实用程序。它提供有关连接当前 TCP&#x2F;IP 设置的有用信息。 56、C 类网络中的网络 ID 数量是多少?对于 C 类网络，可用的网络 ID 位数为 21。可能的网络 ID 数目为 2，提高到 21或 2,097,152。每个网络 ID 的主机 ID 数量为 2，增加到 8 减去 2，或 254。 57、使用长于规定长度的电缆时会发生什么?电缆太长会导致信号丢失。这意味着数据传输和接收将受到影响，因为信号长度下降。 58、什么常见的软件问题可能导致网络缺陷?软件相关问题可以是以下任何一种或其组合：客户端服务器问题；应用程序冲突；配置错误；协议不匹配；安全问题；用户政策和权利问题 59、什么是 ICMP?ICMP 是 Internet 控制消息协议。它为 TCP&#x2F;IP 协议栈内的协议提供消息传递和通信。这也是管理由 PING 等网络工具使用的错误信息的协议。 60、什么是 Ping? Ping 是一个实用程序，允许您检查网络上的网络设备之间的连接。您可以使用其IP 地址或设备名称(如计算机名称、ping 设备。 61、什么是点对点(P2P、?对等是不在服务器上回复的网络。该网络上的所有 PC 都是单独的工作站。 62、什么是 DNS?DNS 是域名系统。该网络服务的主要功能是为 TCP&#x2F;IP 地址解析提供主机名。 63、光纤与其他介质有什么优势?光纤的一个主要优点是不太容易受到电气干扰。它还支持更高的带宽，意味着可以发送和接收更多的数据。长距离信号降级也非常小。 64、集线器和交换机有什么区别?集线器充当多端口中继器。然而，随着越来越多的设备连接到它，它将无法有效地管理通过它的流量。交换机提供了一个更好的替代方案，可以提高性能，特别是在所有端口上预期有高流量时。 65、Windows RRAS 服务支持的不同网络协议是什么?支持三种主要的网络协议：NetBEUI，TCP&#x2F;IP 和 IPX。 66、A，B 和 C 类网络中的最大网络和主机是什么?对于 A 类，有 126 个可能的网络和 16,777,214 个主机对于 B 类，有 16,384 个可能的网络和 65,534 个主机对于 C 类，有 2,097,152 个可能的网络和 254 个主机 67、直通电缆的标准颜色顺序是什么?橙色&#x2F;白色，橙色，绿色&#x2F;白色，蓝色，蓝色&#x2F;白色，绿色，棕色&#x2F;白色，棕色。 68、什么协议落在 TCP&#x2F;IP 协议栈的应用层之下?以下是 TCP&#x2F;IP 应用层协议：FTP，TFTP，Telnet 和 SMTP。 69、您需要连接两台电脑进行文件共享。是否可以这样做，而不使用集线器或路由器?是的，您可以使用一根电缆将两台计算机连接在一起。在这种情况下可以使用交叉型电缆。在这种设置中，一条电缆的数据传输引脚连接到另一条电缆的数据接收引脚，反之亦然。 70、什么是 ipconfig?Ipconfig 是一个常用于识别网络上计算机的地址信息的实用程序。它可以显示物理地址以及 IP 地址。 71、直通和交叉电缆有什么区别?直通电缆用于将计算机连接到交换机，集线器或路由器。交叉电缆用于将两个类似设备连接在一起，如 PC 到 PC 或集线器到集线器。 72、什么是客户端&#x2F;服务器?客户端&#x2F;服务器是一种类型的网络，其中一个或多个计算机充当服务器。服务器提供集中的资源库，如打印机和文件。客户端是指访问服务器的工作站。 73、描述网络网络是指用于数据通信的计算机和外围设备之间的互连。可以使用有线电缆或通过无线链路进行网络连接。 74、将 NIC 卡从一台 PC 移动到另一台 PC 时，MAC 地址是否也被转移?是的，那是因为 MAC 地址是硬连线到 NIC 电路，而不是 PC。这也意味着当 NIC卡被另一个替换时，PC 可以具有不同的 MAC 地址。 75、解释聚类支持群集支持是指网络操作系统在容错组中连接多台服务器的能力。这样做的主要目的是在一台服务器发生故障的情况下，集群中的下一个服务器将继续进行所有处理。 76、在包含两个服务器和二十个工作站的网络中，安装防病毒程序的最佳位置是哪里?必须在所有服务器和工作站上安装防病毒程序，以确保保护。这是因为个人用户可以访问任何工作站，并在插入可移动硬盘驱动器或闪存驱动器时引入计算机病毒。 77、描述以太网以太网是当今使用的流行网络技术之一。它是在 20 世纪 70 年代初开发的，并且基于 IEEE 中规定的规范。以太网在局域网中使用。 78、实现环形拓扑有什么缺点?如果网络上的一个工作站发生故障，可能会导致整个网络丢失。另一个缺点是，当需要在网络的特定部分进行调整和重新配置时，整个网络也必须被暂时关闭。 79、CSMA&#x2F;CD 和 CSMA&#x2F;CA 有什么区别?CSMA&#x2F;CD 或碰撞检测，每当碰撞发生时重新发送数据帧。CSMA&#x2F;CA 或碰撞避免，将首先在数据传输之前广播意图发送。 80、什么是 SMTP?SMTP 是简单邮件传输协议的缩写。该协议处理所有内部邮件，并在 TCP&#x2F;IP 协议栈上提供必要的邮件传递服务。 81、什么是组播路由?组播路由是一种有针对性的广播形式，将消息发送到所选择的用户组，而不是将其发送到子网上的所有用户。 82、加密在网络上的重要性是什么?加密是将信息转换成用户不可读的代码的过程。然后使用秘密密钥或密码将其翻译或解密回其正常可读格式。加密有助于确保中途截获的信息仍然不可读，因为用户必须具有正确的密码或密钥。 83、如何安排和显示 IP 地址?IP 地址显示为一系列由周期或点分隔的四位十进制数字。这种安排的另一个术语是点分十进制格式。一个例子是 192.168.101.2 84、解释认证的重要性认证是在用户登录网络之前验证用户凭据的过程。它通常使用用户名和密码进行。这提供了限制来自网络上的有害入侵者的访问的安全手段。 85、隧道模式是什么意思?这是一种数据交换模式，其中两个通信计算机本身不使用 IPSec。相反，将 LAN连接到中转网络的网关创建了一个使用 IPSec 协议来保护通过它的所有通信的虚拟隧道。 86、建立 WAN 链路涉及的不同技术有哪些?模拟连接 - 使用常规电话线;数字连接 - 使用数字电话线;交换连接 - 使用发送方和接收方之间的多组链接来移动数据。 87、网格拓扑的一个优点是什么?在一个链接失败的情况下，总会有另一个链接可用。网状拓扑实际上是最容错的网络拓扑之一。 88、在排除计算机网络问题时，可能会发生什么常见的硬件相关问题?大部分网络由硬件组成。这些领域的问题可能包括硬盘故障，NIC 损坏甚至硬件启动。不正确的硬件配置也是其中一个疑难问题。 89、可以做什么来修复信号衰减问题?处理这种问题的常见方法是使用中继器和集线器，因为它将有助于重新生成信号，从而防止信号丢失。检查电缆是否正确终止也是必须的。 90、动态主机配置协议如何协助网络管理?网络管理员不必访问每台客户端计算机来配置静态 IP 地址，而是可以应用动态主机配置协议来创建称为可以动态分配给客户端的范围的 IP 地址池。 91、解释网络概念的概况?配置文件是为每个用户设置的配置设置。例如，可以创建将用户置于组中的配置文件。 92、什么是 Sneakernet? Sneakernet 被认为是最早的联网形式，其中使用可移动介质(如磁盘，磁带、物理传输数据。 93、IEEE 在计算机网络中的作用是什么?IEEE 或电气和电子工程师学会是由电气和电子设备标准发布和管理的工程师组成的组织。这包括网络设备，网络接口，cablings 和连接器。 94、TCP&#x2F;IP Internet 层下有哪些协议?该层管理的协议有 4 种。这些是 ICMP，IGMP，IP 和 ARP。 95、谈到网络，什么是权限?权限是指在网络上执行特定操作的授权许可。网络上的每个用户可以分配个人权限，具体取决于该用户必须允许的内容。 96、建立 VLAN 的一个基本要求是什么?需要一个 VLAN，因为在交换机级别只有一个广播域，这意味着每当新用户连接时，该信息都会传播到整个网络。交换机上的 VLAN 有助于在交换机级别创建单独的广播域。它用于安全目的。 97、什么是 IPv6?IPv6 或 Internet 协议版本 6 被开发以替代 IPv4。目前，IPv4 正在用于控制互联网流量，但 IPv4 已经饱和。IPv6 能够克服这个限制。 98、什么是 RSA 算法?RSA 是 Rivest-Shamir-Adleman 算法的缩写。它是目前最常用的公钥加密算法。 99、什么是网格拓扑?网格拓扑是一种设置，其中每个设备都直接连接到网络上的每个其他设备。因此，它要求每个设备具有至少两个网络连接。 100、100Base-FX 网络的最大段长度是多少?使用 100Base-FX 的网段的最大允许长度为 412 米。整个网络的最大长度为 5 公里。","categories":[{"name":"网络","slug":"网络","permalink":"https://dbbruce.github.io/categories/%E7%BD%91%E7%BB%9C/"},{"name":"异常","slug":"网络/异常","permalink":"https://dbbruce.github.io/categories/%E7%BD%91%E7%BB%9C/%E5%BC%82%E5%B8%B8/"}],"tags":[]},{"title":"协程","slug":"python/异步编程/协程","date":"2023-08-10T14:10:22.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2023/08/10/python/异步编程/协程/","link":"","permalink":"https://dbbruce.github.io/2023/08/10/python/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/%E5%8D%8F%E7%A8%8B/","excerpt":"1.协程协程不是系统级线程，很多时候协程被称为“轻量级线程”、“微线程”、“纤程(fiber)”等。简单来说可以认为协程是线程里不同的函数，这些函数之间可以相互快速切换","text":"1.协程协程不是系统级线程，很多时候协程被称为“轻量级线程”、“微线程”、“纤程(fiber)”等。简单来说可以认为协程是线程里不同的函数，这些函数之间可以相互快速切换 协程(Coroutine)，也可以被称为微线程，是一种用户态内的上下文切换技术。简而言之，其实就是通过一个线程实现代码块相互切换执行。例如: 2.实现协程有这么几种方法。 greenlet，早期横块。 yield关键字。。 asyncio装饰器 (py3.4)。 async、await关键字 (py3.5) 3.协程的意义在一个线程中如果遇到IO等待时间，线程不会傻傻等，利用空闲的时候再去干点其他事情","categories":[{"name":"Python基础","slug":"Python基础","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/"},{"name":"异步编程","slug":"Python基础/异步编程","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/"}],"tags":[]},{"title":"tempfile --- 生成临时文件和目录","slug":"python/基础/tempfile --- 生成临时文件和目录","date":"2023-08-10T07:14:52.000Z","updated":"2024-05-24T07:22:56.000Z","comments":true,"path":"2023/08/10/python/基础/tempfile --- 生成临时文件和目录/","link":"","permalink":"https://dbbruce.github.io/2023/08/10/python/%E5%9F%BA%E7%A1%80/tempfile%20---%20%E7%94%9F%E6%88%90%E4%B8%B4%E6%97%B6%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%AE%E5%BD%95/","excerpt":"tempfile介绍在实际的项目处理中，往往我们并不需要创建文件，仅仅用于中转而已。这个时候在系统中频繁的创建中转文件，删除中转文件，不仅浪费系统的资源，而且容易被破坏或者篡改，这个时候用临时文件反而更好。而Python给我们提供了临时文件操作库：tempfile","text":"tempfile介绍在实际的项目处理中，往往我们并不需要创建文件，仅仅用于中转而已。这个时候在系统中频繁的创建中转文件，删除中转文件，不仅浪费系统的资源，而且容易被破坏或者篡改，这个时候用临时文件反而更好。而Python给我们提供了临时文件操作库：tempfile 创建临时文件（TemporaryFile） 其中，mode表示以什么方式创建并打开临时文件，这里w+表示可以读写文件，t是以文本模式打开文件。默认写完内容后，文件句柄在末尾，要重新读取文件，需要使用seek回转重定位。 1234567import tempfilewith tempfile.TemporaryFile(mode=&#x27;w+t&#x27;) as temp: temp.write(&quot;My name is Li Yuanjing&quot;) temp.seek(0) print(temp.read()) print(temp.name) 当然，我们创建临时文件是需要使用的，也就是在程序中，我们需要给它一个名字，方便我们进行操作。我们将上面代码变更一下： 1234567891011import tempfileimport pathlibwith tempfile.TemporaryFile(mode=&#x27;w+t&#x27;) as temp: temp.write(&quot;My name is Li Yuanjing&quot;) temp.seek(0) print(temp.read()) f = pathlib.Path(temp.name)print(tempfile.gettempdir())print(f.name)f.exists() 这里，我们用f变量标记了文件，后面操作的时候，可以使用f进行操作。当我们调用f.exists()函数时，默认临时文件会被删除。 临时目录（TemporaryDirectory）12345678910111213141516import tempfileimport pathlibwith tempfile.TemporaryDirectory() as temp: f = pathlib.Path(temp) print(f) a_file = f / &#x27;a.txt&#x27; a_file.write_text(&quot;111111111111&quot;) b_file = f / &#x27;b.txt&#x27; b_file.write_text(&quot;222222222222&quot;) c_file = f / &#x27;c.txt&#x27; c_file.write_text(&quot;333333333333&quot;) print(a_file.read_text()) print(b_file.read_text()) print(c_file.read_text())f.exists() 假脱机文件如果我们处理的临时文件的数据较少，其实使用SpooledTemporaryFile可能更高效，因为它使用一个io.BytesIO或io.StringIO缓冲区在内存中保存内容，直到数据超过一定的大小，才写入磁盘，然后用TemporaryFile替代缓冲区。 12345678import tempfilewith tempfile.SpooledTemporaryFile(max_size=1000, mode=&#x27;w+t&#x27;, encoding=&#x27;utf-8&#x27;) as temp: print(temp) temp.write(&#x27;15648497987987987&#x27;) temp.seek(0) print(temp.read()) 这里的max_size就是决定文件小于这个值写入缓冲区，大于这个值写入TemporaryFile临时文件。当然，我们可以强制将缓冲区写入临时文件，可以调用rollover()或fileno()函数 12345678import tempfilewith tempfile.SpooledTemporaryFile(max_size=1000, mode=&#x27;w+t&#x27;, encoding=&#x27;utf-8&#x27;) as temp: print(temp) temp.write(&#x27;15648497987987987&#x27;) temp.seek(0) temp.rollover() print(temp.read()) 预测名（NamedTemporaryFile）从上面的代码，我们可以看到，临时文件单独创建的方式，文件名是随机生成的，并不是由程序员指定的，但有时候还需要在名字中包含一些可预测的部分，以便查找和检查文件来进行调用。这个时候，指定文件名往往更好。我们指定文件名规律用NamedTemporaryFile()函数 1234567import tempfileimport pathlibtmp_file = tempfile.NamedTemporaryFile(prefix=&#x27;image_&#x27;, suffix=&#x27;_png&#x27;)print(tmp_file.name)# /var/folders/zq/gqbcprv959b5l6m3crj5dl440000gn/T/image_gmo8w044_png 可以看出来，我们的文件名等于：prefix+random+suffix。当然，其实该函数还有一个dir参数，可以指定目录。完整的文件名等于：dir+prefix+random+suffix。 gettempdir()与gettempprefix()在创建临时文件的时候，如果我们没有指定dir，那么该临时文件的路径会跟随平台和设置变化，也就是不确定的位置。这个时候，我们可能需要获取文件的路径以及其他参数，通过gettempdir()与gettempprefix()可以做到，具体代码如下： 1234567891011import tempfileprint(tempfile.gettempdir())print(tempfile.gettempdirb())print(tempfile.gettempprefix())print(tempfile.gettempprefixb())# /var/folders/zq/gqbcprv959b5l6m3crj5dl440000gn/T# b&#x27;/var/folders/zq/gqbcprv959b5l6m3crj5dl440000gn/T&#x27;# tmp# b&#x27;tmp&#x27;","categories":[{"name":"Python基础","slug":"Python基础","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/"},{"name":"基础","slug":"Python基础/基础","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"002-HTTP头部信息分析","slug":"爬虫/基础/002-HTTP头部信息分析","date":"2023-08-10T04:04:52.000Z","updated":"2024-05-31T01:43:27.000Z","comments":true,"path":"2023/08/10/爬虫/基础/002-HTTP头部信息分析/","link":"","permalink":"https://dbbruce.github.io/2023/08/10/%E7%88%AC%E8%99%AB/%E5%9F%BA%E7%A1%80/002-HTTP%E5%A4%B4%E9%83%A8%E4%BF%A1%E6%81%AF%E5%88%86%E6%9E%90/","excerpt":"常识HTTP得头域包括通用头(Genaral headers)，请求头()，响应头()和实体(entity header)头四个部分，每个头域都由一个域名，冒号和域值三部分组成。","text":"常识HTTP得头域包括通用头(Genaral headers)，请求头()，响应头()和实体(entity header)头四个部分，每个头域都由一个域名，冒号和域值三部分组成。 通用头部：指的是可以应用于请求和响应中，但是不能应用于消息内容自身的HTTP首部，取决于应用的上下文环境，通用首部可以是响应头部或者请求头部，但是不可以是实体头部。最常见的通用首部包括：Date，Cache-Control，Connection 请求头部：是请求报文特有的，并且和请求主体无关。比如客户端希望接收到什么类型的数据，像Accept头部。 并非所有出现在请求中的HTTP首部都属于请求头，例如在POST请求中经常出现的Content-Length实际上是一个代表请求主体大小的entity header，当然这也可以叫做请求头。 响应头部：被用于http响应中并且和响应消息主体无关的那一类HTTP header。详细的在这像Age，Location和Server都属于响应头，他们都用于描述响应。 并非所有出现在响应中的http header都属于响应头，例如Content- Length就是一个代表响应体消息大小的entity header，当然也是可以叫他响应头的。 实体头部：用来描述消息体内容。实体报头既可以用于请求也可以用于响应中，如Content-Length，Content-Language，Content-Encoding之类的报头都是实体报头。 尽管实体报头既不是请求也不是响应报头，但是它经常出现在请求头或响应头中，所以还是把他们包含在一个概念里。 通用头部 名称 作用 Cache-Control 控制缓存的行为； 详情 请求：no-cache（不要缓存的实体，要求现在从WEB服务器去取） max-age：（只接受 Age 值小于 max-age 值，并且没有过期的对象）max-stale：（可以接受过去的对象，但是过期时间必须小于max-stale 值） min-fresh：（接受其新鲜生命期大于其当前 Age 跟 min-fresh 值之和的缓存对象） 响应：public(可以用 Cached 内容回应任何用户)private（只能用缓存内容回应先前请求该内容的那个用户）no-cache（可以缓存，但是只有在跟WEB服务器验证了其有效后，才能返回给客户端） max-age：（本响应包含的对象的过期时间）ALL: no-store（不允许缓存） Connection 决定当前的事务完成后，是否会关闭网络连接； 详情 请求：close（告诉WEB服务器或者代理服务器，在完成本次请求的响应后，断开连接，不要等待本次连接的后续请求了）。 keepalive（告诉WEB服务器或者代理服务器，在完成本次请求的 响应后，保持连接，等待本次连接的后续请求）。 响应：close（连接已经关闭）。 keepalive（连接保持着，在等待本次连接的后续请求）。 Date 创建报文的日期时间； Keep-Alive 用来设置超时时长和最大请求数；如果浏览器请求保持连接，则该头部表明希望 WEB 服务器保持连接多长时间（秒）。 例如：Keep-Alive：300 Via 代理服务器的相关信息；列出从客户端到 OCS 或者相反方向的响应经过了哪些代理服务器，他们用什么协议（和版本）发送的请求。当客户端请求到达第一个代理服务器时，该服务器会在自己发出的请求里面 添加 Via 头部，并填上自己的相关信息当下一个代理服务器收到第一个代理服务器的请求时，会在自己发出的请求里面复制前一个代理服务器的请求的Via头部，并把自己的相关信息加到后面，以此类推，当 OCS 收到最后一个代理服务器的请求时，检查 Via 头部，就知道该请求所经过的路由。例如：Via：1.0 236-81.D07071953.sina.com.cn:80 (squid&#x2F;2.6.STABLE13) Warning 错误通知； Trailer 允许发送方在分块发送的消息后面添加额外的元信息； Transfer-Encoding 指定报文主体的传输编码方式；WEB 服务器表明自己对本响应消息体（不是消息体里面的对象）做了怎样的编码，比如是否分块（chunked）。例如：Transfer-Encoding: chunked Upgrade 升级为其他协议； 请求头部 响应头部 实体头部 End-to-end头部和Hop-by-hop头部http首部字段将定义成缓存代理和非缓存代理的行为，分成2种类型端到端首部（End-to-end Header）此类别中的首部会转发给请求&#x2F;响应对应的最终接受目标，而且必须保存在由缓存生成的响应中，另外规定它必须被转发。逐跳首部（Hop-by-hop Header）此类别中的首部只对单次转发有效，会因通过缓存或代理而不再转发；http1.1和之后的版本，如要使用该首部，需提供Connection首部字段。 下面列举下http&#x2F;1.1中的逐跳首部字段，除了这8个，其他所有字段都属于端到端首部。Connection:Keep-AliveProxy-AuthenticateProxy-AuthorizationTrailerTETransfer-EncodingUpgrade http状态码 状态 详情 1xx 信息，表示临时响应并需要请求者继续执行操作 2xx 成功，操作被成功接收并处理 3xx 表示要完成请求，需要进一步操作。 通常，这些状态代码用来重定向 4xx 客户端错误，请求包含语法错误或无法完成请求 5xx 这些状态代码表示服务器在尝试处理请求时发生内部错误。 这些错误可能是服务器本身的错误，而不是请求出错 1xx100：（继续） 请求者应当继续提出请求。 服务器返回此代码表示已收到请求的第一部分，正在等待其余部分。 101：（切换协议） 请求者已要求服务器切换协议，服务器已确认并准备切换。 102：由WebDAV（RFC 2518）扩展的状态码，代表处理将被继续执行。 2XX200：（成功） 服务器已成功处理了请求。 通常，这表示服务器提供了请求的网页。 201：（已创建） 请求成功并且服务器创建了新的资源。 202：（已接受） 服务器已接受请求，但尚未处理。 203：（非授权信息） 服务器已成功处理了请求，但返回的信息可能来自另一来源。 204：（无内容） 服务器成功处理了请求，但没有返回任何内容。 205：（重置内容） 服务器成功处理了请求，但没有返回任何内容。 206：（部分内容） 服务器成功处理了部分 GET 请求。 208：（已经报告）一个DAV的绑定成员被前一个请求枚举，并且没有被再一次包括。 226：（IM Used）服务器已经满足了请求所要的资源，并且响应是一个或者多个实例操作应用于当前实例的结果。 3XX300：（多种选择） 针对请求，服务器可执行多种操作。 服务器可根据请求者 (user agent) 选择一项操作，或提供操作列表供请求者选择。 301：（永久移动） 请求的网页已永久移动到新位置。 服务器返回此响应（对 GET 或 HEAD 请求的响应）时，会自动将请求者转到新位置。 302：（临时移动） 服务器目前从不同位置的网页响应请求，但请求者应继续使用原有位置来进行以后的请求。 303：（查看其他位置） 请求者应当对不同的位置使用单独的 GET 请求来检索响应时，服务器返回此代码。 304：（未修改） 自从上次请求后，请求的网页未修改过。 服务器返回此响应时，不会返回网页内容。 305：（使用代理） 请求者只能使用代理访问请求的网页。 如果服务器返回此响应，还表示请求者应使用代理。 307：（临时重定向） 服务器目前从不同位置的网页响应请求，但请求者应继续使用原有位置来进行以后的请求。 308：（永久转移）这个请求和以后的请求都应该被另一个URI地址重新发送。307、308和302、301有相同的表现，但是不允许HTTP方法改变。例如，请求表单到一个永久转移的资源将会继续顺利地执行。 4XX400:（错误请求) 服务器不理解请求的语法。 401：(未授权) 请求要求身份验证。 对于需要登录的网页，服务器可能返回此响应。 402：该状态码是为了将来可能的需求而预留的。 403：（禁止) 服务器拒绝请求。 404：（未找到) 服务器找不到请求的网页。 405：（方法禁用) 禁用请求中指定的方法。 406：（不接受) 无法使用请求的内容特性响应请求的网页。 407：（需要代理授权) 此状态代码与 401（未授权）类似，但指定请求者应当授权使用代理。 408：（请求超时) 服务器等候请求时发生超时。 409：（冲突) 服务器在完成请求时发生冲突。 服务器必须在响应中包含有关冲突的信息。 410：（已删除) 如果请求的资源已永久删除，服务器就会返回此响应。 411：（需要有效长度) 服务器不接受不含有效内容长度标头字段的请求。 412：（未满足前提条件) 服务器未满足请求者在请求中设置的其中一个前提条件。 413：（请求实体过大) 服务器无法处理请求，因为请求实体过大，超出服务器的处理能力。 414：（请求的 URI 过长) 请求的 URI（通常为网址）过长，服务器无法处理。 415：（不支持的媒体类型) 请求的格式不受请求页面的支持。 416：（请求范围不符合要求) 如果页面无法提供请求的范围，则服务器会返回此状态代码。 417：（未满足期望值) 服务器未满足”期望”请求标头字段的要求。 418：（我是一个茶壶）这个代码是在1998年作为传统的IETF April Fools‘ jokes被定义的在RFC2324，超文本咖啡罐控制协议，但是并没有被实际的HTTP服务器实现。RFC指定了这个代码应该是由茶罐返回给速溶咖啡。 419：（认证超时）并不是HTTP标注的一部分，419认证超时表示以前的有效证明已经失效了。同时也被用于401未认证的替代选择为了从其它被拒绝访问的已认证客户端中指定服务器的资源。 420：（方法失效）不是HTTP的标准，但是被Spring定义在HTTP状态类中当方法失时使用。这个状态码已经不推荐在Spring中使用。 420：（提高你的耐心）也不是HTTP标准的一部分，但是被版本1的Twitter搜索和趋势APi返回当客户端的速率被限制的时候。其它的服务提供商可能会使用429太多的请求响应码来代替。 421：从当前客户端所在的IP地址到服务器的连接数超过了服务器许可的最大范围。通常，这里的IP地址指的是从服务器上看到的客户端地址（比如用户的网关或者代理服务器地址）。在这种情况下，连接数的计算可能涉及到不止一个终端用户。 422：请求格式正确，但是由于含有语义错误，无法响应。（RFC 4918 WebDAV）423 Locked 当前资源被锁定。（RFC 4918 WebDAV） 424：由于之前的某个请求发生的错误，导致当前请求失败，例如 PROPPATCH。（RFC 4918 WebDAV） 425：在WebDav Advanced Collections 草案中定义，但是未出现在《WebDAV 顺序集协议》（RFC 3658）中。 426：客户端应当切换到TLS&#x2F;1.0。（RFC 2817） 428：(需要前置条件)原始服务器需要有条件的请求。当客户端GET一个资源的状态的时候，同时又PUT回给服务器，与此同时第三方修改状态到服务器上的时候，为了避免丢失更新的问题发生将会导致冲突。 429：（过多请求）用户已经发送了太多的请求在指定的时间里。用于限制速率。 431：（请求头部字段太大）服务器由于一个单独的请求头部字段或者是全部的字段太大而不愿意处理请求。 440：（登陆超时（微软））一个微软的扩展，意味着你的会话已经超时。 444：（无响应）被使用在Nginx的日志中表明服务器没有返回信息给客户端并且关闭了连接（在威慑恶意软件的时候比较有用）。 449：（重试（微软））一个微软的扩展。请求应该在执行适当的动作之后被重试。 450：（被Windows家长控制阻塞（微软））一个微软的扩展。这个错误是当Windows家长控制打开并且阻塞指定网页的访问的时候被指定。 451：（由于法律原因而无效（因特网草稿））被定义在因特网草稿“一个新的HTTP状态码用于法律限制的资源”。被用于当资源的访问由于法律原因被禁止的时候。例如检查制度或者是政府强制要求禁止访问。一个例子是1953年dystopian的小说Fahrenheit 451就是一个非法的资源。 451：（重定向（微软））被用在Exchange ActiveSync中如果一个更有效的服务器能够被使用或者是服务器不能访问用户的邮箱。客户端会假定重新执行HTTP自动发现协议去寻找更适合的服务器。 494：（请求头太大（Nginx））Nginx内置代码和431类似，但是是被更早地引入在版本0.9.4（在2011年1月21日）。 495：（证书错误（Nginx））Nginx内置的代码，当使用SSL客户端证书的时候错误会出现为了在日志错误中区分它和4XX和一个错误页面的重定向。。 496：（没有证书（Nginx））Nginx内置的代码，当客户端不能提供证书在日志中分辨4XX和一个错误页面的重定向。 497：（HTTP到HTTPS（Nginx））Nginx内置的代码，被用于原始的HTTP的请求发送给HTTPS端口去分辨4XX在日志中和一个错误页面的重定向。 498：（令牌超时或失效（Esri））由ArcGIS for Server返回。这个代码意味着令牌的超时或者是失效。 499：（客户端关闭请求（Nginx））被用在Nginx日志去表明一个连接已经被客户端关闭当服务器仍然正在处理它的请求，是的服务器无法返货状态码。 499：（需要令牌（Esri））由ArcGIS for Server返回。意味着需要一个令牌（如果没有令牌被提交）。 5XX500：（服务器内部错误） 服务器遇到错误，无法完成请求。 501：（尚未实施） 服务器不具备完成请求的功能。 例如，服务器无法识别请求方法时可能会返回此代码。 502：（错误网关） 服务器作为网关或代理，从上游服务器收到无效响应。 503：（服务不可用） 服务器目前无法使用（由于超载或停机维护）。 通常，这只是暂时状态。 504：（网关超时） 服务器作为网关或代理，但是没有及时从上游服务器收到请求。 505：（HTTP 版本不受支持） 服务器不支持请求中所用的 HTTP 协议版本。 506：由《透明内容协商协议》（RFC 2295）扩展，代表服务器存在内部配置错误：被请求的协商变元资源被配置为在透明内容协商中使用自己，因此在一个协商处理中不是一个合适的重点。 507：服务器无法存储完成请求所必须的内容。这个状况被认为是临时的。WebDAV (RFC 4918) 509：服务器达到带宽限制。这不是一个官方的状态码，但是仍被广泛使用。 510：获取资源所需要的策略并没有没满足。（RFC 2774）。 508：（发现环路）服务器发现了一个无限的循环档处理请求的时候。 511：（需要网络授权）客户端需要授权去火的网络的访问权限。一般用于代理交互中被用来进行网络的访问控制。 520：（未知错误）这个状态码也没有被指定在任何RFC中，并且只会被一些服务器返回，例如微软的Azure和CloudFlare服务器:”520错误。本质上是一个捕获全部的响应当原始服务器返回一些未知的或者一些不能被忍受或者被解释的(协议违反或者空响应)”。 598：（网络读取超时异常(未知)）这个状态码也没有在任何RFC中指定，但是被用在微软的HTTP代理中去标注一个网络读取超时在一个客户端之前的代理的后面。 599：（网络连接超时异常(未知)）这个状态码也没有在任何RFC中指定，但是被用在微软的HTTP代理中去标注一个网络连接超时在一个客户端之前的代理的后面。","categories":[{"name":"爬虫类","slug":"爬虫类","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/"},{"name":"基础","slug":"爬虫类/基础","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"客户端访问服务器异常","slug":"网络/客户端访问服务器异常","date":"2023-08-10T03:14:52.000Z","updated":"2023-12-05T03:07:40.000Z","comments":true,"path":"2023/08/10/网络/客户端访问服务器异常/","link":"","permalink":"https://dbbruce.github.io/2023/08/10/%E7%BD%91%E7%BB%9C/%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AE%BF%E9%97%AE%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%82%E5%B8%B8/","excerpt":"","text":"1、DNS：将网址转为IP 互联网中每个设备都是通过IP地址通信的，访问百度，必须知道百度的IP;DNS把网址转为IP 2、端口映射：把内网服务器ip，映射为公网的ip，让用户可以通过公网访问服务器 nat server protocol tcp global 64.1.1.3 8601 inside 172.16.60.60 80 3、源地址转换 让内部用户上网用的，我是内网主机，想上百度，抖音，源地址转换；我本机地址是192.168.1.10， 我访问百度是，我的源地址就是64.1.1.1 4、目标地址转换 外网的用户想访问我内部的服务器，目标地址转换；别人访问我，目标是64.1.1.3，到了我的路由， 把目标ip转为172.16.60.60, 送到我的内网服务器上 5、路由表：用来指导网络设备，如何转发数据包 命令：dis ip routing-table 172.16.60.60 （RD 10.10.11.1 是下一跳） 下一跳：就是数据包的下一站地址 配置下一跳：发给172.16.XXX.XXX的包，都会转发到 10.10.11.1 6、回包 7、nslookup:测试域名解析正常情况异常情况 8、telnet 192.168.3.3 8806 9、排查思路","categories":[{"name":"网络","slug":"网络","permalink":"https://dbbruce.github.io/categories/%E7%BD%91%E7%BB%9C/"},{"name":"异常","slug":"网络/异常","permalink":"https://dbbruce.github.io/categories/%E7%BD%91%E7%BB%9C/%E5%BC%82%E5%B8%B8/"}],"tags":[]},{"title":"protobuf包","slug":"python/包/protobuf包","date":"2023-08-10T03:14:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2023/08/10/python/包/protobuf包/","link":"","permalink":"https://dbbruce.github.io/2023/08/10/python/%E5%8C%85/protobuf%E5%8C%85/","excerpt":"1.protobuf简介Protobuf是Protocol Buffers的简称，它是Google公司开发的一种数据描述语言，是一种轻便高效的结构化数据存储格式，可以用于结构化数据串行化，或者说序列化 。它很适合做数据存储或 RPC 数据交换格式。可用于通讯协议、数据存储等领域的语言无关、平台无关、可扩展的序列化结构数据格式。目前提供了 C++、Java、Python 三种语言的 API。","text":"1.protobuf简介Protobuf是Protocol Buffers的简称，它是Google公司开发的一种数据描述语言，是一种轻便高效的结构化数据存储格式，可以用于结构化数据串行化，或者说序列化 。它很适合做数据存储或 RPC 数据交换格式。可用于通讯协议、数据存储等领域的语言无关、平台无关、可扩展的序列化结构数据格式。目前提供了 C++、Java、Python 三种语言的 API。 2.安装protobuf123456789101112131415$ brew install protobuf@3If you need to have protobuf@3 first in your PATH, run: echo &#x27;export PATH=&quot;/usr/local/opt/protobuf@3/bin:$PATH&quot;&#x27; &gt;&gt; ~/.zshrcFor compilers to find protobuf@3 you may need to set: export LDFLAGS=&quot;-L/usr/local/opt/protobuf@3/lib&quot; export CPPFLAGS=&quot;-I/usr/local/opt/protobuf@3/include&quot;For pkg-config to find protobuf@3 you may need to set: export PKG_CONFIG_PATH=&quot;/usr/local/opt/protobuf@3/lib/pkgconfig&quot;添加环境变量：export PATH=&quot;/usr/local/opt/protobuf@3/bin:$PATH&quot; 重启下终端生效 测试 12% protoc --versionlibprotoc 3.20.3 3.protoc pycharm插件 4.安装python protobuf包12345678% pip install protobuf% pip listPackage Version---------- -------pip 23.2.1protobuf 4.24.0setuptools 68.0.0wheel 0.41.0 5.将protobuf文件转为Python版本1protoc --python_out=. v1.proto","categories":[{"name":"Python基础","slug":"Python基础","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/"},{"name":"包方法","slug":"Python基础/包方法","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/%E5%8C%85%E6%96%B9%E6%B3%95/"}],"tags":[]},{"title":"__call__方法","slug":"python/基础/python __call__基础知识","date":"2023-08-10T03:14:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2023/08/10/python/基础/python __call__基础知识/","link":"","permalink":"https://dbbruce.github.io/2023/08/10/python/%E5%9F%BA%E7%A1%80/python%20__call__%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/","excerpt":"Python 类中一个非常特殊的实例方法，即 call()。该方法的功能类似于在类中重载 () 运算符，使得类实例对象可以像调用普通函数那样，以“对象名()”的形式使用。","text":"Python 类中一个非常特殊的实例方法，即 call()。该方法的功能类似于在类中重载 () 运算符，使得类实例对象可以像调用普通函数那样，以“对象名()”的形式使用。 123456class CLanguage: # 定义__call__方法 def __call__(self,name,add): print(&quot;调用__call__()方法&quot;,name,add)clangs = CLanguage()clangs(&quot;C语言中文网&quot;,&quot;http://c.biancheng.net&quot;)","categories":[{"name":"Python基础","slug":"Python基础","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/"},{"name":"基础","slug":"Python基础/基础","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"搜狗-UA伪装","slug":"爬虫/反爬/搜狗-UA伪装","date":"2023-08-10T03:14:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2023/08/10/爬虫/反爬/搜狗-UA伪装/","link":"","permalink":"https://dbbruce.github.io/2023/08/10/%E7%88%AC%E8%99%AB/%E5%8F%8D%E7%88%AC/%E6%90%9C%E7%8B%97-UA%E4%BC%AA%E8%A3%85/","excerpt":"1.何为反爬虫机制反爬虫机制是指网站为了限制爬虫工具的使用，而采取的各种技术手段。这些技术手段可以有效防止爬虫获取网站数据，维护网站的正常运营和安全。","text":"1.何为反爬虫机制反爬虫机制是指网站为了限制爬虫工具的使用，而采取的各种技术手段。这些技术手段可以有效防止爬虫获取网站数据，维护网站的正常运营和安全。 2.UA（User-Agent）是什么用户代理（User-Agent）是指HTTP请求中的一个标头，它告诉服务器发送请求的客户端的操作系统、浏览器以及版本号等信息。在爬虫中，如果不设置UA，那么服务器就无法判断请求是否来自合法的浏览器，因此很容易被识别成爬虫并进行限制。 3.设置UA在Python爬虫中，我们可以通过在请求的headers中设置User-Agent来伪装成浏览器访问网站，从而避免被反爬虫机制限制。 4.UA反爬的核心12headers = &#123;&#x27;User-Agent&#x27;: &#x27;&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.99 Safari/537.36&#x27;&#125; 5.代码12345678910111213141516171819202122import requestsif __name__ == &#x27;__main__&#x27;: url = &#x27;https://www.sogou.com/web?query=张晓波&#x27; kw = input(&#x27;enter a word:&#x27;) param = &#123; &#x27;query&#x27;: kw &#125; # UA伪装 header = &#123; &#x27;User-Agent&#x27;: &#x27;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0 Safari/537.36&#x27; &#125; response = requests.get(url=url,params=param, headers=header) # response = requests.get(url=url,params=param) page_text = response.text filename = kw+&#x27;.html&#x27; with open(filename, &#x27;w&#x27;, encoding=&#x27;utf-8&#x27;) as fp: fp.write(page_text) print(filename,&#x27;保存成功！！！&#x27;)","categories":[{"name":"爬虫类","slug":"爬虫类","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/"},{"name":"反爬","slug":"爬虫类/反爬","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E5%8F%8D%E7%88%AC/"}],"tags":[]},{"title":"爬虫-接口验证方法","slug":"爬虫/反爬/爬虫-接口验证方法","date":"2023-08-10T03:14:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2023/08/10/爬虫/反爬/爬虫-接口验证方法/","link":"","permalink":"https://dbbruce.github.io/2023/08/10/%E7%88%AC%E8%99%AB/%E5%8F%8D%E7%88%AC/%E7%88%AC%E8%99%AB-%E6%8E%A5%E5%8F%A3%E9%AA%8C%E8%AF%81%E6%96%B9%E6%B3%95/","excerpt":"1、接口验证，也叫xhr方法2、步骤1.打开chrome，打开network，找到接口","text":"1、接口验证，也叫xhr方法2、步骤1.打开chrome，打开network，找到接口 2.打开源代码，右侧找到 XHR&#x2F;提取断点，点击 “+”号，粘贴接口 3.点击分页，就会进入debug 4.点击花括号，格式化代码 5.颜色深的这条，就是代码所在位置 6.右侧作用域中，可以看到debug调试信息 7.点击单步执行 8.执行到js函数结束完整url&#x3D;baseurl+url 9.js函数查看，停留在函数上，点击下方显示的js文件，跳转到函数 10.点击执行，清除断点","categories":[{"name":"爬虫类","slug":"爬虫类","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/"},{"name":"反爬","slug":"爬虫类/反爬","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E5%8F%8D%E7%88%AC/"}],"tags":[]},{"title":"策略与防盗链-Referrer","slug":"爬虫/反爬/策略与防盗链-Referrer","date":"2023-08-10T03:14:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2023/08/10/爬虫/反爬/策略与防盗链-Referrer/","link":"","permalink":"https://dbbruce.github.io/2023/08/10/%E7%88%AC%E8%99%AB/%E5%8F%8D%E7%88%AC/%E7%AD%96%E7%95%A5%E4%B8%8E%E9%98%B2%E7%9B%97%E9%93%BE-Referrer/","excerpt":"1.Referrer策略Referrer策略用于控制浏览器在何种情况下发送referrer信息。该策略可以保护用户的隐私，但也可以使得目前绝大多数站点的防盗链机制失效。","text":"1.Referrer策略Referrer策略用于控制浏览器在何种情况下发送referrer信息。该策略可以保护用户的隐私，但也可以使得目前绝大多数站点的防盗链机制失效。 2.代码12345678910111213import requestsheaders =&#123; &#x27;User-Agent&#x27;:&#x27;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0.0.0 Safari/537.36&#x27;, &#x27;Referrer&#x27;:&#x27;https://www.baidu.com&#x27;,&#125;url = &#x27;https://v3.158868.com/laocz/play/ffzy/id/aHR0cHM6Ly92aXAuZmZ6eS1vbmxpbmUyLmNvbS8yMDIzMDEwMi81MjI2X2NjOTlkMWRlL2luZGV4Lm0zdTgsZmZ6eV8zMTM2&#x27;return_obj = requests.get(url, headers=headers)print(return_obj.content)","categories":[{"name":"爬虫类","slug":"爬虫类","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/"},{"name":"反爬","slug":"爬虫类/反爬","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E5%8F%8D%E7%88%AC/"}],"tags":[]},{"title":"001-基础知识","slug":"爬虫/基础/001-基础知识","date":"2023-08-10T03:14:52.000Z","updated":"2024-05-31T01:43:27.000Z","comments":true,"path":"2023/08/10/爬虫/基础/001-基础知识/","link":"","permalink":"https://dbbruce.github.io/2023/08/10/%E7%88%AC%E8%99%AB/%E5%9F%BA%E7%A1%80/001-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/","excerpt":"1.协议爬虫数据采集：天眼查，数据来源工商监控爬虫：合理性爬虫， 灰色爬虫， 是否获取暴利搜索引擎：百度，google红人点集数据","text":"1.协议爬虫数据采集：天眼查，数据来源工商监控爬虫：合理性爬虫， 灰色爬虫， 是否获取暴利搜索引擎：百度，google红人点集数据 2.通用爬虫主要目的:将互联网上的网页下载到本地，形成一个互联网内容的镜像备份通用搜索引擎（search engine）原理：从互联网搜集网页，采集信息，这些网页信息用于搜索引擎建立索引从而提供支持，它决定着整个引擎系统的内容是否丰富，信息是否即时，因此其性能的优劣直接影响搜索引擎的效果 第一步：抓取网页搜索引擎网络爬虫基本工作流程：1、获取一部分种子url，将这些url放入待抓取url列表；2、取出待抓取url，解析dns得到主机ip，并将url对应的网页下载下来，存储进下载网页库中，并且将这些url放进已经抓取url列表3、分析已抓取URL列表中url，分析其中的其他url，并且将url放入待抓取url列表，从而进入下一次循环 搜索引擎如何获取一个新网站的url1、新网站向搜索引擎提交网址，比如百度：zhanzhang.baidu.com&#x2F;linksubmit&#x2F;url2、其他网站上设置新网站外链3、搜索引擎和dns合作，新网站域名将被迅速抓取 3.聚焦爬虫4.http协议和URL地址url:统一资源定位符协议&#x2F;服务器ip或域名&#x2F;端口&#x2F;访问资源路径&#x2F;参数 基本格式:scheme:&#x2F;&#x2F;host[:port#]&#x2F;path&#x2F;..&#x2F;[?query-string][fanchor] scheme : 协议(例如:http, https, ftp) host : 服务器的IP地址或者域名 port : 服务器的端口(如果是走协议默认端口，缺省端口80) path : 访问资源的路径 query-string : 参数，发送给http服务器的数据 anchor : 锚(跳转到网页的指走锚点位置) 5.客户端http请求1、四部分：请求行，请求头，空行，请求数据 6.xhr断点1、copy接口路径刷新页面，会在断点停止","categories":[{"name":"爬虫类","slug":"爬虫类","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/"},{"name":"基础","slug":"爬虫类/基础","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"百度翻译-中文乱码问题","slug":"爬虫/编码/百度翻译-中文乱码问题","date":"2023-08-10T03:14:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2023/08/10/爬虫/编码/百度翻译-中文乱码问题/","link":"","permalink":"https://dbbruce.github.io/2023/08/10/%E7%88%AC%E8%99%AB/%E7%BC%96%E7%A0%81/%E7%99%BE%E5%BA%A6%E7%BF%BB%E8%AF%91-%E4%B8%AD%E6%96%87%E4%B9%B1%E7%A0%81%E9%97%AE%E9%A2%98/","excerpt":"解决百度时乱码的问题","text":"解决百度时乱码的问题 1.代码1234567891011121314151617181920import jsonimport requestsif __name__ == &#x27;__main__&#x27;: post_url = &#x27;https://fanyi.baidu.com/sug&#x27; param = &#123; &#x27;kw&#x27;: &#x27;dog&#x27; &#125; header = &#123; &#x27;User-Agent&#x27;: &#x27;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0 Safari/537.36&#x27; &#125; response = requests.post(url=post_url, params=param, headers=header) dict_obj = response.json() print(dict_obj) fp = open(&#x27;dog.json&#x27;, &#x27;w&#x27;, encoding=&#x27;utf-8&#x27;) # 注意ensure_ascii=False 这里解决乱码 json.dump(dict_obj, fp=fp, ensure_ascii=False)","categories":[{"name":"爬虫类","slug":"爬虫类","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/"},{"name":"编码","slug":"爬虫类/编码","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E7%BC%96%E7%A0%81/"}],"tags":[]},{"title":"设置爬取页面的编码格式","slug":"爬虫/编码/设置爬取页面的编码格式","date":"2023-08-10T03:14:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2023/08/10/爬虫/编码/设置爬取页面的编码格式/","link":"","permalink":"https://dbbruce.github.io/2023/08/10/%E7%88%AC%E8%99%AB/%E7%BC%96%E7%A0%81/%E8%AE%BE%E7%BD%AE%E7%88%AC%E5%8F%96%E9%A1%B5%E9%9D%A2%E7%9A%84%E7%BC%96%E7%A0%81%E6%A0%BC%E5%BC%8F/","excerpt":"报错信息1UnicodeDecodeError： &#x27;utf-8&#x27; codec can&#x27;t decode byte 0xcd in position 956: invalid continuation byte","text":"报错信息1UnicodeDecodeError： &#x27;utf-8&#x27; codec can&#x27;t decode byte 0xcd in position 956: invalid continuation byte 查看网页编码 页面→显示页面源代码 查看编码格式,charset&#x3D;XXX123456&lt;!DOCTYPE html&gt;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt; &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge,chrome=1&quot; /&gt;&lt;meta name=&quot;renderer&quot; content=&quot;webkit&quot; /&gt;&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt; 设置文件个格式12with open(&#x27;fname&#x27;, encoding=&#x27;utf-8&#x27;) as fobj: pass","categories":[{"name":"爬虫类","slug":"爬虫类","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/"},{"name":"编码","slug":"爬虫类/编码","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E7%BC%96%E7%A0%81/"}],"tags":[]},{"title":"获取二叉树右侧视图","slug":"面试/题/获取二叉树右侧视图","date":"2023-08-10T03:14:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2023/08/10/面试/题/获取二叉树右侧视图/","link":"","permalink":"https://dbbruce.github.io/2023/08/10/%E9%9D%A2%E8%AF%95/%E9%A2%98/%E8%8E%B7%E5%8F%96%E4%BA%8C%E5%8F%89%E6%A0%91%E5%8F%B3%E4%BE%A7%E8%A7%86%E5%9B%BE/","excerpt":"1.代码","text":"1.代码 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354from collections import deque# 树的数据# 1# / \\# 2 3# \\ /\\# 4 5 6# /\\# 7 8class NodeTree: # 构造一棵树 def __init__(self, val): self.data = val self.left = None self.right = None# 构造树root = NodeTree(1)root.left = NodeTree(2)root.right = NodeTree(3)root.left.right = NodeTree(4)root.right.left = NodeTree(5)root.right.right = NodeTree(6)root.right.left.left = NodeTree(7)root.right.left.right = NodeTree(8)def rNode(btree): &quot;&quot;&quot; :param btree:二叉树 :return: list ：右侧节点 &quot;&quot;&quot; res = list() if not btree: return res tree_que = deque([btree]) while tree_que: node = tree_que[-1] res.append(node.data) for _ in range(len(tree_que)): node = tree_que.popleft() if node.left: tree_que.append(node.left) if node.right: tree_que.append(node.right) return res# 调用print(rNode(root)) 2.运行结果","categories":[{"name":"面试","slug":"面试","permalink":"https://dbbruce.github.io/categories/%E9%9D%A2%E8%AF%95/"},{"name":"题","slug":"面试/题","permalink":"https://dbbruce.github.io/categories/%E9%9D%A2%E8%AF%95/%E9%A2%98/"}],"tags":[]},{"title":"greenlet实现协程","slug":"python/异步编程/greenlet实现协程","date":"2023-08-09T12:15:10.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2023/08/09/python/异步编程/greenlet实现协程/","link":"","permalink":"https://dbbruce.github.io/2023/08/09/python/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/greenlet%E5%AE%9E%E7%8E%B0%E5%8D%8F%E7%A8%8B/","excerpt":"1.包安装1pip3 install greenlet","text":"1.包安装1pip3 install greenlet 2.实现123456789101112131415161718from greenlet import greenletdef func1(): print(1) # 第1步: 输出 1 gr2.switch() # 第3步: 切换到 func2 函数gr2.switch0) print(2) # 第6步: 输出 2 gr2.switch() # 第7步; 切换到 func2 函数，从上一次执行的位置继续向后执行def func2(): print(3) # 第4步:输出 3 gr1.switch() # 第5步: 切换到 funcl 函数，从上一次执行的位置继续向后执行print(4) print(4) #第8步:输出 4 gr1 = greenlet(func1)gr2 = greenlet(func2)gr1.switch() # 第1步: 去执行 funcl 函数","categories":[{"name":"Python基础","slug":"Python基础","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/"},{"name":"异步编程","slug":"Python基础/异步编程","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/"}],"tags":[]},{"title":"inSuite文档汇总","slug":"项目/医药公司ERP/inSuite文档汇总","date":"2023-06-17T14:14:52.000Z","updated":"2024-11-29T02:15:04.624Z","comments":true,"path":"2023/06/17/项目/医药公司ERP/inSuite文档汇总/","link":"","permalink":"https://dbbruce.github.io/2023/06/17/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/inSuite%E6%96%87%E6%A1%A3%E6%B1%87%E6%80%BB/","excerpt":"1.创建应用流程 创建单据123456单据应用名称:拆卸组装单模型key:用.分隔所属模块:外部管理系统/ps_ext文件路径:ext/ps_ext/继承模型:Studio Bill Base,stk.doc.base","text":"1.创建应用流程 创建单据123456单据应用名称:拆卸组装单模型key:用.分隔所属模块:外部管理系统/ps_ext文件路径:ext/ps_ext/继承模型:Studio Bill Base,stk.doc.base 发布菜单1234菜单名称:拆卸组装单包含视图:拆卸组装单视图,拆卸组装单列表菜单首页:拆卸组装单列表上级菜单:供应链管理/库存管理/库存调整 高级设置123456xml_id: ation_dis_com_ordermenu_code: menu_dis_con_orderdomain:[(&#x27;delete_state&#x27;, &#x27;=&#x27;, &#x27;normal&#x27;)]context: &#123;&#125;缺省文案:打开方式: 当前窗口 一定要先保存，再同步到IDE 文件位置1odoo/ext/ps_ext - - &gt; dis_com_order 只能修改dev 修改manifest1odoo/ext/ps_ext/.__manifest__.py中复制data数据 - - &gt; __manifest__.py中 模块中，init.py 是否引用了新模块1odoo/ext/ps_ext/__init__.py中查看是否添加上了dis_com_order odoo&#x2F;ext&#x2F;ps_ext&#x2F;views中添加12&lt;field name=&quot;domain&quot;&gt;med&lt;/field&gt;&lt;field name=&quot;module&quot;&gt;gsp&lt;/field&gt; 重启项目，设计器升级 权限1主页 - - &gt; 菜单 - - &gt; 系统管理 - - &gt; 用户管理 - - &gt; 角色功能权限 - - &gt; 外部系统管理 - - &gt; 拆卸组装单 - - &gt; 设置批量有权 - - &gt; 刷新 功能1主页 - - &gt; 菜单 - - &gt; 供应链管理 - - &gt; 库存管理 - - &gt; 库存调整 - - &gt; 拆卸组装单 - - &gt; 创建制单","categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"医药公司ERP","slug":"项目/医药公司ERP","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/"},{"name":"基础","slug":"项目/医药公司ERP/基础","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"02-基于Prometheus和K8S构建智能化监控告警系统","slug":"运维/K8S/基于K8S的世界500强企业真实项目汇总/02-基于Prometheus和K8S构建智能化监控告警系统","date":"2023-05-18T12:00:00.000Z","updated":"2023-12-25T02:47:10.000Z","comments":true,"path":"2023/05/18/运维/K8S/基于K8S的世界500强企业真实项目汇总/02-基于Prometheus和K8S构建智能化监控告警系统/","link":"","permalink":"https://dbbruce.github.io/2023/05/18/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E4%BA%8EK8S%E7%9A%84%E4%B8%96%E7%95%8C500%E5%BC%BA%E4%BC%81%E4%B8%9A%E7%9C%9F%E5%AE%9E%E9%A1%B9%E7%9B%AE%E6%B1%87%E6%80%BB/02-%E5%9F%BA%E4%BA%8EPrometheus%E5%92%8CK8S%E6%9E%84%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8C%96%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6%E7%B3%BB%E7%BB%9F/","excerpt":"k8s环境规划： podSubnet（pod网段） 10.244.0.0&#x2F;16 serviceSubnet（service网段）: 10.96.0.0&#x2F;12 实验环境规划：操作系统：centos7.9配置： 4Gib内存&#x2F;4vCPU&#x2F;60G硬盘网络：NAT模式","text":"k8s环境规划： podSubnet（pod网段） 10.244.0.0&#x2F;16 serviceSubnet（service网段）: 10.96.0.0&#x2F;12 实验环境规划：操作系统：centos7.9配置： 4Gib内存&#x2F;4vCPU&#x2F;60G硬盘网络：NAT模式 12[root@centos07-42 ~]# cat /etc/redhat-releaseCentOS Linux release 7.9.2009 (Core) 12[root@centos07-12 ~]# cat /proc/cpuinfo[root@centos07-12 ~]# cat /proc/meminfo K8S集群角色 IP 主机名 安装组件 控制节点 192.168.1.12 centos07-12 apiserver、controller-manager、schedule、kubelet、etcd、kube-proxy、容器运行时、calico 工作节点 192.168.1.22 centos07-22 Kube-proxy、calico、coredns、容器运行时、kubelet 工作节点 192.168.1.42 centos07-42 Kube-proxy、calico、coredns、容器运行时、kubelet 1 初始化安装k8s集群的实验环境1.1 修改机器IP，变成静态IP - centos07-12&#x2F;22&#x2F;421234567891011121314151617181920# vim /etc/sysconfig/network-scripts/ifcfg-enp0s3 文件TYPE=EthernetPROXY_METHOD=noneBROWSER_ONLY=noBOOTPROTO=staticIPADDR=192.168.1.12NETMASK=255.255.255.0GATEWAY=192.168.1.2DNS1=192.168.1.2DEFROUTE=yesIPV4_FAILURE_FATAL=noIPV6INIT=yesIPV6_AUTOCONF=yesIPV6_DEFROUTE=yesIPV6_FAILURE_FATAL=noIPV6_ADDR_GEN_MODE=stable-privacyNAME=enp0s3DEVICE=enp0s3ONBOOT=yes 修改配置文件之后需要重启网络服务才能使配置生效，重启网络服务命令如下： - centos07-12&#x2F;22&#x2F;42 service network restart 12[root@centos07-12 ~]# service network restartRestarting network (via systemctl): [ OK ] 123456789注：/etc/sysconfig/network-scripts/ifcfg-enp0s3文件里的配置说明：NAME=enp0s3 #网卡名字，跟DEVICE名字保持一致即可DEVICE=enp0s3 #网卡设备名，大家ip addr可看到自己的这个网卡设备名，每个人的机器可能这个名字不一样，需要写自己的BOOTPROTO=static #static表示静态ip地址ONBOOT=yes #开机自启动网络，必须是yesIPADDR=192.168.1.12 #ip地址，需要跟自己电脑所在网段一致NETMASK=255.255.255.0 #子网掩码，需要跟自己电脑所在网段一致GATEWAY=192.168.1.2 #网关，在自己电脑打开cmd，输入ipconfig /all可看到DNS1=192.168.1.2 #DNS，在自己电脑打开cmd，输入ipconfig /all可看到 各个节点执行如下命令更新yum源和操作系统： - centos07-12&#x2F;22&#x2F;42 1yum update -y 1.2 关闭selinux，所有k8s机器均操作 - centos07-12&#x2F;22&#x2F;42 - centos07-12&#x2F;22&#x2F;421sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config 修改selinux配置文件之后，重启机器，selinux配置才能永久生效，重启之后，登录到机器，执行如下命令： 1getenforce 如果显示Disabled说明selinux已经关闭 1.3 配置机器主机名 - centos07-12&#x2F;22&#x2F;42在192.168.12 上执行如下： 1hostnamectl set-hostname centos07-12 &amp;&amp; bash 在192.168.1.22 上执行如下： 1hostnamectl set-hostname centos07-22 &amp;&amp; bash 在192.168.1.42 上执行如下： 1hostnamectl set-hostname centos07-42 &amp;&amp; bash 1.4 配置主机hosts文件，相互之间通过主机名互相访问 - centos07-12&#x2F;22&#x2F;42修改每台机器的&#x2F;etc&#x2F;hosts文件，文件最后增加如下内容： 123192.168.12 centos07-12192.168.1.22 centos07-22192.168.1.42 centos07-42 1.5 配置主机之间无密码登录 - centos07-12&#x2F;22&#x2F;42配置3台机器互相免密登录 1ssh-keygen #一路回车，不输入密码 把本地生成的密钥文件和私钥文件拷贝到远程主机 123ssh-copy-id centos07-12ssh-copy-id centos07-22ssh-copy-id centos07-42 1.6 关闭交换分区swap，提升性能 - centos07-12&#x2F;22&#x2F;42临时关闭 1swapoff -a 永久关闭：注释swap挂载，给swap这行开头加一下注释 123vim /etc/fstab #/dev/mapper/centos-swap swap swap defaults 0 0 问题1：为什么要关闭swap交换分区？Swap是交换分区，如果机器内存不够，会使用swap分区，但是swap分区的性能较低，k8s设计的时候为了能提升性能，默认是不允许使用交换分区的。Kubeadm初始化的时候会检测swap是否关闭，如果没关闭，那就初始化失败。如果不想要关闭交换分区，安装k8s的时候可以指定–ignore-preflight-errors&#x3D;Swap来解决。 1.7 修改机器内核参数 - centos07-12&#x2F;22&#x2F;4212345678modprobe br_netfiltercat &gt; /etc/sysctl.d/k8s.conf &lt;&lt;EOFnet.bridge.bridge-nf-call-ip6tables = 1net.bridge.bridge-nf-call-iptables = 1net.ipv4.ip_forward = 1EOF 1sysctl -p /etc/sysctl.d/k8s.conf 问题1：sysctl是做什么的？在运行时配置内核参数 :-p 从指定的文件加载系统参数，如不指定即从&#x2F;etc&#x2F;sysctl.conf中加载 问题2：为什么要执行modprobe br_netfilter？修改&#x2F;etc&#x2F;sysctl.d&#x2F;k8s.conf文件，增加如下三行参数：net.bridge.bridge-nf-call-ip6tables &#x3D; 1net.bridge.bridge-nf-call-iptables &#x3D; 1net.ipv4.ip_forward &#x3D; 1 sysctl -p &#x2F;etc&#x2F;sysctl.d&#x2F;k8s.conf出现报错：sysctl: cannot stat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;bridge&#x2F;bridge-nf-call-ip6tables: No such file or directorysysctl: cannot stat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;bridge&#x2F;bridge-nf-call-iptables: No such file or directory 解决方法：modprobe br_netfilter 问题3：为什么开启net.bridge.bridge-nf-call-iptables内核参数？在centos下安装docker，执行docker info出现如下警告：WARNING: bridge-nf-call-iptables is disabledWARNING: bridge-nf-call-ip6tables is disabled 解决办法：vim &#x2F;etc&#x2F;sysctl.d&#x2F;k8s.confnet.bridge.bridge-nf-call-ip6tables &#x3D; 1net.bridge.bridge-nf-call-iptables &#x3D; 1 问题4：为什么要开启net.ipv4.ip_forward &#x3D; 1参数？kubeadm初始化k8s如果报错： 就表示没有开启ip_forward，需要开启。 net.ipv4.ip_forward是数据包转发：出于安全考虑，Linux系统默认是禁止数据包转发的。所谓转发即当主机拥有多于一块的网卡时，其中一块收到数据包，根据数据包的目的ip地址将数据包发往本机另一块网卡，该网卡根据路由表继续发送数据包。这通常是路由器所要实现的功能。要让Linux系统具有路由转发功能，需要配置一个Linux的内核参数net.ipv4.ip_forward。这个参数指定了Linux系统当前对路由转发功能的支持情况；其值为0时表示禁止进行IP转发；如果是1,则说明IP转发功能已经打开。 1.8 关闭firewalld防火墙 - centos07-12&#x2F;22&#x2F;421systemctl stop firewalld ; systemctl disable firewalld 1.9 配置阿里云的repo源 - centos07-12&#x2F;22&#x2F;42配置国内安装docker和containerd的阿里云的repo源 1yum install yum-utils -y 1yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo 12ll /etc/yum.repos.d/docker-ce.repo-rw-r--r-- 1 root root 2081 12月 23 16:33 /etc/yum.repos.d/docker-ce.repo 1.10 配置安装k8s组件需要的阿里云的repo源 - centos07-12&#x2F;22&#x2F;4212345678cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt;EOF[kubernetes]name=Kubernetesbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/enabled=1gpgcheck=0EOF 1.11 配置时间同步 - centos07-12&#x2F;22&#x2F;42安装ntpdate命令 1yum install ntpdate -y 跟网络时间做同步 1ntpdate cn.pool.ntp.org 把时间同步做成计划任务 123crontab -e* */1 * * * /usr/sbin/ntpdate cn.pool.ntp.org 重启crond服务 1service crond restart 1.12 开启ipvs - centos07-12&#x2F;22&#x2F;42把ipvs.modules上传到centos07-12&#x2F;22&#x2F;42机器的&#x2F;etc&#x2F;sysconfig&#x2F;modules&#x2F;目录下 1cp ipvs.modules /etc/sysconfig/modules/ 123456789101112131415161718chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep ip_vsip_vs_ftp 13079 0nf_nat 26583 1 ip_vs_ftpip_vs_sed 12519 0ip_vs_nq 12516 0ip_vs_sh 12688 0ip_vs_dh 12688 0ip_vs_lblcr 12922 0ip_vs_lblc 12819 0ip_vs_wrr 12697 0ip_vs_rr 12600 0ip_vs_wlc 12519 0ip_vs_lc 12516 0ip_vs 145458 22 ip_vs_dh,ip_vs_lc,ip_vs_nq,ip_vs_rr,ip_vs_sh,ip_vs_ftp,ip_vs_sed,ip_vs_wlc,ip_vs_wrr,ip_vs_lblcr,ip_vs_lblcnf_conntrack 143411 2 ip_vs,nf_natlibcrc32c 12644 4 xfs,ip_vs,nf_nat,nf_conntrack 问题1：ipvs是什么？ipvs (IP Virtual Server) 实现了传输层负载均衡，也就是我们常说的4层LAN交换，作为 Linux 内核的一部分。ipvs运行在主机上，在真实服务器集群前充当负载均衡器。ipvs可以将基于TCP和UDP的服务请求转发到真实服务器上，并使真实服务器的服务在单个 IP 地址上显示为虚拟服务。 问题2：ipvs和iptable对比分析kube-proxy支持 iptables 和 ipvs 两种模式， 在kubernetes v1.8 中引入了 ipvs 模式，在 v1.9 中处于 beta 阶段，在 v1.11 中已经正式可用了。iptables 模式在 v1.1 中就添加支持了，从 v1.2 版本开始 iptables 就是 kube-proxy 默认的操作模式，ipvs 和 iptables 都是基于netfilter的，但是ipvs采用的是hash表，因此当service数量达到一定规模时，hash查表的速度优势就会显现出来，从而提高service的服务性能。那么 ipvs 模式和 iptables 模式之间有哪些差异呢？1、ipvs 为大型集群提供了更好的可扩展性和性能2、ipvs 支持比 iptables 更复杂的复制均衡算法（最小负载、最少连接、加权等等）3、ipvs 支持服务器健康检查和连接重试等功能 1.13 安装基础软件包 - centos07-12&#x2F;22&#x2F;421yum install -y device-mapper-persistent-data lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel python-devel epel-release openssh-server socat ipvsadm conntrack telnet ipvsadm 1.14 安装iptables - centos07-12&#x2F;22&#x2F;42如果用firewalld不习惯，可以安装iptables ，在centos07-12&#x2F;22&#x2F;42上操作：安装iptables 1yum install iptables-services -y 禁用iptables 1service iptables stop &amp;&amp; systemctl disable iptables 清空防火墙规则 1iptables -F 1.15 如果是虚拟机，最好在这里做个镜像2 安装docker服务2.1 安装docker-ce - centos07-12&#x2F;22&#x2F;421yum install docker-ce -y 1systemctl start docker &amp;&amp; systemctl enable docker.service 2.2 配置docker镜像加速器和驱动 - centos07-12&#x2F;22&#x2F;42123456vim /etc/docker/daemon.json &#123; &quot;registry-mirrors&quot;: [&quot;https://882k7j67.mirror.aliyuncs.com&quot;], &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]&#125; “exec-opts”: [“native.cgroupdriver&#x3D;systemd”] # 这里是驱动，需要和kubelet保持一致 1systemctl daemon-reload &amp;&amp; systemctl restart docker 1234567891011121314151617181920212223systemctl status docker● docker.service - Docker Application Container Engine Loaded: loaded (/usr/lib/systemd/system/docker.service; enabled; vendor preset: disabled) Active: active (running) since 日 2023-12-24 22:06:40 CST; 14s ago Docs: https://docs.docker.com Main PID: 2385 (dockerd) Tasks: 10 Memory: 31.4M CGroup: /system.slice/docker.service └─2385 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock12月 24 22:06:39 centos07-12 systemd[1]: Starting Docker Application Container Engine...12月 24 22:06:39 centos07-12 dockerd[2385]: time=&quot;2023-12-24T22:06:39.812530553+08:00&quot; level=info msg=&quot;Starting up&quot;12月 24 22:06:39 centos07-12 dockerd[2385]: time=&quot;2023-12-24T22:06:39.866392448+08:00&quot; level=info msg=&quot;[graphdriver] using prior sto...erlay2&quot;12月 24 22:06:39 centos07-12 dockerd[2385]: time=&quot;2023-12-24T22:06:39.866862764+08:00&quot; level=info msg=&quot;Loading containers: start.&quot;12月 24 22:06:40 centos07-12 dockerd[2385]: time=&quot;2023-12-24T22:06:40.062510212+08:00&quot; level=info msg=&quot;Default bridge (docker0) is a...ddress&quot;12月 24 22:06:40 centos07-12 dockerd[2385]: time=&quot;2023-12-24T22:06:40.138470653+08:00&quot; level=info msg=&quot;Loading containers: done.&quot;12月 24 22:06:40 centos07-12 dockerd[2385]: time=&quot;2023-12-24T22:06:40.169504423+08:00&quot; level=info msg=&quot;Docker daemon&quot; commit=311b9ff...=24.0.712月 24 22:06:40 centos07-12 dockerd[2385]: time=&quot;2023-12-24T22:06:40.169742710+08:00&quot; level=info msg=&quot;Daemon has completed initialization&quot;12月 24 22:06:40 centos07-12 dockerd[2385]: time=&quot;2023-12-24T22:06:40.204093714+08:00&quot; level=info msg=&quot;API listen on /run/docker.sock&quot;12月 24 22:06:40 centos07-12 systemd[1]: Started Docker Application Container Engine.Hint: Some lines were ellipsized, use -l to show in full. 3 安装初始化k8s需要的软件包 - centos07-12&#x2F;22&#x2F;421yum install -y kubelet-1.23.1 kubeadm-1.23.1 kubectl-1.23.1 1systemctl enable kubelet 注：每个软件包的作用Kubeadm: kubeadm是一个工具，用来初始化k8s集群的kubelet: 安装在集群所有节点上，用于启动Pod的kubectl: 通过kubectl可以部署和管理应用，查看各种资源，创建、删除和更新各种组件 4 kubeadm初始化k8s集群 - centos07-12&#x2F;22&#x2F;42把初始化k8s集群需要的离线镜像包上传到 - centos07-12&#x2F;22&#x2F;42 机器上，手动解压： - centos07-12&#x2F;22&#x2F;42 1docker load -i k8s-images-v1.23.1.tar.gz 使用kubeadm初始化k8s集群 - centos07-12设置podSubnet（pod网段）： –pod-network-cidr&#x3D;10.244.0.0&#x2F;16 1kubeadm init --kubernetes-version=1.23.1 --apiserver-advertise-address=192.168.1.12 --image-repository registry.aliyuncs.com/google_containers --pod-network-cidr=10.244.0.0/16 --ignore-preflight-errors=SystemVerification 注：–image-repository registry.aliyuncs.com&#x2F;google_containers：手动指定仓库地址为registry.aliyuncs.com&#x2F;google_containers。 kubeadm默认从k8s.grc.io拉取镜像，但是k8s.gcr.io访问不到，所以需要指定从registry.aliyuncs.com&#x2F;google_containers仓库拉取镜像。显示如下，说明安装完成： 1kubeadm join 192.168.1.12:6443 --token ukaoml.lucdcifuerdxhn1a --discovery-token-ca-cert-hash sha256:c18a369a3d959457249b743d31c9891d8647665471840714e02689f11203724f 上面命令是把node节点加入集群，需要保存下来，每个人的都不一样 配置kubectl的配置文件config，相当于对kubectl进行授权，这样kubectl命令可以使用这个证书对 k8s集群进行管理 123mkdir -p $HOME/.kubesudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/configsudo chown $(id -u):$(id -g) $HOME/.kube/config 1234kubectl get nodesNAME STATUS ROLES AGE VERSIONcentos07-12 NotReady control-plane,master 4m30s v1.23.1 此时集群状态还是NotReady状态，因为没有安装网络插件 5 扩容k8s集群-添加第一个工作节点 - centos07-22在centos07-12上查看加入节点的命令： - centos07-12 123kubeadm token create --print-join-commandkubeadm join 192.168.1.12:6443 --token qjcaxe.domcre9fi3h0bfg0 --discovery-token-ca-cert-hash sha256:c18a369a3d959457249b743d31c9891d8647665471840714e02689f11203724f 把centos07-22加入k8s集群： 1kubeadm join 192.168.1.12:6443 --token qjcaxe.domcre9fi3h0bfg0 --discovery-token-ca-cert-hash sha256:c18a369a3d959457249b743d31c9891d8647665471840714e02689f11203724f 1234567891011121314151617[root@centos07-22 ~]# kubeadm join 192.168.1.12:6443 --token qjcaxe.domcre9fi3h0bfg0 --discovery-token-ca-cert-hash sha256:c18a369a3d959457249b743d31c9891d8647665471840714e02689f11203724f[preflight] Running pre-flight checks [WARNING SystemVerification]: this Docker version is not on the list of validated versions: 24.0.7. Latest validated version: 20.10 [WARNING Service-Kubelet]: kubelet service is not enabled, please run &#x27;systemctl enable kubelet.service&#x27;[preflight] Reading configuration from the cluster...[preflight] FYI: You can look at this config file with &#x27;kubectl -n kube-system get cm kubeadm-config -o yaml&#x27;[kubelet-start] Writing kubelet configuration to file &quot;/var/lib/kubelet/config.yaml&quot;[kubelet-start] Writing kubelet environment file with flags to file &quot;/var/lib/kubelet/kubeadm-flags.env&quot;[kubelet-start] Starting the kubelet[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...This node has joined the cluster:* Certificate signing request was sent to apiserver and a response was received.* The Kubelet was informed of the new secure connection details.Run &#x27;kubectl get nodes&#x27; on the control-plane to see this node join the cluster. 在centos07-12上查看集群节点状况： 1234[root@centos07-12 ~]# kubectl get nodes -owideNAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIMEcentos07-12 NotReady control-plane,master 12m v1.23.1 192.168.1.12 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 docker://24.0.7centos07-22 NotReady &lt;none&gt; 5m18s v1.23.1 192.168.1.22 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 docker://24.0.7 6 扩容k8s集群-添加第一个工作节点 - centos07-42在centos07-12上查看加入节点的命令： - centos07-12 123kubeadm token create --print-join-commandkubeadm join 192.168.1.12:6443 --token qjcaxe.domcre9fi3h0bfg0 --discovery-token-ca-cert-hash sha256:c18a369a3d959457249b743d31c9891d8647665471840714e02689f11203724f 把centos07-42加入k8s集群： 1kubeadm join 192.168.1.12:6443 --token qjcaxe.domcre9fi3h0bfg0 --discovery-token-ca-cert-hash sha256:c18a369a3d959457249b743d31c9891d8647665471840714e02689f11203724f 12345678910111213141516[root@centos07-42 ~]# kubeadm join 192.168.1.12:6443 --token qjcaxe.domcre9fi3h0bfg0 --discovery-token-ca-cert-hash sha256:c18a369a3d959457249b743d31c9891d8647665471840714e02689f11203724f[preflight] Running pre-flight checks [WARNING SystemVerification]: this Docker version is not on the list of validated versions: 24.0.7. Latest validated version: 20.10[preflight] Reading configuration from the cluster...[preflight] FYI: You can look at this config file with &#x27;kubectl -n kube-system get cm kubeadm-config -o yaml&#x27;[kubelet-start] Writing kubelet configuration to file &quot;/var/lib/kubelet/config.yaml&quot;[kubelet-start] Writing kubelet environment file with flags to file &quot;/var/lib/kubelet/kubeadm-flags.env&quot;[kubelet-start] Starting the kubelet[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...This node has joined the cluster:* Certificate signing request was sent to apiserver and a response was received.* The Kubelet was informed of the new secure connection details.Run &#x27;kubectl get nodes&#x27; on the control-plane to see this node join the cluster. 在centos07-12上查看集群节点状况： 12345[root@centos07-12 ~]# kubectl get nodes -owideNAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIMEcentos07-12 NotReady control-plane,master 14m v1.23.1 192.168.1.12 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 docker://24.0.7centos07-22 NotReady &lt;none&gt; 7m36s v1.23.1 192.168.1.22 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 docker://24.0.7centos07-42 NotReady &lt;none&gt; 30s v1.23.1 192.168.1.42 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 docker://24.0.7 7 role角色改为work - centos07-12可以看到centos07-22&#x2F;42的ROLES角色为空，就表示这个节点是工作节点。 12345[root@centos07-12 ~]# kubectl get nodes -owideNAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIMEcentos07-12 NotReady control-plane,master 15m v1.23.1 192.168.1.12 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 docker://24.0.7centos07-22 NotReady &lt;none&gt; 8m51s v1.23.1 192.168.1.22 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 docker://24.0.7centos07-42 NotReady &lt;none&gt; 105s v1.23.1 192.168.1.42 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 docker://24.0.7 可以把centos07-22&#x2F;42的ROLES变成work，按照如下方法： 12kubectl label node centos07-22 node-role.kubernetes.io/worker=workerkubectl label node centos07-42 node-role.kubernetes.io/worker=worker 12345[root@centos07-12 ~]# kubectl get nodes -owideNAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIMEcentos07-12 NotReady control-plane,master 16m v1.23.1 192.168.1.12 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 docker://24.0.7centos07-22 NotReady worker 9m46s v1.23.1 192.168.1.22 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 docker://24.0.7centos07-42 NotReady worker 2m40s v1.23.1 192.168.1.42 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 docker://24.0.7 注意：上面状态都是NotReady状态，说明没有安装网络插件 8 安装kubernetes网络组件-Calico - centos07-12上传calico.yaml到centos07-12上，使用yaml文件安装calico 网络插件添加以下内容： 1234vim calico.yaml - name: IP_AUTODETECTION_METHOD value: &quot;interface=enp0s3&quot; 1kubectl apply -f calico.yaml 注：在线下载配置文件地址是： https://docs.projectcalico.org/manifests/calico.yaml 1234567891011121314151617 kubectl get pod -n kube-system NAME READY STATUS RESTARTS AGEcalico-kube-controllers-677cd97c8d-j2782 0/1 Running 0 60scalico-node-hs9h5 1/1 Running 0 60scalico-node-pt9md 0/1 Running 0 60scalico-node-xddmf 0/1 Running 0 60scoredns-6d8c4cb4d-dgw22 1/1 Running 0 40mcoredns-6d8c4cb4d-j4c6b 1/1 Running 0 40metcd-centos07-12 1/1 Running 0 41mkube-apiserver-centos07-12 1/1 Running 0 41mkube-controller-manager-centos07-12 1/1 Running 0 41mkube-proxy-4nx9c 1/1 Running 0 34mkube-proxy-v87c6 1/1 Running 0 40mkube-proxy-v9lx5 1/1 Running 0 26mkube-scheduler-centos07-12 1/1 Running 0 41m 再次查看集群状态 12345[root@centos07-12 ~]# kubectl get nodes -owideNAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIMEcentos07-12 Ready control-plane,master 46m v1.23.1 192.168.1.12 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 docker://24.0.7centos07-22 Ready worker 39m v1.23.1 192.168.1.22 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 docker://24.0.7centos07-42 Ready worker 32m v1.23.1 192.168.1.42 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 docker://24.0.7 STATUS状态是Ready，说明k8s集群正常运行了 9 测试在k8s创建pod是否可以正常访问网络 - - centos07-12把busybox-1-28.tar.gz上传到centos07-22、42节点，手动解压 - centos07-22&#x2F;42 12scp busybox-1-28.tar.gz root@192.168.1.22:~scp busybox-1-28.tar.gz root@192.168.1.42:~ 1docker load -i busybox-1-28.tar.gz 123456789101112131415docker imagesREPOSITORY TAG IMAGE ID CREATED SIZEregistry.aliyuncs.com/google_containers/kube-apiserver v1.23.1 b6d7abedde39 2 years ago 135MBregistry.aliyuncs.com/google_containers/kube-proxy v1.23.1 b46c42588d51 2 years ago 112MBregistry.aliyuncs.com/google_containers/kube-scheduler v1.23.1 71d575efe628 2 years ago 53.5MBregistry.aliyuncs.com/google_containers/kube-controller-manager v1.23.1 f51846a4fd28 2 years ago 125MBregistry.aliyuncs.com/google_containers/etcd 3.5.1-0 25f8c7f3da61 2 years ago 293MBregistry.aliyuncs.com/google_containers/coredns v1.8.6 a4ca41631cc7 2 years ago 46.8MBregistry.aliyuncs.com/google_containers/pause 3.6 6270bb605e12 2 years ago 683kBcalico/pod2daemon-flexvol v3.18.0 2a22066e9588 2 years ago 21.7MBcalico/node v3.18.0 5a7c4970fbc2 2 years ago 172MBcalico/cni v3.18.0 727de170e4ce 2 years ago 131MBcalico/kube-controllers v3.18.0 9a154323fbf7 2 years ago 53.4MBbusybox 1.28 8c811b4aec35 5 years ago 1.15MB 123456789[root@centos07-12 ~]# kubectl run busybox --image busybox:1.28 --restart=Never --rm -it busybox -- shIf you don&#x27;t see a command prompt, try pressing enter./ # ping www.baidu.comPING www.baidu.com (39.156.66.14): 56 data bytes64 bytes from 39.156.66.14: seq=0 ttl=61 time=7.895 ms64 bytes from 39.156.66.14: seq=1 ttl=61 time=7.726 ms--- www.baidu.com ping statistics ---2 packets transmitted, 2 packets received, 0% packet lossround-trip min/avg/max = 7.726/7.810/7.895 ms 通过上面可以看到能访问网络，说明calico网络插件已经被正常安装了 1.9 测试coredns是否正常123456789[root@centos07-12 ~]# kubectl run busybox --image busybox:1.28 --restart=Never --rm -it busybox -- shIf you don&#x27;t see a command prompt, try pressing enter./ # nslookup kubernetes.default.svc.cluster.localServer: 10.96.0.10Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.localName: kubernetes.default.svc.cluster.localAddress 1: 10.96.0.1 kubernetes.default.svc.cluster.local/ # 10.96.0.10 就是我们coreDNS的clusterIP，说明coreDNS配置好了。解析内部Service的名称，是通过coreDNS去解析的。 注意：busybox要用指定的1.28版本，不能用最新版本，最新版本，nslookup会解析不到dns和ip","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"项目汇总","slug":"运维/K8S/项目汇总","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E9%A1%B9%E7%9B%AE%E6%B1%87%E6%80%BB/"}],"tags":[]},{"title":"01-安装稳定版本K8S-1.23高可用集群","slug":"运维/K8S/基于K8S的世界500强企业真实项目汇总/01-安装稳定版本K8S-1.23高可用集群","date":"2023-05-18T02:00:00.000Z","updated":"2023-12-24T16:05:28.000Z","comments":true,"path":"2023/05/18/运维/K8S/基于K8S的世界500强企业真实项目汇总/01-安装稳定版本K8S-1.23高可用集群/","link":"","permalink":"https://dbbruce.github.io/2023/05/18/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E4%BA%8EK8S%E7%9A%84%E4%B8%96%E7%95%8C500%E5%BC%BA%E4%BC%81%E4%B8%9A%E7%9C%9F%E5%AE%9E%E9%A1%B9%E7%9B%AE%E6%B1%87%E6%80%BB/01-%E5%AE%89%E8%A3%85%E7%A8%B3%E5%AE%9A%E7%89%88%E6%9C%ACK8S-1.23%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4/","excerpt":"k8s环境规划： podSubnet（pod网段） 10.244.0.0&#x2F;16 serviceSubnet（service网段）: 10.96.0.0&#x2F;12 实验环境规划：操作系统：centos7.9配置： 4Gib内存&#x2F;4vCPU&#x2F;60G硬盘网络：NAT模式","text":"k8s环境规划： podSubnet（pod网段） 10.244.0.0&#x2F;16 serviceSubnet（service网段）: 10.96.0.0&#x2F;12 实验环境规划：操作系统：centos7.9配置： 4Gib内存&#x2F;4vCPU&#x2F;60G硬盘网络：NAT模式 12[root@centos07-42 ~]# cat /etc/redhat-releaseCentOS Linux release 7.9.2009 (Core) 12[root@centos07-12 ~]# cat /proc/cpuinfo[root@centos07-12 ~]# cat /proc/meminfo K8S集群角色 IP 主机名 安装组件 控制节点 192.168.1.12 centos07-12 apiserver、controller-manager、schedule、kubelet、etcd、kube-proxy、容器运行时、calico 工作节点 192.168.1.22 centos07-22 Kube-proxy、calico、coredns、容器运行时、kubelet 工作节点 192.168.1.42 centos07-42 Kube-proxy、calico、coredns、容器运行时、kubelet 1 初始化安装k8s集群的实验环境1.1 修改机器IP，变成静态IP - centos07-12&#x2F;22&#x2F;421234567891011121314151617181920# vim /etc/sysconfig/network-scripts/ifcfg-enp0s3 文件TYPE=EthernetPROXY_METHOD=noneBROWSER_ONLY=noBOOTPROTO=staticIPADDR=192.168.1.12NETMASK=255.255.255.0GATEWAY=192.168.1.2DNS1=192.168.1.2DEFROUTE=yesIPV4_FAILURE_FATAL=noIPV6INIT=yesIPV6_AUTOCONF=yesIPV6_DEFROUTE=yesIPV6_FAILURE_FATAL=noIPV6_ADDR_GEN_MODE=stable-privacyNAME=enp0s3DEVICE=enp0s3ONBOOT=yes 修改配置文件之后需要重启网络服务才能使配置生效，重启网络服务命令如下： - centos07-12&#x2F;22&#x2F;42 service network restart 12[root@centos07-12 ~]# service network restartRestarting network (via systemctl): [ OK ] 123456789注：/etc/sysconfig/network-scripts/ifcfg-enp0s3文件里的配置说明：NAME=enp0s3 #网卡名字，跟DEVICE名字保持一致即可DEVICE=enp0s3 #网卡设备名，大家ip addr可看到自己的这个网卡设备名，每个人的机器可能这个名字不一样，需要写自己的BOOTPROTO=static #static表示静态ip地址ONBOOT=yes #开机自启动网络，必须是yesIPADDR=192.168.1.12 #ip地址，需要跟自己电脑所在网段一致NETMASK=255.255.255.0 #子网掩码，需要跟自己电脑所在网段一致GATEWAY=192.168.1.2 #网关，在自己电脑打开cmd，输入ipconfig /all可看到DNS1=192.168.1.2 #DNS，在自己电脑打开cmd，输入ipconfig /all可看到 各个节点执行如下命令更新yum源和操作系统： - centos07-12&#x2F;22&#x2F;42 1yum update -y 1.2 关闭selinux，所有k8s机器均操作 - centos07-12&#x2F;22&#x2F;42 - centos07-12&#x2F;22&#x2F;421sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config 修改selinux配置文件之后，重启机器，selinux配置才能永久生效，重启之后，登录到机器，执行如下命令： 1getenforce 如果显示Disabled说明selinux已经关闭 1.3 配置机器主机名 - centos07-12&#x2F;22&#x2F;42在192.168.12 上执行如下： 1hostnamectl set-hostname centos07-12 &amp;&amp; bash 在192.168.1.22 上执行如下： 1hostnamectl set-hostname centos07-22 &amp;&amp; bash 在192.168.1.42 上执行如下： 1hostnamectl set-hostname centos07-42 &amp;&amp; bash 1.4 配置主机hosts文件，相互之间通过主机名互相访问 - centos07-12&#x2F;22&#x2F;42修改每台机器的&#x2F;etc&#x2F;hosts文件，文件最后增加如下内容： 123192.168.12 centos07-12192.168.1.22 centos07-22192.168.1.42 centos07-42 1.5 配置主机之间无密码登录 - centos07-12&#x2F;22&#x2F;42配置3台机器互相免密登录 1ssh-keygen #一路回车，不输入密码 把本地生成的密钥文件和私钥文件拷贝到远程主机 123ssh-copy-id centos07-12ssh-copy-id centos07-22ssh-copy-id centos07-42 1.6 关闭交换分区swap，提升性能 - centos07-12&#x2F;22&#x2F;42临时关闭 1swapoff -a 永久关闭：注释swap挂载，给swap这行开头加一下注释 123vim /etc/fstab #/dev/mapper/centos-swap swap swap defaults 0 0 问题1：为什么要关闭swap交换分区？Swap是交换分区，如果机器内存不够，会使用swap分区，但是swap分区的性能较低，k8s设计的时候为了能提升性能，默认是不允许使用交换分区的。Kubeadm初始化的时候会检测swap是否关闭，如果没关闭，那就初始化失败。如果不想要关闭交换分区，安装k8s的时候可以指定–ignore-preflight-errors&#x3D;Swap来解决。 1.7 修改机器内核参数 - centos07-12&#x2F;22&#x2F;4212345678modprobe br_netfiltercat &gt; /etc/sysctl.d/k8s.conf &lt;&lt;EOFnet.bridge.bridge-nf-call-ip6tables = 1net.bridge.bridge-nf-call-iptables = 1net.ipv4.ip_forward = 1EOF 1sysctl -p /etc/sysctl.d/k8s.conf 问题1：sysctl是做什么的？在运行时配置内核参数 :-p 从指定的文件加载系统参数，如不指定即从&#x2F;etc&#x2F;sysctl.conf中加载 问题2：为什么要执行modprobe br_netfilter？修改&#x2F;etc&#x2F;sysctl.d&#x2F;k8s.conf文件，增加如下三行参数：net.bridge.bridge-nf-call-ip6tables &#x3D; 1net.bridge.bridge-nf-call-iptables &#x3D; 1net.ipv4.ip_forward &#x3D; 1 sysctl -p &#x2F;etc&#x2F;sysctl.d&#x2F;k8s.conf出现报错：sysctl: cannot stat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;bridge&#x2F;bridge-nf-call-ip6tables: No such file or directorysysctl: cannot stat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;bridge&#x2F;bridge-nf-call-iptables: No such file or directory 解决方法：modprobe br_netfilter 问题3：为什么开启net.bridge.bridge-nf-call-iptables内核参数？在centos下安装docker，执行docker info出现如下警告：WARNING: bridge-nf-call-iptables is disabledWARNING: bridge-nf-call-ip6tables is disabled 解决办法：vim &#x2F;etc&#x2F;sysctl.d&#x2F;k8s.confnet.bridge.bridge-nf-call-ip6tables &#x3D; 1net.bridge.bridge-nf-call-iptables &#x3D; 1 问题4：为什么要开启net.ipv4.ip_forward &#x3D; 1参数？kubeadm初始化k8s如果报错： 就表示没有开启ip_forward，需要开启。 net.ipv4.ip_forward是数据包转发：出于安全考虑，Linux系统默认是禁止数据包转发的。所谓转发即当主机拥有多于一块的网卡时，其中一块收到数据包，根据数据包的目的ip地址将数据包发往本机另一块网卡，该网卡根据路由表继续发送数据包。这通常是路由器所要实现的功能。要让Linux系统具有路由转发功能，需要配置一个Linux的内核参数net.ipv4.ip_forward。这个参数指定了Linux系统当前对路由转发功能的支持情况；其值为0时表示禁止进行IP转发；如果是1,则说明IP转发功能已经打开。 1.8 关闭firewalld防火墙 - centos07-12&#x2F;22&#x2F;421systemctl stop firewalld ; systemctl disable firewalld 1.9 配置阿里云的repo源 - centos07-12&#x2F;22&#x2F;42配置国内安装docker和containerd的阿里云的repo源 1yum install yum-utils -y 1yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo 12ll /etc/yum.repos.d/docker-ce.repo-rw-r--r-- 1 root root 2081 12月 23 16:33 /etc/yum.repos.d/docker-ce.repo 1.10 配置安装k8s组件需要的阿里云的repo源 - centos07-12&#x2F;22&#x2F;4212345678cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt;EOF[kubernetes]name=Kubernetesbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/enabled=1gpgcheck=0EOF 1.11 配置时间同步 - centos07-12&#x2F;22&#x2F;42安装ntpdate命令 1yum install ntpdate -y 跟网络时间做同步 1ntpdate cn.pool.ntp.org 把时间同步做成计划任务 123crontab -e* */1 * * * /usr/sbin/ntpdate cn.pool.ntp.org 重启crond服务 1service crond restart 1.12 开启ipvs - centos07-12&#x2F;22&#x2F;42把ipvs.modules上传到centos07-12&#x2F;22&#x2F;42机器的&#x2F;etc&#x2F;sysconfig&#x2F;modules&#x2F;目录下 1cp ipvs.modules /etc/sysconfig/modules/ 123456789101112131415161718chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep ip_vsip_vs_ftp 13079 0nf_nat 26583 1 ip_vs_ftpip_vs_sed 12519 0ip_vs_nq 12516 0ip_vs_sh 12688 0ip_vs_dh 12688 0ip_vs_lblcr 12922 0ip_vs_lblc 12819 0ip_vs_wrr 12697 0ip_vs_rr 12600 0ip_vs_wlc 12519 0ip_vs_lc 12516 0ip_vs 145458 22 ip_vs_dh,ip_vs_lc,ip_vs_nq,ip_vs_rr,ip_vs_sh,ip_vs_ftp,ip_vs_sed,ip_vs_wlc,ip_vs_wrr,ip_vs_lblcr,ip_vs_lblcnf_conntrack 143411 2 ip_vs,nf_natlibcrc32c 12644 4 xfs,ip_vs,nf_nat,nf_conntrack 问题1：ipvs是什么？ipvs (IP Virtual Server) 实现了传输层负载均衡，也就是我们常说的4层LAN交换，作为 Linux 内核的一部分。ipvs运行在主机上，在真实服务器集群前充当负载均衡器。ipvs可以将基于TCP和UDP的服务请求转发到真实服务器上，并使真实服务器的服务在单个 IP 地址上显示为虚拟服务。 问题2：ipvs和iptable对比分析kube-proxy支持 iptables 和 ipvs 两种模式， 在kubernetes v1.8 中引入了 ipvs 模式，在 v1.9 中处于 beta 阶段，在 v1.11 中已经正式可用了。iptables 模式在 v1.1 中就添加支持了，从 v1.2 版本开始 iptables 就是 kube-proxy 默认的操作模式，ipvs 和 iptables 都是基于netfilter的，但是ipvs采用的是hash表，因此当service数量达到一定规模时，hash查表的速度优势就会显现出来，从而提高service的服务性能。那么 ipvs 模式和 iptables 模式之间有哪些差异呢？1、ipvs 为大型集群提供了更好的可扩展性和性能2、ipvs 支持比 iptables 更复杂的复制均衡算法（最小负载、最少连接、加权等等）3、ipvs 支持服务器健康检查和连接重试等功能 1.13 安装基础软件包 - centos07-12&#x2F;22&#x2F;421yum install -y device-mapper-persistent-data lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel python-devel epel-release openssh-server socat ipvsadm conntrack telnet ipvsadm 1.14 安装iptables - centos07-12&#x2F;22&#x2F;42如果用firewalld不习惯，可以安装iptables ，在centos07-12&#x2F;22&#x2F;42上操作：安装iptables 1yum install iptables-services -y 禁用iptables 1service iptables stop &amp;&amp; systemctl disable iptables 清空防火墙规则 1iptables -F 1.15 如果是虚拟机，最好在这里做个镜像2 安装docker服务2.1 安装docker-ce - centos07-12&#x2F;22&#x2F;421yum install docker-ce -y 1systemctl start docker &amp;&amp; systemctl enable docker.service 2.2 配置docker镜像加速器和驱动 - centos07-12&#x2F;22&#x2F;42123456vim /etc/docker/daemon.json &#123; &quot;registry-mirrors&quot;: [&quot;https://882k7j67.mirror.aliyuncs.com&quot;], &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]&#125; “exec-opts”: [“native.cgroupdriver&#x3D;systemd”] # 这里是驱动，需要和kubelet保持一致 1systemctl daemon-reload &amp;&amp; systemctl restart docker 1234567891011121314151617181920212223systemctl status docker● docker.service - Docker Application Container Engine Loaded: loaded (/usr/lib/systemd/system/docker.service; enabled; vendor preset: disabled) Active: active (running) since 日 2023-12-24 22:06:40 CST; 14s ago Docs: https://docs.docker.com Main PID: 2385 (dockerd) Tasks: 10 Memory: 31.4M CGroup: /system.slice/docker.service └─2385 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock12月 24 22:06:39 centos07-12 systemd[1]: Starting Docker Application Container Engine...12月 24 22:06:39 centos07-12 dockerd[2385]: time=&quot;2023-12-24T22:06:39.812530553+08:00&quot; level=info msg=&quot;Starting up&quot;12月 24 22:06:39 centos07-12 dockerd[2385]: time=&quot;2023-12-24T22:06:39.866392448+08:00&quot; level=info msg=&quot;[graphdriver] using prior sto...erlay2&quot;12月 24 22:06:39 centos07-12 dockerd[2385]: time=&quot;2023-12-24T22:06:39.866862764+08:00&quot; level=info msg=&quot;Loading containers: start.&quot;12月 24 22:06:40 centos07-12 dockerd[2385]: time=&quot;2023-12-24T22:06:40.062510212+08:00&quot; level=info msg=&quot;Default bridge (docker0) is a...ddress&quot;12月 24 22:06:40 centos07-12 dockerd[2385]: time=&quot;2023-12-24T22:06:40.138470653+08:00&quot; level=info msg=&quot;Loading containers: done.&quot;12月 24 22:06:40 centos07-12 dockerd[2385]: time=&quot;2023-12-24T22:06:40.169504423+08:00&quot; level=info msg=&quot;Docker daemon&quot; commit=311b9ff...=24.0.712月 24 22:06:40 centos07-12 dockerd[2385]: time=&quot;2023-12-24T22:06:40.169742710+08:00&quot; level=info msg=&quot;Daemon has completed initialization&quot;12月 24 22:06:40 centos07-12 dockerd[2385]: time=&quot;2023-12-24T22:06:40.204093714+08:00&quot; level=info msg=&quot;API listen on /run/docker.sock&quot;12月 24 22:06:40 centos07-12 systemd[1]: Started Docker Application Container Engine.Hint: Some lines were ellipsized, use -l to show in full. 3 安装初始化k8s需要的软件包 - centos07-12&#x2F;22&#x2F;421yum install -y kubelet-1.23.1 kubeadm-1.23.1 kubectl-1.23.1 1systemctl enable kubelet 注：每个软件包的作用Kubeadm: kubeadm是一个工具，用来初始化k8s集群的kubelet: 安装在集群所有节点上，用于启动Pod的kubectl: 通过kubectl可以部署和管理应用，查看各种资源，创建、删除和更新各种组件 4 kubeadm初始化k8s集群 - centos07-12&#x2F;22&#x2F;42把初始化k8s集群需要的离线镜像包上传到 - centos07-12&#x2F;22&#x2F;42 机器上，手动解压： - centos07-12&#x2F;22&#x2F;42 1docker load -i k8s-images-v1.23.1.tar.gz 使用kubeadm初始化k8s集群 - centos07-12设置podSubnet（pod网段）： –pod-network-cidr&#x3D;10.244.0.0&#x2F;16 1kubeadm init --kubernetes-version=1.23.1 --apiserver-advertise-address=192.168.1.12 --image-repository registry.aliyuncs.com/google_containers --pod-network-cidr=10.244.0.0/16 --ignore-preflight-errors=SystemVerification 注：–image-repository registry.aliyuncs.com&#x2F;google_containers：手动指定仓库地址为registry.aliyuncs.com&#x2F;google_containers。 kubeadm默认从k8s.grc.io拉取镜像，但是k8s.gcr.io访问不到，所以需要指定从registry.aliyuncs.com&#x2F;google_containers仓库拉取镜像。显示如下，说明安装完成： 1kubeadm join 192.168.1.12:6443 --token ukaoml.lucdcifuerdxhn1a --discovery-token-ca-cert-hash sha256:c18a369a3d959457249b743d31c9891d8647665471840714e02689f11203724f 上面命令是把node节点加入集群，需要保存下来，每个人的都不一样 配置kubectl的配置文件config，相当于对kubectl进行授权，这样kubectl命令可以使用这个证书对 k8s集群进行管理 123mkdir -p $HOME/.kubesudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/configsudo chown $(id -u):$(id -g) $HOME/.kube/config 1234kubectl get nodesNAME STATUS ROLES AGE VERSIONcentos07-12 NotReady control-plane,master 4m30s v1.23.1 此时集群状态还是NotReady状态，因为没有安装网络插件 5 扩容k8s集群-添加第一个工作节点 - centos07-22在centos07-12上查看加入节点的命令： - centos07-12 123kubeadm token create --print-join-commandkubeadm join 192.168.1.12:6443 --token qjcaxe.domcre9fi3h0bfg0 --discovery-token-ca-cert-hash sha256:c18a369a3d959457249b743d31c9891d8647665471840714e02689f11203724f 把centos07-22加入k8s集群： 1kubeadm join 192.168.1.12:6443 --token qjcaxe.domcre9fi3h0bfg0 --discovery-token-ca-cert-hash sha256:c18a369a3d959457249b743d31c9891d8647665471840714e02689f11203724f 1234567891011121314151617[root@centos07-22 ~]# kubeadm join 192.168.1.12:6443 --token qjcaxe.domcre9fi3h0bfg0 --discovery-token-ca-cert-hash sha256:c18a369a3d959457249b743d31c9891d8647665471840714e02689f11203724f[preflight] Running pre-flight checks [WARNING SystemVerification]: this Docker version is not on the list of validated versions: 24.0.7. Latest validated version: 20.10 [WARNING Service-Kubelet]: kubelet service is not enabled, please run &#x27;systemctl enable kubelet.service&#x27;[preflight] Reading configuration from the cluster...[preflight] FYI: You can look at this config file with &#x27;kubectl -n kube-system get cm kubeadm-config -o yaml&#x27;[kubelet-start] Writing kubelet configuration to file &quot;/var/lib/kubelet/config.yaml&quot;[kubelet-start] Writing kubelet environment file with flags to file &quot;/var/lib/kubelet/kubeadm-flags.env&quot;[kubelet-start] Starting the kubelet[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...This node has joined the cluster:* Certificate signing request was sent to apiserver and a response was received.* The Kubelet was informed of the new secure connection details.Run &#x27;kubectl get nodes&#x27; on the control-plane to see this node join the cluster. 在centos07-12上查看集群节点状况： 1234[root@centos07-12 ~]# kubectl get nodes -owideNAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIMEcentos07-12 NotReady control-plane,master 12m v1.23.1 192.168.1.12 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 docker://24.0.7centos07-22 NotReady &lt;none&gt; 5m18s v1.23.1 192.168.1.22 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 docker://24.0.7 6 扩容k8s集群-添加第一个工作节点 - centos07-42在centos07-12上查看加入节点的命令： - centos07-12 123kubeadm token create --print-join-commandkubeadm join 192.168.1.12:6443 --token qjcaxe.domcre9fi3h0bfg0 --discovery-token-ca-cert-hash sha256:c18a369a3d959457249b743d31c9891d8647665471840714e02689f11203724f 把centos07-42加入k8s集群： 1kubeadm join 192.168.1.12:6443 --token qjcaxe.domcre9fi3h0bfg0 --discovery-token-ca-cert-hash sha256:c18a369a3d959457249b743d31c9891d8647665471840714e02689f11203724f 12345678910111213141516[root@centos07-42 ~]# kubeadm join 192.168.1.12:6443 --token qjcaxe.domcre9fi3h0bfg0 --discovery-token-ca-cert-hash sha256:c18a369a3d959457249b743d31c9891d8647665471840714e02689f11203724f[preflight] Running pre-flight checks [WARNING SystemVerification]: this Docker version is not on the list of validated versions: 24.0.7. Latest validated version: 20.10[preflight] Reading configuration from the cluster...[preflight] FYI: You can look at this config file with &#x27;kubectl -n kube-system get cm kubeadm-config -o yaml&#x27;[kubelet-start] Writing kubelet configuration to file &quot;/var/lib/kubelet/config.yaml&quot;[kubelet-start] Writing kubelet environment file with flags to file &quot;/var/lib/kubelet/kubeadm-flags.env&quot;[kubelet-start] Starting the kubelet[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...This node has joined the cluster:* Certificate signing request was sent to apiserver and a response was received.* The Kubelet was informed of the new secure connection details.Run &#x27;kubectl get nodes&#x27; on the control-plane to see this node join the cluster. 在centos07-12上查看集群节点状况： 12345[root@centos07-12 ~]# kubectl get nodes -owideNAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIMEcentos07-12 NotReady control-plane,master 14m v1.23.1 192.168.1.12 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 docker://24.0.7centos07-22 NotReady &lt;none&gt; 7m36s v1.23.1 192.168.1.22 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 docker://24.0.7centos07-42 NotReady &lt;none&gt; 30s v1.23.1 192.168.1.42 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 docker://24.0.7 7 role角色改为work - centos07-12可以看到centos07-22&#x2F;42的ROLES角色为空，就表示这个节点是工作节点。 12345[root@centos07-12 ~]# kubectl get nodes -owideNAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIMEcentos07-12 NotReady control-plane,master 15m v1.23.1 192.168.1.12 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 docker://24.0.7centos07-22 NotReady &lt;none&gt; 8m51s v1.23.1 192.168.1.22 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 docker://24.0.7centos07-42 NotReady &lt;none&gt; 105s v1.23.1 192.168.1.42 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 docker://24.0.7 可以把centos07-22&#x2F;42的ROLES变成work，按照如下方法： 12kubectl label node centos07-22 node-role.kubernetes.io/worker=workerkubectl label node centos07-42 node-role.kubernetes.io/worker=worker 12345[root@centos07-12 ~]# kubectl get nodes -owideNAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIMEcentos07-12 NotReady control-plane,master 16m v1.23.1 192.168.1.12 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 docker://24.0.7centos07-22 NotReady worker 9m46s v1.23.1 192.168.1.22 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 docker://24.0.7centos07-42 NotReady worker 2m40s v1.23.1 192.168.1.42 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 docker://24.0.7 注意：上面状态都是NotReady状态，说明没有安装网络插件 8 安装kubernetes网络组件-Calico - centos07-12上传calico.yaml到centos07-12上，使用yaml文件安装calico 网络插件添加以下内容： 1234vim calico.yaml - name: IP_AUTODETECTION_METHOD value: &quot;interface=enp0s3&quot; 1kubectl apply -f calico.yaml 注：在线下载配置文件地址是： https://docs.projectcalico.org/manifests/calico.yaml 1234567891011121314151617 kubectl get pod -n kube-system NAME READY STATUS RESTARTS AGEcalico-kube-controllers-677cd97c8d-j2782 0/1 Running 0 60scalico-node-hs9h5 1/1 Running 0 60scalico-node-pt9md 0/1 Running 0 60scalico-node-xddmf 0/1 Running 0 60scoredns-6d8c4cb4d-dgw22 1/1 Running 0 40mcoredns-6d8c4cb4d-j4c6b 1/1 Running 0 40metcd-centos07-12 1/1 Running 0 41mkube-apiserver-centos07-12 1/1 Running 0 41mkube-controller-manager-centos07-12 1/1 Running 0 41mkube-proxy-4nx9c 1/1 Running 0 34mkube-proxy-v87c6 1/1 Running 0 40mkube-proxy-v9lx5 1/1 Running 0 26mkube-scheduler-centos07-12 1/1 Running 0 41m 再次查看集群状态 12345[root@centos07-12 ~]# kubectl get nodes -owideNAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIMEcentos07-12 Ready control-plane,master 46m v1.23.1 192.168.1.12 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 docker://24.0.7centos07-22 Ready worker 39m v1.23.1 192.168.1.22 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 docker://24.0.7centos07-42 Ready worker 32m v1.23.1 192.168.1.42 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 docker://24.0.7 STATUS状态是Ready，说明k8s集群正常运行了 9 测试在k8s创建pod是否可以正常访问网络 - - centos07-12把busybox-1-28.tar.gz上传到centos07-22、42节点，手动解压 - centos07-22&#x2F;42 12scp busybox-1-28.tar.gz root@192.168.1.22:~scp busybox-1-28.tar.gz root@192.168.1.42:~ 1docker load -i busybox-1-28.tar.gz 123456789101112131415docker imagesREPOSITORY TAG IMAGE ID CREATED SIZEregistry.aliyuncs.com/google_containers/kube-apiserver v1.23.1 b6d7abedde39 2 years ago 135MBregistry.aliyuncs.com/google_containers/kube-proxy v1.23.1 b46c42588d51 2 years ago 112MBregistry.aliyuncs.com/google_containers/kube-scheduler v1.23.1 71d575efe628 2 years ago 53.5MBregistry.aliyuncs.com/google_containers/kube-controller-manager v1.23.1 f51846a4fd28 2 years ago 125MBregistry.aliyuncs.com/google_containers/etcd 3.5.1-0 25f8c7f3da61 2 years ago 293MBregistry.aliyuncs.com/google_containers/coredns v1.8.6 a4ca41631cc7 2 years ago 46.8MBregistry.aliyuncs.com/google_containers/pause 3.6 6270bb605e12 2 years ago 683kBcalico/pod2daemon-flexvol v3.18.0 2a22066e9588 2 years ago 21.7MBcalico/node v3.18.0 5a7c4970fbc2 2 years ago 172MBcalico/cni v3.18.0 727de170e4ce 2 years ago 131MBcalico/kube-controllers v3.18.0 9a154323fbf7 2 years ago 53.4MBbusybox 1.28 8c811b4aec35 5 years ago 1.15MB 123456789[root@centos07-12 ~]# kubectl run busybox --image busybox:1.28 --restart=Never --rm -it busybox -- shIf you don&#x27;t see a command prompt, try pressing enter./ # ping www.baidu.comPING www.baidu.com (39.156.66.14): 56 data bytes64 bytes from 39.156.66.14: seq=0 ttl=61 time=7.895 ms64 bytes from 39.156.66.14: seq=1 ttl=61 time=7.726 ms--- www.baidu.com ping statistics ---2 packets transmitted, 2 packets received, 0% packet lossround-trip min/avg/max = 7.726/7.810/7.895 ms 通过上面可以看到能访问网络，说明calico网络插件已经被正常安装了 1.9 测试coredns是否正常123456789[root@centos07-12 ~]# kubectl run busybox --image busybox:1.28 --restart=Never --rm -it busybox -- shIf you don&#x27;t see a command prompt, try pressing enter./ # nslookup kubernetes.default.svc.cluster.localServer: 10.96.0.10Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.localName: kubernetes.default.svc.cluster.localAddress 1: 10.96.0.1 kubernetes.default.svc.cluster.local/ # 10.96.0.10 就是我们coreDNS的clusterIP，说明coreDNS配置好了。解析内部Service的名称，是通过coreDNS去解析的。 注意：busybox要用指定的1.28版本，不能用最新版本，最新版本，nslookup会解析不到dns和ip","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"项目汇总","slug":"运维/K8S/项目汇总","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E9%A1%B9%E7%9B%AE%E6%B1%87%E6%80%BB/"}],"tags":[]},{"title":"42-Service四层代理","slug":"运维/K8S/基础/42-Service四层代理","date":"2023-05-17T23:00:00.000Z","updated":"2024-02-02T09:03:52.000Z","comments":true,"path":"2023/05/18/运维/K8S/基础/42-Service四层代理/","link":"","permalink":"https://dbbruce.github.io/2023/05/18/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/42-Service%E5%9B%9B%E5%B1%82%E4%BB%A3%E7%90%86/","excerpt":"","text":"关键字：service 1、切换集群：kubectl config use-context 集群名12345678910111213141516171819202122232425[root@centos07-12 .kube]# vim /root/.kube/configapiVersion: v1clusters:- cluster: certificate-authority-data: LS0tLS1CRUdJTiB... server: https://192.168.1.12:6443 name: kubernetescontexts:- context: cluster: kubernetes user: kubernetes-admin name: kubernetes-admin@kubernetescurrent-context: kubernetes-admin@kuberneteskind: Configpreferences: &#123;&#125;users:- name: kubernetes-admin user: client-certificate-data: LS0tLS1CRUdJTi... client-key-data: LS0tLS1CRUdJTiBSU0EgU...kubernetes-admin@kubernetes[root@centos07-12 .kube]# kubectl config use-context kubernetes-admin@kubernetesSwitched to context &quot;kubernetes-admin@kubernetes&quot;. 2、题目12345678910考题：设置配置环境：[student@node-1] $ kubectl config use-context k8sTask重新配置一个已经存在的 front-end 的 deployment，在名字为 nginx 的容器里面添加一个端口配置，名字为 http，暴露端口号为 80，然后创建一个 service，名字为 front-end-svc，暴露该 deployment的 http 端口，并且 service 的类型为 NodePort。 0、自己创建2个命名空间和打一个标签，考试时不需要12345678910111213141516171819202122232425[root@centos07-12 ~]# kubectl get ns --show-labelsNAME STATUS AGE LABELSdefault Active 39d kubernetes.io/metadata.name=defaultkube-node-lease Active 39d kubernetes.io/metadata.name=kube-node-leasekube-public Active 39d kubernetes.io/metadata.name=kube-publickube-system Active 39d kubernetes.io/metadata.name=kube-system[root@centos07-12 ~]# kubectl create ns my-appnamespace/my-app created[root@centos07-12 ~]# kubectl create ns echonamespace/echo created[root@centos07-12 ~]# kubectl label ns echo project=echonamespace/echo labeled[root@centos07-12 ~]# kubectl get ns --show-labelsNAME STATUS AGE LABELSdefault Active 39d kubernetes.io/metadata.name=defaultecho Active 30s kubernetes.io/metadata.name=echo,project=echo # 注意这里，标签，project=echo,后期会用到，如果没有自己手动打一个标签kube-node-lease Active 39d kubernetes.io/metadata.name=kube-node-leasekube-public Active 39d kubernetes.io/metadata.name=kube-publickube-system Active 39d kubernetes.io/metadata.name=kube-systemmy-app Active 35s kubernetes.io/metadata.name=my-app 1、vim networkpolicy.yaml; :set paste,防止格式错乱;复制官网的例子123456789101112131415161718192021222324252627282930313233343536# vim networkpolicy.yamlapiVersion: networking.k8s.io/v1kind: NetworkPolicymetadata: name: allow-port-from-namespace # 修改名称 namespace: my-app # 生效的命名空间spec: podSelector: matchLabels: &#123;&#125; # 添加&#123;&#125; # role: db # 删除 policyTypes: - Ingress # - Egress # 删除 ingress: # - from: # - ipBlock: # 删除 # cidr: 172.17.0.0/16 # 删除 # except: # 删除 # - 172.17.1.0/24 # 删除 - namespaceSelector: matchLabels: project: echo # 运行方法，使用命名空间echo的标签 # - podSelector: # 删除 # matchLabels: # 删除 # role: frontend # 删除 ports: - protocol: TCP port: 9000 # 9000端口 # egress: # 删除 # - to: # 删除 # - ipBlock: # 删除 # cidr: 10.0.0.0/24 # 删除 # ports: # 删除 # - protocol: TCP # 删除 # port: 5978 # 删除","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"41-networkpolicy网络策略","slug":"运维/K8S/基础/41-networkpolicy网络策略","date":"2023-05-17T22:00:00.000Z","updated":"2024-02-02T04:44:50.000Z","comments":true,"path":"2023/05/18/运维/K8S/基础/41-networkpolicy网络策略/","link":"","permalink":"https://dbbruce.github.io/2023/05/18/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/41-networkpolicy%E7%BD%91%E7%BB%9C%E7%AD%96%E7%95%A5/","excerpt":"","text":"关键字：networkpolicy 1、切换集群：kubectl config use-context 集群名12345678910111213141516171819202122232425[root@centos07-12 .kube]# vim /root/.kube/configapiVersion: v1clusters:- cluster: certificate-authority-data: LS0tLS1CRUdJTiB... server: https://192.168.1.12:6443 name: kubernetescontexts:- context: cluster: kubernetes user: kubernetes-admin name: kubernetes-admin@kubernetescurrent-context: kubernetes-admin@kuberneteskind: Configpreferences: &#123;&#125;users:- name: kubernetes-admin user: client-certificate-data: LS0tLS1CRUdJTi... client-key-data: LS0tLS1CRUdJTiBSU0EgU...kubernetes-admin@kubernetes[root@centos07-12 .kube]# kubectl config use-context kubernetes-admin@kubernetesSwitched to context &quot;kubernetes-admin@kubernetes&quot;. 2、题目123456789101112考题：设置配置环境：[student@node-1] $ kubectl config use-context hk8sTask在现有的namespace my-app中创建一个名为allow-port-from-namespace的新NetworkPolicy。确保新的NetworkPolicy允许namespace echo中的Pods连接到namespace my-app中的Pods的9000端口。进一步确保新的 NetworkPolicy：不允许对没有在监听端口 9000 的 Pods 的访问不允许非来自 namespace echo 中的 Pods 的访问 0、自己创建2个命名空间和打一个标签，考试时不需要12345678910111213141516171819202122232425[root@centos07-12 ~]# kubectl get ns --show-labelsNAME STATUS AGE LABELSdefault Active 39d kubernetes.io/metadata.name=defaultkube-node-lease Active 39d kubernetes.io/metadata.name=kube-node-leasekube-public Active 39d kubernetes.io/metadata.name=kube-publickube-system Active 39d kubernetes.io/metadata.name=kube-system[root@centos07-12 ~]# kubectl create ns my-appnamespace/my-app created[root@centos07-12 ~]# kubectl create ns echonamespace/echo created[root@centos07-12 ~]# kubectl label ns echo project=echonamespace/echo labeled[root@centos07-12 ~]# kubectl get ns --show-labelsNAME STATUS AGE LABELSdefault Active 39d kubernetes.io/metadata.name=defaultecho Active 30s kubernetes.io/metadata.name=echo,project=echo # 注意这里，标签，project=echo,后期会用到，如果没有自己手动打一个标签kube-node-lease Active 39d kubernetes.io/metadata.name=kube-node-leasekube-public Active 39d kubernetes.io/metadata.name=kube-publickube-system Active 39d kubernetes.io/metadata.name=kube-systemmy-app Active 35s kubernetes.io/metadata.name=my-app 1、vim networkpolicy.yaml; :set paste,防止格式错乱;复制官网的例子123456789101112131415161718192021222324252627282930313233343536# vim networkpolicy.yamlapiVersion: networking.k8s.io/v1kind: NetworkPolicymetadata: name: allow-port-from-namespace # 修改名称 namespace: my-app # 生效的命名空间spec: podSelector: matchLabels: &#123;&#125; # 添加&#123;&#125; # role: db # 删除 policyTypes: - Ingress # - Egress # 删除 ingress: # - from: # - ipBlock: # 删除 # cidr: 172.17.0.0/16 # 删除 # except: # 删除 # - 172.17.1.0/24 # 删除 - namespaceSelector: matchLabels: project: echo # 运行方法，使用命名空间echo的标签 # - podSelector: # 删除 # matchLabels: # 删除 # role: frontend # 删除 ports: - protocol: TCP port: 9000 # 9000端口 # egress: # 删除 # - to: # 删除 # - ipBlock: # 删除 # cidr: 10.0.0.0/24 # 删除 # ports: # 删除 # - protocol: TCP # 删除 # port: 5978 # 删除 12[root@centos07-12 ~]# kubectl apply -f networkpolicy.yamlnetworkpolicy.networking.k8s.io/test-network-policy created","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"40-etcd备份还原","slug":"运维/K8S/基础/40-etcd备份还原","date":"2023-05-17T21:00:00.000Z","updated":"2024-02-02T03:53:09.000Z","comments":true,"path":"2023/05/18/运维/K8S/基础/40-etcd备份还原/","link":"","permalink":"https://dbbruce.github.io/2023/05/18/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/40-etcd%E5%A4%87%E4%BB%BD%E8%BF%98%E5%8E%9F/","excerpt":"","text":"关键字：upgrade-etcd 1、题目1234567891011121314151617Task：首先，为运行在 https://127.0.0.1:2379 上的现有 etcd 实例创建快照并将快照保存到 /srv/data/etcd-snapshot.db 文件为给定实例创建快照预计能在几秒钟内完成。 如果该操作似乎挂起，则命令可能有问题。用 CTRL + C 来取消操作，然后重试。然后还原位于/var/lib/backup/etcd-snapshot-previous.db 的现有先前快照。提供了以下 TLS 证书和密钥，以通过 etcdctl 连接到服务器。CA 证书: /opt/KUIN00601/ca.crt客户端证书: /opt/KUIN00601/etcd-client.crt客户端密钥: /opt/KUIN00601/etcd-client.key考点： etcd 的备份和还原命令解题：确认一下 ssh 终端，是在[student@node-1] $ 下 0、自己环境的证书 12345678910[root@centos07-12 etcd]# ll /etc/kubernetes/pki/etcd总用量 32-rw-r--r-- 1 root root 1086 12月 24 22:34 ca.crt-rw------- 1 root root 1675 12月 24 22:34 ca.key-rw-r--r-- 1 root root 1159 12月 24 22:34 healthcheck-client.crt-rw------- 1 root root 1675 12月 24 22:34 healthcheck-client.key-rw-r--r-- 1 root root 1204 12月 24 22:34 peer.crt-rw------- 1 root root 1679 12月 24 22:34 peer.key-rw-r--r-- 1 root root 1204 12月 24 22:34 server.crt-rw------- 1 root root 1675 12月 24 22:34 server.key 1、使用 etcdctl 选项的快照 – 关键字：snapshot save 123mkdir /srv/data/ -pexport ETCDCTL_API=3 123456789[root@centos07-12 ~]# sudo ETCDCTL_API=3 etcdctl --endpoints=https://127.0.0.1:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key snapshot save /srv/data/etcd-snapshot.db&#123;&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1706844905.770798,&quot;caller&quot;:&quot;snapshot/v3_snapshot.go:119&quot;,&quot;msg&quot;:&quot;created temporary db file&quot;,&quot;path&quot;:&quot;/srv/data/etcd-snapshot.db.part&quot;&#125;&#123;&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:&quot;2024-02-02T11:35:05.782+0800&quot;,&quot;caller&quot;:&quot;clientv3/maintenance.go:200&quot;,&quot;msg&quot;:&quot;opened snapshot stream; downloading&quot;&#125;&#123;&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1706844905.7827845,&quot;caller&quot;:&quot;snapshot/v3_snapshot.go:127&quot;,&quot;msg&quot;:&quot;fetching snapshot&quot;,&quot;endpoint&quot;:&quot;https://127.0.0.1:2379&quot;&#125;&#123;&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:&quot;2024-02-02T11:35:05.865+0800&quot;,&quot;caller&quot;:&quot;clientv3/maintenance.go:208&quot;,&quot;msg&quot;:&quot;completed snapshot read; closing&quot;&#125;&#123;&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1706844905.8859088,&quot;caller&quot;:&quot;snapshot/v3_snapshot.go:142&quot;,&quot;msg&quot;:&quot;fetched snapshot&quot;,&quot;endpoint&quot;:&quot;https://127.0.0.1:2379&quot;,&quot;size&quot;:&quot;4.0 MB&quot;,&quot;took&quot;:0.114535755&#125;&#123;&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1706844905.88601,&quot;caller&quot;:&quot;snapshot/v3_snapshot.go:152&quot;,&quot;msg&quot;:&quot;saved&quot;,&quot;path&quot;:&quot;/srv/data/etcd-snapshot.db&quot;&#125;Snapshot saved at /srv/data/etcd-snapshot.db 123[root@centos07-12 ~]# ll /srv/data/总用量 3940-rw------- 1 root root 4030496 2月 2 11:35 etcd-snapshot.db 2、恢复 etcd 集群 – 关键字：snapshot restore 1234567[root@centos07-12 ~]# sudo ETCDCTL_API=3 etcdctl --endpoints=https://127.0.0.1:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key snapshot restore /srv/data/etcd-snapshot.db&#123;&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1706845867.4458947,&quot;caller&quot;:&quot;snapshot/v3_snapshot.go:296&quot;,&quot;msg&quot;:&quot;restoring snapshot&quot;,&quot;path&quot;:&quot;/srv/data/etcd-snapshot.db&quot;,&quot;wal-dir&quot;:&quot;default.etcd/member/wal&quot;,&quot;data-dir&quot;:&quot;default.etcd&quot;,&quot;snap-dir&quot;:&quot;default.etcd/member/snap&quot;&#125;&#123;&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1706845867.498151,&quot;caller&quot;:&quot;mvcc/kvstore.go:380&quot;,&quot;msg&quot;:&quot;restored last compact revision&quot;,&quot;meta-bucket-name&quot;:&quot;meta&quot;,&quot;meta-bucket-name-key&quot;:&quot;finishedCompactRev&quot;,&quot;restored-compact-revision&quot;:72278&#125;&#123;&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1706845867.5096366,&quot;caller&quot;:&quot;membership/cluster.go:392&quot;,&quot;msg&quot;:&quot;added member&quot;,&quot;cluster-id&quot;:&quot;cdf818194e3a8c32&quot;,&quot;local-member-id&quot;:&quot;0&quot;,&quot;added-peer-id&quot;:&quot;8e9e05c52164694d&quot;,&quot;added-peer-peer-urls&quot;:[&quot;http://localhost:2380&quot;]&#125;&#123;&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1706845867.5236795,&quot;caller&quot;:&quot;snapshot/v3_snapshot.go:309&quot;,&quot;msg&quot;:&quot;restored snapshot&quot;,&quot;path&quot;:&quot;/srv/data/etcd-snapshot.db&quot;,&quot;wal-dir&quot;:&quot;default.etcd/member/wal&quot;,&quot;data-dir&quot;:&quot;default.etcd&quot;,&quot;snap-dir&quot;:&quot;default.etcd/member/snap&quot;&#125;","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"39-安装etcdctl命令","slug":"运维/K8S/基础/39-安装etcdctl命令","date":"2023-05-17T20:00:00.000Z","updated":"2024-02-02T03:08:26.000Z","comments":true,"path":"2023/05/18/运维/K8S/基础/39-安装etcdctl命令/","link":"","permalink":"https://dbbruce.github.io/2023/05/18/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/39-%E5%AE%89%E8%A3%85etcdctl%E5%91%BD%E4%BB%A4/","excerpt":"","text":"上传解压软件包12345scp etcd-v3.4.13-linux-amd64.tar.gz root@192.168.1.12:~tar xvf etcd-v3.4.13-linux-amd64.tar.gzcp etcd-v3.4.13-linux-amd64/etcdctl /usr/bin/ 测试命令1234567891011121314151617181920[root@centos07-12 ~]# etcdctlNAME: etcdctl - A simple command line client for etcd3.USAGE: etcdctl [flags]VERSION: 3.4.13API VERSION: 3.4COMMANDS: alarm disarm Disarms all alarms alarm list Lists all alarms auth disable Disables authentication auth enable Enables authentication","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"38-k8s版本升级-ubuntu版本","slug":"运维/K8S/基础/38-k8s版本升级-ubuntu版本","date":"2023-05-17T19:00:00.000Z","updated":"2024-01-30T11:38:16.000Z","comments":true,"path":"2023/05/18/运维/K8S/基础/38-k8s版本升级-ubuntu版本/","link":"","permalink":"https://dbbruce.github.io/2023/05/18/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/38-k8s%E7%89%88%E6%9C%AC%E5%8D%87%E7%BA%A7-ubuntu%E7%89%88%E6%9C%AC/","excerpt":"","text":"关键字：kubeadm-upgrade 1、切换集群：kubectl config use-context 集群名12345678910111213141516171819202122232425[root@centos07-12 .kube]# vim /root/.kube/configapiVersion: v1clusters:- cluster: certificate-authority-data: LS0tLS1CRUdJTiB... server: https://192.168.1.12:6443 name: kubernetescontexts:- context: cluster: kubernetes user: kubernetes-admin name: kubernetes-admin@kubernetescurrent-context: kubernetes-admin@kuberneteskind: Configpreferences: &#123;&#125;users:- name: kubernetes-admin user: client-certificate-data: LS0tLS1CRUdJTi... client-key-data: LS0tLS1CRUdJTiBSU0EgU...kubernetes-admin@kubernetes[root@centos07-12 .kube]# kubectl config use-context kubernetes-admin@kubernetesSwitched to context &quot;kubernetes-admin@kubernetes&quot;. 2、题目 1、查看全部nodes123456kubectl get nodesNAME STATUS ROLES AGE VERSIONcentos07-12 Ready control-plane,master 36d v1.23.1centos07-22 Ready worker 36d v1.23.1centos07-42 Ready worker 36d v1.23.1 2、设置master不可以调度 - 查考文档12345678910[root@centos07-12 ~]# kubectl cordon centos07-12node/centos07-12 cordoned[root@centos07-12 ~]# kubectl get nodesNAME STATUS ROLES AGE VERSIONcentos07-12 Ready,SchedulingDisabled control-plane,master 36d v1.23.1centos07-22 Ready worker 36d v1.23.1centos07-42 Ready worker 36d v1.23.1kubectl cordon centos07-12 3、驱逐master上的pods - 查看 kubectl drain centos07-12 –help123456789kubectl drain centos07-12 --delete-emptydir-data --ignore-daemonsets --forcenode/centos07-12 already cordonedWARNING: ignoring DaemonSet-managed Pods: kube-system/calico-node-shmqp, kube-system/kube-proxy-v87c6evicting pod kube-system/coredns-6d8c4cb4d-vd2p5evicting pod kube-system/calico-kube-controllers-677cd97c8d-bdrmfpod/calico-kube-controllers-677cd97c8d-bdrmf evictedpod/coredns-6d8c4cb4d-vd2p5 evictednode/centos07-12 drained 4、确定要升级到1.23.2版本1apt-cache show kubeadm |grep 1.23.2 5、更新下系统源1apt-get update 6、升级控制平面节点1apt-get install -y kubeadm=1.23.2-00 7、验证下载操作正常，并且 kubeadm 版本正确1kubeadm version 8、验证升级计划1kubeadm upgrade plan 9、选择要升级到的目标版本，运行合适的命令，题目etcd不升级1sudo kubeadm upgrade apply v1.23.2 --etcd-upgrade=false 10、升级kubelet kubectl1apt-get install -y kubelet=1.23.2-00 kubectl=1.23.2-00 11、重启 kubelet12sudo systemctl daemon-reloadsudo systemctl restart kubelet 12、解除节点的保护 1kubectl uncordon centos07-12 12、查看下版本12kubelet --versionkubectl version","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"37-节点维护-指定node节点不可用","slug":"运维/K8S/基础/37-节点维护-指定node节点不可用","date":"2023-05-17T18:00:00.000Z","updated":"2024-01-30T07:29:54.000Z","comments":true,"path":"2023/05/18/运维/K8S/基础/37-节点维护-指定node节点不可用/","link":"","permalink":"https://dbbruce.github.io/2023/05/18/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/37-%E8%8A%82%E7%82%B9%E7%BB%B4%E6%8A%A4-%E6%8C%87%E5%AE%9Anode%E8%8A%82%E7%82%B9%E4%B8%8D%E5%8F%AF%E7%94%A8/","excerpt":"","text":"关键字：node节点不可用 - drain-node 1、切换集群：kubectl config use-context 集群名12345678910111213141516171819202122232425[root@centos07-12 .kube]# vim /root/.kube/configapiVersion: v1clusters:- cluster: certificate-authority-data: LS0tLS1CRUdJTiB... server: https://192.168.1.12:6443 name: kubernetescontexts:- context: cluster: kubernetes user: kubernetes-admin name: kubernetes-admin@kubernetescurrent-context: kubernetes-admin@kuberneteskind: Configpreferences: &#123;&#125;users:- name: kubernetes-admin user: client-certificate-data: LS0tLS1CRUdJTi... client-key-data: LS0tLS1CRUdJTiBSU0EgU...kubernetes-admin@kubernetes[root@centos07-12 .kube]# kubectl config use-context kubernetes-admin@kubernetesSwitched to context &quot;kubernetes-admin@kubernetes&quot;. 2、题目 1、查看全部nodes123456kubectl get nodesNAME STATUS ROLES AGE VERSIONcentos07-12 Ready control-plane,master 36d v1.23.1centos07-22 Ready worker 36d v1.23.1centos07-42 Ready worker 36d v1.23.1 2、设置node不可以调度 - 查考文档1234kubectl cordon centos07-42node/centos07-42 cordoned 3、驱逐node上的pods - 查看 kubectl drain centos07-42 –help123kubectl drain centos07-42 --delete-emptydir-data --ignore-daemonsets --forcenode/centos07-42 already cordoned 4、查看哪些pods在nodes12345678910111213141516kubectl get pods -A -owideNAMESPACE NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESkube-system calico-kube-controllers-677cd97c8d-bdrmf 1/1 Running 2 (2d18h ago) 28d 10.244.234.198 centos07-12 &lt;none&gt; &lt;none&gt;kube-system calico-node-l26gm 1/1 Running 1 (2d18h ago) 28d 192.168.1.42 centos07-42 &lt;none&gt; &lt;none&gt;kube-system calico-node-l9mtc 1/1 Running 3 (43h ago) 28d 192.168.1.22 centos07-22 &lt;none&gt; &lt;none&gt;kube-system calico-node-shmqp 1/1 Running 4 (43h ago) 28d 192.168.1.12 centos07-12 &lt;none&gt; &lt;none&gt;kube-system coredns-6d8c4cb4d-h2vl6 1/1 Running 0 33m 10.244.193.129 centos07-22 &lt;none&gt; &lt;none&gt;kube-system coredns-6d8c4cb4d-vd2p5 1/1 Running 2 (2d18h ago) 28d 10.244.234.197 centos07-12 &lt;none&gt; &lt;none&gt;kube-system etcd-centos07-12 1/1 Running 3 (2d18h ago) 36d 192.168.1.12 centos07-12 &lt;none&gt; &lt;none&gt;kube-system kube-apiserver-centos07-12 1/1 Running 3 (2d18h ago) 36d 192.168.1.12 centos07-12 &lt;none&gt; &lt;none&gt;kube-system kube-controller-manager-centos07-12 1/1 Running 3 (2d18h ago) 36d 192.168.1.12 centos07-12 &lt;none&gt; &lt;none&gt;kube-system kube-proxy-4nx9c 1/1 Running 2 (2d18h ago) 36d 192.168.1.22 centos07-22 &lt;none&gt; &lt;none&gt;kube-system kube-proxy-v87c6 1/1 Running 3 (2d18h ago) 36d 192.168.1.12 centos07-12 &lt;none&gt; &lt;none&gt;kube-system kube-proxy-v9lx5 1/1 Running 2 (2d18h ago) 36d 192.168.1.42 centos07-42 &lt;none&gt; &lt;none&gt;kube-system kube-scheduler-centos07-12 1/1 Running 3 (2d18h ago) 36d 192.168.1.12 centos07-12 &lt;none&gt; &lt;none&gt;","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"36-基于角色的访问控制-RBAC","slug":"运维/K8S/基础/36-基于角色的访问控制-RBAC","date":"2023-05-17T17:00:00.000Z","updated":"2024-01-30T06:40:44.000Z","comments":true,"path":"2023/05/18/运维/K8S/基础/36-基于角色的访问控制-RBAC/","link":"","permalink":"https://dbbruce.github.io/2023/05/18/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/36-%E5%9F%BA%E4%BA%8E%E8%A7%92%E8%89%B2%E7%9A%84%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6-RBAC/","excerpt":"","text":"关键字：RBAC 1、切换集群：kubectl config use-context 集群名12345678910111213141516171819202122232425[root@centos07-12 .kube]# vim /root/.kube/configapiVersion: v1clusters:- cluster: certificate-authority-data: LS0tLS1CRUdJTiB... server: https://192.168.1.12:6443 name: kubernetescontexts:- context: cluster: kubernetes user: kubernetes-admin name: kubernetes-admin@kubernetescurrent-context: kubernetes-admin@kuberneteskind: Configpreferences: &#123;&#125;users:- name: kubernetes-admin user: client-certificate-data: LS0tLS1CRUdJTi... client-key-data: LS0tLS1CRUdJTiBSU0EgU...kubernetes-admin@kubernetes[root@centos07-12 .kube]# kubectl config use-context kubernetes-admin@kubernetesSwitched to context &quot;kubernetes-admin@kubernetes&quot;. 2、题目 1、创建cluster role - 查考文档-clusterrole123kubectl create clusterrole deploy-clusterrole --verb=create --resource=deployment,daemonset,statefulset clusterrole.rbac.authorization.k8s.io/deploy-clusterrole created 2、创建SA - 查看 kubectl create sa –help这个考试时，不要管，会有这个app-team1命名空间123kubectl create ns app-team1namespace/app-team1 created 123kubectl create serviceaccount cicd-token -n app-team1serviceaccount/cicd-token created 3、绑定cluserrole和sa - 查考文档-clusterrolebinding注意：题目中写了”限于namespace app-team1”,则创建rolebinding。没写则用clusterrolebinding注意：题目没有给rolebinding名称，名称随意起了，如果给定了要写人家给定的123kubectl create rolebinding cicd-token-binding --clusterrole=deploy-clusterrole --serviceaccount=app-team1:cicd-token --namespace=app-team1rolebinding.rbac.authorization.k8s.io/cicd-token-binding created 4、验证123456789101112kubectl describe rolebinding cicd-token-binding -n app-team1Name: cicd-token-bindingLabels: &lt;none&gt;Annotations: &lt;none&gt;Role: Kind: ClusterRole Name: deploy-clusterroleSubjects: Kind Name Namespace ---- ---- --------- ServiceAccount cicd-token app-team1","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"35-calico文件内容","slug":"运维/K8S/基础/35-calico文件内容","date":"2023-05-17T12:00:00.000Z","updated":"2023-12-24T15:20:11.000Z","comments":true,"path":"2023/05/17/运维/K8S/基础/35-calico文件内容/","link":"","permalink":"https://dbbruce.github.io/2023/05/17/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/35-calico%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9/","excerpt":"","text":"calico.yaml文件1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591601611621631641651661671681691701711721731741751761771781791801811821831841851861871881891901911921931941951961971981992002012022032042052062072082092102112122132142152162172182192202212222232242252262272282292302312322332342352362372382392402412422432442452462472482492502512522532542552562572582592602612622632642652662672682692702712722732742752762772782792802812822832842852862872882892902912922932942952962972982993003013023033043053063073083093103113123133143153163173183193203213223233243253263273283293303313323333343353363373383393403413423433443453463473483493503513523533543553563573583593603613623633643653663673683693703713723733743753763773783793803813823833843853863873883893903913923933943953963973983994004014024034044054064074084094104114124134144154164174184194204214224234244254264274284294304314324334344354364374384394404414424434444454464474484494504514524534544554564574584594604614624634644654664674684694704714724734744754764774784794804814824834844854864874884894904914924934944954964974984995005015025035045055065075085095105115125135145155165175185195205215225235245255265275285295305315325335345355365375385395405415425435445455465475485495505515525535545555565575585595605615625635645655665675685695705715725735745755765775785795805815825835845855865875885895905915925935945955965975985996006016026036046056066076086096106116126136146156166176186196206216226236246256266276286296306316326336346356366376386396406416426436446456466476486496506516526536546556566576586596606616626636646656666676686696706716726736746756766776786796806816826836846856866876886896906916926936946956966976986997007017027037047057067077087097107117127137147157167177187197207217227237247257267277287297307317327337347357367377387397407417427437447457467477487497507517527537547557567577587597607617627637647657667677687697707717727737747757767777787797807817827837847857867877887897907917927937947957967977987998008018028038048058068078088098108118128138148158168178188198208218228238248258268278288298308318328338348358368378388398408418428438448458468478488498508518528538548558568578588598608618628638648658668678688698708718728738748758768778788798808818828838848858868878888898908918928938948958968978988999009019029039049059069079089099109119129139149159169179189199209219229239249259269279289299309319329339349359369379389399409419429439449459469479489499509519529539549559569579589599609619629639649659669679689699709719729739749759769779789799809819829839849859869879889899909919929939949959969979989991000100110021003100410051006100710081009101010111012101310141015101610171018101910201021102210231024102510261027102810291030103110321033103410351036103710381039104010411042104310441045104610471048104910501051105210531054105510561057105810591060106110621063106410651066106710681069107010711072107310741075107610771078107910801081108210831084108510861087108810891090109110921093109410951096109710981099110011011102110311041105110611071108110911101111111211131114111511161117111811191120112111221123112411251126112711281129113011311132113311341135113611371138113911401141114211431144114511461147114811491150115111521153115411551156115711581159116011611162116311641165116611671168116911701171117211731174117511761177117811791180118111821183118411851186118711881189119011911192119311941195119611971198119912001201120212031204120512061207120812091210121112121213121412151216121712181219122012211222122312241225122612271228122912301231123212331234123512361237123812391240124112421243124412451246124712481249125012511252125312541255125612571258125912601261126212631264126512661267126812691270127112721273127412751276127712781279128012811282128312841285128612871288128912901291129212931294129512961297129812991300130113021303130413051306130713081309131013111312131313141315131613171318131913201321132213231324132513261327132813291330133113321333133413351336133713381339134013411342134313441345134613471348134913501351135213531354135513561357135813591360136113621363136413651366136713681369137013711372137313741375137613771378137913801381138213831384138513861387138813891390139113921393139413951396139713981399140014011402140314041405140614071408140914101411141214131414141514161417141814191420142114221423142414251426142714281429143014311432143314341435143614371438143914401441144214431444144514461447144814491450145114521453145414551456145714581459146014611462146314641465146614671468146914701471147214731474147514761477147814791480148114821483148414851486148714881489149014911492149314941495149614971498149915001501150215031504150515061507150815091510151115121513151415151516151715181519152015211522152315241525152615271528152915301531153215331534153515361537153815391540154115421543154415451546154715481549155015511552155315541555155615571558155915601561156215631564156515661567156815691570157115721573157415751576157715781579158015811582158315841585158615871588158915901591159215931594159515961597159815991600160116021603160416051606160716081609161016111612161316141615161616171618161916201621162216231624162516261627162816291630163116321633163416351636163716381639164016411642164316441645164616471648164916501651165216531654165516561657165816591660166116621663166416651666166716681669167016711672167316741675167616771678167916801681168216831684168516861687168816891690169116921693169416951696169716981699170017011702170317041705170617071708170917101711171217131714171517161717171817191720172117221723172417251726172717281729173017311732173317341735173617371738173917401741174217431744174517461747174817491750175117521753175417551756175717581759176017611762176317641765176617671768176917701771177217731774177517761777177817791780178117821783178417851786178717881789179017911792179317941795179617971798179918001801180218031804180518061807180818091810181118121813181418151816181718181819182018211822182318241825182618271828182918301831183218331834183518361837183818391840184118421843184418451846184718481849185018511852185318541855185618571858185918601861186218631864186518661867186818691870187118721873187418751876187718781879188018811882188318841885188618871888188918901891189218931894189518961897189818991900190119021903190419051906190719081909191019111912191319141915191619171918191919201921192219231924192519261927192819291930193119321933193419351936193719381939194019411942194319441945194619471948194919501951195219531954195519561957195819591960196119621963196419651966196719681969197019711972197319741975197619771978197919801981198219831984198519861987198819891990199119921993199419951996199719981999200020012002200320042005200620072008200920102011201220132014201520162017201820192020202120222023202420252026202720282029203020312032203320342035203620372038203920402041204220432044204520462047204820492050205120522053205420552056205720582059206020612062206320642065206620672068206920702071207220732074207520762077207820792080208120822083208420852086208720882089209020912092209320942095209620972098209921002101210221032104210521062107210821092110211121122113211421152116211721182119212021212122212321242125212621272128212921302131213221332134213521362137213821392140214121422143214421452146214721482149215021512152215321542155215621572158215921602161216221632164216521662167216821692170217121722173217421752176217721782179218021812182218321842185218621872188218921902191219221932194219521962197219821992200220122022203220422052206220722082209221022112212221322142215221622172218221922202221222222232224222522262227222822292230223122322233223422352236223722382239224022412242224322442245224622472248224922502251225222532254225522562257225822592260226122622263226422652266226722682269227022712272227322742275227622772278227922802281228222832284228522862287228822892290229122922293229422952296229722982299230023012302230323042305230623072308230923102311231223132314231523162317231823192320232123222323232423252326232723282329233023312332233323342335233623372338233923402341234223432344234523462347234823492350235123522353235423552356235723582359236023612362236323642365236623672368236923702371237223732374237523762377237823792380238123822383238423852386238723882389239023912392239323942395239623972398239924002401240224032404240524062407240824092410241124122413241424152416241724182419242024212422242324242425242624272428242924302431243224332434243524362437243824392440244124422443244424452446244724482449245024512452245324542455245624572458245924602461246224632464246524662467246824692470247124722473247424752476247724782479248024812482248324842485248624872488248924902491249224932494249524962497249824992500250125022503250425052506250725082509251025112512251325142515251625172518251925202521252225232524252525262527252825292530253125322533253425352536253725382539254025412542254325442545254625472548254925502551255225532554255525562557255825592560256125622563256425652566256725682569257025712572257325742575257625772578257925802581258225832584258525862587258825892590259125922593259425952596259725982599260026012602260326042605260626072608260926102611261226132614261526162617261826192620262126222623262426252626262726282629263026312632263326342635263626372638263926402641264226432644264526462647264826492650265126522653265426552656265726582659266026612662266326642665266626672668266926702671267226732674267526762677267826792680268126822683268426852686268726882689269026912692269326942695269626972698269927002701270227032704270527062707270827092710271127122713271427152716271727182719272027212722272327242725272627272728272927302731273227332734273527362737273827392740274127422743274427452746274727482749275027512752275327542755275627572758275927602761276227632764276527662767276827692770277127722773277427752776277727782779278027812782278327842785278627872788278927902791279227932794279527962797279827992800280128022803280428052806280728082809281028112812281328142815281628172818281928202821282228232824282528262827282828292830283128322833283428352836283728382839284028412842284328442845284628472848284928502851285228532854285528562857285828592860286128622863286428652866286728682869287028712872287328742875287628772878287928802881288228832884288528862887288828892890289128922893289428952896289728982899290029012902290329042905290629072908290929102911291229132914291529162917291829192920292129222923292429252926292729282929293029312932293329342935293629372938293929402941294229432944294529462947294829492950295129522953295429552956295729582959296029612962296329642965296629672968296929702971297229732974297529762977297829792980298129822983298429852986298729882989299029912992299329942995299629972998299930003001300230033004300530063007300830093010301130123013301430153016301730183019302030213022302330243025302630273028302930303031303230333034303530363037303830393040304130423043304430453046304730483049305030513052305330543055305630573058305930603061306230633064306530663067306830693070307130723073307430753076307730783079308030813082308330843085308630873088308930903091309230933094309530963097309830993100310131023103310431053106310731083109311031113112311331143115311631173118311931203121312231233124312531263127312831293130313131323133313431353136313731383139314031413142314331443145314631473148314931503151315231533154315531563157315831593160316131623163316431653166316731683169317031713172317331743175317631773178317931803181318231833184318531863187318831893190319131923193319431953196319731983199320032013202320332043205320632073208320932103211321232133214321532163217321832193220322132223223322432253226322732283229323032313232323332343235323632373238323932403241324232433244324532463247324832493250325132523253325432553256325732583259326032613262326332643265326632673268326932703271327232733274327532763277327832793280328132823283328432853286328732883289329032913292329332943295329632973298329933003301330233033304330533063307330833093310331133123313331433153316331733183319332033213322332333243325332633273328332933303331333233333334333533363337333833393340334133423343334433453346334733483349335033513352335333543355335633573358335933603361336233633364336533663367336833693370337133723373337433753376337733783379338033813382338333843385338633873388338933903391339233933394339533963397339833993400340134023403340434053406340734083409341034113412341334143415341634173418341934203421342234233424342534263427342834293430343134323433343434353436343734383439344034413442344334443445344634473448344934503451345234533454345534563457345834593460346134623463346434653466346734683469347034713472347334743475347634773478347934803481348234833484348534863487348834893490349134923493349434953496349734983499350035013502350335043505350635073508350935103511351235133514351535163517351835193520352135223523352435253526352735283529353035313532353335343535353635373538353935403541354235433544354535463547354835493550355135523553355435553556355735583559356035613562356335643565356635673568356935703571357235733574357535763577357835793580358135823583358435853586358735883589359035913592359335943595359635973598359936003601360236033604360536063607360836093610361136123613361436153616361736183619362036213622362336243625362636273628362936303631363236333634363536363637363836393640364136423643364436453646364736483649365036513652365336543655365636573658365936603661366236633664366536663667366836693670367136723673367436753676367736783679368036813682368336843685368636873688368936903691369236933694369536963697369836993700370137023703370437053706370737083709371037113712371337143715371637173718371937203721372237233724372537263727372837293730373137323733373437353736373737383739374037413742374337443745374637473748374937503751375237533754375537563757375837593760376137623763376437653766376737683769377037713772377337743775377637773778377937803781378237833784378537863787378837893790379137923793379437953796379737983799380038013802380338043805380638073808380938103811381238133814381538163817381838193820382138223823382438253826382738283829383038313832383338343835383638373838383938403841384238433844384538463847384838493850385138523853385438553856385738583859386038613862386338643865386638673868386938703871387238733874---# Source: calico/templates/calico-config.yaml# This ConfigMap is used to configure a self-hosted Calico installation.kind: ConfigMapapiVersion: v1metadata: name: calico-config namespace: kube-systemdata: # Typha is disabled. typha_service_name: &quot;none&quot; # Configure the backend to use. calico_backend: &quot;bird&quot; # Configure the MTU to use for workload interfaces and tunnels. # By default, MTU is auto-detected, and explicitly setting this field should not be required. # You can override auto-detection by providing a non-zero value. veth_mtu: &quot;0&quot; # The CNI network configuration to install on each node. The special # values in this config will be automatically populated. cni_network_config: |- &#123; &quot;name&quot;: &quot;k8s-pod-network&quot;, &quot;cniVersion&quot;: &quot;0.3.1&quot;, &quot;plugins&quot;: [ &#123; &quot;type&quot;: &quot;calico&quot;, &quot;log_level&quot;: &quot;info&quot;, &quot;log_file_path&quot;: &quot;/var/log/calico/cni/cni.log&quot;, &quot;datastore_type&quot;: &quot;kubernetes&quot;, &quot;nodename&quot;: &quot;__KUBERNETES_NODE_NAME__&quot;, &quot;mtu&quot;: __CNI_MTU__, &quot;ipam&quot;: &#123; &quot;type&quot;: &quot;calico-ipam&quot; &#125;, &quot;policy&quot;: &#123; &quot;type&quot;: &quot;k8s&quot; &#125;, &quot;kubernetes&quot;: &#123; &quot;kubeconfig&quot;: &quot;__KUBECONFIG_FILEPATH__&quot; &#125; &#125;, &#123; &quot;type&quot;: &quot;portmap&quot;, &quot;snat&quot;: true, &quot;capabilities&quot;: &#123;&quot;portMappings&quot;: true&#125; &#125;, &#123; &quot;type&quot;: &quot;bandwidth&quot;, &quot;capabilities&quot;: &#123;&quot;bandwidth&quot;: true&#125; &#125; ] &#125;---# Source: calico/templates/kdd-crds.yamlapiVersion: apiextensions.k8s.io/v1kind: CustomResourceDefinitionmetadata: name: bgpconfigurations.crd.projectcalico.orgspec: group: crd.projectcalico.org names: kind: BGPConfiguration listKind: BGPConfigurationList plural: bgpconfigurations singular: bgpconfiguration scope: Cluster versions: - name: v1 schema: openAPIV3Schema: description: BGPConfiguration contains the configuration for any BGP routing. properties: apiVersion: description: &#x27;APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources&#x27; type: string kind: description: &#x27;Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds&#x27; type: string metadata: type: object spec: description: BGPConfigurationSpec contains the values of the BGP configuration. properties: asNumber: description: &#x27;ASNumber is the default AS number used by a node. [Default: 64512]&#x27; format: int32 type: integer communities: description: Communities is a list of BGP community values and their arbitrary names for tagging routes. items: description: Community contains standard or large community value and its name. properties: name: description: Name given to community value. type: string value: description: Value must be of format `aa:nn` or `aa:nn:mm`. For standard community use `aa:nn` format, where `aa` and `nn` are 16 bit number. For large community use `aa:nn:mm` format, where `aa`, `nn` and `mm` are 32 bit number. Where, `aa` is an AS Number, `nn` and `mm` are per-AS identifier. pattern: ^(\\d+):(\\d+)$|^(\\d+):(\\d+):(\\d+)$ type: string type: object type: array listenPort: description: ListenPort is the port where BGP protocol should listen. Defaults to 179 maximum: 65535 minimum: 1 type: integer logSeverityScreen: description: &#x27;LogSeverityScreen is the log severity above which logs are sent to the stdout. [Default: INFO]&#x27; type: string nodeToNodeMeshEnabled: description: &#x27;NodeToNodeMeshEnabled sets whether full node to node BGP mesh is enabled. [Default: true]&#x27; type: boolean prefixAdvertisements: description: PrefixAdvertisements contains per-prefix advertisement configuration. items: description: PrefixAdvertisement configures advertisement properties for the specified CIDR. properties: cidr: description: CIDR for which properties should be advertised. type: string communities: description: Communities can be list of either community names already defined in `Specs.Communities` or community value of format `aa:nn` or `aa:nn:mm`. For standard community use `aa:nn` format, where `aa` and `nn` are 16 bit number. For large community use `aa:nn:mm` format, where `aa`, `nn` and `mm` are 32 bit number. Where,`aa` is an AS Number, `nn` and `mm` are per-AS identifier. items: type: string type: array type: object type: array serviceClusterIPs: description: ServiceClusterIPs are the CIDR blocks from which service cluster IPs are allocated. If specified, Calico will advertise these blocks, as well as any cluster IPs within them. items: description: ServiceClusterIPBlock represents a single allowed ClusterIP CIDR block. properties: cidr: type: string type: object type: array serviceExternalIPs: description: ServiceExternalIPs are the CIDR blocks for Kubernetes Service External IPs. Kubernetes Service ExternalIPs will only be advertised if they are within one of these blocks. items: description: ServiceExternalIPBlock represents a single allowed External IP CIDR block. properties: cidr: type: string type: object type: array serviceLoadBalancerIPs: description: ServiceLoadBalancerIPs are the CIDR blocks for Kubernetes Service LoadBalancer IPs. Kubernetes Service status.LoadBalancer.Ingress IPs will only be advertised if they are within one of these blocks. items: description: ServiceLoadBalancerIPBlock represents a single allowed LoadBalancer IP CIDR block. properties: cidr: type: string type: object type: array type: object type: object served: true storage: truestatus: acceptedNames: kind: &quot;&quot; plural: &quot;&quot; conditions: [] storedVersions: []---apiVersion: apiextensions.k8s.io/v1kind: CustomResourceDefinitionmetadata: name: bgppeers.crd.projectcalico.orgspec: group: crd.projectcalico.org names: kind: BGPPeer listKind: BGPPeerList plural: bgppeers singular: bgppeer scope: Cluster versions: - name: v1 schema: openAPIV3Schema: properties: apiVersion: description: &#x27;APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources&#x27; type: string kind: description: &#x27;Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds&#x27; type: string metadata: type: object spec: description: BGPPeerSpec contains the specification for a BGPPeer resource. properties: asNumber: description: The AS Number of the peer. format: int32 type: integer keepOriginalNextHop: description: Option to keep the original nexthop field when routes are sent to a BGP Peer. Setting &quot;true&quot; configures the selected BGP Peers node to use the &quot;next hop keep;&quot; instead of &quot;next hop self;&quot;(default) in the specific branch of the Node on &quot;bird.cfg&quot;. type: boolean node: description: The node name identifying the Calico node instance that is targeted by this peer. If this is not set, and no nodeSelector is specified, then this BGP peer selects all nodes in the cluster. type: string nodeSelector: description: Selector for the nodes that should have this peering. When this is set, the Node field must be empty. type: string password: description: Optional BGP password for the peerings generated by this BGPPeer resource. properties: secretKeyRef: description: Selects a key of a secret in the node pod&#x27;s namespace. properties: key: description: The key of the secret to select from. Must be a valid secret key. type: string name: description: &#x27;Name of the referent. More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#names TODO: Add other useful fields. apiVersion, kind, uid?&#x27; type: string optional: description: Specify whether the Secret or its key must be defined type: boolean required: - key type: object type: object peerIP: description: The IP address of the peer followed by an optional port number to peer with. If port number is given, format should be `[&lt;IPv6&gt;]:port` or `&lt;IPv4&gt;:&lt;port&gt;` for IPv4. If optional port number is not set, and this peer IP and ASNumber belongs to a calico/node with ListenPort set in BGPConfiguration, then we use that port to peer. type: string peerSelector: description: Selector for the remote nodes to peer with. When this is set, the PeerIP and ASNumber fields must be empty. For each peering between the local node and selected remote nodes, we configure an IPv4 peering if both ends have NodeBGPSpec.IPv4Address specified, and an IPv6 peering if both ends have NodeBGPSpec.IPv6Address specified. The remote AS number comes from the remote node&#x27;s NodeBGPSpec.ASNumber, or the global default if that is not set. type: string sourceAddress: description: Specifies whether and how to configure a source address for the peerings generated by this BGPPeer resource. Default value &quot;UseNodeIP&quot; means to configure the node IP as the source address. &quot;None&quot; means not to configure a source address. type: string type: object type: object served: true storage: truestatus: acceptedNames: kind: &quot;&quot; plural: &quot;&quot; conditions: [] storedVersions: []---apiVersion: apiextensions.k8s.io/v1kind: CustomResourceDefinitionmetadata: name: blockaffinities.crd.projectcalico.orgspec: group: crd.projectcalico.org names: kind: BlockAffinity listKind: BlockAffinityList plural: blockaffinities singular: blockaffinity scope: Cluster versions: - name: v1 schema: openAPIV3Schema: properties: apiVersion: description: &#x27;APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources&#x27; type: string kind: description: &#x27;Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds&#x27; type: string metadata: type: object spec: description: BlockAffinitySpec contains the specification for a BlockAffinity resource. properties: cidr: type: string deleted: description: Deleted indicates that this block affinity is being deleted. This field is a string for compatibility with older releases that mistakenly treat this field as a string. type: string node: type: string state: type: string required: - cidr - deleted - node - state type: object type: object served: true storage: truestatus: acceptedNames: kind: &quot;&quot; plural: &quot;&quot; conditions: [] storedVersions: []---apiVersion: apiextensions.k8s.io/v1kind: CustomResourceDefinitionmetadata: name: clusterinformations.crd.projectcalico.orgspec: group: crd.projectcalico.org names: kind: ClusterInformation listKind: ClusterInformationList plural: clusterinformations singular: clusterinformation scope: Cluster versions: - name: v1 schema: openAPIV3Schema: description: ClusterInformation contains the cluster specific information. properties: apiVersion: description: &#x27;APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources&#x27; type: string kind: description: &#x27;Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds&#x27; type: string metadata: type: object spec: description: ClusterInformationSpec contains the values of describing the cluster. properties: calicoVersion: description: CalicoVersion is the version of Calico that the cluster is running type: string clusterGUID: description: ClusterGUID is the GUID of the cluster type: string clusterType: description: ClusterType describes the type of the cluster type: string datastoreReady: description: DatastoreReady is used during significant datastore migrations to signal to components such as Felix that it should wait before accessing the datastore. type: boolean variant: description: Variant declares which variant of Calico should be active. type: string type: object type: object served: true storage: truestatus: acceptedNames: kind: &quot;&quot; plural: &quot;&quot; conditions: [] storedVersions: []---apiVersion: apiextensions.k8s.io/v1kind: CustomResourceDefinitionmetadata: name: felixconfigurations.crd.projectcalico.orgspec: group: crd.projectcalico.org names: kind: FelixConfiguration listKind: FelixConfigurationList plural: felixconfigurations singular: felixconfiguration scope: Cluster versions: - name: v1 schema: openAPIV3Schema: description: Felix Configuration contains the configuration for Felix. properties: apiVersion: description: &#x27;APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources&#x27; type: string kind: description: &#x27;Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds&#x27; type: string metadata: type: object spec: description: FelixConfigurationSpec contains the values of the Felix configuration. properties: allowIPIPPacketsFromWorkloads: description: &#x27;AllowIPIPPacketsFromWorkloads controls whether Felix will add a rule to drop IPIP encapsulated traffic from workloads [Default: false]&#x27; type: boolean allowVXLANPacketsFromWorkloads: description: &#x27;AllowVXLANPacketsFromWorkloads controls whether Felix will add a rule to drop VXLAN encapsulated traffic from workloads [Default: false]&#x27; type: boolean awsSrcDstCheck: description: &#x27;Set source-destination-check on AWS EC2 instances. Accepted value must be one of &quot;DoNothing&quot;, &quot;Enabled&quot; or &quot;Disabled&quot;. [Default: DoNothing]&#x27; enum: - DoNothing - Enable - Disable type: string bpfConnectTimeLoadBalancingEnabled: description: &#x27;BPFConnectTimeLoadBalancingEnabled when in BPF mode, controls whether Felix installs the connection-time load balancer. The connect-time load balancer is required for the host to be able to reach Kubernetes services and it improves the performance of pod-to-service connections. The only reason to disable it is for debugging purposes. [Default: true]&#x27; type: boolean bpfDataIfacePattern: description: BPFDataIfacePattern is a regular expression that controls which interfaces Felix should attach BPF programs to in order to catch traffic to/from the network. This needs to match the interfaces that Calico workload traffic flows over as well as any interfaces that handle incoming traffic to nodeports and services from outside the cluster. It should not match the workload interfaces (usually named cali...). type: string bpfDisableUnprivileged: description: &#x27;BPFDisableUnprivileged, if enabled, Felix sets the kernel.unprivileged_bpf_disabled sysctl to disable unprivileged use of BPF. This ensures that unprivileged users cannot access Calico&#x27;&#x27;s BPF maps and cannot insert their own BPF programs to interfere with Calico&#x27;&#x27;s. [Default: true]&#x27; type: boolean bpfEnabled: description: &#x27;BPFEnabled, if enabled Felix will use the BPF dataplane. [Default: false]&#x27; type: boolean bpfExternalServiceMode: description: &#x27;BPFExternalServiceMode in BPF mode, controls how connections from outside the cluster to services (node ports and cluster IPs) are forwarded to remote workloads. If set to &quot;Tunnel&quot; then both request and response traffic is tunneled to the remote node. If set to &quot;DSR&quot;, the request traffic is tunneled but the response traffic is sent directly from the remote node. In &quot;DSR&quot; mode, the remote node appears to use the IP of the ingress node; this requires a permissive L2 network. [Default: Tunnel]&#x27; type: string bpfKubeProxyEndpointSlicesEnabled: description: BPFKubeProxyEndpointSlicesEnabled in BPF mode, controls whether Felix&#x27;s embedded kube-proxy accepts EndpointSlices or not. type: boolean bpfKubeProxyIptablesCleanupEnabled: description: &#x27;BPFKubeProxyIptablesCleanupEnabled, if enabled in BPF mode, Felix will proactively clean up the upstream Kubernetes kube-proxy&#x27;&#x27;s iptables chains. Should only be enabled if kube-proxy is not running. [Default: true]&#x27; type: boolean bpfKubeProxyMinSyncPeriod: description: &#x27;BPFKubeProxyMinSyncPeriod, in BPF mode, controls the minimum time between updates to the dataplane for Felix&#x27;&#x27;s embedded kube-proxy. Lower values give reduced set-up latency. Higher values reduce Felix CPU usage by batching up more work. [Default: 1s]&#x27; type: string bpfLogLevel: description: &#x27;BPFLogLevel controls the log level of the BPF programs when in BPF dataplane mode. One of &quot;Off&quot;, &quot;Info&quot;, or &quot;Debug&quot;. The logs are emitted to the BPF trace pipe, accessible with the command `tc exec bpf debug`. [Default: Off].&#x27; type: string chainInsertMode: description: &#x27;ChainInsertMode controls whether Felix hooks the kernel&#x27;&#x27;s top-level iptables chains by inserting a rule at the top of the chain or by appending a rule at the bottom. insert is the safe default since it prevents Calico&#x27;&#x27;s rules from being bypassed. If you switch to append mode, be sure that the other rules in the chains signal acceptance by falling through to the Calico rules, otherwise the Calico policy will be bypassed. [Default: insert]&#x27; type: string dataplaneDriver: type: string debugDisableLogDropping: type: boolean debugMemoryProfilePath: type: string debugSimulateCalcGraphHangAfter: type: string debugSimulateDataplaneHangAfter: type: string defaultEndpointToHostAction: description: &#x27;DefaultEndpointToHostAction controls what happens to traffic that goes from a workload endpoint to the host itself (after the traffic hits the endpoint egress policy). By default Calico blocks traffic from workload endpoints to the host itself with an iptables &quot;DROP&quot; action. If you want to allow some or all traffic from endpoint to host, set this parameter to RETURN or ACCEPT. Use RETURN if you have your own rules in the iptables &quot;INPUT&quot; chain; Calico will insert its rules at the top of that chain, then &quot;RETURN&quot; packets to the &quot;INPUT&quot; chain once it has completed processing workload endpoint egress policy. Use ACCEPT to unconditionally accept packets from workloads after processing workload endpoint egress policy. [Default: Drop]&#x27; type: string deviceRouteProtocol: description: This defines the route protocol added to programmed device routes, by default this will be RTPROT_BOOT when left blank. type: integer deviceRouteSourceAddress: description: This is the source address to use on programmed device routes. By default the source address is left blank, leaving the kernel to choose the source address used. type: string disableConntrackInvalidCheck: type: boolean endpointReportingDelay: type: string endpointReportingEnabled: type: boolean externalNodesList: description: ExternalNodesCIDRList is a list of CIDR&#x27;s of external-non-calico-nodes which may source tunnel traffic and have the tunneled traffic be accepted at calico nodes. items: type: string type: array failsafeInboundHostPorts: description: &#x27;FailsafeInboundHostPorts is a comma-delimited list of UDP/TCP ports that Felix will allow incoming traffic to host endpoints on irrespective of the security policy. This is useful to avoid accidentally cutting off a host with incorrect configuration. Each port should be specified as tcp:&lt;port-number&gt; or udp:&lt;port-number&gt;. For back-compatibility, if the protocol is not specified, it defaults to &quot;tcp&quot;. To disable all inbound host ports, use the value none. The default value allows ssh access and DHCP. [Default: tcp:22, udp:68, tcp:179, tcp:2379, tcp:2380, tcp:6443, tcp:6666, tcp:6667]&#x27; items: description: ProtoPort is combination of protocol and port, both must be specified. properties: port: type: integer protocol: type: string required: - port - protocol type: object type: array failsafeOutboundHostPorts: description: &#x27;FailsafeOutboundHostPorts is a comma-delimited list of UDP/TCP ports that Felix will allow outgoing traffic from host endpoints to irrespective of the security policy. This is useful to avoid accidentally cutting off a host with incorrect configuration. Each port should be specified as tcp:&lt;port-number&gt; or udp:&lt;port-number&gt;. For back-compatibility, if the protocol is not specified, it defaults to &quot;tcp&quot;. To disable all outbound host ports, use the value none. The default value opens etcd&#x27;&#x27;s standard ports to ensure that Felix does not get cut off from etcd as well as allowing DHCP and DNS. [Default: tcp:179, tcp:2379, tcp:2380, tcp:6443, tcp:6666, tcp:6667, udp:53, udp:67]&#x27; items: description: ProtoPort is combination of protocol and port, both must be specified. properties: port: type: integer protocol: type: string required: - port - protocol type: object type: array featureDetectOverride: description: FeatureDetectOverride is used to override the feature detection. Values are specified in a comma separated list with no spaces, example; &quot;SNATFullyRandom=true,MASQFullyRandom=false,RestoreSupportsLock=&quot;. &quot;true&quot; or &quot;false&quot; will force the feature, empty or omitted values are auto-detected. type: string genericXDPEnabled: description: &#x27;GenericXDPEnabled enables Generic XDP so network cards that don&#x27;&#x27;t support XDP offload or driver modes can use XDP. This is not recommended since it doesn&#x27;&#x27;t provide better performance than iptables. [Default: false]&#x27; type: boolean healthEnabled: type: boolean healthHost: type: string healthPort: type: integer interfaceExclude: description: &#x27;InterfaceExclude is a comma-separated list of interfaces that Felix should exclude when monitoring for host endpoints. The default value ensures that Felix ignores Kubernetes&#x27;&#x27; IPVS dummy interface, which is used internally by kube-proxy. If you want to exclude multiple interface names using a single value, the list supports regular expressions. For regular expressions you must wrap the value with &#x27;&#x27;/&#x27;&#x27;. For example having values &#x27;&#x27;/^kube/,veth1&#x27;&#x27; will exclude all interfaces that begin with &#x27;&#x27;kube&#x27;&#x27; and also the interface &#x27;&#x27;veth1&#x27;&#x27;. [Default: kube-ipvs0]&#x27; type: string interfacePrefix: description: &#x27;InterfacePrefix is the interface name prefix that identifies workload endpoints and so distinguishes them from host endpoint interfaces. Note: in environments other than bare metal, the orchestrators configure this appropriately. For example our Kubernetes and Docker integrations set the &#x27;&#x27;cali&#x27;&#x27; value, and our OpenStack integration sets the &#x27;&#x27;tap&#x27;&#x27; value. [Default: cali]&#x27; type: string interfaceRefreshInterval: description: InterfaceRefreshInterval is the period at which Felix rescans local interfaces to verify their state. The rescan can be disabled by setting the interval to 0. type: string ipipEnabled: type: boolean ipipMTU: description: &#x27;IPIPMTU is the MTU to set on the tunnel device. See Configuring MTU [Default: 1440]&#x27; type: integer ipsetsRefreshInterval: description: &#x27;IpsetsRefreshInterval is the period at which Felix re-checks all iptables state to ensure that no other process has accidentally broken Calico&#x27;&#x27;s rules. Set to 0 to disable iptables refresh. [Default: 90s]&#x27; type: string iptablesBackend: description: IptablesBackend specifies which backend of iptables will be used. The default is legacy. type: string iptablesFilterAllowAction: type: string iptablesLockFilePath: description: &#x27;IptablesLockFilePath is the location of the iptables lock file. You may need to change this if the lock file is not in its standard location (for example if you have mapped it into Felix&#x27;&#x27;s container at a different path). [Default: /run/xtables.lock]&#x27; type: string iptablesLockProbeInterval: description: &#x27;IptablesLockProbeInterval is the time that Felix will wait between attempts to acquire the iptables lock if it is not available. Lower values make Felix more responsive when the lock is contended, but use more CPU. [Default: 50ms]&#x27; type: string iptablesLockTimeout: description: &#x27;IptablesLockTimeout is the time that Felix will wait for the iptables lock, or 0, to disable. To use this feature, Felix must share the iptables lock file with all other processes that also take the lock. When running Felix inside a container, this requires the /run directory of the host to be mounted into the calico/node or calico/felix container. [Default: 0s disabled]&#x27; type: string iptablesMangleAllowAction: type: string iptablesMarkMask: description: &#x27;IptablesMarkMask is the mask that Felix selects its IPTables Mark bits from. Should be a 32 bit hexadecimal number with at least 8 bits set, none of which clash with any other mark bits in use on the system. [Default: 0xff000000]&#x27; format: int32 type: integer iptablesNATOutgoingInterfaceFilter: type: string iptablesPostWriteCheckInterval: description: &#x27;IptablesPostWriteCheckInterval is the period after Felix has done a write to the dataplane that it schedules an extra read back in order to check the write was not clobbered by another process. This should only occur if another application on the system doesn&#x27;&#x27;t respect the iptables lock. [Default: 1s]&#x27; type: string iptablesRefreshInterval: description: &#x27;IptablesRefreshInterval is the period at which Felix re-checks the IP sets in the dataplane to ensure that no other process has accidentally broken Calico&#x27;&#x27;s rules. Set to 0 to disable IP sets refresh. Note: the default for this value is lower than the other refresh intervals as a workaround for a Linux kernel bug that was fixed in kernel version 4.11. If you are using v4.11 or greater you may want to set this to, a higher value to reduce Felix CPU usage. [Default: 10s]&#x27; type: string ipv6Support: type: boolean kubeNodePortRanges: description: &#x27;KubeNodePortRanges holds list of port ranges used for service node ports. Only used if felix detects kube-proxy running in ipvs mode. Felix uses these ranges to separate host and workload traffic. [Default: 30000:32767].&#x27; items: anyOf: - type: integer - type: string pattern: ^.* x-kubernetes-int-or-string: true type: array logFilePath: description: &#x27;LogFilePath is the full path to the Felix log. Set to none to disable file logging. [Default: /var/log/calico/felix.log]&#x27; type: string logPrefix: description: &#x27;LogPrefix is the log prefix that Felix uses when rendering LOG rules. [Default: calico-packet]&#x27; type: string logSeverityFile: description: &#x27;LogSeverityFile is the log severity above which logs are sent to the log file. [Default: Info]&#x27; type: string logSeverityScreen: description: &#x27;LogSeverityScreen is the log severity above which logs are sent to the stdout. [Default: Info]&#x27; type: string logSeveritySys: description: &#x27;LogSeveritySys is the log severity above which logs are sent to the syslog. Set to None for no logging to syslog. [Default: Info]&#x27; type: string maxIpsetSize: type: integer metadataAddr: description: &#x27;MetadataAddr is the IP address or domain name of the server that can answer VM queries for cloud-init metadata. In OpenStack, this corresponds to the machine running nova-api (or in Ubuntu, nova-api-metadata). A value of none (case insensitive) means that Felix should not set up any NAT rule for the metadata path. [Default: 127.0.0.1]&#x27; type: string metadataPort: description: &#x27;MetadataPort is the port of the metadata server. This, combined with global.MetadataAddr (if not &#x27;&#x27;None&#x27;&#x27;), is used to set up a NAT rule, from 169.254.169.254:80 to MetadataAddr:MetadataPort. In most cases this should not need to be changed [Default: 8775].&#x27; type: integer mtuIfacePattern: description: MTUIfacePattern is a regular expression that controls which interfaces Felix should scan in order to calculate the host&#x27;s MTU. This should not match workload interfaces (usually named cali...). type: string natOutgoingAddress: description: NATOutgoingAddress specifies an address to use when performing source NAT for traffic in a natOutgoing pool that is leaving the network. By default the address used is an address on the interface the traffic is leaving on (ie it uses the iptables MASQUERADE target) type: string natPortRange: anyOf: - type: integer - type: string description: NATPortRange specifies the range of ports that is used for port mapping when doing outgoing NAT. When unset the default behavior of the network stack is used. pattern: ^.* x-kubernetes-int-or-string: true netlinkTimeout: type: string openstackRegion: description: &#x27;OpenstackRegion is the name of the region that a particular Felix belongs to. In a multi-region Calico/OpenStack deployment, this must be configured somehow for each Felix (here in the datamodel, or in felix.cfg or the environment on each compute node), and must match the [calico] openstack_region value configured in neutron.conf on each node. [Default: Empty]&#x27; type: string policySyncPathPrefix: description: &#x27;PolicySyncPathPrefix is used to by Felix to communicate policy changes to external services, like Application layer policy. [Default: Empty]&#x27; type: string prometheusGoMetricsEnabled: description: &#x27;PrometheusGoMetricsEnabled disables Go runtime metrics collection, which the Prometheus client does by default, when set to false. This reduces the number of metrics reported, reducing Prometheus load. [Default: true]&#x27; type: boolean prometheusMetricsEnabled: description: &#x27;PrometheusMetricsEnabled enables the Prometheus metrics server in Felix if set to true. [Default: false]&#x27; type: boolean prometheusMetricsHost: description: &#x27;PrometheusMetricsHost is the host that the Prometheus metrics server should bind to. [Default: empty]&#x27; type: string prometheusMetricsPort: description: &#x27;PrometheusMetricsPort is the TCP port that the Prometheus metrics server should bind to. [Default: 9091]&#x27; type: integer prometheusProcessMetricsEnabled: description: &#x27;PrometheusProcessMetricsEnabled disables process metrics collection, which the Prometheus client does by default, when set to false. This reduces the number of metrics reported, reducing Prometheus load. [Default: true]&#x27; type: boolean removeExternalRoutes: description: Whether or not to remove device routes that have not been programmed by Felix. Disabling this will allow external applications to also add device routes. This is enabled by default which means we will remove externally added routes. type: boolean reportingInterval: description: &#x27;ReportingInterval is the interval at which Felix reports its status into the datastore or 0 to disable. Must be non-zero in OpenStack deployments. [Default: 30s]&#x27; type: string reportingTTL: description: &#x27;ReportingTTL is the time-to-live setting for process-wide status reports. [Default: 90s]&#x27; type: string routeRefreshInterval: description: &#x27;RouteRefreshInterval is the period at which Felix re-checks the routes in the dataplane to ensure that no other process has accidentally broken Calico&#x27;&#x27;s rules. Set to 0 to disable route refresh. [Default: 90s]&#x27; type: string routeSource: description: &#x27;RouteSource configures where Felix gets its routing information. - WorkloadIPs: use workload endpoints to construct routes. - CalicoIPAM: the default - use IPAM data to construct routes.&#x27; type: string routeTableRange: description: Calico programs additional Linux route tables for various purposes. RouteTableRange specifies the indices of the route tables that Calico should use. properties: max: type: integer min: type: integer required: - max - min type: object serviceLoopPrevention: description: &#x27;When service IP advertisement is enabled, prevent routing loops to service IPs that are not in use, by dropping or rejecting packets that do not get DNAT&#x27;&#x27;d by kube-proxy. Unless set to &quot;Disabled&quot;, in which case such routing loops continue to be allowed. [Default: Drop]&#x27; type: string sidecarAccelerationEnabled: description: &#x27;SidecarAccelerationEnabled enables experimental sidecar acceleration [Default: false]&#x27; type: boolean usageReportingEnabled: description: &#x27;UsageReportingEnabled reports anonymous Calico version number and cluster size to projectcalico.org. Logs warnings returned by the usage server. For example, if a significant security vulnerability has been discovered in the version of Calico being used. [Default: true]&#x27; type: boolean usageReportingInitialDelay: description: &#x27;UsageReportingInitialDelay controls the minimum delay before Felix makes a report. [Default: 300s]&#x27; type: string usageReportingInterval: description: &#x27;UsageReportingInterval controls the interval at which Felix makes reports. [Default: 86400s]&#x27; type: string useInternalDataplaneDriver: type: boolean vxlanEnabled: type: boolean vxlanMTU: description: &#x27;VXLANMTU is the MTU to set on the tunnel device. See Configuring MTU [Default: 1440]&#x27; type: integer vxlanPort: type: integer vxlanVNI: type: integer wireguardEnabled: description: &#x27;WireguardEnabled controls whether Wireguard is enabled. [Default: false]&#x27; type: boolean wireguardInterfaceName: description: &#x27;WireguardInterfaceName specifies the name to use for the Wireguard interface. [Default: wg.calico]&#x27; type: string wireguardListeningPort: description: &#x27;WireguardListeningPort controls the listening port used by Wireguard. [Default: 51820]&#x27; type: integer wireguardMTU: description: &#x27;WireguardMTU controls the MTU on the Wireguard interface. See Configuring MTU [Default: 1420]&#x27; type: integer wireguardRoutingRulePriority: description: &#x27;WireguardRoutingRulePriority controls the priority value to use for the Wireguard routing rule. [Default: 99]&#x27; type: integer xdpEnabled: description: &#x27;XDPEnabled enables XDP acceleration for suitable untracked incoming deny rules. [Default: true]&#x27; type: boolean xdpRefreshInterval: description: &#x27;XDPRefreshInterval is the period at which Felix re-checks all XDP state to ensure that no other process has accidentally broken Calico&#x27;&#x27;s BPF maps or attached programs. Set to 0 to disable XDP refresh. [Default: 90s]&#x27; type: string type: object type: object served: true storage: truestatus: acceptedNames: kind: &quot;&quot; plural: &quot;&quot; conditions: [] storedVersions: []---apiVersion: apiextensions.k8s.io/v1kind: CustomResourceDefinitionmetadata: name: globalnetworkpolicies.crd.projectcalico.orgspec: group: crd.projectcalico.org names: kind: GlobalNetworkPolicy listKind: GlobalNetworkPolicyList plural: globalnetworkpolicies singular: globalnetworkpolicy scope: Cluster versions: - name: v1 schema: openAPIV3Schema: properties: apiVersion: description: &#x27;APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources&#x27; type: string kind: description: &#x27;Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds&#x27; type: string metadata: type: object spec: properties: applyOnForward: description: ApplyOnForward indicates to apply the rules in this policy on forward traffic. type: boolean doNotTrack: description: DoNotTrack indicates whether packets matched by the rules in this policy should go through the data plane&#x27;s connection tracking, such as Linux conntrack. If True, the rules in this policy are applied before any data plane connection tracking, and packets allowed by this policy are marked as not to be tracked. type: boolean egress: description: The ordered set of egress rules. Each rule contains a set of packet match criteria and a corresponding action to apply. items: description: &quot;A Rule encapsulates a set of match criteria and an action. Both selector-based security Policy and security Profiles reference rules - separated out as a list of rules for both ingress and egress packet matching. \\n Each positive match criteria has a negated version, prefixed with \\&quot;Not\\&quot;. All the match criteria within a rule must be satisfied for a packet to match. A single rule can contain the positive and negative version of a match and both must be satisfied for the rule to match.&quot; properties: action: type: string destination: description: Destination contains the match criteria that apply to destination entity. properties: namespaceSelector: description: &quot;NamespaceSelector is an optional field that contains a selector expression. Only traffic that originates from (or terminates at) endpoints within the selected namespaces will be matched. When both NamespaceSelector and Selector are defined on the same rule, then only workload endpoints that are matched by both selectors will be selected by the rule. \\n For NetworkPolicy, an empty NamespaceSelector implies that the Selector is limited to selecting only workload endpoints in the same namespace as the NetworkPolicy. \\n For NetworkPolicy, `global()` NamespaceSelector implies that the Selector is limited to selecting only GlobalNetworkSet or HostEndpoint. \\n For GlobalNetworkPolicy, an empty NamespaceSelector implies the Selector applies to workload endpoints across all namespaces.&quot; type: string nets: description: Nets is an optional field that restricts the rule to only apply to traffic that originates from (or terminates at) IP addresses in any of the given subnets. items: type: string type: array notNets: description: NotNets is the negated version of the Nets field. items: type: string type: array notPorts: description: NotPorts is the negated version of the Ports field. Since only some protocols have ports, if any ports are specified it requires the Protocol match in the Rule to be set to &quot;TCP&quot; or &quot;UDP&quot;. items: anyOf: - type: integer - type: string pattern: ^.* x-kubernetes-int-or-string: true type: array notSelector: description: NotSelector is the negated version of the Selector field. See Selector field for subtleties with negated selectors. type: string ports: description: &quot;Ports is an optional field that restricts the rule to only apply to traffic that has a source (destination) port that matches one of these ranges/values. This value is a list of integers or strings that represent ranges of ports. \\n Since only some protocols have ports, if any ports are specified it requires the Protocol match in the Rule to be set to \\&quot;TCP\\&quot; or \\&quot;UDP\\&quot;.&quot; items: anyOf: - type: integer - type: string pattern: ^.* x-kubernetes-int-or-string: true type: array selector: description: &quot;Selector is an optional field that contains a selector expression (see Policy for sample syntax). \\ Only traffic that originates from (terminates at) endpoints matching the selector will be matched. \\n Note that: in addition to the negated version of the Selector (see NotSelector below), the selector expression syntax itself supports negation. The two types of negation are subtly different. One negates the set of matched endpoints, the other negates the whole match: \\n \\tSelector = \\&quot;!has(my_label)\\&quot; matches packets that are from other Calico-controlled \\tendpoints that do not have the label \\&quot;my_label\\&quot;. \\n \\tNotSelector = \\&quot;has(my_label)\\&quot; matches packets that are not from Calico-controlled \\tendpoints that do have the label \\&quot;my_label\\&quot;. \\n The effect is that the latter will accept packets from non-Calico sources whereas the former is limited to packets from Calico-controlled endpoints.&quot; type: string serviceAccounts: description: ServiceAccounts is an optional field that restricts the rule to only apply to traffic that originates from (or terminates at) a pod running as a matching service account. properties: names: description: Names is an optional field that restricts the rule to only apply to traffic that originates from (or terminates at) a pod running as a service account whose name is in the list. items: type: string type: array selector: description: Selector is an optional field that restricts the rule to only apply to traffic that originates from (or terminates at) a pod running as a service account that matches the given label selector. If both Names and Selector are specified then they are AND&#x27;ed. type: string type: object type: object http: description: HTTP contains match criteria that apply to HTTP requests. properties: methods: description: Methods is an optional field that restricts the rule to apply only to HTTP requests that use one of the listed HTTP Methods (e.g. GET, PUT, etc.) Multiple methods are OR&#x27;d together. items: type: string type: array paths: description: &#x27;Paths is an optional field that restricts the rule to apply to HTTP requests that use one of the listed HTTP Paths. Multiple paths are OR&#x27;&#x27;d together. e.g: - exact: /foo - prefix: /bar NOTE: Each entry may ONLY specify either a `exact` or a `prefix` match. The validator will check for it.&#x27; items: description: &#x27;HTTPPath specifies an HTTP path to match. It may be either of the form: exact: &lt;path&gt;: which matches the path exactly or prefix: &lt;path-prefix&gt;: which matches the path prefix&#x27; properties: exact: type: string prefix: type: string type: object type: array type: object icmp: description: ICMP is an optional field that restricts the rule to apply to a specific type and code of ICMP traffic. This should only be specified if the Protocol field is set to &quot;ICMP&quot; or &quot;ICMPv6&quot;. properties: code: description: Match on a specific ICMP code. If specified, the Type value must also be specified. This is a technical limitation imposed by the kernel&#x27;s iptables firewall, which Calico uses to enforce the rule. type: integer type: description: Match on a specific ICMP type. For example a value of 8 refers to ICMP Echo Request (i.e. pings). type: integer type: object ipVersion: description: IPVersion is an optional field that restricts the rule to only match a specific IP version. type: integer metadata: description: Metadata contains additional information for this rule properties: annotations: additionalProperties: type: string description: Annotations is a set of key value pairs that give extra information about the rule type: object type: object notICMP: description: NotICMP is the negated version of the ICMP field. properties: code: description: Match on a specific ICMP code. If specified, the Type value must also be specified. This is a technical limitation imposed by the kernel&#x27;s iptables firewall, which Calico uses to enforce the rule. type: integer type: description: Match on a specific ICMP type. For example a value of 8 refers to ICMP Echo Request (i.e. pings). type: integer type: object notProtocol: anyOf: - type: integer - type: string description: NotProtocol is the negated version of the Protocol field. pattern: ^.* x-kubernetes-int-or-string: true protocol: anyOf: - type: integer - type: string description: &quot;Protocol is an optional field that restricts the rule to only apply to traffic of a specific IP protocol. Required if any of the EntityRules contain Ports (because ports only apply to certain protocols). \\n Must be one of these string values: \\&quot;TCP\\&quot;, \\&quot;UDP\\&quot;, \\&quot;ICMP\\&quot;, \\&quot;ICMPv6\\&quot;, \\&quot;SCTP\\&quot;, \\&quot;UDPLite\\&quot; or an integer in the range 1-255.&quot; pattern: ^.* x-kubernetes-int-or-string: true source: description: Source contains the match criteria that apply to source entity. properties: namespaceSelector: description: &quot;NamespaceSelector is an optional field that contains a selector expression. Only traffic that originates from (or terminates at) endpoints within the selected namespaces will be matched. When both NamespaceSelector and Selector are defined on the same rule, then only workload endpoints that are matched by both selectors will be selected by the rule. \\n For NetworkPolicy, an empty NamespaceSelector implies that the Selector is limited to selecting only workload endpoints in the same namespace as the NetworkPolicy. \\n For NetworkPolicy, `global()` NamespaceSelector implies that the Selector is limited to selecting only GlobalNetworkSet or HostEndpoint. \\n For GlobalNetworkPolicy, an empty NamespaceSelector implies the Selector applies to workload endpoints across all namespaces.&quot; type: string nets: description: Nets is an optional field that restricts the rule to only apply to traffic that originates from (or terminates at) IP addresses in any of the given subnets. items: type: string type: array notNets: description: NotNets is the negated version of the Nets field. items: type: string type: array notPorts: description: NotPorts is the negated version of the Ports field. Since only some protocols have ports, if any ports are specified it requires the Protocol match in the Rule to be set to &quot;TCP&quot; or &quot;UDP&quot;. items: anyOf: - type: integer - type: string pattern: ^.* x-kubernetes-int-or-string: true type: array notSelector: description: NotSelector is the negated version of the Selector field. See Selector field for subtleties with negated selectors. type: string ports: description: &quot;Ports is an optional field that restricts the rule to only apply to traffic that has a source (destination) port that matches one of these ranges/values. This value is a list of integers or strings that represent ranges of ports. \\n Since only some protocols have ports, if any ports are specified it requires the Protocol match in the Rule to be set to \\&quot;TCP\\&quot; or \\&quot;UDP\\&quot;.&quot; items: anyOf: - type: integer - type: string pattern: ^.* x-kubernetes-int-or-string: true type: array selector: description: &quot;Selector is an optional field that contains a selector expression (see Policy for sample syntax). \\ Only traffic that originates from (terminates at) endpoints matching the selector will be matched. \\n Note that: in addition to the negated version of the Selector (see NotSelector below), the selector expression syntax itself supports negation. The two types of negation are subtly different. One negates the set of matched endpoints, the other negates the whole match: \\n \\tSelector = \\&quot;!has(my_label)\\&quot; matches packets that are from other Calico-controlled \\tendpoints that do not have the label \\&quot;my_label\\&quot;. \\n \\tNotSelector = \\&quot;has(my_label)\\&quot; matches packets that are not from Calico-controlled \\tendpoints that do have the label \\&quot;my_label\\&quot;. \\n The effect is that the latter will accept packets from non-Calico sources whereas the former is limited to packets from Calico-controlled endpoints.&quot; type: string serviceAccounts: description: ServiceAccounts is an optional field that restricts the rule to only apply to traffic that originates from (or terminates at) a pod running as a matching service account. properties: names: description: Names is an optional field that restricts the rule to only apply to traffic that originates from (or terminates at) a pod running as a service account whose name is in the list. items: type: string type: array selector: description: Selector is an optional field that restricts the rule to only apply to traffic that originates from (or terminates at) a pod running as a service account that matches the given label selector. If both Names and Selector are specified then they are AND&#x27;ed. type: string type: object type: object required: - action type: object type: array ingress: description: The ordered set of ingress rules. Each rule contains a set of packet match criteria and a corresponding action to apply. items: description: &quot;A Rule encapsulates a set of match criteria and an action. Both selector-based security Policy and security Profiles reference rules - separated out as a list of rules for both ingress and egress packet matching. \\n Each positive match criteria has a negated version, prefixed with \\&quot;Not\\&quot;. All the match criteria within a rule must be satisfied for a packet to match. A single rule can contain the positive and negative version of a match and both must be satisfied for the rule to match.&quot; properties: action: type: string destination: description: Destination contains the match criteria that apply to destination entity. properties: namespaceSelector: description: &quot;NamespaceSelector is an optional field that contains a selector expression. Only traffic that originates from (or terminates at) endpoints within the selected namespaces will be matched. When both NamespaceSelector and Selector are defined on the same rule, then only workload endpoints that are matched by both selectors will be selected by the rule. \\n For NetworkPolicy, an empty NamespaceSelector implies that the Selector is limited to selecting only workload endpoints in the same namespace as the NetworkPolicy. \\n For NetworkPolicy, `global()` NamespaceSelector implies that the Selector is limited to selecting only GlobalNetworkSet or HostEndpoint. \\n For GlobalNetworkPolicy, an empty NamespaceSelector implies the Selector applies to workload endpoints across all namespaces.&quot; type: string nets: description: Nets is an optional field that restricts the rule to only apply to traffic that originates from (or terminates at) IP addresses in any of the given subnets. items: type: string type: array notNets: description: NotNets is the negated version of the Nets field. items: type: string type: array notPorts: description: NotPorts is the negated version of the Ports field. Since only some protocols have ports, if any ports are specified it requires the Protocol match in the Rule to be set to &quot;TCP&quot; or &quot;UDP&quot;. items: anyOf: - type: integer - type: string pattern: ^.* x-kubernetes-int-or-string: true type: array notSelector: description: NotSelector is the negated version of the Selector field. See Selector field for subtleties with negated selectors. type: string ports: description: &quot;Ports is an optional field that restricts the rule to only apply to traffic that has a source (destination) port that matches one of these ranges/values. This value is a list of integers or strings that represent ranges of ports. \\n Since only some protocols have ports, if any ports are specified it requires the Protocol match in the Rule to be set to \\&quot;TCP\\&quot; or \\&quot;UDP\\&quot;.&quot; items: anyOf: - type: integer - type: string pattern: ^.* x-kubernetes-int-or-string: true type: array selector: description: &quot;Selector is an optional field that contains a selector expression (see Policy for sample syntax). \\ Only traffic that originates from (terminates at) endpoints matching the selector will be matched. \\n Note that: in addition to the negated version of the Selector (see NotSelector below), the selector expression syntax itself supports negation. The two types of negation are subtly different. One negates the set of matched endpoints, the other negates the whole match: \\n \\tSelector = \\&quot;!has(my_label)\\&quot; matches packets that are from other Calico-controlled \\tendpoints that do not have the label \\&quot;my_label\\&quot;. \\n \\tNotSelector = \\&quot;has(my_label)\\&quot; matches packets that are not from Calico-controlled \\tendpoints that do have the label \\&quot;my_label\\&quot;. \\n The effect is that the latter will accept packets from non-Calico sources whereas the former is limited to packets from Calico-controlled endpoints.&quot; type: string serviceAccounts: description: ServiceAccounts is an optional field that restricts the rule to only apply to traffic that originates from (or terminates at) a pod running as a matching service account. properties: names: description: Names is an optional field that restricts the rule to only apply to traffic that originates from (or terminates at) a pod running as a service account whose name is in the list. items: type: string type: array selector: description: Selector is an optional field that restricts the rule to only apply to traffic that originates from (or terminates at) a pod running as a service account that matches the given label selector. If both Names and Selector are specified then they are AND&#x27;ed. type: string type: object type: object http: description: HTTP contains match criteria that apply to HTTP requests. properties: methods: description: Methods is an optional field that restricts the rule to apply only to HTTP requests that use one of the listed HTTP Methods (e.g. GET, PUT, etc.) Multiple methods are OR&#x27;d together. items: type: string type: array paths: description: &#x27;Paths is an optional field that restricts the rule to apply to HTTP requests that use one of the listed HTTP Paths. Multiple paths are OR&#x27;&#x27;d together. e.g: - exact: /foo - prefix: /bar NOTE: Each entry may ONLY specify either a `exact` or a `prefix` match. The validator will check for it.&#x27; items: description: &#x27;HTTPPath specifies an HTTP path to match. It may be either of the form: exact: &lt;path&gt;: which matches the path exactly or prefix: &lt;path-prefix&gt;: which matches the path prefix&#x27; properties: exact: type: string prefix: type: string type: object type: array type: object icmp: description: ICMP is an optional field that restricts the rule to apply to a specific type and code of ICMP traffic. This should only be specified if the Protocol field is set to &quot;ICMP&quot; or &quot;ICMPv6&quot;. properties: code: description: Match on a specific ICMP code. If specified, the Type value must also be specified. This is a technical limitation imposed by the kernel&#x27;s iptables firewall, which Calico uses to enforce the rule. type: integer type: description: Match on a specific ICMP type. For example a value of 8 refers to ICMP Echo Request (i.e. pings). type: integer type: object ipVersion: description: IPVersion is an optional field that restricts the rule to only match a specific IP version. type: integer metadata: description: Metadata contains additional information for this rule properties: annotations: additionalProperties: type: string description: Annotations is a set of key value pairs that give extra information about the rule type: object type: object notICMP: description: NotICMP is the negated version of the ICMP field. properties: code: description: Match on a specific ICMP code. If specified, the Type value must also be specified. This is a technical limitation imposed by the kernel&#x27;s iptables firewall, which Calico uses to enforce the rule. type: integer type: description: Match on a specific ICMP type. For example a value of 8 refers to ICMP Echo Request (i.e. pings). type: integer type: object notProtocol: anyOf: - type: integer - type: string description: NotProtocol is the negated version of the Protocol field. pattern: ^.* x-kubernetes-int-or-string: true protocol: anyOf: - type: integer - type: string description: &quot;Protocol is an optional field that restricts the rule to only apply to traffic of a specific IP protocol. Required if any of the EntityRules contain Ports (because ports only apply to certain protocols). \\n Must be one of these string values: \\&quot;TCP\\&quot;, \\&quot;UDP\\&quot;, \\&quot;ICMP\\&quot;, \\&quot;ICMPv6\\&quot;, \\&quot;SCTP\\&quot;, \\&quot;UDPLite\\&quot; or an integer in the range 1-255.&quot; pattern: ^.* x-kubernetes-int-or-string: true source: description: Source contains the match criteria that apply to source entity. properties: namespaceSelector: description: &quot;NamespaceSelector is an optional field that contains a selector expression. Only traffic that originates from (or terminates at) endpoints within the selected namespaces will be matched. When both NamespaceSelector and Selector are defined on the same rule, then only workload endpoints that are matched by both selectors will be selected by the rule. \\n For NetworkPolicy, an empty NamespaceSelector implies that the Selector is limited to selecting only workload endpoints in the same namespace as the NetworkPolicy. \\n For NetworkPolicy, `global()` NamespaceSelector implies that the Selector is limited to selecting only GlobalNetworkSet or HostEndpoint. \\n For GlobalNetworkPolicy, an empty NamespaceSelector implies the Selector applies to workload endpoints across all namespaces.&quot; type: string nets: description: Nets is an optional field that restricts the rule to only apply to traffic that originates from (or terminates at) IP addresses in any of the given subnets. items: type: string type: array notNets: description: NotNets is the negated version of the Nets field. items: type: string type: array notPorts: description: NotPorts is the negated version of the Ports field. Since only some protocols have ports, if any ports are specified it requires the Protocol match in the Rule to be set to &quot;TCP&quot; or &quot;UDP&quot;. items: anyOf: - type: integer - type: string pattern: ^.* x-kubernetes-int-or-string: true type: array notSelector: description: NotSelector is the negated version of the Selector field. See Selector field for subtleties with negated selectors. type: string ports: description: &quot;Ports is an optional field that restricts the rule to only apply to traffic that has a source (destination) port that matches one of these ranges/values. This value is a list of integers or strings that represent ranges of ports. \\n Since only some protocols have ports, if any ports are specified it requires the Protocol match in the Rule to be set to \\&quot;TCP\\&quot; or \\&quot;UDP\\&quot;.&quot; items: anyOf: - type: integer - type: string pattern: ^.* x-kubernetes-int-or-string: true type: array selector: description: &quot;Selector is an optional field that contains a selector expression (see Policy for sample syntax). \\ Only traffic that originates from (terminates at) endpoints matching the selector will be matched. \\n Note that: in addition to the negated version of the Selector (see NotSelector below), the selector expression syntax itself supports negation. The two types of negation are subtly different. One negates the set of matched endpoints, the other negates the whole match: \\n \\tSelector = \\&quot;!has(my_label)\\&quot; matches packets that are from other Calico-controlled \\tendpoints that do not have the label \\&quot;my_label\\&quot;. \\n \\tNotSelector = \\&quot;has(my_label)\\&quot; matches packets that are not from Calico-controlled \\tendpoints that do have the label \\&quot;my_label\\&quot;. \\n The effect is that the latter will accept packets from non-Calico sources whereas the former is limited to packets from Calico-controlled endpoints.&quot; type: string serviceAccounts: description: ServiceAccounts is an optional field that restricts the rule to only apply to traffic that originates from (or terminates at) a pod running as a matching service account. properties: names: description: Names is an optional field that restricts the rule to only apply to traffic that originates from (or terminates at) a pod running as a service account whose name is in the list. items: type: string type: array selector: description: Selector is an optional field that restricts the rule to only apply to traffic that originates from (or terminates at) a pod running as a service account that matches the given label selector. If both Names and Selector are specified then they are AND&#x27;ed. type: string type: object type: object required: - action type: object type: array namespaceSelector: description: NamespaceSelector is an optional field for an expression used to select a pod based on namespaces. type: string order: description: Order is an optional field that specifies the order in which the policy is applied. Policies with higher &quot;order&quot; are applied after those with lower order. If the order is omitted, it may be considered to be &quot;infinite&quot; - i.e. the policy will be applied last. Policies with identical order will be applied in alphanumerical order based on the Policy &quot;Name&quot;. type: number preDNAT: description: PreDNAT indicates to apply the rules in this policy before any DNAT. type: boolean selector: description: &quot;The selector is an expression used to pick pick out the endpoints that the policy should be applied to. \\n Selector expressions follow this syntax: \\n \\tlabel == \\&quot;string_literal\\&quot; \\ -&gt; comparison, e.g. my_label == \\&quot;foo bar\\&quot; \\tlabel != \\&quot;string_literal\\&quot; \\ -&gt; not equal; also matches if label is not present \\tlabel in &#123; \\&quot;a\\&quot;, \\&quot;b\\&quot;, \\&quot;c\\&quot;, ... &#125; -&gt; true if the value of label X is one of \\&quot;a\\&quot;, \\&quot;b\\&quot;, \\&quot;c\\&quot; \\tlabel not in &#123; \\&quot;a\\&quot;, \\&quot;b\\&quot;, \\&quot;c\\&quot;, ... &#125; -&gt; true if the value of label X is not one of \\&quot;a\\&quot;, \\&quot;b\\&quot;, \\&quot;c\\&quot; \\thas(label_name) -&gt; True if that label is present \\t! expr -&gt; negation of expr \\texpr &amp;&amp; expr -&gt; Short-circuit and \\texpr || expr -&gt; Short-circuit or \\t( expr ) -&gt; parens for grouping \\tall() or the empty selector -&gt; matches all endpoints. \\n Label names are allowed to contain alphanumerics, -, _ and /. String literals are more permissive but they do not support escape characters. \\n Examples (with made-up labels): \\n \\ttype == \\&quot;webserver\\&quot; &amp;&amp; deployment == \\&quot;prod\\&quot; \\ttype in &#123;\\&quot;frontend\\&quot;, \\&quot;backend\\&quot;&#125; \\tdeployment != \\&quot;dev\\&quot; \\t! has(label_name)&quot; type: string serviceAccountSelector: description: ServiceAccountSelector is an optional field for an expression used to select a pod based on service accounts. type: string types: description: &quot;Types indicates whether this policy applies to ingress, or to egress, or to both. When not explicitly specified (and so the value on creation is empty or nil), Calico defaults Types according to what Ingress and Egress rules are present in the policy. The default is: \\n - [ PolicyTypeIngress ], if there are no Egress rules (including the case where there are also no Ingress rules) \\n - [ PolicyTypeEgress ], if there are Egress rules but no Ingress rules \\n - [ PolicyTypeIngress, PolicyTypeEgress ], if there are both Ingress and Egress rules. \\n When the policy is read back again, Types will always be one of these values, never empty or nil.&quot; items: description: PolicyType enumerates the possible values of the PolicySpec Types field. type: string type: array type: object type: object served: true storage: truestatus: acceptedNames: kind: &quot;&quot; plural: &quot;&quot; conditions: [] storedVersions: []---apiVersion: apiextensions.k8s.io/v1kind: CustomResourceDefinitionmetadata: name: globalnetworksets.crd.projectcalico.orgspec: group: crd.projectcalico.org names: kind: GlobalNetworkSet listKind: GlobalNetworkSetList plural: globalnetworksets singular: globalnetworkset scope: Cluster versions: - name: v1 schema: openAPIV3Schema: description: GlobalNetworkSet contains a set of arbitrary IP sub-networks/CIDRs that share labels to allow rules to refer to them via selectors. The labels of GlobalNetworkSet are not namespaced. properties: apiVersion: description: &#x27;APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources&#x27; type: string kind: description: &#x27;Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds&#x27; type: string metadata: type: object spec: description: GlobalNetworkSetSpec contains the specification for a NetworkSet resource. properties: nets: description: The list of IP networks that belong to this set. items: type: string type: array type: object type: object served: true storage: truestatus: acceptedNames: kind: &quot;&quot; plural: &quot;&quot; conditions: [] storedVersions: []---apiVersion: apiextensions.k8s.io/v1kind: CustomResourceDefinitionmetadata: name: hostendpoints.crd.projectcalico.orgspec: group: crd.projectcalico.org names: kind: HostEndpoint listKind: HostEndpointList plural: hostendpoints singular: hostendpoint scope: Cluster versions: - name: v1 schema: openAPIV3Schema: properties: apiVersion: description: &#x27;APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources&#x27; type: string kind: description: &#x27;Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds&#x27; type: string metadata: type: object spec: description: HostEndpointSpec contains the specification for a HostEndpoint resource. properties: expectedIPs: description: &quot;The expected IP addresses (IPv4 and IPv6) of the endpoint. If \\&quot;InterfaceName\\&quot; is not present, Calico will look for an interface matching any of the IPs in the list and apply policy to that. Note: \\tWhen using the selector match criteria in an ingress or egress security Policy \\tor Profile, Calico converts the selector into a set of IP addresses. For host \\tendpoints, the ExpectedIPs field is used for that purpose. (If only the interface \\tname is specified, Calico does not learn the IPs of the interface for use in match \\tcriteria.)&quot; items: type: string type: array interfaceName: description: &quot;Either \\&quot;*\\&quot;, or the name of a specific Linux interface to apply policy to; or empty. \\&quot;*\\&quot; indicates that this HostEndpoint governs all traffic to, from or through the default network namespace of the host named by the \\&quot;Node\\&quot; field; entering and leaving that namespace via any interface, including those from/to non-host-networked local workloads. \\n If InterfaceName is not \\&quot;*\\&quot;, this HostEndpoint only governs traffic that enters or leaves the host through the specific interface named by InterfaceName, or - when InterfaceName is empty - through the specific interface that has one of the IPs in ExpectedIPs. Therefore, when InterfaceName is empty, at least one expected IP must be specified. Only external interfaces (such as \\&quot;eth0\\&quot;) are supported here; it isn&#x27;t possible for a HostEndpoint to protect traffic through a specific local workload interface. \\n Note: Only some kinds of policy are implemented for \\&quot;*\\&quot; HostEndpoints; initially just pre-DNAT policy. Please check Calico documentation for the latest position.&quot; type: string node: description: The node name identifying the Calico node instance. type: string ports: description: Ports contains the endpoint&#x27;s named ports, which may be referenced in security policy rules. items: properties: name: type: string port: type: integer protocol: anyOf: - type: integer - type: string pattern: ^.* x-kubernetes-int-or-string: true required: - name - port - protocol type: object type: array profiles: description: A list of identifiers of security Profile objects that apply to this endpoint. Each profile is applied in the order that they appear in this list. Profile rules are applied after the selector-based security policy. items: type: string type: array type: object type: object served: true storage: truestatus: acceptedNames: kind: &quot;&quot; plural: &quot;&quot; conditions: [] storedVersions: []---apiVersion: apiextensions.k8s.io/v1kind: CustomResourceDefinitionmetadata: name: ipamblocks.crd.projectcalico.orgspec: group: crd.projectcalico.org names: kind: IPAMBlock listKind: IPAMBlockList plural: ipamblocks singular: ipamblock scope: Cluster versions: - name: v1 schema: openAPIV3Schema: properties: apiVersion: description: &#x27;APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources&#x27; type: string kind: description: &#x27;Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds&#x27; type: string metadata: type: object spec: description: IPAMBlockSpec contains the specification for an IPAMBlock resource. properties: affinity: type: string allocations: items: type: integer # TODO: This nullable is manually added in. We should update controller-gen # to handle []*int properly itself. nullable: true type: array attributes: items: properties: handle_id: type: string secondary: additionalProperties: type: string type: object type: object type: array cidr: type: string deleted: type: boolean strictAffinity: type: boolean unallocated: items: type: integer type: array required: - allocations - attributes - cidr - strictAffinity - unallocated type: object type: object served: true storage: truestatus: acceptedNames: kind: &quot;&quot; plural: &quot;&quot; conditions: [] storedVersions: []---apiVersion: apiextensions.k8s.io/v1kind: CustomResourceDefinitionmetadata: name: ipamconfigs.crd.projectcalico.orgspec: group: crd.projectcalico.org names: kind: IPAMConfig listKind: IPAMConfigList plural: ipamconfigs singular: ipamconfig scope: Cluster versions: - name: v1 schema: openAPIV3Schema: properties: apiVersion: description: &#x27;APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources&#x27; type: string kind: description: &#x27;Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds&#x27; type: string metadata: type: object spec: description: IPAMConfigSpec contains the specification for an IPAMConfig resource. properties: autoAllocateBlocks: type: boolean maxBlocksPerHost: description: MaxBlocksPerHost, if non-zero, is the max number of blocks that can be affine to each host. type: integer strictAffinity: type: boolean required: - autoAllocateBlocks - strictAffinity type: object type: object served: true storage: truestatus: acceptedNames: kind: &quot;&quot; plural: &quot;&quot; conditions: [] storedVersions: []---apiVersion: apiextensions.k8s.io/v1kind: CustomResourceDefinitionmetadata: name: ipamhandles.crd.projectcalico.orgspec: group: crd.projectcalico.org names: kind: IPAMHandle listKind: IPAMHandleList plural: ipamhandles singular: ipamhandle scope: Cluster versions: - name: v1 schema: openAPIV3Schema: properties: apiVersion: description: &#x27;APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources&#x27; type: string kind: description: &#x27;Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds&#x27; type: string metadata: type: object spec: description: IPAMHandleSpec contains the specification for an IPAMHandle resource. properties: block: additionalProperties: type: integer type: object deleted: type: boolean handleID: type: string required: - block - handleID type: object type: object served: true storage: truestatus: acceptedNames: kind: &quot;&quot; plural: &quot;&quot; conditions: [] storedVersions: []---apiVersion: apiextensions.k8s.io/v1kind: CustomResourceDefinitionmetadata: name: ippools.crd.projectcalico.orgspec: group: crd.projectcalico.org names: kind: IPPool listKind: IPPoolList plural: ippools singular: ippool scope: Cluster versions: - name: v1 schema: openAPIV3Schema: properties: apiVersion: description: &#x27;APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources&#x27; type: string kind: description: &#x27;Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds&#x27; type: string metadata: type: object spec: description: IPPoolSpec contains the specification for an IPPool resource. properties: blockSize: description: The block size to use for IP address assignments from this pool. Defaults to 26 for IPv4 and 112 for IPv6. type: integer cidr: description: The pool CIDR. type: string disabled: description: When disabled is true, Calico IPAM will not assign addresses from this pool. type: boolean ipip: description: &#x27;Deprecated: this field is only used for APIv1 backwards compatibility. Setting this field is not allowed, this field is for internal use only.&#x27; properties: enabled: description: When enabled is true, ipip tunneling will be used to deliver packets to destinations within this pool. type: boolean mode: description: The IPIP mode. This can be one of &quot;always&quot; or &quot;cross-subnet&quot;. A mode of &quot;always&quot; will also use IPIP tunneling for routing to destination IP addresses within this pool. A mode of &quot;cross-subnet&quot; will only use IPIP tunneling when the destination node is on a different subnet to the originating node. The default value (if not specified) is &quot;always&quot;. type: string type: object ipipMode: description: Contains configuration for IPIP tunneling for this pool. If not specified, then this is defaulted to &quot;Never&quot; (i.e. IPIP tunneling is disabled). type: string nat-outgoing: description: &#x27;Deprecated: this field is only used for APIv1 backwards compatibility. Setting this field is not allowed, this field is for internal use only.&#x27; type: boolean natOutgoing: description: When nat-outgoing is true, packets sent from Calico networked containers in this pool to destinations outside of this pool will be masqueraded. type: boolean nodeSelector: description: Allows IPPool to allocate for a specific node by label selector. type: string vxlanMode: description: Contains configuration for VXLAN tunneling for this pool. If not specified, then this is defaulted to &quot;Never&quot; (i.e. VXLAN tunneling is disabled). type: string required: - cidr type: object type: object served: true storage: truestatus: acceptedNames: kind: &quot;&quot; plural: &quot;&quot; conditions: [] storedVersions: []---apiVersion: apiextensions.k8s.io/v1kind: CustomResourceDefinitionmetadata: name: kubecontrollersconfigurations.crd.projectcalico.orgspec: group: crd.projectcalico.org names: kind: KubeControllersConfiguration listKind: KubeControllersConfigurationList plural: kubecontrollersconfigurations singular: kubecontrollersconfiguration scope: Cluster versions: - name: v1 schema: openAPIV3Schema: properties: apiVersion: description: &#x27;APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources&#x27; type: string kind: description: &#x27;Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds&#x27; type: string metadata: type: object spec: description: KubeControllersConfigurationSpec contains the values of the Kubernetes controllers configuration. properties: controllers: description: Controllers enables and configures individual Kubernetes controllers properties: namespace: description: Namespace enables and configures the namespace controller. Enabled by default, set to nil to disable. properties: reconcilerPeriod: description: &#x27;ReconcilerPeriod is the period to perform reconciliation with the Calico datastore. [Default: 5m]&#x27; type: string type: object node: description: Node enables and configures the node controller. Enabled by default, set to nil to disable. properties: hostEndpoint: description: HostEndpoint controls syncing nodes to host endpoints. Disabled by default, set to nil to disable. properties: autoCreate: description: &#x27;AutoCreate enables automatic creation of host endpoints for every node. [Default: Disabled]&#x27; type: string type: object reconcilerPeriod: description: &#x27;ReconcilerPeriod is the period to perform reconciliation with the Calico datastore. [Default: 5m]&#x27; type: string syncLabels: description: &#x27;SyncLabels controls whether to copy Kubernetes node labels to Calico nodes. [Default: Enabled]&#x27; type: string type: object policy: description: Policy enables and configures the policy controller. Enabled by default, set to nil to disable. properties: reconcilerPeriod: description: &#x27;ReconcilerPeriod is the period to perform reconciliation with the Calico datastore. [Default: 5m]&#x27; type: string type: object serviceAccount: description: ServiceAccount enables and configures the service account controller. Enabled by default, set to nil to disable. properties: reconcilerPeriod: description: &#x27;ReconcilerPeriod is the period to perform reconciliation with the Calico datastore. [Default: 5m]&#x27; type: string type: object workloadEndpoint: description: WorkloadEndpoint enables and configures the workload endpoint controller. Enabled by default, set to nil to disable. properties: reconcilerPeriod: description: &#x27;ReconcilerPeriod is the period to perform reconciliation with the Calico datastore. [Default: 5m]&#x27; type: string type: object type: object etcdV3CompactionPeriod: description: &#x27;EtcdV3CompactionPeriod is the period between etcdv3 compaction requests. Set to 0 to disable. [Default: 10m]&#x27; type: string healthChecks: description: &#x27;HealthChecks enables or disables support for health checks [Default: Enabled]&#x27; type: string logSeverityScreen: description: &#x27;LogSeverityScreen is the log severity above which logs are sent to the stdout. [Default: Info]&#x27; type: string prometheusMetricsPort: description: &#x27;PrometheusMetricsPort is the TCP port that the Prometheus metrics server should bind to. Set to 0 to disable. [Default: 9094]&#x27; type: integer required: - controllers type: object status: description: KubeControllersConfigurationStatus represents the status of the configuration. It&#x27;s useful for admins to be able to see the actual config that was applied, which can be modified by environment variables on the kube-controllers process. properties: environmentVars: additionalProperties: type: string description: EnvironmentVars contains the environment variables on the kube-controllers that influenced the RunningConfig. type: object runningConfig: description: RunningConfig contains the effective config that is running in the kube-controllers pod, after merging the API resource with any environment variables. properties: controllers: description: Controllers enables and configures individual Kubernetes controllers properties: namespace: description: Namespace enables and configures the namespace controller. Enabled by default, set to nil to disable. properties: reconcilerPeriod: description: &#x27;ReconcilerPeriod is the period to perform reconciliation with the Calico datastore. [Default: 5m]&#x27; type: string type: object node: description: Node enables and configures the node controller. Enabled by default, set to nil to disable. properties: hostEndpoint: description: HostEndpoint controls syncing nodes to host endpoints. Disabled by default, set to nil to disable. properties: autoCreate: description: &#x27;AutoCreate enables automatic creation of host endpoints for every node. [Default: Disabled]&#x27; type: string type: object reconcilerPeriod: description: &#x27;ReconcilerPeriod is the period to perform reconciliation with the Calico datastore. [Default: 5m]&#x27; type: string syncLabels: description: &#x27;SyncLabels controls whether to copy Kubernetes node labels to Calico nodes. [Default: Enabled]&#x27; type: string type: object policy: description: Policy enables and configures the policy controller. Enabled by default, set to nil to disable. properties: reconcilerPeriod: description: &#x27;ReconcilerPeriod is the period to perform reconciliation with the Calico datastore. [Default: 5m]&#x27; type: string type: object serviceAccount: description: ServiceAccount enables and configures the service account controller. Enabled by default, set to nil to disable. properties: reconcilerPeriod: description: &#x27;ReconcilerPeriod is the period to perform reconciliation with the Calico datastore. [Default: 5m]&#x27; type: string type: object workloadEndpoint: description: WorkloadEndpoint enables and configures the workload endpoint controller. Enabled by default, set to nil to disable. properties: reconcilerPeriod: description: &#x27;ReconcilerPeriod is the period to perform reconciliation with the Calico datastore. [Default: 5m]&#x27; type: string type: object type: object etcdV3CompactionPeriod: description: &#x27;EtcdV3CompactionPeriod is the period between etcdv3 compaction requests. Set to 0 to disable. [Default: 10m]&#x27; type: string healthChecks: description: &#x27;HealthChecks enables or disables support for health checks [Default: Enabled]&#x27; type: string logSeverityScreen: description: &#x27;LogSeverityScreen is the log severity above which logs are sent to the stdout. [Default: Info]&#x27; type: string prometheusMetricsPort: description: &#x27;PrometheusMetricsPort is the TCP port that the Prometheus metrics server should bind to. Set to 0 to disable. [Default: 9094]&#x27; type: integer required: - controllers type: object type: object type: object served: true storage: truestatus: acceptedNames: kind: &quot;&quot; plural: &quot;&quot; conditions: [] storedVersions: []---apiVersion: apiextensions.k8s.io/v1kind: CustomResourceDefinitionmetadata: name: networkpolicies.crd.projectcalico.orgspec: group: crd.projectcalico.org names: kind: NetworkPolicy listKind: NetworkPolicyList plural: networkpolicies singular: networkpolicy scope: Namespaced versions: - name: v1 schema: openAPIV3Schema: properties: apiVersion: description: &#x27;APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources&#x27; type: string kind: description: &#x27;Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds&#x27; type: string metadata: type: object spec: properties: egress: description: The ordered set of egress rules. Each rule contains a set of packet match criteria and a corresponding action to apply. items: description: &quot;A Rule encapsulates a set of match criteria and an action. Both selector-based security Policy and security Profiles reference rules - separated out as a list of rules for both ingress and egress packet matching. \\n Each positive match criteria has a negated version, prefixed with \\&quot;Not\\&quot;. All the match criteria within a rule must be satisfied for a packet to match. A single rule can contain the positive and negative version of a match and both must be satisfied for the rule to match.&quot; properties: action: type: string destination: description: Destination contains the match criteria that apply to destination entity. properties: namespaceSelector: description: &quot;NamespaceSelector is an optional field that contains a selector expression. Only traffic that originates from (or terminates at) endpoints within the selected namespaces will be matched. When both NamespaceSelector and Selector are defined on the same rule, then only workload endpoints that are matched by both selectors will be selected by the rule. \\n For NetworkPolicy, an empty NamespaceSelector implies that the Selector is limited to selecting only workload endpoints in the same namespace as the NetworkPolicy. \\n For NetworkPolicy, `global()` NamespaceSelector implies that the Selector is limited to selecting only GlobalNetworkSet or HostEndpoint. \\n For GlobalNetworkPolicy, an empty NamespaceSelector implies the Selector applies to workload endpoints across all namespaces.&quot; type: string nets: description: Nets is an optional field that restricts the rule to only apply to traffic that originates from (or terminates at) IP addresses in any of the given subnets. items: type: string type: array notNets: description: NotNets is the negated version of the Nets field. items: type: string type: array notPorts: description: NotPorts is the negated version of the Ports field. Since only some protocols have ports, if any ports are specified it requires the Protocol match in the Rule to be set to &quot;TCP&quot; or &quot;UDP&quot;. items: anyOf: - type: integer - type: string pattern: ^.* x-kubernetes-int-or-string: true type: array notSelector: description: NotSelector is the negated version of the Selector field. See Selector field for subtleties with negated selectors. type: string ports: description: &quot;Ports is an optional field that restricts the rule to only apply to traffic that has a source (destination) port that matches one of these ranges/values. This value is a list of integers or strings that represent ranges of ports. \\n Since only some protocols have ports, if any ports are specified it requires the Protocol match in the Rule to be set to \\&quot;TCP\\&quot; or \\&quot;UDP\\&quot;.&quot; items: anyOf: - type: integer - type: string pattern: ^.* x-kubernetes-int-or-string: true type: array selector: description: &quot;Selector is an optional field that contains a selector expression (see Policy for sample syntax). \\ Only traffic that originates from (terminates at) endpoints matching the selector will be matched. \\n Note that: in addition to the negated version of the Selector (see NotSelector below), the selector expression syntax itself supports negation. The two types of negation are subtly different. One negates the set of matched endpoints, the other negates the whole match: \\n \\tSelector = \\&quot;!has(my_label)\\&quot; matches packets that are from other Calico-controlled \\tendpoints that do not have the label \\&quot;my_label\\&quot;. \\n \\tNotSelector = \\&quot;has(my_label)\\&quot; matches packets that are not from Calico-controlled \\tendpoints that do have the label \\&quot;my_label\\&quot;. \\n The effect is that the latter will accept packets from non-Calico sources whereas the former is limited to packets from Calico-controlled endpoints.&quot; type: string serviceAccounts: description: ServiceAccounts is an optional field that restricts the rule to only apply to traffic that originates from (or terminates at) a pod running as a matching service account. properties: names: description: Names is an optional field that restricts the rule to only apply to traffic that originates from (or terminates at) a pod running as a service account whose name is in the list. items: type: string type: array selector: description: Selector is an optional field that restricts the rule to only apply to traffic that originates from (or terminates at) a pod running as a service account that matches the given label selector. If both Names and Selector are specified then they are AND&#x27;ed. type: string type: object type: object http: description: HTTP contains match criteria that apply to HTTP requests. properties: methods: description: Methods is an optional field that restricts the rule to apply only to HTTP requests that use one of the listed HTTP Methods (e.g. GET, PUT, etc.) Multiple methods are OR&#x27;d together. items: type: string type: array paths: description: &#x27;Paths is an optional field that restricts the rule to apply to HTTP requests that use one of the listed HTTP Paths. Multiple paths are OR&#x27;&#x27;d together. e.g: - exact: /foo - prefix: /bar NOTE: Each entry may ONLY specify either a `exact` or a `prefix` match. The validator will check for it.&#x27; items: description: &#x27;HTTPPath specifies an HTTP path to match. It may be either of the form: exact: &lt;path&gt;: which matches the path exactly or prefix: &lt;path-prefix&gt;: which matches the path prefix&#x27; properties: exact: type: string prefix: type: string type: object type: array type: object icmp: description: ICMP is an optional field that restricts the rule to apply to a specific type and code of ICMP traffic. This should only be specified if the Protocol field is set to &quot;ICMP&quot; or &quot;ICMPv6&quot;. properties: code: description: Match on a specific ICMP code. If specified, the Type value must also be specified. This is a technical limitation imposed by the kernel&#x27;s iptables firewall, which Calico uses to enforce the rule. type: integer type: description: Match on a specific ICMP type. For example a value of 8 refers to ICMP Echo Request (i.e. pings). type: integer type: object ipVersion: description: IPVersion is an optional field that restricts the rule to only match a specific IP version. type: integer metadata: description: Metadata contains additional information for this rule properties: annotations: additionalProperties: type: string description: Annotations is a set of key value pairs that give extra information about the rule type: object type: object notICMP: description: NotICMP is the negated version of the ICMP field. properties: code: description: Match on a specific ICMP code. If specified, the Type value must also be specified. This is a technical limitation imposed by the kernel&#x27;s iptables firewall, which Calico uses to enforce the rule. type: integer type: description: Match on a specific ICMP type. For example a value of 8 refers to ICMP Echo Request (i.e. pings). type: integer type: object notProtocol: anyOf: - type: integer - type: string description: NotProtocol is the negated version of the Protocol field. pattern: ^.* x-kubernetes-int-or-string: true protocol: anyOf: - type: integer - type: string description: &quot;Protocol is an optional field that restricts the rule to only apply to traffic of a specific IP protocol. Required if any of the EntityRules contain Ports (because ports only apply to certain protocols). \\n Must be one of these string values: \\&quot;TCP\\&quot;, \\&quot;UDP\\&quot;, \\&quot;ICMP\\&quot;, \\&quot;ICMPv6\\&quot;, \\&quot;SCTP\\&quot;, \\&quot;UDPLite\\&quot; or an integer in the range 1-255.&quot; pattern: ^.* x-kubernetes-int-or-string: true source: description: Source contains the match criteria that apply to source entity. properties: namespaceSelector: description: &quot;NamespaceSelector is an optional field that contains a selector expression. Only traffic that originates from (or terminates at) endpoints within the selected namespaces will be matched. When both NamespaceSelector and Selector are defined on the same rule, then only workload endpoints that are matched by both selectors will be selected by the rule. \\n For NetworkPolicy, an empty NamespaceSelector implies that the Selector is limited to selecting only workload endpoints in the same namespace as the NetworkPolicy. \\n For NetworkPolicy, `global()` NamespaceSelector implies that the Selector is limited to selecting only GlobalNetworkSet or HostEndpoint. \\n For GlobalNetworkPolicy, an empty NamespaceSelector implies the Selector applies to workload endpoints across all namespaces.&quot; type: string nets: description: Nets is an optional field that restricts the rule to only apply to traffic that originates from (or terminates at) IP addresses in any of the given subnets. items: type: string type: array notNets: description: NotNets is the negated version of the Nets field. items: type: string type: array notPorts: description: NotPorts is the negated version of the Ports field. Since only some protocols have ports, if any ports are specified it requires the Protocol match in the Rule to be set to &quot;TCP&quot; or &quot;UDP&quot;. items: anyOf: - type: integer - type: string pattern: ^.* x-kubernetes-int-or-string: true type: array notSelector: description: NotSelector is the negated version of the Selector field. See Selector field for subtleties with negated selectors. type: string ports: description: &quot;Ports is an optional field that restricts the rule to only apply to traffic that has a source (destination) port that matches one of these ranges/values. This value is a list of integers or strings that represent ranges of ports. \\n Since only some protocols have ports, if any ports are specified it requires the Protocol match in the Rule to be set to \\&quot;TCP\\&quot; or \\&quot;UDP\\&quot;.&quot; items: anyOf: - type: integer - type: string pattern: ^.* x-kubernetes-int-or-string: true type: array selector: description: &quot;Selector is an optional field that contains a selector expression (see Policy for sample syntax). \\ Only traffic that originates from (terminates at) endpoints matching the selector will be matched. \\n Note that: in addition to the negated version of the Selector (see NotSelector below), the selector expression syntax itself supports negation. The two types of negation are subtly different. One negates the set of matched endpoints, the other negates the whole match: \\n \\tSelector = \\&quot;!has(my_label)\\&quot; matches packets that are from other Calico-controlled \\tendpoints that do not have the label \\&quot;my_label\\&quot;. \\n \\tNotSelector = \\&quot;has(my_label)\\&quot; matches packets that are not from Calico-controlled \\tendpoints that do have the label \\&quot;my_label\\&quot;. \\n The effect is that the latter will accept packets from non-Calico sources whereas the former is limited to packets from Calico-controlled endpoints.&quot; type: string serviceAccounts: description: ServiceAccounts is an optional field that restricts the rule to only apply to traffic that originates from (or terminates at) a pod running as a matching service account. properties: names: description: Names is an optional field that restricts the rule to only apply to traffic that originates from (or terminates at) a pod running as a service account whose name is in the list. items: type: string type: array selector: description: Selector is an optional field that restricts the rule to only apply to traffic that originates from (or terminates at) a pod running as a service account that matches the given label selector. If both Names and Selector are specified then they are AND&#x27;ed. type: string type: object type: object required: - action type: object type: array ingress: description: The ordered set of ingress rules. Each rule contains a set of packet match criteria and a corresponding action to apply. items: description: &quot;A Rule encapsulates a set of match criteria and an action. Both selector-based security Policy and security Profiles reference rules - separated out as a list of rules for both ingress and egress packet matching. \\n Each positive match criteria has a negated version, prefixed with \\&quot;Not\\&quot;. All the match criteria within a rule must be satisfied for a packet to match. A single rule can contain the positive and negative version of a match and both must be satisfied for the rule to match.&quot; properties: action: type: string destination: description: Destination contains the match criteria that apply to destination entity. properties: namespaceSelector: description: &quot;NamespaceSelector is an optional field that contains a selector expression. Only traffic that originates from (or terminates at) endpoints within the selected namespaces will be matched. When both NamespaceSelector and Selector are defined on the same rule, then only workload endpoints that are matched by both selectors will be selected by the rule. \\n For NetworkPolicy, an empty NamespaceSelector implies that the Selector is limited to selecting only workload endpoints in the same namespace as the NetworkPolicy. \\n For NetworkPolicy, `global()` NamespaceSelector implies that the Selector is limited to selecting only GlobalNetworkSet or HostEndpoint. \\n For GlobalNetworkPolicy, an empty NamespaceSelector implies the Selector applies to workload endpoints across all namespaces.&quot; type: string nets: description: Nets is an optional field that restricts the rule to only apply to traffic that originates from (or terminates at) IP addresses in any of the given subnets. items: type: string type: array notNets: description: NotNets is the negated version of the Nets field. items: type: string type: array notPorts: description: NotPorts is the negated version of the Ports field. Since only some protocols have ports, if any ports are specified it requires the Protocol match in the Rule to be set to &quot;TCP&quot; or &quot;UDP&quot;. items: anyOf: - type: integer - type: string pattern: ^.* x-kubernetes-int-or-string: true type: array notSelector: description: NotSelector is the negated version of the Selector field. See Selector field for subtleties with negated selectors. type: string ports: description: &quot;Ports is an optional field that restricts the rule to only apply to traffic that has a source (destination) port that matches one of these ranges/values. This value is a list of integers or strings that represent ranges of ports. \\n Since only some protocols have ports, if any ports are specified it requires the Protocol match in the Rule to be set to \\&quot;TCP\\&quot; or \\&quot;UDP\\&quot;.&quot; items: anyOf: - type: integer - type: string pattern: ^.* x-kubernetes-int-or-string: true type: array selector: description: &quot;Selector is an optional field that contains a selector expression (see Policy for sample syntax). \\ Only traffic that originates from (terminates at) endpoints matching the selector will be matched. \\n Note that: in addition to the negated version of the Selector (see NotSelector below), the selector expression syntax itself supports negation. The two types of negation are subtly different. One negates the set of matched endpoints, the other negates the whole match: \\n \\tSelector = \\&quot;!has(my_label)\\&quot; matches packets that are from other Calico-controlled \\tendpoints that do not have the label \\&quot;my_label\\&quot;. \\n \\tNotSelector = \\&quot;has(my_label)\\&quot; matches packets that are not from Calico-controlled \\tendpoints that do have the label \\&quot;my_label\\&quot;. \\n The effect is that the latter will accept packets from non-Calico sources whereas the former is limited to packets from Calico-controlled endpoints.&quot; type: string serviceAccounts: description: ServiceAccounts is an optional field that restricts the rule to only apply to traffic that originates from (or terminates at) a pod running as a matching service account. properties: names: description: Names is an optional field that restricts the rule to only apply to traffic that originates from (or terminates at) a pod running as a service account whose name is in the list. items: type: string type: array selector: description: Selector is an optional field that restricts the rule to only apply to traffic that originates from (or terminates at) a pod running as a service account that matches the given label selector. If both Names and Selector are specified then they are AND&#x27;ed. type: string type: object type: object http: description: HTTP contains match criteria that apply to HTTP requests. properties: methods: description: Methods is an optional field that restricts the rule to apply only to HTTP requests that use one of the listed HTTP Methods (e.g. GET, PUT, etc.) Multiple methods are OR&#x27;d together. items: type: string type: array paths: description: &#x27;Paths is an optional field that restricts the rule to apply to HTTP requests that use one of the listed HTTP Paths. Multiple paths are OR&#x27;&#x27;d together. e.g: - exact: /foo - prefix: /bar NOTE: Each entry may ONLY specify either a `exact` or a `prefix` match. The validator will check for it.&#x27; items: description: &#x27;HTTPPath specifies an HTTP path to match. It may be either of the form: exact: &lt;path&gt;: which matches the path exactly or prefix: &lt;path-prefix&gt;: which matches the path prefix&#x27; properties: exact: type: string prefix: type: string type: object type: array type: object icmp: description: ICMP is an optional field that restricts the rule to apply to a specific type and code of ICMP traffic. This should only be specified if the Protocol field is set to &quot;ICMP&quot; or &quot;ICMPv6&quot;. properties: code: description: Match on a specific ICMP code. If specified, the Type value must also be specified. This is a technical limitation imposed by the kernel&#x27;s iptables firewall, which Calico uses to enforce the rule. type: integer type: description: Match on a specific ICMP type. For example a value of 8 refers to ICMP Echo Request (i.e. pings). type: integer type: object ipVersion: description: IPVersion is an optional field that restricts the rule to only match a specific IP version. type: integer metadata: description: Metadata contains additional information for this rule properties: annotations: additionalProperties: type: string description: Annotations is a set of key value pairs that give extra information about the rule type: object type: object notICMP: description: NotICMP is the negated version of the ICMP field. properties: code: description: Match on a specific ICMP code. If specified, the Type value must also be specified. This is a technical limitation imposed by the kernel&#x27;s iptables firewall, which Calico uses to enforce the rule. type: integer type: description: Match on a specific ICMP type. For example a value of 8 refers to ICMP Echo Request (i.e. pings). type: integer type: object notProtocol: anyOf: - type: integer - type: string description: NotProtocol is the negated version of the Protocol field. pattern: ^.* x-kubernetes-int-or-string: true protocol: anyOf: - type: integer - type: string description: &quot;Protocol is an optional field that restricts the rule to only apply to traffic of a specific IP protocol. Required if any of the EntityRules contain Ports (because ports only apply to certain protocols). \\n Must be one of these string values: \\&quot;TCP\\&quot;, \\&quot;UDP\\&quot;, \\&quot;ICMP\\&quot;, \\&quot;ICMPv6\\&quot;, \\&quot;SCTP\\&quot;, \\&quot;UDPLite\\&quot; or an integer in the range 1-255.&quot; pattern: ^.* x-kubernetes-int-or-string: true source: description: Source contains the match criteria that apply to source entity. properties: namespaceSelector: description: &quot;NamespaceSelector is an optional field that contains a selector expression. Only traffic that originates from (or terminates at) endpoints within the selected namespaces will be matched. When both NamespaceSelector and Selector are defined on the same rule, then only workload endpoints that are matched by both selectors will be selected by the rule. \\n For NetworkPolicy, an empty NamespaceSelector implies that the Selector is limited to selecting only workload endpoints in the same namespace as the NetworkPolicy. \\n For NetworkPolicy, `global()` NamespaceSelector implies that the Selector is limited to selecting only GlobalNetworkSet or HostEndpoint. \\n For GlobalNetworkPolicy, an empty NamespaceSelector implies the Selector applies to workload endpoints across all namespaces.&quot; type: string nets: description: Nets is an optional field that restricts the rule to only apply to traffic that originates from (or terminates at) IP addresses in any of the given subnets. items: type: string type: array notNets: description: NotNets is the negated version of the Nets field. items: type: string type: array notPorts: description: NotPorts is the negated version of the Ports field. Since only some protocols have ports, if any ports are specified it requires the Protocol match in the Rule to be set to &quot;TCP&quot; or &quot;UDP&quot;. items: anyOf: - type: integer - type: string pattern: ^.* x-kubernetes-int-or-string: true type: array notSelector: description: NotSelector is the negated version of the Selector field. See Selector field for subtleties with negated selectors. type: string ports: description: &quot;Ports is an optional field that restricts the rule to only apply to traffic that has a source (destination) port that matches one of these ranges/values. This value is a list of integers or strings that represent ranges of ports. \\n Since only some protocols have ports, if any ports are specified it requires the Protocol match in the Rule to be set to \\&quot;TCP\\&quot; or \\&quot;UDP\\&quot;.&quot; items: anyOf: - type: integer - type: string pattern: ^.* x-kubernetes-int-or-string: true type: array selector: description: &quot;Selector is an optional field that contains a selector expression (see Policy for sample syntax). \\ Only traffic that originates from (terminates at) endpoints matching the selector will be matched. \\n Note that: in addition to the negated version of the Selector (see NotSelector below), the selector expression syntax itself supports negation. The two types of negation are subtly different. One negates the set of matched endpoints, the other negates the whole match: \\n \\tSelector = \\&quot;!has(my_label)\\&quot; matches packets that are from other Calico-controlled \\tendpoints that do not have the label \\&quot;my_label\\&quot;. \\n \\tNotSelector = \\&quot;has(my_label)\\&quot; matches packets that are not from Calico-controlled \\tendpoints that do have the label \\&quot;my_label\\&quot;. \\n The effect is that the latter will accept packets from non-Calico sources whereas the former is limited to packets from Calico-controlled endpoints.&quot; type: string serviceAccounts: description: ServiceAccounts is an optional field that restricts the rule to only apply to traffic that originates from (or terminates at) a pod running as a matching service account. properties: names: description: Names is an optional field that restricts the rule to only apply to traffic that originates from (or terminates at) a pod running as a service account whose name is in the list. items: type: string type: array selector: description: Selector is an optional field that restricts the rule to only apply to traffic that originates from (or terminates at) a pod running as a service account that matches the given label selector. If both Names and Selector are specified then they are AND&#x27;ed. type: string type: object type: object required: - action type: object type: array order: description: Order is an optional field that specifies the order in which the policy is applied. Policies with higher &quot;order&quot; are applied after those with lower order. If the order is omitted, it may be considered to be &quot;infinite&quot; - i.e. the policy will be applied last. Policies with identical order will be applied in alphanumerical order based on the Policy &quot;Name&quot;. type: number selector: description: &quot;The selector is an expression used to pick pick out the endpoints that the policy should be applied to. \\n Selector expressions follow this syntax: \\n \\tlabel == \\&quot;string_literal\\&quot; \\ -&gt; comparison, e.g. my_label == \\&quot;foo bar\\&quot; \\tlabel != \\&quot;string_literal\\&quot; \\ -&gt; not equal; also matches if label is not present \\tlabel in &#123; \\&quot;a\\&quot;, \\&quot;b\\&quot;, \\&quot;c\\&quot;, ... &#125; -&gt; true if the value of label X is one of \\&quot;a\\&quot;, \\&quot;b\\&quot;, \\&quot;c\\&quot; \\tlabel not in &#123; \\&quot;a\\&quot;, \\&quot;b\\&quot;, \\&quot;c\\&quot;, ... &#125; -&gt; true if the value of label X is not one of \\&quot;a\\&quot;, \\&quot;b\\&quot;, \\&quot;c\\&quot; \\thas(label_name) -&gt; True if that label is present \\t! expr -&gt; negation of expr \\texpr &amp;&amp; expr -&gt; Short-circuit and \\texpr || expr -&gt; Short-circuit or \\t( expr ) -&gt; parens for grouping \\tall() or the empty selector -&gt; matches all endpoints. \\n Label names are allowed to contain alphanumerics, -, _ and /. String literals are more permissive but they do not support escape characters. \\n Examples (with made-up labels): \\n \\ttype == \\&quot;webserver\\&quot; &amp;&amp; deployment == \\&quot;prod\\&quot; \\ttype in &#123;\\&quot;frontend\\&quot;, \\&quot;backend\\&quot;&#125; \\tdeployment != \\&quot;dev\\&quot; \\t! has(label_name)&quot; type: string serviceAccountSelector: description: ServiceAccountSelector is an optional field for an expression used to select a pod based on service accounts. type: string types: description: &quot;Types indicates whether this policy applies to ingress, or to egress, or to both. When not explicitly specified (and so the value on creation is empty or nil), Calico defaults Types according to what Ingress and Egress are present in the policy. The default is: \\n - [ PolicyTypeIngress ], if there are no Egress rules (including the case where there are also no Ingress rules) \\n - [ PolicyTypeEgress ], if there are Egress rules but no Ingress rules \\n - [ PolicyTypeIngress, PolicyTypeEgress ], if there are both Ingress and Egress rules. \\n When the policy is read back again, Types will always be one of these values, never empty or nil.&quot; items: description: PolicyType enumerates the possible values of the PolicySpec Types field. type: string type: array type: object type: object served: true storage: truestatus: acceptedNames: kind: &quot;&quot; plural: &quot;&quot; conditions: [] storedVersions: []---apiVersion: apiextensions.k8s.io/v1kind: CustomResourceDefinitionmetadata: name: networksets.crd.projectcalico.orgspec: group: crd.projectcalico.org names: kind: NetworkSet listKind: NetworkSetList plural: networksets singular: networkset scope: Namespaced versions: - name: v1 schema: openAPIV3Schema: description: NetworkSet is the Namespaced-equivalent of the GlobalNetworkSet. properties: apiVersion: description: &#x27;APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources&#x27; type: string kind: description: &#x27;Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds&#x27; type: string metadata: type: object spec: description: NetworkSetSpec contains the specification for a NetworkSet resource. properties: nets: description: The list of IP networks that belong to this set. items: type: string type: array type: object type: object served: true storage: truestatus: acceptedNames: kind: &quot;&quot; plural: &quot;&quot; conditions: [] storedVersions: []------# Source: calico/templates/calico-kube-controllers-rbac.yaml# Include a clusterrole for the kube-controllers component,# and bind it to the calico-kube-controllers serviceaccount.kind: ClusterRoleapiVersion: rbac.authorization.k8s.io/v1metadata: name: calico-kube-controllersrules: # Nodes are watched to monitor for deletions. - apiGroups: [&quot;&quot;] resources: - nodes verbs: - watch - list - get # Pods are queried to check for existence. - apiGroups: [&quot;&quot;] resources: - pods verbs: - get # IPAM resources are manipulated when nodes are deleted. - apiGroups: [&quot;crd.projectcalico.org&quot;] resources: - ippools verbs: - list - apiGroups: [&quot;crd.projectcalico.org&quot;] resources: - blockaffinities - ipamblocks - ipamhandles verbs: - get - list - create - update - delete - watch # kube-controllers manages hostendpoints. - apiGroups: [&quot;crd.projectcalico.org&quot;] resources: - hostendpoints verbs: - get - list - create - update - delete # Needs access to update clusterinformations. - apiGroups: [&quot;crd.projectcalico.org&quot;] resources: - clusterinformations verbs: - get - create - update # KubeControllersConfiguration is where it gets its config - apiGroups: [&quot;crd.projectcalico.org&quot;] resources: - kubecontrollersconfigurations verbs: # read its own config - get # create a default if none exists - create # update status - update # watch for changes - watch---kind: ClusterRoleBindingapiVersion: rbac.authorization.k8s.io/v1metadata: name: calico-kube-controllersroleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: calico-kube-controllerssubjects:- kind: ServiceAccount name: calico-kube-controllers namespace: kube-system------# Source: calico/templates/calico-node-rbac.yaml# Include a clusterrole for the calico-node DaemonSet,# and bind it to the calico-node serviceaccount.kind: ClusterRoleapiVersion: rbac.authorization.k8s.io/v1metadata: name: calico-noderules: # The CNI plugin needs to get pods, nodes, and namespaces. - apiGroups: [&quot;&quot;] resources: - pods - nodes - namespaces verbs: - get - apiGroups: [&quot;&quot;] resources: - endpoints - services verbs: # Used to discover service IPs for advertisement. - watch - list # Used to discover Typhas. - get # Pod CIDR auto-detection on kubeadm needs access to config maps. - apiGroups: [&quot;&quot;] resources: - configmaps verbs: - get - apiGroups: [&quot;&quot;] resources: - nodes/status verbs: # Needed for clearing NodeNetworkUnavailable flag. - patch # Calico stores some configuration information in node annotations. - update # Watch for changes to Kubernetes NetworkPolicies. - apiGroups: [&quot;networking.k8s.io&quot;] resources: - networkpolicies verbs: - watch - list # Used by Calico for policy information. - apiGroups: [&quot;&quot;] resources: - pods - namespaces - serviceaccounts verbs: - list - watch # The CNI plugin patches pods/status. - apiGroups: [&quot;&quot;] resources: - pods/status verbs: - patch # Calico monitors various CRDs for config. - apiGroups: [&quot;crd.projectcalico.org&quot;] resources: - globalfelixconfigs - felixconfigurations - bgppeers - globalbgpconfigs - bgpconfigurations - ippools - ipamblocks - globalnetworkpolicies - globalnetworksets - networkpolicies - networksets - clusterinformations - hostendpoints - blockaffinities verbs: - get - list - watch # Calico must create and update some CRDs on startup. - apiGroups: [&quot;crd.projectcalico.org&quot;] resources: - ippools - felixconfigurations - clusterinformations verbs: - create - update # Calico stores some configuration information on the node. - apiGroups: [&quot;&quot;] resources: - nodes verbs: - get - list - watch # These permissions are only required for upgrade from v2.6, and can # be removed after upgrade or on fresh installations. - apiGroups: [&quot;crd.projectcalico.org&quot;] resources: - bgpconfigurations - bgppeers verbs: - create - update # These permissions are required for Calico CNI to perform IPAM allocations. - apiGroups: [&quot;crd.projectcalico.org&quot;] resources: - blockaffinities - ipamblocks - ipamhandles verbs: - get - list - create - update - delete - apiGroups: [&quot;crd.projectcalico.org&quot;] resources: - ipamconfigs verbs: - get # Block affinities must also be watchable by confd for route aggregation. - apiGroups: [&quot;crd.projectcalico.org&quot;] resources: - blockaffinities verbs: - watch # The Calico IPAM migration needs to get daemonsets. These permissions can be # removed if not upgrading from an installation using host-local IPAM. - apiGroups: [&quot;apps&quot;] resources: - daemonsets verbs: - get---apiVersion: rbac.authorization.k8s.io/v1kind: ClusterRoleBindingmetadata: name: calico-noderoleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: calico-nodesubjects:- kind: ServiceAccount name: calico-node namespace: kube-system---# Source: calico/templates/calico-node.yaml# This manifest installs the calico-node container, as well# as the CNI plugins and network config on# each master and worker node in a Kubernetes cluster.kind: DaemonSetapiVersion: apps/v1metadata: name: calico-node namespace: kube-system labels: k8s-app: calico-nodespec: selector: matchLabels: k8s-app: calico-node updateStrategy: type: RollingUpdate rollingUpdate: maxUnavailable: 1 template: metadata: labels: k8s-app: calico-node spec: nodeSelector: kubernetes.io/os: linux hostNetwork: true tolerations: # Make sure calico-node gets scheduled on all nodes. - effect: NoSchedule operator: Exists # Mark the pod as a critical add-on for rescheduling. - key: CriticalAddonsOnly operator: Exists - effect: NoExecute operator: Exists serviceAccountName: calico-node # Minimize downtime during a rolling upgrade or deletion; tell Kubernetes to do a &quot;force # deletion&quot;: https://kubernetes.io/docs/concepts/workloads/pods/pod/#termination-of-pods. terminationGracePeriodSeconds: 0 priorityClassName: system-node-critical initContainers: # This container performs upgrade from host-local IPAM to calico-ipam. # It can be deleted if this is a fresh installation, or if you have already # upgraded to use calico-ipam. - name: upgrade-ipam image: docker.io/calico/cni:v3.18.0 command: [&quot;/opt/cni/bin/calico-ipam&quot;, &quot;-upgrade&quot;] envFrom: - configMapRef: # Allow KUBERNETES_SERVICE_HOST and KUBERNETES_SERVICE_PORT to be overridden for eBPF mode. name: kubernetes-services-endpoint optional: true env: - name: KUBERNETES_NODE_NAME valueFrom: fieldRef: fieldPath: spec.nodeName - name: CALICO_NETWORKING_BACKEND valueFrom: configMapKeyRef: name: calico-config key: calico_backend volumeMounts: - mountPath: /var/lib/cni/networks name: host-local-net-dir - mountPath: /host/opt/cni/bin name: cni-bin-dir securityContext: privileged: true # This container installs the CNI binaries # and CNI network config file on each node. - name: install-cni image: docker.io/calico/cni:v3.18.0 command: [&quot;/opt/cni/bin/install&quot;] envFrom: - configMapRef: # Allow KUBERNETES_SERVICE_HOST and KUBERNETES_SERVICE_PORT to be overridden for eBPF mode. name: kubernetes-services-endpoint optional: true env: # Name of the CNI config file to create. - name: CNI_CONF_NAME value: &quot;10-calico.conflist&quot; # The CNI network config to install on each node. - name: CNI_NETWORK_CONFIG valueFrom: configMapKeyRef: name: calico-config key: cni_network_config # Set the hostname based on the k8s node name. - name: KUBERNETES_NODE_NAME valueFrom: fieldRef: fieldPath: spec.nodeName # CNI MTU Config variable - name: CNI_MTU valueFrom: configMapKeyRef: name: calico-config key: veth_mtu # Prevents the container from sleeping forever. - name: SLEEP value: &quot;false&quot; volumeMounts: - mountPath: /host/opt/cni/bin name: cni-bin-dir - mountPath: /host/etc/cni/net.d name: cni-net-dir securityContext: privileged: true # Adds a Flex Volume Driver that creates a per-pod Unix Domain Socket to allow Dikastes # to communicate with Felix over the Policy Sync API. - name: flexvol-driver image: docker.io/calico/pod2daemon-flexvol:v3.18.0 volumeMounts: - name: flexvol-driver-host mountPath: /host/driver securityContext: privileged: true containers: # Runs calico-node container on each Kubernetes node. This # container programs network policy and routes on each # host. - name: calico-node image: docker.io/calico/node:v3.18.0 envFrom: - configMapRef: # Allow KUBERNETES_SERVICE_HOST and KUBERNETES_SERVICE_PORT to be overridden for eBPF mode. name: kubernetes-services-endpoint optional: true env: # Use Kubernetes API as the backing datastore. - name: DATASTORE_TYPE value: &quot;kubernetes&quot; # Wait for the datastore. - name: WAIT_FOR_DATASTORE value: &quot;true&quot; # Set based on the k8s node name. - name: NODENAME valueFrom: fieldRef: fieldPath: spec.nodeName # Choose the backend to use. - name: CALICO_NETWORKING_BACKEND valueFrom: configMapKeyRef: name: calico-config key: calico_backend # Cluster type to identify the deployment type - name: CLUSTER_TYPE value: &quot;k8s,bgp&quot; # Auto-detect the BGP IP address. - name: IP value: &quot;autodetect&quot; # Enable IPIP - name: CALICO_IPV4POOL_IPIP value: &quot;Always&quot; - name: IP_AUTODETECTION_METHOD value: &quot;interface=enp0s3&quot; # Enable or Disable VXLAN on the default IP pool. - name: CALICO_IPV4POOL_VXLAN value: &quot;Never&quot; # Set MTU for tunnel device used if ipip is enabled - name: FELIX_IPINIPMTU valueFrom: configMapKeyRef: name: calico-config key: veth_mtu # Set MTU for the VXLAN tunnel device. - name: FELIX_VXLANMTU valueFrom: configMapKeyRef: name: calico-config key: veth_mtu # Set MTU for the Wireguard tunnel device. - name: FELIX_WIREGUARDMTU valueFrom: configMapKeyRef: name: calico-config key: veth_mtu # The default IPv4 pool to create on startup if none exists. Pod IPs will be # chosen from this range. Changing this value after installation will have # no effect. This should fall within `--cluster-cidr`. # - name: CALICO_IPV4POOL_CIDR # value: &quot;192.168.0.0/16&quot; # Disable file logging so `kubectl logs` works. - name: CALICO_DISABLE_FILE_LOGGING value: &quot;true&quot; # Set Felix endpoint to host default action to ACCEPT. - name: FELIX_DEFAULTENDPOINTTOHOSTACTION value: &quot;ACCEPT&quot; # Disable IPv6 on Kubernetes. - name: FELIX_IPV6SUPPORT value: &quot;false&quot; # Set Felix logging to &quot;info&quot; - name: FELIX_LOGSEVERITYSCREEN value: &quot;info&quot; - name: FELIX_HEALTHENABLED value: &quot;true&quot; securityContext: privileged: true resources: requests: cpu: 250m livenessProbe: exec: command: - /bin/calico-node - -felix-live - -bird-live periodSeconds: 10 initialDelaySeconds: 10 failureThreshold: 6 readinessProbe: exec: command: - /bin/calico-node - -felix-ready - -bird-ready periodSeconds: 10 volumeMounts: - mountPath: /lib/modules name: lib-modules readOnly: true - mountPath: /run/xtables.lock name: xtables-lock readOnly: false - mountPath: /var/run/calico name: var-run-calico readOnly: false - mountPath: /var/lib/calico name: var-lib-calico readOnly: false - name: policysync mountPath: /var/run/nodeagent # For eBPF mode, we need to be able to mount the BPF filesystem at /sys/fs/bpf so we mount in the # parent directory. - name: sysfs mountPath: /sys/fs/ # Bidirectional means that, if we mount the BPF filesystem at /sys/fs/bpf it will propagate to the host. # If the host is known to mount that filesystem already then Bidirectional can be omitted. mountPropagation: Bidirectional - name: cni-log-dir mountPath: /var/log/calico/cni readOnly: true volumes: # Used by calico-node. - name: lib-modules hostPath: path: /lib/modules - name: var-run-calico hostPath: path: /var/run/calico - name: var-lib-calico hostPath: path: /var/lib/calico - name: xtables-lock hostPath: path: /run/xtables.lock type: FileOrCreate - name: sysfs hostPath: path: /sys/fs/ type: DirectoryOrCreate # Used to install CNI. - name: cni-bin-dir hostPath: path: /opt/cni/bin - name: cni-net-dir hostPath: path: /etc/cni/net.d # Used to access CNI logs. - name: cni-log-dir hostPath: path: /var/log/calico/cni # Mount in the directory for host-local IPAM allocations. This is # used when upgrading from host-local to calico-ipam, and can be removed # if not using the upgrade-ipam init container. - name: host-local-net-dir hostPath: path: /var/lib/cni/networks # Used to create per-pod Unix Domain Sockets - name: policysync hostPath: type: DirectoryOrCreate path: /var/run/nodeagent # Used to install Flex Volume Driver - name: flexvol-driver-host hostPath: type: DirectoryOrCreate path: /usr/libexec/kubernetes/kubelet-plugins/volume/exec/nodeagent~uds---apiVersion: v1kind: ServiceAccountmetadata: name: calico-node namespace: kube-system---# Source: calico/templates/calico-kube-controllers.yaml# See https://github.com/projectcalico/kube-controllersapiVersion: apps/v1kind: Deploymentmetadata: name: calico-kube-controllers namespace: kube-system labels: k8s-app: calico-kube-controllersspec: # The controllers can only have a single active instance. replicas: 1 selector: matchLabels: k8s-app: calico-kube-controllers strategy: type: Recreate template: metadata: name: calico-kube-controllers namespace: kube-system labels: k8s-app: calico-kube-controllers spec: nodeSelector: kubernetes.io/os: linux tolerations: # Mark the pod as a critical add-on for rescheduling. - key: CriticalAddonsOnly operator: Exists - key: node-role.kubernetes.io/master effect: NoSchedule serviceAccountName: calico-kube-controllers priorityClassName: system-cluster-critical containers: - name: calico-kube-controllers image: docker.io/calico/kube-controllers:v3.18.0 env: # Choose which controllers to run. - name: ENABLED_CONTROLLERS value: node - name: DATASTORE_TYPE value: kubernetes readinessProbe: exec: command: - /usr/bin/check-status - -r---apiVersion: v1kind: ServiceAccountmetadata: name: calico-kube-controllers namespace: kube-system---# This manifest creates a Pod Disruption Budget for Controller to allow K8s Cluster Autoscaler to evictapiVersion: policy/v1kind: PodDisruptionBudgetmetadata: name: calico-kube-controllers namespace: kube-system labels: k8s-app: calico-kube-controllersspec: maxUnavailable: 1 selector: matchLabels: k8s-app: calico-kube-controllers---# Source: calico/templates/calico-etcd-secrets.yaml---# Source: calico/templates/calico-typha.yaml---# Source: calico/templates/configure-canal.yaml","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"34-测试k8s基于docker做容器从harbor拉取镜像","slug":"运维/K8S/基础/34-测试k8s基于docker做容器从harbor拉取镜像","date":"2023-05-17T02:00:00.000Z","updated":"2023-12-24T04:58:54.000Z","comments":true,"path":"2023/05/17/运维/K8S/基础/34-测试k8s基于docker做容器从harbor拉取镜像/","link":"","permalink":"https://dbbruce.github.io/2023/05/17/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/34-%E6%B5%8B%E8%AF%95k8s%E5%9F%BA%E4%BA%8Edocker%E5%81%9A%E5%AE%B9%E5%99%A8%E4%BB%8Eharbor%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F/","excerpt":"1、修改docker配置文件，需要在k8s每个节点都修改docker配置文件1234567cat &gt; /etc/docker/daemon.json &lt;&lt;EOF&#123;&quot;registry-mirrors&quot;:[&quot;https://rsbud4vc.mirror.aliyuncs.com&quot;,&quot;https://registry.docker-cn.com&quot;,&quot;https://docker.mirrors.ustc.edu.cn&quot;,&quot;https://dockerhub.azk8s.cn&quot;,&quot;http://hub-mirror.c.163.com&quot;],&quot;insecure-registries&quot;:[&quot;192.168.40.62&quot;,&quot;harbor&quot;], &quot;exec-opts&quot;:[&quot;native.cgroupdriver=systemd&quot;]&#125;EOF","text":"1、修改docker配置文件，需要在k8s每个节点都修改docker配置文件1234567cat &gt; /etc/docker/daemon.json &lt;&lt;EOF&#123;&quot;registry-mirrors&quot;:[&quot;https://rsbud4vc.mirror.aliyuncs.com&quot;,&quot;https://registry.docker-cn.com&quot;,&quot;https://docker.mirrors.ustc.edu.cn&quot;,&quot;https://dockerhub.azk8s.cn&quot;,&quot;http://hub-mirror.c.163.com&quot;],&quot;insecure-registries&quot;:[&quot;192.168.40.62&quot;,&quot;harbor&quot;], &quot;exec-opts&quot;:[&quot;native.cgroupdriver=systemd&quot;]&#125;EOF 1systemctl restart docker 2、修改linux机器的hosts文件，需要在k8s每个节点和harbor机器上修改12345678vim /etc/hosts127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4::1 localhost localhost.localdomain localhost6 localhost6.localdomain6192.168.1.12 centos07-12192.168.1.22 centos07-22192.168.1.42 centos07-42192.168.1.32 dbbruce-harbor 让k8s每个节点和harbor通过主机名能互相访问 3、创建Secret：1kubectl create secret docker-registry registry-pull-secret --docker-server=192.168.1.32 --docker-username=admin --docker-password=Harbor12345 4、创建pod：1234567891011121314# cat pod.yaml apiVersion: v1kind: Podmetadata: name: nginx namespace: defaultspec: imagePullSecrets: - name: registry-pull-secret # 这里使用上面创建的secret containers: - name: nginx image: 192.168.1.32/test/nginx:v2.5 imagePullPolicy: Always","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"33-测试k8s基于containerd做容器从harbor拉取镜","slug":"运维/K8S/基础/33-测试k8s基于containerd做容器从harbor拉取镜","date":"2023-05-16T12:00:00.000Z","updated":"2023-12-24T04:43:44.000Z","comments":true,"path":"2023/05/16/运维/K8S/基础/33-测试k8s基于containerd做容器从harbor拉取镜/","link":"","permalink":"https://dbbruce.github.io/2023/05/16/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/33-%E6%B5%8B%E8%AF%95k8s%E5%9F%BA%E4%BA%8Econtainerd%E5%81%9A%E5%AE%B9%E5%99%A8%E4%BB%8Eharbor%E6%8B%89%E5%8F%96%E9%95%9C/","excerpt":"查看下容器运行时（CONTAINER-RUNTIME），是否是containerd12345[root@centos07-12 ~]# kubectl get nodes -o wideNAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIMEcentos07-12 Ready control-plane 12h v1.28.1 192.168.1.12 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 containerd://1.6.6centos07-22 Ready work 12h v1.28.1 192.168.1.22 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 containerd://1.6.6centos07-42 Ready work 12h v1.28.1 192.168.1.42 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 containerd://1.6.6","text":"查看下容器运行时（CONTAINER-RUNTIME），是否是containerd12345[root@centos07-12 ~]# kubectl get nodes -o wideNAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIMEcentos07-12 Ready control-plane 12h v1.28.1 192.168.1.12 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 containerd://1.6.6centos07-22 Ready work 12h v1.28.1 192.168.1.22 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 containerd://1.6.6centos07-42 Ready work 12h v1.28.1 192.168.1.42 &lt;none&gt; CentOS Linux 7 (Core) 3.10.0-1160.105.1.el7.x86_64 containerd://1.6.6 如果是虚拟机先做个新备份，因为需要重新安装containerd需要一台haibor，可以参考 docker-基础-17-Docker私有镜像仓库harbor安装1.6.22 稳定版1、删除老版本，安装1.6.22 – centos07-12&#x2F;22&#x2F;42注意：装个containerd后，删除软件，目录不会删除，&#x2F;etc&#x2F;containerd&#x2F; 1234yum remove containerd.io -yyum install containerd.io-1.6.22* -ycd /etc/containerd/rm -rf * 2、把课程资料里提供的config.toml文件传到 &#x2F;etc&#x2F;containerd&#x2F;目录下 – centos07-12&#x2F;22&#x2F;42修改以下内容：1、SystemdCgroup &#x3D; true # false 改为 true2、sandbox_image &#x3D; “registry.aliyuncs.com&#x2F;google_containers&#x2F;pause:3.7” # 把google的地址，改为阿里云地址3、新增下面一段，注意缩进，1、修改ip为harborip 1234567891011121314[plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs] [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs.&quot;192.168.1.32&quot;.tls] insecure_skip_verify = true [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs.&quot;192.168.1.32&quot;.auth] username = &quot;admin&quot; password = &quot;Harbor12345&quot;[plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.headers][plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors] [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;192.168.1.32&quot;] endpoint = [&quot;https://192.168.1.32:443&quot;] [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;docker.io&quot;] endpoint = [&quot;https://vh3bm52y.mirror.aliyuncs.com&quot;,&quot;https://registry.docker-cn.com&quot;] 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261# vim /etc/containerd/config.tomldisabled_plugins = []imports = []oom_score = 0plugin_dir = &quot;&quot;required_plugins = []root = &quot;/var/lib/containerd&quot;state = &quot;/run/containerd&quot;temp = &quot;&quot;version = 2[cgroup] path = &quot;&quot;[debug] address = &quot;&quot; format = &quot;&quot; gid = 0 level = &quot;&quot; uid = 0[grpc] address = &quot;/run/containerd/containerd.sock&quot; gid = 0 max_recv_message_size = 16777216 max_send_message_size = 16777216 tcp_address = &quot;&quot; tcp_tls_ca = &quot;&quot; tcp_tls_cert = &quot;&quot; tcp_tls_key = &quot;&quot; uid = 0[metrics] address = &quot;&quot; grpc_histogram = false[plugins] [plugins.&quot;io.containerd.gc.v1.scheduler&quot;] deletion_threshold = 0 mutation_threshold = 100 pause_threshold = 0.02 schedule_delay = &quot;0s&quot; startup_delay = &quot;100ms&quot; [plugins.&quot;io.containerd.grpc.v1.cri&quot;] device_ownership_from_security_context = false disable_apparmor = false disable_cgroup = false disable_hugetlb_controller = true disable_proc_mount = false disable_tcp_service = true enable_selinux = false enable_tls_streaming = false enable_unprivileged_icmp = false enable_unprivileged_ports = false ignore_image_defined_volumes = false max_concurrent_downloads = 3 max_container_log_line_size = 16384 netns_mounts_under_state_dir = false restrict_oom_score_adj = false sandbox_image = &quot;registry.aliyuncs.com/google_containers/pause:3.7&quot; selinux_category_range = 1024 stats_collect_period = 10 stream_idle_timeout = &quot;4h0m0s&quot; stream_server_address = &quot;127.0.0.1&quot; stream_server_port = &quot;0&quot; systemd_cgroup = false tolerate_missing_hugetlb_controller = true unset_seccomp_profile = &quot;&quot; [plugins.&quot;io.containerd.grpc.v1.cri&quot;.cni] bin_dir = &quot;/opt/cni/bin&quot; conf_dir = &quot;/etc/cni/net.d&quot; conf_template = &quot;&quot; ip_pref = &quot;&quot; max_conf_num = 1 [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd] default_runtime_name = &quot;runc&quot; disable_snapshot_annotations = true discard_unpacked_layers = false ignore_rdt_not_enabled_errors = false no_pivot = false snapshotter = &quot;overlayfs&quot; [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.default_runtime] base_runtime_spec = &quot;&quot; cni_conf_dir = &quot;&quot; cni_max_conf_num = 0 container_annotations = [] pod_annotations = [] privileged_without_host_devices = false runtime_engine = &quot;&quot; runtime_path = &quot;&quot; runtime_root = &quot;&quot; runtime_type = &quot;&quot; [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.default_runtime.options] [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes] [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc] base_runtime_spec = &quot;&quot; cni_conf_dir = &quot;&quot; cni_max_conf_num = 0 container_annotations = [] pod_annotations = [] privileged_without_host_devices = false runtime_engine = &quot;&quot; runtime_path = &quot;&quot; runtime_root = &quot;&quot; runtime_type = &quot;io.containerd.runc.v2&quot; [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options] BinaryName = &quot;&quot; CriuImagePath = &quot;&quot; CriuPath = &quot;&quot; CriuWorkPath = &quot;&quot; IoGid = 0 IoUid = 0 NoNewKeyring = false NoPivotRoot = false Root = &quot;&quot; ShimCgroup = &quot;&quot; SystemdCgroup = true [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.untrusted_workload_runtime] base_runtime_spec = &quot;&quot; cni_conf_dir = &quot;&quot; cni_max_conf_num = 0 container_annotations = [] pod_annotations = [] privileged_without_host_devices = false runtime_engine = &quot;&quot; runtime_path = &quot;&quot; runtime_root = &quot;&quot; runtime_type = &quot;&quot; [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.untrusted_workload_runtime.options] [plugins.&quot;io.containerd.grpc.v1.cri&quot;.image_decryption] key_model = &quot;node&quot; [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry] config_path = &quot;&quot; [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.auths] [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs] [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs.&quot;192.168.1.32&quot;.tls] insecure_skip_verify = true [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs.&quot;192.168.1.32&quot;.auth] username = &quot;admin&quot; password = &quot;Harbor12345&quot; [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.headers] [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors] [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;192.168.1.32&quot;] endpoint = [&quot;https://192.168.1.32:443&quot;] [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;docker.io&quot;] endpoint = [&quot;https://vh3bm52y.mirror.aliyuncs.com&quot;,&quot;https://registry.docker-cn.com&quot;] [plugins.&quot;io.containerd.grpc.v1.cri&quot;.x509_key_pair_streaming] tls_cert_file = &quot;&quot; tls_key_file = &quot;&quot; [plugins.&quot;io.containerd.internal.v1.opt&quot;] path = &quot;/opt/containerd&quot; [plugins.&quot;io.containerd.internal.v1.restart&quot;] interval = &quot;10s&quot; [plugins.&quot;io.containerd.internal.v1.tracing&quot;] sampling_ratio = 1.0 service_name = &quot;containerd&quot; [plugins.&quot;io.containerd.metadata.v1.bolt&quot;] content_sharing_policy = &quot;shared&quot; [plugins.&quot;io.containerd.monitor.v1.cgroups&quot;] no_prometheus = false [plugins.&quot;io.containerd.runtime.v1.linux&quot;] no_shim = false runtime = &quot;runc&quot; runtime_root = &quot;&quot; shim = &quot;containerd-shim&quot; shim_debug = false [plugins.&quot;io.containerd.runtime.v2.task&quot;] platforms = [&quot;linux/amd64&quot;] sched_core = false [plugins.&quot;io.containerd.service.v1.diff-service&quot;] default = [&quot;walking&quot;] [plugins.&quot;io.containerd.service.v1.tasks-service&quot;] rdt_config_file = &quot;&quot; [plugins.&quot;io.containerd.snapshotter.v1.aufs&quot;] root_path = &quot;&quot; [plugins.&quot;io.containerd.snapshotter.v1.btrfs&quot;] root_path = &quot;&quot; [plugins.&quot;io.containerd.snapshotter.v1.devmapper&quot;] async_remove = false base_image_size = &quot;&quot; discard_blocks = false fs_options = &quot;&quot; fs_type = &quot;&quot; pool_name = &quot;&quot; root_path = &quot;&quot; [plugins.&quot;io.containerd.snapshotter.v1.native&quot;] root_path = &quot;&quot; [plugins.&quot;io.containerd.snapshotter.v1.overlayfs&quot;] root_path = &quot;&quot; upperdir_label = false [plugins.&quot;io.containerd.snapshotter.v1.zfs&quot;] root_path = &quot;&quot; [plugins.&quot;io.containerd.tracing.processor.v1.otlp&quot;] endpoint = &quot;&quot; insecure = false protocol = &quot;&quot;[proxy_plugins][stream_processors] [stream_processors.&quot;io.containerd.ocicrypt.decoder.v1.tar&quot;] accepts = [&quot;application/vnd.oci.image.layer.v1.tar+encrypted&quot;] args = [&quot;--decryption-keys-path&quot;, &quot;/etc/containerd/ocicrypt/keys&quot;] env = [&quot;OCICRYPT_KEYPROVIDER_CONFIG=/etc/containerd/ocicrypt/ocicrypt_keyprovider.conf&quot;] path = &quot;ctd-decoder&quot; returns = &quot;application/vnd.oci.image.layer.v1.tar&quot; [stream_processors.&quot;io.containerd.ocicrypt.decoder.v1.tar.gzip&quot;] accepts = [&quot;application/vnd.oci.image.layer.v1.tar+gzip+encrypted&quot;] args = [&quot;--decryption-keys-path&quot;, &quot;/etc/containerd/ocicrypt/keys&quot;] env = [&quot;OCICRYPT_KEYPROVIDER_CONFIG=/etc/containerd/ocicrypt/ocicrypt_keyprovider.conf&quot;] path = &quot;ctd-decoder&quot; returns = &quot;application/vnd.oci.image.layer.v1.tar+gzip&quot;[timeouts] &quot;io.containerd.timeout.bolt.open&quot; = &quot;0s&quot; &quot;io.containerd.timeout.shim.cleanup&quot; = &quot;5s&quot; &quot;io.containerd.timeout.shim.load&quot; = &quot;5s&quot; &quot;io.containerd.timeout.shim.shutdown&quot; = &quot;3s&quot; &quot;io.containerd.timeout.task.state&quot; = &quot;2s&quot;[ttrpc] address = &quot;&quot; gid = 0 uid = 0 3、重启containerd – centos07-12&#x2F;22&#x2F;421systemctl restart containerd 1234567891011121314151617181920212223242526272829systemctl status containerd● containerd.service - containerd container runtime Loaded: loaded (/usr/lib/systemd/system/containerd.service; disabled; vendor preset: disabled) Active: active (running) since 日 2023-12-24 12:08:28 CST; 1min 14s ago Docs: https://containerd.io Process: 17599 ExecStartPre=/sbin/modprobe overlay (code=exited, status=0/SUCCESS) Main PID: 17601 (containerd) Tasks: 70 Memory: 169.9M CGroup: /system.slice/containerd.service ├─ 1882 /usr/bin/containerd-shim-runc-v2 -namespace k8s.io -id 558effb5d2da48ba3fb5ad561f2a337bc54857eb7daca47c6845bdb52d3df35d -address /run/containerd/containerd.sock ├─ 1962 /usr/bin/containerd-shim-runc-v2 -namespace k8s.io -id e14d9c1e151c565526fa174c43b3fc86cabf10e2636f79d84ef10e70b56a2ad1 -address /run/containerd/containerd.sock ├─ 3126 /usr/bin/containerd-shim-runc-v2 -namespace k8s.io -id 2f2940aa848cf9077047cd704f1e444e676bd4f2143c9a3262fe9127e14f2584 -address /run/containerd/containerd.sock ├─ 3174 /usr/bin/containerd-shim-runc-v2 -namespace k8s.io -id 1169d9b8a3dd23d5e002888264647a6d924646d47104382745b791d0ddfc7660 -address /run/containerd/containerd.sock ├─ 3224 /usr/bin/containerd-shim-runc-v2 -namespace k8s.io -id 7e6ae4e017bc8d9ca48b1c63a046928886c60bf5098bf0c52b3ee0d7c8bfa067 -address /run/containerd/containerd.sock └─17601 /usr/bin/containerd12月 24 12:08:28 centos07-22 containerd[17601]: time=&quot;2023-12-24T12:08:28.554812680+08:00&quot; level=info msg=serving... address=/run/containerd/containerd.sock.ttrpc12月 24 12:08:28 centos07-22 containerd[17601]: time=&quot;2023-12-24T12:08:28.555165607+08:00&quot; level=info msg=serving... address=/run/containerd/containerd.sock12月 24 12:08:28 centos07-22 containerd[17601]: time=&quot;2023-12-24T12:08:28.557182024+08:00&quot; level=info msg=&quot;Start subscribing containerd event&quot;12月 24 12:08:28 centos07-22 containerd[17601]: time=&quot;2023-12-24T12:08:28.557269831+08:00&quot; level=info msg=&quot;Start recovering state&quot;12月 24 12:08:28 centos07-22 containerd[17601]: time=&quot;2023-12-24T12:08:28.854586173+08:00&quot; level=info msg=&quot;Start event monitor&quot;12月 24 12:08:28 centos07-22 containerd[17601]: time=&quot;2023-12-24T12:08:28.854667877+08:00&quot; level=info msg=&quot;Start snapshots syncer&quot;12月 24 12:08:28 centos07-22 containerd[17601]: time=&quot;2023-12-24T12:08:28.855968929+08:00&quot; level=info msg=&quot;Start cni network conf syncer for default&quot;12月 24 12:08:28 centos07-22 containerd[17601]: time=&quot;2023-12-24T12:08:28.856021603+08:00&quot; level=info msg=&quot;Start streaming server&quot;12月 24 12:08:28 centos07-22 containerd[17601]: time=&quot;2023-12-24T12:08:28.856224429+08:00&quot; level=info msg=&quot;containerd successfully booted in 0.495595s&quot;12月 24 12:08:28 centos07-22 systemd[1]: Started containerd container runtime. 4、卸载containerd时，可能卸载了docker，重装下docker – centos07-12&#x2F;22&#x2F;42docker是为了做镜像，docker build做镜像 1yum -y install docker-ce 1systemctl start docker 5、上传一个镜像到harbor，任意一台机器都可以，我用22做例子 –centos07- 22拉取一个镜像 1docker pull nginx 123[root@centos07-22 containerd]# docker imagesREPOSITORY TAG IMAGE ID CREATED SIZEnginx latest 605c77e624dd 24 months ago 141MB 打标签，加上harborip和仓库名称：192.168.1.32（harborip）+ test（harbor项目）+ 镜像名 + 版本 1docker tag nginx:latest 192.168.1.32/test/nginx:v2.5 1234[root@centos07-22 containerd]# docker imagesREPOSITORY TAG IMAGE ID CREATED SIZE192.168.1.32/test/nginx v2.5 605c77e624dd 24 months ago 141MBnginx latest 605c77e624dd 24 months ago 141MB 6、允许使用http上传镜像，修改配置文件 –centos07- 22加一段： “insecure-registries”: [“192.168.1.32”,”harbor”] 1234&#123; &quot;registry-mirrors&quot;: [&quot;https://882k7j67.mirror.aliyuncs.com&quot;], &quot;insecure-registries&quot;: [&quot;192.168.1.32&quot;,&quot;harbor&quot;]&#125; 重启，配置生效 1systemctl restart docker 7、修改hosts文件，使harbor和centos07-22，可以使用主机名互通 – harbor centos07-22centos07-22 12345678vim /etc/hosts127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4::1 localhost localhost.localdomain localhost6 localhost6.localdomain6192.168.1.12 centos07-12192.168.1.22 centos07-22192.168.1.42 centos07-42192.168.1.32 dbbruce-harbor harbor 1234567vim /etc/hosts127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4::1 localhost localhost.localdomain localhost6 localhost6.localdomain6192.168.1.32 dbbruce-harbor192.168.1.12 CentOS07-12192.168.1.22 centos07-22 8、登录harbor – centos07-2212345678[root@centos07-22 containerd]# docker login 192.168.1.32Username: adminPassword:WARNING! Your password will be stored unencrypted in /root/.docker/config.json.Configure a credential helper to remove this warning. Seehttps://docs.docker.com/engine/reference/commandline/login/#credentials-storeLogin Succeeded 1234[root@centos07-22 containerd]# docker imagesREPOSITORY TAG IMAGE ID CREATED SIZE192.168.1.32/test/nginx v2.5 605c77e624dd 24 months ago 141MBnginx latest 605c77e624dd 24 months ago 141MB 1docker push 192.168.1.32/test/nginx:v2.5 9、登录harborweb，查看镜像 – chrome 10、编写yaml从harbor拉取镜像，创建pod – centos07-12123456789101112# cat pod.yaml apiVersion: v1kind: Podmetadata: name: nginx namespace: defaultspec: containers: - name: nginx image: 192.168.1.32/test/nginx:v2.5 imagePullPolicy: Always 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165[root@centos07-12 ~]# kubectl apply -f pod.yamlpod/nginx created[root@centos07-12 ~]# kubectl get podsNAME READY STATUS RESTARTS AGEnginx 0/1 ContainerCreating 0 8s[root@centos07-12 ~]# kubectl describe pods nginxName: nginxNamespace: defaultPriority: 0Service Account: defaultNode: centos07-22/192.168.1.22Start Time: Sun, 24 Dec 2023 12:39:21 +0800Labels: &lt;none&gt;Annotations: cni.projectcalico.org/podIP: 10.188.193.136/32 cni.projectcalico.org/podIPs: 10.188.193.136/32Status: PendingIP:IPs: &lt;none&gt;Containers: nginx: Container ID: Image: 192.168.1.32/test/nginx:v2.5 Image ID: Port: &lt;none&gt; Host Port: &lt;none&gt; State: Waiting Reason: ContainerCreating Ready: False Restart Count: 0 Environment: &lt;none&gt; Mounts: /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-dc5h7 (ro)Conditions: Type Status Initialized True Ready False ContainersReady False PodScheduled TrueVolumes: kube-api-access-dc5h7: Type: Projected (a volume that contains injected data from multiple sources) TokenExpirationSeconds: 3607 ConfigMapName: kube-root-ca.crt ConfigMapOptional: &lt;nil&gt; DownwardAPI: trueQoS Class: BestEffortNode-Selectors: &lt;none&gt;Tolerations: node.kubernetes.io/not-ready:NoExecute op=Exists for 300s node.kubernetes.io/unreachable:NoExecute op=Exists for 300sEvents: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 35s default-scheduler Successfully assigned default/nginx to centos07-22 Normal Pulling 33s kubelet Pulling image &quot;192.168.1.32/test/nginx:v2.5&quot;[root@centos07-12 ~]# kubectl describe pods nginxName: nginxNamespace: defaultPriority: 0Service Account: defaultNode: centos07-22/192.168.1.22Start Time: Sun, 24 Dec 2023 12:39:21 +0800Labels: &lt;none&gt;Annotations: cni.projectcalico.org/podIP: 10.188.193.136/32 cni.projectcalico.org/podIPs: 10.188.193.136/32Status: PendingIP:IPs: &lt;none&gt;Containers: nginx: Container ID: Image: 192.168.1.32/test/nginx:v2.5 Image ID: Port: &lt;none&gt; Host Port: &lt;none&gt; State: Waiting Reason: ContainerCreating Ready: False Restart Count: 0 Environment: &lt;none&gt; Mounts: /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-dc5h7 (ro)Conditions: Type Status Initialized True Ready False ContainersReady False PodScheduled TrueVolumes: kube-api-access-dc5h7: Type: Projected (a volume that contains injected data from multiple sources) TokenExpirationSeconds: 3607 ConfigMapName: kube-root-ca.crt ConfigMapOptional: &lt;nil&gt; DownwardAPI: trueQoS Class: BestEffortNode-Selectors: &lt;none&gt;Tolerations: node.kubernetes.io/not-ready:NoExecute op=Exists for 300s node.kubernetes.io/unreachable:NoExecute op=Exists for 300sEvents: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 36s default-scheduler Successfully assigned default/nginx to centos07-22 Normal Pulling 34s kubelet Pulling image &quot;192.168.1.32/test/nginx:v2.5&quot; Normal Pulled 0s kubelet Successfully pulled image &quot;192.168.1.32/test/nginx:v2.5&quot; in 34.481s (34.481s including waiting) Normal Created 0s kubelet Created container nginx Normal Started 0s kubelet Started container nginx[root@centos07-12 ~]# kubectl describe pods nginxName: nginxNamespace: defaultPriority: 0Service Account: defaultNode: centos07-22/192.168.1.22Start Time: Sun, 24 Dec 2023 12:39:21 +0800Labels: &lt;none&gt;Annotations: cni.projectcalico.org/podIP: 10.188.193.136/32 cni.projectcalico.org/podIPs: 10.188.193.136/32Status: RunningIP: 10.188.193.136IPs: IP: 10.188.193.136Containers: nginx: Container ID: containerd://3616cb846fa8901980c1dd8c3692e5df5831a16558d44df05a0c245ff17178a6 Image: 192.168.1.32/test/nginx:v2.5 Image ID: 192.168.1.32/test/nginx@sha256:ee89b00528ff4f02f2405e4ee221743ebc3f8e8dd0bfd5c4c20a2fa2aaa7ede3 Port: &lt;none&gt; Host Port: &lt;none&gt; State: Running Started: Sun, 24 Dec 2023 12:39:58 +0800 Ready: True Restart Count: 0 Environment: &lt;none&gt; Mounts: /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-dc5h7 (ro)Conditions: Type Status Initialized True Ready True ContainersReady True PodScheduled TrueVolumes: kube-api-access-dc5h7: Type: Projected (a volume that contains injected data from multiple sources) TokenExpirationSeconds: 3607 ConfigMapName: kube-root-ca.crt ConfigMapOptional: &lt;nil&gt; DownwardAPI: trueQoS Class: BestEffortNode-Selectors: &lt;none&gt;Tolerations: node.kubernetes.io/not-ready:NoExecute op=Exists for 300s node.kubernetes.io/unreachable:NoExecute op=Exists for 300sEvents: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 38s default-scheduler Successfully assigned default/nginx to centos07-22 Normal Pulling 36s kubelet Pulling image &quot;192.168.1.32/test/nginx:v2.5&quot; Normal Pulled 2s kubelet Successfully pulled image &quot;192.168.1.32/test/nginx:v2.5&quot; in 34.481s (34.481s including waiting) Normal Created 1s kubelet Created container nginx Normal Started 1s kubelet Started container nginx[root@centos07-12 ~]# kubectl get podsNAME READY STATUS RESTARTS AGEnginx 1/1 Running 0 55s","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"32-k8s1.28新版本安装","slug":"运维/K8S/基础/32-k8s1.28新版本安装","date":"2023-05-16T02:00:00.000Z","updated":"2023-12-24T03:03:24.000Z","comments":true,"path":"2023/05/16/运维/K8S/基础/32-k8s1.28新版本安装/","link":"","permalink":"https://dbbruce.github.io/2023/05/16/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/32-k8s1.28%E6%96%B0%E7%89%88%E6%9C%AC%E5%AE%89%E8%A3%85/","excerpt":"kubeadm安装k8s1.28集群k8s环境规划： podSubnet（pod网段） 10.188.0.0&#x2F;16 serviceSubnet（service网段）: 10.88.0.0&#x2F;12 实验环境规划：操作系统：centos7.9配置： 4Gib内存&#x2F;4vCPU&#x2F;60G硬盘网络：NAT模式","text":"kubeadm安装k8s1.28集群k8s环境规划： podSubnet（pod网段） 10.188.0.0&#x2F;16 serviceSubnet（service网段）: 10.88.0.0&#x2F;12 实验环境规划：操作系统：centos7.9配置： 4Gib内存&#x2F;4vCPU&#x2F;60G硬盘网络：NAT模式 12[root@centos07-42 ~]# cat /etc/redhat-releaseCentOS Linux release 7.9.2009 (Core) 12[root@centos07-12 ~]# cat /proc/cpuinfo[root@centos07-12 ~]# cat /proc/meminfo K8S集群角色 IP 主机名 安装组件 控制节点 192.168.1.12 centos07-12 apiserver、controller-manager、schedule、kubelet、etcd、kube-proxy、容器运行时、calico 工作节点 192.168.1.22 centos07-22 Kube-proxy、calico、coredns、容器运行时、kubelet 工作节点 192.168.1.42 centos07-42 Kube-proxy、calico、coredns、容器运行时、kubelet 1.1 初始化安装k8s集群的实验环境1.1.1 修改机器IP，变成静态IP - centos07-12&#x2F;22&#x2F;421234567891011121314151617181920# vim /etc/sysconfig/network-scripts/ifcfg-enp0s3 文件TYPE=EthernetPROXY_METHOD=noneBROWSER_ONLY=noBOOTPROTO=staticIPADDR=192.168.1.12NETMASK=255.255.255.0GATEWAY=192.168.1.2DNS1=192.168.1.2DEFROUTE=yesIPV4_FAILURE_FATAL=noIPV6INIT=yesIPV6_AUTOCONF=yesIPV6_DEFROUTE=yesIPV6_FAILURE_FATAL=noIPV6_ADDR_GEN_MODE=stable-privacyNAME=enp0s3DEVICE=enp0s3ONBOOT=yes 修改配置文件之后需要重启网络服务才能使配置生效，重启网络服务命令如下： - centos07-12&#x2F;22&#x2F;42 service network restart 12[root@centos07-12 ~]# service network restartRestarting network (via systemctl): [ OK ] 123456789注：/etc/sysconfig/network-scripts/ifcfg-enp0s3文件里的配置说明：NAME=enp0s3 #网卡名字，跟DEVICE名字保持一致即可DEVICE=enp0s3 #网卡设备名，大家ip addr可看到自己的这个网卡设备名，每个人的机器可能这个名字不一样，需要写自己的BOOTPROTO=static #static表示静态ip地址ONBOOT=yes #开机自启动网络，必须是yesIPADDR=192.168.1.12 #ip地址，需要跟自己电脑所在网段一致NETMASK=255.255.255.0 #子网掩码，需要跟自己电脑所在网段一致GATEWAY=192.168.1.2 #网关，在自己电脑打开cmd，输入ipconfig /all可看到DNS1=192.168.1.2 #DNS，在自己电脑打开cmd，输入ipconfig /all可看到 各个节点执行如下命令更新yum源和操作系统： - centos07-12&#x2F;22&#x2F;42 1yum update -y 1.1.2 关闭selinux，所有k8s机器均操作 - centos07-12&#x2F;22&#x2F;42 - centos07-12&#x2F;22&#x2F;421sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config 修改selinux配置文件之后，重启机器，selinux配置才能永久生效，重启之后，登录到机器，执行如下命令： 1getenforce 如果显示Disabled说明selinux已经关闭 1.1.3 配置机器主机名 - centos07-12&#x2F;22&#x2F;42在192.168.1.12 上执行如下： 1hostnamectl set-hostname centos07-12 &amp;&amp; bash 在192.168.1.22 上执行如下： 1hostnamectl set-hostname centos07-22 &amp;&amp; bash 在192.168.1.42 上执行如下： 1hostnamectl set-hostname centos07-42 &amp;&amp; bash 1.1.4 配置主机hosts文件，相互之间通过主机名互相访问 - centos07-12&#x2F;22&#x2F;42修改每台机器的&#x2F;etc&#x2F;hosts文件，文件最后增加如下内容： 123192.168.1.12 centos07-12192.168.1.22 centos07-22192.168.1.42 centos07-42 1.1.5 配置主机之间无密码登录 - centos07-12&#x2F;22&#x2F;42配置3台机器互相免密登录 1ssh-keygen #一路回车，不输入密码 把本地生成的密钥文件和私钥文件拷贝到远程主机 123ssh-copy-id centos07-12ssh-copy-id centos07-22ssh-copy-id centos07-42 1.1.6 关闭交换分区swap，提升性能 - centos07-12&#x2F;22&#x2F;42临时关闭 1swapoff -a 永久关闭：注释swap挂载，给swap这行开头加一下注释 123vim /etc/fstab #/dev/mapper/centos-swap swap swap defaults 0 0 问题1：为什么要关闭swap交换分区？Swap是交换分区，如果机器内存不够，会使用swap分区，但是swap分区的性能较低，k8s设计的时候为了能提升性能，默认是不允许使用交换分区的。Kubeadm初始化的时候会检测swap是否关闭，如果没关闭，那就初始化失败。如果不想要关闭交换分区，安装k8s的时候可以指定–ignore-preflight-errors&#x3D;Swap来解决。 1.1.7 修改机器内核参数 - centos07-12&#x2F;22&#x2F;4212345678modprobe br_netfiltercat &gt; /etc/sysctl.d/k8s.conf &lt;&lt;EOFnet.bridge.bridge-nf-call-ip6tables = 1net.bridge.bridge-nf-call-iptables = 1net.ipv4.ip_forward = 1EOF 1sysctl -p /etc/sysctl.d/k8s.conf 问题1：sysctl是做什么的？在运行时配置内核参数 :-p 从指定的文件加载系统参数，如不指定即从&#x2F;etc&#x2F;sysctl.conf中加载 问题2：为什么要执行modprobe br_netfilter？修改&#x2F;etc&#x2F;sysctl.d&#x2F;k8s.conf文件，增加如下三行参数：net.bridge.bridge-nf-call-ip6tables &#x3D; 1net.bridge.bridge-nf-call-iptables &#x3D; 1net.ipv4.ip_forward &#x3D; 1 sysctl -p &#x2F;etc&#x2F;sysctl.d&#x2F;k8s.conf出现报错：sysctl: cannot stat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;bridge&#x2F;bridge-nf-call-ip6tables: No such file or directorysysctl: cannot stat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;bridge&#x2F;bridge-nf-call-iptables: No such file or directory 解决方法：modprobe br_netfilter 问题3：为什么开启net.bridge.bridge-nf-call-iptables内核参数？在centos下安装docker，执行docker info出现如下警告：WARNING: bridge-nf-call-iptables is disabledWARNING: bridge-nf-call-ip6tables is disabled 解决办法：vim &#x2F;etc&#x2F;sysctl.d&#x2F;k8s.confnet.bridge.bridge-nf-call-ip6tables &#x3D; 1net.bridge.bridge-nf-call-iptables &#x3D; 1 问题4：为什么要开启net.ipv4.ip_forward &#x3D; 1参数？kubeadm初始化k8s如果报错： 就表示没有开启ip_forward，需要开启。 net.ipv4.ip_forward是数据包转发：出于安全考虑，Linux系统默认是禁止数据包转发的。所谓转发即当主机拥有多于一块的网卡时，其中一块收到数据包，根据数据包的目的ip地址将数据包发往本机另一块网卡，该网卡根据路由表继续发送数据包。这通常是路由器所要实现的功能。要让Linux系统具有路由转发功能，需要配置一个Linux的内核参数net.ipv4.ip_forward。这个参数指定了Linux系统当前对路由转发功能的支持情况；其值为0时表示禁止进行IP转发；如果是1,则说明IP转发功能已经打开。 1.1.8 关闭firewalld防火墙 - centos07-12&#x2F;22&#x2F;421systemctl stop firewalld ; systemctl disable firewalld 1.1.9 配置阿里云的repo源 - centos07-12&#x2F;22&#x2F;42配置国内安装docker和containerd的阿里云的repo源 1yum install yum-utils -y 1yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo 12ll /etc/yum.repos.d/docker-ce.repo-rw-r--r-- 1 root root 2081 12月 23 16:33 /etc/yum.repos.d/docker-ce.repo 1.1.10 配置安装k8s组件需要的阿里云的repo源 - centos07-12&#x2F;22&#x2F;4212345678cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt;EOF[kubernetes]name=Kubernetesbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/enabled=1gpgcheck=0EOF 1.1.11 配置时间同步 - centos07-12&#x2F;22&#x2F;42安装ntpdate命令 1yum install ntpdate -y 跟网络时间做同步 1ntpdate cn.pool.ntp.org 把时间同步做成计划任务 123crontab -e* */1 * * * /usr/sbin/ntpdate cn.pool.ntp.org 重启crond服务 1service crond restart 1.1.12 安装基础软件包 - centos07-12&#x2F;22&#x2F;421yum install -y device-mapper-persistent-data lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel python-devel epel-release openssh-server socat ipvsadm conntrack telnet ipvsadm 1.1.13 如果是虚拟机，最好在这里做个镜像1.2、安装containerd服务1.2.1 安装containerd - centos07-12&#x2F;22&#x2F;421yum install containerd.io-1.6.6 -y 接下来生成 containerd 的配置文件: 12mkdir -p /etc/containerdcontainerd config default &gt; /etc/containerd/config.toml 修改配置文件：打开&#x2F;etc&#x2F;containerd&#x2F;config.toml把SystemdCgroup &#x3D; false修改成SystemdCgroup &#x3D; true把sandbox_image &#x3D; “k8s.gcr.io&#x2F;pause:3.6”修改成sandbox_image&#x3D;”registry.aliyuncs.com&#x2F;google_containers&#x2F;pause:3.7” 1234vim /etc/containerd/config.toml61 sandbox_image = &quot;registry.aliyuncs.com/google_containers/pause:3.7&quot;125 SystemdCgroup = true 配置 containerd 开机启动，并启动 containerd 1systemctl enable containerd --now 修改&#x2F;etc&#x2F;crictl.yaml文件 1234567cat &gt; /etc/crictl.yaml &lt;&lt;EOFruntime-endpoint: unix:///run/containerd/containerd.sockimage-endpoint: unix:///run/containerd/containerd.socktimeout: 10debug: falseEOF 1systemctl restart containerd 备注：docker也要安装，docker跟containerd不冲突，安装docker是为了能基于dockerfile构建镜像 1yum install docker-ce -y 1systemctl enable docker --now 配置containerd镜像加速器，k8s所有节点均按照以下配置：编辑vim &#x2F;etc&#x2F;containerd&#x2F;config.toml文件找到config_path &#x3D; “”，修改成如下目录：config_path &#x3D; “&#x2F;etc&#x2F;containerd&#x2F;certs.d”保存退出 123vim /etc/containerd/config.toml145 config_path = &quot;/etc/containerd/certs.d&quot; 1234567mkdir /etc/containerd/certs.d/docker.io/ -pvim /etc/containerd/certs.d/docker.io/hosts.toml# 写入如下内容：[host.&quot;https://vh3bm52y.mirror.aliyuncs.com&quot;,host.&quot;https://registry.docker-cn.com&quot;] capabilities = [&quot;pull&quot;] 重启containerd： 1systemctl restart containerd 配置docker镜像加速器，k8s所有节点均按照以下配置 123456sudo mkdir -p /etc/dockersudo tee /etc/docker/daemon.json &lt;&lt;-&#x27;EOF&#x27;&#123; &quot;registry-mirrors&quot;: [&quot;https://882k7j67.mirror.aliyuncs.com&quot;]&#125;EOF 重启docker： 12sudo systemctl daemon-reloadsudo systemctl restart docker 1.3、安装初始化k8s需要的软件包 - centos07-12&#x2F;22&#x2F;42123yum install -y kubelet-1.28.1 kubeadm-1.28.1 kubectl-1.28.1systemctl enable kubelet 注：每个软件包的作用Kubeadm: kubeadm是一个工具，用来初始化k8s集群的kubelet: 安装在集群所有节点上，用于启动Pod的，kubeadm安装k8s，k8s控制节点和工作节点的组件，都是基于pod运行的，只要pod启动，就需要kubeletkubectl: 通过kubectl可以部署和管理应用，查看各种资源，创建、删除和更新各种组件 1.4、kubeadm初始化k8s集群 - centos07-12使用kubeadm初始化k8s集群 - centos07-12 1kubeadm config print init-defaults &gt; kubeadm.yaml 根据我们自己的需求修改配置，比如修改 imageRepository 的值，kube-proxy 的模式为 ipvs，需要注意的是由于我们使用的containerd作为运行时，所以在初始化节点的时候需要指定cgroupDriver为systemdkubeadm.yaml配置文件如下： 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748# vim kubeadm.yamlapiVersion: kubeadm.k8s.io/v1beta3bootstrapTokens:- groups: - system:bootstrappers:kubeadm:default-node-token token: abcdef.0123456789abcdef ttl: 24h0m0s usages: - signing - authenticationkind: InitConfigurationlocalAPIEndpoint: advertiseAddress: 192.168.1.12 # 控制节点的ip bindPort: 6443nodeRegistration: criSocket: unix:///run/containerd/containerd.sock #指定containerd容器运行时 imagePullPolicy: IfNotPresent name: centos07-12 # 控制节点主机名 taints: null---apiServer: timeoutForControlPlane: 4m0sapiVersion: kubeadm.k8s.io/v1beta3certificatesDir: /etc/kubernetes/pkiclusterName: kubernetescontrollerManager: &#123;&#125;dns: &#123;&#125;etcd: local: dataDir: /var/lib/etcdimageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers # 指定阿里云镜像仓库地址kind: ClusterConfigurationkubernetesVersion: 1.28.1 # k8s版本 kubectl versionnetworking: dnsDomain: cluster.local podSubnet: 10.188.0.0/16 # 指定pod网段， 需要新增加这个 serviceSubnet: 10.88.0.0/12 # 指定Service网段 scheduler: &#123;&#125;#在文件最后，插入以下内容，（复制时，要带着---）---apiVersion: kubeproxy.config.k8s.io/v1alpha1kind: KubeProxyConfigurationmode: ipvs---apiVersion: kubelet.config.k8s.io/v1beta1kind: KubeletConfigurationcgroupDriver: systemd 1kubeadm init --config=kubeadm.yaml --ignore-preflight-errors=SystemVerification 显示如下，说明安装完成： 特别提醒：–image-repository registry.aliyuncs.com&#x2F;google_containers为保证拉取镜像不到国外站点拉取，手动指定仓库地址为registry.aliyuncs.com&#x2F;google_containers。kubeadm默认从k8s.gcr.io拉取镜像。 我们本地有导入到的离线镜像，所以会优先使用本地的镜像。 mode: ipvs 表示kube-proxy代理模式是ipvs，如果不指定ipvs，会默认使用iptables，但是iptables效率低，所以我们生产环境建议开启ipvs，阿里云和华为云托管的K8s，也提供ipvs模式，如下： 配置kubectl的配置文件config，相当于对kubectl进行授权，这样kubectl命令可以使用这个证书对k8s集群进行管理 12345mkdir -p $HOME/.kubesudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/configsudo chown $(id -u):$(id -g) $HOME/.kube/config 123[root@centos07-12 ~]# kubectl get nodesNAME STATUS ROLES AGE VERSIONcentos07-12 NotReady control-plane 14m v1.28.1 1.5、扩容k8s集群-添加第一个工作节点 - centos07-22在centos07-12上查看加入节点的命令： – centos07-12 123kubeadm token create --print-join-commandkubeadm join 192.168.1.12:6443 --token b0jkre.bnk4y6g4jf3rd6nc --discovery-token-ca-cert-hash sha256:6cb76134d477c7eb25d4927ae651b1b252dab75270cfb104462ffa2ed6b347b2 把xcentos07-22加入k8s集群： – centos07-22 1kubeadm join 192.168.1.12:6443 --token b0jkre.bnk4y6g4jf3rd6nc --discovery-token-ca-cert-hash sha256:6cb76134d477c7eb25d4927ae651b1b252dab75270cfb104462ffa2ed6b347b2 --ignore-preflight-errors=SystemVerification 1234567891011121314[root@centos07-22 ~]# kubeadm join 192.168.1.12:6443 --token b0jkre.bnk4y6g4jf3rd6nc --discovery-token-ca-cert-hash sha256:6cb76134d477c7eb25d4927ae651b1b252dab75270cfb104462ffa2ed6b347b2[preflight] Running pre-flight checks[preflight] Reading configuration from the cluster...[preflight] FYI: You can look at this config file with &#x27;kubectl -n kube-system get cm kubeadm-config -o yaml&#x27;[kubelet-start] Writing kubelet configuration to file &quot;/var/lib/kubelet/config.yaml&quot;[kubelet-start] Writing kubelet environment file with flags to file &quot;/var/lib/kubelet/kubeadm-flags.env&quot;[kubelet-start] Starting the kubelet[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...This node has joined the cluster:* Certificate signing request was sent to apiserver and a response was received.* The Kubelet was informed of the new secure connection details.Run &#x27;kubectl get nodes&#x27; on the control-plane to see this node join the cluster. 看到上面说明centos07-22节点已经加入到集群了,充当工作节点 在centos07-12上查看集群节点状况： 1234[root@centos07-12 ~]# kubectl get nodesNAME STATUS ROLES AGE VERSIONcentos07-12 NotReady control-plane 19m v1.28.1centos07-22 NotReady &lt;none&gt; 93s v1.28.1 可以对centos07-22打个标签，显示work 1kubectl label nodes centos07-22 node-role.kubernetes.io/work=work 123456[root@centos07-12 ~]# kubectl label nodes centos07-22 node-role.kubernetes.io/work=worknode/centos07-22 labeled[root@centos07-12 ~]# kubectl get nodesNAME STATUS ROLES AGE VERSIONcentos07-12 NotReady control-plane 20m v1.28.1centos07-22 NotReady work 2m29s v1.28.1 1.6、扩容k8s集群-添加第二个工作节点 - centos07-42在centos07-12上查看加入节点的命令： – centos07-12 12[root@centos07-12 ~]# kubeadm token create --print-join-commandkubeadm join 192.168.1.12:6443 --token qaz1z6.am3llfeybr3sfm85 --discovery-token-ca-cert-hash sha256:6cb76134d477c7eb25d4927ae651b1b252dab75270cfb104462ffa2ed6b347b2 把centos07-42加入k8s集群： – centos07-42 1234567891011121314[root@centos07-42 ~]# kubeadm join 192.168.1.12:6443 --token qaz1z6.am3llfeybr3sfm85 --discovery-token-ca-cert-hash sha256:6cb76134d477c7eb25d4927ae651b1b252dab75270cfb104462ffa2ed6b347b2[preflight] Running pre-flight checks[preflight] Reading configuration from the cluster...[preflight] FYI: You can look at this config file with &#x27;kubectl -n kube-system get cm kubeadm-config -o yaml&#x27;[kubelet-start] Writing kubelet configuration to file &quot;/var/lib/kubelet/config.yaml&quot;[kubelet-start] Writing kubelet environment file with flags to file &quot;/var/lib/kubelet/kubeadm-flags.env&quot;[kubelet-start] Starting the kubelet[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...This node has joined the cluster:* Certificate signing request was sent to apiserver and a response was received.* The Kubelet was informed of the new secure connection details.Run &#x27;kubectl get nodes&#x27; on the control-plane to see this node join the cluster. 看到上面说明centos07-42节点已经加入到集群了,充当工作节点 在centos07-12上查看集群节点状况： – centos07-12 12345[root@centos07-12 ~]# kubectl get nodesNAME STATUS ROLES AGE VERSIONcentos07-12 NotReady control-plane 24m v1.28.1centos07-22 NotReady work 6m22s v1.28.1centos07-42 NotReady &lt;none&gt; 80s v1.28.1 可以对centos07-42打个标签，显示work 1kubectl label nodes centos07-42 node-role.kubernetes.io/work=work 1234567[root@centos07-12 ~]# kubectl label nodes centos07-42 node-role.kubernetes.io/work=worknode/centos07-42 labeled[root@centos07-12 ~]# kubectl get nodesNAME STATUS ROLES AGE VERSIONcentos07-12 NotReady control-plane 35m v1.28.1centos07-22 NotReady work 17m v1.28.1centos07-42 NotReady work 12m v1.28.1 1.7、安装kubernetes网络组件-Calico – centos07-12&#x2F;22&#x2F;42把安装calico需要的镜像calico.tar.gz传到centos07-12&#x2F;22&#x2F;42节点，手动解压： 1ctr -n=k8s.io images import calico.tar.gz 上传calico.yaml到centos07-12上，使用yaml文件安装calico 网络插件: 修改calico配置： 加上下面这段配置： 1234vim calico.yaml - name: IP_AUTODETECTION_METHOD value: &quot;interface=enp0s3&quot; 123456789101112131415161718192021222324252627[root@centos07-12 ~]# kubectl apply -f calico.yamlconfigmap/calico-config createdcustomresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org createdcustomresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org createdcustomresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org createdcustomresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org createdcustomresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org createdcustomresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org createdcustomresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org createdcustomresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org createdcustomresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org createdcustomresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org createdcustomresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org createdcustomresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org createdcustomresourcedefinition.apiextensions.k8s.io/kubecontrollersconfigurations.crd.projectcalico.org createdcustomresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org createdcustomresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org createdclusterrole.rbac.authorization.k8s.io/calico-kube-controllers createdclusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers createdclusterrole.rbac.authorization.k8s.io/calico-node createdclusterrolebinding.rbac.authorization.k8s.io/calico-node createddaemonset.apps/calico-node createdserviceaccount/calico-node createddeployment.apps/calico-kube-controllers createdserviceaccount/calico-kube-controllers createdpoddisruptionbudget.policy/calico-kube-controllers created 12345[root@centos07-12 ~]# kubectl get nodesNAME STATUS ROLES AGE VERSIONcentos07-12 Ready control-plane 58m v1.28.1centos07-22 Ready work 40m v1.28.1centos07-42 Ready work 35m v1.28.1 注：在线下载配置文件地址是： https://docs.projectcalico.org/manifests/calico.yaml 1.8、测试在k8s创建pod是否可以正常访问网络把busybox-1-28.tar.gz上传到centos07-22&#x2F;42节点，手动解压 1ctr -n k8s.io images import busybox-1-28.tar.gz 123456789101112131415161718[root@centos07-12 ~]# kubectl run busybox --image docker.io/library/busybox:1.28 --image-pull-policy=IfNotPresent --restart=Never --rm -it busybox -- shIf you don&#x27;t see a command prompt, try pressing enter.# 通过下面可以看到能访问网络，说明calico网络插件已经被正常安装了/ # ping www.baidu.comPING www.baidu.com (39.156.66.14): 56 data bytes64 bytes from 39.156.66.14: seq=2 ttl=61 time=8.535 ms--- www.baidu.com ping statistics ---3 packets transmitted, 3 packets received, 0% packet lossround-trip min/avg/max = 7.047/7.557/8.535 ms/ # nslookup kubernetes.default.svc.cluster.localServer: 10.80.0.10Address 1: 10.80.0.10 kube-dns.kube-system.svc.cluster.localName: kubernetes.default.svc.cluster.localAddress 1: 10.80.0.1 kubernetes.default.svc.cluster.local exit #退出pod10.80.0.10 就是我们coreDNS的clusterIP，说明coreDNS配置好了。解析内部Service的名称，是通过coreDNS去解析的。 注意：busybox要用指定的1.28版本，不能用最新版本，最新版本，nslookup会解析不到dns和ip","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"31-Ingress实现业务灰度发布","slug":"运维/K8S/基础/31-Ingress实现业务灰度发布","date":"2023-05-15T12:00:00.000Z","updated":"2023-12-22T11:58:34.000Z","comments":true,"path":"2023/05/15/运维/K8S/基础/31-Ingress实现业务灰度发布/","link":"","permalink":"https://dbbruce.github.io/2023/05/15/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/31-Ingress%E5%AE%9E%E7%8E%B0%E4%B8%9A%E5%8A%A1%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83/","excerpt":"通过Ingress-nginx实现灰度发布场景一: 将新版本灰度给部分用户假设线上运行了一套对外提供 7 层服务的 Service A 服务，后来开发了个新版本 Service A’ 想要上线，但又不想直接替换掉原来的 Service A，希望先灰度一小部分用户，等运行一段时间足够稳定了再逐渐全量上线新版本，最后平滑下线旧版本。这个时候就可以利用 Nginx Ingress 基于 Header 或 Cookie 进行流量切分的策略来发布，业务使用 Header 或 Cookie 来标识不同类型的用户，我们通过配置 Ingress 来实现让带有指定 Header 或 Cookie 的请求被转发到新版本，其它的仍然转发到旧版本，从而实现将新版本灰度给部分用户:","text":"通过Ingress-nginx实现灰度发布场景一: 将新版本灰度给部分用户假设线上运行了一套对外提供 7 层服务的 Service A 服务，后来开发了个新版本 Service A’ 想要上线，但又不想直接替换掉原来的 Service A，希望先灰度一小部分用户，等运行一段时间足够稳定了再逐渐全量上线新版本，最后平滑下线旧版本。这个时候就可以利用 Nginx Ingress 基于 Header 或 Cookie 进行流量切分的策略来发布，业务使用 Header 或 Cookie 来标识不同类型的用户，我们通过配置 Ingress 来实现让带有指定 Header 或 Cookie 的请求被转发到新版本，其它的仍然转发到旧版本，从而实现将新版本灰度给部分用户: 场景二: 切一定比例的流量给新版本假设线上运行了一套对外提供 7 层服务的 Service B 服务，后来修复了一些问题，需要灰度上线一个新版本 Service B’，但又不想直接替换掉原来的 Service B，而是让先切 10% 的流量到新版本，等观察一段时间稳定后再逐渐加大新版本的流量比例直至完全替换旧版本，最后再滑下线旧版本，从而实现切一定比例的流量给新版本: Nginx Annotations支持以下几种Canary规则Ingress-Nginx是一个K8S ingress工具，支持配置Ingress Annotations来实现不同场景下的灰度发布和测试。Nginx Annotations支持以下几种Canary规则： 假设我们现在部署了两个版本的服务，老版本和canary版本 nginx.ingress.kubernetes.io&#x2F;canary-by-header：基于Request Header的流量切分，适用于灰度发布以及 A&#x2F;B 测试。当Request Header 设置为always时，请求将会被一直发送到 Canary 版本；当 Request Header 设置为never时，请求不会被发送到 Canary 入口。 nginx.ingress.kubernetes.io&#x2F;canary-by-header-value：要匹配的 Request Header 的值，用于通知 Ingress 将请求路由到 Canary Ingress 中指定的服务。当 Request Header 设置为此值时，它将被路由到 Canary 入口。 nginx.ingress.kubernetes.io&#x2F;canary-weight：基于服务权重的流量切分，适用于蓝绿部署，权重范围 0 - 100 按百分比将请求路由到 Canary Ingress 中指定的服务。权重为 0 意味着该金丝雀规则不会向 Canary 入口的服务发送任何请求。权重为60意味着60%流量转到canary。权重为 100 意味着所有请求都将被发送到 Canary 入口。 nginx.ingress.kubernetes.io&#x2F;canary-by-cookie：基于 Cookie 的流量切分，适用于灰度发布与 A&#x2F;B 测试。用于通知 Ingress 将请求路由到 Canary Ingress 中指定的服务的cookie。当 cookie 值设置为always时，它将被路由到 Canary 入口；当 cookie 值设置为never时，请求不会被发送到 Canary 入口。 部署两个版本的服务 1、这里以简单的 nginx 为例，先部署一个 v1 版本:特别注意：因为我们之前安装的k8s版本是1.25，那就需要按照文档步骤ctr -n&#x3D;k8s.io images import导出镜像，如果k8s版本是1.24之前的，可以用docker load -i解压，视频里用的docker load -i，现在我们课程安装更新到了k8s1.25，所以导出镜像需要用ctr -n&#x3D;k8s.io images import 解压镜像，导入镜像 - centos07-22&#x2F;6212[root@centos07-22 ~]# ctr -n=k8s.io images import openresty.tar.gz[root@centos07-62 ~]# ctr -n=k8s.io images import openresty.tar.gz 创建deployment1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677# vim v1.yamlapiVersion: apps/v1kind: Deploymentmetadata: name: nginx-v1spec: replicas: 1 selector: matchLabels: app: nginx version: v1 template: metadata: labels: app: nginx version: v1 spec: containers: - name: nginx image: &quot;openresty/openresty:centos&quot; imagePullPolicy: IfNotPresent ports: - name: http protocol: TCP containerPort: 80 volumeMounts: - mountPath: /usr/local/openresty/nginx/conf/nginx.conf name: config subPath: nginx.conf volumes: - name: config configMap: name: nginx-v1---apiVersion: v1kind: ConfigMapmetadata: labels: app: nginx version: v1 name: nginx-v1data: nginx.conf: |- worker_processes 1; events &#123; accept_mutex on; multi_accept on; use epoll; worker_connections 1024; &#125; http &#123; ignore_invalid_headers off; server &#123; listen 80; location / &#123; access_by_lua &#x27; local header_str = ngx.say(&quot;nginx-v1&quot;) &#x27;; &#125; &#125; &#125;---apiVersion: v1kind: Servicemetadata: name: nginx-v1spec: type: ClusterIP ports: - port: 80 protocol: TCP name: http selector: app: nginx version: v1 1234[root@centos07-12 v1v2]# kubectl apply -f v1.yamldeployment.apps/nginx-v1 createdconfigmap/nginx-v1 createdservice/nginx-v1 created 2、再部署一个 v2 版本:123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778# vim v2.yamlapiVersion: apps/v1kind: Deploymentmetadata: name: nginx-v2spec: replicas: 1 selector: matchLabels: app: nginx version: v2 template: metadata: labels: app: nginx version: v2 spec: containers: - name: nginx image: &quot;openresty/openresty:centos&quot; imagePullPolicy: IfNotPresent ports: - name: http protocol: TCP containerPort: 80 volumeMounts: - mountPath: /usr/local/openresty/nginx/conf/nginx.conf name: config subPath: nginx.conf volumes: - name: config configMap: name: nginx-v2---apiVersion: v1kind: ConfigMapmetadata: labels: app: nginx version: v2 name: nginx-v2data: nginx.conf: |- worker_processes 1; events &#123; accept_mutex on; multi_accept on; use epoll; worker_connections 1024; &#125; http &#123; ignore_invalid_headers off; server &#123; listen 80; location / &#123; access_by_lua &#x27; local header_str = ngx.say(&quot;nginx-v2&quot;) &#x27;; &#125; &#125; &#125;---apiVersion: v1kind: Servicemetadata: name: nginx-v2spec: type: ClusterIP ports: - port: 80 protocol: TCP name: http selector: app: nginx version: v2 1234[root@centos07-12 v1v2]# kubectl apply -f v2.yamldeployment.apps/nginx-v2 createdconfigmap/nginx-v2 createdservice/nginx-v2 created 3、再创建一个 Ingress，对外暴露服务，指向 v1 版本的服务12345678910111213141516171819# vim v1-ingress.yamlapiVersion: networking.k8s.io/v1kind: Ingressmetadata: name: nginxspec: ingressClassName: nginx rules: - host: canary.example.com http: paths: - path: / #配置访问路径，如果通过url进行转发，需要修改；空默认为访问的路径为&quot;/&quot; pathType: Prefix backend: #配置后端服务 service: name: nginx-v1 port: number: 80 k8s版本1.25 ingressClassName，会有警告提示， class为none 1234567[root@centos07-12 v1v2]# kubectl apply -f v1-ingress.yamlWarning: annotation &quot;kubernetes.io/ingress.class&quot; is deprecated, please use &#x27;spec.ingressClassName&#x27; insteadingress.networking.k8s.io/nginx created[root@centos07-12 v1v2]# kubectl get ingressNAME CLASS HOSTS ADDRESS PORTS AGEnginx-canary &lt;none&gt; canary.example.com 192.168.1.22,192.168.1.62 80 37s 添加ingressClassName就不会有告警了 12spec: ingressClassName: nginx 12[root@centos07-12 v1v2]# kubectl apply -f v1-ingress.yamlingress.networking.k8s.io/nginx created 123[root@centos07-12 v1v2]# kubectl get ingressNAME CLASS HOSTS ADDRESS PORTS AGEnginx nginx canary.example.com 192.168.1.22,192.168.1.62 80 8m18s 4、访问验证一下:$ curl -H “Host: canary.example.com” http://EXTERNAL-IP # EXTERNAL-IP 替换为 Nginx Ingress 自身对外暴露的 IP， 1.22或者1.62都可以12345[root@centos07-12 v1v2]# curl -H &quot;Host: canary.example.com&quot; http://192.168.1.22nginx-v1[root@centos07-12 v1v2]# curl -H &quot;Host: canary.example.com&quot; http://192.168.1.62nginx-v1 5、基于 Header 的流量切分：创建 Canary Ingress，指定 v2 版本的后端服务，且加上一些 annotation，实现仅将带有名为 Region 且值为 cd 或 sz 的请求头的请求转发给当前 Canary Ingress，模拟灰度新版本给成都和深圳地域的用户:12345678910111213141516171819202122232425# vim v2-ingress.yamlapiVersion: networking.k8s.io/v1kind: Ingressmetadata: annotations: kubernetes.io/ingress.class: nginx nginx.ingress.kubernetes.io/canary: &quot;true&quot; nginx.ingress.kubernetes.io/canary-by-header: &quot;Region&quot; # hander key：Region nginx.ingress.kubernetes.io/canary-by-header-pattern: &quot;cd|sz&quot; # header 值cd 或者 sz name: nginx-canaryspec: ingressClassName: nginx rules: - host: canary.example.com http: paths: - path: / #配置访问路径，如果通过url进行转发，需要修改；空默认为访问的路径为&quot;/&quot; pathType: Prefix backend: #配置后端服务 service: name: nginx-v2 port: number: 80 12[root@centos07-12 v1v2]# kubectl apply -f v2-ingress.yamlingress.networking.k8s.io/nginx-canary created 12345[root@centos07-12 v1v2]# kubectl get ingressNAME CLASS HOSTS ADDRESS PORTS AGEingress-tomcat-tls nginx dong.dbbruce.com 192.168.1.22,192.168.1.62 80, 443 7h59mnginx nginx canary.example.com 192.168.1.22,192.168.1.62 80 21mnginx-canary nginx canary.example.com 192.168.1.22,192.168.1.62 80 17s 不写ingressClassName，会有一个警告提醒, class 也会为none123[root@centos07-12 v1v2]# kubectl get ingressNAME CLASS HOSTS ADDRESS PORTS AGEnginx-canary &lt;none&gt; canary.example.com 192.168.1.22,192.168.1.62 80 37s 6、测试访问:$ curl -H “Host: canary.example.com” -H “Region: cd” http://EXTERNAL-IP # EXTERNAL-IP 替换为 Nginx Ingress 自身对外暴露的 IP可以看到，只有 header Region 为 cd 或 sz 的请求才由 v2 版本服务响应。12345[root@centos07-12 v1v2]# curl -H &quot;Host: canary.example.com&quot; -H &quot;Region: cd&quot; http://192.168.1.22nginx-v2[root@centos07-12 v1v2]# curl -H &quot;Host: canary.example.com&quot; -H &quot;Region: sz&quot; http://192.168.1.22nginx-v2 其他v1响应$ curl -H “Host: canary.example.com” -H “Region: bj” http://EXTERNAL-IP123456789[root@centos07-12 v1v2]# curl -H &quot;Host: canary.example.com&quot; -H &quot;Region: bj&quot; http://192.168.1.22nginx-v1[root@centos07-12 v1v2]# curl -H &quot;Host: canary.example.com&quot; http://192.168.1.22nginx-v1[root@centos07-12 v1v2]# curl -H &quot;Host: canary.example.com&quot; -H &quot;Region: dong&quot; http://192.168.1.22nginx-v1[root@cen 7、基于 Cookie 的流量切分：与前面 Header 类似，不过使用 Cookie 就无法自定义 value 了，这里以模拟灰度成都地域用户为例，仅将带有名为 user_from_cd 的 cookie 的请求转发给当前 Canary Ingress 。先删除前面基于 Header 的流量切分的 Canary Ingress，然后创建下面新的 Canary Ingress:12[root@centos07-12 v1v2]# kubectl delete -f v2-ingress.yamlingress.networking.k8s.io &quot;nginx-canary&quot; deleted 1234567891011121314151617181920212223# vim v1-cookie.yamlapiVersion: networking.k8s.io/v1kind: Ingressmetadata: annotations: kubernetes.io/ingress.class: nginx nginx.ingress.kubernetes.io/canary: &quot;true&quot; nginx.ingress.kubernetes.io/canary-by-cookie: &quot;user_from_cd&quot; name: nginx-canaryspec: rules: - host: canary.example.com http: paths: - path: / #配置访问路径，如果通过url进行转发，需要修改；空默认为访问的路径为&quot;/&quot; pathType: Prefix backend: #配置后端服务 service: name: nginx-v2 port: number: 80 123[root@centos07-12 v1v2]# kubectl apply -f v1-cookie.yamlWarning: annotation &quot;kubernetes.io/ingress.class&quot; is deprecated, please use &#x27;spec.ingressClassName&#x27; insteadingress.networking.k8s.io/nginx-canary created 123[root@centos07-12 v1v2]# kubectl get ingressNAME CLASS HOSTS ADDRESS PORTS AGEnginx-canary &lt;none&gt; canary.example.com 192.168.1.22,192.168.1.62 80 25s 8、测试访问:$ curl -s -H “Host: canary.example.com” –cookie “user_from_cd&#x3D;always” http://EXTERNAL-IP # EXTERNAL-IP 替换为 Nginx Ingress 自身对外暴露的 IP12[root@centos07-12 v1v2]# curl -s -H &quot;Host: canary.example.com&quot; --cookie &quot;user_from_cd=always&quot; http://192.168.1.22nginx-v2 12345[root@centos07-12 v1v2]# curl -s -H &quot;Host: canary.example.com&quot; --cookie &quot;user_from_cd=dafadf&quot; http://192.168.1.22nginx-v1[root@centos07-12 v1v2]# curl -s -H &quot;Host: canary.example.com&quot; --cookie &quot;user_from_bj=always&quot; http://192.168.1.22nginx-v1 可以看到，只有 cookie user_from_cd 为 always 的请求才由 v2 版本的服务响应 9、基于服务权重的流量切分基于服务权重的 Canary Ingress 就简单了，直接定义需要导入的流量比例，这里以导入 10% 流量到 v2 版本为例 (如果有，先删除之前的 Canary Ingress):12[root@centos07-12 v1v2]# kubectl delete -f v1-cookie.yamlingress.networking.k8s.io &quot;nginx-canary&quot; deleted 12345678910111213141516171819202122# vim v1-weight.yamlapiVersion: networking.k8s.io/v1kind: Ingressmetadata: annotations: kubernetes.io/ingress.class: nginx nginx.ingress.kubernetes.io/canary: &quot;true&quot; nginx.ingress.kubernetes.io/canary-weight: &quot;10&quot; name: nginx-canaryspec: rules: - host: canary.example.com http: paths: - path: / #配置访问路径，如果通过url进行转发，需要修改；空默认为访问的路径为&quot;/&quot; pathType: Prefix backend: #配置后端服务 service: name: nginx-v2 port: number: 80 123[root@centos07-12 v1v2]# kubectl apply -f v1-weight.yamlWarning: annotation &quot;kubernetes.io/ingress.class&quot; is deprecated, please use &#x27;spec.ingressClassName&#x27; insteadingress.networking.k8s.io/nginx-canary created 123[root@centos07-12 v1v2]# kubectl get ingressNAME CLASS HOSTS ADDRESS PORTS AGEnginx-canary &lt;none&gt; canary.example.com 80 25s 10、测试访问:$ for i in {1..10}; do curl -H “Host: canary.example.com” http://EXTERNAL-IP; done;1234567891011[root@centos07-12 v1v2]# for i in &#123;1..10&#125;; do curl -H &quot;Host: canary.example.com&quot; http://192.168.1.22; done;nginx-v1nginx-v2nginx-v1nginx-v2nginx-v2nginx-v1nginx-v1nginx-v1nginx-v2nginx-v1 可以看到，大概只有十分之一的几率由 v2 版本的服务响应，符合 10% 服务权重的设置","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"30-Ingress-Controller高可用方案及多租户场景","slug":"运维/K8S/基础/30-Ingress-Controller高可用方案及多租户场景","date":"2023-05-15T02:00:00.000Z","updated":"2023-12-22T10:21:48.000Z","comments":true,"path":"2023/05/15/运维/K8S/基础/30-Ingress-Controller高可用方案及多租户场景/","link":"","permalink":"https://dbbruce.github.io/2023/05/15/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/30-Ingress-Controller%E9%AB%98%E5%8F%AF%E7%94%A8%E6%96%B9%E6%A1%88%E5%8F%8A%E5%A4%9A%E7%A7%9F%E6%88%B7%E5%9C%BA%E6%99%AF/","excerpt":"Ingress和 Ingress Controller概述1. 回顾下service四层负载","text":"Ingress和 Ingress Controller概述1. 回顾下service四层负载 在k8s中为什么要做负载均衡？ Pod 漂移问题，可以理解成Pod IP是变化的Kubernetes具有强大的副本控制能力，能保证在任意副本（Pod）挂掉时自动从其他机器启动一个新的，还可以动态扩容等。通俗地说，这个Pod可能在任何时刻出现在任何节点上，也可能在任何时刻死在任何节点上；那么自然随着Pod的创建和销毁，Pod IP 肯定会动态变化；那么如何把这个动态的Pod IP暴露出去？这里借助于Kubernetes的 Service 机制，Service可以以标签的形式选定一组带有指定标签的Pod，并监控和自动负载他们的Pod IP，那么我们向外暴露只暴露Service IP就行了；这就是NodePort模式：即在每个节点上开起一个端口，然后转发到内部Pod IP 上。 Service可以通过标签选择器找到它所关联的Pod。但是属于四层代理，只能基于IP和端口代理。 Service存在一个问题，什么问题呢？Service的type类型有很多，如NodePort、clusterIp、loadbalancer、externalname，如果Service想要被k8s集群外部访问，需要用NodePort类型，但是NodePort类型的svc有如下几个问题：nodeport会在物理机映射一个端口，绑定到物理机上，这样就导致，每个服务都要映射一个端口，端口过多，维护困难，还有就是Service底层使用的是iptables或者ipvs，仅支持四层代理，无法基于https协议做代理，因此我们这节课讲解的是ingress-nginx-controller七层代理。 四层负载和七层负载的区别： 1）四层负载：四层的负载均衡就是基于IP+端口的负载均衡：在三层负载均衡的基础上，通过发布三层的IP地址（VIP），然后加四层的端口号，来决定哪些流量需要做负载均衡，对需要处理的流量进行NAT处理，转发至后台服务器，并记录下这个TCP或者UDP的流量是由哪台服务器处理的，后续这个连接的所有流量都同样转发到同一台服务器处理。 2）七层的负载均衡就是基于虚拟的URL或主机IP的负载均衡：在四层负载均衡的基础上（没有四层是绝对不可能有七层的），再考虑应用层的特征，比如同一个Web服务器的负载均衡，除了根据VIP加80端口辨别是否需要处理的流量，还可根据七层的URL、浏览器类别、语言来决定是否要进行负载均衡。举个例子，如果你的Web服务器分成两组，一组是中文语言的，一组是英文语言的，那么七层负载均衡就可以当用户来访问你的域名时，自动辨别用户语言，然后选择对应的语言服务器组进行负载均衡处理。 3）四层负载均衡工作在传输层，七层负载均衡工作在应用层 OSI七层模型： 2. Ingress介绍Ingress官网定义：Ingress可以把进入到集群内部的请求转发到集群中的一些服务上，从而可以把服务映射到集群外部。Ingress 能把集群内Service 配置成外网能够访问的 URL，流量负载均衡，提供基于域名访问的虚拟主机等。Ingress简单的理解就是你原来需要改Nginx配置，然后配置各种域名对应哪个 Service，现在把这个动作抽象出来，变成一个 Ingress 对象，你可以用 yaml 创建，每次不要去改Nginx 了，直接改yaml然后创建&#x2F;更新就行了；那么问题来了：”Nginx 该怎么处理？” Ingress总结：ingress是k8s中的资源，主要是管理ingress-controller这个代理的配置文件 Ingress Controller 这东西就是解决 “Nginx 的处理方式” 的；Ingress Controller 通过与 Kubernetes API 交互，动态的去感知集群中Ingress规则变化，然后读取他，按照他自己模板生成一段 Nginx 配置，再写到 Nginx Pod 里，最后 reload 一下 3. Ingress Controller介绍Ingress Controller是一个七层负载均衡调度器，客户端的请求先到达这个七层负载均衡调度器，由七层负载均衡器在反向代理到后端pod，常见的七层负载均衡器有nginx、traefik，以我们熟悉的nginx为例，假如请求到达nginx，会通过upstream反向代理到后端pod应用，但是后端pod的ip地址是一直在变化的，因此在后端pod前需要加一个service，这个service只是起到分组的作用，那么我们upstream只需要填写service地址即可。 Ingress-controller里面封装就是nginx，有的同学问？ 我直接在物理机上装个nginx就行了啊，为啥还弄个Ingress-controller？ Nginx：nginx配置文件一改动，你还需要手动reload一下才可以生效，但是如果用ingress-controller封装的nginx，你ingress维护配置，ingress创建好之后，会自动的把配置文件传到ingress-controller这个pod里，会自动进行reload，然后配置就生效了。 4. Ingress和Ingress Controller总结Ingress ControllerIngress Controller结合Ingress 定义的规则生成配置，然后动态更新ingress-controller里的Nginx 或者trafik负载均衡器，并刷新使配置生效，来达到服务自动发现的作用。Ingress 则是定义规则，通过它定义某个域名的请求过来之后转发到集群中指定的 Service。它可以通过 Yaml 文件定义，可以给一个或多个 Service 定义一个或多个 Ingress 规则。 5. 使用Ingress Controller代理k8s内部pod的流程 （1）部署Ingress controller，我们ingress controller使用的是nginx （2）创建Pod应用，可以通过控制器创建pod （3）创建Service，用来分组pod （4）创建Ingress http，测试通过http访问应用 （5）创建Ingress https，测试通过https访问应用 客户端通过七层调度器访问后端pod的方式 使用七层负载均衡调度器ingress controller时，当客户端访问kubernetes集群内部的应用时，数据包走向如下图流程所示： 6. Ingress-controller高可用Ingress Controller是集群流量的接入层，对它做高可用非常重要，可以基于keepalive实现nginx-ingress-controller高可用，具体实现如下：Ingress-controller根据Deployment + nodeSelector + pod反亲和性 方式部署在k8s指定的两个work节点，nginx-ingress-controller这个pod共享宿主机ip，然后通过keepalive+nginx实现nginx-ingress-controller高可用 ingress-nginx 参考：https://github.com/kubernetes/ingress-nginx ingress-deploy官网地址：https://github.com/kubernetes/ingress-nginx/tree/main/deploy/static/provider/baremetal 特别注意：因为我们现在安装的k8s版本是1.25，那就需要按照文档步骤ctr -n&#x3D;k8s.io images import导出镜像，如果k8s版本是1.24之前的，可以用docker load -i解压，视频里用的docker load -i，现在我们课程安装更新到了k8s1.25，所以导出镜像需要用ctr -n&#x3D;k8s.io images import 导入镜像 centos07-22&#x2F;62，k8s版本1.24前：docker load -i 镜像.gz， 版本1.25后：crictl -n&#x3D;k8s.io images import 镜像.gz 1234[root@centos07-22 ~]# ctr -n=k8s.io images import ingress-nginx-controllerv1.1.0.tar.gzunpacking registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller:v1.1.0 (sha256:27acdc134e169d6821f9a5b8cd752da29d4f17d099352a7cc53b35158d5fa49e)...done[root@centos07-22 ~]# ctr -n=k8s.io images import kube-webhook-certgen-v1.1.0.tar.gzunpacking registry.cn-hangzhou.aliyuncs.com/google_containers/kube-webhook-certgen:v1.1.1 (sha256:8018351af36a10f9859fbb103138f66d364d78d97cb9592fd26de0107563d0af)...done 这个是修改后的ingress-deploy，和官网有区别 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587588589590591592593594595596597598599600601602603604605606607608609610611612613614615616617618619620621622623624625626627628629630631632633634635636637638639640641642643644645646647648649650651652653654655656657658659660661662663664665666667668669670671672673674675676677678679680681682683684685686687688689690691692693694695# ingress-deploy.yamlapiVersion: v1kind: Namespacemetadata: name: ingress-nginx labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx---# Source: ingress-nginx/templates/controller-serviceaccount.yamlapiVersion: v1kind: ServiceAccountmetadata: labels: helm.sh/chart: ingress-nginx-4.0.10 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.1.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: ingress-nginx namespace: ingress-nginxautomountServiceAccountToken: true---# Source: ingress-nginx/templates/controller-configmap.yamlapiVersion: v1kind: ConfigMapmetadata: labels: helm.sh/chart: ingress-nginx-4.0.10 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.1.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: ingress-nginx-controller namespace: ingress-nginxdata: allow-snippet-annotations: &#x27;true&#x27;---# Source: ingress-nginx/templates/clusterrole.yamlapiVersion: rbac.authorization.k8s.io/v1kind: ClusterRolemetadata: labels: helm.sh/chart: ingress-nginx-4.0.10 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.1.0 app.kubernetes.io/managed-by: Helm name: ingress-nginxrules: - apiGroups: - &#x27;&#x27; resources: - configmaps - endpoints - nodes - pods - secrets - namespaces verbs: - list - watch - apiGroups: - &#x27;&#x27; resources: - nodes verbs: - get - apiGroups: - &#x27;&#x27; resources: - services verbs: - get - list - watch - apiGroups: - networking.k8s.io resources: - ingresses verbs: - get - list - watch - apiGroups: - &#x27;&#x27; resources: - events verbs: - create - patch - apiGroups: - networking.k8s.io resources: - ingresses/status verbs: - update - apiGroups: - networking.k8s.io resources: - ingressclasses verbs: - get - list - watch---# Source: ingress-nginx/templates/clusterrolebinding.yamlapiVersion: rbac.authorization.k8s.io/v1kind: ClusterRoleBindingmetadata: labels: helm.sh/chart: ingress-nginx-4.0.10 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.1.0 app.kubernetes.io/managed-by: Helm name: ingress-nginxroleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: ingress-nginxsubjects: - kind: ServiceAccount name: ingress-nginx namespace: ingress-nginx---# Source: ingress-nginx/templates/controller-role.yamlapiVersion: rbac.authorization.k8s.io/v1kind: Rolemetadata: labels: helm.sh/chart: ingress-nginx-4.0.10 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.1.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: ingress-nginx namespace: ingress-nginxrules: - apiGroups: - &#x27;&#x27; resources: - namespaces verbs: - get - apiGroups: - &#x27;&#x27; resources: - configmaps - pods - secrets - endpoints verbs: - get - list - watch - apiGroups: - &#x27;&#x27; resources: - services verbs: - get - list - watch - apiGroups: - networking.k8s.io resources: - ingresses verbs: - get - list - watch - apiGroups: - networking.k8s.io resources: - ingresses/status verbs: - update - apiGroups: - networking.k8s.io resources: - ingressclasses verbs: - get - list - watch - apiGroups: - &#x27;&#x27; resources: - configmaps resourceNames: - ingress-controller-leader verbs: - get - update - apiGroups: - &#x27;&#x27; resources: - configmaps verbs: - create - apiGroups: - &#x27;&#x27; resources: - events verbs: - create - patch---# Source: ingress-nginx/templates/controller-rolebinding.yamlapiVersion: rbac.authorization.k8s.io/v1kind: RoleBindingmetadata: labels: helm.sh/chart: ingress-nginx-4.0.10 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.1.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: ingress-nginx namespace: ingress-nginxroleRef: apiGroup: rbac.authorization.k8s.io kind: Role name: ingress-nginxsubjects: - kind: ServiceAccount name: ingress-nginx namespace: ingress-nginx---# Source: ingress-nginx/templates/controller-service-webhook.yamlapiVersion: v1kind: Servicemetadata: labels: helm.sh/chart: ingress-nginx-4.0.10 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.1.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: ingress-nginx-controller-admission namespace: ingress-nginxspec: type: ClusterIP ports: - name: https-webhook port: 443 targetPort: webhook appProtocol: https selector: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/component: controller---# Source: ingress-nginx/templates/controller-service.yamlapiVersion: v1kind: Servicemetadata: annotations: labels: helm.sh/chart: ingress-nginx-4.0.10 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.1.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: ingress-nginx-controller namespace: ingress-nginxspec: type: NodePort ipFamilyPolicy: SingleStack ipFamilies: - IPv4 ports: - name: http port: 80 protocol: TCP targetPort: http appProtocol: http - name: https port: 443 protocol: TCP targetPort: https appProtocol: https selector: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/component: controller---# Source: ingress-nginx/templates/controller-deployment.yamlapiVersion: apps/v1kind: Deploymentmetadata: labels: helm.sh/chart: ingress-nginx-4.0.10 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.1.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: ingress-nginx-controller namespace: ingress-nginxspec: replicas: 2 selector: matchLabels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/component: controller revisionHistoryLimit: 10 minReadySeconds: 0 template: metadata: labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/component: controller spec: hostNetwork: true affinity: podAntiAffinity: preferredDuringSchedulingIgnoredDuringExecution: - weight: 100 podAffinityTerm: labelSelector: matchLabels: app.kubernetes.io/name: ingress-nginx topologyKey: kubernetes.io/hostname dnsPolicy: ClusterFirstWithHostNet containers: - name: controller image: registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller:v1.1.0 imagePullPolicy: IfNotPresent lifecycle: preStop: exec: command: - /wait-shutdown args: - /nginx-ingress-controller - --election-id=ingress-controller-leader - --controller-class=k8s.io/ingress-nginx - --configmap=$(POD_NAMESPACE)/ingress-nginx-controller - --validating-webhook=:8443 - --validating-webhook-certificate=/usr/local/certificates/cert - --validating-webhook-key=/usr/local/certificates/key securityContext: capabilities: drop: - ALL add: - NET_BIND_SERVICE runAsUser: 101 allowPrivilegeEscalation: true env: - name: POD_NAME valueFrom: fieldRef: fieldPath: metadata.name - name: POD_NAMESPACE valueFrom: fieldRef: fieldPath: metadata.namespace - name: LD_PRELOAD value: /usr/local/lib/libmimalloc.so livenessProbe: failureThreshold: 5 httpGet: path: /healthz port: 10254 scheme: HTTP initialDelaySeconds: 10 periodSeconds: 10 successThreshold: 1 timeoutSeconds: 1 readinessProbe: failureThreshold: 3 httpGet: path: /healthz port: 10254 scheme: HTTP initialDelaySeconds: 10 periodSeconds: 10 successThreshold: 1 timeoutSeconds: 1 ports: - name: http containerPort: 80 protocol: TCP - name: https containerPort: 443 protocol: TCP - name: webhook containerPort: 8443 protocol: TCP volumeMounts: - name: webhook-cert mountPath: /usr/local/certificates/ readOnly: true resources: requests: cpu: 100m memory: 90Mi nodeSelector: kubernetes.io/os: linux serviceAccountName: ingress-nginx terminationGracePeriodSeconds: 300 volumes: - name: webhook-cert secret: secretName: ingress-nginx-admission---# Source: ingress-nginx/templates/controller-ingressclass.yaml# We don&#x27;t support namespaced ingressClass yet# So a ClusterRole and a ClusterRoleBinding is requiredapiVersion: networking.k8s.io/v1kind: IngressClassmetadata: labels: helm.sh/chart: ingress-nginx-4.0.10 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.1.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: nginx namespace: ingress-nginxspec: controller: k8s.io/ingress-nginx---# Source: ingress-nginx/templates/admission-webhooks/validating-webhook.yaml# before changing this value, check the required kubernetes version# https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#prerequisitesapiVersion: admissionregistration.k8s.io/v1kind: ValidatingWebhookConfigurationmetadata: labels: helm.sh/chart: ingress-nginx-4.0.10 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.1.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook name: ingress-nginx-admissionwebhooks: - name: validate.nginx.ingress.kubernetes.io matchPolicy: Equivalent rules: - apiGroups: - networking.k8s.io apiVersions: - v1 operations: - CREATE - UPDATE resources: - ingresses failurePolicy: Fail sideEffects: None admissionReviewVersions: - v1 clientConfig: service: namespace: ingress-nginx name: ingress-nginx-controller-admission path: /networking/v1/ingresses---# Source: ingress-nginx/templates/admission-webhooks/job-patch/serviceaccount.yamlapiVersion: v1kind: ServiceAccountmetadata: name: ingress-nginx-admission namespace: ingress-nginx annotations: helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded labels: helm.sh/chart: ingress-nginx-4.0.10 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.1.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook---# Source: ingress-nginx/templates/admission-webhooks/job-patch/clusterrole.yamlapiVersion: rbac.authorization.k8s.io/v1kind: ClusterRolemetadata: name: ingress-nginx-admission annotations: helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded labels: helm.sh/chart: ingress-nginx-4.0.10 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.1.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhookrules: - apiGroups: - admissionregistration.k8s.io resources: - validatingwebhookconfigurations verbs: - get - update---# Source: ingress-nginx/templates/admission-webhooks/job-patch/clusterrolebinding.yamlapiVersion: rbac.authorization.k8s.io/v1kind: ClusterRoleBindingmetadata: name: ingress-nginx-admission annotations: helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded labels: helm.sh/chart: ingress-nginx-4.0.10 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.1.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhookroleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: ingress-nginx-admissionsubjects: - kind: ServiceAccount name: ingress-nginx-admission namespace: ingress-nginx---# Source: ingress-nginx/templates/admission-webhooks/job-patch/role.yamlapiVersion: rbac.authorization.k8s.io/v1kind: Rolemetadata: name: ingress-nginx-admission namespace: ingress-nginx annotations: helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded labels: helm.sh/chart: ingress-nginx-4.0.10 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.1.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhookrules: - apiGroups: - &#x27;&#x27; resources: - secrets verbs: - get - create---# Source: ingress-nginx/templates/admission-webhooks/job-patch/rolebinding.yamlapiVersion: rbac.authorization.k8s.io/v1kind: RoleBindingmetadata: name: ingress-nginx-admission namespace: ingress-nginx annotations: helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded labels: helm.sh/chart: ingress-nginx-4.0.10 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.1.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhookroleRef: apiGroup: rbac.authorization.k8s.io kind: Role name: ingress-nginx-admissionsubjects: - kind: ServiceAccount name: ingress-nginx-admission namespace: ingress-nginx---# Source: ingress-nginx/templates/admission-webhooks/job-patch/job-createSecret.yamlapiVersion: batch/v1kind: Jobmetadata: name: ingress-nginx-admission-create namespace: ingress-nginx annotations: helm.sh/hook: pre-install,pre-upgrade helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded labels: helm.sh/chart: ingress-nginx-4.0.10 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.1.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhookspec: template: metadata: name: ingress-nginx-admission-create labels: helm.sh/chart: ingress-nginx-4.0.10 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.1.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook spec: containers: - name: create image: registry.cn-hangzhou.aliyuncs.com/google_containers/kube-webhook-certgen:v1.1.1 imagePullPolicy: IfNotPresent args: - create - --host=ingress-nginx-controller-admission,ingress-nginx-controller-admission.$(POD_NAMESPACE).svc - --namespace=$(POD_NAMESPACE) - --secret-name=ingress-nginx-admission env: - name: POD_NAMESPACE valueFrom: fieldRef: fieldPath: metadata.namespace securityContext: allowPrivilegeEscalation: false restartPolicy: OnFailure serviceAccountName: ingress-nginx-admission nodeSelector: kubernetes.io/os: linux securityContext: runAsNonRoot: true runAsUser: 2000---# Source: ingress-nginx/templates/admission-webhooks/job-patch/job-patchWebhook.yamlapiVersion: batch/v1kind: Jobmetadata: name: ingress-nginx-admission-patch namespace: ingress-nginx annotations: helm.sh/hook: post-install,post-upgrade helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded labels: helm.sh/chart: ingress-nginx-4.0.10 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.1.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhookspec: template: metadata: name: ingress-nginx-admission-patch labels: helm.sh/chart: ingress-nginx-4.0.10 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.1.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook spec: containers: - name: patch image: registry.cn-hangzhou.aliyuncs.com/google_containers/kube-webhook-certgen:v1.1.1 imagePullPolicy: IfNotPresent args: - patch - --webhook-name=ingress-nginx-admission - --namespace=$(POD_NAMESPACE) - --patch-mutating=false - --secret-name=ingress-nginx-admission - --patch-failure-policy=Fail env: - name: POD_NAMESPACE valueFrom: fieldRef: fieldPath: metadata.namespace securityContext: allowPrivilegeEscalation: false restartPolicy: OnFailure serviceAccountName: ingress-nginx-admission nodeSelector: kubernetes.io/os: linux securityContext: runAsNonRoot: true runAsUser: 2000 应用 ingress-deploy.yaml 1234567891011121314151617181920[root@centos07-12 ingresstest]# kubectl apply -f ingress-deploy.yamlnamespace/ingress-nginx createdserviceaccount/ingress-nginx createdconfigmap/ingress-nginx-controller createdclusterrole.rbac.authorization.k8s.io/ingress-nginx createdclusterrolebinding.rbac.authorization.k8s.io/ingress-nginx createdrole.rbac.authorization.k8s.io/ingress-nginx createdrolebinding.rbac.authorization.k8s.io/ingress-nginx createdservice/ingress-nginx-controller-admission createdservice/ingress-nginx-controller createddeployment.apps/ingress-nginx-controller createdingressclass.networking.k8s.io/nginx createdvalidatingwebhookconfiguration.admissionregistration.k8s.io/ingress-nginx-admission createdserviceaccount/ingress-nginx-admission createdclusterrole.rbac.authorization.k8s.io/ingress-nginx-admission createdclusterrolebinding.rbac.authorization.k8s.io/ingress-nginx-admission createdrole.rbac.authorization.k8s.io/ingress-nginx-admission createdrolebinding.rbac.authorization.k8s.io/ingress-nginx-admission createdjob.batch/ingress-nginx-admission-create createdjob.batch/ingress-nginx-admission-patch created 更新yaml文件： 1234567891011121314151617181920# vim ingress-myapp.yamlapiVersion: networking.k8s.io/v1kind: Ingressmetadata: name: ingress-myapp namespace: defaultspec: ingressClassName: nginx rules: - host: tomcat.dbbruce.com http: paths: - backend: service: name: tomcat port: number: 8080 path: / pathType: Prefix 12root@centos07-12 ingresstest]# kubectl apply -f ingress-myapp.yamlingress.networking.k8s.io/ingress-myapp created 123[root@centos07-12 ingresstest]# kubectl get ingressNAME CLASS HOSTS ADDRESS PORTS AGEingress-myapp nginx tomcat.dbbruce.com 80 12s 123456789101112131415161718[root@centos07-12 ingresstest]# kubectl describe ingress ingress-myappName: ingress-myappLabels: &lt;none&gt;Namespace: defaultAddress: 192.168.1.22,192.168.1.62Ingress Class: nginxDefault backend: &lt;default&gt;Rules: Host Path Backends ---- ---- -------- tomcat.dbbruce.com / tomcat:8080 (&lt;error: endpoints &quot;tomcat&quot; not found&gt;)Annotations: &lt;none&gt;Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Sync 21s (x2 over 36s) nginx-ingress-controller Scheduled for sync Normal Sync 20s (x2 over 36s) nginx-ingress-controller Scheduled for sync 报错如下：k8s版本1.25有这个报错，需要执行下面命令：解决办法：kubectl delete -A ValidatingWebhookConfiguration ingress-nginx-admission 123456[root@centos07-12 ingresstest]# kubectl get pods -n ingress-nginx -o wideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESingress-nginx-admission-create-x2m47 0/1 Completed 0 10m 10.244.193.137 centos07-22 &lt;none&gt; &lt;none&gt;ingress-nginx-admission-patch-9zd9n 0/1 Completed 0 10m 10.244.193.134 centos07-22 &lt;none&gt; &lt;none&gt;ingress-nginx-controller-85886f4d44-94bx8 1/1 Running 0 10m 192.168.1.22 centos07-22 &lt;none&gt; &lt;none&gt;ingress-nginx-controller-85886f4d44-s7ppt 1/1 Running 0 10m 192.168.1.62 centos07-62 &lt;none&gt; &lt;none&gt; 6.1 通过keepalived+nginx实现ingress-nginx-controller高可用 1、安装nginx主备： 在centos07-22&#x2F;62上做nginx主备安装 12[root@centos07-22 ~]# yum install epel-release nginx keepalived nginx-mod-stream -y[root@centos07-62 ~]# yum install epel-release nginx keepalived nginx-mod-stream -y 2、修改nginx配置文件。主备一样：在centos07-22&#x2F;62 12345678910111213141516171819202122232425262728293031323334353637383940414243# vim /etc/nginx/nginx.confuser nginx;worker_processes auto;error_log /var/log/nginx/error.log;pid /run/nginx.pid;include /usr/share/nginx/modules/*.conf;events &#123; worker_connections 1024;&#125;# 四层负载均衡，为两台Master apiserver组件提供负载均衡stream &#123; log_format main &#x27;$remote_addr $upstream_addr - [$time_local] $status $upstream_bytes_sent&#x27;; access_log /var/log/nginx/k8s-access.log main; upstream k8s-ingress-controller &#123; server 192.168.1.22:80 weight=5 max_fails=3 fail_timeout=30s; # centos07-22 IP:PORT server 192.168.1.62:80 weight=5 max_fails=3 fail_timeout=30s; # centos07-62 IP:PORT &#125; server &#123; listen 30080; proxy_pass k8s-ingress-controller; # 这里要和upstream写的一样 &#125;&#125;http &#123; log_format main &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27; &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27; &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;; access_log /var/log/nginx/access.log main; sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65; types_hash_max_size 2048; include /etc/nginx/mime.types; default_type application/octet-stream;&#125; 备注：server 反向服务地址和端口weight 权重max_fails 失败多少次，认为主机已挂掉，则踢出fail_timeout 踢出后重新探测时间 1234nginx -tnginx: the configuration file /etc/nginx/nginx.conf syntax is oknginx: configuration file /etc/nginx/nginx.conf test is successful 注意：nginx监听端口变成大于30000的端口，比方说30080,这样访问域名:30080就可以了，必须是满足大于30000以上，才能代理ingress-controller 3、keepalive配置主keepalived - centos07-22 123456789101112131415161718192021222324252627282930313233343536# cat /etc/keepalived/keepalived.conf global_defs &#123; notification_email &#123; acassen@firewall.loc failover@firewall.loc sysadmin@firewall.loc &#125; notification_email_from Alexandre.Cassen@firewall.loc smtp_server 127.0.0.1 smtp_connect_timeout 30 router_id NGINX_MASTER&#125; vrrp_script check_nginx &#123; script &quot;/etc/keepalived/check_nginx.sh&quot;&#125;vrrp_instance VI_1 &#123; state MASTER interface enp0s3 # 修改为实际网卡名 virtual_router_id 51 # VRRP 路由 ID实例，每个实例是唯一的 priority 100 # 优先级，备服务器设置 90 advert_int 1 # 指定VRRP 心跳包通告间隔时间，默认1秒 authentication &#123; auth_type PASS auth_pass 1111 &#125; # 虚拟IP virtual_ipaddress &#123; 192.168.1.199/24 &#125; track_script &#123; check_nginx &#125; &#125; vrrp_script：指定检查nginx工作状态脚本（根据nginx状态判断是否故障转移）virtual_ipaddress：虚拟IP（VIP） 1234567891011121314151617# cat /etc/keepalived/check_nginx.sh #!/bin/bash#1、判断Nginx是否存活counter=$(ps -ef |grep nginx | grep sbin | egrep -cv &quot;grep|$$&quot; )if [ $counter -eq 0 ]; then #2、如果不存活则尝试启动Nginx service nginx start sleep 2 #3、等待2秒后再次获取一次Nginx状态 counter=$(ps -ef |grep nginx | grep sbin | egrep -cv &quot;grep|$$&quot; ) #4、再次进行判断，如Nginx还不存活则停止Keepalived，让地址进行漂移 if [ $counter -eq 0 ]; then service keepalived stop fifi 1[root@centos07-22 keepalived]# chmod +x /etc/keepalived/check_nginx.sh 备keepalive - centos07-62 1234567891011121314151617181920212223242526272829303132333435# cat /etc/keepalived/keepalived.conf global_defs &#123; notification_email &#123; acassen@firewall.loc failover@firewall.loc sysadmin@firewall.loc &#125; notification_email_from Alexandre.Cassen@firewall.loc smtp_server 127.0.0.1 smtp_connect_timeout 30 router_id NGINX_BACKUP&#125; vrrp_script check_nginx &#123; script &quot;/etc/keepalived/check_nginx.sh&quot;&#125;vrrp_instance VI_1 &#123; state BACKUP interface enp0s3 # 这里换成自己的-ifconfig virtual_router_id 51 # VRRP 路由 ID实例，每个实例是唯一的 ,与主的一致 priority 90 advert_int 1 authentication &#123; auth_type PASS auth_pass 1111 &#125; virtual_ipaddress &#123; 192.168.1.199/24 # 虚拟ip &#125; track_script &#123; check_nginx &#125; &#125; 12345678910111213141516# cat /etc/keepalived/check_nginx.sh #!/bin/bash#1、判断Nginx是否存活counter=$(ps -ef |grep nginx | grep sbin | egrep -cv &quot;grep|$$&quot; )if [ $counter -eq 0 ]; then #2、如果不存活则尝试启动Nginx service nginx start sleep 2 #3、等待2秒后再次获取一次Nginx状态 counter=$(ps -ef |grep nginx | grep sbin | egrep -cv &quot;grep|$$&quot; ) #4、再次进行判断，如Nginx还不存活则停止Keepalived，让地址进行漂移 if [ $counter -eq 0 ]; then service keepalived stop fifi 1[root@centos07-62 ~]# chmod +x /etc/keepalived/check_nginx.sh 注：keepalived根据脚本返回状态码（0为工作正常，非0不正常）判断是否故障转移。 4、启动服务 -centos07-22&#x2F;62 daemon-reload: 重新加载某个服务的配置文件，如果新安装了一个服务，归属于 systemctl 管理，要是新服务的服务程序配置文件生效，需重新加载 先启动 centos07-22 123456789[root@centos07-22 keepalived]# systemctl daemon-reload[root@centos07-22 keepalived]# systemctl enable nginx keepalivedCreated symlink from /etc/systemd/system/multi-user.target.wants/nginx.service to /usr/lib/systemd/system/nginx.service.Created symlink from /etc/systemd/system/multi-user.target.wants/keepalived.service to /usr/lib/systemd/system/keepalived.service.[root@centos07-22 keepalived]# systemctl start nginx[root@centos07-22 keepalived]# systemctl start keepalived 再起centos07-62 123456789[root@centos07-62 ~]# systemctl daemon-reload[root@centos07-62 ~]# systemctl enable nginx keepalivedCreated symlink from /etc/systemd/system/multi-user.target.wants/nginx.service to /usr/lib/systemd/system/nginx.service.Created symlink from /etc/systemd/system/multi-user.target.wants/keepalived.service to /usr/lib/systemd/system/keepalived.service.[root@centos07-62 ~]# systemctl start nginx[root@centos07-62 ~]# systemctl start keepalived 5、测试vip是否绑定成功12345678910111213141516171819202122232425[root@centos07-22 keepalived]# ip addr1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever inet6 ::1/128 scope host valid_lft forever preferred_lft forever2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 08:00:27:ab:98:08 brd ff:ff:ff:ff:ff:ff inet 10.0.3.15/24 brd 10.0.3.255 scope global noprefixroute dynamic eth0 valid_lft 79994sec preferred_lft 79994sec inet6 fe80::9c04:aae3:aa70:d253/64 scope link noprefixroute valid_lft forever preferred_lft forever3: enp0s3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 08:00:27:ab:32:79 brd ff:ff:ff:ff:ff:ff inet 192.168.1.22/24 brd 192.168.1.255 scope global noprefixroute enp0s3 valid_lft forever preferred_lft forever inet 192.168.1.199/24 scope global secondary enp0s3 valid_lft forever preferred_lft forever inet6 2409:8a00:603c:9c10:fe40:36b9:7c19:34e3/64 scope global noprefixroute dynamic valid_lft 259027sec preferred_lft 172627sec inet6 2409:8a00:6033:af0:f31f:9c9b:832:902f/64 scope global noprefixroute dynamic valid_lft 209044sec preferred_lft 122644sec inet6 fe80::885:90eb:3a46:25fa/64 scope link noprefixroute valid_lft forever preferred_lft forever 6、测试keepalived：停掉22上的keepalived，Vip会漂移到62上12[root@centos07-22 keepalived]# service keepalived stopRedirecting to /bin/systemctl stop keepalived.service 22keepalive断了，vip漂移到62上了12345678910111213141516171819202122232425[root@centos07-62 ~]# ip addr1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever inet6 ::1/128 scope host valid_lft forever preferred_lft forever2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 08:00:27:ab:98:08 brd ff:ff:ff:ff:ff:ff inet 10.0.3.15/24 brd 10.0.3.255 scope global noprefixroute dynamic eth0 valid_lft 69180sec preferred_lft 69180sec inet6 fe80::9c04:aae3:aa70:d253/64 scope link noprefixroute valid_lft forever preferred_lft forever3: enp0s3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 08:00:27:87:94:c3 brd ff:ff:ff:ff:ff:ff inet 192.168.1.62/24 brd 192.168.1.255 scope global noprefixroute enp0s3 valid_lft forever preferred_lft forever inet 192.168.1.199/24 scope global secondary enp0s3 valid_lft forever preferred_lft forever inet6 2409:8a00:603c:9c10:759:40c2:221c:89b3/64 scope global noprefixroute dynamic valid_lft 259070sec preferred_lft 172670sec inet6 2409:8a00:6033:af0:f299:4e40:f360:bde3/64 scope global noprefixroute dynamic valid_lft 208857sec preferred_lft 122457sec inet6 fe80::5a3c:f64c:f870:624b/64 scope link noprefixroute valid_lft forever preferred_lft forever 启动22上的keepalived, Vip又会漂移到2212[root@centos07-22 keepalived]# service keepalived startRedirecting to /bin/systemctl start keepalived.service 12345678910111213141516171819202122232425[root@centos07-22 keepalived]# ip addr1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever inet6 ::1/128 scope host valid_lft forever preferred_lft forever2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 08:00:27:ab:98:08 brd ff:ff:ff:ff:ff:ff inet 10.0.3.15/24 brd 10.0.3.255 scope global noprefixroute dynamic eth0 valid_lft 79616sec preferred_lft 79616sec inet6 fe80::9c04:aae3:aa70:d253/64 scope link noprefixroute valid_lft forever preferred_lft forever3: enp0s3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 08:00:27:ab:32:79 brd ff:ff:ff:ff:ff:ff inet 192.168.1.22/24 brd 192.168.1.255 scope global noprefixroute enp0s3 valid_lft forever preferred_lft forever inet 192.168.1.199/24 scope global secondary enp0s3 valid_lft forever preferred_lft forever inet6 2409:8a00:603c:9c10:fe40:36b9:7c19:34e3/64 scope global noprefixroute dynamic valid_lft 258956sec preferred_lft 172556sec inet6 2409:8a00:6033:af0:f31f:9c9b:832:902f/64 scope global noprefixroute dynamic valid_lft 208665sec preferred_lft 122265sec inet6 fe80::885:90eb:3a46:25fa/64 scope link noprefixroute valid_lft forever preferred_lft forever 6.2 测试Ingress HTTP代理k8s内部pod 1、部署后端tomcat服务123456789101112131415161718192021222324252627282930313233343536373839404142434445# cat ingress-demo.yaml apiVersion: v1kind: Servicemetadata: name: tomcat namespace: defaultspec: selector: app: tomcat release: canary ports: - name: http targetPort: 8080 port: 8080 - name: ajp targetPort: 8009 port: 8009---apiVersion: apps/v1kind: Deploymentmetadata: name: tomcat-deploy namespace: defaultspec: replicas: 2 selector: matchLabels: app: tomcat release: canary template: metadata: labels: app: tomcat release: canary spec: containers: - name: tomcat image: docker.io/library/tomcat:8.5.34-jre8-alpine imagePullPolicy: IfNotPresent ports: - name: http containerPort: 8080 name: ajp containerPort: 8009 更新资源清单yaml文件：123[root@centos07-12 ingresstest]# kubectl apply -f ingress-demo.yamlservice/tomcat createddeployment.apps/tomcat-deploy created 查看pod是否部署成功123[root@centos07-12 ingresstest]# kubectl get ingress -owide --show-labelsNAME CLASS HOSTS ADDRESS PORTS AGE LABELSingress-myapp nginx tomcat.dbbruce.com 192.168.1.22,192.168.1.62 80 11h &lt;none&gt; 1234[root@centos07-12 ingresstest]# kubectl get svc -owide --show-labelsNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTOR LABELSkubernetes ClusterIP 10.96.0.1 &lt;none&gt; 443/TCP 18d &lt;none&gt; component=apiserver,provider=kubernetestomcat ClusterIP 10.99.241.74 &lt;none&gt; 8080/TCP,8009/TCP 2m14s app=tomcat,release=canary &lt;none&gt; 123[root@centos07-12 ingresstest]# kubectl get deployment -owide --show-labelsNAME READY UP-TO-DATE AVAILABLE AGE CONTAINERS IMAGES SELECTOR LABELStomcat-deploy 2/2 2 2 3m51s tomcat docker.io/library/tomcat:8.5.34-jre8-alpine app=tomcat,release=canary &lt;none&gt; 123[root@centos07-12 ingresstest]# kubectl get replicaset -owide --show-labelsNAME DESIRED CURRENT READY AGE CONTAINERS IMAGES SELECTOR LABELStomcat-deploy-86894dc77b 2 2 2 3m13s tomcat docker.io/library/tomcat:8.5.34-jre8-alpine app=tomcat,pod-template-hash=86894dc77b,release=canary app=tomcat,pod-template-hash=86894dc77b,release=canary 1234[root@centos07-12 ingresstest]# kubectl get pods -owide --show-labelsNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES LABELStomcat-deploy-86894dc77b-nkqnp 1/1 Running 0 7s 10.244.250.234 centos07-62 &lt;none&gt; &lt;none&gt; app=tomcat,pod-template-hash=86894dc77b,release=canarytomcat-deploy-86894dc77b-sk7k5 1/1 Running 0 7s 10.244.193.141 centos07-22 &lt;none&gt; &lt;none&gt; app=tomcat,pod-template-hash=86894dc77b,release=canary 2、编写ingress规则编写ingress的配置清单1234567891011121314151617181920# cat ingress-myapp.yaml apiVersion: networking.k8s.io/v1kind: Ingressmetadata: name: ingress-myapp namespace: defaultspec: ingressClassName: nginx rules: - host: tomcat.dbbruce.com http: paths: - backend: service: name: tomcat # svc的名称 port: number: 8080 # svc的端口号： tomcat ClusterIP 10.99.241.74 &lt;none&gt; 8080/TCP（外部通信）,8009/TCP （内部通信） path: / pathType: Prefix 12[root@centos07-12 ingresstest]# kubectl apply -f ingress-myapp.yamlingress.networking.k8s.io/ingress-myapp created 报错如下：解决办法：kubectl delete -A ValidatingWebhookConfiguration ingress-nginx-admission 查看ingress-myapp的详细信息 123[root@centos07-12 ingresstest]# kubectl get ingressNAME CLASS HOSTS ADDRESS PORTS AGEingress-myapp nginx tomcat.dbbruce.com 192.168.1.22,192.168.1.62 80 77s ingress名称： ingress-myapp对应域名： tomcat.dbbruce.comingress control 对应的 ip：192.168.1.22,192.168.1.62ingress control 端口： 80 123456789101112131415161718[root@centos07-12 ingresstest]# kubectl describe ingress ingress-myappName: ingress-myappLabels: &lt;none&gt;Namespace: defaultAddress: 192.168.1.22,192.168.1.62Ingress Class: nginxDefault backend: &lt;default&gt;Rules: Host Path Backends ---- ---- -------- tomcat.dbbruce.com / tomcat:8080 (10.244.193.141:8080,10.244.250.234:8080)Annotations: &lt;none&gt;Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Sync 48s (x2 over 104s) nginx-ingress-controller Scheduled for sync Normal Sync 48s (x2 over 104s) nginx-ingress-controller Scheduled for sync 查看下ingress-control的pods，发现其实是一个nginx的服务，ingress规则自动生成nginx配置文件 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587588589590591592593594595596597598599600601602603604605606607608609610611612613614615616617618619620621622623624625626627628629630631632633634635636637638639640641642643644645646647648649650651652653654655656657658659660661662663664665666667668669670671672673674675676677678679680681682683684685686687688689690691692693694695696697698699700701702703704705706707708709710711712713714715716717718719720721722[root@centos07-12 ~]# kubectl get pods -n ingress-nginxNAME READY STATUS RESTARTS AGEingress-nginx-admission-create-x2m47 0/1 Completed 0 16hingress-nginx-admission-patch-9zd9n 0/1 Completed 0 16hingress-nginx-controller-85886f4d44-94bx8 1/1 Running 0 16hingress-nginx-controller-85886f4d44-s7ppt 1/1 Running 0 16h[root@centos07-12 ~]# kubectl exec -it -n ingress-nginx ingress-nginx-controller-85886f4d44-s7ppt -- /bin/sh/etc/nginx $ lsfastcgi.conf koi-utf modsecurity owasp-modsecurity-crs uwsgi_params.defaultfastcgi.conf.default koi-win modules scgi_params win-utffastcgi_params lua nginx.conf scgi_params.defaultfastcgi_params.default mime.types nginx.conf.default templategeoip mime.types.default opentracing.json uwsgi_params/etc/nginx $ cat nginx.conf# Configuration checksum: 5200893477115189153# setup custom paths that do not require root accesspid /tmp/nginx.pid;daemon off;worker_processes 4;worker_rlimit_nofile 1047552;worker_shutdown_timeout 240s ;events &#123; multi_accept on; worker_connections 16384; use epoll;&#125;http &#123; lua_package_path &quot;/etc/nginx/lua/?.lua;;&quot;; lua_shared_dict balancer_ewma 10M; lua_shared_dict balancer_ewma_last_touched_at 10M; lua_shared_dict balancer_ewma_locks 1M; lua_shared_dict certificate_data 20M; lua_shared_dict certificate_servers 5M; lua_shared_dict configuration_data 20M; lua_shared_dict global_throttle_cache 10M; lua_shared_dict ocsp_response_cache 5M; init_by_lua_block &#123; collectgarbage(&quot;collect&quot;) -- init modules local ok, res ok, res = pcall(require, &quot;lua_ingress&quot;) if not ok then error(&quot;require failed: &quot; .. tostring(res)) else lua_ingress = res lua_ingress.set_config(&#123; use_forwarded_headers = false, use_proxy_protocol = false, is_ssl_passthrough_enabled = false, http_redirect_code = 308, listen_ports = &#123; ssl_proxy = &quot;442&quot;, https = &quot;443&quot; &#125;, hsts = true, hsts_max_age = 15724800, hsts_include_subdomains = true, hsts_preload = false, global_throttle = &#123; memcached = &#123; host = &quot;&quot;, port = 11211, connect_timeout = 50, max_idle_timeout = 10000, pool_size = 50, &#125;, status_code = 429, &#125; &#125;) end ok, res = pcall(require, &quot;configuration&quot;) if not ok then error(&quot;require failed: &quot; .. tostring(res)) else configuration = res configuration.prohibited_localhost_port = &#x27;10246&#x27; end ok, res = pcall(require, &quot;balancer&quot;) if not ok then error(&quot;require failed: &quot; .. tostring(res)) else balancer = res end ok, res = pcall(require, &quot;monitor&quot;) if not ok then error(&quot;require failed: &quot; .. tostring(res)) else monitor = res end ok, res = pcall(require, &quot;certificate&quot;) if not ok then error(&quot;require failed: &quot; .. tostring(res)) else certificate = res certificate.is_ocsp_stapling_enabled = false end ok, res = pcall(require, &quot;plugins&quot;) if not ok then error(&quot;require failed: &quot; .. tostring(res)) else plugins = res end -- load all plugins that&#x27;ll be used here plugins.init(&#123; &#125;) &#125; init_worker_by_lua_block &#123; lua_ingress.init_worker() balancer.init_worker() monitor.init_worker(10000) plugins.run() &#125; geoip_country /etc/nginx/geoip/GeoIP.dat; geoip_city /etc/nginx/geoip/GeoLiteCity.dat; geoip_org /etc/nginx/geoip/GeoIPASNum.dat; geoip_proxy_recursive on; aio threads; aio_write on; tcp_nopush on; tcp_nodelay on; log_subrequest on; reset_timedout_connection on; keepalive_timeout 75s; keepalive_requests 100; client_body_temp_path /tmp/client-body; fastcgi_temp_path /tmp/fastcgi-temp; proxy_temp_path /tmp/proxy-temp; ajp_temp_path /tmp/ajp-temp; client_header_buffer_size 1k; client_header_timeout 60s; large_client_header_buffers 4 8k; client_body_buffer_size 8k; client_body_timeout 60s; http2_max_field_size 4k; http2_max_header_size 16k; http2_max_requests 1000; http2_max_concurrent_streams 128; types_hash_max_size 2048; server_names_hash_max_size 1024; server_names_hash_bucket_size 64; map_hash_bucket_size 64; proxy_headers_hash_max_size 512; proxy_headers_hash_bucket_size 64; variables_hash_bucket_size 256; variables_hash_max_size 2048; underscores_in_headers off; ignore_invalid_headers on; limit_req_status 503; limit_conn_status 503; include /etc/nginx/mime.types; default_type text/html; # Custom headers for response server_tokens off; more_clear_headers Server; # disable warnings uninitialized_variable_warn off; # Additional available variables: # $namespace # $ingress_name # $service_name # $service_port log_format upstreaminfo &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; $status $body_bytes_sent &quot;$http_referer&quot; &quot;$http_user_agent&quot; $request_length $request_time [$proxy_upstream_name] [$proxy_alternative_upstream_name] $upstream_addr $upstream_response_length $upstream_response_time $upstream_status $req_id&#x27;; map $request_uri $loggable &#123; default 1; &#125; access_log /var/log/nginx/access.log upstreaminfo if=$loggable; error_log /var/log/nginx/error.log notice; resolver 10.96.0.10 valid=30s; # See https://www.nginx.com/blog/websocket-nginx map $http_upgrade $connection_upgrade &#123; default upgrade; # See http://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive &#x27;&#x27; &#x27;&#x27;; &#125; # Reverse proxies can detect if a client provides a X-Request-ID header, and pass it on to the backend server. # If no such header is provided, it can provide a random value. map $http_x_request_id $req_id &#123; default $http_x_request_id; &quot;&quot; $request_id; &#125; # Create a variable that contains the literal $ character. # This works because the geo module will not resolve variables. geo $literal_dollar &#123; default &quot;$&quot;; &#125; server_name_in_redirect off; port_in_redirect off; ssl_protocols TLSv1.2 TLSv1.3; ssl_early_data off; # turn on session caching to drastically improve performance ssl_session_cache shared:SSL:10m; ssl_session_timeout 10m; # allow configuring ssl session tickets ssl_session_tickets off; # slightly reduce the time-to-first-byte ssl_buffer_size 4k; # allow configuring custom ssl ciphers ssl_ciphers &#x27;ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384&#x27;; ssl_prefer_server_ciphers on; ssl_ecdh_curve auto; # PEM sha: 0a0aec962dbb704929f14c1df1491d28b6394114 ssl_certificate /etc/ingress-controller/ssl/default-fake-certificate.pem; ssl_certificate_key /etc/ingress-controller/ssl/default-fake-certificate.pem; proxy_ssl_session_reuse on; upstream upstream_balancer &#123; ### Attention!!! # # We no longer create &quot;upstream&quot; section for every backend. # Backends are handled dynamically using Lua. If you would like to debug # and see what backends ingress-nginx has in its memory you can # install our kubectl plugin https://kubernetes.github.io/ingress-nginx/kubectl-plugin. # Once you have the plugin you can use &quot;kubectl ingress-nginx backends&quot; command to # inspect current backends. # ### server 0.0.0.1; # placeholder balancer_by_lua_block &#123; balancer.balance() &#125; keepalive 320; keepalive_timeout 60s; keepalive_requests 10000; &#125; # Cache for internal auth checks proxy_cache_path /tmp/nginx-cache-auth levels=1:2 keys_zone=auth_cache:10m max_size=128m inactive=30m use_temp_path=off; # Global filters ## start server _ server &#123; server_name _ ; listen 80 default_server reuseport backlog=511 ; listen [::]:80 default_server reuseport backlog=511 ; listen 443 default_server reuseport backlog=511 ssl http2 ; listen [::]:443 default_server reuseport backlog=511 ssl http2 ; set $proxy_upstream_name &quot;-&quot;; ssl_certificate_by_lua_block &#123; certificate.call() &#125; location / &#123; set $namespace &quot;&quot;; set $ingress_name &quot;&quot;; set $service_name &quot;&quot;; set $service_port &quot;&quot;; set $location_path &quot;&quot;; set $global_rate_limit_exceeding n; rewrite_by_lua_block &#123; lua_ingress.rewrite(&#123; force_ssl_redirect = false, ssl_redirect = false, force_no_ssl_redirect = false, preserve_trailing_slash = false, use_port_in_redirects = false, global_throttle = &#123; namespace = &quot;&quot;, limit = 0, window_size = 0, key = &#123; &#125;, ignored_cidrs = &#123; &#125; &#125;, &#125;) balancer.rewrite() plugins.run() &#125; # be careful with `access_by_lua_block` and `satisfy any` directives as satisfy any # will always succeed when there&#x27;s `access_by_lua_block` that does not have any lua code doing `ngx.exit(ngx.DECLINED)` # other authentication method such as basic auth or external auth useless - all requests will be allowed. #access_by_lua_block &#123; #&#125; header_filter_by_lua_block &#123; lua_ingress.header() plugins.run() &#125; body_filter_by_lua_block &#123; plugins.run() &#125; log_by_lua_block &#123; balancer.log() monitor.call() plugins.run() &#125; access_log off; port_in_redirect off; set $balancer_ewma_score -1; set $proxy_upstream_name &quot;upstream-default-backend&quot;; set $proxy_host $proxy_upstream_name; set $pass_access_scheme $scheme; set $pass_server_port $server_port; set $best_http_host $http_host; set $pass_port $pass_server_port; set $proxy_alternative_upstream_name &quot;&quot;; client_max_body_size 1m; proxy_set_header Host $best_http_host; # Pass the extracted client certificate to the backend # Allow websocket connections proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection $connection_upgrade; proxy_set_header X-Request-ID $req_id; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $remote_addr; proxy_set_header X-Forwarded-Host $best_http_host; proxy_set_header X-Forwarded-Port $pass_port; proxy_set_header X-Forwarded-Proto $pass_access_scheme; proxy_set_header X-Forwarded-Scheme $pass_access_scheme; proxy_set_header X-Scheme $pass_access_scheme; # Pass the original X-Forwarded-For proxy_set_header X-Original-Forwarded-For $http_x_forwarded_for; # mitigate HTTPoxy Vulnerability # https://www.nginx.com/blog/mitigating-the-httpoxy-vulnerability-with-nginx/ proxy_set_header Proxy &quot;&quot;; # Custom headers to proxied server proxy_connect_timeout 5s; proxy_send_timeout 60s; proxy_read_timeout 60s; proxy_buffering off; proxy_buffer_size 4k; proxy_buffers 4 4k; proxy_max_temp_file_size 1024m; proxy_request_buffering on; proxy_http_version 1.1; proxy_cookie_domain off; proxy_cookie_path off; # In case of errors try the next upstream server before returning an error proxy_next_upstream error timeout; proxy_next_upstream_timeout 0; proxy_next_upstream_tries 3; proxy_pass http://upstream_balancer; proxy_redirect off; &#125; # health checks in cloud providers require the use of port 80 location /healthz &#123; access_log off; return 200; &#125; # this is required to avoid error if nginx is being monitored # with an external software (like sysdig) location /nginx_status &#123; allow 127.0.0.1; allow ::1; deny all; access_log off; stub_status on; &#125; &#125; ## end server _ ## start server dong.dbbruce.com server &#123; server_name dong.dbbruce.com ; listen 80 ; listen [::]:80 ; listen 443 ssl http2 ; listen [::]:443 ssl http2 ; set $proxy_upstream_name &quot;-&quot;; ssl_certificate_by_lua_block &#123; certificate.call() &#125; location / &#123; set $namespace &quot;default&quot;; set $ingress_name &quot;ingress-tomcat-tls&quot;; set $service_name &quot;tomcat&quot;; set $service_port &quot;8080&quot;; set $location_path &quot;/&quot;; set $global_rate_limit_exceeding n; rewrite_by_lua_block &#123; lua_ingress.rewrite(&#123; force_ssl_redirect = false, ssl_redirect = true, force_no_ssl_redirect = false, preserve_trailing_slash = false, use_port_in_redirects = false, global_throttle = &#123; namespace = &quot;&quot;, limit = 0, window_size = 0, key = &#123; &#125;, ignored_cidrs = &#123; &#125; &#125;, &#125;) balancer.rewrite() plugins.run() &#125; # be careful with `access_by_lua_block` and `satisfy any` directives as satisfy any # will always succeed when there&#x27;s `access_by_lua_block` that does not have any lua code doing `ngx.exit(ngx.DECLINED)` # other authentication method such as basic auth or external auth useless - all requests will be allowed. #access_by_lua_block &#123; #&#125; header_filter_by_lua_block &#123; lua_ingress.header() plugins.run() &#125; body_filter_by_lua_block &#123; plugins.run() &#125; log_by_lua_block &#123; balancer.log() monitor.call() plugins.run() &#125; port_in_redirect off; set $balancer_ewma_score -1; set $proxy_upstream_name &quot;default-tomcat-8080&quot;; set $proxy_host $proxy_upstream_name; set $pass_access_scheme $scheme; set $pass_server_port $server_port; set $best_http_host $http_host; set $pass_port $pass_server_port; set $proxy_alternative_upstream_name &quot;&quot;; client_max_body_size 1m; proxy_set_header Host $best_http_host; # Pass the extracted client certificate to the backend # Allow websocket connections proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection $connection_upgrade; proxy_set_header X-Request-ID $req_id; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $remote_addr; proxy_set_header X-Forwarded-Host $best_http_host; proxy_set_header X-Forwarded-Port $pass_port; proxy_set_header X-Forwarded-Proto $pass_access_scheme; proxy_set_header X-Forwarded-Scheme $pass_access_scheme; proxy_set_header X-Scheme $pass_access_scheme; # Pass the original X-Forwarded-For proxy_set_header X-Original-Forwarded-For $http_x_forwarded_for; # mitigate HTTPoxy Vulnerability # https://www.nginx.com/blog/mitigating-the-httpoxy-vulnerability-with-nginx/ proxy_set_header Proxy &quot;&quot;; # Custom headers to proxied server proxy_connect_timeout 5s; proxy_send_timeout 60s; proxy_read_timeout 60s; proxy_buffering off; proxy_buffer_size 4k; proxy_buffers 4 4k; proxy_max_temp_file_size 1024m; proxy_request_buffering on; proxy_http_version 1.1; proxy_cookie_domain off; proxy_cookie_path off; # In case of errors try the next upstream server before returning an error proxy_next_upstream error timeout; proxy_next_upstream_timeout 0; proxy_next_upstream_tries 3; proxy_pass http://upstream_balancer; proxy_redirect off; &#125; &#125; ## end server dong.dbbruce.com # backend for when default-backend-service is not configured or it does not have endpoints server &#123; listen 8181 default_server reuseport backlog=511; listen [::]:8181 default_server reuseport backlog=511; set $proxy_upstream_name &quot;internal&quot;; access_log off; location / &#123; return 404; &#125; &#125; # default server, used for NGINX healthcheck and access to nginx stats server &#123; listen 127.0.0.1:10246; set $proxy_upstream_name &quot;internal&quot;; keepalive_timeout 0; gzip off; access_log off; location /healthz &#123; return 200; &#125; location /is-dynamic-lb-initialized &#123; content_by_lua_block &#123; local configuration = require(&quot;configuration&quot;) local backend_data = configuration.get_backends_data() if not backend_data then ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR) return end ngx.say(&quot;OK&quot;) ngx.exit(ngx.HTTP_OK) &#125; &#125; location /nginx_status &#123; stub_status on; &#125; location /configuration &#123; client_max_body_size 21M; client_body_buffer_size 21M; proxy_buffering off; content_by_lua_block &#123; configuration.call() &#125; &#125; location / &#123; content_by_lua_block &#123; ngx.exit(ngx.HTTP_NOT_FOUND) &#125; &#125; &#125;&#125;stream &#123; lua_package_path &quot;/etc/nginx/lua/?.lua;/etc/nginx/lua/vendor/?.lua;;&quot;; lua_shared_dict tcp_udp_configuration_data 5M; init_by_lua_block &#123; collectgarbage(&quot;collect&quot;) -- init modules local ok, res ok, res = pcall(require, &quot;configuration&quot;) if not ok then error(&quot;require failed: &quot; .. tostring(res)) else configuration = res end ok, res = pcall(require, &quot;tcp_udp_configuration&quot;) if not ok then error(&quot;require failed: &quot; .. tostring(res)) else tcp_udp_configuration = res tcp_udp_configuration.prohibited_localhost_port = &#x27;10246&#x27; end ok, res = pcall(require, &quot;tcp_udp_balancer&quot;) if not ok then error(&quot;require failed: &quot; .. tostring(res)) else tcp_udp_balancer = res end &#125; init_worker_by_lua_block &#123; tcp_udp_balancer.init_worker() &#125; lua_add_variable $proxy_upstream_name; log_format log_stream &#x27;[$remote_addr] [$time_local] $protocol $status $bytes_sent $bytes_received $session_time&#x27;; access_log /var/log/nginx/access.log log_stream ; error_log /var/log/nginx/error.log notice; upstream upstream_balancer &#123; server 0.0.0.1:1234; # placeholder balancer_by_lua_block &#123; tcp_udp_balancer.balance() &#125; &#125; server &#123; listen 127.0.0.1:10247; access_log off; content_by_lua_block &#123; tcp_udp_configuration.call() &#125; &#125; # TCP services # UDP services&#125; 修改电脑本地的hosts文件，增加如下一行，下面的ip是centos07-22节点ip 123dbbruce@dbburce 课程资料 % sudo vim /etc/hosts192.168.1.199 tomcat.dbbruce.com 浏览器访问tomcat.dbbruce.com，出现如下页面： 代理流程：tomcat.dbbruce.com:30080-&gt;192.168.40.199:30080-&gt;192.168.40.181:80,192.168.40.182:80-&gt;svc: tomcat:8080-&gt;tomcat-deploy- 6.3 扩展：测试Ingress HTTPS代理k8s内部pod 1、构建TLS站点（1）准备证书，在centos07-12节点操作12345678910111213141516171819202122232425262728293031323334353637[root@centos07-12 ~]# cd /root/[root@centos07-12 ~]# openssl genrsa -out tls.key 2048Generating RSA private key, 2048 bit long modulus...................................+++....................................+++e is 65537 (0x10001)[root@centos07-12 ~]# openssl req -new -x509 -key tls.key -out tls.crt -subj /C=CN/ST=Beijing/L=Beijing/O=DevOps/CN=dong.dbbruce.com[root@centos07-12 ~]# ll -lt总用量 146468-rw-r--r-- 1 root root 1294 12月 22 11:30 tls.crt # 证书-rw-r--r-- 1 root root 1679 12月 22 11:29 tls.key # 私钥drwxr-xr-x 2 root root 115 12月 22 11:20 ingresstestdrwxr-xr-x 2 root root 274 12月 21 20:07 rbactestdrwxr-xr-x 2 root root 102 12月 21 14:46 replicasettestdrwxr-xr-x 2 root root 98 12月 21 14:46 statefulsettestdrwxr-xr-x 2 root root 78 12月 20 19:07 secrettestdrwxr-xr-x 3 root root 205 12月 20 13:55 configmaptestdrwxr-xr-x 2 root root 28 12月 20 12:10 daemonsettest-rwxr-xr-x 1 root root 148490240 12月 20 10:59 fluentd_2_5_1.tar.gz-rwxr-xr-x 1 root root 1459200 12月 20 10:59 busybox.tar.gzdrwxr-xr-x 2 root root 128 12月 14 20:04 storageclasstestdrwxr-xr-x 2 root root 172 12月 13 15:53 volumetestdrwxr-xr-x 2 root root 4096 12月 13 10:09 servicetestdrwxr-xr-x 2 root root 61 12月 9 21:22 probe1testdrwxr-xr-x 2 root root 113 12月 6 23:36 inittestdrwxr-xr-x 2 root root 57 12月 6 16:59 restartpolicytestdrwxr-xr-x 2 root root 93 12月 6 09:57 tainttestdrwxr-xr-x 2 root root 98 12月 5 23:32 nodeantiaffinitytestdrwxr-xr-x 2 root root 88 12月 5 22:52 nodeaffinitytestdrwxr-xr-x 2 root root 158 12月 5 22:40 affinitytestdrwxr-xr-x 2 root root 45 12月 5 18:34 nodenametestdrwxr-xr-x 2 root root 79 12月 5 11:52 nstest-rwxr-xr-x 1 root root 10756 12月 3 17:17 update-kubeadm-cert.sh-rw-------. 1 root root 1455 8月 14 15:10 anaconda-ks.cfg （2）生成secret，在centos07-12节点操作12[root@centos07-12 ~]# kubectl create secret tls tomcat-ingress-secret --cert=tls.crt --key=tls.keysecret/tomcat-ingress-secret created （3）查看secret12345[root@centos07-12 ~]# kubectl get secretNAME TYPE DATA AGEmysecret Opaque 2 40hmysql-password Opaque 1 40htomcat-ingress-secret kubernetes.io/tls 2 17s （4）查看tomcat-ingress-secret详细信息123456789101112[root@centos07-12 ~]# kubectl describe secret tomcat-ingress-secretName: tomcat-ingress-secretNamespace: defaultLabels: &lt;none&gt;Annotations: &lt;none&gt;Type: kubernetes.io/tlsData====tls.crt: 1294 bytestls.key: 1679 bytes Ingress规则可以参考官方： https://kubernetes.io/zh/docs/concepts/services-networking/ingress/ 123456789101112131415161718192021[root@centos07-12 ~]# kubectl explain ingress.spec.rules.http.paths.backend.serviceGROUP: networking.k8s.ioKIND: IngressVERSION: v1FIELD: service &lt;IngressServiceBackend&gt;DESCRIPTION: service references a service as a backend. This is a mutually exclusive setting with &quot;Resource&quot;. IngressServiceBackend references a Kubernetes Service as a Backend.FIELDS: name &lt;string&gt; -required- name is the referenced service. The service must exist in the same namespace as the Ingress object. port &lt;ServiceBackendPort&gt; port of the referenced service. A port name or port number is required for a IngressServiceBackend. 123456789101112131415161718192021222324# cat ingress-tomcat-tls.yamlapiVersion: networking.k8s.io/v1kind: Ingressmetadata: name: ingress-tomcat-tls namespace: defaultspec: ingressClassName: nginx tls: - hosts: - dong.dbbruce.com secretName: tomcat-ingress-secret rules: - host: dong.dbbruce.com http: paths: - path: / pathType: Prefix backend: service: name: tomcat port: number: 8080 更新yaml文件 12345[root@centos07-12 ingresstest]# kubectl delete -f ingress-myapp.yamlingress.networking.k8s.io &quot;ingress-myapp&quot; deleted[root@centos07-12 ingresstest]# kubectl apply -f ingress-tomcat-tls.yamlingress.networking.k8s.io/ingress-tomcat-tls created 修改电脑的hosts文件： 123dbbruce@dbburce 课程资料 % sudo vim /etc/hosts192.168.1.199 dong.dbbruce.com 浏览器访问https://dong.dbbruce.com:30080 6.3 同一个k8s搭建多套Ingress-controlleringress可以简单理解为service的service，他通过独立的ingress对象来制定请求转发的规则，把请求路由到一个或多个service中。这样就把服务与请求规则解耦了，可以从业务维度统一考虑业务的暴露，而不用为每个service单独考虑。 在同一个k8s集群里，部署两个ingress nginx。一个deploy部署给A的API网关项目用。另一个daemonset部署给其它项目作域名访问用。这两个项目的更新频率和用法不一致，暂时不用合成一个。 为了满足多租户场景，需要在k8s集群部署多个ingress-controller，给不同用户不同环境使用。 主要参数设置： 123456containers: - name: nginx-ingress-controller image: registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller:v1.1.0 args: - /nginx-ingress-controller - --ingress-class=ngx-ds 注意：–ingress-class设置该Ingress Controller可监听的目标Ingress Class标识；注意：同一个集群中不同套Ingress Controller监听的Ingress Class标识必须唯一，且不能设置为nginx关键字（其是集群默认Ingress Controller的监听标识）； 创建Ingress规则： 123456789101112131415161718apiVersion: networking.k8s.io/v1kind: Ingressmetadata: name: ingress-myapp namespace: defaultspec: ingressClassName: nginx rules: - host: tomcat.dbbruce.com http: paths: - path: / pathType: Prefix backend: service: name: tomcat port: number: 8080 注意：这里要设置为你前面配置的controller.ingressClass唯一标识","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"29-K8S安全实战篇之RBAC认证授权","slug":"运维/K8S/基础/29-K8S安全实战篇之RBAC认证授权","date":"2023-05-14T12:00:00.000Z","updated":"2023-12-21T14:22:44.000Z","comments":true,"path":"2023/05/14/运维/K8S/基础/29-K8S安全实战篇之RBAC认证授权/","link":"","permalink":"https://dbbruce.github.io/2023/05/14/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/29-K8S%E5%AE%89%E5%85%A8%E5%AE%9E%E6%88%98%E7%AF%87%E4%B9%8BRBAC%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83/","excerpt":"1 k8s安全管理：认证、授权、准入控制概述1.1 认证认证基本介绍kubernetes主要通过APIserver对外提供服务，那么就需要对访问apiserver的用户做认证，如果任何人都能访问apiserver，那么就可以随意在k8s集群部署资源，这是非常危险的，也容易被黑客攻击渗透，所以需要我们对访问k8s系统的apiserver的用户进行认证，确保是合法的符合要求的用户。","text":"1 k8s安全管理：认证、授权、准入控制概述1.1 认证认证基本介绍kubernetes主要通过APIserver对外提供服务，那么就需要对访问apiserver的用户做认证，如果任何人都能访问apiserver，那么就可以随意在k8s集群部署资源，这是非常危险的，也容易被黑客攻击渗透，所以需要我们对访问k8s系统的apiserver的用户进行认证，确保是合法的符合要求的用户。 授权基本介绍：认证通过后仅代表它是一个被apiserver信任的用户，能访问apiserver，但是用户是否拥有删除资源的权限， 需要进行授权操作，常见的授权方式有rbac授权。 准入控制基本介绍：当用户经过认证和授权之后，最后一步就是准入控制了，k8s提供了多种准入控制机制，它有点类似”插件”，为apiserver提供了很好的”可扩展性”。请求apiserver时，通过认证、鉴权后、持久化(“api对象”保存到etcd)前，会经过”准入控制器”，让它可以做”变更和验证”。为什么需要准入控制器呢？如果我们创建pod时定义了资源上下限，但不满足LimitRange规则中定义的资源上下限，此时LimitRanger就会拒绝我们创建此pod 假如我们定义了一个名称空间叫做test-aa，这个名称空间做下资源限制：限制最多可以使用10vCPU、10Gi内存，在这个名称空间test-aa下创建的所有pod，定义limit的时候，所有pod的limit值不能超过test-aa这个名称空间设置的limit上线。 k8s客户端访问apiserver的几种认证方式1）客户端认证：客户端认证也称为双向TLS认证， kubectl在访问apiserver的时候，apiserver也要认证kubectl是否是合法的，他们都会通过ca根证书来进行验证，如下图：2）BearertokenBearertoken的方式，可以理解为apiserver将一个密码通过了非对称加密的方式告诉了kubectl，然后通过该密码进行相互访问，如下图：Kubectl访问k8s集群，要找一个kubeconfig文件，基于kubeconfig文件里的用户访问apiserver3）Serviceaccount上面客户端证书认证和Bearertoken的两种认证方式，都是外部访问apiserver的时候使用的方式，那么我们这次说的Serviceaccount是内部访问pod和apiserver交互时候采用的一种方式。Serviceaccount包括了，namespace、token、ca，且通过目录挂载的方式给予pod，当pod运行起来的时候，就会读取到这些信息，从而使用该方式和apiserver进行通信。如下图： kubeconfig文件官方地址： https://kubernetes.io/zh-cn/docs/concepts/configuration/organize-cluster-access-kubeconfig/ 1[root@centos07-12 ~]# vim /root/.kube/config 1234567891011121314151617181920[root@centos07-12 ~]# kubectl config viewapiVersion: v1clusters:- cluster: certificate-authority-data: DATA+OMITTED server: https://192.168.1.12:6443 name: kubernetescontexts:- context: cluster: kubernetes user: kubernetes-admin name: kubernetes-admin@kubernetescurrent-context: kubernetes-admin@kuberneteskind: Configpreferences: &#123;&#125;users:- name: kubernetes-admin user: client-certificate-data: DATA+OMITTED client-key-data: DATA+OMITTED 在K8S集群当中，当我们使用kubectl操作k8s资源时候，需要确定我们用哪个用户访问哪个k8s集群，kubectl操作k8s集群资源会去&#x2F;root&#x2F;.kube目录下找config文件，可以通过kubectl config查看config文件配置，如下： 12345678910111213141516171819202122kubectl config view显示如下：apiVersion: v1clusters:- cluster: certificate-authority-data: DATA+OMITTED server: https://192.168.40.180:6443 #apiserver的地址 name: kubernetes #集群的名字contexts: # 上下文，环境- context: cluster: kubernetes user: kubernetes-admin name: kubernetes-admin@kubernetes #上下文的名字current-context: kubernetes-admin@kubernetes #当前上下文的名字kind: Configpreferences: &#123;&#125;users:- name: kubernetes-admin user: client-certificate-data: REDACTED # 证书 client-key-data: REDACTED # 私钥 在上面的配置文件当中，定义了集群、上下文以及用户。其中Config也是K8S的标准资源之一，在该配置文件当中定义了一个集群列表，指定的集群可以有多个；用户列表也可以有多个，指明集群中的用户；而在上下文列表当中，是进行定义可以使用哪个用户对哪个集群进行访问，以及当前使用的上下文是什么。 针对配置信息，kubectl 在 $HOME&#x2F;.kube 目录中查找一个名为 config 的配置文件。 你可以通过设置 KUBECONFIG 环境变量或设置 –kubeconfig 参数来指定其它 kubeconfig 文件。kubectl get pods –kubeconfig&#x3D;&#x2F;root&#x2F;.kube&#x2F;config 1.2 授权用户通过认证之后，什么权限都没有，需要一些后续的授权操作，如对资源的增删该查等，kubernetes1.6之后开始有RBAC（基于角色的访问控制机制）授权检查机制。Kubernetes的授权是基于插件形成的，其常用的授权插件有以下几种：1）Node（节点认证）2）ABAC(基于属性的访问控制)3）RBAC（基于角色的访问控制）***4）Webhook（基于http回调机制的访问控制） 什么是RBAC（基于角色的授权）？让一个用户（Users）扮演一个角色（Role），角色拥有权限，从而让用户拥有这样的权限，随后在授权机制当中，只需要将权限授予某个角色，此时用户将获取对应角色的权限，从而实现角色的访问控制。如图： 在k8s的授权机制当中，采用RBAC的方式进行授权，其工作逻辑是，把对对象的操作权限定义到一个角色当中，再将用户绑定到该角色，从而使用户得到对应角色的权限。如果通过rolebinding绑定role，只能对rolebingding所在的名称空间的资源有权限，上图user1这个用户绑定到role1上，只对role1这个名称空间的资源有权限，对其他名称空间资源没有权限，属于名称空间级别的； 另外，k8s为此还有一种集群级别的授权机制，就是定义一个集群角色（ClusterRole），对集群内的所有资源都有可操作的权限，从而将User2通过ClusterRoleBinding到ClusterRole，从而使User2拥有集群的操作权限。 Role、RoleBinding、ClusterRole和ClusterRoleBinding的关系如下：1、用户基于rolebinding绑定到role限定在rolebinding所在的名称空间 2、用户基于rolebinding绑定到clusterrole上面我们说了两个角色绑定：（1）用户通过rolebinding绑定role（2）用户通过rolebinding绑定clusterrole rolebinding绑定clusterrole的好处：假如有6个名称空间，每个名称空间的用户都需要对自己的名称空间有管理员权限，那么需要定义6个role和rolebinding，然后依次绑定，如果名称空间更多，我们需要定义更多的role，这个是很麻烦的，所以我们引入clusterrole，定义一个clusterrole，对clusterrole授予所有权限，然后用户通过rolebinding绑定到clusterrole，就会拥有自己名称空间的管理员权限了 注：RoleBinding仅仅对当前名称空间有对应的权限。 3、用户基于clusterrolebinding绑定到clusterrole用户基于rbac授权有几种方案：基于rolebinding绑定到role上基于rolebinding绑定到clusterrole上基于clusterrolebinding绑定到clusterrole上 1.3 准入控制在k8s上准入控制器的模块有很多，其中比较常用的有LimitRanger、ResourceQuota、ServiceAccount、PodSecurityPolicy(k8s1.25废弃了)等等，对于前面三种准入控制器系统默认是启用的，我们只需要定义对应的规则即可；对于PodSecurityPolicy(k8s1.25废弃了)这种准入控制器，系统默认没有启用，如果我们要使用，就必需启用以后，对应规则才会正常生效；这里需要注意一点，对应psp准入控制器，一定要先写好对应的规则，把规则和权限绑定好以后，在启用对应的准入控制器，否则先启用准入控制器，没有对应的规则，默认情况它是拒绝操作，这可能导致现有的k8s系统跑的系统级pod无法正常工作；所以对于psp准入控制器要慎用，如果规则和权限做的足够精细，它会给我们的k8s系统安全带来大幅度的提升，反之，可能导致整个k8s系统不可用。 查看apiserver启用的准入控制器有哪些？ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109# cat /etc/kubernetes/manifests/kube-apiserver.yamlapiVersion: v1kind: Podmetadata: annotations: kubeadm.kubernetes.io/kube-apiserver.advertise-address.endpoint: 192.168.1.12:6443 creationTimestamp: null labels: component: kube-apiserver tier: control-plane name: kube-apiserver namespace: kube-systemspec: containers: - command: - kube-apiserver - --advertise-address=192.168.1.12 - --allow-privileged=true - --authorization-mode=Node,RBAC - --client-ca-file=/etc/kubernetes/pki/ca.crt - --enable-admission-plugins=NodeRestriction - --enable-bootstrap-token-auth=true - --etcd-cafile=/etc/kubernetes/pki/etcd/ca.crt - --etcd-certfile=/etc/kubernetes/pki/apiserver-etcd-client.crt - --etcd-keyfile=/etc/kubernetes/pki/apiserver-etcd-client.key - --etcd-servers=https://127.0.0.1:2379 - --kubelet-client-certificate=/etc/kubernetes/pki/apiserver-kubelet-client.crt - --kubelet-client-key=/etc/kubernetes/pki/apiserver-kubelet-client.key - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname - --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.crt - --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client.key - --requestheader-allowed-names=front-proxy-client - --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt - --requestheader-extra-headers-prefix=X-Remote-Extra- - --requestheader-group-headers=X-Remote-Group - --requestheader-username-headers=X-Remote-User - --secure-port=6443 - --service-account-issuer=https://kubernetes.default.svc.cluster.local - --service-account-key-file=/etc/kubernetes/pki/sa.pub - --service-account-signing-key-file=/etc/kubernetes/pki/sa.key - --service-cluster-ip-range=10.96.0.0/12 - --tls-cert-file=/etc/kubernetes/pki/apiserver.crt - --tls-private-key-file=/etc/kubernetes/pki/apiserver.key image: registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.27.0 imagePullPolicy: IfNotPresent livenessProbe: failureThreshold: 8 httpGet: host: 192.168.1.12 path: /livez port: 6443 scheme: HTTPS initialDelaySeconds: 10 periodSeconds: 10 timeoutSeconds: 15 name: kube-apiserver readinessProbe: failureThreshold: 3 httpGet: host: 192.168.1.12 path: /readyz port: 6443 scheme: HTTPS periodSeconds: 1 timeoutSeconds: 15 resources: requests: cpu: 250m startupProbe: failureThreshold: 24 httpGet: host: 192.168.1.12 path: /livez port: 6443 scheme: HTTPS initialDelaySeconds: 10 periodSeconds: 10 timeoutSeconds: 15 volumeMounts: - mountPath: /etc/ssl/certs name: ca-certs readOnly: true - mountPath: /etc/pki name: etc-pki readOnly: true - mountPath: /etc/kubernetes/pki name: k8s-certs readOnly: true hostNetwork: true priority: 2000001000 priorityClassName: system-node-critical securityContext: seccompProfile: type: RuntimeDefault volumes: - hostPath: path: /etc/ssl/certs type: DirectoryOrCreate name: ca-certs - hostPath: path: /etc/pki type: DirectoryOrCreate name: etc-pki - hostPath: path: /etc/kubernetes/pki type: DirectoryOrCreate name: k8s-certsstatus: &#123;&#125; 提示：apiserver启用准入控制插件需要使用–enable-admission-plugins选项来指定，该选项可以使用多个值，用逗号隔开表示启用指定的准入控制插件；这里配置文件中显式启用了NodeRestrication这个插件；默认没有写在这上面的内置准入控制器，它也是启用了的，比如LimitRanger、ResourceQuota、ServiceAccount等等；对于不同的k8s版本，内置的准入控制器和启用与否请查看相关版本的官方文档；对于那些没有启动的准入控制器，我们可以在上面选项中直接启用，分别用逗号隔开即可。 对应的官网地址： https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/admission-controllers/ 2 Useraccount和ServiceAccount介绍kubernetes中账户分为：UserAccounts（用户账户） 和 ServiceAccounts（服务账户） 两种：UserAccount是给kubernetes集群外部用户使用的，如kubectl访问k8s集群要用useraccount用户， kubeadm安装的k8s，默认的useraccount用户是kubernetes-admin； k8s客户端(一般用:kubectl) ——&gt;API Server APIServer需要对客户端做认证，使用kubeadm安装的K8s，会在用户家目录下创建一个认证配置文件 .kube&#x2F;config 这里面保存了客户端访问API Server的密钥相关信息，这样当用kubectl访问k8s时，它就会自动读取该配置文件，向API Server发起认证，然后完成操作请求。 用户名称可以在kubeconfig中查看 1234567891011121314151617181920212223[root@centos07-12 ~]# cd ~/.kube/[root@centos07-12 .kube]# lscache config[root@centos07-12 .kube]# cat configapiVersion: v1clusters:- cluster: certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJek1USXdNekE0TVRZME5sb1hEVE16TVRFek1EQTRNVFkwTmxvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBT0tjClFValdBODhpbndzd1Y1bWRaMlVHZ3BwUklwN0lSb3VxWVZSVDdXbmtIdUlEWTllYXdNQW9IWjlIS0QwVVhneFoKOEhQVlBPQmkxTzRnMDNybkZaSDg2blF4cUgvbkpJcXBNNEtjeFJTR0xvTHhCMGVITVVMamhZVHZCektpQXVFZwpSNUlFYWw2YldXcnRCS2JpN2JLVHpzU3ZsTGR6NUVPSzB2Rk5yeTlWUUYxNkpETUF5SGtaZzU5SjRKeFQySGVoCjIwTTViamRGbEVsOUJrakQ5SkJQRlVqbHQyU0dlWDJqYTNpOVNseDAyUURCMTNsRWw5ZDIyUVFxVFlHRk8yQ3oKSE5TTEsxMk5qdHBCcysvUXRTZWxDZER0T0xhak5wNnJpZVExK1dNQldQSU9sOU5TNk9OcXhJNWE0U3lMWmtHMgpEU3hGYXI2NjJTNHZabDV4bjFFQ0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZIbW8zeDhsRkZXTkVmRUs4MCs0OVlOMlBRK2FNQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBSFp3NWNJU0NSb1NZc3RWcllRVAp4MnBoaldwYXRKWm96R2VzQ0JTNTNsYktKQW9DaThrcWxQMWpVNVZxaEZSMEVDRlBYcG5xc3FUcmFHS2oyaVIrCjhkRHIxZi9SQ01xKzA1SjZ6S1dRbkdzdXdBWUhndlZVYnI1eGhtR2llZWlsVm42WHFzUlRlSXkrMWZTbk90cFEKZVRkNkhiZDBFYzhQajYwRmp2K1kvbTd5ODVnNHoxZ2diRlkrWmV1YUowcFQzUjc5eEFhakVmSXlrTlFVeGpjcwpnNGdMM1FLRG8rS3lycXhvR2hUQVJ6OUJ4THdvZGtTTFJwSE1RbU5BdGFRaVkxemR2MXVPMThac2szQmpnYWNjCmJvdm5GdlZ2cG12L1lIYThrZlMzaUJ0b0xaYmNlTTUycVZnc3M2OE10U0Y0T2ltbk5zbGZqa2srdnp5M2xMZi8KNXBBPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg== server: https://192.168.1.12:6443 name: kubernetescontexts:- context: cluster: kubernetes user: kubernetes-admin name: kubernetes-admin@kubernetescurrent-context: kubernetes-admin@kuberneteskind: Configpreferences: &#123;&#125;users:- name: kubernetes-admin # 用户 user: ServiceAccount是Pod使用的账号，Pod容器的进程需要访问API Server时用的就是ServiceAccount账户；ServiceAccount仅局限它所在的namespace，每个namespace创建时都会自动创建一个default service account；创建Pod时，如果没有指定Service Account，Pod则会使用default Service Account。 3 ServiceAccount使用案例介绍: 创建sa，并绑定到pod3.1 创建sa12345678[root@centos07-12 .kube]# kubectl create sa sa-testserviceaccount/sa-test created[root@centos07-12 .kube]# kubectl get saNAME SECRETS AGEdefault 0 17dnfs-provisioner 0 6d2hsa-test 0 3s 3.2 创建pod12345678910111213141516# cat pod.yaml apiVersion: v1kind: Podmetadata: name: sa-test namespace: default labels: app: saspec: serviceAccountName: sa-test containers: - name: sa-tomcat ports: - containerPort: 80 image: docker.io/library/nginx:latest imagePullPolicy: IfNotPresent 12[root@centos07-12 rbactest]# kubectl apply -f pod.yamlpod/sa-test created 123[root@centos07-12 rbactest]# kubectl get podsNAME READY STATUS RESTARTS AGEsa-test 1/1 Running 0 8s 123456789101112131415[root@centos07-12 rbactest]# kubectl exec -it sa-test -- /bin/bashroot@sa-test:/# cd /var/run/secrets/kubernetes.io/serviceaccount/root@sa-test:/var/run/secrets/kubernetes.io/serviceaccount# curl --cacert ./ca.crt -H &quot;Authorization: Bearer $(cat ./token)&quot; https://kubernetes/api/v1/namespaces/kube-system&#123; &quot;kind&quot;: &quot;Status&quot;, &quot;apiVersion&quot;: &quot;v1&quot;, &quot;metadata&quot;: &#123;&#125;, &quot;status&quot;: &quot;Failure&quot;, &quot;message&quot;: &quot;namespaces \\&quot;kube-system\\&quot; is forbidden: User \\&quot;system:serviceaccount:default:sa-test\\&quot; cannot get resource \\&quot;namespaces\\&quot; in API group \\&quot;\\&quot; in the namespace \\&quot;kube-system\\&quot;&quot;, &quot;reason&quot;: &quot;Forbidden&quot;, &quot;details&quot;: &#123; &quot;name&quot;: &quot;kube-system&quot;, &quot;kind&quot;: &quot;namespaces&quot; &#125;, &quot;code&quot;: 403 上面结果能看到sa能通过https方式成功认证API，但是没有权限访问k8s资源，所以code状态码是403，表示没有权限操作k8s资源 3.3 对sa做授权 kubectl create clusterrolebinding sa-test-admin –clusterrole&#x3D;cluster-admin –serviceaccount&#x3D;default:sa-test绑定前 12[root@centos07-12 rbactest]# kubectl create clusterrolebinding sa-test-admin --clusterrole=cluster-admin --serviceaccount=default:sa-testclusterrolebinding.rbac.authorization.k8s.io/sa-test-admin created 12[root@centos07-12 rbactest]# kubectl get clusterrolebinding |grep adminsa-test-admin ClusterRole/cluster-admin 2s 3.4 再次请求12345678910111213141516171819202122232425262728293031323334353637383940[root@centos07-12 rbactest]# kubectl exec -it sa-test -- /bin/bashroot@sa-test:/# cd /var/run/secrets/kubernetes.io/serviceaccount/root@sa-test:/var/run/secrets/kubernetes.io/serviceaccount# curl --cacert ./ca.crt -H &quot;Authorization: Bearer $(cat ./token)&quot; https://kubernetes/api/v1/namespaces/kube-system&#123; &quot;kind&quot;: &quot;Namespace&quot;, &quot;apiVersion&quot;: &quot;v1&quot;, &quot;metadata&quot;: &#123; &quot;name&quot;: &quot;kube-system&quot;, &quot;uid&quot;: &quot;5891aa5c-4e4e-42e3-b772-679c4bc85315&quot;, &quot;resourceVersion&quot;: &quot;10&quot;, &quot;creationTimestamp&quot;: &quot;2023-12-03T08:16:58Z&quot;, &quot;labels&quot;: &#123; &quot;kubernetes.io/metadata.name&quot;: &quot;kube-system&quot; &#125;, &quot;managedFields&quot;: [ &#123; &quot;manager&quot;: &quot;kube-apiserver&quot;, &quot;operation&quot;: &quot;Update&quot;, &quot;apiVersion&quot;: &quot;v1&quot;, &quot;time&quot;: &quot;2023-12-03T08:16:58Z&quot;, &quot;fieldsType&quot;: &quot;FieldsV1&quot;, &quot;fieldsV1&quot;: &#123; &quot;f:metadata&quot;: &#123; &quot;f:labels&quot;: &#123; &quot;.&quot;: &#123;&#125;, &quot;f:kubernetes.io/metadata.name&quot;: &#123;&#125; &#125; &#125; &#125; &#125; ] &#125;, &quot;spec&quot;: &#123; &quot;finalizers&quot;: [ &quot;kubernetes&quot; ] &#125;, &quot;status&quot;: &#123; &quot;phase&quot;: &quot;Active&quot; &#125; 通过上面可以看到，对sa做授权之后就有权限访问k8s资源了cd &#x2F;var&#x2F;run&#x2F;secrets&#x2F;kubernetes.io&#x2F;serviceaccountcurl –cacert .&#x2F;ca.crt -H “Authorization: Bearer $(cat .&#x2F;token)” https://kubernetes/api/v1/pod 4 RBAC认证授权策略RBAC介绍在Kubernetes中，所有资源对象都是通过API进行操作，他们保存在etcd里。而对etcd的操作我们需要通过访问 kube-apiserver 来实现，上面的Service Account其实就是APIServer的认证过程，而授权的机制是通过RBAC：基于角色的访问控制实现。 RBAC有四个资源对象，分别是Role、ClusterRole、RoleBinding、ClusterRoleBinding 4.1 Role：角色一组权限的集合，在一个命名空间中，可以用其来定义一个角色，只能对命名空间内的资源进行授权。如果是集群级别的资源，则需要使用ClusterRole。例如：定义一个角色用来读取Pod的权限 12345678910111213141516apiVersion: rbac.authorization.k8s.io/v1kind: Rolemetadata: namespace: rbac name: pod-readrules: # 指定什么样的规则和权限- apiGroups: [&quot;&quot;] resources: [&quot;pods&quot;] # 对pod类型 resourceNames: [] # 如果有多个pod时，想指定授权的pod，这里写pod的名字verbs: [&quot;get&quot;,&quot;watch&quot;,&quot;list&quot;] # 权限rules中的参数说明：1、apiGroups：支持的API组列表，例如：&quot;apiVersion: apps/v1&quot;等2、resources：支持的资源对象列表，例如pods、deployments、jobs等3、resourceNames: 指定resource的名称4、verbs：对资源对象的操作方法列表。 https://kubernetes.io/zh-cn/docs/reference/kubernetes-api/authorization-resources/role-v1/ 4.2 ClusterRole：集群角色具有和角色一致的命名空间资源的管理能力，还可用于以下特殊元素的授权1、集群范围的资源，例如Node2、非资源型的路径，例如：&#x2F;healthz3、包含全部命名空间的资源，例如Pods 例如：定义一个集群角色可让用户访问任意secrets 12345678apiVersion: rbac.authorization.k8s.io/v1kind: ClusterRolemetadata: name: secrets-clusterrolerules:- apiGroups: [&quot;&quot;] resources: [&quot;secrets&quot;]verbs: [&quot;get&quot;,&quot;watch&quot;,&quot;list&quot;] 4.3 RoleBinding：角色绑定、ClusterRolebinding：集群角色绑定角色绑定和集群角色绑定用于把一个角色绑定在一个目标上，可以是User，Group，Service Account，使用RoleBinding为某个命名空间授权，使用ClusterRoleBinding为集群范围内授权。例如：将在rbac命名空间中把pod-read角色授予用户es 12345678910111213apiVersion: rbac.authorization.k8s.io/v1kind: RoleBindingmetadata: name: pod-read-bind namespace: rbacsubjects:- kind: User name: es apiGroup: rbac.authorization.k8s.ioroleRef:- kind: Role name: pod-read apiGroup: rbac.authorizatioin.k8s.io RoleBinding也可以引用ClusterRole，对属于同一命名空间内的ClusterRole定义的资源主体进行授权，例如：es能获取到集群中所有的资源信息 12345678910111213apiVersion: rbac.authorization.k8s.io/v1kind: RoleBindingmetadata: name: es-allresource namespace: rbacsubjects:- kind: User name: es apiGroup: rbac.authorization.k8s.ioroleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: cluster-admin 5 资源的引用方式多数资源可以用其名称的字符串表示，也就是Endpoint中的URL相对路径，例如pod中的日志是GET &#x2F;api&#x2F;v1&#x2F;namaspaces&#x2F;{namespace}&#x2F;pods&#x2F;{podname}&#x2F;log如果需要在一个RBAC对象中体现上下级资源，就需要使用“&#x2F;”分割资源和下级资源。例如：若想授权让某个主体同时能够读取Pod和Pod log，则可以配置 resources为一个数组 12[root@centos07-12 .kube]# kubectl create ns testnamespace/test created 1234567[root@centos07-12 .kube]# kubectl get nsNAME STATUS AGEdefault Active 17dkube-node-lease Active 17dkube-public Active 17dkube-system Active 17dtest Active 17m 1234567891011# vim role-test.yamlapiVersion: rbac.authorization.k8s.io/v1kind: Rolemetadata: name: logs-reader namespace: testrules:- apiGroups: [&quot;&quot;] resources: [&quot;pods&quot;,&quot;pods/log&quot;] verbs: [&quot;get&quot;,&quot;list&quot;,&quot;watch&quot;] 12[root@centos07-12 rbactest]# kubectl apply -f role-test.yamlrole.rbac.authorization.k8s.io/logs-reader created 123[root@centos07-12 rbactest]# kubectl get roles -n testNAME CREATED ATlogs-reader 2023-12-20T15:30:15Z 创建sa账号：sa-test 12[root@centos07-12 rbactest]# kubectl create sa sa-test -n testserviceaccount/sa-test created 12345[root@centos07-12 rbactest]# kubectl get saNAME SECRETS AGEdefault 0 17dnfs-provisioner 0 6d3hsa-test 0 63m 将账号sa-test绑定到logs-reader角色创建一个rolebinding: 名称：sa-test-1 ，指定在test命名空间下，绑定test命名空间下的sa-test账号；说明test的命名空间下账号sa-test,只能查test命名空间下的pod 12[root@centos07-12 rbactest]# kubectl create rolebinding sa-test-1 -n test --role=logs-reader --serviceaccount=test:sa-testrolebinding.rbac.authorization.k8s.io/sa-test-1 created 1234567891011121314151617# vim pod-test.yamlapiVersion: v1kind: Podmetadata: name: sa-test-pod namespace: test labels: app: saspec: serviceAccountName: sa-test containers: - name: sa-tomcat ports: - containerPort: 80 image: docker.io/library/nginx:latest imagePullPolicy: IfNotPresent 12[root@centos07-12 rbactest]# kubectl apply -f pod-test.yamlpod/sa-test-pod created 123[root@centos07-12 rbactest]# kubectl get pod -n testNAME READY STATUS RESTARTS AGEsa-test-pod 1/1 Running 0 69s 12345678910111213141516[root@centos07-12 rbactest]# kubectl exec -it sa-test-pod -n test -- /bin/bashroot@sa-test-pod:/# cd /var/run/secrets/kubernetes.io/serviceaccountroot@sa-test-pod:/var/run/secrets/kubernetes.io/serviceaccount# curl --cacert ./ca.crt -H &quot;Authorization: Bearer $(cat ./token)&quot; https://kubernetes.default/api/v1/namespaces/test/pods/sa-test-pod/logs&#123; &quot;kind&quot;: &quot;Status&quot;, &quot;apiVersion&quot;: &quot;v1&quot;, &quot;metadata&quot;: &#123;&#125;, &quot;status&quot;: &quot;Failure&quot;, &quot;message&quot;: &quot;pods \\&quot;sa-test-pod\\&quot; is forbidden: User \\&quot;system:serviceaccount:test:sa-test\\&quot; cannot get resource \\&quot;pods/logs\\&quot; in API group \\&quot;\\&quot; in the namespace \\&quot;test\\&quot;&quot;, &quot;reason&quot;: &quot;Forbidden&quot;, &quot;details&quot;: &#123; &quot;name&quot;: &quot;sa-test-pod&quot;, &quot;kind&quot;: &quot;pods&quot; &#125;, &quot;code&quot;: 403&#125; 解决上述报错需要做授权： 12[root@centos07-12 rbactest]# kubectl create rolebinding sa-test-2 -n test --role=logs-reader --user=system:serviceaccount:test:sa-testrolebinding.rbac.authorization.k8s.io/sa-test-2 created 12345678910111213141516171819202122[root@centos07-12 rbactest]# kubectl exec -it sa-test-pod -n test -- /bin/bashroot@sa-test-pod:/# cd /var/run/secrets/kubernetes.io/serviceaccountroot@sa-test-pod:/var/run/secrets/kubernetes.io/serviceaccount# curl --cacert ./ca.crt -H &quot;Authorization: Bearer $(cat ./token)&quot; https://kubernetes.default/api/v1/namespaces/test/pods/sa-test-pod/log/docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration/docker-entrypoint.sh: Looking for shell scripts in /docker-entrypoint.d//docker-entrypoint.sh: Launching /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh10-listen-on-ipv6-by-default.sh: info: Getting the checksum of /etc/nginx/conf.d/default.conf10-listen-on-ipv6-by-default.sh: info: Enabled listen on IPv6 in /etc/nginx/conf.d/default.conf/docker-entrypoint.sh: Sourcing /docker-entrypoint.d/15-local-resolvers.envsh/docker-entrypoint.sh: Launching /docker-entrypoint.d/20-envsubst-on-templates.sh/docker-entrypoint.sh: Launching /docker-entrypoint.d/30-tune-worker-processes.sh/docker-entrypoint.sh: Configuration complete; ready for start up2023/12/20 15:32:55 [notice] 1#1: using the &quot;epoll&quot; event method2023/12/20 15:32:55 [notice] 1#1: nginx/1.25.32023/12/20 15:32:55 [notice] 1#1: built by gcc 12.2.0 (Debian 12.2.0-14)2023/12/20 15:32:55 [notice] 1#1: OS: Linux 3.10.0-1160.102.1.el7.x86_642023/12/20 15:32:55 [notice] 1#1: getrlimit(RLIMIT_NOFILE): 1048576:10485762023/12/20 15:32:55 [notice] 1#1: start worker processes2023/12/20 15:32:55 [notice] 1#1: start worker process 282023/12/20 15:32:55 [notice] 1#1: start worker process 292023/12/20 15:32:55 [notice] 1#1: start worker process 302023/12/20 15:32:55 [notice] 1#1: start worker process 31 资源还可以通过名称（ResourceName）进行引用，在指定ResourceName后，使用get、delete、update、patch请求，就会被限制在这个资源实例范围内例如，下面的声明让一个主体只能对名为my-configmap的Configmap进行get和update操作： 12345678910apiVersion: rabc.authorization.k8s.io/v1kind: Rolemetadata: namaspace: default name: configmap-updaterules:- apiGroups: [&quot;&quot;] resources: [&quot;configmaps&quot;] resourceNames: [&quot;my-configmap&quot;] verbs: [&quot;get&quot;,&quot;update&quot;] 查看role信息 12345678910111213[root@centos07-12 rbactest]# kubectl get roles -n testNAME CREATED ATlogs-reader 2023-12-20T15:30:15Z[root@centos07-12 rbactest]# kubectl describe roles -n test logs-readerName: logs-readerLabels: &lt;none&gt;Annotations: &lt;none&gt;PolicyRule: Resources Non-Resource URLs Resource Names Verbs --------- ----------------- -------------- ----- pods/log [] [] [get list watch] pods [] [] [get list watch] 查看rolebinding信息 12345678910111213141516[root@centos07-12 rbactest]# kubectl get rolebindings -n testNAME ROLE AGEsa-test-1 Role/logs-reader 12hsa-test-2 Role/logs-reader 11h[root@centos07-12 rbactest]# kubectl describe rolebindings sa-test-1 -n testName: sa-test-1Labels: &lt;none&gt;Annotations: &lt;none&gt;Role: Kind: Role Name: logs-readerSubjects: Kind Name Namespace ---- ---- --------- ServiceAccount sa-test test 6 常见角色(role)授权的案例（1）允许读取核心API组的Pod资源 1234rules:- apiGroups: [&quot;&quot;] # 空着就是所有的组 resources: [&quot;pods&quot;] # 所有的pod读取 verbs: [&quot;get&quot;,&quot;list&quot;,&quot;watch&quot;] （2）允许读写apps API组中的deployment资源 1234rules:- apiGroups: [&quot;apps&quot;] # 只能对apps组下的，deployment操作 resources: [&quot;deployments&quot;] verbs: [&quot;get&quot;,&quot;list&quot;,&quot;watch&quot;,&quot;create&quot;,&quot;update&quot;,&quot;patch&quot;,&quot;delete&quot;] （3）允许读取Pod以及读写job信息 1234567rules:- apiGroups: [&quot;&quot;] resources: [&quot;pods&quot;] verbs: [&quot;get&quot;,&quot;list&quot;,&quot;watch&quot;]- apiGroups: [&quot;&quot;] resources: [&quot;jobs&quot;] verbs: [&quot;get&quot;,&quot;list&quot;,&quot;watch&quot;,&quot;create&quot;,&quot;update&quot;,&quot;patch&quot;,&quot;delete&quot;] （4）允许读取一个名为my-config的ConfigMap（必须绑定到一个RoleBinding来限制到一个Namespace下的ConfigMap）： 12345rules:- apiGroups: [&quot;&quot;] resources: [&quot;configmaps&quot;] resourceNames: [&quot;my-configmap&quot;] verbs: [&quot;get&quot;] （5）读取核心组的Node资源（Node属于集群级的资源，所以必须存在于ClusterRole中，并使用ClusterRoleBinding进行绑定）： 1234rules:- apiGroups: [&quot;&quot;] resources: [&quot;nodes&quot;] verbs: [&quot;get&quot;,&quot;list&quot;,&quot;watch&quot;] （6）允许对非资源端点“&#x2F;healthz”及其所有子路径进行GET和POST操作（必须使用ClusterRole和ClusterRoleBinding）： 123rules:- nonResourceURLs: [&quot;/healthz&quot;,&quot;/healthz/*&quot;] verbs: [&quot;get&quot;,&quot;post&quot;] 7 常见的角色绑定示例（1）用户名alice 1234subjects:- kind: User name: alice apiGroup: rbac.authorization.k8s.io （2）组名alice 1234subjects:- kind: Group name: alice apiGroup: rbac.authorization.k8s.io （3）kube-system命名空间中默认Service Account 1234subjects:- kind: ServiceAccount name: default namespace: kube-system 8 对Service Account的授权管理Service Account也是一种账号，是给运行在Pod里的进程提供了必要的身份证明。需要在Pod定义中指明引用的Service Account，这样就可以对Pod的进行赋权操作。例如：pod内可获取rbac命名空间的所有Pod资源，pod-reader-sc的Service Account是绑定了名为pod-read的Role 12[root@centos07-12 rbactest]# kubectl create ns rbacnamespace/rbac created 12[root@centos07-12 rbactest]# kubectl create sa pod-reader-sc -n rbacserviceaccount/pod-reader-sc created 1234[root@centos07-12 rbactest]# kubectl get sa -n rbacNAME SECRETS AGEdefault 0 17spod-reader-sc 0 9s 123456789101112131415#cat pod-rbac.yamlapiVersion: v1kind: Podmetadata: name: nginx namespace: rbacspec: serviceAccountName: pod-reader-sc containers: - name: nginx image: docker.io/library/nginx:latest imagePullPolicy: IfNotPresent ports: - containerPort: 80 12[root@centos07-12 rbactest]# kubectl apply -f pod-rbac.yamlpod/nginx created 123[root@centos07-12 rbactest]# kubectl get pods -n rbacNAME READY STATUS RESTARTS AGEnginx 1/1 Running 0 16s （1）my-namespace中的my-sa Service Account授予只读权限, clusterrole：view是系统自动的kubectl create rolebinding my-sa-view –clusterrole&#x3D;view –serviceaccount&#x3D;my-namespace:my-sa –namespace&#x3D;my-namespace （2）为一个命名空间中名为default的Service Account授权如果一个应用没有指定 serviceAccountName，则会使用名为default的Service Account。注意，赋予Service Account “default”的权限会让所有没有指定serviceAccountName的Pod都具有这些权限 例如，在my-namespace命名空间中为Service Account“default”授予只读权限：kubectl create rolebinding default-view –clusterrole&#x3D;view –serviceaccount&#x3D;my-namespace:default –namespace&#x3D;my-namespace （3）为命名空间中所有Service Account都授予一个角色如果希望在一个命名空间中，任何Service Account应用都具有一个角色，则可以为这一命名空间的Service Account群组进行授权 kubectl create rolebinding serviceaccounts-view –clusterrole&#x3D;view –group&#x3D;system:serviceaccounts:my-namespace –namespace&#x3D;my-namespace （4）为集群范围内所有Service Account都授予一个低权限角色如果不想为每个命名空间管理授权，则可以把一个集群级别的角色赋给所有Service Account。 kubectl create clusterrolebinding serviceaccounts-view –clusterrole&#x3D;view –group&#x3D;system:serviceaccounts （5）为所有Service Account授予超级用户权限kubectl create clusterrolebinding serviceaccounts-view –clusterrole&#x3D;cluster-admin –group&#x3D;system:serviceaccounts 9 使用kubectl命令行工具创建资源对象（1）在命名空间rbac中为用户es授权admin ClusterRole：kubectl create rolebinding bob-admin-binding –clusterrole&#x3D;admin –user&#x3D;es –namespace&#x3D;rbac （2）在命名空间rbac中为名为myapp的Service Account授予view ClusterRole：kubctl create rolebinding myapp-role-binding –clusterrole&#x3D;view –serviceaccount&#x3D;rbac:myapp –namespace&#x3D;rbac （3）在全集群范围内为用户root授予cluster-admin ClusterRole：kubectl create clusterrolebinding cluster-binding –clusterrole&#x3D;cluster-admin –user&#x3D;root （4）在全集群范围内为名为myapp的Service Account授予view ClusterRole：kubectl create clusterrolebinding service-account-binding –clusterrole&#x3D;view –serviceaccount&#x3D;myapp yaml文件进行rbac授权：https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/ 10 限制不同的用户操作k8s集群查看下k8s当前用户环境 12[root@centos07-12 rbactest]# kubectl config current-contextkubernetes-admin@kubernetes 10.1 ssl认证生成一个证书（1）生成一个私钥 12345678910[root@centos07-12 pki]# cd /etc/kubernetes/pki/[root@centos07-12 pki]# (umask 077; openssl genrsa -out dbbruce.key 2048)Generating RSA private key, 2048 bit long modulus...+++...................+++e is 65537 (0x10001)[root@centos07-12 pki]# ls |grep dbbrucedbbruce.key （2）生成一个证书请求 1234[root@centos07-12 pki]# openssl req -new -key dbbruce.key -out dbbruce.csr -subj &quot;/CN=dbbruce&quot;[root@centos07-12 pki]# ls |grep dbbrucedbbruce.csrdbbruce.key （3）生成一个证书，表示dbbruce用户被apiserver信任了，可以访问apiserver，但是没有权限 123456789[root@centos07-12 pki]# openssl x509 -req -in dbbruce.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out dbbruce.crt -days 3650Signature oksubject=/CN=dbbruceGetting CA Private Key[root@centos07-12 pki]# ls |grep dbbrucedbbruce.crtdbbruce.csrdbbruce.key 10.2 在kubeconfig下新增加一个dbbruce这个用户（0）先备份下文件 1234567[root@centos07-12 pki]# cp /root/.kube/config /root/.kube/configbak[root@centos07-12 pki]# ll /root/.kube/总用量 24drwxr-x--- 4 root root 35 12月 3 16:28 cache-rw------- 1 root root 9172 12月 21 12:27 config-rw------- 1 root root 9172 12月 21 12:31 configbak （1）把dbbruce这个用户添加到kubernetes集群中，可以用来认证apiserver的连接先查看下用户信息，只有一个kubernetes-admin 12345678910111213141516171819[root@centos07-12 .kube]# kubectl config viewapiVersion: v1clusters:- cluster: certificate-authority-data: DATA+OMITTED server: https://192.168.1.12:6443 name: kubernetescontexts:- context: cluster: kubernetes user: kubernetes-admin name: kubernetes-admin@kubernetescurrent-context: kubernetes-admin@kuberneteskind: Configpreferences: &#123;&#125;- name: kubernetes-admin # 只有个用户 user: client-certificate-data: DATA+OMITTED client-key-data: DATA+OMITTED 新增用户dbbruce 12[root@centos07-12 pki]# kubectl config set-credentials dbbruce --client-certificate=./dbbruce.crt --client-key=./dbbruce.key --embed-certs=trueUser &quot;dbbruce&quot; set. 123456789101112131415161718192021222324[root@centos07-12 .kube]# kubectl config viewapiVersion: v1clusters:- cluster: certificate-authority-data: DATA+OMITTED server: https://192.168.1.12:6443 name: kubernetes # 集群名称下面会用到contexts:- context: cluster: kubernetes user: kubernetes-admin name: kubernetes-admin@kubernetescurrent-context: kubernetes-admin@kuberneteskind: Configpreferences: &#123;&#125;users:- name: dbbruce # 新增用户dbbruce user: client-certificate-data: DATA+OMITTED client-key-data: DATA+OMITTED- name: kubernetes-admin user: client-certificate-data: DATA+OMITTED ###证书 client-key-data: DATA+OMITTED ###key （2）在kubeconfig下新增加一个dbbruce这个账号 kubectl config set-context dbbruce@kubernetes –cluster&#x3D;集群名称，（config view能看到 ）–user&#x3D;dbbruce 12[root@centos07-12 .kube]# kubectl config set-context dbbruce@kubernetes --cluster=kubernetes --user=dbbruceContext &quot;dbbruce@kubernetes&quot; created. 12345678910111213141516171819202122232425262728[root@centos07-12 .kube]# kubectl config viewapiVersion: v1clusters:- cluster: certificate-authority-data: DATA+OMITTED server: https://192.168.1.12:6443 name: kubernetescontexts:- context: # 多了个上下文，环境 cluster: kubernetes user: dbbruce name: dbbruce@kubernetes # 多了- context: cluster: kubernetes user: kubernetes-admin name: kubernetes-admin@kubernetescurrent-context: kubernetes-admin@kuberneteskind: Configpreferences: &#123;&#125;users:- name: dbbruce user: client-certificate-data: DATA+OMITTED client-key-data: DATA+OMITTED- name: kubernetes-admin user: client-certificate-data: DATA+OMITTED client-key-data: DATA+OMITTED （3）切换账号到dbbruce，默认没有任何权限 kubectl config view &gt;&gt;&gt;&gt;&gt; current-context: kubernetes-admin@kubernetes 1234567891011121314151617181920212223242526272829303132[root@centos07-12 .kube]# kubectl config use-context dbbruce@kubernetesSwitched to context &quot;dbbruce@kubernetes&quot;.[root@centos07-12 .kube]# kubectl config viewapiVersion: v1clusters:- cluster: certificate-authority-data: DATA+OMITTED server: https://192.168.1.12:6443 name: kubernetescontexts:- context: cluster: kubernetes user: dbbruce name: dbbruce@kubernetes- context: cluster: kubernetes user: kubernetes-admin name: kubernetes-admin@kubernetescurrent-context: dbbruce@kubernetes ### 当前用户变为dbbrucekind: Configpreferences: &#123;&#125;users:- name: dbbruce user: client-certificate-data: DATA+OMITTED client-key-data: DATA+OMITTED- name: kubernetes-admin user: client-certificate-data: DATA+OMITTED client-key-data: DATA+OMITTED 没有权限 12[root@centos07-12 .kube]# kubectl get podsError from server (Forbidden): pods is forbidden: User &quot;dbbruce&quot; cannot list resource &quot;pods&quot; in API group &quot;&quot; in the namespace &quot;default&quot; （4）切换账号到admin 123456789101112[root@centos07-12 .kube]# kubectl config use-context kubernetes-admin@kubernetesSwitched to context &quot;kubernetes-admin@kubernetes&quot;.[root@centos07-12 .kube]# kubectl get podsNAME READY STATUS RESTARTS AGEmysql-pod 0/1 Completed 0 23hmysql-pod-envfrom 0/1 Completed 0 22hmysql-pod-volume 0/1 Completed 0 22hnfs-provisioner-77467f5d6d-lmprs 1/1 Running 0 6d16hpod-secret 1/1 Running 0 17hpod-secret-volume 1/1 Running 0 17hsa-test 1/1 Running 0 14h 10.3 把user这个用户通过rolebinding绑定到clusterrole上，授予权限,权限只是在dbbruce这个名称空间有效（1）把dbbruce这个用户通过rolebinding绑定到clusterrole上，命名空间为test 1234567891011[root@centos07-12 .kube]# kubectl get nsNAME STATUS AGEdefault Active 17dkube-node-lease Active 17dkube-public Active 17dkube-system Active 17dtest Active 13h[root@centos07-12 .kube]# kubectl get pods -n testNAME READY STATUS RESTARTS AGEsa-test-pod 1/1 Running 0 13h 12[root@centos07-12 .kube]# kubectl create rolebinding dbbruce -n test --clusterrole=cluster-admin --user=dbbrucerolebinding.rbac.authorization.k8s.io/dbbruce created （2）切换到dbbruce这个用户 12[root@centos07-12 .kube]# kubectl config use-context dbbruce@kubernetesSwitched to context &quot;dbbruce@kubernetes&quot;. （3）测试是否有权限 12345678[root@centos07-12 .kube]# kubectl get pods -n test ### test命名空间有权限NAME READY STATUS RESTARTS AGEsa-test-pod 1/1 Running 0 13h[root@centos07-12 .kube]# kubectl get pods ### default命名空间没有权限Error from server (Forbidden): pods is forbidden: User &quot;dbbruce&quot; cannot list resource &quot;pods&quot; in API group &quot;&quot; in the namespace &quot;default&quot;[root@centos07-12 .kube]# kubectl get pods -n testNAME READY STATUS RESTARTS AGEsa-test-pod 1/1 Running 0 13h 有权限操作test这个名称空间 10.4 添加一个test的普通用户123456789101112[root@centos07-12 .kube]# cp -ar /root/.kube/ /tmp/[root@centos07-12 .kube]# ll -al /tmp/总用量 0drwxrwxrwt. 8 root root 106 12月 21 12:50 .dr-xr-xr-x. 19 root root 268 12月 13 13:48 ..drwxrwxrwt. 2 root root 6 8月 14 14:59 .font-unixdrwxrwxrwt. 2 root root 6 8月 14 14:59 .ICE-unixdrwxr-xr-x 3 root root 50 12月 21 12:47 .kubedrwxrwxrwt. 2 root root 6 8月 14 14:59 .Test-unixdrwxrwxrwt. 2 root root 6 8月 14 14:59 .X11-unixdrwxrwxrwt. 2 root root 6 8月 14 14:59 .XIM-unix 1[root@centos07-12 .kube]# useradd test 修改&#x2F;tmp&#x2F;.kube&#x2F;config文件，把kubernetes-admin相关的删除，只留dbbruce用户 注意千万不要修改&#x2F;root&#x2F;.kube&#x2F;config 1[root@centos07-12 pki]# vim /tmp/.kube/config 修改后的k8s配置文件，给test用户使用，只允许操作test命名空间pod 1234567891011121314[root@centos07-12 test]# cp -ar /tmp/.kube/ /home/test/[root@centos07-12 test]# ls -al总用量 12drwx------ 3 test test 75 12月 21 13:01 .drwxr-xr-x. 4 root root 30 12月 21 12:55 ..-rw-r--r-- 1 test test 18 11月 25 2021 .bash_logout-rw-r--r-- 1 test test 193 11月 25 2021 .bash_profile-rw-r--r-- 1 test test 231 11月 25 2021 .bashrcdrwxr-xr-x 3 root root 50 12月 21 12:59 .kube[root@centos07-12 test]# chown -R test.test /home/test/[root@centos07-12 test]# su - test # 这间有个杠 测试test用户权限，default命名空间无权限，test命名空间有权限 123456[test@centos07-12 ~]$ kubectl get podsError from server (Forbidden): pods is forbidden: User &quot;dbbruce&quot; cannot list resource &quot;pods&quot; in API group &quot;&quot; in the namespace &quot;default&quot;[test@centos07-12 ~]$ kubectl get pods -n testNAME READY STATUS RESTARTS AGEsa-test-pod 1/1 Running 0 13h 退出test用户，需要在把集群环境切换成管理员权限 12345678910111213141516171819202122232425262728293031[root@centos07-12 ~]# kubectl config use-context kubernetes-admin@kubernetesSwitched to context &quot;kubernetes-admin@kubernetes&quot;.[root@centos07-12 ~]# kubectl config viewapiVersion: v1clusters:- cluster: certificate-authority-data: DATA+OMITTED server: https://192.168.1.12:6443 name: kubernetescontexts:- context: cluster: kubernetes user: dbbruce name: dbbruce@kubernetes- context: cluster: kubernetes user: kubernetes-admin name: kubernetes-admin@kubernetescurrent-context: kubernetes-admin@kuberneteskind: Configpreferences: &#123;&#125;users:- name: dbbruce user: client-certificate-data: DATA+OMITTED client-key-data: DATA+OMITTED- name: kubernetes-admin user: client-certificate-data: DATA+OMITTED client-key-data: DATA+OMITTED 10.5 授权kubectl用户能查看所有名称空间的pod的权限ssl认证生成一个证书（1）生成一个私钥 1234567[root@centos07-12 ~]# cd /etc/kubernetes/pki/[root@centos07-12 pki]# (umask 077; openssl genrsa -out dbbruce1.key 2048)Generating RSA private key, 2048 bit long modulus......................................................................................................+++..............................................................................+++e is 65537 (0x10001) （2）生成一个证书请求 1[root@centos07-12 pki]# openssl req -new -key dbbruce1.key -out dbbruce1.csr -subj &quot;/CN=dbbruce66&quot; （3）生成一个证书 1234[root@centos07-12 pki]# openssl x509 -req -in dbbruce1.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out dbbruce1.crt -days 3650Signature oksubject=/CN=dbbruce66Getting CA Private Key 在kubeconfig下新增加一个dbbruce66这个用户（1）把dbbruce66这个用户添加到kubernetes集群中，可以用来认证apiserver的连接 12[root@centos07-12 pki]# kubectl config set-credentials dbbruce66 --client-certificate=./dbbruce1.crt --client-key=./dbbruce1.key --embed-certs=trueUser &quot;dbbruce66&quot; set. （2）在kubeconfig下新增加一个dbbruce66这个账号 12[root@centos07-12 pki]# kubectl config set-context dbbruce66@kubernetes --cluster=kubernetes --user=dbbruce66Context &quot;dbbruce66@kubernetes&quot; created. (3)创建一个clusterrole 12345678910# vim dbbruce66-clusterrole.yamlapiVersion: rbac.authorization.k8s.io/v1kind: ClusterRolemetadata: name: dbbruce66-get-podrules:- apiGroups: [&quot;&quot;] resources: [&quot;pods&quot;] verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;] 12[root@centos07-12 rbactest]# kubectl apply -f dbbruce66-clusterrole.yamlclusterrole.rbac.authorization.k8s.io/dbbruce66-get-pod created 12[root@centos07-12 rbactest]# kubectl get clusterrole |grep dbbruce66dbbruce66-get-pod 2023-12-21T05:19:26Z （4）创建一个clusterrolebinding，所有命名空间有读的权限，不加指定命名空间，就是全部命名空间 12[root@centos07-12 rbactest]# kubectl create clusterrolebinding dbbruce66-get-pods --clusterrole=dbbruce66-get-pod --user=dbbruce66clusterrolebinding.rbac.authorization.k8s.io/dbbruce66-get-pods created 123456789101112131415161718192021222324252627282930313233343536[root@centos07-12 rbactest]# kubectl config viewapiVersion: v1clusters:- cluster: certificate-authority-data: DATA+OMITTED server: https://192.168.1.12:6443 name: kubernetescontexts:- context: #### 新增dbbruce66 的上下文 cluster: kubernetes user: dbbruce66 name: dbbruce66@kubernetes- context: cluster: kubernetes user: dbbruce name: dbbruce@kubernetes- context: cluster: kubernetes user: kubernetes-admin name: kubernetes-admin@kubernetescurrent-context: kubernetes-admin@kuberneteskind: Configpreferences: &#123;&#125;users:- name: dbbruce user: client-certificate-data: DATA+OMITTED client-key-data: DATA+OMITTED- name: dbbruce66 #### 新增dbbruce66的用户 user: client-certificate-data: DATA+OMITTED client-key-data: DATA+OMITTED- name: kubernetes-admin user: client-certificate-data: DATA+OMITTED client-key-data: DATA+OMITTED 添加一个test66的普通用户 12345[root@centos07-12 rbactest]# useradd test66[root@centos07-12 rbactest]# rm -rf /tmp/.kube[root@centos07-12 rbactest]# cp -ar /root/.kube /tmp/ 修改&#x2F;tmp&#x2F;.kube&#x2F;config文件，把kubernetes-admin和dbbruce相关的删除，只留dbbruce66用户 1[root@centos07-12 rbactest]# vim /tmp/.kube/config 12345678910111213141516171819[root@centos07-12 rbactest]# cp -ar /tmp/.kube/ /home/test66/[root@centos07-12 rbactest]# chown -R test66.test66 /home/test66/[root@centos07-12 rbactest]# su - test66[test66@centos07-12 ~]$ kubectl get podsNAME READY STATUS RESTARTS AGEmysql-pod 0/1 Completed 0 23hmysql-pod-envfrom 0/1 Completed 0 23hmysql-pod-volume 0/1 Completed 0 23hnfs-provisioner-77467f5d6d-lmprs 1/1 Running 0 6d17hpod-secret 1/1 Running 0 18hpod-secret-volume 1/1 Running 0 18hsa-test 1/1 Running 0 14h[test66@centos07-12 ~]$ kubectl get pods -n testNAME READY STATUS RESTARTS AGEsa-test-pod 1/1 Running 0 14h 无法删除，dbbruce66只有全部命名空间的读权限 123[test66@centos07-12 ~]$ kubectl delete pods sa-testError from server (Forbidden): pods &quot;sa-test&quot; is forbidden: User &quot;dbbruce66&quot; cannot delete resource &quot;pods&quot; in API group &quot;&quot; in the namespace &quot;default&quot;[test66@centos07-12 ~]$ 11 准入控制11.1 ResourceQuota准入控制器ResourceQuota准入控制器是k8s上内置的准入控制器，默认该控制器是启用的状态，它主要作用是用来限制一个名称空间下的资源的使用，它能防止在一个名称空间下的pod被过多创建时，导致过多占用k8s资源，简单讲它是用来在名称空间级别限制用户的资源使用。 1、限制cpu、内存、pod、deployment数量 1.1、创建resourcequota资源12[root@centos07-12 rbactest]# kubectl create ns quotanamespace/quota created 12345678910111213141516# cat resourcequota-1.yaml apiVersion: v1kind: ResourceQuotametadata: name: quota-test namespace: quotaspec: hard: pods: &quot;6&quot; # 最多创建6个pod requests.cpu: &quot;2&quot; requests.memory: 2Gi limits.cpu: &quot;4&quot; limits.memory: 10Gi count/deployments.apps: &quot;6&quot; persistentvolumeclaims: &quot;6&quot; 以上配置清单表示，在quota名称空间下运行的pod数量不能超过6个，所有pod的cpu资源下限总和不能大于2个核心，内存资源下限总和不能大于2G，cpu上限资源总和不能大于4个核心，内存上限总和不能超过10G，apps群组下的deployments控制器不能超过6个， pvc个数不能超过6个；以上条件中任意一个条目不满足，都将无法在对应名称空间创建对应的资源。 12[root@centos07-12 rbactest]# kubectl apply -f resourcequota-1.yamlresourcequota/quota-test created 123[root@centos07-12 rbactest]# kubectl get resourcequota -n quota -owideNAME AGE REQUEST LIMITquota-test 66m count/deployments.apps: 0/6, persistentvolumeclaims: 0/6, pods: 0/6, requests.cpu: 0/2, requests.memory: 0/2Gi limits.cpu: 0/4, limits.memory: 0/10Gi 123456789101112[root@centos07-12 rbactest]# kubectl describe quota -n quotaName: quota-testNamespace: quotaResource Used Hard-------- ---- ----count/deployments.apps 1 6 # deployments限制6个limits.cpu 0 4 # 4核cpulimits.memory 0 10Gi # 内存10Gpersistentvolumeclaims 0 6 # pvc 6个pods 0 6 # pods6个requests.cpu 0 2 # request cpu 2requests.memory 0 2Gi # request memory 2G 1.2、创建pod进行测试12345678910111213141516171819202122232425262728293031# vim deploy-demo.yamlapiVersion: apps/v1kind: Deploymentmetadata: name: quota namespace: quotaspec: replicas: 7 # 创建7个，超出quota的限制6 selector: matchLabels: app: quota template: metadata: labels: app: quota spec: containers: - name: myapp image: docker.io/ikubernetes/myapp:v2 imagePullPolicy: IfNotPresent ports: - containerPort: 80 resources: requests: cpu: 1 memory: 1Gi limits: cpu: 2 memory: 2Gi 12[root@centos07-12 rbactest]# kubectl apply -f deploy-demo.yamldeployment.apps/quota configured 这里为什么创建2个pods，因为quota现在最多2个requets，pod每个设置1个request，只能创建2个pod1234[root@centos07-12 rbactest]# kubectl get pods -n quotaNAME READY STATUS RESTARTS AGEquota-5b5dddd5bb-lnr4h 1/1 Running 0 16squota-5b5dddd5bb-v72xl 1/1 Running 0 16s 2、限制存储空间大小12345678910111213# vim resourcequota-2.yaml apiVersion: v1kind: ResourceQuotametadata: name: quota-storage-test namespace: quotaspec: hard: requests.storage: &quot;5Gi&quot; persistentvolumeclaims: &quot;5&quot; requests.ephemeral-storage: &quot;1Gi&quot; limits.ephemeral-storage: &quot;2Gi&quot; 12[root@centos07-12 rbactest]# kubectl apply -f resourcequota-2.yamlresourcequota/quota-storage-test created 1234[root@centos07-12 rbactest]# kubectl get ResourceQuota -n quotaNAME AGE REQUEST LIMITquota-storage-test 4s persistentvolumeclaims: 0/5, requests.ephemeral-storage: 0/1Gi, requests.storage: 0/5Gi limits.ephemeral-storage: 0/2Giquota-test 6h2m count/deployments.apps: 1/6, persistentvolumeclaims: 0/6, pods: 2/6, requests.cpu: 2/2, requests.memory: 2Gi/2Gi limits.cpu: 4/4, limits.memory: 4Gi/10Gi 简写resourcequota &#x3D; quota12345[root@centos07-12 rbactest]# kubectl get quota -n quotaNAME AGE REQUEST LIMITquota-storage-test 6s persistentvolumeclaims: 0/5, requests.ephemeral-storage: 0/1Gi, requests.storage: 0/5Gi limits.ephemeral-storage: 0/2Giquota-test 6h2m count/deployments.apps: 1/6, persistentvolumeclaims: 0/6, pods: 2/6, requests.cpu: 2/2, requests.memory: 2Gi/2Gi limits.cpu: 4/4, limits.memory: 4Gi/10Gi[root@centos07-12 rbactest]# 备注：requests.storage用来限制对应名称空间下的存储下限总和persistenvolumeclaims用来限制pvc总数量requests.ephemeral-storage用来现在使用本地临时存储的下限总容量limits.ephemeral-storage用来限制使用本地临时存储上限总容量；以上配置表示在default名称空间下非停止状态的容器存储下限总容量不能超过5G，pvc的数量不能超过5个，本地临时存储下限容量不能超过1G，上限不能超过2G。 11.2 LimitRanger准入控制器LimitRanger准入控制器是k8s上一个内置的准入控制器，LimitRange是k8s上的一个标准资源，它主要用来定义在某个名称空间下限制pod或pod里的容器对k8s上的cpu和内存资源使用；它能够定义我们在某个名称空间下创建pod时使用的cpu和内存的上限和下限以及默认cpu、内存的上下限。 如果我们创建pod时定义了资源上下限，但不满足LimitRange规则中定义的资源上下限，此时LimitRanger就会拒绝我们创建此pod；如果我们在LimitRange规则中定义了默认的资源上下限制，我们创建资源没有指定其资源限制，它默认会使用LimitRange规则中的默认资源限制；同样的逻辑LimitRanger可以限制一个pod使用资源的上下限，它还可以限制pod中的容器的资源上下限，比限制pod更加精准；不管是针对pod还是pod里的容器，它始终只是限制单个pod资源使用。 123456789101112131415161718192021222324252627282930# cat limitrange.yaml apiVersion: v1kind: Namespacemetadata: name: limit---apiVersion: v1kind: LimitRangemetadata: name: cpu-memory namespace: limitspec: limits: - default: # 不指定pod的limits资源时，默认就是default的值，现在limits cpu: 1000m memory: 1000Mi defaultRequest: # 不指定pod的requests资源时, 默认使用 defaultRequest cpu: 500m memory: 500Mi min: # pod定义了limits，最小值 cpu: 500m memory: 500Mi max: # pod定义了limits，最大值 cpu: 2000m memory: 2000Mi maxLimitRequestRatio: # 比例，创建pod时，cpu上限是下限的4倍， memory上限是下限的4倍 cpu: 4 memory: 4 type: Container 备注：以上清单主要定义了两个资源，一个创建limit名称空间，一个是在对应limit名称空间下定义了LimitRange资源；其中LimitRange资源的名称为cpu-memory，default字段用来指定默认容器资源上限值；defaultRequest用来指定默认容器资源下限值；min字段用来指定限制用户指定的资源下限不能小于对应资源的值；max是用来限制用户指定资源上限值不能大于该值；maxLimitRequestRatio字段用来指定资源的上限和下限的比值；即上限是下限的多少倍；type是用来描述对应资源限制的级别，该字段有两个值pod和container。上述资源清单表示在该名称空间下创建pod时，默认不指定其容器的资源限制，就限制对应容器最少要有0.5个核心的cpu和500M的内存；最大为1个核心cpu,1g内存；如果我们手动定义了容器的资源限制，那么对应资源限制最小不能小于cpu为0.5个核心，内存为500M，最大不能超过cpu为2个核心，内存为2000M；如果我们在创建pod时，只指定了容器的资源上限或下限，那么上限最大是下限的的4倍，如果指定cpu上限为2000m那么下限一定不会小于500m，如果只指定了cpu下限为500m那么上限最大不会超过2000m，对于内存也是同样的逻辑。 123[root@centos07-12 rbactest]# kubectl apply -f limitrange.yamlnamespace/limit createdlimitrange/cpu-memory created 1 在limit名称空间创建pod，不指定资源，看看是否会被limitrange规则自动附加其资源限制？ 1234567891011121314# vim limitpods-demo.yamlapiVersion: v1kind: Podmetadata: name: nginx-pod-demo namespace: limitspec: containers: - name: nginx image: docker.io/library/nginx:latest imagePullPolicy: IfNotPresent ports: - containerPort: 80 12[root@centos07-12 rbactest]# kubectl apply -f limitpods-demo.yamlpod/nginx-pod-demo created 123[root@centos07-12 rbactest]# kubectl get pods -n limitNAME READY STATUS RESTARTS AGEnginx-pod-demo 1/1 Running 0 2m20s 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859[root@centos07-12 rbactest]# kubectl describe pods nginx-pod-demo -n limitName: nginx-pod-demoNamespace: limitPriority: 0Service Account: defaultNode: centos07-62/192.168.1.62Start Time: Thu, 21 Dec 2023 20:01:06 +0800Labels: &lt;none&gt;Annotations: cni.projectcalico.org/podIP: 10.244.250.231/32 cni.projectcalico.org/podIPs: 10.244.250.231/32 kubernetes.io/limit-ranger: LimitRanger plugin set: cpu, memory request for container nginx; cpu, memory limit for container nginxStatus: RunningIP: 10.244.250.231IPs: IP: 10.244.250.231Containers: nginx: Container ID: containerd://cee2451d0fa1dc99a5172dbe6566fb84284a9932955a39283d582d76fe041193 Image: docker.io/library/nginx:latest Image ID: sha256:f6d0b4767a6c466c178bf718f99bea0d3742b26679081e52dbf8e0c7c4c42d74 Port: 80/TCP Host Port: 0/TCP State: Running Started: Thu, 21 Dec 2023 20:01:07 +0800 Ready: True Restart Count: 0 Limits: cpu: 1 memory: 1000Mi Requests: cpu: 500m memory: 500Mi Environment: &lt;none&gt; Mounts: /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-wx84d (ro)Conditions: Type Status Initialized True Ready True ContainersReady True PodScheduled TrueVolumes: kube-api-access-wx84d: Type: Projected (a volume that contains injected data from multiple sources) TokenExpirationSeconds: 3607 ConfigMapName: kube-root-ca.crt ConfigMapOptional: &lt;nil&gt; DownwardAPI: trueQoS Class: BurstableNode-Selectors: &lt;none&gt;Tolerations: node.kubernetes.io/not-ready:NoExecute op=Exists for 300s node.kubernetes.io/unreachable:NoExecute op=Exists for 300sEvents: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 3m1s default-scheduler Successfully assigned limit/nginx-pod-demo to centos07-62 Normal Pulled 3m kubelet Container image &quot;docker.io/library/nginx:latest&quot; already present on machine Normal Created 3m kubelet Created container nginx Normal Started 3m kubelet Started container nginx 显示如下：通过上面结果可以看到我们在limit名称空间下创建的pod没有指定其容器资源限制，创建pod后，其内部容器自动就有了默认的资源限制；其大小就是我们在定义LimitRange规则中的default和defaultRequest字段中指定的资源限制。 2 创建pod，指定cpu请求是100m，看看是否允许创建 123456789101112131415# vim pod-request.yamlapiVersion: v1kind: Podmetadata: name: pod-request namespace: limitspec: containers: - image: nginx imagePullPolicy: IfNotPresent name: nginx resources: requests: cpu: 100m 12[root@centos07-12 rbactest]# kubectl apply -f pod-request.yamlError from server (Forbidden): error when creating &quot;pod-request.yaml&quot;: pods &quot;pod-request&quot; is forbidden: [minimum cpu usage per Container is 500m, but request is 100m, cpu max limit to request ratio per Container is 4, but provided ratio is 10.000000] 创建的pod cpu 100m,限制是pod最少500m，不符合限制，所有报错","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"28-K8S配置管理中心Secret实现加密数据配置管理","slug":"运维/K8S/基础/28-K8S配置管理中心Secret实现加密数据配置管理","date":"2023-05-14T02:00:00.000Z","updated":"2023-12-20T11:37:25.000Z","comments":true,"path":"2023/05/14/运维/K8S/基础/28-K8S配置管理中心Secret实现加密数据配置管理/","link":"","permalink":"https://dbbruce.github.io/2023/05/14/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/28-K8S%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E4%B8%AD%E5%BF%83Secret%E5%AE%9E%E7%8E%B0%E5%8A%A0%E5%AF%86%E6%95%B0%E6%8D%AE%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/","excerpt":"1.Secret概述1.1 Secret是什么？上面我们学习的Configmap一般是用来存放明文数据的，如配置文件，对于一些敏感数据，如密码、私钥等数据时，要用secret类型。Secret解决了密码、token、秘钥等敏感数据的配置问题，而不需要把这些敏感数据暴露到镜像或者Pod Spec中。Secret可以以Volume或者环境变量的方式使用。","text":"1.Secret概述1.1 Secret是什么？上面我们学习的Configmap一般是用来存放明文数据的，如配置文件，对于一些敏感数据，如密码、私钥等数据时，要用secret类型。Secret解决了密码、token、秘钥等敏感数据的配置问题，而不需要把这些敏感数据暴露到镜像或者Pod Spec中。Secret可以以Volume或者环境变量的方式使用。 1.2 要使用 secret，pod 需要引用 secret。Pod 可以用两种方式使用 secret：作为 volume 中的文件被挂载到 pod 中的一个或者多个容器里当 kubelet 为 pod 拉取镜像时使用。 1.3 secret可选参数有三种:generic: 通用类型，通常用于存储密码数据。tls：此类型仅用于存储私钥和证书。docker-registry: 若要保存docker仓库的认证信息的话，就必须使用此种类型来创建。 1.4 Secret类型，有三种：Service Account：用于被 serviceaccount 引用。serviceaccout 创建时 Kubernetes 会默认创建对应的 secret。Pod 如果使用了 serviceaccount，对应的 secret 会自动挂载到 Pod 的 &#x2F;run&#x2F;secrets&#x2F;kubernetes.io&#x2F;serviceaccount 目录中。Opaque：base64编码格式的Secret，用来存储密码、秘钥等。可以通过base64 –decode解码获得原始数据，因此安全性弱kubernetes.io&#x2F;dockerconfigjson：用来存储私有docker registry的认证信息。 2.使用Secret2.1 通过环境变量引入Secret把mysql的root用户的password创建成secret 12[root@centos07-12 ~]# kubectl create secret generic mysql-password --from-literal=password=123456secret/mysql-password created 123[root@centos07-12 ~]# kubectl get secretNAME TYPE DATA AGEmysql-password Opaque 1 2s 1234567891011[root@centos07-12 ~]# kubectl describe secret mysql-passwordName: mysql-passwordNamespace: defaultLabels: &lt;none&gt;Annotations: &lt;none&gt;Type: OpaqueData====password: 6 bytes password的值是加密的，但secret的加密是一种伪加密，它仅仅是将数据做了base64的编码. 2.2 创建pod，引用secret123456789101112131415161718192021# cat pod-secret.yaml apiVersion: v1kind: Podmetadata: name: pod-secret labels: app: myappspec: containers: - name: myapp image: ikubernetes/myapp:v1 ports: - name: http containerPort: 80 env: - name: MYSQL_ROOT_PASSWORD #它是Pod启动成功后,Pod中容器的环境变量名. valueFrom: secretKeyRef: name: mysql-password #这是secret的对象名 key: password #它是secret中的key名 12[root@centos07-12 secrettest]# kubectl apply -f pod-secret.yamlpod/pod-secret created 123[root@centos07-12 secrettest]# kubectl get podsNAME READY STATUS RESTARTS AGEpod-secret 1/1 Running 0 2m 123[root@centos07-12 secrettest]# kubectl exec -it pod-secret -- /bin/sh/ # printenvMYSQL_ROOT_PASSWORD=123456 2.3 通过volume挂载Secret 1）创建Secret手动加密，基于base64加密echo -n 不显示换行1234[root@centos07-12 secrettest]# echo -n &#x27;admin&#x27; | base64YWRtaW4=[root@centos07-12 secrettest]# echo -n &#x27;dbbruce123456&#x27; | base64ZGJicnVjZTEyMzQ1Ng== 解码：12[root@centos07-12 secrettest]# echo ZGJicnVjZTEyMzQ1Ng== | base64 -ddbbruce123456 2）创建yaml文件12345678910# vim secret.yamlapiVersion: v1kind: Secretmetadata: name: mysecrettype: Opaquedata: username: YWRtaW4= password: ZGJicnVjZTEyMzQ1Ng== 12[root@centos07-12 secrettest]# kubectl apply -f secret.yamlsecret/mysecret created 1234[root@centos07-12 secrettest]# kubectl get secretNAME TYPE DATA AGEmysecret Opaque 2 19smysql-password Opaque 1 12m 123456789101112[root@centos07-12 secrettest]# kubectl describe secret mysecretName: mysecretNamespace: defaultLabels: &lt;none&gt;Annotations: &lt;none&gt;Type: OpaqueData====password: 13 bytesusername: 5 bytes 3）将Secret挂载到Volume中12345678910111213141516171819# vim pod_secret_volume.yamlapiVersion: v1kind: Podmetadata: name: pod-secret-volumespec: containers: - name: myapp image: docker.io/ikubernetes/myapp:v1 imagePullPolicy: IfNotPresent volumeMounts: - name: secret-volume mountPath: /etc/secret readOnly: true volumes: - name: secret-volume secret: secretName: mysecret 12[root@centos07-12 secrettest]# kubectl apply -f pod_secret_volume.yamlpod/pod-secret-volume created 123[root@centos07-12 secrettest]# kubectl get podsNAME READY STATUS RESTARTS AGEpod-secret-volume 1/1 Running 0 30s 12345678[root@centos07-12 secrettest]# kubectl exec -it pod-secret-volume -- /bin/sh/ # cd /etc/secret//etc/secret # lspassword username/etc/secret # cat usernameadmin/etc/secret # cat passworddbbruce123456 由上可见，在pod中的secret信息实际已经被解密。总结：secret的密码导入pod后，都会变成明文","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"27-K8S配置管理中心Configmap实现微服务配置管理","slug":"运维/K8S/基础/27-K8S配置管理中心Configmap实现微服务配置管理","date":"2023-05-13T12:00:00.000Z","updated":"2023-12-20T06:05:11.000Z","comments":true,"path":"2023/05/13/运维/K8S/基础/27-K8S配置管理中心Configmap实现微服务配置管理/","link":"","permalink":"https://dbbruce.github.io/2023/05/13/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/27-K8S%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E4%B8%AD%E5%BF%83Configmap%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/","excerpt":"1. Configmap概述1.1 什么是Configmap？Configmap是k8s中的资源对象，用于保存非机密性的配置的，数据可以用key&#x2F;value键值对的形式保存，也可通过文件的形式保存。","text":"1. Configmap概述1.1 什么是Configmap？Configmap是k8s中的资源对象，用于保存非机密性的配置的，数据可以用key&#x2F;value键值对的形式保存，也可通过文件的形式保存。 1.2 Configmap能解决哪些问题？我们在部署服务的时候，每个服务都有自己的配置文件，如果一台服务器上部署多个服务：nginx、tomcat、apache等，那么这些配置都存在这个节点上，假如一台服务器不能满足线上高并发的要求，需要对服务器扩容，扩容之后的服务器还是需要部署多个服务：nginx、tomcat、apache，新增加的服务器上还是要管理这些服务的配置，如果有一个服务出现问题，需要修改配置文件，每台物理节点上的配置都需要修改，这种方式肯定满足不了线上大批量的配置变更要求。 所以，k8s中引入了Configmap资源对象，可以当成volume挂载到pod中，实现统一的配置管理。1、Configmap是k8s中的资源， 相当于配置文件，可以有一个或者多个Configmap；2、Configmap可以做成Volume，k8s pod启动之后，通过 volume 形式映射到容器内部指定目录上；3、容器中应用程序按照原有方式读取容器特定目录上的配置文件。4、在容器看来，配置文件就像是打包在容器内部特定目录，整个过程对应用没有任何侵入。 1.3 Configmap应用场景1、使用k8s部署应用，当你将应用配置写进代码中，更新配置时也需要打包镜像，configmap可以将配置信息和docker镜像解耦，以便实现镜像的可移植性和可复用性，因为一个configMap其实就是一系列配置信息的集合，可直接注入到Pod中给容器使用。configmap注入方式有两种，一种将configMap做为存储卷，一种是将configMap通过env中configMapKeyRef注入到容器中。2、使用微服务架构的话，存在多个服务共用配置的情况，如果每个服务中单独一份配置的话，那么更新配置就很麻烦，使用configmap可以友好的进行配置共享。 1.4 局限性ConfigMap在设计上不是用来保存大量数据的。在ConfigMap中保存的数据不可超过1 MiB。如果你需要保存超出此尺寸限制的数据，可以考虑挂载存储卷或者使用独立的数据库或者文件服务。 2. Configmap创建方法2.1 命令行直接创建直接在命令行中指定configmap参数创建，通过–from-literal指定参数 1kubectl create configmap tomcat-config --from-literal=tomcat_port=8080 --from-literal=server_name=myapp.tomcat.com --from-literal=dbbruce=dxb 123[root@centos07-12 ~]# kubectl get configmapNAME DATA AGEtomcat-config 3 6s 12345678910111213141516171819202122[root@centos07-12 ~]# kubectl describe configmap tomcat-configName: tomcat-configNamespace: defaultLabels: &lt;none&gt;Annotations: &lt;none&gt;Data====tomcat_port: ### key ----8080 ### valuedbbruce: ----dxbserver_name:----myapp.tomcat.comBinaryData====Events: &lt;none&gt; 2.2 通过文件创建通过指定文件创建一个configmap，–from-file&#x3D;&lt;文件&gt; 123456# vim nginx.confserver &#123; server_name www.nginx.com; listen 80; root /home/nginx/www/&#125; 定义一个key是www，值是nginx.conf中的内容 12[root@centos07-12 configmaptest]# kubectl create configmap www-nginx --from-file=www=./nginx.confconfigmap/www-nginx created 123456789101112131415161718192021222324252627[root@centos07-12 configmaptest]# kubectl get cmNAME DATA AGEkube-root-ca.crt 1 16dtomcat-config 3 4m33swww-nginx 1 39s[root@centos07-12 configmaptest]# kubectl describe cm www-nginxName: www-nginxNamespace: defaultLabels: &lt;none&gt;Annotations: &lt;none&gt;Data====www:----server &#123; server_name www.nginx.com; listen 80; root /home/nginx/www&#125;BinaryData====Events: &lt;none&gt; 2.3 指定目录创建configmap12345678[root@centos07-12 configmaptest]# mkdir test-a[root@centos07-12 configmaptest]# cd test-a/[root@centos07-12 test-a]# ll[root@centos07-12 test-a]# vim my-slave.cnfserver-id=1[root@centos07-12 test-a]# vim my-slave.cnfserver-id=2 指定目录创建configmap 1234[root@centos07-12 test-a]# pwd/root/configmaptest/test-a[root@centos07-12 test-a]# kubectl create configmap mysql-config --from-file=/root/configmaptest/test-a/configmap/my-sql created 查看configmap详细信息 123456789101112131415161718192021222324252627[root@centos07-12 test-a]# kubectl get cmNAME DATA AGEmysql-config 2 11s[root@centos07-12 test-a]# kubectl describe cm mysql-configName: mysql-configNamespace: defaultLabels: &lt;none&gt;Annotations: &lt;none&gt;Data====my-server.cnf:----server-id=1my-slave.cnf:----server-id=2BinaryData====Events: &lt;none&gt; 2.4 编写configmap资源清单YAML文件 |竖线表示有很多行 1234567891011121314151617# cat mysql-configmap.yaml apiVersion: v1kind: ConfigMapmetadata: name: mysql labels: app: mysqldata: master.cnf: | [mysqld] # 第一行 log-bin # 第二行 log_bin_trust_function_creators=1 lower_case_table_names=1 slave.cnf: | [mysqld] super-read-only log_bin_trust_function_creators=1 1234567891011121314151617181920212223242526272829303132[root@centos07-12 configmaptest]# kubectl apply -f mysql-configmap.yamlconfigmap/mysql created[root@centos07-12 configmaptest]# kubectl get cmNAME DATA AGEmysql 2 2s[root@centos07-12 configmaptest]# kubectl describe cm mysqlName: mysqlNamespace: defaultLabels: app=mysqlAnnotations: &lt;none&gt;Data====master.cnf:----[mysqld]log-binlog_bin_trust_function_creators=1lower_case_table_names=1slave.cnf:----[mysqld]super-read-onlylog_bin_trust_function_creators=1BinaryData====Events: &lt;none&gt; 3. 使用Configmap3.1 通过环境变量引入：使用configMapKeyRef创建一个存储mysql配置的configmap 1234567891011# cat mysql-configmap2.yamlapiVersion: v1kind: ConfigMapmetadata: name: mysql labels: app: mysqldata: log: &quot;1&quot; lower: &quot;1&quot; 12[root@centos07-12 configmaptest]# kubectl apply -f mysql-configmap2.yamlconfigmap/mysql configured 创建pod，引用Configmap中的内容 1234567891011121314151617181920212223# cat mysql-pod.yaml apiVersion: v1kind: Podmetadata: name: mysql-podspec: containers: - name: mysql image: docker.io/library/busybox:1.28 imagePullPolicy: IfNotPresent command: [ &quot;/bin/sh&quot;, &quot;-c&quot;, &quot;sleep 3600&quot; ] env: - name: log_bin #定义环境变量log_bin valueFrom: configMapKeyRef: name: mysql #指定configmap的名字 key: log #指定configmap中的key - name: lower #定义环境变量lower valueFrom: configMapKeyRef: name: mysql key: lower restartPolicy: Never 解释下这块，pod定义环境变量，变量名: log_bin, 引入configmap，将configmap中名称为mysql中的，key为log的值，赋予给pod的环境变量log_bin简单来说就是：将configmap定义的变量log&#x3D;1，将值1服务给pod变量log_bin 123456env:- name: log_bin #定义环境变量log_bin valueFrom: configMapKeyRef: name: mysql #指定configmap的名字 key: log #指定configmap中的key 更新资源清单文件 12[root@centos07-12 configmaptest]# kubectl apply -f mysql-pod.yamlpod/mysql-pod created 123[root@centos07-12 configmaptest]# kubectl get podsNAME READY STATUS RESTARTS AGEmysql-pod 1/1 Running 0 19s 1234[root@centos07-12 configmaptest]# kubectl exec -it mysql-pod -- /bin/sh/ # printenvlog_bin=1lower=1 3.2 通过环境变量引入：使用envfrom12345678910111213141516# cat mysql-pod-envfrom.yaml apiVersion: v1kind: Podmetadata: name: mysql-pod-envfromspec: containers: - name: mysql image: busybox imagePullPolicy: IfNotPresent command: [ &quot;/bin/sh&quot;, &quot;-c&quot;, &quot;sleep 3600&quot; ] envFrom: - configMapRef: name: mysql #指定configmap的名字 restartPolicy: Never 更新资源清单文件 12[root@centos07-12 configmaptest]# kubectl apply -f mysql-pod-envfrom.yamlpod/mysql-pod-envfrom created 1234[root@centos07-12 configmaptest]# kubectl exec -it mysql-pod-envfrom -- /bin/sh/ # printenvlower=1log=1 3.3 把configmap做成volume，挂载到pod1234567891011121314# cat mysql-configmap3.yaml apiVersion: v1kind: ConfigMapmetadata: name: mysql3 labels: app: mysql3data: log: &quot;1&quot; lower: &quot;1&quot; my.cnf: | [mysqld] Welcome=dbbruce 12[root@centos07-12 configmaptest]# kubectl apply -f mysql-configmap3.yamlconfigmap/mysql3 created 12345678910111213141516171819# cat mysql-pod-volume.yaml apiVersion: v1kind: Podmetadata: name: mysql-pod-volumespec: containers: - name: mysql image: busybox command: [ &quot;/bin/sh&quot;,&quot;-c&quot;,&quot;sleep 3600&quot; ] volumeMounts: - name: mysql-config mountPath: /tmp/config volumes: - name: mysql-config configMap: name: mysql3 restartPolicy: Never 12[root@centos07-12 configmaptest]# kubectl apply -f mysql-pod-volume.yamlpod/mysql-pod-volume created 1234567[root@centos07-12 configmaptest]# kubectl exec -it mysql-pod-volume -- /bin/sh/ # cd /tmp/config//tmp/config # lslog lower my.cnf/tmp/config # cat my.cnf[mysqld]Welcome=dbbruce 4 Configmap热更新1234567[root@centos07-12 configmaptest]# kubectl edit configmap mysql3apiVersion: v1data: log: &quot;2&quot; # 把log: “1”变成log: “2” lower: &quot;1&quot;kind: ConfigMap 保存退出发现log值变成了2，更新生效了 123[root@centos07-12 configmaptest]# kubectl exec -it mysql-pod-volume -- /bin/sh/tmp/config # cat /tmp/config/log2 注意：更新 ConfigMap 后：使用该 ConfigMap 挂载的 Env 不会同步更新使用该 ConfigMap 挂载的 Volume 中的数据需要一段时间（实测大概10秒）才能同步更新","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"26-K8S控制器Daemonset入门到企业实战应用","slug":"运维/K8S/基础/26-K8S控制器Daemonset入门到企业实战应用","date":"2023-05-13T02:00:00.000Z","updated":"2023-12-20T06:05:11.000Z","comments":true,"path":"2023/05/13/运维/K8S/基础/26-K8S控制器Daemonset入门到企业实战应用/","link":"","permalink":"https://dbbruce.github.io/2023/05/13/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/26-K8S%E6%8E%A7%E5%88%B6%E5%99%A8Daemonset%E5%85%A5%E9%97%A8%E5%88%B0%E4%BC%81%E4%B8%9A%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8/","excerpt":"1 DaemonSet控制器：概念、原理解读1.1 DaemonSet概述DaemonSet控制器能够确保k8s集群所有的节点都运行一个相同的pod副本，当向k8s集群中增加node节点时，这个node节点也会自动创建一个pod副本，当node节点从集群移除，这些pod也会自动删除；删除Daemonset也会删除它们创建的pod","text":"1 DaemonSet控制器：概念、原理解读1.1 DaemonSet概述DaemonSet控制器能够确保k8s集群所有的节点都运行一个相同的pod副本，当向k8s集群中增加node节点时，这个node节点也会自动创建一个pod副本，当node节点从集群移除，这些pod也会自动删除；删除Daemonset也会删除它们创建的pod 1.2 DaemonSet工作原理：如何管理Pod？daemonset的控制器会监听kuberntes的daemonset对象、pod对象、node对象，这些被监听的对象之变动，就会触发syncLoop循环让kubernetes集群朝着daemonset对象描述的状态进行演进。 1.3 Daemonset典型的应用场景在集群的每个节点上运行存储，比如：glusterd 或 ceph。在每个节点上运行日志收集组件，比如：flunentd 、 logstash、filebeat等。在每个节点上运行监控组件，比如：Prometheus、 Node Exporter 、collectd等。 1.4 DaemonSet 与 Deployment 的区别Deployment 部署的副本 Pod 会分布在各个 Node 上，每个 Node 都可能运行好几个副本。DaemonSet 的不同之处在于：每个 Node 上最多只能运行一个副本。 2 DaemonSet资源清单文件编写技巧2.1 查看定义Daemonset资源需要的字段有哪些？12345678910111213# kubectl explain dsKIND: DaemonSetVERSION: apps/v1DESCRIPTION: DaemonSet represents the configuration of a daemon set.FIELDS: apiVersion &lt;string&gt; #当前资源使用的api版本，跟VERSION: apps/v1保持一致 kind &lt;string&gt; #资源类型，跟KIND: DaemonSet保持一致 metadata &lt;Object&gt; #元数据，定义DaemonSet名字的 spec &lt;Object&gt; #定义容器的 status &lt;Object&gt; #状态信息，不能改 2.2 查看DaemonSet的spec字段如何定义？123456789101112131415# kubectl explain ds.specKIND: DaemonSetVERSION: apps/v1RESOURCE: spec &lt;Object&gt;DESCRIPTION: The desired behavior of this daemon set. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status DaemonSetSpec is the specification of a daemon set.FIELDS: minReadySeconds &lt;integer&gt; #当新的pod启动几秒种后，再kill掉旧的pod。 revisionHistoryLimit &lt;integer&gt; #历史版本 selector &lt;Object&gt; -required- #用于匹配pod的标签选择器 template &lt;Object&gt; -required- #定义Pod的模板，基于这个模板定义的所有pod是一样的 updateStrategy &lt;Object&gt; #daemonset的升级策略 3.3 查看DaemonSet的spec.template字段如何定义？#对于template而言，其内部定义的就是pod，pod模板是一个独立的对象 1234567# kubectl explain ds.spec.templateKIND: DaemonSetVERSION: apps/v1RESOURCE: template &lt;Object&gt;FIELDS: metadata &lt;Object&gt; spec&lt;Object&gt; 3 DaemonSet使用案例：部署日志收集组件fluentd3.1 把fluentd-2-5-1.tar.gz上传到centos07-12&#x2F;22&#x2F;62上，解压特别注意：因为我们安装的k8s版本是1.25，那就需要按照文档步骤ctr -n&#x3D;k8s.io images import导出镜像，如果k8s版本是1.24之前的，可以用docker load -i解压，视频里用的docker load -i，现在我们课程安装更新到了k8s1.25，所以导出镜像需要用ctr -n&#x3D;k8s.io images import 123[root@centos07-12 ~]# ctr -n=k8s.io images import fluentd_2_5_1.tar.gz[root@centos07-22 ~]# ctr -n=k8s.io images import fluentd_2_5_1.tar.gz[root@centos07-62 ~]# ctr -n=k8s.io images import fluentd_2_5_1.tar.gz 123[root@centos07-62 ~]# crictl imagesIMAGE TAG IMAGE ID SIZEdocker.io/xianchao/fluentd v2.5.1 cf4ed11c3a092 148MB 3.2 编写一个DaemonSet资源清单容忍需要查看下master的污点信息 1234567891011121314151617[root@centos07-12 ~]# kubectl describe node centos07-12Name: centos07-12Roles: control-planeLabels: beta.kubernetes.io/arch=amd64 beta.kubernetes.io/os=linux kubernetes.io/arch=amd64 kubernetes.io/hostname=centos07-12 kubernetes.io/os=linux node-role.kubernetes.io/control-plane= node.kubernetes.io/exclude-from-external-load-balancers=Annotations: kubeadm.alpha.kubernetes.io/cri-socket: unix:///run/containerd/containerd.sock node.alpha.kubernetes.io/ttl: 0 projectcalico.org/IPv4Address: 192.168.1.12/24 projectcalico.org/IPv4IPIPTunnelAddr: 10.244.234.192 volumes.kubernetes.io/controller-managed-attach-detach: trueCreationTimestamp: Sun, 03 Dec 2023 16:16:58 +0800Taints: node-role.kubernetes.io/control-plane:NoSchedule #### 前面是key，后面策略，这里下面会看到 12345678910111213141516171819202122232425262728293031323334353637383940414243# cat daemonset.yaml apiVersion: apps/v1kind: DaemonSetmetadata: name: fluentd-elasticsearch namespace: kube-system labels: k8s-app: fluentd-loggingspec: selector: matchLabels: name: fluentd-elasticsearch template: metadata: labels: name: fluentd-elasticsearch spec: tolerations: - key: node-role.kubernetes.io/control-plane effect: NoSchedule containers: - name: fluentd-elasticsearch image: docker.io/xianchao/fluentd:v2.5.1 resources: limits: memory: 200Mi requests: cpu: 100m memory: 200Mi volumeMounts: - name: varlog mountPath: /var/log - name: varlibdockercontainers mountPath: /var/lib/docker/containers readOnly: true terminationGracePeriodSeconds: 30 volumes: - name: varlog hostPath: path: /var/log - name: varlibdockercontainers hostPath: path: /var/lib/docker/containers 1[root@centos07-12 daemonsettest]# kubectl apply -f daemonset.yaml 12345[root@centos07-12 daemonsettest]# kubectl get ds -n kube-systemNAME DESIRED CURRENT READY UP-TO-DATE AVAILABLE NODE SELECTOR AGEcalico-node 3 3 3 3 3 kubernetes.io/os=linux 16dfluentd-elasticsearch 3 3 3 3 3 &lt;none&gt; 55skube-proxy 3 3 3 3 3 kubernetes.io/os=linux 16d 12345[root@centos07-12 daemonsettest]# kubectl get pods -n kube-system -o wideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESfluentd-elasticsearch-bs6hl 1/1 Running 0 75s 10.244.193.129 centos07-22 &lt;none&gt; &lt;none&gt;fluentd-elasticsearch-s5wg9 1/1 Running 0 75s 10.244.250.224 centos07-62 &lt;none&gt; &lt;none&gt;fluentd-elasticsearch-xn52q 1/1 Running 0 75s 10.244.234.199 centos07-12 &lt;none&gt; &lt;none&gt; 通过上面可以看到在k8s的三个节点均创建了fluentd这个podpod的名字是由控制器的名字-随机数组成的 3.3 资源清单详细说明123456789101112131415161718192021222324252627282930313233343536373839404142apiVersion: apps/v1 #DaemonSet使用的api版本kind: DaemonSet # 资源类型metadata: name: fluentd-elasticsearch #资源的名字 namespace: kube-system #资源所在的名称空间 labels: k8s-app: fluentd-logging #资源具有的标签spec: selector: #标签选择器 matchLabels: name: fluentd-elasticsearch template: metadata: labels: #基于这回模板定义的pod具有的标签 name: fluentd-elasticsearch spec: tolerations: #定义容忍度 - key: node-role.kubernetes.io/master effect: NoSchedule containers: #定义容器 - name: fluentd-elasticsearch image: xianchao/fluentd:v2.5.1 resources: #资源配额 limits: memory: 200Mi requests: cpu: 100m memory: 200Mi volumeMounts: - name: varlog mountPath: /var/log #把本地/var/log目录挂载到容器 - name: varlibdockercontainers mountPath: /var/lib/docker/containers #把/var/lib/docker/containers/挂载到容器里 readOnly: true #挂载目录是只读权限 terminationGracePeriodSeconds: 30 #优雅的关闭服务 volumes: - name: varlog hostPath: path: /var/log #基于本地目录创建一个卷 - name: varlibdockercontainers hostPath: path: /var/lib/docker/containers #基于本地目录创建一个卷 4 Daemonset管理pod：滚动更新4.1 查看daemonset的滚动更新策略1234567891011121314# kubectl explain ds.spec.updateStrategyKIND: DaemonSetVERSION: apps/v1RESOURCE: updateStrategy &lt;Object&gt;DESCRIPTION: An update strategy to replace existing DaemonSet pods with new pods. DaemonSetUpdateStrategy is a struct used to control the update strategy for a DaemonSet.FIELDS: rollingUpdate &lt;Object&gt; Rolling update config params. Present only if type = &quot;RollingUpdate&quot;. type &lt;string&gt; Type of daemon set update. Can be &quot;RollingUpdate&quot; or &quot;OnDelete&quot;. Default is RollingUpdate. 4.2 查看rollingUpdate支持的更新策略12345678910# kubectl explain ds.spec.updateStrategy.rollingUpdateKIND: DaemonSetVERSION: apps/v1RESOURCE: rollingUpdate &lt;Object&gt;DESCRIPTION: Rolling update config params. Present only if type = &quot;RollingUpdate&quot;. Spec to control the desired behavior of daemon set rolling update.FIELDS: maxUnavailable &lt;string&gt; 上面表示rollingUpdate更新策略只支持maxUnavailabe，先删除在更新；因为我们不支持一个节点运行两个pod，因此需要先删除一个，在更新一个。 4.3 更新镜像版本，可以按照如下方法：1234567891011121314151617181920[root@centos07-12 daemonsettest]# kubectl set image daemonsets --helpUpdate existing container image(s) of resources. Possible resources include (case insensitive): pod (po), replicationcontroller (rc), deployment (deploy), daemonset (ds), statefulset (sts), cronjob (cj), replicaset(rs)Examples: # Set a deployment&#x27;s nginx container image to &#x27;nginx:1.9.1&#x27;, and its busybox container image to &#x27;busybox&#x27; kubectl set image deployment/nginx busybox=busybox nginx=nginx:1.9.1 # Update all deployments&#x27; and rc&#x27;s nginx container&#x27;s image to &#x27;nginx:1.9.1&#x27; kubectl set image deployments,rc nginx=nginx:1.9.1 --all # Update image of all containers of daemonset abc to &#x27;nginx:1.9.1&#x27; kubectl set image daemonset abc *=nginx:1.9.1 # Print result (in yaml format) of updating nginx container image from local file, without hitting the server kubectl set image -f path/to/file.yaml nginx=nginx:1.9.1 --local -o yaml kubectl set image daemonsets daemonset名称 containers名称&#x3D;镜像 -n 命名空间kubectl set image daemonsets fluentd-elasticsearch fluentd-elasticsearch&#x3D;docker.io&#x2F;library&#x2F;nginx:latest -n kube-system先查看下pod的镜像 12345[root@centos07-12 daemonsettest]# kubectl get pods -n=kube-systemNAME READY STATUS RESTARTS AGEfluentd-elasticsearch-bs6hl 1/1 Running 0 9m42sfluentd-elasticsearch-s5wg9 1/1 Running 0 9m42sfluentd-elasticsearch-xn52q 1/1 Running 0 9m42s 镜像是：docker.io&#x2F;xianchao&#x2F;fluentd:v2.5.1 12345678910111213141516171819202122[root@centos07-12 daemonsettest]# kubectl describe pods fluentd-elasticsearch-bs6hl -n=kube-systemName: fluentd-elasticsearch-bs6hlNamespace: kube-systemPriority: 0Service Account: defaultNode: centos07-22/192.168.1.22Start Time: Wed, 20 Dec 2023 11:57:38 +0800Labels: controller-revision-hash=7c7ddfc966 name=fluentd-elasticsearch pod-template-generation=1Annotations: cni.projectcalico.org/podIP: 10.244.193.129/32 cni.projectcalico.org/podIPs: 10.244.193.129/32Status: RunningIP: 10.244.193.129IPs: IP: 10.244.193.129Controlled By: DaemonSet/fluentd-elasticsearchContainers: fluentd-elasticsearch: Container ID: containerd://84d31822da2f428a35951897bcb3865b1a99a786ab331dcfde3c0beea21d996c Image: docker.io/xianchao/fluentd:v2.5.1 Image ID: sha256:cf4ed11c3a09256efe86757fc193d7066c26b2d80e29d5673091b8922e166fae 修改镜像 12[root@centos07-12 daemonsettest]# kubectl set image daemonsets fluentd-elasticsearch fluentd-elasticsearch=docker.io/library/nginx:latest -n kube-systemdaemonset.apps/fluentd-elasticsearch image updated 1234567891011121314151617181920[root@centos07-12 daemonsettest]# kubectl describe pods -n=kube-system fluentd-elasticsearch-t58h7Name: fluentd-elasticsearch-t58h7Namespace: kube-systemPriority: 0Service Account: defaultNode: centos07-12/192.168.1.12Start Time: Wed, 20 Dec 2023 12:14:58 +0800Labels: controller-revision-hash=57dd8dd6c5 name=fluentd-elasticsearch pod-template-generation=2Annotations: cni.projectcalico.org/podIP: 10.244.234.200/32 cni.projectcalico.org/podIPs: 10.244.234.200/32Status: PendingIP:IPs: &lt;none&gt;Controlled By: DaemonSet/fluentd-elasticsearchContainers: fluentd-elasticsearch: Container ID: Image: docker.io/library/nginx:latest","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"25-Statefulset控制器：概念、原理解读","slug":"运维/K8S/基础/25-Statefulset控制器：概念、原理解读","date":"2023-05-12T12:00:00.000Z","updated":"2023-12-14T15:17:17.000Z","comments":true,"path":"2023/05/12/运维/K8S/基础/25-Statefulset控制器：概念、原理解读/","link":"","permalink":"https://dbbruce.github.io/2023/05/12/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/25-Statefulset%E6%8E%A7%E5%88%B6%E5%99%A8%EF%BC%9A%E6%A6%82%E5%BF%B5%E3%80%81%E5%8E%9F%E7%90%86%E8%A7%A3%E8%AF%BB/","excerpt":"Statefulset控制器：概念、原理解读StatefulSet是为了管理有状态服务的问题而设计的 扩展：有状态服务？StatefulSet是有状态的集合，管理有状态的服务，它所管理的Pod的名称不能随意变化。数据持久化的目录也是不一样，每一个Pod都有自己独有的数据持久化存储目录。比如MySQL主从、redis集群等。 无状态服务？RC、Deployment、DaemonSet都是管理无状态的服务，它们所管理的Pod的IP、名字，启停顺序等都是随机的。个体对整体无影响，所有pod都是共用一个数据卷的，部署的tomcat就是无状态的服务，tomcat被删除，在启动一个新的tomcat，加入到集群即可，跟tomcat的名字无关。","text":"Statefulset控制器：概念、原理解读StatefulSet是为了管理有状态服务的问题而设计的 扩展：有状态服务？StatefulSet是有状态的集合，管理有状态的服务，它所管理的Pod的名称不能随意变化。数据持久化的目录也是不一样，每一个Pod都有自己独有的数据持久化存储目录。比如MySQL主从、redis集群等。 无状态服务？RC、Deployment、DaemonSet都是管理无状态的服务，它们所管理的Pod的IP、名字，启停顺序等都是随机的。个体对整体无影响，所有pod都是共用一个数据卷的，部署的tomcat就是无状态的服务，tomcat被删除，在启动一个新的tomcat，加入到集群即可，跟tomcat的名字无关。 个人理解，有状态服务：数据持久化pod名称有序，比如mysql主从pod整体删除一个pod有影响，mysql集群有个pod删除了，会有影响pod之间有依赖关系； Statefulset资源清单文件编写技巧查看定义Statefulset资源需要的字段123456789101112131415# kubectl explain statefulsetKIND: StatefulSetVERSION: apps/v1DESCRIPTION: StatefulSet represents a set of pods with consistent identities. Identities are defined as: - Network: A single stable DNS and hostname. - Storage: As many VolumeClaims as requested. The StatefulSet guarantees that a given network identity will always map to the same storage identity.FIELDS: apiVersion &lt;string&gt; #定义statefulset资源需要使用的api版本 kind &lt;string&gt; #定义的资源类型 metadata &lt;Object&gt; #元数据 spec &lt;Object&gt; #定义容器相关的信息 查看statefulset.spec字段如何定义？1234567891011121314151617# kubectl explain statefulset.specKIND: StatefulSetVERSION: apps/v1RESOURCE: spec &lt;Object&gt;DESCRIPTION: Spec defines the desired identities of pods in this set. A StatefulSetSpec is the specification of a StatefulSet.FIELDS: podManagementPolicy &lt;string&gt; #pod管理策略 replicas &lt;integer&gt; #副本数 revisionHistoryLimit &lt;integer&gt; #保留的历史版本 selector &lt;Object&gt; -required- #标签选择器，选择它所关联的pod serviceName &lt;string&gt; -required- #headless service的名字 template &lt;Object&gt; -required- #生成pod的模板 updateStrategy &lt;Object&gt; #更新策略 volumeClaimTemplates &lt;[]Object&gt; #存储卷申请模板 查看statefulset的spec.template字段如何定义？ 对于template而言，其内部定义的就是pod，pod模板是一个独立的对象 123456789101112131415# kubectl explain statefulset.spec.templateKIND: StatefulSetVERSION: apps/v1RESOURCE: template &lt;Object&gt;DESCRIPTION: template is the object that describes the pod that will be created if insufficient replicas are detected. Each pod stamped out by the StatefulSet will fulfill this Template, but have a unique identity from the rest of the StatefulSet. PodTemplateSpec describes the data a pod should have when created from a templateFIELDS: metadata &lt;Object&gt; spec &lt;Object&gt; #定义容器属性的 通过上面可以看到，statefulset资源中有两个spec字段。第一个spec声明的是statefulset定义多少个Pod副本（默认将仅部署1个Pod）、匹配Pod标签的选择器、创建pod的模板、存储卷申请模板，第二个spec是spec.template.spec：主要用于Pod里的容器属性等配置。.spec.template里的内容是声明Pod对象时要定义的各种属性，所以这部分也叫做PodTemplate（Pod模板）。还有一个值得注意的地方是：在.spec.selector中定义的标签选择器必须能够匹配到spec.template.metadata.labels里定义的Pod标签，否则Kubernetes将不允许创建statefulset。 Statefulset使用案例：部署web站点把nfs-subdir-external-provisioner.tar.gz上传到centos07-22&#x2F;62上，手动解压123ctr -n=k8s.io images import busybox.tar.gzctr -n=k8s.io images import myapp.tar.gzctr -n=k8s.io images import nginx.tar.gz 编写一个Statefulset资源清单文件1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950# cat statefulset.yaml apiVersion: v1kind: Servicemetadata: name: nginx labels: app: nginxspec: ports: - port: 80 name: web clusterIP: None selector: app: nginx---apiVersion: apps/v1kind: StatefulSetmetadata: name: webspec: selector: matchLabels: app: nginx serviceName: &quot;nginx&quot; replicas: 2 template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx imagePullPolicy: IfNotPresent ports: - containerPort: 80 name: web volumeMounts: - name: www mountPath: /usr/share/nginx/html volumeClaimTemplates: - metadata: name: www spec: accessModes: [&quot;ReadWriteOnce&quot;] storageClassName: &quot;nfs&quot; resources: requests: storage: 1Gi 更新资源清单文件123[root@centos07-12 statefulsettest]# kubectl apply -f statefulset.yamlservice/nginx createdstatefulset.apps/web created 查看statefulset是否创建成功1234[root@centos07-12 statefulsettest]# kubectl get svc -owideNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTORkubernetes ClusterIP 10.96.0.1 &lt;none&gt; 443/TCP 11d &lt;none&gt;nginx ClusterIP None &lt;none&gt; 80/TCP 2m16s app=nginx 123[root@centos07-12 statefulsettest]# kubectl get statefulset -owideNAME READY AGE CONTAINERS IMAGESweb 2/2 10m nginx nginx 1234[root@centos07-12 statefulsettest]# kubectl get pods -owide --show-labelsNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES LABELSweb-0 1/1 Running 0 86s 10.244.193.186 centos07-22 &lt;none&gt; &lt;none&gt; app=nginx,controller-revision-hash=web-56589c8559,statefulset.kubernetes.io/pod-name=web-0web-1 1/1 Running 0 84s 10.244.250.216 centos07-62 &lt;none&gt; &lt;none&gt; app=nginx,controller-revision-hash=web-56589c8559,statefulset.kubernetes.io/pod-name=web-1 通过上面可以看到创建的pod是有序的 查看pvc1234[root@centos07-12 statefulsettest]# kubectl get pvcNAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGEwww-web-0 Bound pvc-701297bc-d753-4ba7-b201-fc5f69b3f3e3 1Gi RWO nfs 12mwww-web-1 Bound pvc-6347066e-8a85-4227-a995-7856aa862e3e 1Gi RWO nfs 9m7s 查看pv1234[root@centos07-12 statefulsettest]# kubectl get pvNAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGEpvc-6347066e-8a85-4227-a995-7856aa862e3e 1Gi RWO Delete Bound default/www-web-1 nfs 9m36spvc-701297bc-d753-4ba7-b201-fc5f69b3f3e3 1Gi RWO Delete Bound default/www-web-0 nfs 13m 查看pod主机名123[root@centos07-12 statefulsettest]# for i in 0 1; do kubectl exec web-$i -- sh -c &#x27;hostname&#x27;;doneweb-0web-1 备注：StatefulSet由以下几个部分组成： Headless Service：用来定义pod网路标识，生成可解析的DNS记录 volumeClaimTemplates：存储卷申请模板，创建pvc，指定pvc名称大小，自动创建pvc，且pvc由存储类供应。 StatefulSet：管理pod的 扩展：什么是Headless service?Headless service不分配clusterIP，headless service可以通过解析service的DNS,返回所有Pod的dns和ip地址 (statefulSet部署的Pod才有DNS)，普通的service,只能通过解析service的DNS返回service的ClusterIP。 1.headless service会为service分配一个域名: .$.svc.cluster.local K8s中资源的全局FQDN格式: Service_NAME.NameSpace_NAME.Domain.LTD. Domain.LTD.&#x3D;svc.cluster.local. #这是默认k8s集群的域名。 FQDN 全称 Fully Qualified Domain Name即全限定域名：同时带有主机名和域名的名称FQDN &#x3D; Hostname + DomainName如 主机名是 xianchao域名是 baidu.comFQDN&#x3D; xianchao.baidu.com 2.StatefulSet会为关联的Pod保持一个不变的Pod Namestatefulset中Pod的名字格式为$(StatefulSet name)-$(pod序号) 3.StatefulSet会为关联的Pod分配一个dnsName$.$.$.svc.cluster.local 为什么要用volumeClaimTemplate？对于有状态应用都会用到持久化存储，比如mysql主从，由于主从数据库的数据是不能存放在一个目录下的，每个mysql节点都需要有自己独立的存储空间。而在deployment中创建的存储卷是一个共享的存储卷，多个pod使用同一个存储卷，它们数据是同步的，而statefulset定义中的每一个pod都不能使用同一个存储卷，这就需要使用volumeClainTemplate，当在使用statefulset创建pod时，volumeClainTemplate会自动生成一个PVC，从而请求绑定一个PV，每一个pod都有自己专用的存储卷。Pod、PVC和PV对应的关系图如下： 使用kubectl run运行一个提供nslookup命令的容器的，这个命令来自于dnsutils包，通过对pod主机名执行nslookup，可以检查它们在集群内部的DNS地址：注意：必须使用busybox 1.28版本，使用latest版本，nslookup解析域名不同 kubectl run busybox –image docker.io&#x2F;library&#x2F;busybox:1.28 –image-pull-policy&#x3D;IfNotPresent –restart&#x3D;Never –rm -it busybox – sh 1234567891011121314151617181920212223242526272829303132[root@centos07-12 statefulsettest]# kubectl run busybox --image docker.io/library/busybox:1.28 --image-pull-policy=IfNotPresent --restart=Never --rm -it busybox -- shIf you don&#x27;t see a command prompt, try pressing enter.#### service域名：nginx.default.svc.cluster.local#### 查询service dns，会把对应的pod ip解析出来 / # nslookup nginx.default.svc.cluster.localServer: 10.96.0.10 #### coredns，都是通过coredns解析的域名Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.localName: nginx.default.svc.cluster.localAddress 1: 10.244.250.216 web-1.nginx.default.svc.cluster.local Address 2: 10.244.193.186 web-0.nginx.default.svc.cluster.local#### service名称：nginx/ # nslookup nginxServer: 10.96.0.10 #### coredns，都是通过coredns解析的域名Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.localName: nginxAddress 1: 10.244.193.186 web-0.nginx.default.svc.cluster.localAddress 2: 10.244.250.216 web-1.nginx.default.svc.cluster.local#### statefulset创建的pod也是有dns记录的#### pod 的域名，pod有域名后，无论pod如何新建，都可以通过域名找到/ # nslookup web-0.nginx.default.svc.cluster.localServer: 10.96.0.10Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.localName: web-0.nginx.default.svc.cluster.localAddress 1: 10.244.193.186 web-0.nginx.default.svc.cluster.local #解析的是pod的ip地址 资源清单详细解读：123456789101112131415161718192021222324252627282930313233343536373839404142434445464748apiVersion: v1 #定义api版本kind: Service #定义要创建的资源：servicemetadata: name: nginx #定义service的名字 labels: app: nginx #service的标签spec: ports: - port: 80 name: web clusterIP: None #创建一个没有ip的service selector: app: nginx #选择拥有app=nginx标签的pod---apiVersion: apps/v1kind: StatefulSetmetadata: name: webspec: selector: matchLabels: app: nginx serviceName: &quot;nginx&quot; #headless service的名字 replicas: 2 #副本数 template: #定义pod的模板 metadata: labels: app: nginx spec: containers: - name: nginx image: nginx imagePullPolicy: IfNotPresent ports: - containerPort: 80 name: web volumeMounts: - name: www mountPath: /usr/share/nginx/html volumeClaimTemplates: #存储卷申请模板 - metadata: name: www spec: accessModes: [&quot;ReadWriteOnce&quot;]storageClassName: &quot;nfs&quot; #指定从哪个存储类申请pv resources: requests: storage: 1Gi #需要1G的pvc，会自动跟符合条件的pv绑定 Statefulset总结：1、Statefulset管理的pod，pod名字是有序的，由statefulset的名字-0、1、2这种格式组成2、创建statefulset资源的时候，必须事先创建好一个service,如果创建的service没有ip，那对这个service做dns解析，会找到它所关联的pod ip，如果创建的service有ip，那对这个service做dns解析，会解析到service本身ip。3、statefulset管理的pod，删除pod，新创建的pod名字跟删除的pod名字是一样的4、statefulset具有volumeclaimtemplate这个字段，这个是卷申请模板，会自动创建pv，pvc也会自动生成，跟pv进行绑定，那如果创建的statefulset使用了volumeclaimtemplate这个字段，那创建pod，数据目录是独享的5、ststefulset创建的pod，是域名的（域名组成：pod-name.svc-name.svc-namespace.svc.cluster.local） dig的使用dig -t A记录 要解析的域名 @指定域名服务器dig -t A nginx.default.svc.cluster.local @10.96.0.10格式如下：@来指定域名服务器A 为解析类型 ，A记录， A记录是解析域名到IP-t 指定要解析的类型 123456789101112131415# cat dig.yamlapiVersion: v1kind: Podmetadata: name: dig namespace: defaultspec: containers: - name: dig image: docker.io/xianchao/dig:latest imagePullPolicy: IfNotPresent command: - sleep - &quot;3600&quot; restartPolicy: Always 123456789101112131415161718192021222324[root@centos07-12 statefulsettest]# kubectl exec -it dig -- /bin/bashbash-4.3# dig -t A nginx.default.svc.cluster.local @10.96.0.10; &lt;&lt;&gt;&gt; DiG 9.10.3-P3 &lt;&lt;&gt;&gt; -t A nginx.default.svc.cluster.local @10.96.0.10;; global options: +cmd;; Got answer:;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 33080;; flags: qr aa rd; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1;; WARNING: recursion requested but not available;; OPT PSEUDOSECTION:; EDNS: version: 0, flags:; udp: 4096;; QUESTION SECTION:;nginx.default.svc.cluster.local. IN A;; ANSWER SECTION:nginx.default.svc.cluster.local. 30 IN A 10.244.193.186nginx.default.svc.cluster.local. 30 IN A 10.244.250.216;; Query time: 1 msec;; SERVER: 10.96.0.10#53(10.96.0.10);; WHEN: Thu Dec 14 14:02:43 UTC 2023;; MSG SIZE rcvd: 154 扩展：举例说明service 和headless service区别： 通过deployment创建pod，pod前端创建一个service12345678910111213141516171819202122232425262728293031323334353637383940# cat deploy-service.yaml apiVersion: v1kind: Servicemetadata: name: my-nginx labels: run: my-nginxspec: type: ClusterIP ports: - port: 80 #service的端口，暴露给k8s集群内部服务访问 protocol: TCP targetPort: 80 #pod容器中定义的端口 selector: run: my-nginx #选择拥有run=my-nginx标签的pod---apiVersion: apps/v1kind: Deploymentmetadata: name: my-nginxspec: selector: matchLabels: run: my-nginx replicas: 2 template: metadata: labels: run: my-nginx spec: containers: - name: my-nginx image: busybox imagePullPolicy: IfNotPresent ports: - containerPort: 80 command: - sleep - &quot;3600&quot; 更新资源清单文件1kubectl apply -f deploy-service.yaml 查看service123[root@centos07-12 statefulsettest]# kubectl get svc -l run=my-nginxNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGEmy-nginx ClusterIP 10.107.58.213 &lt;none&gt; 80/TCP 61s 查看pod123[root@centos07-12 statefulsettest]# kubectl get pods |grep nginxmy-nginx-7bf86b59cc-48txm 1/1 Running 0 65smy-nginx-7bf86b59cc-4db6k 1/1 Running 0 65s 通过上面可以看到deployment创建的pod是随机生成的 Statefulset管理pod：扩容、缩容、更新Statefulset实现pod的动态扩容如果我们觉得两个副本太少了，想要增加，只需要修改配置文件statefulset.yaml里的replicas的值即可，原来replicas: 2，现在变成replicaset: 3，修改之后，执行如下命令更新： 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950# cat statefulset.yaml apiVersion: v1kind: Servicemetadata: name: nginx labels: app: nginxspec: ports: - port: 80 name: web clusterIP: None selector: app: nginx---apiVersion: apps/v1kind: StatefulSetmetadata: name: webspec: selector: matchLabels: app: nginx serviceName: &quot;nginx&quot; replicas: 3 # 这里2修改为3 template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx imagePullPolicy: IfNotPresent ports: - containerPort: 80 name: web volumeMounts: - name: www mountPath: /usr/share/nginx/html volumeClaimTemplates: - metadata: name: www spec: accessModes: [&quot;ReadWriteOnce&quot;] storageClassName: &quot;nfs&quot; resources: requests: storage: 1Gi 123[root@centos07-12 statefulsettest]# kubectl apply -f statefulset.yamlservice/nginx unchangedstatefulset.apps/web configured 新增一个web-2,这个新增是有序的 12345[root@centos07-12 statefulsettest]# kubectl get podsNAME READY STATUS RESTARTS AGEweb-0 1/1 Running 0 75mweb-1 1/1 Running 0 75mweb-2 1/1 Running 0 9s 查看statfulset名称1234567[root@centos07-12 statefulsettest]# kubectl get stsNAME READY AGEweb 3/3 77m[root@centos07-12 statefulsettest]# kubectl get statefulsetNAME READY AGEweb 3/3 77m 也可以直接编辑控制器实现扩容，弹窗一个交互页面，直接修改为 replicas:4 这个是我们把请求提交给了apiserver，实时修改, 保存退出，pod直接增加 12345678910111213141516171819202122[root@centos07-12 statefulsettest]# kubectl edit sts webapiVersion: apps/v1kind: StatefulSetmetadata: annotations: kubectl.kubernetes.io/last-applied-configuration: | &#123;&quot;apiVersion&quot;:&quot;apps/v1&quot;,&quot;kind&quot;:&quot;StatefulSet&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;name&quot;:&quot;web&quot;,&quot;namespace&quot;:&quot;default&quot;&#125;,&quot;spec&quot;:&#123;&quot;replicas&quot;:3,&quot;selector&quot;:&#123;&quot;matchLabels&quot;:&#123;&quot;app&quot;:&quot;nginx&quot;&#125;&#125;,&quot;serviceName&quot;:&quot;nginx&quot;,&quot;template&quot;:&#123;&quot;metadata&quot;:&#123;&quot;labels&quot;:&#123;&quot;app&quot;:&quot;nginx&quot;&#125;&#125;,&quot;spec&quot;:&#123;&quot;containers&quot;:[&#123;&quot;image&quot;:&quot;nginx&quot;,&quot;imagePullPolicy&quot;:&quot;IfNotPresent&quot;,&quot;name&quot;:&quot;nginx&quot;,&quot;ports&quot;:[&#123;&quot;containerPort&quot;:80,&quot;name&quot;:&quot;web&quot;&#125;],&quot;volumeMounts&quot;:[&#123;&quot;mountPath&quot;:&quot;/usr/share/nginx/html&quot;,&quot;name&quot;:&quot;www&quot;&#125;]&#125;]&#125;&#125;,&quot;volumeClaimTemplates&quot;:[&#123;&quot;metadata&quot;:&#123;&quot;name&quot;:&quot;www&quot;&#125;,&quot;spec&quot;:&#123;&quot;accessModes&quot;:[&quot;ReadWriteOnce&quot;],&quot;resources&quot;:&#123;&quot;requests&quot;:&#123;&quot;storage&quot;:&quot;1Gi&quot;&#125;&#125;,&quot;storageClassName&quot;:&quot;nfs&quot;&#125;&#125;]&#125;&#125; creationTimestamp: &quot;2023-12-14T13:25:46Z&quot; generation: 3 name: web namespace: default resourceVersion: &quot;544708&quot; uid: 3b783ff6-f11e-410d-bd74-05424762af3cspec: persistentVolumeClaimRetentionPolicy: whenDeleted: Retain whenScaled: Retain podManagementPolicy: OrderedReady replicas: 4 123456[root@centos07-12 statefulsettest]# kubectl get pods -l app=nginxNAME READY STATUS RESTARTS AGEweb-0 1/1 Running 0 81mweb-1 1/1 Running 0 81mweb-2 1/1 Running 0 6m13sweb-3 1/1 Running 0 2m43s Statefulset实现pod的动态缩容如果我们觉得4个Pod副本太多了，想要减少，只需要修改配置文件statefulset.yaml里的replicas的值即可，把replicaset：4变成replicas: 2，修改之后，执行如下命令更新： 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950# cat statefulset.yaml apiVersion: v1kind: Servicemetadata: name: nginx labels: app: nginxspec: ports: - port: 80 name: web clusterIP: None selector: app: nginx---apiVersion: apps/v1kind: StatefulSetmetadata: name: webspec: selector: matchLabels: app: nginx serviceName: &quot;nginx&quot; replicas: 2 # 这里3修改为2 template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx imagePullPolicy: IfNotPresent ports: - containerPort: 80 name: web volumeMounts: - name: www mountPath: /usr/share/nginx/html volumeClaimTemplates: - metadata: name: www spec: accessModes: [&quot;ReadWriteOnce&quot;] storageClassName: &quot;nfs&quot; resources: requests: storage: 1Gi 123[root@centos07-12 statefulsettest]# kubectl apply -f statefulset.yamlservice/nginx unchangedstatefulset.apps/web configured 1234[root@centos07-12 statefulsettest]# kubectl get pods -l app=nginxNAME READY STATUS RESTARTS AGEweb-0 1/1 Running 0 84mweb-1 1/1 Running 0 84m Statefulset实现pod的更新 查看更新字段1kubectl explain sts.spec.updateStrategy 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354# cat statefulset.yaml apiVersion: v1kind: Servicemetadata: name: nginx labels: app: nginxspec: ports: - port: 80 name: web clusterIP: None selector: app: nginx---apiVersion: apps/v1kind: StatefulSetmetadata: name: webspec: updateStrategy: # 新加了更新字段 rollingUpdate: maxUnavailable: 0 partition: 1 selector: matchLabels: app: nginx serviceName: &quot;nginx&quot; replicas: 2 template: metadata: labels: app: nginx spec: containers: - name: nginx image: docker.io/ikubernetes/myapp:v2 # 修改了镜像 imagePullPolicy: IfNotPresent ports: - containerPort: 80 name: web volumeMounts: - name: www mountPath: /usr/share/nginx/html volumeClaimTemplates: - metadata: name: www spec: accessModes: [&quot;ReadWriteOnce&quot;] storageClassName: &quot;nfs&quot; resources: requests: storage: 1Gi 在一个终端动态查看pod1234[root@centos07-12 ~]# kubectl get pods -l app=nginx -wNAME READY STATUS RESTARTS AGEweb-0 1/1 Running 0 99mweb-1 1/1 Running 0 99m 另一个终端执行如下命令123[root@centos07-12 statefulsettest]# kubectl apply -f statefulset2.yamlservice/nginx unchangedstatefulset.apps/web configured 在一个终端动态查看pod只有web-1更新了123456789101112131415[root@centos07-12 ~]# kubectl get pods -l app=nginx -wNAME READY STATUS RESTARTS AGEweb-0 1/1 Running 0 99mweb-1 1/1 Running 0 99mweb-1 1/1 Terminating 0 99mweb-1 1/1 Terminating 0 99mweb-1 0/1 Terminating 0 99mweb-1 0/1 Terminating 0 99mweb-1 0/1 Terminating 0 99mweb-1 0/1 Terminating 0 99mweb-1 0/1 Pending 0 0sweb-1 0/1 Pending 0 0sweb-1 0/1 ContainerCreating 0 0sweb-1 0/1 ContainerCreating 0 1sweb-1 1/1 Running 0 2s 从上面结果可以看出来，pod在更新的时候，只是更新了web-1这个pod, partition: 1表示更新的时候会把pod序号大于等于1的进行更新 如果更新策略是OnDelete，那不会自动更新pod，需要手动删除，重新常见的pod才会实现更新123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051# cat statefulset2.yamlapiVersion: v1kind: Servicemetadata: name: nginx labels: app: nginxspec: ports: - port: 80 name: web clusterIP: None selector: app: nginx---apiVersion: apps/v1kind: StatefulSetmetadata: name: webspec: updateStrategy: type: OnDelete # 更改为OnDelete， 注意大小写，这里错了 selector: matchLabels: app: nginx serviceName: &quot;nginx&quot; replicas: 2 # 这里3修改为2 template: metadata: labels: app: nginx spec: containers: - name: nginx image: docker.io/ikubernetes/myapp:v2 # 注意这个images imagePullPolicy: IfNotPresent ports: - containerPort: 80 name: web volumeMounts: - name: www mountPath: /usr/share/nginx/html volumeClaimTemplates: - metadata: name: www spec: accessModes: [&quot;ReadWriteOnce&quot;] storageClassName: &quot;nfs&quot; resources: requests: storage: 1Gi 在一个终端动态查看pod1234[root@centos07-12 ~]# kubectl get pods -l app=nginx -wNAME READY STATUS RESTARTS AGEweb-0 1/1 Running 0 105mweb-1 1/1 Running 0 5m39s 另一个终端执行如下命令123[root@centos07-12 statefulsettest]# kubectl apply -f statefulset2.yamlservice/nginx unchangedstatefulset.apps/web configured 在一个终端动态查看pod，执行apply后没有变化，需要delete pod后，才会更新pod1234[root@centos07-12 ~]# kubectl get pods -l app=nginx -wNAME READY STATUS RESTARTS AGEweb-0 1/1 Running 0 105mweb-1 1/1 Running 0 5m39s 删除pod1234[root@centos07-12 statefulsettest]# kubectl delete pod web-0pod &quot;web-0&quot; deleted[root@centos07-12 statefulsettest]# kubectl delete pod web-1pod &quot;web-1&quot; deleted pod更新了123456789101112131415161718192021[root@centos07-12 statefulsettest]# kubectl describe pod web-0Name: web-0Namespace: defaultPriority: 0Service Account: defaultNode: centos07-22/192.168.1.22Start Time: Thu, 14 Dec 2023 23:13:09 +0800Labels: app=nginx controller-revision-hash=web-79784bbccf statefulset.kubernetes.io/pod-name=web-0Annotations: cni.projectcalico.org/podIP: cni.projectcalico.org/podIPs:Status: RunningIP: 10.244.193.191IPs: IP: 10.244.193.191Controlled By: StatefulSet/webContainers: nginx: Container ID: containerd://a9fb2b916ccb7ec160d5f49623d31fe0051dca506dc5268eec2b347af18e550c Image: docker.io/ikubernetes/myapp:v2 ### images更新了","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"24-k8s存储类storageclass","slug":"运维/K8S/基础/24-k8s存储类storageclass","date":"2023-05-12T02:00:00.000Z","updated":"2023-12-14T12:13:54.000Z","comments":true,"path":"2023/05/12/运维/K8S/基础/24-k8s存储类storageclass/","link":"","permalink":"https://dbbruce.github.io/2023/05/12/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/24-k8s%E5%AD%98%E5%82%A8%E7%B1%BBstorageclass/","excerpt":"k8s存储类：storageclass上面介绍的PV和PVC模式都是需要先创建好PV，然后定义好PVC和pv进行一对一的Bond，但是如果PVC请求成千上万，那么就需要创建成千上万的PV，对于运维人员来说维护成本很高，Kubernetes提供一种自动创建PV的机制，叫StorageClass，它的作用就是创建PV的模板。k8s集群管理员通过创建storageclass可以动态生成一个存储卷pv供k8s pvc使用。 每个StorageClass都包含字段provisioner，parameters和reclaimPolicy。 具体来说，StorageClass会定义以下两部分：1、PV的属性 ，比如存储的大小、类型等；2、创建这种PV需要使用到的存储插件，比如Ceph、NFS等 有了这两部分信息，Kubernetes就能够根据用户提交的PVC，找到对应的StorageClass，然后Kubernetes就会调用 StorageClass声明的存储插件，创建出需要的PV。","text":"k8s存储类：storageclass上面介绍的PV和PVC模式都是需要先创建好PV，然后定义好PVC和pv进行一对一的Bond，但是如果PVC请求成千上万，那么就需要创建成千上万的PV，对于运维人员来说维护成本很高，Kubernetes提供一种自动创建PV的机制，叫StorageClass，它的作用就是创建PV的模板。k8s集群管理员通过创建storageclass可以动态生成一个存储卷pv供k8s pvc使用。 每个StorageClass都包含字段provisioner，parameters和reclaimPolicy。 具体来说，StorageClass会定义以下两部分：1、PV的属性 ，比如存储的大小、类型等；2、创建这种PV需要使用到的存储插件，比如Ceph、NFS等 有了这两部分信息，Kubernetes就能够根据用户提交的PVC，找到对应的StorageClass，然后Kubernetes就会调用 StorageClass声明的存储插件，创建出需要的PV。 查看定义的storageclass需要的字段12345678910111213141516171819# kubectl explain storageclassKIND: StorageClassVERSION: storage.k8s.io/v1DESCRIPTION: StorageClass describes the parameters for a class of storage for which PersistentVolumes can be dynamically provisioned. StorageClasses are non-namespaced; the name of the storage class according to etcd is in ObjectMeta.Name.FIELDS: allowVolumeExpansion &lt;boolean&gt; allowedTopologies &lt;[]Object&gt; apiVersion &lt;string&gt; kind &lt;string&gt; metadata &lt;Object&gt; mountOptions &lt;[]string&gt; parameters &lt;map[string]string&gt; provisioner &lt;string&gt; -required- reclaimPolicy &lt;string&gt; volumeBindingMode &lt;string&gt; provisioner：供应商，storageclass需要有一个供应者，用来确定我们使用什么样的存储来创建pv，常见的provisioner如下（https://kubernetes.io/zh/docs/concepts/storage/storage-classes/）： provisioner既可以由内部供应商提供，也可以由外部供应商提供，如果是外部供应商可以参考https://github.com/kubernetes-incubator/external-storage/下提供的方法创建。 https://github.com/kubernetes-sigs/sig-storage-lib-external-provisioner 以NFS为例，要想使用NFS，我们需要一个nfs-client的自动装载程序，称之为provisioner，这个程序会使用我们已经配置好的NFS服务器自动创建持久卷，也就是自动帮我们创建PV。 reclaimPolicy：回收策略 allowVolumeExpansion：允许卷扩展，PersistentVolume 可以配置成可扩展。将此功能设置为true时，允许用户通过编辑相应的 PVC 对象来调整卷大小。当基础存储类的allowVolumeExpansion字段设置为 true 时，以下类型的卷支持卷扩展。注意：此功能仅用于扩容卷，不能用于缩小卷。 安装nfs provisioner，用于配合存储类动态生成pv把nfs-subdir-external-provisioner.tar.gz上传到centos07-22&#x2F;62上，手动解压。1ctr -n=k8s.io images import nfs-subdir-external-provisioner.tar.gz 123[root@centos07-62 ~]# crictl imagesIMAGE TAG IMAGE ID SIZEregistry.cn-beijing.aliyuncs.com/mydlq/nfs-subdir-external-provisioner v4.0.0 3beaacba3ff48 45.1MB 创建service account, 创建运行nfs-provisioner需要的sa账号123456# cat serviceaccount.yaml apiVersion: v1kind: ServiceAccountmetadata: name: nfs-provisioner 12[root@centos07-12 storageclasstest]# kubectl apply -f serviceaccount.yamlserviceaccount/nfs-provisioner created 1234[root@centos07-12 storageclasstest]# kubectl get saNAME SECRETS AGEdefault 0 11dnfs-provisioner 0 9m51s 扩展：什么是sa？sa的全称是serviceaccount。serviceaccount是为了方便Pod里面的进程调用Kubernetes API或其他外部服务而设计的。指定了serviceaccount之后，我们把pod创建出来了，我们在使用这个pod时，这个pod就有了我们指定的账户的权限了。 对sa授权1kubectl create clusterrolebinding nfs-provisioner-clusterrolebinding --clusterrole=cluster-admin --serviceaccount=default:nfs-provisioner 把&#x2F;data&#x2F;nfs_pro变成nfs共享的目录1mkdir /data/nfs_pro -p 123# cat /etc/exports/data/nfs_pro 192.168.1.0/24(rw,no_root_squash) 12[root@centos07-12 storageclasstest]# exportfs -arvexporting 192.168.1.0/24:/data/nfs_pro 安装nfs-provisioner程序1234567891011121314151617181920212223242526272829303132333435363738# cat nfs-deployment.yaml apiVersion: apps/v1kind: Deploymentmetadata: name: nfs-provisionerspec: selector: matchLabels: app: nfs-provisioner replicas: 1 strategy: type: Recreate template: metadata: labels: app: nfs-provisioner spec: serviceAccount: nfs-provisioner containers: - name: nfs-provisioner image: registry.cn-beijing.aliyuncs.com/mydlq/nfs-subdir-external-provisioner:v4.0.0 imagePullPolicy: IfNotPresent volumeMounts: - name: nfs-client-root mountPath: /persistentvolumes env: - name: PROVISIONER_NAME # 供应商的名称 value: example.com/nfs - name: NFS_SERVER value: 192.168.1.12 - name: NFS_PATH value: /data/nfs_pro volumes: - name: nfs-client-root nfs: server: 192.168.1.12 path: /data/nfs_pro 更新资源清单文件12[root@centos07-12 storageclasstest]# kubectl apply -f nfs-deployment.yamldeployment.apps/nfs-provisioner created 查看nfs-provisioner是否正常运行12[root@centos07-12 storageclasstest]# kubectl get pods -owide --show-labels |grep nfsnfs-provisioner-77467f5d6d-9ff6s 1/1 Running 0 68s 10.244.250.211 centos07-62 &lt;none&gt; &lt;none&gt; app=nfs-provisioner,pod-template-hash=77467f5d6d 创建storageclass，动态供给pv添加一个storageclass1234567# cat nfs-storageclass.yaml kind: StorageClassapiVersion: storage.k8s.io/v1metadata: name: nfsprovisioner: example.com/nfs 12[root@centos07-12 storageclasstest]# kubectl apply -f nfs-storageclass.yamlstorageclass.storage.k8s.io/nfs created 查看storageclass是否创建成功123[root@centos07-12 storageclasstest]# kubectl get storageclass -owideNAME PROVISIONER RECLAIMPOLICY VOLUMEBINDINGMODE ALLOWVOLUMEEXPANSION AGEnfs example.com/nfs Delete Immediate false 93s 显示内容如上，说明storageclass创建成功了 注意：provisioner处写的example.com&#x2F;nfs应该跟安装nfs provisioner时候的env下的PROVISIONER_NAME的value值保持一致，如下：env: - name: PROVISIONER_NAME value: example.com&#x2F;nfs 创建pvc，通过storageclass动态生成pv123456789101112# cat claim.yaml apiVersion: v1kind: PersistentVolumeClaimmetadata: name: test-claim1spec: accessModes: [&quot;ReadWriteMany&quot;] resources: requests: storage: 1Gi storageClassName: nfs 12[root@centos07-12 storageclasstest]# kubectl apply -f claim.yamlpersistentvolumeclaim/test-claim1 created 查看是否动态生成了pv，pvc是否创建成功，并和pv绑定123[root@centos07-12 storageclasstest]# kubectl get pv -owideNAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE VOLUMEMODEpvc-2ae047d9-23a2-43d3-a0d1-db81982ea8bd 1Gi RWX Delete Bound default/test-claim1 nfs 102s Filesystem 123[root@centos07-12 storageclasstest]# kubectl get pvc -owideNAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE VOLUMEMODEtest-claim1 Bound pvc-2ae047d9-23a2-43d3-a0d1-db81982ea8bd 1Gi RWX nfs 103s Filesystem 通过上面可以看到test-claim1的pvc已经成功创建了，绑定的pv是pvc-2ae047d9-23a2-43d3-a0d1-db81982ea8bd，这个pv是由storageclass调用nfs provisioner自动生成的。 步骤总结：1、供应商：创建一个nfs provisioner2、创建storageclass，storageclass指定刚才创建的供应商3、创建pvc，这个pvc指定storageclass 创建pod，挂载storageclass动态生成的pvc：test-claim112345678910111213141516171819# cat read-pod.yaml kind: PodapiVersion: v1metadata: name: read-podspec: containers: - name: read-pod image: nginx imagePullPolicy: IfNotPresent volumeMounts: - name: nfs-pvc mountPath: /usr/share/nginx/html restartPolicy: &quot;Never&quot; volumes: - name: nfs-pvc persistentVolumeClaim: claimName: test-claim1 更新资源清单文件12[root@centos07-12 storageclasstest]# kubectl apply -f read-pod.yamlpod/read-pod created 查看pod是否创建成功12[root@centos07-12 storageclasstest]# kubectl get pods -owide |grep readread-pod 1/1 Running 0 41s 10.244.250.212 centos07-62 &lt;none&gt; &lt;none&gt;","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"23-K8s持久化存储","slug":"运维/K8S/基础/23-K8s持久化存储","date":"2023-05-11T12:00:00.000Z","updated":"2023-12-14T08:18:09.000Z","comments":true,"path":"2023/05/11/运维/K8S/基础/23-K8s持久化存储/","link":"","permalink":"https://dbbruce.github.io/2023/05/11/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/23-K8s%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8/","excerpt":"一、K8s持久化存储1.1.在k8s中为什么要做持久化存储？在k8s中部署的应用都是以pod容器的形式运行的，假如我们部署MySQL、Redis等数据库，需要对这些数据库产生的数据做备份。因为Pod是有生命周期的，如果pod不挂载数据卷，那pod被删除或重启后这些数据会随之消失，如果想要长久的保留这些数据就要用到pod数据持久化存储。","text":"一、K8s持久化存储1.1.在k8s中为什么要做持久化存储？在k8s中部署的应用都是以pod容器的形式运行的，假如我们部署MySQL、Redis等数据库，需要对这些数据库产生的数据做备份。因为Pod是有生命周期的，如果pod不挂载数据卷，那pod被删除或重启后这些数据会随之消失，如果想要长久的保留这些数据就要用到pod数据持久化存储。 二、k8s持久化存储类型查看k8s支持哪些存储1234567891011121314151617181920212223242526272829303132333435363738394041# kubectl explain pods.spec.volumesKIND: PodVERSION: v1RESOURCE: volumes &lt;[]Object&gt;DESCRIPTION: List of volumes that can be mounted by containers belonging to the pod. More info: https://kubernetes.io/docs/concepts/storage/volumes Volume represents a named volume in a pod that may be accessed by any container in the pod.FIELDS: awsElasticBlockStore &lt;Object&gt; azureDisk &lt;Object&gt; azureFile &lt;Object&gt; cephfs &lt;Object&gt; cinder &lt;Object&gt; configMap &lt;Object&gt; csi &lt;Object&gt; downwardAPI &lt;Object&gt; emptyDir &lt;Object&gt; ephemeral &lt;Object&gt; fc &lt;Object&gt; flexVolume &lt;Object&gt; flocker &lt;Object&gt; gcePersistentDisk &lt;Object&gt; gitRepo &lt;Object&gt; glusterfs &lt;Object&gt; hostPath &lt;Object&gt; iscsi &lt;Object&gt; name &lt;string&gt; -required- nfs &lt;Object&gt; persistentVolumeClaim &lt;Object&gt; photonPersistentDisk &lt;Object&gt; portworxVolume &lt;Object&gt; projected &lt;Object&gt; quobyte &lt;Object&gt; rbd &lt;Object&gt; scaleIO &lt;Object&gt; secret &lt;Object&gt; storageos &lt;Object&gt; vsphereVolume &lt;Object&gt; 常用的如下：emptyDirhostPathnfspersistentVolumeClaimglusterfscephfsconfigMapsecret 我们想要使用存储卷，需要经历如下步骤1、定义pod的volume，这个volume指明它要关联到哪个存储上的2、在容器中要使用volumemounts挂载对应的存储经过以上两步才能正确的使用存储卷 emptyDir类型的Volume是在Pod分配到Node上时被创建，Kubernetes会在Node上自动分配一个目录，因此无需指定宿主机Node上对应的目录文件。 这个目录的初始内容为空，当Pod从Node上移除时，emptyDir中的数据会被永久删除。emptyDir Volume主要用于某些应用程序无需永久保存的临时目录，多个容器的共享目录等。 2.1.emptyDir &#x3D;&#x3D; 挂载临时目录 Emptydir的官方网址：https://kubernetes.io/docs/concepts/storage/volumes#emptydir1234567891011121314151617# cat emptydir.yaml apiVersion: v1kind: Podmetadata: name: pod-emptyspec: containers: - name: container-empty image: nginx imagePullPolicy: s volumeMounts: - mountPath: /cache name: cache-volume volumes: - emptyDir: &#123;&#125; name: cache-volume 更新资源清单文件12[root@centos07-12 volumetest]# kubectl apply -f emptydir.yamlpod/pod-empty configured 查看pod调度到哪个节点，pod在62节点上123[root@centos07-12 volumetest]# kubectl get pods -owide --show-labelsNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES LABELSpod-empty 1/1 Running 0 2m10s 10.244.250.200 centos07-62 &lt;none&gt; &lt;none&gt; &lt;none&gt; 查看pod的uid kubectl get pods pod-empty -o yaml | grep uid 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107[root@centos07-12 volumetest]# kubectl get pods pod-empty -o yamlapiVersion: v1kind: Podmetadata: annotations: cni.projectcalico.org/podIP: 10.244.250.200/32 cni.projectcalico.org/podIPs: 10.244.250.200/32 kubectl.kubernetes.io/last-applied-configuration: | &#123;&quot;apiVersion&quot;:&quot;v1&quot;,&quot;kind&quot;:&quot;Pod&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;name&quot;:&quot;pod-empty&quot;,&quot;namespace&quot;:&quot;default&quot;&#125;,&quot;spec&quot;:&#123;&quot;containers&quot;:[&#123;&quot;image&quot;:&quot;nginx&quot;,&quot;imagePullPolicy&quot;:&quot;IfNotPresent&quot;,&quot;name&quot;:&quot;container-empty&quot;,&quot;volumeMounts&quot;:[&#123;&quot;mountPath&quot;:&quot;/cache&quot;,&quot;name&quot;:&quot;cache-volume&quot;&#125;]&#125;],&quot;volumes&quot;:[&#123;&quot;emptyDir&quot;:&#123;&#125;,&quot;name&quot;:&quot;cache-volume&quot;&#125;]&#125;&#125; creationTimestamp: &quot;2023-12-13T03:43:39Z&quot; name: pod-empty namespace: default resourceVersion: &quot;447861&quot; uid: 99cfb8a9-283c-45fa-bb6e-acf9bc545f3e # 这里是UIDspec: containers: - image: nginx imagePullPolicy: IfNotPresent name: container-empty resources: &#123;&#125; terminationMessagePath: /dev/termination-log terminationMessagePolicy: File volumeMounts: - mountPath: /cache name: cache-volume - mountPath: /var/run/secrets/kubernetes.io/serviceaccount name: kube-api-access-869hl readOnly: true dnsPolicy: ClusterFirst enableServiceLinks: true nodeName: centos07-62 preemptionPolicy: PreemptLowerPriority priority: 0 restartPolicy: Always schedulerName: default-scheduler securityContext: &#123;&#125; serviceAccount: default serviceAccountName: default terminationGracePeriodSeconds: 30 tolerations: - effect: NoExecute key: node.kubernetes.io/not-ready operator: Exists tolerationSeconds: 300 - effect: NoExecute key: node.kubernetes.io/unreachable operator: Exists tolerationSeconds: 300 volumes: - emptyDir: &#123;&#125; name: cache-volume - name: kube-api-access-869hl projected: defaultMode: 420 sources: - serviceAccountToken: expirationSeconds: 3607 path: token - configMap: items: - key: ca.crt path: ca.crt name: kube-root-ca.crt - downwardAPI: items: - fieldRef: apiVersion: v1 fieldPath: metadata.namespace path: namespacestatus: conditions: - lastProbeTime: null lastTransitionTime: &quot;2023-12-13T03:43:40Z&quot; status: &quot;True&quot; type: Initialized - lastProbeTime: null lastTransitionTime: &quot;2023-12-13T03:43:41Z&quot; status: &quot;True&quot; type: Ready - lastProbeTime: null lastTransitionTime: &quot;2023-12-13T03:43:41Z&quot; status: &quot;True&quot; type: ContainersReady - lastProbeTime: null lastTransitionTime: &quot;2023-12-13T03:43:39Z&quot; status: &quot;True&quot; type: PodScheduled containerStatuses: - containerID: containerd://b12ee8c5a336922adbc6fa3fb50ab7d8d8291db44db664b19602ac34f3a4ea90 image: docker.io/library/nginx:latest imageID: sha256:f6d0b4767a6c466c178bf718f99bea0d3742b26679081e52dbf8e0c7c4c42d74 lastState: &#123;&#125; name: container-empty ready: true restartCount: 0 started: true state: running: startedAt: &quot;2023-12-13T03:43:41Z&quot; hostIP: 192.168.1.62 phase: Running podIP: 10.244.250.200 podIPs: - ip: 10.244.250.200 qosClass: BestEffort startTime: &quot;2023-12-13T03:43:40Z&quot; 123[root@centos07-12 volumetest]# kubectl get pods pod-empty -o yaml | grep uid uid: 99cfb8a9-283c-45fa-bb6e-acf9bc545f3e 查看本机临时目录存在的位置，可用如下方法：在 centos07-62上123# 在 centos07-62上yum install tree -y pod目录路径 &#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;pods&#x2F; 树形结构 tree &#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;pods&#x2F;99cfb8a9-283c-45fa-bb6e-acf9bc545f3e 12345678910111213141516171819202122[root@centos07-62 pods]# tree /var/lib/kubelet/pods/99cfb8a9-283c-45fa-bb6e-acf9bc545f3e/var/lib/kubelet/pods/99cfb8a9-283c-45fa-bb6e-acf9bc545f3e├── containers│ └── container-empty│ └── 01458b80├── etc-hosts├── plugins│ └── kubernetes.io~empty-dir│ ├── cache-volume│ │ └── ready│ └── wrapped_kube-api-access-869hl│ └── ready└── volumes ├── kubernetes.io~empty-dir │ └── cache-volume └── kubernetes.io~projected └── kube-api-access-869hl ├── ca.crt -&gt; ..data/ca.crt ├── namespace -&gt; ..data/namespace └── token -&gt; ..data/token11 directories, 7 files 由上可知，临时目录在本地的&#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;pods&#x2F;99cfb8a9-283c-45fa-bb6e-acf9bc545f3e&#x2F;volumes&#x2F;kubernetes.io~empty-dir&#x2F;cache-volume下 2.2.hostPath &#x3D;&#x3D; Pod挂载宿主机上的目录或文件hostPath Volume是指Pod挂载宿主机上的目录或文件。 hostPath Volume使得容器可以使用宿主机的文件系统进行存储，hostpath（宿主机路径）：节点级别的存储卷，在pod被删除，这个存储卷还是存在的，不会被删除，所以只要同一个pod被调度到同一个节点上来，在pod被删除重新被调度到这个节点之后，对应的数据依然是存在的。局限性，pod和node需要绑定，因为数据是存在固定的node上 查看hostPath存储卷的用法 123456789101112131415# kubectl explain pods.spec.volumes.hostPathKIND: PodVERSION: v1RESOURCE: hostPath &lt;Object&gt;DESCRIPTION: HostPath represents a pre-existing file or directory on the host machine that is directly exposed to the container. This is generally used for system agents or other privileged things that are allowed to see the host machine. Most containers will NOT need this. More info: https://kubernetes.io/docs/concepts/storage/volumes#hostpath Represents a host path mapped into a pod. Host path volumes do not support ownership management or SELinux relabeling.FIELDS: path &lt;string&gt; -required- type &lt;string&gt; 把tomcat.tar.gz上传到centos07-22&#x2F;62上，手动解压： 1ctr -n=k8s.io images import tomcat.tar.gz 创建一个pod，挂载hostPath存储卷 12345678910111213141516171819202122232425# cat hostpath.yaml apiVersion: v1kind: Podmetadata: name: test-hostpathspec: nodeName: centos07-62 # 可以加可以不加，加的话指定调度到那个node上 containers: - image: nginx imagePullPolicy: IfNotPresent name: test-nginx volumeMounts: - mountPath: /test-nginx name: test-volume - image: tomcat:8.5-jre8-alpine imagePullPolicy: IfNotPresent name: test-tomcat volumeMounts: - mountPath: /test-tomcat name: test-volume volumes: - name: test-volume hostPath: path: /data1 type: DirectoryOrCreate 注意：DirectoryOrCreate表示本地有&#x2F;data1目录，就用本地的，本地没有就会在pod调度到的节点自动创建一个。https://kubernetes.io/zh-cn/docs/concepts/storage/volumes/ 更新资源清单文件 12[root@centos07-12 volumetest]# kubectl apply -f hostpath.yamlpod/test-hostpath created 查看pod调度到了哪个物理节点 12[root@centos07-12 volumetest]# kubectl get pods -o wide | grep hostpathtest-hostpath 0/2 ContainerCreating 0 37s &lt;none&gt; centos07-62 &lt;none&gt; &lt;none&gt; 由上面可以知道pod调度到了centos07-62上，登录到centos07-62机器，查看是否在这台机器创建了存储目录 12[root@centos07-62 cache-volume]# ll /data1/总用量 0 上面可以看到已经创建了存储目录&#x2F;data1，这个&#x2F;data1会作为pod的持久化存储目录 在centos07-62上的&#x2F;data1下创建一个目录 12[root@centos07-62 cache-volume]# cd /data1/[root@centos07-62 data1]# mkdir aa 测试存储卷是否可以正常使用,登录到nginx容器 12[root@centos07-12 volumetest]# kubectl get pods -owide |grep test-hostpathtest-hostpath 2/2 Running 0 12m 10.244.250.201 centos07-62 &lt;none&gt; &lt;none&gt; 123456[root@centos07-12 volumetest]# kubectl exec -it test-hostpath -c test-nginx -- /bin/bashroot@test-hostpath:/# cd /test-nginx/root@test-hostpath:/test-nginx# lsaa &#x2F;test-nginx&#x2F;目录存在，说明已经把宿主机目录挂载到了容器里 测试存储卷是否可以正常使用,登录到tomcat容器 指定Pod中某个容器执行data命令:kubectl exec -c data 1234[root@centos07-12 volumetest]# kubectl exec -it test-hostpath -c test-tomcat -- /bin/bashbash-4.4# cd /test-tomcat/ #/test-tomcat/目录存在，说明已经把宿主机目录挂载到了容器里bash-4.4# lsaa 通过上面测试可以看到，同一个pod里的test-nginx和test-tomcat这两个容器是共享存储卷的。 hostpath存储卷缺点： 单节点pod删除之后重新创建必须调度到同一个node节点，数据才不会丢失 可以用分布式存储：nfs，cephfs，glusterfs 2.3.nfs &#x3D;&#x3D; 网络文件系统NFS：网络文件系统，英文Network File System(NFS)，是由SUN公司研制的UNIX表示层协议(presentation layer protocol)，能使使用者访问网络上别处的文件就像在使用自己的计算机一样。 搭建nfs服务以k8s的控制节点作为NFS服务端1[root@centos07-12 volumetest]# yum install nfs-utils -y 在宿主机创建NFS需要的共享目录1234[root@centos07-12 volumetest]# mkdir /data/volumes -pvmkdir: 已创建目录 &quot;/data&quot;mkdir: 已创建目录 &quot;/data/volumes&quot;[root@centos07-12 volumetest]# ls /data/volumes/ 配置nfs共享服务器上的&#x2F;data&#x2F;volumes目录1[root@centos07-12 volumetest]# systemctl start nfs 1234[root@centos07-12 volumetest]# vim /etc/exports/data/volumes *(rw,no_root_squash)#rw 该主机对该共享目录有读写权限 no_root_squash 登入 NFS 主机使用分享目录的使用者，如果是 root 的话，那么对于这个分享的目录来说，他就具有 root 的权限 使NFS配置生效 12[root@centos07-12 volumetest]# exportfs -arvexporting *:/data/volumes 设置成开机自启动 12[root@centos07-12 volumetest]# service nfs restartRedirecting to /bin/systemctl restart nfs.service 12[root@centos07-12 volumetest]# systemctl enable nfsCreated symlink from /etc/systemd/system/multi-user.target.wants/nfs-server.service to /usr/lib/systemd/system/nfs-server.service. 查看nfs是否启动成功 1234567891011[root@centos07-12 volumetest]# systemctl status nfs● nfs-server.service - NFS server and services Loaded: loaded (/usr/lib/systemd/system/nfs-server.service; enabled; vendor preset: disabled) Drop-In: /run/systemd/generator/nfs-server.service.d └─order-with-mounts.conf Active: active (exited) since 三 2023-12-13 13:30:47 CST; 44s ago Main PID: 16582 (code=exited, status=0/SUCCESS) CGroup: /system.slice/nfs-server.service12月 13 13:30:47 centos07-12 systemd[1]: Starting NFS server and services...12月 13 13:30:47 centos07-12 systemd[1]: Started NFS server and services. Active: active看到nfs是active，说明nfs正常启动了 centos07-22&#x2F;62上也安装nfs驱动 12yum install nfs-utils -ysystemctl enable nfs --now (2个杠) 在centos07-22&#x2F;62上手动挂载试试： 123mkdir /test mount 192.168.1.12:/data/volumes /test/df -h 123[root@centos07-22 pods]# df -h文件系统 容量 已用 可用 已用% 挂载点192.168.1.12:/data/volumes 26G 5.0G 21G 20% /test nfs可以被正常挂载手动卸载centos07-22&#x2F;62： 1umount /test 创建Pod，挂载NFS共享出来的目录Pod挂载nfs的官方地址：https://kubernetes.io/zh/docs/concepts/storage/volumes/1234567891011121314151617181920212223242526272829303132# cat nfs.yaml apiVersion: apps/v1kind: Deploymentmetadata: name: nfs-testspec: replicas: 3 selector: matchLabels: cunchu: nfs template: metadata: labels: cunchu: nfs spec: containers: - name: test-nfs image: docker.io/library/nginx:latest imagePullPolicy: IfNotPresent ports: - containerPort: 80 protocol: TCP volumeMounts: - name: nfs-volumes mountPath: /usr/share/nginx/html volumes: - name: nfs-volumes nfs: server: 192.168.1.12 path: /data/volumes 注：path: &#x2F;data&#x2F;volumes #nfs的共享目录server：192.168.40.180是xianchaomaster1机器的ip，这个是安装nfs服务的地址 更新资源清单文件12[root@centos07-12 volumetest]# kubectl apply -f nfs.yamldeployment.apps/nfs-test created 查看pod是否创建成功12345[root@centos07-12 volumetest]# kubectl get pods -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESnfs-test-7c77d7b868-d44tr 1/1 Running 0 7s 10.244.250.204 centos07-62 &lt;none&gt; &lt;none&gt;nfs-test-7c77d7b868-p9xm7 1/1 Running 0 7s 10.244.193.180 centos07-22 &lt;none&gt; &lt;none&gt;nfs-test-7c77d7b868-r4kkr 1/1 Running 0 7s 10.244.250.205 centos07-62 &lt;none&gt; &lt;none&gt; 登录到nfs服务器 centos07-12，在共享目录创建一个index.html12345678910[root@centos07-12 volumetest]# cd /data/volumes/[root@centos07-12 volumes]# ll总用量 0[root@centos07-12 volumes]# pwd/data/volumes[root@centos07-12 volumes]# vim index.htmlHello, EveryoneMy name is xianchaoMy Chat is luckylucky421302 请求pod，看结果，访问任意一个pod ip12345678910[root@centos07-12 volumes]# kubectl get pods -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESnfs-test-7c77d7b868-d44tr 1/1 Running 0 5m9s 10.244.250.204 centos07-62 &lt;none&gt; &lt;none&gt;nfs-test-7c77d7b868-p9xm7 1/1 Running 0 5m9s 10.244.193.180 centos07-22 &lt;none&gt; &lt;none&gt;nfs-test-7c77d7b868-r4kkr 1/1 Running 0 5m9s 10.244.250.205 centos07-62 &lt;none&gt; &lt;none&gt;[root@centos07-12 volumes]# curl 10.244.250.204Hello, EveryoneMy name is xianchaoMy Chat is luckylucky421302 通过上面可以看到，在共享目录创建的index.html已经被pod挂载了 登录到pod验证下123456[root@centos07-12 volumes]# kubectl exec -it nfs-test-7c77d7b868-r4kkr -- /bin/bashroot@nfs-test-7c77d7b868-r4kkr:/# cat /usr/share/nginx/html/index.htmlHello, EveryoneMy name is xianchaoMy Chat is luckylucky421302 上面说明挂载nfs存储卷成功了，nfs支持多个客户端挂载，可以创建多个pod，挂载同一个nfs服务器共享出来的目录；但是nfs如果宕机了，数据也就丢失了，所以需要使用分布式存储，常见的分布式存储有glusterfs和cephfs 三、k8s持久化存储： PVC参考官网:https://kubernetes.io/docs/concepts/storage/persistent-volumes/#access-modes 3.1.k8s PV是什么？PersistentVolume（PV）是集群中的一块存储，由管理员配置或使用存储类动态配置。 它是集群中的资源，就像pod是k8s集群资源一样。 PV是容量插件，如Volumes，其生命周期独立于使用PV的任何单个pod。个人理解：PV 就是一个后端存储，比如将nfs做成PV 3.2.k8s PVC是什么？PersistentVolumeClaim（PVC）是一个持久化存储卷，我们在创建pod时可以定义这个类型的存储卷。 它类似于一个pod。 Pod消耗节点资源，PVC消耗PV资源。 Pod可以请求特定级别的资源（CPU和内存）。 pvc在申请pv的时候也可以请求特定的大小和访问模式（例如，可以一次读写或多次只读）。个人理解：pvc和pv绑定使用 3.3.k8s PVC和PV工作原理 PV是集群中的资源。 PVC是对这些资源的请求。 PV和PVC之间的相互作用遵循以下生命周期：（1）pv的供应方式可以通过两种方式配置PV：静态或动态。静态的：集群管理员创建了许多PV。它们包含可供集群用户使用的实际存储的详细信息。它们存在于Kubernetes API中，可供使用。动态的：当管理员创建的静态PV都不匹配用户的PersistentVolumeClaim时，集群可能会尝试为PVC专门动态配置卷。此配置基于StorageClasses，PVC必须请求存储类，管理员必须创建并配置该类，以便进行动态配置。（2）绑定用户创建pvc并指定需要的资源和访问模式。在找到可用pv之前，pvc会保持未绑定状态（3）使用a）需要找一个存储服务器，把它划分成多个存储空间；b）k8s管理员可以把这些存储空间定义成多个pv；c）在pod中使用pvc类型的存储卷之前需要先创建pvc，通过定义需要使用的pv的大小和对应的访问模式，找到合适的pv；d）pvc被创建之后，就可以当成存储卷来使用了，我们在定义pod时就可以使用这个pvc的存储卷e）pvc和pv它们是一一对应的关系，pv如果被pvc绑定了，就不能被其他pvc使用了；f）我们在创建pvc的时候，应该确保和底下的pv能绑定，如果没有合适的pv，那么pvc就会处于pending状态。（4）回收策略当我们创建pod时如果使用pvc做为存储卷，那么它会和pv绑定，当删除pod，pvc和pv绑定就会解除，解除之后和pvc绑定的pv卷里的数据需要怎么处理，目前，卷可以保留，回收或删除：RetainRecycle （不推荐使用，1.15可能被废弃了）Delete Retain当删除pvc的时候，pv仍然存在，处于released状态，但是它不能被其他pvc绑定使用，里面的数据还是存在的，当我们下次再使用的时候，数据还是存在的，这个是默认的回收策略 Delete删除pvc时即会从Kubernetes中移除PV，也会从相关的外部设施中删除存储资产 3.4.创建pod，使用pvc作为持久化存储卷 1、创建nfs共享目录在宿主机创建NFS需要的共享目录1234567891011121314[root@centos07-12 volumes]# mkdir /data/volume_test/v&#123;1,2,3,4,5,6,7,8,9,10&#125; -p[root@centos07-12 volumes]# cd /data/volume_test/[root@centos07-12 volume_test]# ll总用量 0drwxr-xr-x 2 root root 6 12月 13 15:03 v1drwxr-xr-x 2 root root 6 12月 13 15:03 v10drwxr-xr-x 2 root root 6 12月 13 15:03 v2drwxr-xr-x 2 root root 6 12月 13 15:03 v3drwxr-xr-x 2 root root 6 12月 13 15:03 v4drwxr-xr-x 2 root root 6 12月 13 15:03 v5drwxr-xr-x 2 root root 6 12月 13 15:03 v6drwxr-xr-x 2 root root 6 12月 13 15:03 v7drwxr-xr-x 2 root root 6 12月 13 15:03 v8drwxr-xr-x 2 root root 6 12月 13 15:03 v9 配置nfs共享宿主机上的&#x2F;data&#x2F;volume_test&#x2F;v1..v10目录12345678910111213# cat /etc/exports/data/volumes 192.168.1.0/24(rw,no_root_squash)/data/volume_test/v1 192.168.1.0/24(rw,no_root_squash)/data/volume_test/v2 192.168.1.0/24(rw,no_root_squash)/data/volume_test/v3 192.168.1.0/24(rw,no_root_squash)/data/volume_test/v4 192.168.1.0/24(rw,no_root_squash)/data/volume_test/v5 192.168.1.0/24(rw,no_root_squash)/data/volume_test/v6 192.168.1.0/24(rw,no_root_squash)/data/volume_test/v7 192.168.1.0/24(rw,no_root_squash)/data/volume_test/v8 192.168.1.0/24(rw,no_root_squash)/data/volume_test/v9 192.168.1.0/24(rw,no_root_squash)/data/volume_test/v10 192.168.1.0/24(rw,no_root_squash) 批量替换方法 :1,$s&#x2F;192.168.1.0/24&#x2F;*&#x2F;g 重新加载配置，使配置成效 12345678910111213[root@centos07-12 volume_test]# exportfs -arvexporting 192.168.1.0/24:/data/volume_test/v10exporting 192.168.1.0/24:/data/volume_test/v9exporting 192.168.1.0/24:/data/volume_test/v8exporting 192.168.1.0/24:/data/volume_test/v7exporting 192.168.1.0/24:/data/volume_test/v6exporting 192.168.1.0/24:/data/volume_test/v5exporting 192.168.1.0/24:/data/volume_test/v4exporting 192.168.1.0/24:/data/volume_test/v3exporting 192.168.1.0/24:/data/volume_test/v2exporting 192.168.1.0/24:/data/volume_test/v1exporting 192.168.1.0/24:/data/volumes 2、如何编写pv的资源清单文件查看定义pv需要的字段123456789101112# kubectl explain pvKIND: PersistentVolumeVERSION: v1DESCRIPTION: PersistentVolume (PV) is a storage resource provisioned by an administrator. It is analogous to a node. More info: https://kubernetes.io/docs/concepts/storage/persistent-volumesFIELDS: apiVersion &lt;string&gt;s kind &lt;string&gt; metadata &lt;Object&gt; spec &lt;Object&gt; 查看定义nfs类型的pv需要的字段12345678# kubectl explain pv.spec.nfsKIND: PersistentVolumeVERSION: v1RESOURCE: nfs &lt;Object&gt;FIELDS: path &lt;string&gt; -required- readOnly &lt;boolean&gt; server &lt;string&gt; -required- 3、创建pv参考：https://kubernetes.io/zh/docs/concepts/storage/persistent-volumes/#reclaiming12345678910111213141516171819202122232425262728293031323334353637383940414243# cat pv.yaml apiVersion: v1kind: PersistentVolumemetadata: name: v1 labels: app: v1spec: nfs: server: 192.168.1.12 path: /data/volume_test/v1 accessModes: [&quot;ReadWriteOnce&quot;] capacity: storage: 1Gi---apiVersion: v1kind: PersistentVolumemetadata: name: v2 labels: app: v2spec: nfs: server: 192.168.1.12 path: /data/volume_test/v2 accessModes: [&quot;ReadOnlyMany&quot;] capacity: storage: 2Gi---apiVersion: v1kind: PersistentVolumemetadata: name: v3 labels: app: v3spec: nfs: server: 192.168.1.12 path: /data/volume_test/v3 accessModes: [&quot;ReadWriteMany&quot;] capacity: storage: 3Gi 1234[root@centos07-12 volumetest]# kubectl apply -f pv.yamlpersistentvolume/v1 createdpersistentvolume/v2 createdpersistentvolume/v3 created 12345[root@centos07-12 volumetest]# kubectl get pv -owide --show-labelsNAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE VOLUMEMODE LABELSv1 1Gi RWO Retain Available 17s Filesystem app=v1v2 2Gi ROX Retain Available 17s Filesystem app=v2v3 3Gi RWX Retain Available 17s Filesystem app=v3 注解：RWO：readwriteonce： 单路读写，允许同一个node节点上的pod访问ROX： readonlymany: 多路只读，允许不通node节点的pod以只读方式访问RWX： readwritemany： 多路读写，允许不同的node节点的pod以读写方式访问 4、创建pvc，和符合条件的pv绑定1234567891011121314151617181920212223242526272829303132333435363738394041# cat pvc.yaml apiVersion: v1kind: PersistentVolumeClaimmetadata: name: pvc-v1spec: accessModes: [&quot;ReadWriteOnce&quot;] selector: matchLabels: app: v1 resources: requests: storage: 1Gi---apiVersion: v1kind: PersistentVolumeClaimmetadata: name: pvc-v2spec: accessModes: [&quot;ReadOnlyMany&quot;] selector: matchLabels: app: v2 resources: requests: storage: 2Gi---apiVersion: v1kind: PersistentVolumeClaimmetadata: name: pvc-v3spec: accessModes: [&quot;ReadWriteMany&quot;] selector: matchLabels: app: v3 resources: requests: storage: 3Gi 1234[root@centos07-12 volumetest]# kubectl apply -f pvc.yamlpersistentvolumeclaim/pvc-v1 createdpersistentvolumeclaim/pvc-v2 createdpersistentvolumeclaim/pvc-v3 created 12345[root@centos07-12 volumetest]# kubectl get pvc -owideNAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE VOLUMEMODEpvc-v1 Bound v1 1Gi RWO 8s Filesystempvc-v2 Bound v2 2Gi ROX 8s Filesystempvc-v3 Bound v3 3Gi RWX 8s Filesystem 看到pvc的status都是bound状态，就说明pvc跟pv已经绑定了 5、创建pod，挂载pvc123456789101112131415161718192021222324252627282930# cat pod_pvc.yaml apiVersion: apps/v1kind: Deploymentmetadata: name: pvc-testspec: replicas: 3 selector: matchLabels: cunchu: pvc template: metadata: labels: cunchu: pvc spec: containers: - name: test-pvc image: docker.io/library/nginx:latest imagePullPolicy: IfNotPresent ports: - containerPort: 80 protocol: TCP volumeMounts: - name: nginx-html mountPath: /usr/share/nginx/html volumes: - persistentVolumeClaim: claimName: pvc-v1 name: nginx-html 12[root@centos07-12 volumetest]# kubectl apply -f pod_pvc.yamldeployment.apps/pvc-test created 12345[root@centos07-12 volumetest]# kubectl get pods -owide --show-labelsNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES LABELSpvc-test-6447ddff88-brhxw 1/1 Running 0 22s 10.244.250.207 centos07-62 &lt;none&gt; &lt;none&gt; cunchu=pvc,pod-template-hash=6447ddff88pvc-test-6447ddff88-ngt4j 1/1 Running 0 22s 10.244.193.182 centos07-22 &lt;none&gt; &lt;none&gt; cunchu=pvc,pod-template-hash=6447ddff88pvc-test-6447ddff88-x9262 1/1 Running 0 22s 10.244.250.208 centos07-62 &lt;none&gt; &lt;none&gt; cunchu=pvc,pod-template-hash=6447ddff88 centos07-1212cd /data/volume_test/v1mkdir lucky 12345[root@centos07-12 v1]# kubectl exec -it pvc-test-6447ddff88-x9262 -- /bin/bashroot@pvc-test-6447ddff88-x9262:/#root@pvc-test-6447ddff88-x9262:/# cd /usr/share/nginx/html/root@pvc-test-6447ddff88-x9262:/usr/share/nginx/html# lslucky 注：使用pvc和pv的注意事项1、我们每次创建pvc的时候，需要事先有划分好的pv，这样可能不方便，那么可以在创建pvc的时候直接动态创建一个pv这个存储类，pv事先是不存在的2、pvc和pv绑定，如果使用默认的回收策略retain，那么删除pvc之后，pv会处于released状态，我们想要继续使用这个pv，需要手动删除pv，kubectl delete pv pv_name，删除pv，不会删除pv里的数据，当我们重新创建pvc时还会和这个最匹配的pv绑定，数据还是原来数据，不会丢失。 经过测试，如果回收策略是Delete，删除pv，pv后端存储的数据也不会被删除 回收策略：persistentVolumeReclaimPolicy字段删除pvc的步骤：需要先删除使用pvc的pod再删除pvc 12[root@centos07-12 volumetest]# kubectl delete -f pod_pvc.yamldeployment.apps &quot;pvc-test&quot; deleted 12345[root@centos07-12 volumetest]# kubectl get pvc -owideNAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE VOLUMEMODEpvc-v1 Bound v1 1Gi RWO 18m Filesystempvc-v2 Bound v2 2Gi ROX 18m Filesystempvc-v3 Bound v3 3Gi RWX 18m Filesystem 12[root@centos07-12 volumetest]# kubectl delete pvc pvc-v1persistentvolumeclaim &quot;pvc-v1&quot; deleted 演示pv用Delete回收策略：1234567891011121314151617# vim pv-1.yamlapiVersion: v1kind: PersistentVolumemetadata: name: v4 labels: app: v4spec: nfs: server: 192.168.1.12 path: /data/volume_test/v4 accessModes: [&quot;ReadWriteOnce&quot;] capacity: storage: 1Gi persistentVolumeReclaimPolicy: Delete 12[root@centos07-12 volumetest]# kubectl apply -f pv-1.yamlpersistentvolume/v4 created 1234567891011121314# vim pvc-1.yaml apiVersion: v1kind: PersistentVolumeClaimmetadata: name: pvc-v4spec: accessModes: [&quot;ReadWriteOnce&quot;] selector: matchLabels: app: v4 resources: requests: storage: 1Gi 12[root@centos07-12 volumetest]# kubectl apply -f pvc-1.yamlpersistentvolumeclaim/pvc-v4 created 123[root@centos07-12 volumetest]# kubectl get pvc -owide --show-labelsNAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE VOLUMEMODE LABELSpvc-v4 Bound v4 1Gi RWO 45s Filesystem &lt;none&gt; 123456789101112131415161718192021222324252627282930# cat pod_pvc-2.yaml apiVersion: apps/v1kind: Deploymentmetadata: name: pvc-test-1spec: replicas: 3 selector: matchLabels: cunchu: pvc-1 template: metadata: labels: cunchu: pvc-1 spec: containers: - name: test-pvc image: docker.io/library/nginx:latest imagePullPolicy: IfNotPresent ports: - containerPort: 80 protocol: TCP volumeMounts: - name: nginx-html mountPath: /usr/share/nginx/html volumes: - persistentVolumeClaim: claimName: pvc-v4 name: nginx-html 12[root@centos07-12 volumetest]# kubectl apply -f pod_pvc-2.yamldeployment.apps/pvc-test-1 created 123cd /data/volume_test/v4/lsmkdir lucky 12345[root@centos07-12 v4]# kubectl get pods -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESpvc-test-1-6f57777995-6rdlt 1/1 Running 0 107s 10.244.193.183 centos07-22 &lt;none&gt; &lt;none&gt;pvc-test-1-6f57777995-7nlxb 1/1 Running 0 107s 10.244.250.210 centos07-62 &lt;none&gt; &lt;none&gt;pvc-test-1-6f57777995-8wmhd 1/1 Running 0 107s 10.244.250.209 centos07-62 &lt;none&gt; &lt;none&gt; 1234[root@centos07-12 v4]# kubectl exec -it pvc-test-1-6f57777995-8wmhd -- /bin/bashroot@pvc-test-1-6f57777995-8wmhd:/# cd /usr/share/nginx/html/root@pvc-test-1-6f57777995-8wmhd:/usr/share/nginx/html# lslucky","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"22-Service四层代理基本介绍","slug":"运维/K8S/基础/22-Service四层代理基本介绍","date":"2023-05-11T02:00:00.000Z","updated":"2023-12-13T02:23:32.000Z","comments":true,"path":"2023/05/11/运维/K8S/基础/22-Service四层代理基本介绍/","link":"","permalink":"https://dbbruce.github.io/2023/05/11/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/22-Service%E5%9B%9B%E5%B1%82%E4%BB%A3%E7%90%86%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D/","excerpt":"一、四层负载均衡Service：概念、原理解读1.1.为什么要有Service？在kubernetes中，Pod是有生命周期的，如果Pod重启它的IP很有可能会发生变化。如果我们的服务都是将Pod的IP地址写死，Pod挂掉或者重启，和刚才重启的pod相关联的其他服务将会找不到它所关联的Pod，为了解决这个问题，在kubernetes中定义了service资源对象，Service 定义了一个服务访问的入口，客户端通过这个入口即可访问服务背后的应用集群实例，service是一组Pod的逻辑集合，这一组Pod能够被Service访问到，通常是通过Label Selector实现的。","text":"一、四层负载均衡Service：概念、原理解读1.1.为什么要有Service？在kubernetes中，Pod是有生命周期的，如果Pod重启它的IP很有可能会发生变化。如果我们的服务都是将Pod的IP地址写死，Pod挂掉或者重启，和刚才重启的pod相关联的其他服务将会找不到它所关联的Pod，为了解决这个问题，在kubernetes中定义了service资源对象，Service 定义了一个服务访问的入口，客户端通过这个入口即可访问服务背后的应用集群实例，service是一组Pod的逻辑集合，这一组Pod能够被Service访问到，通常是通过Label Selector实现的。 可以看下面的图： 1、pod ip经常变化，service是pod的代理，我们客户端访问，只需要访问service，就会把请求代理到Pod 2、pod ip在k8s集群之外无法访问，所以需要创建service，这个service可以在k8s集群外访问的。 1.2.Service概述service是一个固定接入层，客户端可以通过访问service的ip和端口访问到service关联的后端pod，这个service工作依赖于在kubernetes集群之上部署的一个附件，就是kubernetes的dns服务（不同kubernetes版本的dns默认使用的也是不一样的，1.11之前的版本使用的是kubeDNs，较新的版本使用的是coredns），service的名称解析是依赖于dns附件的，因此在部署完k8s之后需要再部署dns附件，kubernetes要想给客户端提供网络功能，需要依赖第三方的网络插件（flannel，calico等）。每个K8s节点上都有一个组件叫做kube-proxy，kube-proxy这个组件将始终监视着apiserver中有关service资源的变动信息，需要跟master之上的apiserver交互，随时连接到apiserver上获取任何一个与service资源相关的资源变动状态，这种是通过kubernetes中固有的一种请求方法watch（监视）来实现的，一旦有service资源的内容发生变动（如创建，删除），kube-proxy都会将它转化成当前节点之上的能够实现service资源调度，把我们请求调度到后端特定的pod资源之上的规则，这个规则可能是iptables，也可能是ipvs，取决于service的实现方式。 1.3.Service工作原理k8s在创建Service时，会根据标签选择器selector(lable selector)来查找Pod，据此创建与Service同名的endpoint对象，当Pod 地址发生变化时，endpoint也会随之发生变化，service接收前端client请求的时候，就会通过endpoint，找到转发到哪个Pod进行访问的地址。(至于转发到哪个节点的Pod，由负载均衡kube-proxy决定) 1.4.kubernetes集群中有三类IP地址 1.4.1.Node Network（节点网络）：物理节点或者虚拟节点的网络，如ens33接口上的网路地址123[root@centos07-12 replicasettest]# ip addr |grep enp0s33: enp0s3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 inet 192.168.1.12/24 brd 192.168.1.255 scope global noprefixroute enp0s3 1.4.2.Pod network（pod 网络），创建的Pod具有的IP地址123[root@centos07-12 replicasettest]# kubectl get pods -n blue-green -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESmyapp-v1-6bb9cb95bd-n54f9 1/1 Running 0 2d20h 10.244.250.255 centos07-62 &lt;none&gt; &lt;none&gt; Node Network和Pod network这两种网络地址是我们实实在在配置的，其中节点网络地址是配置在节点接口之上，而pod网络地址是配置在pod资源之上的，因此这些地址都是配置在某些设备之上的，这些设备可能是硬件，也可能是软件模拟的 1.4.3.Cluster Network（集群地址，也称为service network），这个地址是虚拟的地址（virtual ip），没有配置在某个接口上，只是出现在service的规则当中。1234[root@centos07-12 replicasettest]# kubectl get svcNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGEkubernetes ClusterIP 10.96.0.1 &lt;none&gt; 443/TCP 9dspringboot NodePort 10.106.160.209 &lt;none&gt; 8080:31180/TCP,8081:31181/TCP 4d20h 二、创建Service资源2.1.查看定义Service资源需要的字段有哪些1234567891011121314kubectl explain serviceKIND: ServiceVERSION: v1DESCRIPTION: Service is a named abstraction of software service (for example, mysql) consisting of local port (for example 3306) that the proxy listens on, and the selector that determines which pods will answer requests sent through the proxy.FIELDS: apiVersion &lt;string&gt; #service资源使用的api组 kind &lt;string&gt; #创建的资源类型 metadata &lt;Object&gt; #定义元数据 spec &lt;Object&gt; 2.2.查看service的spec字段如何定义123456789101112131415161718192021222324252627282930313233343536373839kubectl explain service.specKIND: ServiceVERSION: v1RESOURCE: spec &lt;Object&gt;DESCRIPTION: Spec defines the behavior of a service. https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status ServiceSpec describes the attributes that a user creates on a service.FIELDS: allocateLoadBalancerNodePorts &lt;boolean&gt; clusterIP &lt;string&gt; #动态分配的地址，也可以自己在创建的时候指定，创建之后就改不了了 clusterIPs &lt;[]string&gt; externalIPs &lt;[]string&gt; externalName &lt;string&gt; externalTrafficPolicy &lt;string&gt; healthCheckNodePort &lt;integer&gt; ipFamilies &lt;[]string&gt; ipFamilyPolicy &lt;string&gt; loadBalancerIP &lt;string&gt; loadBalancerSourceRanges &lt;[]string&gt; ports &lt;[]Object&gt; #定义service端口，用来和后端pod建立联系 publishNotReadyAddresses &lt;boolean&gt; selector &lt;map[string]string&gt; #通过标签选择器选择关联的pod有哪些 sessionAffinity &lt;string&gt; #service在实现负载均衡的时候还支持sessionAffinity，sessionAffinity什么意思？会话联系，默认是none，随机调度的（基于iptables规则调度的）；如果我们定义sessionAffinity的client ip，那就表示把来自同一客户端的IP请求调度到同一个pod上 sessionAffinityConfig &lt;Object&gt; topologyKeys &lt;[]string&gt; type &lt;string&gt; #定义service的类型 三.Service的四种类型3.1.查看定义Service.spec.type需要的字段有哪些?1234567891011121314151617181920kubectl explain service.spec.typeKIND: ServiceVERSION: v1FIELD: type &lt;string&gt;DESCRIPTION: type determines how the Service is exposed. Defaults to ClusterIP. Valid options are ExternalName, ClusterIP, NodePort, and LoadBalancer. &quot;ClusterIP&quot; allocates a cluster-internal IP address for load-balancing to endpoints. Endpoints are determined by the selector or if that is not specified, by manual construction of an Endpoints object or EndpointSlice objects. If clusterIP is &quot;None&quot;, no virtual IP is allocated and the endpoints are published as a set of endpoints rather than a virtual IP. &quot;NodePort&quot; builds on ClusterIP and allocates a port on every node which routes to the same endpoints as the clusterIP. &quot;LoadBalancer&quot; builds on NodePort and creates an external load-balancer (if supported in the current cloud) which routes to the same endpoints as the clusterIP. &quot;ExternalName&quot; aliases this service to the specified externalName. Several other fields do not apply to ExternalName services. More info: https://kubernetes.io/docs/concepts/services-networking/service/#publishing-services-service-types 四.Service的端口4.1.1 查看service的spec.ports字段如何定义？1234567891011121314151617kubectl explain service.spec.portsKIND: ServiceVERSION: v1RESOURCE: ports &lt;[]Object&gt;DESCRIPTION: The list of ports that are exposed by this service. More info: https://kubernetes.io/docs/concepts/services-networking/service/#virtual-ips-and-service-proxies ServicePort contains information on service&#x27;s port.FIELDS: appProtocol &lt;string&gt; name &lt;string&gt; #定义端口的名字 nodePort &lt;integer&gt; #service在物理机映射的端口，默认在 30000-32767 之间 port &lt;integer&gt; -required- #service的端口，这个是k8s集群内部服务可访问的端口 protocol &lt;string&gt; targetPort &lt;string&gt; #targetPort是pod上的端口，从port和nodePort上来的流量，经过kube-proxy流入到后端pod的targetPort上，最后进入容器。 五.创建Service5.1.type类型是ClusterIP 把nginx.tar.gz上传到centos07-22&#x2F;62，手动解压1ctr -n=k8s.io images import nginx.tar.gz 创建2个pod12345678910111213141516171819202122232425262728293031323334353637383940414243444546# cat pod_test.yaml apiVersion: apps/v1kind: Deploymentmetadata: name: my-nginxspec: selector: matchLabels: run: my-nginx replicas: 2 template: metadata: labels: run: my-nginx spec: containers: - name: my-nginx image: docker.io/library/nginx:latest imagePullPolicy: IfNotPresent ports: - containerPort: 80 #pod中的容器需要暴露的端口 startupProbe: periodSeconds: 5 initialDelaySeconds: 60 timeoutSeconds: 10 httpGet: scheme: HTTP port: 80 path: / livenessProbe: periodSeconds: 5 initialDelaySeconds: 60 timeoutSeconds: 10 httpGet: scheme: HTTP port: 80 path: / readinessProbe: periodSeconds: 5 initialDelaySeconds: 60 timeoutSeconds: 10 httpGet: scheme: HTTP port: 80 path: / 更新资源清单文件1kubectl apply -f pod_test.yaml 查看刚才创建的Pod ip地址1kubectl get pods -l run=my-nginx -o wide 1234[root@centos07-12 servicetest]# kubectl get pods -l run=my-nginx -o wide --show-labelsNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES LABELSmy-nginx-77f64d8c6b-62wns 1/1 Running 0 3m29s 10.244.193.173 centos07-22 &lt;none&gt; &lt;none&gt; pod-template-hash=77f64d8c6b,run=my-nginxmy-nginx-77f64d8c6b-9cnmq 1/1 Running 0 3m29s 10.244.250.194 centos07-62 &lt;none&gt; &lt;none&gt; pod-template-hash=77f64d8c6b,run=my-nginx 请求pod ip地址，查看结果12345[root@centos07-12 servicetest]# curl 10.244.250.194&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;title&gt;Welcome to nginx!&lt;/title&gt; 123456[root@centos07-12 servicetest]# curl 10.244.193.172&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;title&gt;Welcome to nginx!&lt;/title&gt;&lt;style&gt; 123456789101112131415161718192021222324252627[root@centos07-12 servicetest]# kubectl exec -it my-nginx-77f64d8c6b-62wns -- sh# curl 10.244.250.194&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;title&gt;Welcome to nginx!&lt;/title&gt;&lt;style&gt; body &#123; width: 35em; margin: 0 auto; font-family: Tahoma, Verdana, Arial, sans-serif; &#125;&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;&lt;p&gt;If you see this page, the nginx web server is successfully installed andworking. Further configuration is required.&lt;/p&gt;&lt;p&gt;For online documentation and support please refer to&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;Commercial support is available at&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;&lt;/body&gt;&lt;/html&gt; 需要注意的是，pod虽然定义了容器端口，但是不会使用调度到该节点上的80端口，也不会使用任何特定的NAT规则去路由流量到Pod上。 这意味着可以在同一个节点上运行多个 Pod，使用相同的容器端口，并且可以从集群中任何其他的Pod或节点上使用IP的方式访问到它们 误删除其中一个Pod1kubectl delete pods my-nginx-77f64d8c6b-62wns 12[root@centos07-12 servicetest]# kubectl delete pods my-nginx-77f64d8c6b-62wnspod &quot;my-nginx-77f64d8c6b-62wns&quot; deleted 1234[root@centos07-12 servicetest]# kubectl get pods -l run=my-nginx -o wideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESmy-nginx-77f64d8c6b-8t4km 1/1 Running 0 5m23s 10.244.193.174 centos07-22 &lt;none&gt; &lt;none&gt;my-nginx-77f64d8c6b-9cnmq 1/1 Running 0 19m 10.244.250.194 centos07-62 &lt;none&gt; &lt;none&gt; 通过上面可以看到重新生成了一个pod ：my-nginx-77f64d8c6b-8t4km，ip是10.244.193.174，在k8s中创建pod，如果pod被删除了，重新生成的pod ip地址会发生变化，所以需要在pod前端加一个固定接入层。接下来创建service： 查看pod标签1234[root@centos07-12 servicetest]# kubectl get pods --show-labelsNAME READY STATUS RESTARTS AGE LABELSmy-nginx-77f64d8c6b-8t4km 1/1 Running 0 6m26s pod-template-hash=77f64d8c6b,run=my-nginxmy-nginx-77f64d8c6b-9cnmq 1/1 Running 0 20m pod-template-hash=77f64d8c6b,run=my-nginx 创建 clusterip server12345678910111213141516# cat service_test.yaml apiVersion: v1kind: Servicemetadata: name: my-nginx labels: run: my-nginxspec: type: ClusterIP ports: - port: 80 #service的端口，暴露给k8s集群内部服务访问 protocol: TCP targetPort: 80 #pod容器中定义的端口 selector: run: my-nginx #选择拥有run=my-nginx标签的pod 上述yaml文件将创建一个 Service，具有标签run&#x3D;my-nginx的Pod，目标TCP端口 80，并且在一个抽象的Service端口（targetPort：容器接收流量的端口；port：抽象的 Service 端口，可以使任何其它 Pod访问该 Service 的端口）上暴露 12[root@centos07-12 servicetest]# kubectl apply -f service_test.yamlservice/my-nginx created 1234[root@centos07-12 servicetest]# kubectl get svc -owideNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTORkubernetes ClusterIP 10.96.0.1 &lt;none&gt; 443/TCP 9d &lt;none&gt;my-nginx ClusterIP 10.101.207.148 &lt;none&gt; 80/TCP 65s run=my-nginx 123[root@centos07-12 servicetest]# kubectl get svc -l run=my-nginxNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGEmy-nginx ClusterIP 10.101.207.148 &lt;none&gt; 80/TCP 2m25s 在k8s控制节点访问service的ip:端口就可以把请求代理到后端pod1234567[root@centos07-12 servicetest]# curl 10.101.207.148&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;title&gt;Welcome to nginx!&lt;/title&gt;&lt;style&gt; 通过上面可以看到请求service IP:port跟直接访问pod ip:port看到的结果一样，这就说明service可以把请求代理到它所关联的后端pod注意：上面的10.99.198.177:80地址只能是在k8s集群内部可以访问，在外部无法访问，比方说我们想要通过浏览器访问，那么是访问不通的，如果想要在k8s集群之外访问，是需要把service type类型改成nodePort的 查看service详细信息12345678910111213141516[root@centos07-12 servicetest]# kubectl describe svc my-nginxName: my-nginxNamespace: defaultLabels: run=my-nginxAnnotations: &lt;none&gt;Selector: run=my-nginxType: ClusterIPIP Family Policy: SingleStackIP Families: IPv4IP: 10.101.207.148IPs: 10.101.207.148Port: &lt;unset&gt; 80/TCPTargetPort: 80/TCPEndpoints: 10.244.193.174:80,10.244.250.194:80Session Affinity: NoneEvents: &lt;none&gt; 123[root@centos07-12 servicetest]# kubectl get ep my-nginxNAME ENDPOINTS AGEmy-nginx 10.244.193.174:80,10.244.250.194:80 7m59s service可以对外提供统一固定的ip地址，并将请求重定向至集群中的pod。其中“将请求重定向至集群中的pod”就是通过endpoint与selector协同工作实现。selector是用于选择pod，由selector选择出来的pod的ip地址和端口号，将会被记录在endpoint中。endpoint便记录了所有pod的ip地址和端口号。当一个请求访问到service的ip地址时，就会从endpoint中选择出一个ip地址和端口号，然后将请求重定向至pod中。具体把请求代理到哪个pod，需要的就是kube-proxy的轮询实现的。service不会直接到pod，service是直接到endpoint资源，就是地址加端口，再由endpoint再关联到pod。 service只要创建完成，我们就可以直接解析它的服务名，每一个服务创建完成后都会在集群dns中动态添加一个资源记录，添加完成后我们就可以解析了，资源记录格式是:SVC_NAME.NS_NAME.DOMAIN.LTD.服务名.命名空间.域名后缀集群默认的域名后缀是svc.cluster.local.就像我们上面创建的my-nginx这个服务，它的完整名称解析就是my-nginx.default.svc.cluster.local 域名123456789101112131415161718192021222324252627[root@centos07-12 servicetest]# kubectl exec -it my-nginx-77f64d8c6b-9cnmq -- /bin/bashroot@my-nginx-77f64d8c6b-9cnmq:/# curl my-nginx.default.svc.cluster.local&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;title&gt;Welcome to nginx!&lt;/title&gt;&lt;style&gt; body &#123; width: 35em; margin: 0 auto; font-family: Tahoma, Verdana, Arial, sans-serif; &#125;&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;&lt;p&gt;If you see this page, the nginx web server is successfully installed andworking. Further configuration is required.&lt;/p&gt;&lt;p&gt;For online documentation and support please refer to&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;Commercial support is available at&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;&lt;/body&gt;&lt;/html&gt; ipvsadm -Ln rr 轮询 endpoints1234[root@centos07-12 servicetest]# kubectl get epNAME ENDPOINTS AGEkubernetes 192.168.1.12:6443 9dmy-nginx 10.244.193.174:80,10.244.250.194:80 54m 1234[root@centos07-12 servicetest]# kubectl get endpointsNAME ENDPOINTS AGEkubernetes 192.168.1.12:6443 9dmy-nginx 10.244.193.174:80,10.244.250.194:80 54m my-nginx.default.svc.cluster.local，这个域名只能在pod里访问 5.2.type类型是NodePort 创建一个pod资源12345678910111213141516171819202122# cat pod_nodeport.yamlapiVersion: apps/v1kind: Deploymentmetadata: name: my-nginx-nodeportspec: selector: matchLabels: run: my-nginx-nodeport replicas: 2 template: metadata: labels: run: my-nginx-nodeport spec: containers: - name: my-nginx-nodeport-container image: nginx imagePullPolicy: IfNotPresent ports: - containerPort: 80 更新资源清单文件12kubectl apply -f pod_nodeport.yamldeployment.apps/my-nginx-nodeport created 查看pod是否创建成功1234[root@centos07-12 servicetest]# kubectl get pods -l run=my-nginx-nodeport -owide --show-labelsNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES LABELSmy-nginx-nodeport-7f7f67b7d6-7bbxk 1/1 Running 0 79s 10.244.250.197 centos07-62 &lt;none&gt; &lt;none&gt; pod-template-hash=7f7f67b7d6,run=my-nginx-nodeportmy-nginx-nodeport-7f7f67b7d6-vdf9l 1/1 Running 0 79s 10.244.193.176 centos07-22 &lt;none&gt; &lt;none&gt; pod-template-hash=7f7f67b7d6,run=my-nginx-nodeport 创建service，代理pod12345678910111213141516# cat service_nodeport.yaml apiVersion: v1kind: Servicemetadata: name: my-nginx-nodeport labels: run: my-nginx-nodeportspec: type: NodePort ports: - port: 80 protocol: TCP targetPort: 80 nodePort: 30380 selector: run: my-nginx-nodeport 更新资源清单文件12[root@centos07-12 servicetest]# kubectl apply -f service_nodeport.yamlservice/my-nginx-nodeport created 查看刚才创建的service123[root@centos07-12 servicetest]# kubectl get svc -l run=my-nginx-nodeport -owideNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTORmy-nginx-nodeport NodePort 10.96.16.147 &lt;none&gt; 80:30380/TCP 10m run=my-nginx-nodeport 访问service1234567891011121314151617181920212223242526root@centos07-12 servicetest]# curl 10.96.16.147&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;title&gt;Welcome to nginx!&lt;/title&gt;&lt;style&gt; body &#123; width: 35em; margin: 0 auto; font-family: Tahoma, Verdana, Arial, sans-serif; &#125;&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;&lt;p&gt;If you see this page, the nginx web server is successfully installed andworking. Further configuration is required.&lt;/p&gt;&lt;p&gt;For online documentation and support please refer to&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;Commercial support is available at&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;&lt;/body&gt;&lt;/html&gt; 注意：10.96.16.147 是k8s集群内部的service ip地址，只能在k8s集群内部访问，在集群外无法访问。 在集群外访问service123456[root@centos07-12 servicetest]# curl 192.168.1.12:30380&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;title&gt;Welcome to nginx!&lt;/title&gt;&lt;style&gt; 在浏览器访问service: http://192.168.1.12:30380/ 数据转发流程1234567[root@centos07-12 servicetest]# ipvsadm -LnIP Virtual Server version 1.2.1 (size=4096)Prot LocalAddress:Port Scheduler Flags -&gt; RemoteAddress:Port Forward Weight ActiveConn InActConnTCP 172.17.0.1:30380 rr -&gt; 10.244.193.176:80 Masq 1 0 0 -&gt; 10.244.250.197:80 Masq 1 0 0 客户端请求http://192.168.1.12:30380-&gt;docker0虚拟网卡:172.17.0.1:30380-&gt;10.244.193.176:80,10.244.250.197:80 123[root@centos07-12 servicetest]# ip addr|grep docker04: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0 5.3.type类型是ExternalName 应用场景：跨名称空间访问 需求：default名称空间下的client 服务想要访问nginx-ns名称空间下的nginx-svc服务 需要把busybox.tar.gz上传到centos07-22&#x2F;62上，手动解压，1ctr -n=k8s.io images import busybox.tar.gz 创建命名空间：nginx-ns12[root@centos07-12 servicetest]# kubectl create ns nginx-nsnamespace/nginx-ns created 1234567[root@centos07-12 servicetest]# kubectl get nsNAME STATUS AGEdefault Active 9dkube-node-lease Active 9dkube-public Active 9dkube-system Active 9dnginx-ns Active 4s 创建deployment, 命名空间:nginx-ns123456789101112131415161718192021# cat server_nginx.yaml apiVersion: apps/v1kind: Deploymentmetadata: name: nginx namespace: nginx-nsspec: replicas: 1 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx imagePullPolicy: IfNotPresent 1kubectl apply -f server_nginx.yaml 查看pod是否创建成功123[root@centos07-12 servicetest]# kubectl get pods -n nginx-ns -owide --show-labelsNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES LABELSnginx-5f5c64f949-7m47l 1/1 Running 0 2m39s 10.244.250.198 centos07-62 &lt;none&gt; &lt;none&gt; app=nginx,pod-template-hash=5f5c64f949 创建service， 命名空间:nginx-ns1234567891011121314]# cat nginx_svc.yaml apiVersion: v1kind: Servicemetadata: name: nginx-svc namespace: nginx-nsspec: selector: app: nginx ports: - name: http protocol: TCP port: 80 targetPort: 80 12[root@centos07-12 servicetest]# kubectl apply -f nginx_svc.yamlservice/nginx-svc created 创建deployment，命名空间：default123456789101112131415161718192021# cat client.yaml apiVersion: apps/v1kind: Deploymentmetadata: name: clientspec: replicas: 1 selector: matchLabels: app: busybox template: metadata: labels: app: busybox spec: containers: - name: busybox image: busybox imagePullPolicy: IfNotPresent command: [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;sleep 36000&quot;] 12[root@centos07-12 servicetest]# kubectl apply -f client.yamldeployment.apps/client created 创建service，命名空间：default123456789101112# cat client_svc.yaml apiVersion: v1kind: Servicemetadata: name: client-svcspec: type: ExternalName externalName: nginx-svc.nginx-ns.svc.cluster.local #service名称.命名空间。svc.cluster.local ports: - name: http port: 80 targetPort: 80 12[root@centos07-12 servicetest]# kubectl apply -f client_svc.yamlservice/client-svc created 1234[root@centos07-12 servicetest]# kubectl get svc -owide --show-labelsNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTOR LABELSclient-svc ExternalName &lt;none&gt; nginx-svc.nginx-ns.svc.cluster.local 80/TCP 20s &lt;none&gt; &lt;none&gt;kubernetes ClusterIP 10.96.0.1 &lt;none&gt; 443/TCP 9d &lt;none&gt; component=apiserver,provider=kubernetes 该文件中指定了到 nginx-svc 的软链，让使用者感觉就好像调用自己命名空间的服务一样。 查看pod是否正常运行123[root@centos07-12 servicetest]# kubectl get podsNAME READY STATUS RESTARTS AGEclient-5d97b75948-z2skf 1/1 Running 0 27m 登录到client pod client-svc.default.svc.cluster.local 和 nginx-svc.nginx-ns.svc.cluster.local 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960[root@centos07-12 servicetest]# kubectl exec -it client-5d97b75948-z2skf -- /bin/sh# 1、default命名空间的域名/ # wget -q -O - client-svc.default.svc.cluster.local&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;title&gt;Welcome to nginx!&lt;/title&gt;&lt;style&gt; body &#123; width: 35em; margin: 0 auto; font-family: Tahoma, Verdana, Arial, sans-serif; &#125;&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;&lt;p&gt;If you see this page, the nginx web server is successfully installed andworking. Further configuration is required.&lt;/p&gt;&lt;p&gt;For online documentation and support please refer to&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;Commercial support is available at&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;# 2、nginx-ns命名空间的域名/ # wget -q -O - nginx-svc.nginx-ns.svc.cluster.local&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;title&gt;Welcome to nginx!&lt;/title&gt;&lt;style&gt; body &#123; width: 35em; margin: 0 auto; font-family: Tahoma, Verdana, Arial, sans-serif; &#125;&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;&lt;p&gt;If you see this page, the nginx web server is successfully installed andworking. Further configuration is required.&lt;/p&gt;&lt;p&gt;For online documentation and support please refer to&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;Commercial support is available at&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;/ # 上面两个请求的结果一样 5.4.k8s最佳实践：映射外部服务案例分享 场景1：k8s集群引用外部的mysql数据库 centos07-22上安装mysql数据库：1yum install mariadb-server.x86_64 -y 1systemctl start mariadb 123456789# cat mysql_service.yaml apiVersion: v1kind: Servicemetadata: name: mysqlspec: type: ClusterIP ports: - port: 3306 12[root@centos07-12 servicetest]# kubectl apply -f mysql_service.yamlservice/mysql created 12[root@centos07-12 servicetest]# kubectl get svc | grep mysqlmysql ClusterIP 10.111.145.204 &lt;none&gt; 12345678910111213141516[root@centos07-12 servicetest]# kubectl describe svc mysqlName: mysqlNamespace: defaultLabels: &lt;none&gt;Annotations: &lt;none&gt;Selector: &lt;none&gt;Type: ClusterIPIP Family Policy: SingleStackIP Families: IPv4IP: 10.111.145.204IPs: 10.111.145.204Port: &lt;unset&gt; 3306/TCPTargetPort: 3306/TCP Endpoints: &lt;none&gt; #还没有endpointSession Affinity: NoneEvents: &lt;none&gt; 1234567891011# cat mysql_endpoint.yaml apiVersion: v1kind: Endpointsmetadata: name: mysqlsubsets:- addresses: - ip: 192.168.1.12 ports: - port: 3306 12[root@centos07-12 servicetest]# kubectl apply -f mysql_endpoint.yamlendpoints/mysql created 12345678910111213141516[root@centos07-12 servicetest]# kubectl describe svc mysqlName: mysqlNamespace: defaultLabels: &lt;none&gt;Annotations: &lt;none&gt;Selector: &lt;none&gt;Type: ClusterIPIP Family Policy: SingleStackIP Families: IPv4IP: 10.111.145.204IPs: 10.111.145.204Port: &lt;unset&gt; 3306/TCPTargetPort: 3306/TCPEndpoints: 192.168.1.12:3306 #这个就是定义的外部数据库Session Affinity: NoneEvents: &lt;none&gt; 上面配置就是将外部IP地址和服务引入到k8s集群内部，由service作为一个代理来达到能够访问外部服务的目的。 5.5.Service服务发现：coredns组件详解 DNS是什么？DNS全称是Domain Name System：域名系统，是整个互联网的电话簿，它能够将可被人理解的域名翻译成可被机器理解IP地址，使得互联网的使用者不再需要直接接触很难阅读和理解的IP地址。域名系统在现在的互联网中非常重要，因为服务器的 IP 地址可能会经常变动，如果没有了 DNS，那么可能 IP 地址一旦发生了更改，当前服务器的客户端就没有办法连接到目标的服务器了，如果我们为 IP 地址提供一个『别名』并在其发生变动时修改别名和 IP 地址的关系，那么我们就可以保证集群对外提供的服务能够相对稳定地被其他客户端访问。DNS 其实就是一个分布式的树状命名系统，它就像一个去中心化的分布式数据库，存储着从域名到 IP 地址的映射。 CoreDNS？CoreDNS 其实就是一个 DNS 服务，而 DNS 作为一种常见的服务发现手段，所以很多开源项目以及工程师都会使用 CoreDNS 为集群提供服务发现的功能，Kubernetes 就在集群中使用 CoreDNS 解决服务发现的问题。 作为一个加入 CNCF（Cloud Native Computing Foundation）的服务， CoreDNS 的实现非常简单。 验证coredns 把dig.tar.gz上传到centos07-22&#x2F;62机器上，手动解压：1ctr -n=k8s.io images import dig.tar.gz 12345678910111213141516# cat dig.yaml apiVersion: v1kind: Podmetadata: name: dig namespace: defaultspec: containers: - name: dig image: docker.io/xianchao/dig:latest imagePullPolicy: IfNotPresent command: - sleep - &quot;3600&quot; restartPolicy: Always 更新资源清单文件12[root@centos07-12 servicetest]# kubectl apply -f dig.yamlpod/dig created 查看默认名称空间的kubernetes服务12[root@centos07-12 servicetest]# kubectl get svc | grep kuberneteskubernetes ClusterIP 10.96.0.1 &lt;none&gt; 443/TCP 9d 解析dns，如有以下返回说明dns安装成功123456[root@centos07-12 servicetest]# kubectl exec -it dig -- nslookup kubernetesServer: 10.96.0.10Address: 10.96.0.10#53Name: kubernetes.default.svc.cluster.localAddress: 10.96.0.1 1234567[root@centos07-12 servicetest]# kubectl exec -it dig -- nslookup client-svc.default.svc.cluster.localServer: 10.96.0.10Address: 10.96.0.10#53client-svc.default.svc.cluster.local canonical name = nginx-svc.nginx-ns.svc.cluster.local.Name: nginx-svc.nginx-ns.svc.cluster.localAddress: 10.110.245.110 kubernetes.default.svc.cluster.local 服务名.名称空间.默认后缀在k8s中创建service之后，service默认的FQDN是..svc.cluster.local，那么k8s集群内部的服务就可以通过FQDN访问完全限定域名（fully qualified domain name，FQDN）","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"21-Deployment资源基本介绍","slug":"运维/K8S/基础/21-Deployment资源基本介绍","date":"2023-05-10T12:00:00.000Z","updated":"2023-12-09T14:11:56.000Z","comments":true,"path":"2023/05/10/运维/K8S/基础/21-Deployment资源基本介绍/","link":"","permalink":"https://dbbruce.github.io/2023/05/10/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/21-Deployment%E8%B5%84%E6%BA%90%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D/","excerpt":"Deployment控制器：概念、原理解读Deployment官方文档：https://kubernetes.io/docs/concepts/workloads/controllers/deployment/ 1、Deployment概述Deployment是kubernetes中最常用的资源对象，为ReplicaSet和Pod的创建提供了一种声明式的定义方法，在Deployment对象中描述一个期望的状态，Deployment控制器就会按照一定的控制速率把实际状态改成期望状态，通过定义一个Deployment控制器会创建一个新的ReplicaSet控制器，通过ReplicaSet创建pod，删除Deployment控制器，也会删除Deployment控制器下对应的ReplicaSet控制器和pod资源.使用Deployment而不直接创建ReplicaSet是因为Deployment对象拥有许多ReplicaSet没有的特性，例如滚动升级、金丝雀发布、蓝绿部署和回滚。 扩展：声明式定义是指直接修改资源清单yaml文件，然后通过kubectl apply -f 资源清单yaml文件，就可以更改资源","text":"Deployment控制器：概念、原理解读Deployment官方文档：https://kubernetes.io/docs/concepts/workloads/controllers/deployment/ 1、Deployment概述Deployment是kubernetes中最常用的资源对象，为ReplicaSet和Pod的创建提供了一种声明式的定义方法，在Deployment对象中描述一个期望的状态，Deployment控制器就会按照一定的控制速率把实际状态改成期望状态，通过定义一个Deployment控制器会创建一个新的ReplicaSet控制器，通过ReplicaSet创建pod，删除Deployment控制器，也会删除Deployment控制器下对应的ReplicaSet控制器和pod资源.使用Deployment而不直接创建ReplicaSet是因为Deployment对象拥有许多ReplicaSet没有的特性，例如滚动升级、金丝雀发布、蓝绿部署和回滚。 扩展：声明式定义是指直接修改资源清单yaml文件，然后通过kubectl apply -f 资源清单yaml文件，就可以更改资源 Deployment控制器是建立在rs之上的一个控制器，可以管理多个rs，每次更新镜像版本，都会生成一个新的rs，把旧的rs替换掉，多个rs同时存在，但是只有一个rs运行。rs v1控制三个pod，删除一个pod，在rs v2上重新建立一个，依次类推，直到全部都是由rs v2控制，如果rs v2有问题，还可以回滚，Deployment是建构在rs之上的，多个rs组成一个Deployment，但是只有一个rs处于活跃状态. 2、Deployment工作原理：如何管理rs和Pod？Deployment可以使用声明式定义，直接在命令行通过纯命令的方式完成对应资源版本的内容的修改，也就是通过打补丁的方式进行修改；Deployment能提供滚动式自定义自控制的更新；对Deployment来讲，我们在实现更新时还可以实现控制更新节奏和更新逻辑。 互动：什么叫做更新节奏和更新逻辑呢？比如说Deployment控制5个pod副本，pod的期望值是5个，但是升级的时候需要额外多几个pod，那我们控制器可以控制在5个pod副本之外还能再增加几个pod副本；比方说能多一个，但是不能少，那么升级的时候就是先增加一个，再删除一个，增加一个删除一个，始终保持pod副本数是5个；还有一种情况，最多允许多一个，最少允许少一个，也就是最多6个，最少4个，第一次加一个，删除两个，第二次加两个，删除两个，依次类推，可以自己控制更新方式，这种滚动更新需要加readinessProbe和livenessProbe探测，确保pod中容器里的应用都正常启动了才删除之前的pod。启动第一步，刚更新第一批就暂停了也可以；假如目标是5个，允许一个也不能少，允许最多可以10个，那一次加5个即可；这就是我们可以自己控制节奏来控制更新的方法。通过Deployment对象，你可以轻松的做到以下事情：1、创建ReplicaSet和Pod2、滚动升级（不停止旧服务的状态下升级）和回滚应用（将应用回滚到之前的版本）3、平滑地扩容和缩容4、暂停和继续Deployment Deployment资源清单文件编写技巧 查看Deployment资源对象由哪几部分组成123456789101112# kubectl explain deploymentKIND: DeploymentVERSION: apps/v1DESCRIPTION: Deployment enables declarative updates for Pods and ReplicaSets.FIELDS: apiVersion &lt;string&gt; #该资源使用的api版本 kind &lt;string&gt; #创建的资源是什么？ metadata &lt;Object&gt; #元数据，包括资源的名字和名称空间 spec &lt;Object&gt; #定义容器的 status &lt;Object&gt; #状态，不可以修改 查看Deployment下的spec字段123456789101112131415161718192021# kubectl explain deployment.specKIND: DeploymentVERSION: apps/v1RESOURCE: spec &lt;Object&gt;DESCRIPTION: Specification of the desired behavior of the Deployment. DeploymentSpec is the specification of the desired behavior of the Deployment.FIELDS: minReadySeconds &lt;integer&gt; #Kubernetes在等待设置的时间后才进行升级 #如果没有设置该值，Kubernetes会假设该容器启动起来后就提供服务了 paused &lt;boolean&gt; #暂停，当我们更新的时候创建pod先暂停，不是立即更新 progressDeadlineSeconds &lt;integer&gt; # k8s 在升级过程中有可能由于各种原因升级卡住（这个时候还没有明确的升级失败），比如在拉取被墙的镜像，权限不够等错误。那么这个时候就需要有个 deadline ，在 deadline 之内如果还卡着，那么就上报这个情况，这个时候这个 Deployment 状态就被标记为 False，并且注明原因。但是它并不会阻止 Deployment 继续进行卡住后面的操作。完全由用户进行控制。 replicas &lt;integer&gt; #副本数 revisionHistoryLimit &lt;integer&gt; #保留的历史版本，默认是10 selector &lt;Object&gt; -required- #标签选择器，选择它关联的pod strategy &lt;Object&gt; #更新策略 template &lt;Object&gt; -required #定义的pod模板 查看Deployment下的spec.strategy字段123456789101112131415# kubectl explain deploy.spec.strategyKIND: DeploymentVERSION: apps/v1RESOURCE: strategy &lt;Object&gt;DESCRIPTION: The deployment strategy to use to replace existing pods with new ones. DeploymentStrategy describes how to replace existing pods with new ones.FIELDS: rollingUpdate &lt;Object&gt; type &lt;string&gt; Type of deployment. Can be &quot;Recreate&quot; or &quot;RollingUpdate&quot;. Default is RollingUpdate.#支持两种更新，Recreate和RollingUpdate#Recreate是重建式更新，删除一个更新一个#RollingUpdate滚动更新，定义滚动更新方式，也就是pod能多几个，少几个 查看Deployment下的spec.strategy.rollingUpdate字段123456789101112131415# kubectl explain deploy.spec.strategy.rollingUpdateKIND: DeploymentVERSION: apps/v1RESOURCE: rollingUpdate &lt;Object&gt;DESCRIPTION: Rolling update config params. Present only if DeploymentStrategyType = RollingUpdate. Spec to control the desired behavior of rolling update.FIELDS: maxSurge &lt;string&gt; #我们更新的过程当中最多允许超出的指定的目标副本数有几个； 它有两种取值方式，第一种直接给定数量，第二种根据百分比，百分比表示原本是5个，最多可以超出20%，那就允许多一个，最多可以超过40%，那就允许多两个 maxUnavailable &lt;string&gt; #最多允许几个不可用 假设有5个副本，最多一个不可用，就表示最少有4个可用 replicas： 5maxSurge: 25% 5*25%&#x3D;1.25 -&gt;5+2&#x3D;7 &#x3D;&gt; 向上取maxUnavailable: 25% 5%25%&#x3D;1.25 -&gt; 5-1&#x3D;4 &#x3D;&gt; 向下取 查看Deployment下的spec.template字段 #template为定义Pod的模板，Deployment通过模板创建Pod 12345678910# kubectl explain deploy.spec.templateKIND: DeploymentVERSION: apps/v1RESOURCE: template &lt;Object&gt;DESCRIPTION: Template describes the pods that will be created. PodTemplateSpec describes the data a pod should have when created from a templateFIELDS: metadata &lt;Object&gt; #定义模板的名字 spec &lt;Object&gt; deployment.spec.template为Pod定义的模板，和Pod定义不太一样，template中不包含apiVersion和Kind属性，要求必须有metadata。deployment.spec.template.spec为容器的属性信息，其他定义内容和Pod一致。 Deployment使用案例：创建一个web站点 deployment是一个三级结构，deployment管理replicaset，replicaset管理pod 1、用deployment创建一个pod1234[root@centos07-22 ~]# ctr -n=k8s.io images import myapp-blue-v1.tar.gz[root@centos07-22 ~]# ctr -n=k8s.io images import myapp-blue-v2.tar.gz[root@centos07-62 ~]# ctr -n=k8s.io images import myapp-blue-v1.tar.gz[root@centos07-62 ~]# ctr -n=k8s.io images import myapp-blue-v2.tar.gz 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748# cat deploy-demo.yaml apiVersion: apps/v1kind: Deploymentmetadata: name: myapp-v1spec: replicas: 2 selector: matchLabels: app: myapp version: v1 template: metadata: labels: app: myapp version: v1 spec: containers: - name: myapp image: docker.io/janakiramm/myapp:v1 imagePullPolicy: IfNotPresent ports: - containerPort: 80 startupProbe: periodSeconds: 5 initialDelaySeconds: 20 timeoutSeconds: 10 httpGet: scheme: HTTP port: 80 path: / livenessProbe: periodSeconds: 5 initialDelaySeconds: 20 timeoutSeconds: 10 httpGet: scheme: HTTP port: 80 path: / readinessProbe: periodSeconds: 5 initialDelaySeconds: 20 timeoutSeconds: 10 httpGet: scheme: HTTP port: 80 path: / 2、更新资源清单文件： #kubectl apply：表示声明式的定义，既可以创建资源，也可以动态更新资源 12[root@centos07-12 replicasettest]# kubectl apply -f deploy-demo.yamldeployment.apps/myapp-v1 created 3、查看deploy状态：1.NAME：列出名称空间中deployment的名称。2.READY：显示deployment有多少副本数。它遵循ready&#x2F;desired的模式。3.UP-TO-DATE：显示已更新到所需状态的副本数。4.AVAILABLE：显示你的可以使用多少个应用程序副本。5.AGE：显示应用程序已运行的时间。 kubectl get deploy 123[root@centos07-12 replicasettest]# kubectl get deploymentNAME READY UP-TO-DATE AVAILABLE AGEmyapp-v1 2/2 2 2 62s 4、创建deploy的时候也会创建一个rs（replicaset），67fd9fc9c8 这个随机数字是我们引用pod的模板template的名字的hash值 kubectl get rs1.NAME：列出名称空间中ReplicaSet资源2.DESIRED：显示应用程序的所需副本数，这些副本数是在创建时定义的。这是所需的状态。3.CURRENT：显示当前正在运行多少个副本。4.READY：显示你的用户可以使用多少个应用程序副本。5.AGE：显示应用程序已运行的时间。 5、请注意，ReplicaSet的名称始终设置为[DEPLOYMENT-NAME]-[RANDOM-STRING]。RANDOM-STRING是随机生成的123[root@centos07-12 replicasettest]# kubectl get replicasetNAME DESIRED CURRENT READY AGEmyapp-v1-86b9dddd9b 2 2 2 67s 6、查看pod详情1234[root@centos07-12 replicasettest]# kubectl get pods -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESmyapp-v1-86b9dddd9b-njc5w 1/1 Running 0 5m6s 10.244.250.235 centos07-62 &lt;none&gt; &lt;none&gt;myapp-v1-86b9dddd9b-w9ks7 1/1 Running 0 5m6s 10.244.193.158 centos07-22 &lt;none&gt; &lt;none&gt; 7、验证访问12345678910111213141516171819202122232425262728293031323334[root@centos07-12 replicasettest]# curl 10.244.250.235&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt; &lt;meta charset=&quot;utf-8&quot;&gt; &lt;title&gt;Sample Deployment&lt;/title&gt; &lt;style&gt; body &#123; color: #ffffff; background-color: blue; font-family: Arial, sans-serif; font-size: 14px; &#125; h1 &#123; font-size: 500%; font-weight: normal; margin-bottom: 0; &#125; h2 &#123; font-size: 200%; font-weight: normal; margin-bottom: 0; &#125; &lt;/style&gt;&lt;/head&gt;&lt;body&gt; &lt;div align=&quot;center&quot;&gt; &lt;h1&gt;Welcome to V1 of the web application&lt;/h1&gt; &lt;h2&gt;This application will be deployed on Kubernetes.&lt;/h2&gt; &lt;/div&gt;&lt;/body&gt;&lt;/html&gt; Deployment资源清单文件详细解读12345678910111213141516171819202122apiVersion: apps/v1 #deployment对应的api版本kind: Deployment #创建的资源是deploymentmetadata: name: myapp-v1 #deployment的名字spec: replicas: 2 #deployment管理的pod副本数 selector: #标签选择器 matchLabels: # matchLabels下定义的标签需要跟template.metadata.labels定义的标签一致 app: myapp version: v1 template: metadata: labels: app: myapp version: v1 spec: #定义容器的属性 containers: - name: myapp image: janakiramm/myapp:v1 #容器使用的镜像 imagePullPolicy: IfNotPresent #镜像拉取策略 ports: - containerPort: 80 #容器里的应用的端口 Deployment管理pod：扩容1、通过deployment管理应用，实现扩容，把副本数变成3123456apiVersion: apps/v1kind: Deploymentmetadata: name: myapp-v1spec: replicas: 3 2、查看pod的情况，新增myapp-v1-86b9dddd9b-2r6mk1234567891011[root@centos07-12 probe1test]# kubectl get pods -owide -wNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESmyapp-v1-86b9dddd9b-njc5w 1/1 Running 0 178m 10.244.250.235 centos07-62 &lt;none&gt; &lt;none&gt;myapp-v1-86b9dddd9b-w9ks7 1/1 Running 0 178m 10.244.193.158 centos07-22 &lt;none&gt; &lt;none&gt;myapp-v1-86b9dddd9b-2r6mk 0/1 Pending 0 0s &lt;none&gt; &lt;none&gt; &lt;none&gt; &lt;none&gt;myapp-v1-86b9dddd9b-2r6mk 0/1 Pending 0 0s &lt;none&gt; centos07-62 &lt;none&gt; &lt;none&gt;myapp-v1-86b9dddd9b-2r6mk 0/1 ContainerCreating 0 0s &lt;none&gt; centos07-62 &lt;none&gt; &lt;none&gt;myapp-v1-86b9dddd9b-2r6mk 0/1 ContainerCreating 0 1s &lt;none&gt; centos07-62 &lt;none&gt; &lt;none&gt;myapp-v1-86b9dddd9b-2r6mk 0/1 Running 0 2s 10.244.250.236 centos07-62 &lt;none&gt; &lt;none&gt;myapp-v1-86b9dddd9b-2r6mk 0/1 Running 0 26s 10.244.250.236 centos07-62 &lt;none&gt; &lt;none&gt;myapp-v1-86b9dddd9b-2r6mk 1/1 Running 0 26s 10.244.250.236 centos07-62 &lt;none&gt; &lt;none&gt; 3、注意：apply不同于create，apply可以执行多次；create执行一次，再执行就会报错复。12[root@centos07-12 replicasettest]# kubectl apply -f deploy-demo.yamldeployment.apps/myapp-v1 configured 4、可以看到pod副本数变成了3个12345[root@centos07-12 replicasettest]# kubectl get pods -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESmyapp-v1-86b9dddd9b-2r6mk 1/1 Running 0 2m8s 10.244.250.236 centos07-62 &lt;none&gt; &lt;none&gt;myapp-v1-86b9dddd9b-njc5w 1/1 Running 0 3h4m 10.244.250.235 centos07-62 &lt;none&gt; &lt;none&gt;myapp-v1-86b9dddd9b-w9ks7 1/1 Running 0 3h4m 10.244.193.158 centos07-22 &lt;none&gt; &lt;none&gt; 5、查看myapp-v1这个控制器的详细信息123[root@centos07-12 replicasettest]# kubectl get deploy myapp-v1NAME READY UP-TO-DATE AVAILABLE AGEmyapp-v1 3/3 3 3 3h5m 12345678910111213141516171819202122232425262728293031323334353637[root@centos07-12 replicasettest]# kubectl describe deploy myapp-v1Name: myapp-v1Namespace: defaultCreationTimestamp: Sat, 09 Dec 2023 15:59:51 +0800Labels: &lt;none&gt;Annotations: deployment.kubernetes.io/revision: 1Selector: app=myapp,version=v1Replicas: 3 desired | 3 updated | 3 total | 3 available | 0 unavailableStrategyType: RollingUpdateMinReadySeconds: 0RollingUpdateStrategy: 25% max unavailable, 25% max surgePod Template: Labels: app=myapp version=v1 Containers: myapp: Image: docker.io/janakiramm/myapp:v1 Port: 80/TCP Host Port: 0/TCP Liveness: http-get http://:80/ delay=20s timeout=10s period=5s #success=1 #failure=3 Readiness: http-get http://:80/ delay=20s timeout=10s period=5s #success=1 #failure=3 Startup: http-get http://:80/ delay=20s timeout=10s period=5s #success=1 #failure=3 Environment: &lt;none&gt; Mounts: &lt;none&gt; Volumes: &lt;none&gt;Conditions: Type Status Reason ---- ------ ------ Progressing True NewReplicaSetAvailable Available True MinimumReplicasAvailableOldReplicaSets: &lt;none&gt;NewReplicaSet: myapp-v1-86b9dddd9b (3/3 replicas created)Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal ScalingReplicaSet 3h6m deployment-controller Scaled up replica set myapp-v1-86b9dddd9b to 2 Normal ScalingReplicaSet 3m53s deployment-controller Scaled up replica set myapp-v1-86b9dddd9b to 3 from 2 Deployment管理pod：缩容1、通过deployment管理应用，实现缩容，把副本数变成212345678# cat deploy-demo.yaml apiVersion: apps/v1kind: Deploymentmetadata: name: myapp-v1spec: replicas: 2 12[root@centos07-12 replicasettest]# kubectl apply -f deploy-demo.yamldeployment.apps/myapp-v1 configured 1234[root@centos07-12 replicasettest]# kubectl get pods -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESmyapp-v1-86b9dddd9b-njc5w 1/1 Running 0 3h9m 10.244.250.235 centos07-62 &lt;none&gt; &lt;none&gt;myapp-v1-86b9dddd9b-w9ks7 1/1 Running 0 3h9m 10.244.193.158 centos07-22 &lt;none&gt; &lt;none&gt; 通过k8s实现滚动更新1、滚动更新简介滚动更新是一种自动化程度较高的发布方式，用户体验比较平滑，是目前成熟型技术组织所采用的主流发布方式，一次滚动发布一般由若干个发布批次组成，每批的数量一般是可以配置的（可以通过发布模板定义），例如第一批1台，第二批10%，第三批50%，第四批100%。每个批次之间留观察间隔，通过手工验证或监控反馈确保没有问题再发下一批次，所以总体上滚动式发布过程是比较缓慢的 10个pod：第一我更新1个pod：第二次更新：1个第三次更新：5个第四次：3个 2、首先看下Deployment资源对象的组成：1[root@centos07-12 replicasettest]# kubectl explain deployment 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293[root@centos07-12 replicasettest]# kubectl explain deployment.specKIND: DeploymentVERSION: apps/v1RESOURCE: spec &lt;Object&gt;DESCRIPTION: Specification of the desired behavior of the Deployment. DeploymentSpec is the specification of the desired behavior of the Deployment.FIELDS: minReadySeconds &lt;integer&gt; Minimum number of seconds for which a newly created pod should be ready without any of its container crashing, for it to be considered available. Defaults to 0 (pod will be considered available as soon as it is ready) paused &lt;boolean&gt; Indicates that the deployment is paused.#暂停，当我们更新的时候创建pod先暂停，不是立即更新 progressDeadlineSeconds &lt;integer&gt; The maximum time in seconds for a deployment to make progress before it is considered to be failed. The deployment controller will continue to process failed deployments and a condition with a ProgressDeadlineExceeded reason will be surfaced in the deployment status. Note that progress will not be estimated during the time a deployment is paused. Defaults to 600s. replicas &lt;integer&gt; Number of desired pods. This is a pointer to distinguish between explicit zero and not specified. Defaults to 1. revisionHistoryLimit &lt;integer&gt;#保留的历史版本数，默认是10个 The number of old ReplicaSets to retain to allow rollback. This is a pointer to distinguish between explicit zero and not specified. Defaults to 10. selector &lt;Object&gt; -required- Label selector for pods. Existing ReplicaSets whose pods are selected by this will be the ones affected by this deployment. It must match the pod template&#x27;s labels. strategy &lt;Object&gt;#更新策略，支持的滚动更新策略 The deployment strategy to use to replace existing pods with new ones. template &lt;Object&gt; -required- Template describes the pods that will be created.kubectl explain deploy.spec.strategyKIND: DeploymentVERSION: apps/v1RESOURCE: strategy &lt;Object&gt;DESCRIPTION: The deployment strategy to use to replace existing pods with new ones. DeploymentStrategy describes how to replace existing pods with new ones.FIELDS: rollingUpdate &lt;Object&gt; Rolling update config params. Present only if DeploymentStrategyType = RollingUpdate. type &lt;string&gt; Type of deployment. Can be &quot;Recreate&quot; or &quot;RollingUpdate&quot;. Default is RollingUpdate.#支持两种更新，Recreate和RollingUpdate #Recreate是重建式更新，删除一个更新一个 #RollingUpdate 滚动更新，定义滚动更新的更新方式的，也就是pod能多几个，少几个，控制更新力度的kubectl explain deploy.spec.strategy.rollingUpdateKIND: DeploymentVERSION: apps/v1RESOURCE: rollingUpdate &lt;Object&gt;DESCRIPTION: Rolling update config params. Present only if DeploymentStrategyType = RollingUpdate. Spec to control the desired behavior of rolling update.FIELDS: maxSurge &lt;string&gt; The maximum number of pods that can be scheduled above the desired number of pods. Value can be an absolute number (ex: 5) or a percentage of desired pods (ex: 10%). This can not be 0 if MaxUnavailable is 0. Absolute number is calculated from percentage by rounding up. Defaults to 25%. Example: when this is set to 30%, the new ReplicaSet can be scaled up immediately when the rolling update starts, such that the total number of old and new pods do not exceed 130% of desired pods. Once old pods have been killed, new ReplicaSet can be scaled up further, ensuring that total number of pods running at any time during the update is at most 130% of desired pods.#我们更新的过程当中最多允许超出的指定的目标副本数有几个； 它有两种取值方式，第一种直接给定数量，第二种根据百分比，百分比表示原本是5个，最多可以超出20%，那就允许多一个，最多可以超过40%，那就允许多两个 maxUnavailable &lt;string&gt; The maximum number of pods that can be unavailable during the update. Value can be an absolute number (ex: 5) or a percentage of desired pods (ex: 10%). Absolute number is calculated from percentage by rounding down. This can not be 0 if MaxSurge is 0. Defaults to 25%. Example: when this is set to 30%, the old ReplicaSet can be scaled down to 70% of desired pods immediately when the rolling update starts. Once new pods are ready, old ReplicaSet can be scaled down further, followed by scaling up the new ReplicaSet, ensuring that the total number of pods available at all times during the update is at least 70% of desired pods.#最多允许几个不可用假设有5个副本，最多一个不可用，就表示最少有4个可用 deployment是一个三级结构，deployment控制replicaset，replicaset控制pod 3、123456apiVersion: apps/v1kind: Deploymentmetadata: name: myapp-v1spec: replicas: 3 12[root@centos07-12 replicasettest]# kubectl apply -f deploy-demo.yamldeployment.apps/myapp-v1 configured 可以看到pod副本数变成了3个 12345[root@centos07-12 replicasettest]# kubectl get podsNAME READY STATUS RESTARTS AGEmyapp-v1-86b9dddd9b-njc5w 1/1 Running 0 3h15mmyapp-v1-86b9dddd9b-qxs6n 1/1 Running 0 64smyapp-v1-86b9dddd9b-w9ks7 1/1 Running 0 3h15m 注意：apply不同于create，apply可以执行多次；create执行一次，再执行就会报错有重复。 [root@centos07-12 replicasettest]# kubectl create -f deploy-demo.yaml Error from server (AlreadyExists): error when creating “deploy-demo.yaml”: deployments.apps “myapp-v1” already exists [root@centos07-12 replicasettest]# kubectl apply -f deploy-demo.yaml deployment.apps&#x2F;myapp-v1 configured 查看myapp-v1这个控制器的详细信息123456789101112131415161718192021222324252627282930313233343536373839[root@centos07-12 replicasettest]# kubectl describe deploy myapp-v1Name: myapp-v1Namespace: defaultCreationTimestamp: Sat, 09 Dec 2023 15:59:51 +0800Labels: &lt;none&gt;Annotations: deployment.kubernetes.io/revision: 1Selector: app=myapp,version=v1Replicas: 4 desired | 4 updated | 4 total | 4 available | 0 unavailableStrategyType: RollingUpdateMinReadySeconds: 0RollingUpdateStrategy: 25% max unavailable, 25% max surgePod Template: Labels: app=myapp version=v1 Containers: myapp: Image: docker.io/janakiramm/myapp:v1 Port: 80/TCP Host Port: 0/TCP Liveness: http-get http://:80/ delay=20s timeout=10s period=5s #success=1 #failure=3 Readiness: http-get http://:80/ delay=20s timeout=10s period=5s #success=1 #failure=3 Startup: http-get http://:80/ delay=20s timeout=10s period=5s #success=1 #failure=3 Environment: &lt;none&gt; Mounts: &lt;none&gt; Volumes: &lt;none&gt;Conditions: Type Status Reason ---- ------ ------ Progressing True NewReplicaSetAvailable Available True MinimumReplicasAvailableOldReplicaSets: &lt;none&gt;NewReplicaSet: myapp-v1-86b9dddd9b (4/4 replicas created)Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal ScalingReplicaSet 58m deployment-controller Scaled down replica set myapp-v1-86b9dddd9b to 2 from 3 Normal ScalingReplicaSet 52m (x2 over 64m) deployment-controller Scaled up replica set myapp-v1-86b9dddd9b to 3 from 2 Normal ScalingReplicaSet 46m deployment-controller Scaled down replica set myapp-v1-86b9dddd9b to 3 from 4 Normal ScalingReplicaSet 45m (x2 over 47m) deployment-controller Scaled up replica set myapp-v1-86b9dddd9b to 4 from 3 打开一个新的终端窗口更改镜像版本，按如下操作：1kubectl get pods -l app=myapp -w 把image: janakiramm&#x2F;myapp:v1 变成image: janakiramm&#x2F;myapp:v2 ，保存退出，执行 12345678910111213141516171819apiVersion: apps/v1kind: Deploymentmetadata: name: myapp-v1spec: replicas: 3 selector: matchLabels: app: myapp version: v1 template: metadata: labels: app: myapp version: v1 spec: containers: - name: myapp image: docker.io/janakiramm/myapp:v2 12[root@centos07-12 replicasettest]# kubectl apply -f deploy-demo.yamldeployment.apps/myapp-v1 configured 再回到刚才监测的那个窗口，可以看到信息如下： 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051[root@centos07-12 probe1test]# kubectl get pods -l app=myapp -wNAME READY STATUS RESTARTS AGEmyapp-v1-86b9dddd9b-lwcxz 1/1 Running 0 47mmyapp-v1-86b9dddd9b-njc5w 1/1 Running 0 4h8mmyapp-v1-86b9dddd9b-qxs6n 1/1 Running 0 54mmyapp-v1-86b9dddd9b-w9ks7 1/1 Running 0 4h8mmyapp-v1-7d4c7ddb79-dwpq8 0/1 Pending 0 0smyapp-v1-7d4c7ddb79-dwpq8 0/1 Pending 0 0smyapp-v1-86b9dddd9b-qxs6n 1/1 Terminating 0 56mmyapp-v1-7d4c7ddb79-dwpq8 0/1 ContainerCreating 0 0smyapp-v1-86b9dddd9b-qxs6n 1/1 Terminating 0 56mmyapp-v1-7d4c7ddb79-dwpq8 0/1 ContainerCreating 0 1smyapp-v1-86b9dddd9b-qxs6n 0/1 Terminating 0 56mmyapp-v1-86b9dddd9b-qxs6n 0/1 Terminating 0 56mmyapp-v1-86b9dddd9b-qxs6n 0/1 Terminating 0 56mmyapp-v1-86b9dddd9b-qxs6n 0/1 Terminating 0 56mmyapp-v1-7d4c7ddb79-dwpq8 0/1 Running 0 3smyapp-v1-7d4c7ddb79-dwpq8 0/1 Running 0 26smyapp-v1-7d4c7ddb79-dwpq8 1/1 Running 0 26smyapp-v1-86b9dddd9b-lwcxz 1/1 Terminating 0 49mmyapp-v1-7d4c7ddb79-mvrfh 0/1 Pending 0 0smyapp-v1-7d4c7ddb79-mvrfh 0/1 Pending 0 0smyapp-v1-7d4c7ddb79-mvrfh 0/1 ContainerCreating 0 0smyapp-v1-86b9dddd9b-lwcxz 1/1 Terminating 0 49mmyapp-v1-7d4c7ddb79-mvrfh 0/1 ContainerCreating 0 1smyapp-v1-86b9dddd9b-lwcxz 0/1 Terminating 0 49mmyapp-v1-86b9dddd9b-lwcxz 0/1 Terminating 0 49mmyapp-v1-86b9dddd9b-lwcxz 0/1 Terminating 0 49mmyapp-v1-86b9dddd9b-lwcxz 0/1 Terminating 0 49mmyapp-v1-7d4c7ddb79-mvrfh 0/1 Running 0 2smyapp-v1-7d4c7ddb79-mvrfh 0/1 Running 0 25smyapp-v1-7d4c7ddb79-mvrfh 1/1 Running 0 25smyapp-v1-86b9dddd9b-njc5w 1/1 Terminating 0 4h11mmyapp-v1-7d4c7ddb79-mdn79 0/1 Pending 0 0smyapp-v1-7d4c7ddb79-mdn79 0/1 Pending 0 0smyapp-v1-7d4c7ddb79-mdn79 0/1 ContainerCreating 0 0smyapp-v1-86b9dddd9b-njc5w 1/1 Terminating 0 4h11mmyapp-v1-7d4c7ddb79-mdn79 0/1 ContainerCreating 0 1smyapp-v1-86b9dddd9b-njc5w 0/1 Terminating 0 4h11mmyapp-v1-86b9dddd9b-njc5w 0/1 Terminating 0 4h11mmyapp-v1-86b9dddd9b-njc5w 0/1 Terminating 0 4h11mmyapp-v1-86b9dddd9b-njc5w 0/1 Terminating 0 4h11mmyapp-v1-7d4c7ddb79-mdn79 0/1 Running 0 2smyapp-v1-7d4c7ddb79-mdn79 0/1 Running 0 25smyapp-v1-7d4c7ddb79-mdn79 1/1 Running 0 25smyapp-v1-86b9dddd9b-w9ks7 1/1 Terminating 0 4h11mmyapp-v1-86b9dddd9b-w9ks7 1/1 Terminating 0 4h11mmyapp-v1-86b9dddd9b-w9ks7 0/1 Terminating 0 4h11mmyapp-v1-86b9dddd9b-w9ks7 0/1 Terminating 0 4h11mmyapp-v1-86b9dddd9b-w9ks7 0/1 Terminating 0 4h11mmyapp-v1-86b9dddd9b-w9ks7 0/1 Terminating 0 4h11m pending表示正在进行调度，ContainerCreating表示正在创建一个pod，running表示运 行一个pod，running起来一个pod之后再Terminating（停掉）一个pod，以此类推，直 到所有pod完成滚动升级 在另外一个窗口执行1234root@centos07-12 replicasettest]# kubectl get rsNAME DESIRED CURRENT READY AGEmyapp-v1-7d4c7ddb79 3 3 3 3m23smyapp-v1-86b9dddd9b 0 0 0 4h13m 上面可以看到rs有两个，下面那个是升级之前的，已经被停掉，但是可以随时回滚 查看myapp-v1这个控制器的滚动历史，显示如下：12345[root@centos07-12 replicasettest]# kubectl rollout history deployment myapp-v1deployment.apps/myapp-v1REVISION CHANGE-CAUSE1 &lt;none&gt;2 &lt;none&gt; 回滚操作如下： 12[root@centos07-12 replicasettest]# kubectl rollout undo deployment/myapp-v1 --to-revision=1deployment.apps/myapp-v1 rolled back 自定义滚动更新策略 maxSurge[更新的过程当中最多允许超出的指定的目标副本数有几个]和maxUnavailable[最多允许几个不可用]用来控制滚动更新的更新策略 取值范围数值 maxUnavailable: [0, 副本数] maxSurge: [0, 副本数]注意：两者不能同时为0。 比例 maxUnavailable: [0%, 100%] 向下取整，比如10个副本，5%的话&#x3D;&#x3D;0.5个，但计算按照0个； maxSurge: [0%, 100%] 向上取整，比如10个副本，5%的话&#x3D;&#x3D;0.5个，但计算按照1个；注意：两者不能同时为0。 建议配置 maxUnavailable &#x3D;&#x3D; 0 maxSurge &#x3D;&#x3D; 1这是我们生产环境提供给用户的默认配置。即“一上一下，先上后下”最平滑原则：1个新版本pod ready（结合readiness）后，才销毁旧版本pod。此配置适用场景是平滑更新、保证服务平稳，但也有缺点，就是“太慢”了。-总结：maxUnavailable：和期望的副本数比，不可用副本数最大比例（或最大值），这个值越小，越能保证服务稳定，更新越平滑；maxSurge：和期望的副本数比，超过期望副本数最大比例（或最大值），这个值调的越大，副本更新速度越快。 1、自定义策略： 修改更新策略：maxUnavailable&#x3D;1，maxSurge&#x3D;1 12[root@centos07-12 replicasettest]# kubectl patch deployment myapp-v1 -p &#x27;&#123;&quot;spec&quot;:&#123;&quot;strategy&quot;:&#123;&quot;rollingUpdate&quot;: &#123;&quot;maxSurge&quot;:1,&quot;maxUnavailable&quot;:1&#125;&#125;&#125;&#125;&#x27;deployment.apps/myapp-v1 patched 查看myapp-v1这个控制器的详细信息 [root@centos07-12 replicasettest]# kubectl describe deployment myapp-v1RollingUpdateStrategy: 1 max unavailable, 1 max surge 上面可以看到RollingUpdateStrategy: 1 max unavailable, 1 max surge 这个rollingUpdate更新策略变成了刚才设定的，因为我们设定的pod副本数是3，1和1表示最少不能少于2个pod，最多不能超过4个pod 这个就是通过控制RollingUpdateStrategy这个字段来设置滚动更新策略的 2、把pod更新策略变成Recreate1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950# cat deploy-demo.yaml apiVersion: apps/v1kind: Deploymentmetadata: name: myapp-v1spec: strategy: type: Recreate replicas: 3 selector: matchLabels: app: myapp version: v1 template: metadata: labels: app: myapp version: v1 spec: containers: - name: myapp image: docker.io/janakiramm/myapp:v2 imagePullPolicy: IfNotPresent ports: - containerPort: 80 startupProbe: periodSeconds: 5 initialDelaySeconds: 20 timeoutSeconds: 10 httpGet: scheme: HTTP port: 80 path: / livenessProbe: periodSeconds: 5 initialDelaySeconds: 20 timeoutSeconds: 10 httpGet: scheme: HTTP port: 80 path: / readinessProbe: periodSeconds: 5 initialDelaySeconds: 20 timeoutSeconds: 10 httpGet: scheme: HTTP port: 80 path: / 12[root@centos07-12 replicasettest]# kubectl apply -f deploy-demo.yamldeployment.apps/myapp-v1 configured 打开新的终端，看pod更新过程1234567891011121314151617181920212223242526272829303132333435363738394041424344[root@centos07-12 probe1test]# kubectl get pods -l app=myapp -wNAME READY STATUS RESTARTS AGEmyapp-v1-86b9dddd9b-k7rzf 1/1 Running 0 58smyapp-v1-86b9dddd9b-l44mj 1/1 Running 0 58smyapp-v1-86b9dddd9b-xcpfd 1/1 Running 0 58s############ recreate，直接把pod全部删除，在新建myapp-v1-86b9dddd9b-xcpfd 1/1 Terminating 0 64smyapp-v1-86b9dddd9b-k7rzf 1/1 Terminating 0 64smyapp-v1-86b9dddd9b-l44mj 1/1 Terminating 0 64smyapp-v1-86b9dddd9b-l44mj 1/1 Terminating 0 65smyapp-v1-86b9dddd9b-k7rzf 1/1 Terminating 0 65smyapp-v1-86b9dddd9b-xcpfd 1/1 Terminating 0 65smyapp-v1-86b9dddd9b-l44mj 0/1 Terminating 0 65smyapp-v1-86b9dddd9b-k7rzf 0/1 Terminating 0 65smyapp-v1-86b9dddd9b-xcpfd 0/1 Terminating 0 65smyapp-v1-7d4c7ddb79-l7g8t 0/1 Pending 0 0smyapp-v1-7d4c7ddb79-vzmzh 0/1 Pending 0 0smyapp-v1-7d4c7ddb79-l7g8t 0/1 Pending 0 0smyapp-v1-7d4c7ddb79-97fjd 0/1 Pending 0 0smyapp-v1-86b9dddd9b-l44mj 0/1 Terminating 0 66smyapp-v1-7d4c7ddb79-vzmzh 0/1 Pending 0 0smyapp-v1-7d4c7ddb79-97fjd 0/1 Pending 0 0smyapp-v1-86b9dddd9b-l44mj 0/1 Terminating 0 66smyapp-v1-7d4c7ddb79-l7g8t 0/1 ContainerCreating 0 0smyapp-v1-86b9dddd9b-l44mj 0/1 Terminating 0 66smyapp-v1-7d4c7ddb79-97fjd 0/1 ContainerCreating 0 0smyapp-v1-7d4c7ddb79-vzmzh 0/1 ContainerCreating 0 0smyapp-v1-86b9dddd9b-xcpfd 0/1 Terminating 0 66smyapp-v1-86b9dddd9b-xcpfd 0/1 Terminating 0 66smyapp-v1-86b9dddd9b-xcpfd 0/1 Terminating 0 66smyapp-v1-86b9dddd9b-k7rzf 0/1 Terminating 0 66smyapp-v1-86b9dddd9b-k7rzf 0/1 Terminating 0 67smyapp-v1-86b9dddd9b-k7rzf 0/1 Terminating 0 67smyapp-v1-7d4c7ddb79-l7g8t 0/1 ContainerCreating 0 1smyapp-v1-7d4c7ddb79-vzmzh 0/1 ContainerCreating 0 1smyapp-v1-7d4c7ddb79-97fjd 0/1 ContainerCreating 0 1smyapp-v1-7d4c7ddb79-97fjd 0/1 Running 0 2smyapp-v1-7d4c7ddb79-l7g8t 0/1 Running 0 2smyapp-v1-7d4c7ddb79-vzmzh 0/1 Running 0 3smyapp-v1-7d4c7ddb79-l7g8t 0/1 Running 0 25smyapp-v1-7d4c7ddb79-vzmzh 0/1 Running 0 25smyapp-v1-7d4c7ddb79-l7g8t 1/1 Running 0 25smyapp-v1-7d4c7ddb79-vzmzh 1/1 Running 0 25smyapp-v1-7d4c7ddb79-97fjd 1/1 Running 0 25s 总结：recreate这种更新策略，会把之前的所有pod都删除，再创建新的pod，风险很大 生产环境如何实现蓝绿部署？1、什么是蓝绿部署？蓝绿部署中，一共有两套系统：一套是正在提供服务系统，标记为“绿色”；另一套是准备发布的系统，标记为“蓝色”。两套系统都是功能完善的、正在运行的系统，只是系统版本和对外服务情况不同。开发新版本，要用新版本替换线上的旧版本，在线上的系统之外，搭建了一个使用新版本代码的全新系统。 这时候，一共有两套系统在运行，正在对外提供服务的老系统是绿色系统，新部署的系统是蓝色系统。蓝色系统不对外提供服务，用来做什么呢？用来做发布前测试，测试过程中发现任何问题，可以直接在蓝色系统上修改，不干扰用户正在使用的系统。（注意，两套系统没有耦合的时候才能百分百保证不干扰）蓝色系统经过反复的测试、修改、验证，确定达到上线标准之后，直接将用户切换到蓝色系统：切换后的一段时间内，依旧是蓝绿两套系统并存，但是用户访问的已经是蓝色系统。这段时间内观察蓝色系统（新系统）工作状态，如果出现问题，直接切换回绿色系统。 当确信对外提供服务的蓝色系统工作正常，不对外提供服务的绿色系统已经不再需要的时候，蓝色系统正式成为对外提供服务系统，成为新的绿色系统。 原先的绿色系统可以销毁，将资源释放出来，用于部署下一个蓝色系统。 2、蓝绿部署的优势和缺点优点：1、更新过程无需停机，风险较少2、回滚方便，只需要更改路由或者切换DNS服务器，效率较高缺点：1、成本较高，需要部署两套环境。如果新版本中基础服务出现问题，会瞬间影响全网用户；如果新版本有问题也会影响全网用户。2、需要部署两套机器，费用开销大3、在非隔离的机器（Docker、VM）上操作时，可能会导致蓝绿环境被摧毁风险4、负载均衡器&#x2F;反向代理&#x2F;路由&#x2F;DNS处理不当，将导致流量没有切换过来情况出现 通过k8s实现线上业务的蓝绿部署 下面实验需要的镜像包在课件，把镜像压缩包上传到k8s的各个工作节点，ctr -n&#x3D;k8s.io images import解压：1234[root@centos07-22 ~]# ctr -n=k8s.io images import myapp-lan.tar.gz[root@centos07-22 ~]# ctr -n=k8s.io images import myapp-lv.tar.gz[root@centos07-62 ~]# ctr -n=k8s.io images import myapp-lan.tar.gz[root@centos07-62 ~]# ctr -n=k8s.io images import myapp-lv.tar.gz Kubernetes不支持内置的蓝绿部署。目前最好的方式是创建新的deployment，然后更新应用程序的service以指向新的deployment部署的应用 1.创建绿色部署环境（基于第一版代码做的镜像运行的pod）12345678910111213141516171819202122232425# cat lv.yamlapiVersion: apps/v1kind: Deploymentmetadata: name: myapp-v1 namespace: blue-greenspec: replicas: 3 selector: matchLabels: app: myapp version: v2 template: metadata: labels: app: myapp version: v2 spec: containers: - name: myapp image: janakiramm/myapp:v2 imagePullPolicy: IfNotPresent ports: - containerPort: 80 可以使用kubectl命令创建部署12[root@centos07-12 probe1test]# kubectl create ns blue-greennamespace/blue-green created 12[root@centos07-12 replicasettest]# kubectl apply -f lv.yamldeployment.apps/myapp-v1 created 12345[root@centos07-12 probe1test]# kubectl get pods -n blue-greenNAME READY STATUS RESTARTS AGEmyapp-v1-7b77cfb74f-jj486 1/1 Running 0 20smyapp-v1-7b77cfb74f-kpxrj 1/1 Running 0 20smyapp-v1-7b77cfb74f-snxq7 1/1 Running 0 20s 12345[root@centos07-12 probe1test]# kubectl get pods -n blue-green --show-labelsNAME READY STATUS RESTARTS AGE LABELSmyapp-v1-7b77cfb74f-jj486 1/1 Running 0 42s app=myapp,pod-template-hash=7b77cfb74f,version=v2myapp-v1-7b77cfb74f-kpxrj 1/1 Running 0 42s app=myapp,pod-template-hash=7b77cfb74f,version=v2myapp-v1-7b77cfb74f-snxq7 1/1 Running 0 42s app=myapp,pod-template-hash=7b77cfb74f,version=v2 创建前端service123456789101112131415161718# cat service_lanlv.yaml apiVersion: v1kind: Servicemetadata: name: myapp-lan-lv namespace: blue-green labels: app: myappspec: type: NodePort ports: - port: 80 nodePort: 30062 name: http selector: app: myapp version: v2 更新服务：12[root@centos07-12 probe1test]# kubectl apply -f service_lanlv.yamlservice/myapp-lan-lv created 前端服务123[root@centos07-12 probe1test]# kubectl get svc -n blue-green -owideNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTORmyapp-lan-lv NodePort 10.107.103.219 &lt;none&gt; 80:30062/TCP 3m31s app=myapp,version=v2 123456789101112131415161718[root@centos07-12 probe1test]# kubectl describe svc myapp-lan-lv -n blue-greenName: myapp-lan-lvNamespace: blue-greenLabels: app=myappAnnotations: &lt;none&gt;Selector: app=myapp,version=v2Type: NodePortIP Family Policy: SingleStackIP Families: IPv4IP: 10.107.103.219IPs: 10.107.103.219Port: http 80/TCPTargetPort: 80/TCPNodePort: http 30062/TCPEndpoints: 10.244.193.166:80,10.244.250.248:80,10.244.250.249:80Session Affinity: NoneExternal Traffic Policy: ClusterEvents: &lt;none&gt; 在浏览器访问http://k8s-master节点ip:30062 显示如下： 2.创建蓝色部署环境（新上线的环境，要替代绿色环境）123456789101112131415161718# cat lan.yamlapiVersion: v1kind: Servicemetadata: name: myapp-lan-lv namespace: blue-green labels: app: myappspec: type: NodePort ports: - port: 80 nodePort: 30062 name: http selector: app: myapp version: v1 然后可以使用kubectl命令创建部署。12[root@centos07-12 probe1test]# kubectl apply -f lan.yamldeployment.apps/myapp-v2 created service 从 v2 变 v1123[root@centos07-12 replicasettest]# kubectl get svc -n blue-green -owideNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTORmyapp-lan-lv NodePort 10.107.103.219 &lt;none&gt; 80:30062/TCP 36m app=myapp,version=v2 123[root@centos07-12 replicasettest]# kubectl get svc -n blue-green -owideNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTORmyapp-lan-lv NodePort 10.107.103.219 &lt;none&gt; 80:30062/TCP 36m app=myapp,version=v1 在浏览器访问http://k8s-master节点ip:30062 显示如下： 3.实验完成之后，把资源先删除，以免影响后面实验12345678[root@centos07-12 replicasettest]# kubectl delete -f lan.yamldeployment.apps &quot;myapp-v2&quot; deleted[root@centos07-12 replicasettest]# kubectl delete -f lv.yamldeployment.apps &quot;myapp-v1&quot; deleted[root@centos07-12 replicasettest]# kubectl delete -f service_lanlv.yamlservice &quot;myapp-lan-lv&quot; deleted 通过k8s完成线上业务的金丝雀发布1、金丝雀发布简介金丝雀发布的由来：17 世纪，英国矿井工人发现，金丝雀对瓦斯这种气体十分敏感。空气中哪怕有极其微量的瓦斯，金丝雀也会停止歌唱；当瓦斯含量超过一定限度时，虽然人类毫无察觉，金丝雀却早已毒发身亡。当时在采矿设备相对简陋的条件下，工人们每次下井都会带上一只金丝雀作为瓦斯检测指标，以便在危险状况下紧急撤离。金丝雀发布（又称灰度发布、灰度更新）：金丝雀发布一般先发1台，或者一个小比例，例如2%的服务器，主要做流量验证用，也称为金丝雀 (Canary) 测试 （国内常称灰度测试）。 100个pod: 更新了一个pod：用的新的代码做的镜像 99个pod：没有更新 简单的金丝雀测试一般通过手工测试验证，复杂的金丝雀测试需要比较完善的监控基础设施配合，通过监控指标反馈，观察金丝雀的健康状况，作为后续发布或回退的依据。 如果金丝测试通过，则把剩余的V1版本全部升级为V2版本。如果金丝雀测试失败，则直接回退金丝雀，发布失败。优点：灵活，策略自定义，可以按照流量或具体的内容进行灰度(比如不同账号，不同参数)，出现问题不会影响全网用户缺点：没有覆盖到所有的用户导致出现问题不好排查 2、在k8s中实现金丝雀发布12345678910111213141516171819202122232425# cat lv.yaml apiVersion: apps/v1kind: Deploymentmetadata: name: myapp-v1 namespace: blue-greenspec: replicas: 3 selector: matchLabels: app: myapp version: v2 template: metadata: labels: app: myapp version: v2 spec: containers: - name: myapp image: janakiramm/myapp:v2 imagePullPolicy: IfNotPresent ports: - containerPort: 80 打开一个标签1监测更新过程 12[root@centos07-12 replicasettest]# kubectl apply -f lv.yamldeployment.apps/myapp-v1 created 12345[root@centos07-12 ~]# kubectl get pods -l app=myapp -n blue-green -w -owide --show-labelsNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES LABELSmyapp-v1-7b77cfb74f-69pk6 1/1 Running 0 2m19s 10.244.193.170 centos07-22 &lt;none&gt; &lt;none&gt; app=myapp,pod-template-hash=7b77cfb74f,version=v2myapp-v1-7b77cfb74f-mbw6s 1/1 Running 0 2m19s 10.244.250.254 centos07-62 &lt;none&gt; &lt;none&gt; app=myapp,pod-template-hash=7b77cfb74f,version=v2myapp-v1-7b77cfb74f-p9pkk 1/1 Running 0 2m19s 10.244.250.253 centos07-62 &lt;none&gt; &lt;none&gt; app=myapp,pod-template-hash=7b77cfb74f,version=v2 123[root@centos07-12 ~]# kubectl get deploy -n blue-green -owideNAME READY UP-TO-DATE AVAILABLE AGE CONTAINERS IMAGES SELECTORmyapp-v1 3/3 3 3 3m20s myapp janakiramm/myapp:v2 app=myapp,version=v2 打开另一个标签2执行如下操作： kubectl set image deployment myapp-v1(deploy名称) myapp(container名)&#x3D;docker.io&#x2F;library&#x2F;nginx:latest -n blue-green &amp;&amp; kubectl rollout pause deployment myapp-v1 -n blue-green 123[root@centos07-12 replicasettest]# kubectl set image deployment myapp-v1 myapp=docker.io/library/nginx:latest -n blue-green &amp;&amp; kubectl rollout pause deployment myapp-v1 -n blue-greendeployment.apps/myapp-v1 image updateddeployment.apps/myapp-v1 paused 回到标签1观察，显示如下：1234567891011[root@centos07-12 ~]# kubectl get pods -n blue-green -wNAME READY STATUS RESTARTS AGEmyapp-v1-7b77cfb74f-69pk6 1/1 Running 0 6m22smyapp-v1-7b77cfb74f-mbw6s 1/1 Running 0 6m22smyapp-v1-7b77cfb74f-p9pkk 1/1 Running 0 6m22s######## 创建了一个pods，使用的是nginx镜像myapp-v1-6bb9cb95bd-n54f9 0/1 Pending 0 0smyapp-v1-6bb9cb95bd-n54f9 0/1 Pending 0 0smyapp-v1-6bb9cb95bd-n54f9 0/1 ContainerCreating 0 0smyapp-v1-6bb9cb95bd-n54f9 0/1 ContainerCreating 0 1smyapp-v1-6bb9cb95bd-n54f9 1/1 Running 0 2s 注：上面的解释说明把myapp这个容器的镜像更新到docker.io&#x2F;xianchao&#x2F;nginx:v1版本 更新镜像之后，创建一个新的pod就立即暂停，这就是我们说的金丝雀发布；如果暂停几个小时之后没有问题，那么取消暂停，就会依次执行后面步骤，把所有pod都升级。 回到标签1继续观察：123456[root@centos07-12 ~]# kubectl get pods -n blue-green -wNAME READY STATUS RESTARTS AGEmyapp-v1-6bb9cb95bd-n54f9 1/1 Running 0 4m7smyapp-v1-7b77cfb74f-69pk6 1/1 Running 0 11mmyapp-v1-7b77cfb74f-mbw6s 1/1 Running 0 11mmyapp-v1-7b77cfb74f-p9pkk 1/1 Running 0 11m 解除暂停：12[root@centos07-12 replicasettest]# kubectl rollout resume deployment myapp-v1 -n blue-greendeployment.apps/myapp-v1 resumed 在标签1可以看到如下一些信息，下面过程是把余下的pod里的容器都更的版本：123456789101112131415161718192021222324252627282930313233343536[root@centos07-12 ~]# kubectl get pods -n blue-green -wNAME READY STATUS RESTARTS AGEmyapp-v1-6bb9cb95bd-n54f9 1/1 Running 0 4m7smyapp-v1-7b77cfb74f-69pk6 1/1 Running 0 11mmyapp-v1-7b77cfb74f-mbw6s 1/1 Running 0 11mmyapp-v1-7b77cfb74f-p9pkk 1/1 Running 0 11m####### 有个细节就是：会先创建新pod，后删除老podmyapp-v1-7b77cfb74f-p9pkk 1/1 Terminating 0 12mmyapp-v1-6bb9cb95bd-xlp9l 0/1 Pending 0 0smyapp-v1-6bb9cb95bd-xlp9l 0/1 Pending 0 0smyapp-v1-6bb9cb95bd-xlp9l 0/1 ContainerCreating 0 0smyapp-v1-7b77cfb74f-p9pkk 1/1 Terminating 0 12mmyapp-v1-6bb9cb95bd-xlp9l 0/1 ContainerCreating 0 1smyapp-v1-7b77cfb74f-p9pkk 0/1 Terminating 0 12mmyapp-v1-7b77cfb74f-p9pkk 0/1 Terminating 0 12mmyapp-v1-7b77cfb74f-p9pkk 0/1 Terminating 0 12mmyapp-v1-7b77cfb74f-p9pkk 0/1 Terminating 0 12mmyapp-v1-6bb9cb95bd-xlp9l 1/1 Running 0 2smyapp-v1-7b77cfb74f-69pk6 1/1 Terminating 0 12mmyapp-v1-6bb9cb95bd-vzdt5 0/1 Pending 0 0smyapp-v1-6bb9cb95bd-vzdt5 0/1 Pending 0 0smyapp-v1-6bb9cb95bd-vzdt5 0/1 ContainerCreating 0 0smyapp-v1-7b77cfb74f-69pk6 1/1 Terminating 0 12mmyapp-v1-6bb9cb95bd-vzdt5 0/1 ContainerCreating 0 1smyapp-v1-7b77cfb74f-69pk6 0/1 Terminating 0 12mmyapp-v1-7b77cfb74f-69pk6 0/1 Terminating 0 12mmyapp-v1-7b77cfb74f-69pk6 0/1 Terminating 0 12mmyapp-v1-7b77cfb74f-69pk6 0/1 Terminating 0 12mmyapp-v1-6bb9cb95bd-vzdt5 1/1 Running 0 2smyapp-v1-7b77cfb74f-mbw6s 1/1 Terminating 0 12mmyapp-v1-7b77cfb74f-mbw6s 1/1 Terminating 0 12mmyapp-v1-7b77cfb74f-mbw6s 0/1 Terminating 0 12mmyapp-v1-7b77cfb74f-mbw6s 0/1 Terminating 0 12mmyapp-v1-7b77cfb74f-mbw6s 0/1 Terminating 0 12mmyapp-v1-7b77cfb74f-mbw6s 0/1 Terminating 0 12m 可以看到replicaset控制器有2个了1234[root@centos07-12 replicasettest]# kubectl get replicaset -n blue-greenNAME DESIRED CURRENT READY AGEmyapp-v1-6bb9cb95bd 3 3 3 7m50smyapp-v1-7b77cfb74f 0 0 0 15m 3层结构123456789101112[root@centos07-12 replicasettest]# kubectl get deploy -n blue-greenNAME READY UP-TO-DATE AVAILABLE AGEmyapp-v1 3/3 3 3 17m[root@centos07-12 replicasettest]# kubectl get replicaset -n blue-greenNAME DESIRED CURRENT READY AGEmyapp-v1-6bb9cb95bd 3 3 3 9m42smyapp-v1-7b77cfb74f 0 0 0 17m[root@centos07-12 replicasettest]# kubectl get pods -n blue-greenNAME READY STATUS RESTARTS AGEmyapp-v1-6bb9cb95bd-n54f9 1/1 Running 0 9m49smyapp-v1-6bb9cb95bd-vzdt5 1/1 Running 0 5m6smyapp-v1-6bb9cb95bd-xlp9l 1/1 Running 0 5m8s 使用kubectl命令修改deployment kubectl scale deployment myapp-v1 –replicas&#x3D;3 修改副本数 kubectl create -f xxx.yaml 和 kubectl apply -f xxx.yaml 都是创建，create不能运行多次，多次出错；apply 可以运行多次 kubectl edit deployment myapp-v1 修改副本数，执行后弹出deployment的配置页面，修改配置页面，保存后，直接生效 版本回退： kubectl rollout：版本升级相关功能，支持下面的选项：status：显示当前升级状态history：显示升级历史记录pause：暂停版本升级过程resume：继续已经暂停的版本升级过程restart：重启版本升级过程undo：回滚到上一级版本（可以使用–to-revision回滚到指定版本） kubectl rollout status deploy myapp-v1kubectl rollout history deploy myapp-v1 -n defaultkubectl rollout undo deployment myapp-v1 –to-revision&#x3D;1 -n default 金丝雀发布(灰度发布): Deployment控制器支持控制更新过程中的控制，如暂停(pause)或继续(resume)更新操作。kubectl set image deploy myapp-v1 nginx&#x3D;nginx:1.17.4 -n dev &amp;&amp; kubectl rollout pause deployment myapp-v1 -n dev 观察更新状态kubectl rollout status deploy pc-deployment -n dev 监控更新的过程kubectl get rs -n dev -o wide 继续更新kubectl rollout resume deploy pc-deployment -n dev 删除 Deploymentkubectl delete -f pc-deployment.yml Deployment和ReplicaSet的区别1 ReplicaSet核心作用在于帮助用户创建指定数量的pod副本，并确保pod副本一直处于满足用户期望的数量，起到多退少补的作用，并且还具有自动扩容缩容等机制主要由三个部分组成用户期望的pod副本数：用来定义由这个控制器管控的pod副本有几个标签选择器：当pod挂掉的时候，replicaset就通过标签选择器，选择指定标签的pod模板，再通过pod模板创建pod。pod资源模板：定义一个Pod模板，且需要给pod模板设置标签。给标签选择器使用 2 DeploymentReplicaSet并不是我们直接使用的控制器，kubernetes建议我们使用DeploymentDeployment控制器是工作在ReplicaSet之上的，Deployment通过控制ReplicaSet来控制pod，并不是直接控制pod。Deployment有ReplicaSet的所有功能Deployment支持自动扩容缩容，滚动更新和回滚等机制，并提供了一个声明式的定义功能，这种声明式定义使得我们将来创建资源时可以基于声明的逻辑来定义，我们那些所有定义的资源可以随时重新进行声明，随时改变我们在apiserver上的定义的目标期望状态，只要那些资源支持动态运行时修改，都能修改是帮我们管理无状态的应用的最好的控制器","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"20-replicaset资源","slug":"运维/K8S/基础/20-replicaset资源","date":"2023-05-10T02:00:00.000Z","updated":"2023-12-09T02:29:54.000Z","comments":true,"path":"2023/05/10/运维/K8S/基础/20-replicaset资源/","link":"","permalink":"https://dbbruce.github.io/2023/05/10/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/20-replicaset%E8%B5%84%E6%BA%90/","excerpt":"K8s控制器Replicaset前面我们学习了Pod，那我们在定义pod资源时，可以直接创建一个kind：Pod类型的自主式pod，但是这存在一个问题，假如pod被删除了，那这个pod就不能自我恢复，就会彻底被删除，线上这种情况非常危险，所以今天就给大家讲解下pod的控制器，所谓控制器就是能够管理pod，监测pod运行状况，当pod发生故障，可以自动恢复pod。也就是说能够代我们去管理pod中间层，并帮助我们确保每一个pod资源始终处于我们所定义或者我们所期望的目标状态，一旦pod资源出现故障，那么控制器会尝试重启pod或者里面的容器，如果一直重启有问题的话那么它可能会基于某种策略来进行重新布派或者重新编排；如果pod副本数量低于用户所定义的目标数量，它也会自动补全；如果多余，也会自动终止pod资源。","text":"K8s控制器Replicaset前面我们学习了Pod，那我们在定义pod资源时，可以直接创建一个kind：Pod类型的自主式pod，但是这存在一个问题，假如pod被删除了，那这个pod就不能自我恢复，就会彻底被删除，线上这种情况非常危险，所以今天就给大家讲解下pod的控制器，所谓控制器就是能够管理pod，监测pod运行状况，当pod发生故障，可以自动恢复pod。也就是说能够代我们去管理pod中间层，并帮助我们确保每一个pod资源始终处于我们所定义或者我们所期望的目标状态，一旦pod资源出现故障，那么控制器会尝试重启pod或者里面的容器，如果一直重启有问题的话那么它可能会基于某种策略来进行重新布派或者重新编排；如果pod副本数量低于用户所定义的目标数量，它也会自动补全；如果多余，也会自动终止pod资源。 1、Replicaset概述ReplicaSet是kubernetes中的一种副本控制器，简称rs，主要作用是控制由其管理的pod，使pod副本的数量始终维持在预设的个数。它的主要作用就是保证一定数量的Pod能够在集群中正常运行，它会持续监听这些Pod的运行状态，在Pod发生故障时重启pod，pod数量减少时重新运行新的 Pod副本。官方推荐不要直接使用ReplicaSet，用Deployments取而代之，Deployments是比ReplicaSet更高级的概念，它会管理ReplicaSet并提供很多其它有用的特性，最重要的是Deployments支持声明式更新，声明式更新的好处是不会丢失历史变更。所以Deployment控制器不直接管理Pod对象，而是由 Deployment 管理ReplicaSet，再由ReplicaSet负责管理Pod对象。 2、Replicaset工作原理：如何管理Pod？Replicaset核心作用在于代用户创建指定数量的pod副本，并确保pod副本一直处于满足用户期望的数量， 起到多退少补的作用，并且还具有自动扩容缩容等机制。 3、Replicaset控制器主要由三个部分组成： 1、用户期望的pod副本数：用来定义由这个控制器管控的pod副本有几个 2、标签选择器：选定哪些pod是自己管理的，如果通过标签选择器选到的pod副本数量少于我们指定的数量，需要用到下面的组件 3、pod资源模板：如果集群中现存的pod数量不够我们定义的副本中期望的数量怎么办，需要新建pod，这就需要pod模板，新建的pod是基于模板来创建的。 Replicaset资源清单文件编写技巧1、查看定义Replicaset资源需要的字段有哪些？12345678910111213# kubectl explain rsKIND: ReplicaSetVERSION: apps/v1DESCRIPTION: ReplicaSet ensures that a specified number of pod replicas are running at any given time.FIELDS: apiVersion &lt;string&gt; #当前资源使用的api版本，跟VERSION: apps/v1保持一致 kind &lt;string&gt; #资源类型，跟KIND: ReplicaSet保持一致 metadata &lt;Object&gt; #元数据，定义Replicaset名字的 spec &lt;Object&gt; ##定义副本数、定义标签选择器、定义Pod模板 status &lt;Object&gt; #状态信息，不能改 2、查看replicaset的spec字段如何定义？123456789101112131415# kubectl explain rs.specKIND: ReplicaSetVERSION: apps/v1RESOURCE: spec &lt;Object&gt;DESCRIPTION: Spec defines the specification of the desired behavior of the ReplicaSet. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status ReplicaSetSpec is the specification of a ReplicaSet.FIELDS: minReadySeconds &lt;integer&gt; 新创建的pod准备就绪的最小秒数，默认0 replicas &lt;integer&gt; #定义的pod副本数，根据我们指定的值创建对应数量的pod selector &lt;Object&gt; -required- #用于匹配pod的标签选择器 template &lt;Object&gt; #定义Pod的模板，基于这个模板定义的所有pod是一样的 3、查看replicaset的spec.template字段如何定义？ 对于template而言，其内部定义的就是pod，pod模板是一个独立的对象 1234567891011# kubectl explain rs.spec.templateKIND: ReplicaSetVERSION: apps/v1RESOURCE: template &lt;Object&gt;DESCRIPTION: Template is the object that describes the pod that will be created if insufficient replicas are detected。PodTemplateSpec describes the data a pod should have when created from a templateFIELDS: metadata &lt;Object&gt; spec &lt;Object&gt; 4、查看 kubectl explain rs.spec.template.spec字段 通过上面可以看到，ReplicaSet资源中有两个spec字段。第一个spec声明的是ReplicaSet定义多少个Pod副本（默认将仅部署1个Pod）、匹配Pod标签的选择器、创建pod的模板。第二个spec是spec.template.spec：主要用于Pod里的容器属性等配置。 .spec.template里的内容是声明Pod对象时要定义的各种属性，所以这部分也叫做PodTemplate（Pod模板）。还有一个值得注意的地方是：在.spec.selector中定义的标签选择器必须能够匹配到spec.template.metadata.labels里定义的Pod标签，否则Kubernetes将不允许创建ReplicaSet。 Replicaset使用案例：部署Guestbook留言板1、把frontend.tar.gz上传到centos07-22&#x2F;62上，解压1ctr -n=k8s.io images import frontend.tar.gz 2、编写一个ReplicaSet资源清单1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950# cat replicaset.yaml apiVersion: apps/v1kind: ReplicaSetmetadata: name: frontedn namespace: default labels: app: guestbook tier: frontendspec: replicas: 3 selector: matchLabels: tier1: frontend1 template: metadata: labels: tier1: frontend1 spec: containers: - name: php-redis image: docker.io/yecc/gcr.io-google_samples-gb-frontend:v3 imagePullPolicy: IfNotPresent ports: - containerPort: 80 startupProbe: periodSeconds: 5 initialDelaySeconds: 20 timeoutSeconds: 10 httpGet: scheme: HTTP port: 80 path: / livenessProbe: periodSeconds: 5 initialDelaySeconds: 20 timeoutSeconds: 10 httpGet: scheme: HTTP port: 80 path: / readinessProbe: periodSeconds: 5 initialDelaySeconds: 20 timeoutSeconds: 10 httpGet: scheme: HTTP port: 80 path: / 12[root@centos07-12 replicasettest]# kubectl apply -f replicaset.yamlreplicaset.apps/frontedn created kubectl get replicaset DESIRED 预期 CURRENT 当前 READY 就绪123[root@centos07-12 replicasettest]# kubectl get replicasetNAME DESIRED CURRENT READY AGEfrontedn 3 3 3 4m40s 12345[root@centos07-12 replicasettest]# kubectl get podsNAME READY STATUS RESTARTS AGEfrontedn-gq8c9 1/1 Running 0 6m41sfrontedn-rv6v2 1/1 Running 0 6m42sfrontedn-x2tq7 1/1 Running 0 6m41s pod的名字是由控制器的名字-随机数组成的 资源清单详细说明123456789101112131415161718192021222324apiVersion: apps/v1 #ReplicaSet 这个控制器属于的核心群组kind: ReplicaSet #创建的资源类型metadata: name: frontend #控制器的名字 labels: app: guestbook tier: frontendspec: replicas: 3 #管理的pod副本数量 selector: matchLabels: tier1: frontend1 #管理带有tier=frontend标签的pod template: #定义pod的模板 metadata: labels: tier1: frontend 1#pod标签，一定要有，这样上面控制器就能找到它要管理的pod是哪些了 spec: containers: #定义pod里运行的容器 - name: php-redis #定义容器的名字 image: yecc/gcr.io-google_samples-gb-frontend:v3 ports: #定义端口- name: http #定义容器的名字containerPort: 80 #定义容器暴露的端口 Replicaset管理pod：扩容、缩容、更新1、Replicaset实现pod的动态扩容ReplicaSet最核心的功能是可以动态扩容和回缩，如果我们觉得两个副本太少了，想要增加，只需要修改配置文件replicaset.yaml里的replicas的值即可，原来replicas: 3，现在变成replicaset: 4，修改之后，执行如下命令更新： 副本数改为41234567891011121314apiVersion: apps/v1kind: ReplicaSetmetadata: name: frontedn namespace: default labels: app: guestbook tier: frontendspec: replicas: 4 selector: ... 12[root@centos07-12 replicasettest]# kubectl apply -f replicaset.yamlreplicaset.apps/frontedn configured 123[root@centos07-12 replicasettest]# kubectl get replicasetNAME DESIRED CURRENT READY AGEfrontedn 4 4 3 10m 123456[root@centos07-12 replicasettest]# kubectl get pods -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESfrontedn-gq8c9 1/1 Running 0 10m 10.244.250.232 centos07-62 &lt;none&gt; &lt;none&gt;frontedn-rv6v2 1/1 Running 0 10m 10.244.193.154 centos07-22 &lt;none&gt; &lt;none&gt;frontedn-tqxlz 1/1 Running 0 43s 10.244.193.155 centos07-22 &lt;none&gt; &lt;none&gt;frontedn-x2tq7 1/1 Running 0 10m 10.244.250.233 centos07-62 &lt;none&gt; &lt;none&gt; 2、Replicaset实现pod的动态缩容如果我们觉得5个Pod副本太多了，想要减少，只需要修改配置文件replicaset.yaml里的replicas的值即可，把replicaset：4变成replicas: 2，修改之后，执行如下命令更新： 1234567891011121314&quot;replicaset.yaml&quot; 48L, 1066CapiVersion: apps/v1kind: ReplicaSetmetadata: name: frontedn namespace: default labels: app: guestbook tier: frontendspec: replicas: 2... 12[root@centos07-12 replicasettest]# kubectl apply -f replicaset.yamlreplicaset.apps/frontedn configured 123[root@centos07-12 replicasettest]# kubectl get replicasetNAME DESIRED CURRENT READY AGEfrontedn 2 2 2 13m 1234[root@centos07-12 replicasettest]# kubectl get pods -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESfrontedn-rv6v2 1/1 Running 0 13m 10.244.193.154 centos07-22 &lt;none&gt; &lt;none&gt;frontedn-x2tq7 1/1 Running 0 13m 10.244.250.233 centos07-62 &lt;none&gt; &lt;none&gt; 3、Replicaset实现pod的更新 把myapp-v2.tar.gz上传到centos07-22&#x2F;62上，手动解压1[root@centos07-22 ~]# ctr -n=k8s.io images import myapp-v2.tar.gz 修改镜像123456789101112131415161718192021222324apiVersion: apps/v1kind: ReplicaSetmetadata: name: frontedn namespace: default labels: app: guestbook tier: frontendspec: replicas: 2 selector: matchLabels: tier1: frontend1 template: metadata: labels: tier1: frontend1 spec: containers: - name: php-redis image: docker.io/ikubernetes/myapp:v2... 12[root@centos07-12 replicasettest]# kubectl apply -f replicaset.yamlreplicaset.apps/frontedn configured 123[root@centos07-12 replicasettest]# kubectl get replicasetNAME DESIRED CURRENT READY AGEfrontedn 2 2 2 17m 1234[root@centos07-12 replicasettest]# kubectl get pods -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESfrontedn-rv6v2 1/1 Running 0 17m 10.244.193.154 centos07-22 &lt;none&gt; &lt;none&gt;frontedn-x2tq7 1/1 Running 0 17m 10.244.250.233 centos07-62 &lt;none&gt; &lt;none&gt; 1234567891011121314151617181920212223242526[root@centos07-12 replicasettest]# curl 10.244.193.154&lt;html ng-app=&quot;redis&quot;&gt; &lt;head&gt; &lt;title&gt;Guestbook&lt;/title&gt; &lt;link rel=&quot;stylesheet&quot; href=&quot;//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css&quot;&gt; &lt;script src=&quot;https://ajax.googleapis.com/ajax/libs/angularjs/1.2.12/angular.min.js&quot;&gt;&lt;/script&gt; &lt;script src=&quot;controllers.js&quot;&gt;&lt;/script&gt; &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/0.13.0/ui-bootstrap-tpls.js&quot;&gt;&lt;/script&gt; &lt;/head&gt; &lt;body ng-controller=&quot;RedisCtrl&quot;&gt; &lt;div style=&quot;width: 50%; margin-left: 20px&quot;&gt; &lt;h2&gt;Guestbook&lt;/h2&gt; &lt;form&gt; &lt;fieldset&gt; &lt;input ng-model=&quot;msg&quot; placeholder=&quot;Messages&quot; class=&quot;form-control&quot; type=&quot;text&quot; name=&quot;input&quot;&gt;&lt;br&gt; &lt;button type=&quot;button&quot; class=&quot;btn btn-primary&quot; ng-click=&quot;controller.onRedis()&quot;&gt;Submit&lt;/button&gt; &lt;/fieldset&gt; &lt;/form&gt; &lt;div&gt; &lt;div ng-repeat=&quot;msg in messages track by $index&quot;&gt; &#123;&#123;msg&#125;&#125; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt; &lt;/body&gt;&lt;/html&gt; 上面可以看到，虽然replicaset.yaml修改了镜像，执行了kubectl apply -f replicaset.yaml，但是pod还是用的frontend:v3这个镜像，没有实现自动更新 frontedn-rv6v2 - 10.244.193.154 pod删除12[root@centos07-12 replicasettest]# kubectl delete pods frontedn-rv6v2pod &quot;frontedn-rv6v2&quot; deleted #重新生成了一个新的pod：frontedn-9cgbz - 10.244.193.156 1234[root@centos07-12 replicasettest]# kubectl get pods -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESfrontedn-9cgbz 0/1 Running 0 5s 10.244.193.156 centos07-22 &lt;none&gt; &lt;none&gt;frontedn-x2tq7 1/1 Running 0 18m 10.244.250.233 centos07-62 &lt;none&gt; &lt;none&gt; 新生成的pod的镜像已经变成了myapp的，说明更新完成了12[root@centos07-12 replicasettest]# curl 10.244.193.156Hello MyApp | Version: v2 | &lt;a href=&quot;hostname.html&quot;&gt;Pod Name&lt;/a&gt; 总结：生产环境如果升级，可以删除一个pod，观察一段时间之后没问题再删除另一个pod，但是这样需要人工干预多次；实际生产环境一般采用蓝绿发布，原来有一个rs1，再创建一个rs2（控制器），通过修改service标签，修改service可以匹配到rs2的控制器，这样才是蓝绿发布，这个也需要我们精心的部署规划，我们有一个控制器就是建立在rs之上完成的，叫做Deployment 删除 replicaset12root@centos07-12 replicasettest]# kubectl delete replicaset frontednreplicaset.apps &quot;frontedn&quot; deleted 12[root@centos07-12 replicasettest]# kubectl get replicasetNo resources found in default namespace. 12[root@centos07-12 replicasettest]# kubectl get podsNo resources found in default namespace.","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"19-Pod容器健康探测","slug":"运维/K8S/基础/19-Pod容器健康探测","date":"2023-05-09T12:00:00.000Z","updated":"2023-12-07T14:30:29.000Z","comments":true,"path":"2023/05/09/运维/K8S/基础/19-Pod容器健康探测/","link":"","permalink":"https://dbbruce.github.io/2023/05/09/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/19-Pod%E5%AE%B9%E5%99%A8%E5%81%A5%E5%BA%B7%E6%8E%A2%E6%B5%8B/","excerpt":"为什么要对容器做探测？在 Kubernetes 中 Pod 是最小的计算单元，而一个 Pod 又由多个容器组成，相当于每个容器就是一个应用，应用在运行期间，可能因为某些意外情况致使程序挂掉。那么如何监控这些容器状态稳定性，保证服务在运行期间不会发生问题，发生问题后进行重启等机制，就成为了重中之重的事情，考虑到这点 kubernetes 推出了活性探针机制。有了存活性探针能保证程序在运行中如果挂掉能够自动重启，但是还有个经常遇到的问题，比如说，在Kubernetes 中启动Pod，显示明明Pod已经启动成功，且能访问里面的端口，但是却返回错误信息。还有就是在执行滚动更新时候，总会出现一段时间，Pod对外提供网络访问，但是访问却发生404，这两个原因，都是因为Pod已经成功启动，但是 Pod 的的容器中应用程序还在启动中导致，考虑到这点Kubernetes推出了就绪性探针机制","text":"为什么要对容器做探测？在 Kubernetes 中 Pod 是最小的计算单元，而一个 Pod 又由多个容器组成，相当于每个容器就是一个应用，应用在运行期间，可能因为某些意外情况致使程序挂掉。那么如何监控这些容器状态稳定性，保证服务在运行期间不会发生问题，发生问题后进行重启等机制，就成为了重中之重的事情，考虑到这点 kubernetes 推出了活性探针机制。有了存活性探针能保证程序在运行中如果挂掉能够自动重启，但是还有个经常遇到的问题，比如说，在Kubernetes 中启动Pod，显示明明Pod已经启动成功，且能访问里面的端口，但是却返回错误信息。还有就是在执行滚动更新时候，总会出现一段时间，Pod对外提供网络访问，但是访问却发生404，这两个原因，都是因为Pod已经成功启动，但是 Pod 的的容器中应用程序还在启动中导致，考虑到这点Kubernetes推出了就绪性探针机制 1.默认的健康检查Kubernetes默认的健康检查机制： 每个容器启动时都会执行一个进程， 此进程由Dockerfile的CMD或ENTRYPOINT指定。 如果进程退出时返回码非零， 则认为容器发生故障， Kubernetes就会根据restartPolicy策略决定是否重启容器。 123456789101112131415161718# cat chech.yamlapiVersion: v1kind: Podmetadata: name: check namespace: default labels: app: checkspec: containers: - name: check image: docker.io/library/busybox:1.28 imagePullPolicy: IfNotPresent command: - /bin/sh - -c - sleep 10;exit 12345678910111213[root@centos07-12 ~]# kubectl get pods -wNAME READY STATUS RESTARTS AGEcheck 0/1 Pending 0 0scheck 0/1 Pending 0 0scheck 0/1 ContainerCreating 0 0scheck 0/1 ContainerCreating 0 1scheck 1/1 Running 0 3scheck 0/1 Completed 0 13scheck 1/1 Running 1 (2s ago) 14scheck 0/1 Completed 1 (12s ago) 24scheck 0/1 CrashLoopBackOff 1 (12s ago) 35scheck 1/1 Running 2 (13s ago) 36scheck 0/1 Completed 2 (23s ago) 46s 在上面的例子中， 容器进程返回值非零， Kubernetes则认为容器发生故障， 需要重启。 有不少情况是发生了故障， 但进程并不会退出。 比如访问Web服务器时显示500内部错误， 可能是系统超载， 也可能是资源死锁， 此时httpd进程并没有异常退出， 在这种情况下重启容器可能是最直接、 最有效的解决方案。 k8s 提供了三种来实现容器探测的方法，分别是： 1、startupProbe：启动探测，探测容器中的应用是否已经启动。如果提供了启动探测(startup probe)，则禁用所有其他探测，直到它成功为止。如果启动探测失败，kubelet 将杀死容器，容器服从其重启策略进行重启。如果容器没有提供启动探测，则默认状态为成功Success。 2、livenessProbe：存活探测，用指定的方式（exec、tcp、http）检测pod中的容器是否正常运行，如果检测失败，则认为容器不健康，那么Kubelet将根据Pod中设置的 restartPolicy策略来判断Pod 是否要进行重启操作，如果容器配置中没有配置 livenessProbe，Kubelet 将认为存活探针探测一直为success（成功）状态。 3、readnessProbe：就绪性探针，用于检测容器中的应用是否可以接受请求，当探测成功后才使Pod对外提供网络访问，将容器标记为就绪状态，可以加到pod前端负载，如果探测失败，则将容器标记为未就绪状态，会把pod从前端负载移除。 真正的启动顺序可以自定义在pod启动时是否执行这些检测，如果不设置，则检测结果均默认为通过，如果设置，则顺序为startupProbe&gt;readinessProbe和livenessProbe，readinessProbe和livenessProbe是并发关系 官方文档：Caution: Liveness probes do not wait for readiness probes to succeed. If you want to wait before executing a liveness probe you should use initialDelaySeconds or a startupProbe 也就是 Liveness probes 并不会等到 Readiness probes 成功之后才运行，根据上面的官方文档，Liveness 和 readiness 应该是某种并发的关系。 目前LivenessProbe和ReadinessProbe、startupprobe探测都支持下面三种探针： 1、exec：在容器中执行指定的命令，如果执行成功，退出码为 0 则探测成功。 2、TCPSocket：通过容器的 IP 地址和端口号执行 TCP 检 查，如果能够建立 TCP 连接，则表明容器健康。 3、HTTPGet：通过容器的IP地址、端口号及路径调用 HTTP Get方法，如果响应的状态码大于等于200且小于400，则认为容器健康 探针探测结果有以下值： 1、Success：表示通过检测。 2、Failure：表示未通过检测。 3、Unknown：表示检测没有正常进行。 Pod探针相关的属性：探针(Probe)有许多可选字段，可以用来更加精确的控制Liveness和Readiness两种探针的行为 initialDelaySeconds：容器启动后要等待多少秒后探针开始工作，单位“秒”，默认是 0 秒，最小值是 0 periodSeconds： 执行探测的时间间隔（单位是秒），默认为 10s，单位“秒”，最小值是1 timeoutSeconds： 探针执行检测请求后，等待响应的超时时间，默认为1，单位“秒”。 successThreshold：连续探测几次成功，才认为探测成功，默认为 1，在 Liveness 探针中必须为1，最小值为1。 failureThreshold： 探测失败的重试次数，重试一定次数后将认为失败，在 readiness 探针中，Pod会被标记为未就绪，默认为 3，最小值为 1 两种探针区别： ReadinessProbe 和 livenessProbe 可以使用相同探测方式，只是对 Pod 的处置方式不同： readinessProbe 当检测失败后，将 Pod 的 IP:Port 从对应的 EndPoint 列表中删除。 livenessProbe 当检测失败后，将杀死容器并根据 Pod 的重启策略来决定作出对应的措施。 启动探测startupprobe1、exec模式123456789101112131415161718192021222324# cat startup-exec.yaml apiVersion: v1kind: Podmetadata: name: startupprobespec: containers: - name: startup image: docker.io/library/tomcat:8.5-jre8-alpine imagePullPolicy: IfNotPresent ports: - containerPort: 8080 startupProbe: exec: command: - &quot;/bin/sh&quot; - &quot;-c&quot; - &quot;aaa ps aux | grep tomcat&quot; initialDelaySeconds: 6 #容器启动后多久开始探测 periodSeconds: 5 #执行探测的时间间隔 timeoutSeconds: 4 #探针执行检测请求后，等待响应的超时时间 successThreshold: 1 #成功多少次才算成功 failureThreshold: 2 #失败多少次才算失败 注释上面的命令是错误的，所以检测会失败：正确格式：删除aaa &#x3D; &#x2F;bin&#x2F;sh -c ps aux|grep tomcat 12[root@centos07-12 probe1test]# kubectl apply -f startup-exec.yamlpod/startupprobe created 每次时间间隔16秒，是这样算的，initialDelaySeconds: 6 + periodSeconds: 5 + timeoutSeconds: 4 &#x3D; 15秒 1234567891011121314[root@centos07-12 ~]# kubectl get pods -wNAME READY STATUS RESTARTS AGEstartupprobe 0/1 Pending 0 0sstartupprobe 0/1 Pending 0 0sstartupprobe 0/1 ContainerCreating 0 0sstartupprobe 0/1 ContainerCreating 0 0sstartupprobe 0/1 Running 0 1sstartupprobe 0/1 Running 1 (1s ago) 16s startupprobe 0/1 Running 2 (1s ago) 31sstartupprobe 0/1 Running 3 (1s ago) 46sstartupprobe 0/1 CrashLoopBackOff 3 (0s ago) 60sstartupprobe 0/1 Running 4 (26s ago) 86sstartupprobe 0/1 Running 5 (2s ago) 102sstartupprobe 0/1 CrashLoopBackOff 5 (1s ago) 116s 2、tcpsocket模式123456789101112131415161718192021# cat startup-tcpsocket.yaml apiVersion: v1kind: Podmetadata: name: startupprobespec: containers: - name: startup image: docker.io/library/tomcat:8.5-jre8-alpine imagePullPolicy: IfNotPresent ports: - containerPort: 8080 startupProbe: tcpSocket: port: 8080 initialDelaySeconds: 20 #容器启动后多久开始探测 periodSeconds: 20 #执行探测的时间间隔 timeoutSeconds: 10 #探针执行检测请求后，等待响应的超时时间 successThreshold: 1 #成功多少次才算成功 failureThreshold: 3 #失败多少次才算失败 12[root@centos07-12 probe1test]# kubectl apply -f startup-tcpsocket.yamlpod/startupprobe created 123456[root@centos07-12 ~]# kubectl get pods -wNAME READY STATUS RESTARTS AGEstartupprobe 0/1 Running 0 7sstartupprobe 0/1 Running 0 10sstartupprobe 0/1 Running 0 40sstartupprobe 1/1 Running 0 40s 1234[root@centos07-12 ~]# telnet 10.244.250.224 8080Trying 10.244.250.224...Connected to 10.244.250.224.Escape character is &#x27;^]&#x27;. 端口检测通过，pod正常启动 3、httpget模式12345678910111213141516171819202122232425# cat startup-httpget.yaml apiVersion: v1kind: Podmetadata: name: startupprobe namespace: default labels: app: sappspec: containers: - name: startup image: docker.io/library/tomcat:8.5-jre8-alpine imagePullPolicy: IfNotPresent ports: - containerPort: 8080 startupProbe: httpGet: path: / port: 8080 initialDelaySeconds: 20 periodSeconds: 20 timeoutSeconds: 10 successThreshold: 1 failureThreshold: 3 存活性探测livenessProbe 官网地址：https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/ 1、通过exec方式做健康探测123456789101112131415161718192021222324#cat liveness-exec.yamlapiVersion: v1kind: Podmetadata: name: liveness-exec labels: app: livenessspec: containers: - name: liveness image: busybox:1.28 imagePullPolicy: IfNotPresent args: #创建测试探针探测的文件 - /bin/sh - -c - touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600 livenessProbe: initialDelaySeconds: 10 #延迟检测时间 periodSeconds: 5 #检测时间间隔 exec: command: - cat - /tmp/healthy 容器启动设置执行的命令： &#x2F;bin&#x2F;sh -c “touch &#x2F;tmp&#x2F;healthy; sleep 30; rm -rf &#x2F;tmp&#x2F;healthy; sleep 600”容器在初始化后，首先创建一个 &#x2F;tmp&#x2F;healthy 文件，然后执行睡眠命令，睡眠 30 秒，到时间后执行删除 &#x2F;tmp&#x2F;healthy 文件命令。而设置的存活探针检检测方式为执行 shell 命令，用 cat 命令输出 healthy 文件的内容，如果能成功执行这条命令，存活探针就认为探测成功，否则探测失败。在前 30 秒内，由于文件存在，所以存活探针探测时执行 cat &#x2F;tmp&#x2F;healthy 命令成功执行。30 秒后 healthy 文件被删除，所以执行命令失败，Kubernetes 会根据 Pod 设置的重启策略来判断，是否重启 Pod。12345[root@centos07-12 ~]# kubectl get pods -wNAME READY STATUS RESTARTS AGEliveness-exec 1/1 Running 0 3sliveness-exec 1/1 Running 1 (2s ago) 77sliveness-exec 1/1 Running 2 (1s ago) 2m31s &#x2F;tmp&#x2F;healthy 文件删除后，检测失败，重启pod1234567891011[root@centos07-12 probe1test]# kubectl describe pods liveness-exec...Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 3m48s default-scheduler Successfully assigned default/liveness-exec to centos07-62 Warning Unhealthy 33s (x9 over 3m13s) kubelet Liveness probe failed: cat: can&#x27;t open &#x27;/tmp/healthy&#x27;: No such file or directory Normal Killing 33s (x3 over 3m3s) kubelet Container liveness failed liveness probe, will be restarted Normal Pulled 2s (x4 over 3m47s) kubelet Container image &quot;busybox:1.28&quot; already present on machine Normal Created 2s (x4 over 3m47s) kubelet Created container liveness Normal Started 2s (x4 over 3m47s) kubelet Started container liveness 2、通过HTTP方式做健康探测1ctr -n k8s.io images import springboot.tar.gz 123[root@centos07-22 ~]# crictl imagesIMAGE TAG IMAGE ID SIZEdocker.io/mydlqclub/springboot-helloworld 0.0.1 950026ec75570 106MB 123456789101112131415161718192021# cat liveness-http.yamlapiVersion: v1kind: Podmetadata: name: liveness-http labels: test: livenessspec: containers: - name: liveness image: mydlqclub/springboot-helloworld:0.0.1 imagePullPolicy: IfNotPresent livenessProbe: initialDelaySeconds: 20 #延迟加载时间 periodSeconds: 5 #重试时间间隔 timeoutSeconds: 10 #超时时间设置 httpGet: scheme: HTTP port: 8081 path: /actuator/health 1234567[root@centos07-12 ~]# kubectl get pods -wNAME READY STATUS RESTARTS AGEliveness-http 0/1 Pending 0 0sliveness-http 0/1 Pending 0 0sliveness-http 0/1 ContainerCreating 0 0sliveness-http 0/1 ContainerCreating 0 1sliveness-http 1/1 Running 0 2s 123[root@centos07-12 ~]# kubectl get pods -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESliveness-http 1/1 Running 0 2m2s 10.244.250.228 centos07-62 &lt;none&gt; &lt;none&gt; 1234567891011121314151617[root@centos07-12 probe1test]# curl -vv 10.244.250.228:8081/actuator/health* About to connect() to 10.244.250.228 port 8081 (#0)* Trying 10.244.250.228...* Connected to 10.244.250.228 (10.244.250.228) port 8081 (#0)&gt; GET /actuator/health HTTP/1.1&gt; User-Agent: curl/7.29.0&gt; Host: 10.244.250.228:8081&gt; Accept: */*&gt;&lt; HTTP/1.1 200&lt; Content-Type: application/vnd.spring-boot.actuator.v2+json;charset=UTF-8&lt; Transfer-Encoding: chunked&lt; Date: Thu, 07 Dec 2023 13:41:23 GMT&lt;* Connection #0 to host 10.244.250.228 left intact&#123;&quot;status&quot;:&quot;UP&quot;&#125; 上面 Pod 中启动的容器是一个 SpringBoot 应用，其中引用了 Actuator 组件，提供了 &#x2F;actuator&#x2F;health 健康检查地址，存活探针可以使用 HTTPGet 方式向服务发起请求，请求 8081 端口的 &#x2F;actuator&#x2F;health 路径来进行存活判断： 任何大于或等于200且小于400的代码表示探测成功。 任何其他代码表示失败。 如果探测失败，则会杀死 Pod 进行重启操作。 httpGet探测方式有如下可选的控制字段: scheme: 用于连接host的协议，默认为HTTP。 host：要连接的主机名，默认为Pod IP，可以在http request head中设置host头部。 port：容器上要访问端口号或名称。 path：http服务器上的访问URI。 httpHeaders：自定义HTTP请求headers，HTTP允许重复headers。 3、通过TCP方式做健康探测123456789101112131415161718# cat liveness-tcp.yamlapiVersion: v1kind: Podmetadata: name: liveness-tcp labels: app: livenessspec: containers: - name: liveness image: docker.io/library/nginx:latest imagePullPolicy: IfNotPresent livenessProbe: initialDelaySeconds: 15 periodSeconds: 20 tcpSocket: port: 80 12[root@centos07-12 probe1test]# kubectl apply -f liveness-tcp.yamlpod/liveness-tcp created 1234567[root@centos07-12 ~]# kubectl get pods -owide -wNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESliveness-tcp 0/1 Pending 0 0s &lt;none&gt; &lt;none&gt; &lt;none&gt; &lt;none&gt;liveness-tcp 0/1 Pending 0 0s &lt;none&gt; centos07-62 &lt;none&gt; &lt;none&gt;liveness-tcp 0/1 ContainerCreating 0 0s &lt;none&gt; centos07-62 &lt;none&gt; &lt;none&gt;liveness-tcp 0/1 ContainerCreating 0 0s &lt;none&gt; centos07-62 &lt;none&gt; &lt;none&gt;liveness-tcp 1/1 Running 0 2s 10.244.250.229 centos07-62 &lt;none&gt; &lt;none&gt; 1234[root@centos07-12 probe1test]# telnet 10.244.250.229 80Trying 10.244.250.229...Connected to 10.244.250.229.Escape character is &#x27;^]&#x27;. TCP 检查方式和 HTTP 检查方式非常相似，在容器启动 initialDelaySeconds 参数设定的时间后，kubelet 将发送第一个 livenessProbe 探针，尝试连接容器的 80 端口，如果连接失败则将杀死 Pod 重启容器。 就绪性探测readinessProbePod 的ReadinessProbe 探针使用方式和 LivenessProbe 探针探测方法一样，也是支持三种，只是一个是用于探测应用的存活，一个是判断是否对外提供流量的条件。 这里用一个 Springboot 项目，设置 ReadinessProbe 探测 SpringBoot 项目的 8081 端口下的 &#x2F;actuator&#x2F;health 接口，如果探测成功则代表内部程序以及启动，就开放对外提供接口访问，否则内部应用没有成功启动，暂不对外提供访问，直到就绪探针探测成功。 1、ReadinessProbe 探针使用示例12345678910111213141516171819202122232425262728293031323334353637383940414243444546# cat readiness-exec.yamlapiVersion: v1kind: Servicemetadata: name: springboot labels: app: springbootspec: type: NodePort ports: - name: server port: 8080 targetPort: 8080 nodePort: 31180 - name: management port: 8081 targetPort: 8081 nodePort: 31181 selector: app: springboot---apiVersion: v1kind: Podmetadata: name: springboot labels: app: springbootspec: containers: - name: springboot image: mydlqclub/springboot-helloworld:0.0.1 imagePullPolicy: IfNotPresent ports: - name: server containerPort: 8080 - name: management containerPort: 8081 readinessProbe: initialDelaySeconds: 20 periodSeconds: 5 timeoutSeconds: 10 httpGet: scheme: HTTP port: 8081 path: /actuator/health 12345678[root@centos07-12 ~]# kubectl get pods -l app=springboot -wNAME READY STATUS RESTARTS AGEspringboot 0/1 Pending 0 0sspringboot 0/1 Pending 0 0sspringboot 0/1 ContainerCreating 0 1sspringboot 0/1 ContainerCreating 0 1sspringboot 0/1 Running 0 3sspringboot 1/1 Running 0 26s 123[root@centos07-12 ~]# kubectl get svc -l app=springboot -wNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGEspringboot NodePort 10.106.160.209 &lt;none&gt; 8080:31180/TCP,8081:31181/TCP 2m41s 12345678910111213141516171819202122[root@centos07-12 ~]# kubectl describe svc springbootName: springbootNamespace: defaultLabels: app=springbootAnnotations: &lt;none&gt;Selector: app=springbootType: NodePortIP Family Policy: SingleStackIP Families: IPv4IP: 10.106.160.209IPs: 10.106.160.209Port: server 8080/TCPTargetPort: 8080/TCPNodePort: server 31180/TCPEndpoints: 10.244.250.231:8080Port: management 8081/TCPTargetPort: 8081/TCPNodePort: management 31181/TCPEndpoints: 10.244.250.231:8081Session Affinity: NoneExternal Traffic Policy: ClusterEvents: &lt;none&gt; 12[root@centos07-12 probe1test]# curl 10.244.250.231:8081/actuator/health&#123;&quot;status&quot;:&quot;UP&quot;&#125; ReadinessProbe + LivenessProbe +startupProbe配合使用示例一般程序中需要设置三种探针结合使用，并且也要结合实际情况，来配置初始化检查时间和检测间隔，下面列一个简单的 SpringBoot 项目的例子。startupProbe探测没有问题后，才能开始其他的探测pod的默认重启策略是alway，总是重启 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162# cat start-read-live.yaml apiVersion: v1kind: Servicemetadata: name: springboot-live labels: app: springbootspec: type: NodePort ports: - name: server port: 8080 targetPort: 8080 nodePort: 31180 - name: management port: 8081 targetPort: 8081 nodePort: 31181 selector: app: springboot---apiVersion: v1kind: Podmetadata: name: springboot-live labels: app: springbootspec: containers: - name: springboot image: mydlqclub/springboot-helloworld:0.0.1 imagePullPolicy: IfNotPresent ports: - name: server containerPort: 8080 - name: management containerPort: 8081 readinessProbe: initialDelaySeconds: 20 periodSeconds: 5 timeoutSeconds: 10 httpGet: scheme: HTTP port: 8081 path: /actuator/health livenessProbe: initialDelaySeconds: 20 periodSeconds: 5 timeoutSeconds: 10 httpGet: scheme: HTTP port: 8081 path: /actuator/health startupProbe: initialDelaySeconds: 20 periodSeconds: 5 timeoutSeconds: 10 httpGet: scheme: HTTP port: 8081 path: /actuator/health 涉及的其他知识kubernetes args字段 描述 dockerfile kubernetes 容器运行的命令 Entrypoint command 传递给命令的参数 Cmd args 由上表可以看出，k8s的container里的command参数相当于Entrypoint， args参数相当于CMD，command和args可以单独使用，都可以执行一条完成的语句。而如果结合使用args就是作为command的参数传递 service类似pod前端的代理 pod的ready 不是1&#x2F;1 时，endpoints是空 ready 1&#x2F;1 时， endpoints 有内容 一个yaml文件里可以定义多个资源，使用三个横线分隔，—12345678910111213apiVersion: v1kind: Servicemetadata: ... --- ############## 这里apiVersion: v1kind: Podmetadata: ...","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"18-Pod生命周期完整流程介绍","slug":"运维/K8S/基础/18-Pod生命周期完整流程介绍","date":"2023-05-09T02:00:00.000Z","updated":"2023-12-06T15:42:13.000Z","comments":true,"path":"2023/05/09/运维/K8S/基础/18-Pod生命周期完整流程介绍/","link":"","permalink":"https://dbbruce.github.io/2023/05/09/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/18-Pod%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B%E4%BB%8B%E7%BB%8D/","excerpt":"Pod生命周期pod从开始创建到终止退出的时间范围称为Pod生命周期生命周期包含以下几个重要流程：创建主容器（containers）是必须的操作，初始化容器（initContainers），容器启动后钩子，启动探测、存活性探测，就绪性探测，容器停止前钩子","text":"Pod生命周期pod从开始创建到终止退出的时间范围称为Pod生命周期生命周期包含以下几个重要流程：创建主容器（containers）是必须的操作，初始化容器（initContainers），容器启动后钩子，启动探测、存活性探测，就绪性探测，容器停止前钩子 pod在整个生命周期的过程中总会处于以下几个状态： Pending：创建了pod资源并存入etcd中，但尚未完成调度。 ContainerCreating：Pod 的调度完成，被分配到指定 Node 上。处于容器创建的过程中。通常是在拉取镜像的过程中。 Running：Pod 包含的所有容器都已经成功创建，并且成功运行起来。 Succeeded：Pod中的所有容器都已经成功终止并且不会被重启 Failed：所有容器都已经终止，但至少有一个容器终止失败，也就是说容器返回了非0值的退出状态或已经被系统终止。 Unknown：因为某些原因无法取得 Pod 的状态。这种情况通常是因为与 Pod 所在主机通信失败。 pod生命周期的重要行为： 1.在启动任何容器之前，先创建pause基础容器，它初始化Pod的环境并为后续加⼊的容器提供共享的名称空间。 2.初始化容器（initcontainer）：一个pod可以拥有任意数量的init容器。init容器是按照顺序以此执行的，并且仅当最后一个init容器执行完毕才会去启动主容器。 3.生命周期钩子：pod允许定义两种类型的生命周期钩子，启动后(post-start)钩子和停止前(pre-stop)钩子这些生命周期钩子是基于每个容器来指定的，和init容器不同的是，init容器是应用到整个pod。而这些钩子是针对容器的，是在容器启动后和停止前执行的。 4.容器探测： 4.1.对Pod健康状态诊断。分为三种： Startupprobe、Livenessprobe(存活性探测)， Readinessprobe(就绪性检测) Startup（启动探测）:探测容器是否正常运行Liveness(存活性探测)：判断容器是否处于runnning状态，根据重启策略决定是否重启容器Readiness(就绪性检测)：判断容器是否准备就绪并对外提供服务，将容器设置为不可用，不接受service转发的请求 4.2.三种探针用于Pod检测： ExecAction：在容器中执行一个命令，并根据返回的状态码进行诊断，只有返回0为成功TCPSocketAction：通过与容器的某TCP端口尝试建立连接HTTPGetAction：通过向容器IP地址的某指定端口的path发起HTTP GET请求。 5.容器的重启策略：定义是否重启Pod对象Always：但凡Pod对象终止就重启，默认设置OnFailure：仅在Pod出现错误时才重启Never：从不注：一旦Pod绑定到一个节点上，就不会被重新绑定到另一个节点上，要么重启，要么终止 6.pod的终止过程终止过程主要分为如下几个步骤：(1)用户发出删除 pod 命令：kubectl delete pods ，kubectl delete -f yaml(2)Pod 对象随着时间的推移更新，在宽限期（默认情况下30秒），pod 被视为“dead”状态(3)将 pod 标记为“Terminating”状态(4)第三步同时运行，监控到 pod 对象为“Terminating”状态的同时启动 pod 关闭过程(5)第三步同时进行，endpoints 控制器监控到 pod 对象关闭，将pod与service匹配的 endpoints 列表中删除(6)如果 pod 中定义了 preStop 钩子处理程序，则 pod 被标记为“Terminating”状态时以同步的方式启动执行；若宽限期结束后，preStop 仍未执行结束，第二步会重新执行并额外获得一个2秒的小宽限期(7)Pod 内对象的容器收到 TERM 信号(8)宽限期结束之后，若存在任何一个运行的进程，pod 会收到 SIGKILL 信号(9)Kubelet 请求 API Server 将此 Pod 资源宽限期设置为0从而完成删除操作 Init容器spec字段下有个initContainers字段(初始化容器)，Init容器就是做初始化工作的容器。可以有一个或多个，如果多个按照定义的顺序依次执行，先执行初始化容器1，再执行初始化容器2等，等初始化容器执行完具体操作之后初始化容器就退出了，只有所有的初始化容器执行完后，主容器才启动。由于一个Pod里容器存储卷是共享的，所以Init Container里产生的数据可以被主容器使用到，Init Container可以在多种K8S资源里被使用到，如Deployment、DaemonSet, StatefulSet、Job等，但都是在Pod启动时，在主容器启动前执行，做初始化工作。 初始化容器与主容器区别是:1、初始化容器不支持 Readinessprobe,因为它们必须在Pod就绪之前运行完成2、每个Init容器必须运行成功,下一个才能够运行 初始化容器的官方地址：https://kubernetes.io/docs/concepts/workloads/pods/init-containers/#init-containers-in-use 初始化容器使用案例11234567891011121314151617181920212223# cat init.yamlapiVersion: v1kind: Podmetadata: name: myapp-pod namespace: default labels: app: myappspec: initContainers: - name: init-myserver image: docker.io/library/busybox:1.28 imagePullPolicy: IfNotPresent command: [&#x27;sh&#x27;, &#x27;-c&#x27;, &quot;until nslookup myservice.$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace).svc.cluster.local; do echo waiting for myservice; sleep 2; done&quot;] - name: init-mydb image: docker.io/library/busybox:1.28 imagePullPolicy: IfNotPresent command: [&#x27;sh&#x27;, &#x27;-c&#x27;, &quot;until nslookup mydb.$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace).svc.cluster.local; do echo waiting for mydb; sleep 2; done&quot;] containers: - name: myapp-container image: docker.io/library/busybox:1.28 command: [&#x27;sh&#x27;, &#x27;-c&#x27;, &#x27;echo The app is running! &amp;&amp; sleep 3600&#x27;] 1[root@centos07-12 inittest]# kubectl apply -f init.yaml 有2个容器初始化123[root@centos07-12 inittest]# kubectl get pods -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESmyapp-pod 0/1 Init:0/2 0 52s 10.244.250.208 centos07-62 &lt;none&gt; &lt;none&gt; 查看详情1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192[root@centos07-12 inittest]# kubectl describe pod myapp-podName: myapp-podNamespace: defaultPriority: 0Service Account: defaultNode: centos07-62/192.168.1.62Start Time: Wed, 06 Dec 2023 20:39:52 +0800Labels: app=myappAnnotations: cni.projectcalico.org/podIP: 10.244.250.208/32 cni.projectcalico.org/podIPs: 10.244.250.208/32Status: PendingIP: 10.244.250.208IPs: IP: 10.244.250.208Init Containers: init-myserver: Container ID: containerd://d15939ab99e8e35dc158548e2189a99dd86565c4278cce07392e960060aedeb2 Image: docker.io/library/busybox:1.28 Image ID: docker.io/library/busybox@sha256:141c253bc4c3fd0a201d32dc1f493bcf3fff003b6df416dea4f41046e0f37d47 Port: &lt;none&gt; Host Port: &lt;none&gt; Command: sh -c until nslookup myservice.$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace).svc.cluster.local; do echo waiting for myservice; sleep 2; done State: Running Started: Wed, 06 Dec 2023 20:40:05 +0800 Ready: False Restart Count: 0 Environment: &lt;none&gt; Mounts: /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-h8chq (ro) init-mydb: Container ID: Image: docker.io/library/busybox:1.28 Image ID: Port: &lt;none&gt; Host Port: &lt;none&gt; Command: sh -c until nslookup mydb.$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace).svc.cluster.local; do echo waiting for mydb; sleep 2; done State: Waiting Reason: PodInitializing Ready: False Restart Count: 0 Environment: &lt;none&gt; Mounts: /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-h8chq (ro)Containers: myapp-container: Container ID: Image: docker.io/library/busybox:1.28 Image ID: Port: &lt;none&gt; Host Port: &lt;none&gt; Command: sh -c echo The app is running! &amp;&amp; sleep 3600 State: Waiting Reason: PodInitializing Ready: False Restart Count: 0 Environment: &lt;none&gt; Mounts: /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-h8chq (ro)Conditions: Type Status Initialized False Ready False ContainersReady False PodScheduled TrueVolumes: kube-api-access-h8chq: Type: Projected (a volume that contains injected data from multiple sources) TokenExpirationSeconds: 3607 ConfigMapName: kube-root-ca.crt ConfigMapOptional: &lt;nil&gt; DownwardAPI: trueQoS Class: BestEffortNode-Selectors: &lt;none&gt;Tolerations: node.kubernetes.io/not-ready:NoExecute op=Exists for 300s node.kubernetes.io/unreachable:NoExecute op=Exists for 300sEvents: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 17m default-scheduler Successfully assigned default/myapp-pod to centos07-62 Normal Pulling 17m kubelet Pulling image &quot;docker.io/library/busybox:1.28&quot; Normal Pulled 17m kubelet Successfully pulled image &quot;docker.io/library/busybox:1.28&quot; in 11.385772079s (11.38581593s including waiting) Normal Created 17m kubelet Created container init-myserver Normal Started 17m kubelet Started container init-myserver 删除12[root@centos07-12 inittest]# kubectl delete -f .pod &quot;myapp-pod&quot; deleted 初始化容器使用案例21234567891011121314151617181920212223# vim init2.yamlapiVersion: v1kind: Podmetadata: name: myapp-pod labels: app: myappspec: initContainers: - name: init-myservice image: docker.io/library/busybox:1.28 imagePullPolicy: IfNotPresent command: [&#x27;sh&#x27;, &#x27;-c&#x27;, &quot;sleep 10&quot;] - name: init-mydb image: docker.io/library/busybox:1.28 imagePullPolicy: IfNotPresent command: [&#x27;sh&#x27;, &#x27;-c&#x27;, &quot;sleep 10&quot;] containers: - name: myapp-container image: docker.io/library/busybox:1.28 imagePullPolicy: IfNotPresent command: [&#x27;sh&#x27;, &#x27;-c&#x27;, &#x27;echo containers start running! &amp;&amp; sleep 3600&#x27;] 1[root@centos07-12 inittest]# kubectl apply -f init2.yaml 1234567[root@centos07-12 inittest]# kubectl get pod -wNAME READY STATUS RESTARTS AGEmyapp-pod 0/1 Init:0/2 0 11smyapp-pod 0/1 Init:1/2 0 13smyapp-pod 0/1 Init:1/2 0 14smyapp-pod 0/1 PodInitializing 0 24smyapp-pod 1/1 Running 0 25s 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103[root@centos07-12 inittest]# kubectl describe pod myapp-podName: myapp-podNamespace: defaultPriority: 0Service Account: defaultNode: centos07-62/192.168.1.62Start Time: Wed, 06 Dec 2023 21:05:02 +0800Labels: app=myappAnnotations: cni.projectcalico.org/podIP: 10.244.250.209/32 cni.projectcalico.org/podIPs: 10.244.250.209/32Status: RunningIP: 10.244.250.209IPs: IP: 10.244.250.209Init Containers: init-myservice: Container ID: containerd://44b3a8c036547f4367179f7276b6708c67d288f6009fd4cd039a3cf2e9155fe5 Image: docker.io/library/busybox:1.28 Image ID: docker.io/library/busybox@sha256:141c253bc4c3fd0a201d32dc1f493bcf3fff003b6df416dea4f41046e0f37d47 Port: &lt;none&gt; Host Port: &lt;none&gt; Command: sh -c sleep 10 State: Terminated Reason: Completed Exit Code: 0 Started: Wed, 06 Dec 2023 21:05:04 +0800 Finished: Wed, 06 Dec 2023 21:05:14 +0800 Ready: True Restart Count: 0 Environment: &lt;none&gt; Mounts: /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-scjhq (ro) init-mydb: Container ID: containerd://bc777de83e2d10cc848866e5c45dce24bf1d988a4821d6851e9e4b5f945c238b Image: docker.io/library/busybox:1.28 Image ID: docker.io/library/busybox@sha256:141c253bc4c3fd0a201d32dc1f493bcf3fff003b6df416dea4f41046e0f37d47 Port: &lt;none&gt; Host Port: &lt;none&gt; Command: sh -c sleep 10 State: Terminated Reason: Completed Exit Code: 0 Started: Wed, 06 Dec 2023 21:05:14 +0800 Finished: Wed, 06 Dec 2023 21:05:24 +0800 Ready: True Restart Count: 0 Environment: &lt;none&gt; Mounts: /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-scjhq (ro)Containers: myapp-container: Container ID: containerd://ce6cd5a85e5ae1939fa943d7b8a008005a7b6b16091a892a41f3c4bbc3c140b5 Image: docker.io/library/busybox:1.28 Image ID: docker.io/library/busybox@sha256:141c253bc4c3fd0a201d32dc1f493bcf3fff003b6df416dea4f41046e0f37d47 Port: &lt;none&gt; Host Port: &lt;none&gt; Command: sh -c echo containers start running! &amp;&amp; sleep 3600 State: Running Started: Wed, 06 Dec 2023 21:05:25 +0800 Ready: True Restart Count: 0 Environment: &lt;none&gt; Mounts: /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-scjhq (ro)Conditions: Type Status Initialized True Ready True ContainersReady True PodScheduled TrueVolumes: kube-api-access-scjhq: Type: Projected (a volume that contains injected data from multiple sources) TokenExpirationSeconds: 3607 ConfigMapName: kube-root-ca.crt ConfigMapOptional: &lt;nil&gt; DownwardAPI: trueQoS Class: BestEffortNode-Selectors: &lt;none&gt;Tolerations: node.kubernetes.io/not-ready:NoExecute op=Exists for 300s node.kubernetes.io/unreachable:NoExecute op=Exists for 300sEvents: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 94s default-scheduler Successfully assigned default/myapp-pod to centos07-62 Normal Pulled 93s kubelet Container image &quot;docker.io/library/busybox:1.28&quot; already present on machine Normal Created 92s kubelet Created container init-myservice Normal Started 92s kubelet Started container init-myservice Normal Pulled 82s kubelet Container image &quot;docker.io/library/busybox:1.28&quot; already present on machine Normal Created 82s kubelet Created container init-mydb Normal Started 82s kubelet Started container init-mydb Normal Pulled 71s kubelet Container image &quot;docker.io/library/busybox:1.28&quot; already present on machine Normal Created 71s kubelet Created container myapp-container Normal Started 71s kubelet Started container myapp-container 12[root@centos07-12 inittest]# kubectl delete pod myapp-podpod &quot;myapp-pod&quot; deleted 初始化容器生产应用 主容器运行nginx服务，初始化容器用来给主容器生成index.html文件12345678910111213141516171819202122232425262728293031# init3.yamlapiVersion: v1kind: Podmetadata: name: initnginxspec: initContainers: - name: install image: docker.io/library/busybox:1.28 imagePullPolicy: IfNotPresent command: - wget - &quot;-O&quot; - &quot;/work-dir/index.html&quot; - &quot;https://www.baidu.com&quot; volumeMounts: - name: workdir mountPath: /work-dir containers: - name: nginx image: docker.io/library/nginx:latest imagePullPolicy: IfNotPresent ports: - containerPort: 80 volumeMounts: - name: workdir mountPath: /usr/share/nginx/html dnsPolicy: Default volumes: - name: workdir emptyDir: &#123;&#125; 12[root@centos07-12 inittest]# kubectl apply -f init3.yamlpod/initnginx created 123root@centos07-12 inittest]# kubectl get pods -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESinitnginx 1/1 Running 0 2m10s 10.244.250.210 centos07-62 &lt;none&gt; &lt;none&gt; 1234[root@centos07-12 inittest]# curl 10.244.250.210&lt;!DOCTYPE html&gt;&lt;!--STATUS OK--&gt;&lt;html&gt; &lt;head&gt;&lt;meta http-equiv=content-type content=text/html;charset=utf-8&gt;&lt;meta http-equiv=X-UA-Compatible content=IE=Edge&gt;&lt;meta content=always name=referrer&gt;&lt;link rel=stylesheet type=text/css href=https://ss1.bdstatic.com/5eN1bjq8AAUYm2zgoY3K/r/www/cache/bdorz/baidu.min.css&gt;&lt;title&gt;百度一下，你就知道&lt;/title&gt;&lt;/head&gt; &lt;body link=#0000cc&gt; &lt;div id=wrapper&gt; &lt;div id=head&gt; &lt;div class=head_wrapper&gt; &lt;div class=s_form&gt; &lt;div class=s_form_wrapper&gt; &lt;div id=lg&gt; &lt;img hidefocus=true src=//www.baidu.com/img/bd_logo1.png width=270 height=129&gt; &lt;/div&gt; &lt;form id=form name=f action=//www.baidu.com/s class=fm&gt; &lt;input type=hidden name=bdorz_come value=1&gt; &lt;input type=hidden name=ie value=utf-8&gt; &lt;input type=hidden name=f value=8&gt; &lt;input type=hidden name=rsv_bp value=1&gt; &lt;input type=hidden name=rsv_idx value=1&gt; &lt;input type=hidden name=tn value=baidu&gt;&lt;span class=&quot;bg s_ipt_wr&quot;&gt;&lt;input id=kw name=wd class=s_ipt value maxlength=255 autocomplete=off autofocus=autofocus&gt;&lt;/span&gt;&lt;span class=&quot;bg s_btn_wr&quot;&gt;&lt;input type=submit id=su value=百度一下 class=&quot;bg s_btn&quot; autofocus&gt;&lt;/span&gt; &lt;/form&gt; &lt;/div&gt; &lt;/div&gt; &lt;div id=u1&gt; &lt;a href=http://news.baidu.com name=tj_trnews class=mnav&gt;新闻&lt;/a&gt; &lt;a href=https://www.hao123.com name=tj_trhao123 class=mnav&gt;hao123&lt;/a&gt; &lt;a href=http://map.baidu.com name=tj_trmap class=mnav&gt;地图&lt;/a&gt; &lt;a href=http://v.baidu.com name=tj_trvideo class=mnav&gt;视频&lt;/a&gt; &lt;a href=http://tieba.baidu.com name=tj_trtieba class=mnav&gt;贴吧&lt;/a&gt; &lt;noscript&gt; &lt;a href=http://www.baidu.com/bdorz/login.gif?login&amp;amp;tpl=mn&amp;amp;u=http%3A%2F%2Fwww.baidu.com%2f%3fbdorz_come%3d1 name=tj_login class=lb&gt;登录&lt;/a&gt; &lt;/noscript&gt; &lt;script&gt;document.write(&#x27;&lt;a href=&quot;http://www.baidu.com/bdorz/login.gif?login&amp;tpl=mn&amp;u=&#x27;+ encodeURIComponent(window.location.href+ (window.location.search === &quot;&quot; ? &quot;?&quot; : &quot;&amp;&quot;)+ &quot;bdorz_come=1&quot;)+ &#x27;&quot; name=&quot;tj_login&quot; class=&quot;lb&quot;&gt;登录&lt;/a&gt;&#x27;); &lt;/script&gt; &lt;a href=//www.baidu.com/more/ name=tj_briicon class=bri style=&quot;display: block;&quot;&gt;更多产品&lt;/a&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt; &lt;div id=ftCon&gt; &lt;div id=ftConw&gt; &lt;p id=lh&gt; &lt;a href=http://home.baidu.com&gt;关于百度&lt;/a&gt; &lt;a href=http://ir.baidu.com&gt;About Baidu&lt;/a&gt; &lt;/p&gt; &lt;p id=cp&gt;&amp;copy;2017&amp;nbsp;Baidu&amp;nbsp;&lt;a href=http://www.baidu.com/duty/&gt;使用百度前必读&lt;/a&gt;&amp;nbsp; &lt;a href=http://jianyi.baidu.com/ class=cp-fe 12345[root@centos07-12 inittest]# kubectl exec -it initnginx -- /bin/bashDefaulted container &quot;nginx&quot; out of: nginx, install (init)root@initnginx:/# cd /usr/share/nginx/html/root@initnginx:/usr/share/nginx/html# lsindex.html 主容器1、容器钩子初始化容器启动之后，开始启动主容器，在主容器启动之后有一个post start hook（容器启动后钩子）和pre stop hook（容器结束前钩子），无论启动后还是结束前所做的事我们可以把它放两个钩子，这个钩子就表示用户可以用它来钩住一些命令，非必须选项 postStart：该钩子在容器被创建后立刻执行，如果该钩子对应的探测执行失败，则该容器会被杀死，并根据该容器的重启策略决定是否要重启该容器，这个钩子不需要传递任何参数。 preStop：该钩子在容器被删除前执行，主要用于释放资源和优雅关闭程序 容器钩子：postStart和preStop postStart：容器创建之后立刻执行，用于资源部署、环境准备等。 preStop：在容器被终止前执行，用于优雅关闭应用程序、通知其他系统等。 演示postStart和preStop用法123456789101112131415161718192021# p3.yamlapiVersion: v1kind: Podmetadata: name: life-demospec: containers: - name: lifecycle-demo-container image: docker.io/library/nginx:latest imagePullPolicy: IfNotPresent lifecycle: postStart: exec: command: [&quot;/bin/sh&quot;, &quot;-c&quot;,&quot;echo &#x27;lifecycle hookshandler&#x27; &gt; /usr/share/nginx/html/test.html&quot;] preStop: exec: command: - &quot;/bin/sh&quot; - &quot;-c&quot; - &quot;nginx -s stop&quot; 12345[root@centos07-12 inittest]# kubectl exec -it lifecycle-demo -- /bin/bashroot@lifecycle-demo:/# cat /usr/share/nginx/html/test.htmllifecycle hookshardlerroot@lifecycle-demo:/# exitexit 总结：pod在整个生命周期中有非常多的用户行为： 1、初始化容器完成初始化 2、主容器启动后可以做启动后钩子 3、主容器结束前可以做结束前钩子 4、在主容器运行中可以做一些健康检测，如startupprobe、livenessprobe，readnessprobe","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"17-Pod常见的状态和重启策略","slug":"运维/K8S/基础/17-Pod常见的状态和重启策略","date":"2023-05-08T12:00:50.000Z","updated":"2023-12-06T09:11:09.000Z","comments":true,"path":"2023/05/08/运维/K8S/基础/17-Pod常见的状态和重启策略/","link":"","permalink":"https://dbbruce.github.io/2023/05/08/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/17-Pod%E5%B8%B8%E8%A7%81%E7%9A%84%E7%8A%B6%E6%80%81%E5%92%8C%E9%87%8D%E5%90%AF%E7%AD%96%E7%95%A5/","excerpt":"Pod常见的状态和重启策略常见的pod状态","text":"Pod常见的状态和重启策略常见的pod状态 第一阶段： 挂起（Pending）： 1、正在创建Pod但是Pod中的容器还没有全部被创建完成，处于此状态的Pod应该检查Pod依赖的存储是否有权限挂载、镜像是否可以下载、调度是否正常等2、我们在请求创建pod时，条件不满足，调度没有完成，没有任何一个节点能满足调度条件，已经创建了pod但是没有适合它运行的节点叫做挂起，调度没有完成。 失败（Failed）：Pod 中的所有容器都已终止了，并且至少有一个容器是因为失败终止。也就是说，容器以非0状态退出或者被系统终止。 未知（Unknown）：未知状态，所谓pod是什么状态是apiserver和运行在pod节点的kubelet进行通信获取状态信息的，如果节点之上的kubelet本身出故障，那么apiserver就连不上kubelet，得不到信息了，就会看Unknown，通常是由于与pod所在的node节点通信错误。 Error 状态：Pod 启动过程中发生了错误 成功（Succeeded）：Pod中的所有容器都被成功终止，即pod里所有的containers均已terminated。 第二阶段： Unschedulable：Pod不能被调度， scheduler没有匹配到合适的node节点 PodScheduled：pod正处于调度中，在scheduler刚开始调度的时候，还没有将pod分配到指定的node，在筛选出合适的节点后就会更新etcd数据，将pod分配到指定的node Initialized：所有pod中的初始化容器已经完成了 ImagePullBackOff：Pod所在的node节点下载镜像失败 Running：Pod内部的容器已经被创建并且启动。 扩展：还有其他状态，如下： Evicted状态：出现这种情况，多见于系统内存或硬盘资源不足，可df-h查看docker存储所在目录的资源使用情况，如果百分比大于85%，就要及时清理下资源，尤其是一些大文件、docker镜像。 CrashLoopBackOff：容器曾经启动了，但可能又异常退出了 pod重启策略Pod的重启策略（RestartPolicy）应用于Pod内的所有容器，当某个容器异常退出或者健康检查失败时，kubelet将根据 重启策略来进行相应的操作。 Pod 的 spec 中包含一个 restartPolicy 字段，其可能取值包括 Always、OnFailure 和 Never。默认值是 Always。 Always：只要容器异常退出，kubelet就会自动重启该容器。（这个是默认的重启策略） OnFailure：当容器终止运行且退出码不为0时，由kubelet自动重启该容器。 Never：不论容器运行状态如何，kubelet都不会重启该容器。 1、测试Always重启策略1234567891011121314151617# cat pod1.yaml apiVersion: v1kind: Podmetadata: name: pod1 namespace: default labels: app: pod1spec: restartPolicy: Always containers: - name: tomcat-pod-java ports: - containerPort: 8080 image: docker.io/library/tomcat:8.5-jre8-alpine imagePullPolicy: IfNotPresent 1kubectl apply -f pod1.yaml 1）正常停止容器里的tomcat服务12345678910[root@centos07-12 restartpolicytest]# kubectl exec -it pod1 -- /bin/bashbash-4.4# /usr/local/tomcat/bin/shutdown.shUsing CATALINA_BASE: /usr/local/tomcatUsing CATALINA_HOME: /usr/local/tomcatUsing CATALINA_TMPDIR: /usr/local/tomcat/tempUsing JRE_HOME: /usr/lib/jvm/java-1.8-openjdk/jreUsing CLASSPATH: /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jarbash-4.4# command terminated with exit code 137[root@centos07-12 restartpolicytest]# #查看pod状态：发现正常停止容器里的tomcat服务，容器重启了一次，pod又恢复正常了 123[root@centos07-12 restartpolicytest]# kubectl get pods -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESpod1 1/1 Running 1 (29s ago) 3m22s 10.244.250.203 centos07-62 &lt;none&gt; &lt;none&gt; 2）非正常停止容器里的tomcat服务 123[root@centos07-12 restartpolicytest]# kubectl exec -it pod1 -- /bin/bashbash-4.4# kill 1bash-4.4# command terminated with exit code 137 123[root@centos07-12 restartpolicytest]# kubectl get pods -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESpod1 0/1 Error 1 (2m3s ago) 4m56s 10.244.250.203 centos07-62 &lt;none&gt; &lt;none&gt; 123[root@centos07-12 restartpolicytest]# kubectl get pods -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESpod1 1/1 Running 2 (73s ago) 6m6s 10.244.250.203 centos07-62 &lt;none&gt; &lt;none&gt; 上面可以看到容器终止了，并且又重启一次，重启次数增加了一次 注意：使用 -w ，保持终端，能查看pod的变化 123456789[root@centos07-12 nstest]# kubectl get pods -wNAME READY STATUS RESTARTS AGEpod1 1/1 Running 1 (110s ago) 4m43s# 进入终端，kill 1，容器非0退出，报错pod1 0/1 Error 1 (2m ago) 4m53spod1 0/1 CrashLoopBackOff 1 (12s ago) 5m5s# 容器又重新启动了，策略alway，只要容器异常退出，kubelet就会自动重启该容器。pod1 1/1 Running 2 (14s ago) 5m7s 2、测试never重启策略1234567891011121314151617# vim pod2.yamlapiVersion: v1kind: Podmetadata: name: pod2 namespace: default labels: app: myappspec: restartPolicy: Never containers: - name: tomcat-pod-java ports: - containerPort: 8080 image: docker.io/library/tomcat:8.5-jre8-alpine imagePullPolicy: IfNotPresent 12[root@centos07-12 restartpolicytest]# kubectl apply -f pod2.yamlpod/pod2 created 123[root@centos07-12 restartpolicytest]# kubectl get podsNAME READY STATUS RESTARTS AGEpod2 1/1 Running 0 5s 1）正常停止容器里的tomcat服务 123456789[root@centos07-12 restartpolicytest]# kubectl exec -it pod2 -- /bin/bashbash-4.4# /usr/local/tomcat/bin/shutdown.shUsing CATALINA_BASE: /usr/local/tomcatUsing CATALINA_HOME: /usr/local/tomcatUsing CATALINA_TMPDIR: /usr/local/tomcat/tempUsing JRE_HOME: /usr/lib/jvm/java-1.8-openjdk/jreUsing CLASSPATH: /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jarbash-4.4# command terminated with exit code 137[root@centos07-12 restartpolicytest]# 查看pod状态：发现正常停止容器里的tomcat服务，pod正常运行，容器没有重启 123[root@centos07-12 restartpolicytest]# kubectl get podsNAME READY STATUS RESTARTS AGEpod2 0/1 Completed 0 2m50s 12345678910[root@centos07-12 nstest]# kubectl get pods -wNAME READY STATUS RESTARTS AGEpod2 1/1 Running 0 69s# 正常停止，容器不会重启pod2 0/1 Completed 0 84spod2 0/1 Completed 0 86spod2 0/1 Completed 0 86spod2 0/1 Completed 0 86s 2）非正常停止容器里的tomcat服务 1234[root@centos07-12 restartpolicytest]# kubectl exec -it pod2 -- /bin/bashbash-4.4# kill 1bash-4.4# command terminated with exit code 137[root@centos07-12 restartpolicytest]# 123[root@centos07-12 restartpolicytest]# kubectl get podNAME READY STATUS RESTARTS AGEpod2 0/1 Error 0 109s 上面可以看到容器状态是error，并且没有重启，这说明重启策略是never，那么pod里容器服务无论如何终止，都不会重启 1234567[root@centos07-12 nstest]# kubectl get pod -wNAME READY STATUS RESTARTS AGEpod2 1/1 Running 0 78spod2 0/1 Error 0 98spod2 0/1 Error 0 100spod2 0/1 Error 0 100spod2 0/1 Error 0 100s 3、测试OnFailure重启策略1234567891011121314151617# pod3.yamlapiVersion: v1kind: Podmetadata: name: pod3 namespace: default labels: app: myappspec: restartPolicy: OnFailure containers: - name: tomcat-pod-java ports: - containerPort: 8080 image: docker.io/library/tomcat:8.5-jre8-alpine imagePullPolicy: IfNotPresent 1[root@centos07-12 restartpolicytest]# kubectl apply -f pod3.yaml 123[root@centos07-12 restartpolicytest]# kubectl get podNAME READY STATUS RESTARTS AGEpod3 1/1 Running 0 4m18s 1）正常停止容器里的tomcat服务12345678910[root@centos07-12 restartpolicytest]# kubectl exec -it pod3 -- /bin/bashbash-4.4#bash-4.4# /usr/local/tomcat/bin/shutdown.shUsing CATALINA_BASE: /usr/local/tomcatUsing CATALINA_HOME: /usr/local/tomcatUsing CATALINA_TMPDIR: /usr/local/tomcat/tempUsing JRE_HOME: /usr/lib/jvm/java-1.8-openjdk/jreUsing CLASSPATH: /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jarbash-4.4# command terminated with exit code 137[root@centos07-12 restartpolicytest]# 查看pod状态：123[root@centos07-12 restartpolicytest]# kubectl get podNAME READY STATUS RESTARTS AGEpod3 0/1 Completed 0 5m45s 发现正常停止容器里的tomcat服务，退出码是0，pod里的容器不会重启 1234567[root@centos07-12 nstest]# kubectl get pod -wNAME READY STATUS RESTARTS AGEpod3 1/1 Running 0 4m21spod3 0/1 Completed 0 5m7spod3 0/1 Completed 0 5m8spod3 0/1 Completed 0 5m8spod3 0/1 Completed 0 5m9s 2）非正常停止容器里的tomcat服务123[root@centos07-12 restartpolicytest]# kubectl exec -it pod3 -- /bin/bashbash-4.4# kill 1bash-4.4# command terminated with exit code 137 123[root@centos07-12 restartpolicytest]# kubectl get podNAME READY STATUS RESTARTS AGEpod3 1/1 Running 1 (19s ago) 41s 上面可以看到非正常停止pod里的容器，容器退出码不是0，那就会重启容器 123456[root@centos07-12 nstest]# kubectl get pod -wNAME READY STATUS RESTARTS AGEpod3 1/1 Running 0 1spod3 1/1 Running 0 15spod3 0/1 Error 0 22spod3 1/1 Running 1 (1s ago) 23s","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"16-污点和容忍度","slug":"运维/K8S/基础/16-污点和容忍度","date":"2023-05-08T02:00:50.000Z","updated":"2023-12-06T02:05:59.000Z","comments":true,"path":"2023/05/08/运维/K8S/基础/16-污点和容忍度/","link":"","permalink":"https://dbbruce.github.io/2023/05/08/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/16-%E6%B1%A1%E7%82%B9%E5%92%8C%E5%AE%B9%E5%BF%8D%E5%BA%A6/","excerpt":"污点、容忍度给了节点选则的主动权，我们给节点打一个污点，不容忍的pod就运行不上来，污点就是定义在节点上的键值属性数据，可以定决定拒绝那些pod；taints是键值数据，用在节点上，定义污点；tolerations是键值数据，用在pod上，定义容忍度，能容忍哪些污点pod亲和性是pod属性；但是污点是node节点的属性，污点定义在k8s集群的node节点上的一个字段","text":"污点、容忍度给了节点选则的主动权，我们给节点打一个污点，不容忍的pod就运行不上来，污点就是定义在节点上的键值属性数据，可以定决定拒绝那些pod；taints是键值数据，用在节点上，定义污点；tolerations是键值数据，用在pod上，定义容忍度，能容忍哪些污点pod亲和性是pod属性；但是污点是node节点的属性，污点定义在k8s集群的node节点上的一个字段 查看下master上的污点信息 Taints: node-role.kubernetes.io&#x2F;control-plane:NoSchedule NoSchedule 是等级下面有讲解所以我们创建的pod都不会调度到master上，因为我们创建的pod没有容忍度 12345678910111213141516171819[root@centos07-12 nodeantiaffinitytest]# kubectl describe nodes centos07-12Name: centos07-12Roles: control-planeLabels: beta.kubernetes.io/arch=amd64 beta.kubernetes.io/os=linux kubernetes.io/arch=amd64 kubernetes.io/hostname=centos07-12 kubernetes.io/os=linux node-role.kubernetes.io/control-plane= node.kubernetes.io/exclude-from-external-load-balancers=Annotations: kubeadm.alpha.kubernetes.io/cri-socket: unix:///run/containerd/containerd.sock node.alpha.kubernetes.io/ttl: 0 projectcalico.org/IPv4Address: 192.168.1.12/24 projectcalico.org/IPv4IPIPTunnelAddr: 10.244.234.192 volumes.kubernetes.io/controller-managed-attach-detach: trueCreationTimestamp: Sun, 03 Dec 2023 16:16:58 +0800Taints: node-role.kubernetes.io/control-plane:NoSchedule Unschedulable: false 污点的使用帮助1234567891011121314kubectl explain node.spec.taintsKIND: NodeVERSION: v1RESOURCE: taints &lt;[]Object&gt;DESCRIPTION: If specified, the node&#x27;s taints. The node this Taint is attached to has the &quot;effect&quot; on any pod that does not tolerate the Taint.FIELDS: effect &lt;string&gt; -required- key &lt;string&gt; -required- timeAdded &lt;string&gt; value &lt;string&gt; taints污点的effect用来定义对pod对象的排斥等级（效果）：排斥等级 NoSchedule：仅影响pod调度过程，当pod能容忍这个节点污点，就可以调度到当前节点，后来这个节点的污点改了，加了一个新的污点，使得之前调度的pod不能容忍了，那这个pod会怎么处理，对现存的pod对象不产生影响 NoExecute：既影响调度过程，又影响现存的pod对象，如果现存的pod不能容忍节点后来加的污点，这个pod就会被驱逐 referNoSchedule：最好不，也可以，是NoSchedule的柔性版本 如果想让pod调度到master上，需要在node上加上容忍度，看下apiserver 容忍度是：NoExecute时，可以调度到NoSchedule的node上可以看到这个pod的容忍度是NoExecute，则可以调度到master上 123[root@centos07-12 ~]# kubectl describe pod kube-apiserver-centos07-12 -n kube-systemTolerations: :NoExecute op=Exists 123[root@centos07-12 nodeantiaffinitytest]# kubectl describe nodes centos07-12Taints: node-role.kubernetes.io/control-plane:NoSchedule 上面可以看到master这个节点的污点是Noschedule 管理节点污点 kubectl taint –helpkubectl taint node 节点名 node-type&#x3D;自定义名:等级 例1：把62当成是生产环境专用的，其他node是测试的12[root@centos07-12 nodeantiaffinitytest]# kubectl taint node centos07-62 node-type=prduction:NoSchedulenode/centos07-62 tainted 1234567891011121314151617[root@centos07-12 nodeantiaffinitytest]# kubectl describe node centos07-62Name: centos07-62Roles: workLabels: beta.kubernetes.io/arch=amd64 beta.kubernetes.io/os=linux kubernetes.io/arch=amd64 kubernetes.io/hostname=centos07-62 kubernetes.io/os=linux node-role.kubernetes.io/work=work zone=fooAnnotations: kubeadm.alpha.kubernetes.io/cri-socket: unix:///var/run/containerd/containerd.sock node.alpha.kubernetes.io/ttl: 0 projectcalico.org/IPv4Address: 192.168.1.62/24 projectcalico.org/IPv4IPIPTunnelAddr: 10.244.250.192 volumes.kubernetes.io/controller-managed-attach-detach: trueCreationTimestamp: Tue, 05 Dec 2023 17:15:18 +0800Taints: node-type=prduction:NoSchedule 给62打污点，pod如果不能容忍就不会调度过来123456789101112131415# cat pod-taint.yaml apiVersion: v1kind: Podmetadata: name: taint-pod namespace: default labels: tomcat: tomcat-podspec: containers: - name: taint-pod ports: - containerPort: 8080 image: docker.io/library/tomcat:8.5-jre8-alpine imagePullPolicy: IfNotPresent 123[root@centos07-12 tainttest]# kubectl get podNAME READY STATUS RESTARTS AGEtaint-pod 1/1 Running 0 6s 123[root@centos07-12 tainttest]# kubectl get pods -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATEStaint-pod 1/1 Running 0 66s 10.244.193.148 centos07-22 &lt;none&gt; &lt;none&gt; 可以看到都被调度到22上了，因为62这个节点打了污点，而我们在创建pod的时候没有容忍度，所以62上不会有pod调度上去的 例2：给22也打上污点1kubectl taint node centos07-22 node-type=dev:NoExecute 12[root@centos07-12 tainttest]# kubectl taint node centos07-22 node-type=dev:NoExecutenode/centos07-22 tainted 12345[root@centos07-12 tainttest]# kubectl describe node centos07-22Name: centos07-22Roles: work...Taints: node-type=dev:NoExecute 定义的污点是NoExecute，pod会被驱逐 12[root@centos07-12 tainttest]# kubectl get pods -o wideNo resources found in default namespace. 1234567891011121314151617181920212223# cat pod-demo-1.yaml apiVersion: v1kind: Podmetadata: name: myapp-deploy namespace: default labels: app: myapp release: canaryspec: containers: - name: myapp image: ikubernetes/myapp:v1 imagePullPolicy: IfNotPresent ports: - name: http containerPort: 80 tolerations: - key: &quot;node-type&quot; operator: &quot;Equal&quot; value: &quot;production&quot; effect: &quot;NoExecute&quot; tolerationSeconds: 3600 当等级是NoExecute时，可以设置驱逐的延迟时间，tolerationSeconds，默认没有此字段是立即驱逐 12[root@centos07-12 tainttest]# kubectl apply -f pod1.yamlpod/myapp-deploy created 123[root@centos07-12 tainttest]# kubectl get pods -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESmyapp-deploy 0/1 Pending 0 17s &lt;none&gt; &lt;none&gt; &lt;none&gt; &lt;none&gt; pod无法创建，还是显示pending，因为我们使用的是equal（等值匹配）， 所以key和value，effect必须和node节点定义的污点完全匹配才可以， pod的容忍度是：node-type&#x3D;production:NoExecute 22:Taints: node-type&#x3D;dev:NoExecute 不匹配 62:Taints: node-type&#x3D;prduction:NoSchedule 不匹配 结果：无法创建pod 例子3.1 把上面配置effect: “NoExecute”变成 ；effect: “NoSchedule”成； tolerationSeconds: 3600这行去掉 pod的容忍度是：node-type&#x3D;production:NoSchedule 22:Taints: node-type&#x3D;dev:NoExecute 不匹配 62:Taints: node-type&#x3D;prduction:NoSchedule 匹配 12345678910111213141516171819202122# cat pod-demo-2.yaml apiVersion: v1kind: Podmetadata: name: myapp-deploy namespace: default labels: app: myapp release: canaryspec: containers: - name: myapp image: ikubernetes/myapp:v1 imagePullPolicy: IfNotPresent ports: - name: http containerPort: 80 tolerations: - key: &quot;node-type&quot; operator: &quot;Equal&quot; value: &quot;production&quot; effect: &quot;NoSchedule&quot; 12[root@centos07-12 tainttest]# kubectl apply -f pod3.yamlpod/myapp-deploy created 123[root@centos07-12 tainttest]# kubectl get pods -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESmyapp-deploy 1/1 Running 0 16s 10.244.250.202 centos07-62 &lt;none&gt; &lt;none&gt; 上面就可以调度到62上了，因为在pod中定义的容忍度能容忍node节点上的污点 [root@xianchaomaster1 ~]# kubectl apply -f pod-demo-1.yaml[root@xianchaomaster1 ~]# kubectl get podsmyapp-deploy 1&#x2F;1 Pending 0 11s xianchaonode2 [root@xianchaomaster1 ~]# kubectl delete -f pod-demo-1.yaml[root@xianchaomaster1 ~]# kubectl apply -f pod-demo-1.yaml[root@xianchaomaster1 ~]# kubectl get podsmyapp-deploy 1&#x2F;1 running 0 11s xianchaonode2 3.2 容忍度使用：Exists，只要对应的键是存在的，exists，其值被自动定义成通配符 pod的容忍度是：node-type&#x3D;****:NoExecute 22:Taints: node-type&#x3D;dev:NoExecute 匹配 62:Taints: node-type&#x3D;prduction:NoSchedule 不匹配 1234567891011121314151617181920212223# cat pod-demo-2.yaml apiVersion: v1kind: Podmetadata: name: myapp-deploy2 namespace: default labels: app: myapp release: canaryspec: containers: - name: myapp2 image: ikubernetes/myapp:v1 imagePullPolicy: IfNotPresent ports: - name: http containerPort: 80 tolerations: - key: &quot;node-type&quot; operator: &quot;Exists&quot; value: &quot;&quot; effect: &quot;NoExecute&quot; 12[root@centos07-12 tainttest]# kubectl apply -f pod4.yamlpod/myapp-deploy2 created 1234[root@centos07-12 tainttest]# kubectl get pods -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESmyapp-deploy 1/1 Running 0 5m11s 10.244.250.202 centos07-62 &lt;none&gt; &lt;none&gt;myapp-deploy2 1/1 Running 0 6s 10.244.193.149 centos07-22 &lt;none&gt; &lt;none&gt; 删除污点： kubectl taint nodes 节点名 node-type:NoExecute-kubectl taint nodes 节点名 node-type- 1234[root@centos07-12 tainttest]# kubectl taint nodes centos07-22 node-type:NoExecute-node/centos07-22 untainted[root@centos07-12 tainttest]# kubectl taint nodes centos07-62 node-type-node/centos07-62 untainted","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"15-node节点亲和性，pod亲和性，pod反亲和性多种调度策略","slug":"运维/K8S/基础/15-node节点亲和性，pod亲和性，pod反亲和性多种调度策略","date":"2023-05-07T12:00:50.000Z","updated":"2023-12-05T15:55:58.000Z","comments":true,"path":"2023/05/07/运维/K8S/基础/15-node节点亲和性，pod亲和性，pod反亲和性多种调度策略/","link":"","permalink":"https://dbbruce.github.io/2023/05/07/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/15-node%E8%8A%82%E7%82%B9%E4%BA%B2%E5%92%8C%E6%80%A7%EF%BC%8Cpod%E4%BA%B2%E5%92%8C%E6%80%A7%EF%BC%8Cpod%E5%8F%8D%E4%BA%B2%E5%92%8C%E6%80%A7%E5%A4%9A%E7%A7%8D%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5/","excerpt":"亲和性 node节点亲和性 Pod节点亲和性 pod节点反亲和性 node节点亲和性node节点亲和性调度：nodeAffinity","text":"亲和性 node节点亲和性 Pod节点亲和性 pod节点反亲和性 node节点亲和性node节点亲和性调度：nodeAffinity 123456789101112131415161718192021222324252627[root@centos07-12 nodenametest]# kubectl explain pods.spec.affinityKIND: PodVERSION: v1FIELD: affinity &lt;Affinity&gt;DESCRIPTION: If specified, the pod&#x27;s scheduling constraints Affinity is a group of affinity scheduling rules. pod的调度约束, affinity是一组调度规则FIELDS: nodeAffinity &lt;NodeAffinity&gt; Describes node affinity scheduling rules for the pod. 描述pod的节点关联调度规则。 podAffinity &lt;PodAffinity&gt; Describes pod affinity scheduling rules (e.g. co-locate this pod in the same node, zone, etc. as some other pod(s)). 描述pod关联调度规则（例如，将此pod放在同一个pod的节点、区域等作为一些其它pod） podAntiAffinity &lt;PodAntiAffinity&gt; Describes pod anti-affinity scheduling rules (e.g. avoid putting this pod in the same node, zone, etc. as some other pod(s)). 描述pod反关联调度规则（例如，避免将此pod放入与一些其他Pod相同的节点、区域等） prefered 表示有节点尽量满足这个位置定义的亲和性，这不是一个必须的条件，软亲和性require 表示必须有节点满足这个位置定义的亲和性，这是个硬性条件，硬亲和性 12345678910111213141516171819202122232425262728293031[root@centos07-12 nodenametest]# kubectl explain pods.spec.affinity.nodeAffinityKIND: PodVERSION: v1FIELD: nodeAffinity &lt;NodeAffinity&gt;DESCRIPTION: Describes node affinity scheduling rules for the pod. Node affinity is a group of node affinity scheduling rules. 描述pod的节点关联调度规则。FIELDS: preferredDuringSchedulingIgnoredDuringExecution &lt;[]PreferredSchedulingTerm&gt; The scheduler will prefer to schedule pods to nodes that satisfy the affinity expressions specified by this field, but it may choose a node that violates one or more of the expressions. The node that is most preferred is the one with the greatest sum of weights, i.e. for each node that meets all of the scheduling requirements (resource request, requiredDuringScheduling affinity expressions, etc.), compute a sum by iterating through the elements of this field and adding &quot;weight&quot; to the sum if the node matches the corresponding matchExpressions; the node(s) with the highest sum are the most preferred. requiredDuringSchedulingIgnoredDuringExecution &lt;NodeSelector&gt; If the affinity requirements specified by this field are not met at scheduling time, the pod will not be scheduled onto the node. If the affinity requirements specified by this field cease to be met at some point during pod execution (e.g. due to an update), the system may or may not try to eventually evict the pod from its node. 1234567891011121314151617181920[root@centos07-12 nodenametest]# kubectl explain pods.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecutionKIND: PodVERSION: v1FIELD: requiredDuringSchedulingIgnoredDuringExecution &lt;NodeSelector&gt;DESCRIPTION: If the affinity requirements specified by this field are not met at scheduling time, the pod will not be scheduled onto the node. If the affinity requirements specified by this field cease to be met at some point during pod execution (e.g. due to an update), the system may or may not try to eventually evict the pod from its node. A node selector represents the union of the results of one or more label queries over a set of nodes; that is, it represents the OR of the selectors represented by the node selector terms.FIELDS: nodeSelectorTerms &lt;[]NodeSelectorTerm&gt; -required- Required. A list of node selector terms. The terms are ORed. matchExpressions：匹配表达式的matchFields： 匹配字段的 123456789101112131415161718[root@centos07-12 nodenametest]# kubectl explain pods.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTermsKIND: PodVERSION: v1FIELD: nodeSelectorTerms &lt;[]NodeSelectorTerm&gt;DESCRIPTION: Required. A list of node selector terms. The terms are ORed. A null or empty node selector term matches no objects. The requirements of them are ANDed. The TopologySelectorTerm type implements a subset of the NodeSelectorTerm.FIELDS: matchExpressions &lt;[]NodeSelectorRequirement&gt; A list of node selector requirements by node&#x27;s labels. matchFields &lt;[]NodeSelectorRequirement&gt; A list of node selector requirements by node&#x27;s fields. 123456789101112131415161718192021222324252627282930313233[root@centos07-12 nodenametest]# kubectl explain pods.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms.matchFieldsKIND: PodVERSION: v1FIELD: matchFields &lt;[]NodeSelectorRequirement&gt;DESCRIPTION: A list of node selector requirements by node&#x27;s fields. A node selector requirement is a selector that contains values, a key, and an operator that relates the key and values.FIELDS: key &lt;string&gt; -required- The label key that the selector applies to. operator &lt;string&gt; -required- Represents a key&#x27;s relationship to a set of values. Valid operators are In, NotIn, Exists, DoesNotExist. Gt, and Lt. Possible enum values: - `&quot;DoesNotExist&quot;` - `&quot;Exists&quot;` - `&quot;Gt&quot;` - `&quot;In&quot;` - `&quot;Lt&quot;` - `&quot;NotIn&quot;` values &lt;[]string&gt; An array of string values. If the operator is In or NotIn, the values array must be non-empty. If the operator is Exists or DoesNotExist, the values array must be empty. If the operator is Gt or Lt, the values array must have a single element, which will be interpreted as an integer. This array is replaced during a strategic merge patch. key：检查labeloperator：做等值选则还是不等值选则values：给定值 12345678910111213141516171819202122232425262728293031323334[root@centos07-12 nodenametest]# kubectl explain pods.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms.matchExpressionsKIND: PodVERSION: v1FIELD: matchExpressions &lt;[]NodeSelectorRequirement&gt;DESCRIPTION: A list of node selector requirements by node&#x27;s labels. A node selector requirement is a selector that contains values, a key, and an operator that relates the key and values.FIELDS: key &lt;string&gt; -required- The label key that the selector applies to. operator &lt;string&gt; -required- Represents a key&#x27;s relationship to a set of values. Valid operators are In, NotIn, Exists, DoesNotExist. Gt, and Lt. Possible enum values: - `&quot;DoesNotExist&quot;` - `&quot;Exists&quot;` - `&quot;Gt&quot;` - `&quot;In&quot;` - `&quot;Lt&quot;` - `&quot;NotIn&quot;` values &lt;[]string&gt; An array of string values. If the operator is In or NotIn, the values array must be non-empty. If the operator is Exists or DoesNotExist, the values array must be empty. If the operator is Gt or Lt, the values array must have a single element, which will be interpreted as an integer. This array is replaced during a strategic merge patch. Node节点亲和性针对的是pod和node的关系，Pod调度到node节点的时候匹配的条件 例1：使用requiredDuringSchedulingIgnoredDuringExecution硬亲和性 把myapp-v1.tar.gz上传到centos07-22和centos07-62上，手动解压：1ctr -n=k8s.io images import myapp-v1.tar.gz yaml文件12345678910111213141516171819202122232425# cat pod-nodeaffinity-demo.yaml apiVersion: v1kind: Podmetadata: name: pod-node-affinity-demo namespace: default labels: app: myapp tier: frontendspec: affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: zone operator: In values: - foo - bar containers: - name: myapp image: docker.io/ikubernetes/myapp:v1 imagePullPolicy: IfNotPresent 我们检查当前节点中有任意一个节点拥有zone标签的值是foo或者bar，就可以把pod调度到这个node节点的foo或者bar标签上的节点上12[root@centos07-12 affinitytest]# kubectl apply -f pod-nodeaffinity-demo.yamlpod/pod-node-affinity-demo created status的状态是pending，上面说明没有完成调度，因为没有一个拥有zone的标签的值是foo或者bar，而且使用的是硬亲和性，必须满足条件才能完成调度12[root@centos07-12 affinitytest]# kubectl get pods -o wide | grep pod-nodepod-node-affinity-demo 0/1 Pending 0 7m57s &lt;none&gt; &lt;none&gt; &lt;none&gt; &lt;none&gt; centosos07-22添加一个标签12[root@centos07-12 affinitytest]# kubectl label nodes centos07-22 zone=foonode/centos07-22 labeled 给这个centosos07-22节点打上标签zone&#x3D;foo，在查看12[root@centos07-12 affinitytest]# kubectl get pods -o wide | grep pod-nodepod-node-affinity-demo 1/1 Running 0 9m46s 10.244.193.145 centos07-22 &lt;none&gt; &lt;none&gt; 例2：使用preferredDuringSchedulingIgnoredDuringExecution软亲和性 软亲和性，没有符合的一会创建，随机选一个创建 12345678910111213141516171819202122232425262728293031323334# cat vapiVersion: v1kind: Podmetadata: name: pod-node-affinity-demo-2 namespace: default labels: app: myapp tier: frontendspec: containers: - name: myapp image: docker.io/ikubernetes/myapp:v1 imagePullPolicy: IfNotPresent affinity: nodeAffinity: preferredDuringSchedulingIgnoredDuringExecution: - preference: matchExpressions: - key: zone1 operator: In values: - foo1 - bar1 weight: 10 - preference: matchExpressions: - key: zone2 operator: In values: - foo2 - bar2 weight: 20 上面说明软亲和性是可以运行这个pod的，尽管没有运行这个pod的节点定义的zone1标签weight是相对权重，权重越高，pod调度的几率越大; 上面的例子，就是现在zone2 为foo2或者bar2的节点，没有再找zone1 12[root@centos07-12 affinitytest]# kubectl apply -f pod-nodeaffinity-demo-2.yamlpod/pod-node-affinity-demo-2 created 12[root@centos07-12 affinitytest]# kubectl get pods -o wide |grep demo-2pod-node-affinity-demo-2 1/1 Running 0 18s 10.244.250.197 centos07-62 &lt;none&gt; &lt;none&gt; 假如给centos07-22和centos07-62都打上标签12kubectl label nodes centos07-62 zone1=foo1kubectl label nodes centos07-22 zone2=foo2 123[root@centos07-12 affinitytest]# kubectl get nodes --show-labels|grep zonecentos07-22 Ready work 2d4h v1.27.0 beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=centos07-22,kubernetes.io/os=linux,node-role.kubernetes.io/work=work,zone2=foo2,zone=foocentos07-62 Ready work 4h9m v1.27.0 beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=centos07-62,kubernetes.io/os=linux,node-role.kubernetes.io/work=work,zone1=foo1 pod在定义node节点亲和性的时候，centos07-22 和 centos07-62都满足条件，都可以调度pod，但是centos07-22具有的标签是zone2&#x3D;foo2，pod在匹配zone2&#x3D;foo2的权重高，那么pod就会优先调度到centos07-22上123456[root@centos07-12 affinitytest]# kubectl apply -f pod-nodeaffinity-demo-2.yamlpod/pod-node-affinity-demo-2 created[root@centos07-12 affinitytest]# kubectl get pod -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESpod-node-affinity-demo-2 1/1 Running 0 20s 10.244.193.146 centos07-22 &lt;none&gt; &lt;none&gt; [root@xianchaomaster1 ~]# kubectl apply -f pod-nodeaffinity-demo-2.yaml[root@xianchaomaster1 ~]# kubectl get pods -o wide |grep demo-2pod-node-affinity-demo-2 1&#x2F;1 Running 0 xianchaonode1 [root@xianchaomaster1 ~]# kubectl label nodes xianchaonode1 zone1&#x3D;foo1[root@xianchaomaster1 ~]# kubectl label nodes xianchaonode2 zone2&#x3D;foo2preferredDuringSchedulingIgnoredDuringExecution: - preference: matchExpressions: - key: zone1 operator: In values: - foo1 - bar1 weight: 10 - preference: matchExpressions: - key: zone2 operator: In values: - foo2 - bar2 weight: 20 [root@xianchaomaster1 ~]# kubectl label nodes xianchaonode1 zone1-[root@xianchaomaster1 ~]# kubectl label nodes xianchaonode2 zone2-[root@xianchaomaster1 ~]# kubectl label nodes xianchaonode1 zone- [root@xianchaomaster1]# kubectl delete -f pod-nodeaffinity-demo.yaml[root@xianchaomaster1]# kubectl delete -f pod-nodeaffinity-demo-2.yaml 删除默认名称空间的所有pod资源12345[root@centos07-12 affinitytest]# kubectl delete -f pod-nodeaffinity-demo-2.yamlpod &quot;pod-node-affinity-demo-2&quot; deleted[root@centos07-12 affinitytest]# kubectl get pods -owideNo resources found in default namespace. Pod节点亲和性pod自身的亲和性调度有两种表示形式 podaffinity：pod和pod更倾向腻在一起，把相近的pod结合到相近的位置，如同一区域，同一机架，这样的话pod和pod之间更好通信，比方说有两个机房，这两个机房部署的集群有1000台主机，那么我们希望把nginx和tomcat都部署同一个地方的node节点上，可以提高通信效率； podunaffinity：pod和pod更倾向不腻在一起，如果部署两套程序，那么这两套程序更倾向于反亲和性，这样相互之间不会有影响。 第一个pod随机选则一个节点，做为评判后续的pod能否到达这个pod所在的节点上的运行方式，这就称为pod亲和性；我们怎么判定哪些节点是相同位置的，哪些节点是不同位置的；我们在定义pod亲和性时需要有一个前提，哪些pod在同一个位置，哪些pod不在同一个位置，这个位置是怎么定义的，标准是什么？以节点名称为标准，这个节点名称相同的表示是同一个位置，节点名称不相同的表示不是一个位置。 requiredDuringSchedulingIgnoredDuringExecution： 硬亲和性preferredDuringSchedulingIgnoredDuringExecution：软亲和性 123456789101112kubectl explain pods.spec.affinity.podAffinityKIND: PodVERSION: v1RESOURCE: podAffinity &lt;Object&gt;DESCRIPTION: Describes pod affinity scheduling rules (e.g. co-locate this pod in the same node, zone, etc. as some other pod(s)). Pod affinity is a group of inter pod affinity scheduling rules.FIELDS: preferredDuringSchedulingIgnoredDuringExecution &lt;[]Object&gt; requiredDuringSchedulingIgnoredDuringExecution &lt;[]Object&gt; topologyKey :位置拓扑的键:这个是必须字段; 判断标签是不是在同一个位置 topologyKey + node标签的key 怎么判断是不是同一个位置： rack&#x3D;rack1 row&#x3D;row1 使用rack的键是同一个位置 使用row的键是同一个位置 labelSelector：我们要判断pod跟别的pod亲和，跟哪个pod亲和，需要靠labelSelector，通过labelSelector选则一组能作为亲和对象的pod资源namespace： labelSelector需要选则一组资源，那么这组资源是在哪个名称空间中呢，通过namespace指定，如果不指定namespaces，那么就是当前创建pod的名称空间 123456789kubectl explain pods.spec.affinity.podAffinity.requiredDuringSchedulingIgnoredDuringExecutionKIND: PodVERSION: v1RESOURCE: requiredDuringSchedulingIgnoredDuringExecution &lt;[]Object&gt;DESCRIPTION:FIELDS: labelSelector &lt;Object&gt; namespaces &lt;[]string&gt; topologyKey &lt;string&gt; -required- 123456789101112kubectl explain pods.spec.affinity.podAffinity.requiredDuringSchedulingIgnoredDuringExecution.labelSelector KIND: PodVERSION: v1RESOURCE: labelSelector &lt;Object&gt;DESCRIPTION: A label query over a set of resources, in this case pods. A label selector is a label query over a set of resources. The result of matchLabels and matchExpressions are ANDed. An empty label selector matches all objects. A null label selector matches no objects.FIELDS: matchExpressions &lt;[]Object&gt; matchLabels &lt;map[string]string&gt; 例1：pod节点亲和性 定义两个pod，第一个pod做为基准，第二个pod跟着它走 查看默认名称空间有哪些pod12kubectl get podsNo resources found in default namespace. 把看到的pod删除，让默认名称空间没有pod 创建一个pod，标签app2&#x3D;myapp21234567891011121314# cat pod-required-affinity-demo-1.yaml apiVersion: v1kind: Podmetadata: name: pod-first labels: app2: myapp2 tier: frontendspec: containers: - name: myapp image: docker.io/ikubernetes/myapp:v1 imagePullPolicy: IfNotPresent 123456[root@centos07-12 affinitytest]# kubectl apply -f pod-required-affinity-demo-1.yamlpod/pod-first created[root@centos07-12 affinitytest]# kubectl get pod -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESpod-first 1/1 Running 0 15s 10.244.250.198 centos07-62 &lt;none&gt; &lt;none&gt; 创建一个pod亲和pod标签为app2&#x3D;myapp2，并且node标签key是kubernetes.io&#x2F;hostname，满足前面2个条件，创建在相同的node上12345678910111213141516171819202122# pod-required-affinity-demo-2.yaml apiVersion: v1kind: Podmetadata: name: pod-second labels: app: backend tier: dbspec: containers: - name: busybox image: docker.io/library/busybox:latest imagePullPolicy: IfNotPresent command: [&quot;sh&quot;,&quot;-c&quot;,&quot;sleep 3600&quot;] affinity: podAffinity: requiredDuringSchedulingIgnoredDuringExecution: - labelSelector: matchExpressions: - &#123;key: app2, operator: In, values: [&quot;myapp2&quot;]&#125; topologyKey: kubernetes.io/hostname # 这里是node上标签的key 上面表示创建的pod必须与拥有app2&#x3D;myapp2标签的pod在一个节点上 1kubectl apply -f pod-required-affinity-demo-2.yaml 2个pod创建在一个了，都在centos07-62 node上， 第一个pod调度到哪，第二个pod也调度到哪，这就是pod节点亲和性 1234[root@centos07-12 nodeaffinitytest]# kubectl get pods -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESpod-first 0/1 ImagePullBackOff 0 4m30s 10.244.250.199 centos07-62 &lt;none&gt; &lt;none&gt;pod-second 1/1 Running 0 49s 10.244.250.200 centos07-62 &lt;none&gt; &lt;none&gt; pod节点反亲和性 就好像2个Pod是赌气的2个孩子，互相对着干，一个往东，另一随便去哪个方向就是不往东，他们不会去到同一个地方 例2：pod节点反亲和性:定义两个pod，第一个pod做为基准，第二个pod跟它调度节点相反 第一个pod做为基准12345678910111213# cat pod-required-anti-affinity-demo-1.yamlapiVersion: v1kind: Podmetadata: name: pod-first labels: app1: myapp1 tier: frontendspec: containers: - name: myapp image: ikubernetes/myapp:v1 imagePullPolicy: IfNotPresent 1kubectl apply -f pod-required-anti-affinity-demo-1.yaml 第二个pod跟它调度节点相反，注意这里有2个条件，第一个node的标签key不能有kubernetes.io&#x2F;hostname；第二个pod的标签不能包含app1&#x3D;myapp112345678910111213141516171819202122# cat pod-required-anti-affinity-demo-2.yamlapiVersion: v1kind: Podmetadata: name: pod-second labels: app: backend tier: dbspec: containers: - name: busybox image: busybox:latest imagePullPolicy: IfNotPresent command: [&quot;sh&quot;,&quot;-c&quot;,&quot;sleep 3600&quot;] affinity: podAntiAffinity: requiredDuringSchedulingIgnoredDuringExecution: - labelSelector: matchExpressions: - &#123;key: app1, operator: In, values: [&quot;myapp1&quot;]&#125; topologyKey: kubernetes.io/hostname 1kubectl apply -f pod-required-anti-affinity-demo-2.yaml 显示两个pod不在一个node节点上，这就是pod节点反亲和性1234[root@centos07-12 nodeantiaffinitytest]# kubectl get pod -owide --show-labelsNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES LABELSpod-first 1/1 Running 0 5m8s 10.244.250.201 centos07-62 &lt;none&gt; &lt;none&gt; app1=myapp1,tier=frontendpod-second 1/1 Running 0 91s 10.244.193.147 centos07-22 &lt;none&gt; &lt;none&gt; app=backend,tier=db 删除pod12kubectl delete -f pod-required-anti-affinity-demo-1.yamlkubectl delete -f pod-required-anti-affinity-demo-2.yaml 例3：换一个topologykey 给2个node节点添加标签zone12345[root@centos07-12 nodeantiaffinitytest]# kubectl label nodes centos07-22 zone=foonode/centos07-22 labeled[root@centos07-12 nodeantiaffinitytest]# kubectl label nodes centos07-62 zone=foonode/centos07-62 labeled 1234[root@centos07-12 nodeantiaffinitytest]# kubectl get nodes -l zone=fooNAME STATUS ROLES AGE VERSIONcentos07-22 Ready work 2d7h v1.27.0centos07-62 Ready work 6h20m v1.27.0 12345[root@centos07-12 nodeantiaffinitytest]# kubectl get nodes -L zoneNAME STATUS ROLES AGE VERSION ZONEcentos07-12 Ready control-plane 2d7h v1.27.0centos07-22 Ready work 2d7h v1.27.0 foocentos07-62 Ready work 6h21m v1.27.0 foo 1234567891011121314# cat pod-first-required-anti-affinity-demo-1.yamlapiVersion: v1kind: Podmetadata: name: pod-first labels: app3: myapp3 tier: frontendspec: containers: - name: myapp image: ikubernetes/myapp:v1 imagePullPolicy: IfNotPresent 1kubectl apply -f pod-first-required-anti-affinity-demo-1.yaml 12345678910111213141516171819202122# cat pod-second-required-anti-affinity-demo-1.yaml apiVersion: v1kind: Podmetadata: name: pod-second labels: app: backend tier: dbspec: containers: - name: busybox image: busybox:latest imagePullPolicy: IfNotPresent command: [&quot;sh&quot;,&quot;-c&quot;,&quot;sleep 3600&quot;] affinity: podAntiAffinity: requiredDuringSchedulingIgnoredDuringExecution: - labelSelector: matchExpressions: - &#123;key: app3 ,operator: In, values: [&quot;myapp3&quot;]&#125; topologyKey: zone 1kubectl apply -f pod-second-required-anti-affinity-demo-1.yaml 显示无法调度，第二个pod跟它调度节点相反，注意这里有2个条件，第一个node的标签key不能有zone；第二个pod的标签不能包含app1&#x3D;myapp11234[root@centos07-12 nodeantiaffinitytest]# kubectl get pods -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESpod-first 1/1 Running 0 29m 10.244.250.201 centos07-62 &lt;none&gt; &lt;none&gt;pod-second 0/1 Pending 0 14m &lt;none&gt; &lt;none&gt; &lt;none&gt; &lt;none&gt; 报错信息: 2 node(s) didn’t match pod anti-affinity rules123456789101112131415161718192021222324252627282930313233343536373839404142[root@centos07-12 nodeantiaffinitytest]# kubectl describe pods pod-secondName: pod-secondNamespace: defaultPriority: 0Service Account: defaultNode: &lt;none&gt;Labels: app=backend tier=dbAnnotations: &lt;none&gt;Status: PendingIP:IPs: &lt;none&gt;Containers: busybox: Image: busybox:latest Port: &lt;none&gt; Host Port: &lt;none&gt; Command: sh -c sleep 3600 Environment: &lt;none&gt; Mounts: /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-cw9m6 (ro)Conditions: Type Status PodScheduled FalseVolumes: kube-api-access-cw9m6: Type: Projected (a volume that contains injected data from multiple sources) TokenExpirationSeconds: 3607 ConfigMapName: kube-root-ca.crt ConfigMapOptional: &lt;nil&gt; DownwardAPI: trueQoS Class: BestEffortNode-Selectors: &lt;none&gt;Tolerations: node.kubernetes.io/not-ready:NoExecute op=Exists for 300s node.kubernetes.io/unreachable:NoExecute op=Exists for 300sEvents: Type Reason Age From Message ---- ------ ---- ---- ------- Warning FailedScheduling 4m49s (x3 over 15m) default-scheduler 0/3 nodes are available: 1 node(s) had untolerated taint &#123;node-role.kubernetes.io/control-plane: &#125;, 2 node(s) didn&#x27;t match pod anti-affinity rules. preemption: 0/3 nodes are available: 1 Preemption is not helpful for scheduling, 2 No preemption victims found for incoming pod.. 第二个pod是pending，因为两个节点是同一个位置，现在没有不是同一个位置的了，而且我们要求反亲和性，所以就会处于pending状态，如果在反亲和性这个位置把required改成preferred，那么也会运行。","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"14-K8S节点选择器nodeName和nodeSelector","slug":"运维/K8S/基础/14-K8S节点选择器nodeName和nodeSelector","date":"2023-05-07T02:00:50.000Z","updated":"2023-12-05T14:16:32.000Z","comments":true,"path":"2023/05/07/运维/K8S/基础/14-K8S节点选择器nodeName和nodeSelector/","link":"","permalink":"https://dbbruce.github.io/2023/05/07/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/14-K8S%E8%8A%82%E7%82%B9%E9%80%89%E6%8B%A9%E5%99%A8nodeName%E5%92%8CnodeSelector/","excerpt":"node节点选择器我们在创建pod资源的时候，pod会根据schduler进行调度，那么默认会调度到随机的一个工作节点如果我们想要pod调度到指定节点或者调度到一些具有相同特点的node节点，怎么办呢？可以使用pod中的nodeName或者nodeSelector字段指定要调度到的node节点","text":"node节点选择器我们在创建pod资源的时候，pod会根据schduler进行调度，那么默认会调度到随机的一个工作节点如果我们想要pod调度到指定节点或者调度到一些具有相同特点的node节点，怎么办呢？可以使用pod中的nodeName或者nodeSelector字段指定要调度到的node节点 nodeName：指定pod节点运行在哪个具体node上 把tomcat.tar.gz上传到centos07-22和centos07-62， 手动解压：ctr -n&#x3D;k8s.io images import tomcat.tar.gz 12[root@centos07-62 ~]# ctr -n=k8s.io images import tomcat.tar.gz [root@centos07-62 ~]# ctr -n=k8s.io images import tomcat.tar.gz 把busybox.tar.gz上传到centos07-22和centos07-62， 手动解压： ctr -n&#x3D;k8s.io images import busybox.tar.gz12[root@centos07-22 ~]# ctr -n=k8s.io images import busybox.tar.gz[root@centos07-22 ~]# ctr -n=k8s.io images import busybox.tar.gz cat pod-node.yaml 12345678910111213141516171819202122apiVersion: v1kind: Podmetadata: name: demo-pod namespace: test labels: app: myapp env: devspec: nodeName: centos07-62 # 指定到centos07-62 containers: - name: tomcat-pod-java ports: - containerPort: 8080 image: tomcat:8.5-jre8-alpine imagePullPolicy: IfNotPresent - name: busybox image: busybox:latest command: - &quot;/bin/sh&quot; - &quot;-c&quot; - &quot;sleep 3600&quot; kubectl apply -f pod-node.yaml123[root@centos07-12 nodenametest]# kubectl apply -f pod-node.yamlpod/demo-pod created 查看pod调度到哪个节点123[root@centos07-12 nodenametest]# kubectl get pod -n test -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESdemo-pod 2/2 Running 0 13s 10.244.250.194 centos07-62 &lt;none&gt; &lt;none&gt; nodeSelector：指定pod调度到具有哪些标签的node节点上 查看原有node的标签123456[root@centos07-12 nodenametest]# kubectl get node --show-labelsNAME STATUS ROLES AGE VERSION LABELScentos07-12 Ready control-plane 2d1h v1.27.0 beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=centos07-12,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node.kubernetes.io/exclude-from-external-load-balancers=centos07-22 Ready work 2d1h v1.27.0 beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=centos07-22,kubernetes.io/os=linux,node-role.kubernetes.io/work=workcentos07-62 Ready work 52m v1.27.0 beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=centos07-62,kubernetes.io/os=linux,node-role.kubernetes.io/work=work 给node节点打标签，打个具有disk&#x3D;ceph的标签12[root@centos07-12 nodenametest]# kubectl label nodes centos07-62 disk=cephnode/centos07-62 labeled 12345[root@centos07-12 nodenametest]# kubectl get node --show-labelsNAME STATUS ROLES AGE VERSION LABELScentos07-12 Ready control-plane 2d1h v1.27.0 beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=centos07-12,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node.kubernetes.io/exclude-from-external-load-balancers=centos07-22 Ready work 2d1h v1.27.0 beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=centos07-22,kubernetes.io/os=linux,node-role.kubernetes.io/work=workcentos07-62 Ready work 54m v1.27.0 beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,disk=ceph,kubernetes.io/arch=amd64,kubernetes.io/hostname=centos07-62,kubernetes.io/os=linux,node-role.kubernetes.io/work=work 12345[root@centos07-12 nodenametest]# kubectl get node -L diskNAME STATUS ROLES AGE VERSION DISKcentos07-12 Ready control-plane 2d1h v1.27.0centos07-22 Ready work 2d1h v1.27.0centos07-62 Ready work 56m v1.27.0 ceph 定义pod的时候指定要调度到具有disk&#x3D;ceph标签的node上12345678910111213141516171819# cat pod-1.yaml apiVersion: v1kind: Podmetadata: name: demo-pod-1 namespace: default labels: app: myapp env: devspec: nodeSelector: disk: ceph containers: - name: tomcat-pod-java ports: - containerPort: 8080 image: tomcat:8.5-jre8-alpine imagePullPolicy: IfNotPresent 1kubectl apply -f pod-1.yaml 查看pod调度到哪个节点12345[root@centos07-12 nodenametest]# kubectl get pods -o wide -n testNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESdemo-pod 2/2 Running 0 10m 10.244.250.194 centos07-62 &lt;none&gt; &lt;none&gt;demo-pod-1 1/1 Running 0 45s 10.244.250.195 centos07-62 &lt;none&gt; &lt;none&gt; 做完上面实验，需要把default名称空间下的pod全都删除 删除指定的pod:kubectl delete pods pod名字12[root@centos07-12 nodenametest]# kubectl delete pod -n test demo-podpod &quot;demo-pod&quot; deleted 使用创建pod的yaml文件删除，同时可以删除多个pod &#x3D;&gt;kubectl delete -f .（点），注意后面有个点 123[root@centos07-12 nodenametest]# kubectl delete -f .pod &quot;demo-pod-1&quot; deletedpod &quot;demo-pod&quot; deleted 删除node节点打的标签：123456[root@centos07-12 nodenametest]# kubectl get node --show-labelsNAME STATUS ROLES AGE VERSION LABELScentos07-12 Ready control-plane 2d2h v1.27.0 beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=centos07-12,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node.kubernetes.io/exclude-from-external-load-balancers=centos07-22 Ready work 2d1h v1.27.0 beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=centos07-22,kubernetes.io/os=linux,node-role.kubernetes.io/work=workcentos07-62 Ready work 70m v1.27.0 beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,disk=ceph,kubernetes.io/arch=amd64,kubernetes.io/hostname=centos07-62,kubernetes.io/os=linux,node-role.kubernetes.io/work=work 123[root@centos07-12 nodenametest]# kubectl label nodes centos07-62 disk-node/centos07-62 unlabeled 同一个yaml文件里定义pod资源，如果同时定义了nodeName和NodeSelector，那么条件必须都满足才可以，有一个不满足都会调度失败12345678910111213141516171819# 假如yaml文件改成如下：apiVersion: v1kind: Podmetadata: name: demo-pod-1 namespace: default labels: app: myapp env: devspec: nodeName: xianchaonode2 nodeSelector: disk: ceph containers: - name: tomcat-pod-java ports: - containerPort: 8080 image: tomcat:8.5-jre8-alpine imagePullPolicy: IfNotPresent 那么创建pod，会报错，报什么错呢？ :Warning NodeAffinity 17s kubelet Predicate NodeAffinity failed123[root@centos07-12 nodenametest]# kubectl get pod -n test -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESdemo-pod-1 0/1 NodeAffinity 0 37s &lt;none&gt; centos07-62 &lt;none&gt; &lt;none&gt; 假如给centos07-62继续打上标签12[root@centos07-12 nodenametest]# kubectl label nodes centos07-62 disk=cephnode/centos07-62 labeled 123[root@centos07-12 nodenametest]# kubectl get pod -n test -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESdemo-pod-1 0/1 NodeAffinity 0 5m46s &lt;none&gt; centos07-62 &lt;none&gt; &lt;none&gt; 12[root@centos07-12 nodenametest]# kubectl delete pod -n test demo-pod-1pod &quot;demo-pod-1&quot; deleted 12[root@centos07-12 nodenametest]# kubectl get pod -n test -owideNo resources found in test namespace. 12[root@centos07-12 nodenametest]# kubectl apply -f pod-1.yamlpod/demo-pod-1 created 123[root@centos07-12 nodenametest]# kubectl get pod -n test -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESdemo-pod-1 1/1 Running 0 4s 10.244.250.196 centos07-62 &lt;none&gt; &lt;none&gt; 删除标签1[root@centos07-12 nodenametest]# kubectl label node centos07-62 disk- 删除pod12[root@centos07-12 nodenametest]# kubectl delete pod demo-pod-1 -n testpod &quot;demo-pod-1&quot; deleted","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"13-K8S标签labels的使用","slug":"运维/K8S/基础/13-K8S标签labels的使用","date":"2023-05-06T12:00:50.000Z","updated":"2023-12-05T05:27:16.000Z","comments":true,"path":"2023/05/06/运维/K8S/基础/13-K8S标签labels的使用/","link":"","permalink":"https://dbbruce.github.io/2023/05/06/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/13-K8S%E6%A0%87%E7%AD%BElabels%E7%9A%84%E4%BD%BF%E7%94%A8/","excerpt":"标签 labels什么是标签？标签其实就一对 key&#x2F;value ，被关联到对象上，比如Pod,标签的使用我们倾向于能够表示对象的特殊特点，就是一眼就看出了这个Pod是干什么的，标签可以用来划分特定的对象（比如版本，服务类型等），标签可以在创建一个对象的时候直接定义，也可以在后期随时修改，每一个对象可以拥有多个标签，但是，key值必须是唯一的。创建标签之后也可以方便我们对资源进行分组管理。如果对pod打标签，之后就可以使用标签来查看、删除指定的pod。在k8s中，大部分资源都可以打标签。","text":"标签 labels什么是标签？标签其实就一对 key&#x2F;value ，被关联到对象上，比如Pod,标签的使用我们倾向于能够表示对象的特殊特点，就是一眼就看出了这个Pod是干什么的，标签可以用来划分特定的对象（比如版本，服务类型等），标签可以在创建一个对象的时候直接定义，也可以在后期随时修改，每一个对象可以拥有多个标签，但是，key值必须是唯一的。创建标签之后也可以方便我们对资源进行分组管理。如果对pod打标签，之后就可以使用标签来查看、删除指定的pod。在k8s中，大部分资源都可以打标签。 给pod资源打标签1234567891011121314151617181920212223# vim pod-test.yamlapiVersion: v1kind: Podmetadata: name: pod-test namespace: test labels: app: tomcat-pod-testspec: containers: - name: tomcat-test ports: - containerPort: 8080 image: xianchao/tomcat-8.5-jre8:v1 imagePullPolicy: IfNotPresent resources: requests: memory: &quot;100Mi&quot; # 1Mi=1024 cpu: &quot;500m&quot; # k8s将cpu1核分成1000毫核，500毫核 limits: memory: &quot;2Gi&quot; cpu: &quot;2&quot; 1kubectl apply -f pod-first.yaml 获取test命名空间下的pod信息1234kubectl get pods -n testNAME READY STATUS RESTARTS AGEpod-test 1/1 Running 0 14m 查看test名称空间下所有pod资源的标签1234kubectl get pods -n test --show-labelsNAME READY STATUS RESTARTS AGE LABELSpod-test 1/1 Running 0 15m app=tomcat-pod-test 对已经存在的pod打标签，标签是key：value形式123kubectl label pods -n test pod-test release=v1pod/pod-test labeled 查看标签是否打成功：1234kubectl get pods -n test --show-labelsNAME READY STATUS RESTARTS AGE LABELSpod-test 1/1 Running 0 68m app=tomcat-pod-test,release=v1 查看资源标签查看默认名称空间下所有pod资源的标签kubectl get pods –show-labels 查看默认名称空间下指定pod具有的所有标签kubectl get pods tomcat-test –show-labels 列出默认名称空间下标签key是release的pod，不显示标签kubectl get pods -l release 列出默认名称空间下标签key是release、值是v1的pod，不显示标签kubectl get pods -l release&#x3D;v1 1234567[root@centos07-12 nstest]# kubectl get pods -n test -l release=v1NAME READY STATUS RESTARTS AGEpod-test 1/1 Running 0 88m[root@centos07-12 nstest]# kubectl get pods -n test -l releaseNAME READY STATUS RESTARTS AGEpod-test 1/1 Running 0 88m 列出默认名称空间下标签key是release的所有pod，并打印对应的标签值，显示key字段，key字段就是过来的releasekubectl get pods -L release 123[root@centos07-12 nstest]# kubectl get pods -n test -L releaseNAME READY STATUS RESTARTS AGE RELEASEpod-test 1/1 Running 0 88m v1 查看所有名称空间下的所有pod的标签kubectl get pods –all-namespaces –show-labels 1234567891011121314[root@centos07-12 nstest]# kubectl get pods --all-namespaces --show-labelsNAMESPACE NAME READY STATUS RESTARTS AGE LABELSkube-system calico-kube-controllers-75c9ddd877-86xrx 1/1 Running 1 (44h ago) 44h k8s-app=calico-kube-controllers,pod-template-hash=75c9ddd877kube-system calico-node-d7cqt 1/1 Running 2 (44h ago) 44h controller-revision-hash=5fc89c58fc,k8s-app=calico-node,pod-template-generation=1kube-system calico-node-sn4cb 1/1 Running 2 (26h ago) 44h controller-revision-hash=5fc89c58fc,k8s-app=calico-node,pod-template-generation=1kube-system coredns-65dcc469f7-4twqh 1/1 Running 2 (26h ago) 45h k8s-app=kube-dns,pod-template-hash=65dcc469f7kube-system coredns-65dcc469f7-ltfc4 1/1 Running 7 (26h ago) 45h k8s-app=kube-dns,pod-template-hash=65dcc469f7kube-system etcd-centos07-12 1/1 Running 2 (44h ago) 45h component=etcd,tier=control-planekube-system kube-apiserver-centos07-12 1/1 Running 2 (26h ago) 45h component=kube-apiserver,tier=control-planekube-system kube-controller-manager-centos07-12 1/1 Running 2 (44h ago) 45h component=kube-controller-manager,tier=control-planekube-system kube-proxy-cznxr 1/1 Running 2 (44h ago) 44h controller-revision-hash=6478b8f4f,k8s-app=kube-proxy,pod-template-generation=1kube-system kube-proxy-xmkn4 1/1 Running 2 (26h ago) 45h controller-revision-hash=6478b8f4f,k8s-app=kube-proxy,pod-template-generation=1kube-system kube-scheduler-centos07-12 1/1 Running 2 (26h ago) 45h component=kube-scheduler,tier=control-planetest pod-test 1/1 Running 0 90m app=tomcat-pod-test,release=v1","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"12-namespace和资源配额应用场景分析","slug":"运维/K8S/基础/12-namespace和资源配额应用场景分析","date":"2023-05-06T02:00:50.000Z","updated":"2023-12-05T03:59:39.000Z","comments":true,"path":"2023/05/06/运维/K8S/基础/12-namespace和资源配额应用场景分析/","link":"","permalink":"https://dbbruce.github.io/2023/05/06/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/12-namespace%E5%92%8C%E8%B5%84%E6%BA%90%E9%85%8D%E9%A2%9D%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF%E5%88%86%E6%9E%90/","excerpt":"命名空间 &#x3D;&gt; namespace &#x3D;&#x3D; ns什么是命名空间？Kubernetes 支持多个虚拟集群，它们底层依赖于同一个物理集群。 这些虚拟集群被称为命名空间。命名空间namespace是k8s集群级别的资源，可以给不同的用户、租户、环境或项目创建对应的命名空间，例如，可以为test、devlopment、production环境分别创建各自的命名空间。","text":"命名空间 &#x3D;&gt; namespace &#x3D;&#x3D; ns什么是命名空间？Kubernetes 支持多个虚拟集群，它们底层依赖于同一个物理集群。 这些虚拟集群被称为命名空间。命名空间namespace是k8s集群级别的资源，可以给不同的用户、租户、环境或项目创建对应的命名空间，例如，可以为test、devlopment、production环境分别创建各自的命名空间。 namespace应用场景命名空间适用于存在很多跨多个团队或项目的用户的场景。对于只有几到几十个用户的集群，根本不需要创建或考虑命名空间。 namespacs使用案例分享 查看命名空间 kubect get namespace &#x2F; ns 123456789101112[root@centos07-12 ~]# kubectl get nsNAME STATUS AGEdefault Active 25hkube-node-lease Active 25hkube-public Active 25hkube-system Active 25h[root@centos07-12 ~]# kubectl get namespaceNAME STATUS AGEdefault Active 25hkube-node-lease Active 25hkube-public Active 25hkube-system Active 25h 创建一个test命名空间 kubectl create ns test kubectl create namespace test 1234567891011121314[root@centos07-12 ~]# kubectl create ns testnamespace/test created[root@centos07-12 ~]# kubectl create ns test2namespace/test2 created[root@centos07-12 ~]# kubectl get nsNAME STATUS AGEdefault Active 25hkube-node-lease Active 25hkube-public Active 25hkube-system Active 25htest Active 16stest2 Active 5s Pod资源配额 为什么要资源配额？ 当多个应用共享固定节点数目的集群时，人们会担心某些应用过度使用资源，从而影响到其他的服务，我们需要设定一些规则，用来保证应用能获得其运行所需的合理资源 CPU资源类型 CPU资源的约束和请求以毫核(m)为单位。在k8s中1m是最小的调度单位，CPU的一个核心可以看作1000m 假如你有2颗CPU，且每个CPU为4核心，那么你的CPU资源总量就是8000m 内存资源类型 memory的约束个请求以字节为单位 可以使用以下单位表示内存：E、P、T、G、M、k 也可以使用对应的2的幂数：Ei、Pi、Ti、Gi、Mi、Ki 1k &#x3D;&#x3D; 1000 1Ki &#x3D;&#x3D; 1024 namespace资源限额 如何对namespace资源做限额呢？ vim namespace-quota.yaml123456789101112apiVersion: v1kind: ResourceQuotametadata: name: mem-cpu-quota namespace: testspec: hard: requests.cpu: &quot;2&quot; # 所有非终止状态的 Pod，其 CPU 需求总量不能超过该值。 requests.memory: 2Gi # 所有非终止状态的 Pod，其内存需求总量不能超过该值 limits.cpu: &quot;4&quot; # 所有非终止状态的 Pod，其 CPU 限额总量不能超过该值。 limits.memory: 4Gi # 所有非终止状态的 Pod，其内存限额总量不能超过该值。 命名空间设置cpu，mem限额 kubectl apply -f namespace-quota.yaml创建的ResourceQuota对象将在test名字空间中添加以下限制：每个容器必须设置：内存请求（memory request）内存限额（memory limit）cpu请求（cpu request）cpu限额（cpu limit） 12[root@centos07-12 nstest]# kubectl apply -f namespace-quota.yamlresourcequota/mem-cpu-quota created 所有容器的内存请求总额不得超过2GiB。所有容器的内存限额总额不得超过4 GiB。所有容器的CPU请求总额不得超过2 CPU。所有容器的CPU限额总额不得超过4CPU。 查看命名空间资源 kubectl get quota -n testkubectl describe quota -n test 1234[root@centos07-12 nstest]# kubectl get quota -n testNAME AGE REQUEST LIMITmem-cpu-quota 9m32s requests.cpu: 0/2, requests.memory: 0/2Gi limits.cpu: 0/4, limits.memory: 0/4Gi 123456789[root@centos07-12 nstest]# kubectl describe quota -n testName: mem-cpu-quotaNamespace: testResource Used Hard-------- ---- ----limits.cpu 0 4limits.memory 0 4Girequests.cpu 0 2requests.memory 0 2Gi 创建pod时候必须设置资源限额，否则创建失败，如下： 正常配置: 1234567891011121314151617181920212223# vim pod-test.yamlapiVersion: v1kind: Podmetadata: name: pod-test namespace: test labels: app: tomcat-pod-testspec: containers: - name: tomcat-test ports: - containerPort: 8080 image: xianchao/tomcat-8.5-jre8:v1 imagePullPolicy: IfNotPresent resources: requests: memory: &quot;100Mi&quot; cpu: &quot;500m&quot; limits: memory: &quot;2Gi&quot; cpu: &quot;2&quot; 12[root@centos07-12 nstest]# kubectl apply -f pod-test.yamlpod/pod-test created 删除pod kubectl delete pod -n test pod-test 12[root@centos07-12 nstest]# kubectl delete pod -n test pod-testpod &quot;pod-test&quot; deleted 使用的资源超过限额 限额：limits.cpu&#x3D;4,limits.memory&#x3D;4Gi新pod配置 limits.cpu&#x3D;5,limits.memory&#x3D;5Gi报错的配置如下： 1234567891011121314151617181920212223# cat pod-test.yamlapiVersion: v1kind: Podmetadata: name: pod-test namespace: test labels: app: tomcat-pod-testspec: containers: - name: tomcat-test ports: - containerPort: 8080 image: xianchao/tomcat-8.5-jre8:v1 imagePullPolicy: IfNotPresent resources: requests: memory: &quot;2Gi&quot; cpu: &quot;2&quot; limits: memory: &quot;5Gi&quot; cpu: &quot;5&quot; 12[root@centos07-12 nstest]# kubectl apply -f pod-test.yamlError from server (Forbidden): error when creating &quot;pod-test.yaml&quot;: pods &quot;pod-test&quot; is forbidden: exceeded quota: mem-cpu-quota, requested: limits.cpu=5,limits.memory=5Gi, used: limits.cpu=0,limits.memory=0, limited: limits.cpu=4,limits.memory=4Gi","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"11- Pod资源清单编写技巧","slug":"运维/K8S/基础/11- Pod资源清单编写技巧","date":"2023-05-05T13:00:50.000Z","updated":"2023-12-05T03:44:42.000Z","comments":true,"path":"2023/05/05/运维/K8S/基础/11- Pod资源清单编写技巧/","link":"","permalink":"https://dbbruce.github.io/2023/05/05/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/11-%20Pod%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E7%BC%96%E5%86%99%E6%8A%80%E5%B7%A7/","excerpt":"","text":"Pod资源清单编写技巧 通过kubectl explain 查看定义Pod资源包含哪些字段。kubectl explain pod APIVersion定义了对象,代表了一个版本。Kind是字符串类型的值，代表了要创建的资源。服务器可以从客户端提交的请求推断出这个资源。metadata是对象，定义元数据属性信息的spec制定了定义Pod的规格，里面包含容器的信息status表示状态，这个不可以修改，定义pod的时候也不需要定义这个字段 1234567891011121314151617181920212223242526272829303132333435363738KIND: PodVERSION: v1DESCRIPTION: Pod is a collection of containers that can run on a host. This resource is created by clients and scheduled onto hosts.Pod是可以在主机上运行的容器的集合。此资源是由客户端创建并安排到主机上。FIELDS: APIVersion定义了对象,代表了一个版本。 apiVersion &lt;string&gt; APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources Kind是字符串类型的值，代表了要创建的资源。服务器可以从客户端提交的请求推断出这个资源。 kind &lt;string&gt; Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds metadata是对象，定义元数据属性信息的 metadata &lt;Object&gt; Standard object&#x27;s metadata. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata spec制定了定义Pod的规格，里面包含容器的信息 spec &lt;Object&gt; Specification of the desired behavior of the pod. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status status表示状态，这个不可以修改，定义pod的时候也不需要定义这个字段 status &lt;Object&gt; Most recently observed status of the pod. This data may not be up to date. Populated by the system. Read-only. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status 查看pod.metadata字段如何定义 kubectl explain pod.metadatametadata是对象Object，下面可以有多个字段 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273KIND: PodVERSION: v1RESOURCE: metadata &lt;Object&gt; metadata是对象&lt;Object&gt;，下面可以有多个字段DESCRIPTION: Standard object&#x27;s metadata. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata ObjectMeta is metadata that all persisted resources must have, which includes all objects users must create.FIELDS:annotations是注解，map类型表示对应的值是key-value键值对，&lt;string,string&gt;表示 key和value都是String类型的 annotations &lt;mapstringstring&gt; Annotations is an unstructured key value map stored with a resource that may be set by external tools to store and retrieve arbitrary metadata. They are not queryable and should be preserved when modifying objects. More info: http://kubernetes.io/docs/user-guide/annotations &quot;metadata&quot;: &#123; &quot;annotations&quot;: &#123; &quot;key1&quot; : &quot;value1&quot;, &quot;key2&quot; : &quot;value2&quot; &#125; &#125;用Annotation来记录的信息包括：build信息、release信息、Docker镜像信息等，例如时间戳、release id号、镜像hash值、docker registry地址等；日志库、监控库、分析库等资源库的地址信息；程序调试工具信息，例如工具名称、版本号等；团队的联系信息，例如电话号码、负责人名称、网址等。#对象所属群集的名称。这是用来区分不同集群中具有相同名称和命名空间的资源。此字段现在未设置在任何位置，apiserver将忽略它，如果设置了就使用设置的值 clusterName &lt;string&gt; The name of the cluster which the object belongs to. This is used to distinguish resources with same name and namespace in different clusters. This field is not set anywhere right now and apiserver is going to ignore it if set in create or update request. creationTimestamp &lt;string&gt; deletionGracePeriodSeconds &lt;integer&gt; deletionTimestamp &lt;string&gt; finalizers &lt;string&gt; generateName &lt;string&gt; generation &lt;integer&gt; #labels是标签，labels是map类型，map类型表示对应的值是key-value键值对，&lt;string,string&gt;表示 key和value都是String类型的 labels &lt;mapstringstring&gt; #创建的资源具有的标签 Map of string keys and values that can be used to organize and categorize (scope and select) objects. May match selectors of replication controllers and services. More info: http://kubernetes.io/docs/user-guide/labels managedFields &lt;Object&gt; #创建的资源的名字 name &lt;string&gt; #创建的资源所属的名称空间 namespaces划分了一个空间，在同一个namesace下的资源名字是唯一的，默认的名称空间是default。 namespace &lt;string&gt; Namespace defines the space within which each name must be unique. An empty namespace is equivalent to the &quot;default&quot; namespace, but &quot;default&quot; is the canonical representation. Not all objects are required to be scoped to a namespace - the value of this field for those objects will be empty. Must be a DNS_LABEL. Cannot be updated. More info: http://kubernetes.io/docs/user-guide/namespaces ownerReferences &lt;Object&gt; resourceVersion &lt;string&gt; selfLink &lt;string&gt; uid &lt;string&gt; 查看pod.spec字段如何定义 kubectl explain pod.spec 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152KIND: PodVERSION: v1RESOURCE: spec &lt;Object&gt;DESCRIPTION: Specification of the desired behavior of the pod. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status PodSpec is a description of a pod.#Pod的spec字段是用来描述Pod的FIELDS:#表示Pod可以运行的最长时间，达到设置的值后，Pod会自动停止。 activeDeadlineSeconds &lt;integer&gt; #定义亲和性的 affinity &lt;Object&gt; automountServiceAccountToken &lt;boolean&gt; #containers是对象列表，用来定义容器的，是必须字段。对象列表 表示下面有很多对象，对象列表下面的内容用 - 连接。 containers &lt;Object&gt; -required- dnsConfig &lt;Object&gt; dnsPolicy &lt;string&gt; enableServiceLinks &lt;boolean&gt; ephemeralContainers &lt;Object&gt; hostAliases &lt;Object&gt; hostIPC &lt;boolean&gt; hostNetwork &lt;boolean&gt; hostPID &lt;boolean&gt; hostname &lt;string&gt; imagePullSecrets &lt;Object&gt; initContainers &lt;Object&gt; nodeName &lt;string&gt; nodeSelector &lt;mapstringstring&gt; overhead &lt;mapstringstring&gt; preemptionPolicy &lt;string&gt; priority &lt;integer&gt; priorityClassName &lt;string&gt; readinessGates &lt;Object&gt; restartPolicy &lt;string&gt; runtimeClassName &lt;string&gt; schedulerName &lt;string&gt; securityContext &lt;Object&gt; serviceAccount &lt;string&gt; serviceAccountName &lt;string&gt; setHostnameAsFQDN &lt;boolean&gt; shareProcessNamespace &lt;boolean&gt; subdomain &lt;string&gt; terminationGracePeriodSeconds &lt;integer&gt; tolerations &lt;Object&gt; topologySpreadConstraints &lt;Object&gt; volumes &lt;Object&gt; 查看pod.spec.containers字段如何定义 kubectl explain pod.spec.containers 12345678910111213141516171819202122232425262728293031323334353637383940414243444546KIND: PodVERSION: v1RESOURCE: containers &lt;Object&gt;DESCRIPTION: List of containers belonging to the pod. Containers cannot currently be added or removed. There must be at least one container in a Pod. Cannot be updated. A single application container that you want to run within a pod.#container是定义在pod里面的，一个pod至少要有一个容器。FIELDS: args &lt;string&gt; command &lt;string&gt; env &lt;Object&gt; envFrom &lt;Object&gt;image是用来指定容器需要的镜像的 image &lt;string&gt; 镜像拉取策略，pod是要调度到node节点的，那pod启动需要镜像，可以根据这个字段设置镜像拉取策略，支持如下三种：Always：不管本地是否存在镜像，都要重新拉取镜像Never： 从不拉取镜像IfNotPresent：如果本地存在，使用本地的镜像，本地不存在，从官方拉取镜像 imagePullPolicy &lt;string&gt; lifecycle &lt;Object&gt; livenessProbe &lt;Object&gt;#name是必须字段，用来指定容器名字的 name &lt;string&gt; -required-#port是端口，属于对象列表 ports &lt;Object&gt; readinessProbe &lt;Object&gt; resources &lt;Object&gt; securityContext &lt;Object&gt; startupProbe &lt;Object&gt; stdin &lt;boolean&gt; stdinOnce &lt;boolean&gt; terminationMessagePath &lt;string&gt; terminationMessagePolicy &lt;string&gt; tty &lt;boolean&gt; volumeDevices &lt;Object&gt; volumeMounts &lt;Object&gt; workingDir &lt;string&gt; ### 查看pod.spec.container.ports字段如何定义 kubectl explain pod.spec.containers.ports 12345678910111213141516171819202122232425262728293031323334353637KIND: PodVERSION: v1RESOURCE: ports &lt;Object&gt;DESCRIPTION: List of ports to expose from the container. Exposing a port here gives the system additional information about the network connections a container uses, but is primarily informational. Not specifying a port here DOES NOT prevent that port from being exposed. Any port which is listening on the default &quot;0.0.0.0&quot; address inside a container will be accessible from the network. Cannot be updated. ContainerPort represents a network port in a single container.FIELDS:#containerPort是必须字段， pod中的容器需要暴露的端口。 containerPort &lt;integer&gt; -required- Number of port to expose on the pod&#x27;s IP address. This must be a valid port number, 0 &lt; x &lt; 65536.#将容器中的服务暴露到宿主机的端口上时，可以指定绑定的宿主机 IP。 hostIP &lt;string&gt; What host IP to bind the external port to.#容器中的服务在宿主机上映射的端口 hostPort &lt;integer&gt; Number of port to expose on the host. If specified, this must be a valid port number, 0 &lt; x &lt; 65536. If HostNetwork is specified, this must match ContainerPort. Most containers do not need this.#端口的名字 name &lt;string&gt; If specified, this must be an IANA_SVC_NAME and unique within the pod. Each named port in a pod must have a unique name. Name for the port that can be referred to by services. protocol &lt;string&gt; Protocol for port. Must be UDP, TCP, or SCTP. Defaults to &quot;TCP&quot;. 通过kubectl run创建Pod1kubectl run tomcat --image=xianchao/tomcat-8.5-jre8:v1 --image-pull-policy=&#x27;IfNotPresent&#x27; --port=8080 查看kubectl的帮助命令：1kubectl --help (双杠) 进入容器1kubectl exec -it tomcat-test -c tomcat-java -- /bin/bash","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"10-K8S最小调度单元Pod概述","slug":"运维/K8S/基础/10-K8S最小调度单元Pod概述","date":"2023-05-05T12:00:50.000Z","updated":"2023-12-05T03:23:26.000Z","comments":true,"path":"2023/05/05/运维/K8S/基础/10-K8S最小调度单元Pod概述/","link":"","permalink":"https://dbbruce.github.io/2023/05/05/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/10-K8S%E6%9C%80%E5%B0%8F%E8%B0%83%E5%BA%A6%E5%8D%95%E5%85%83Pod%E6%A6%82%E8%BF%B0/","excerpt":"官方文档K8s官方文档：https://kubernetes.io/K8s中文官方文档： https://kubernetes.io/zh/K8s Github地址：https://github.com/kubernetes/kubernetes","text":"官方文档K8s官方文档：https://kubernetes.io/K8s中文官方文档： https://kubernetes.io/zh/K8s Github地址：https://github.com/kubernetes/kubernetes pod的简单理解 pod包含container，container运行在pod中，一个pod有多个container，pod可以看出一个虚拟机，container可以看出进程； Pod是什么 官方文档：https://kubernetes.io/docs/concepts/workloads/pods/ Pod是Kubernetes中的最小调度单元，k8s是通过定义一个Pod的资源，然后在Pod里面运行容器，容器需要指定一个镜像，这样就可以用来运行具体的服务。一个Pod封装一个容器（也可以封装多个容器），Pod里的容器共享存储、网络等。也就是说，应该把整个pod看作虚拟机，然后每个容器相当于运行在虚拟机的进程Pod是需要调度到k8s集群的工作节点来运行的，具体调度到哪个节点，是根据scheduler调度器实现的。 白话解释： 可以把pod看成是一个“豌豆荚”，里面有很多“豆子”（容器）。一个豌豆荚里可以有很多豆子（容器）pod相当于一个逻辑主机–比方说我们想要部署一个tomcat应用，如果不用容器，我们可能会部署到物理机、虚拟机或者云主机上，那么出现k8s之后，我们就可以定义一个pod资源，在pod里定义一个把tomcat容器，所以pod充当的是一个逻辑主机的角色。pod可以包含多个或者一个container Pod如何管理多个容器？一个pod有多个容器，最好这些容器有关联关系， Pod中可以同时运行多个容器。同一个Pod中的容器会自动的分配到同一个 node 上。同一个Pod中的容器共享资源、网络环境，它们总是被同时调度，在一个Pod中同时运行多个容器是一种比较高级的用法，只有当你的容器需要紧密配合协作的时候才考虑用这种模式。例如，你有一个容器作为web服务器运行，需要用到共享的volume，有另一个“sidecar”容器来从远端获取资源更新这些文件。 一些Pod有init容器和应用容器。 在应用程序容器启动之前，运行初始化容器。 Pod网络 Pod是有IP地址的，假如pod不是共享物理机ip，由网络插件（calico、flannel、weave）划分的ip，每个pod都被分配唯一的IP地址 查看pod信息 加-owide 会多显示ip, node, nominated node, readiness ga 1234567891011121314[root@centos07-12 ~]# kubectl get pods -n kube-system -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATEScalico-kube-controllers-75c9ddd877-86xrx 1/1 Running 1 (20h ago) 20h 10.244.193.132 centos07-22 &lt;none&gt; &lt;none&gt;calico-node-d7cqt 1/1 Running 2 (20h ago) 20h 192.168.1.22 centos07-22 &lt;none&gt; &lt;none&gt;calico-node-sn4cb 1/1 Running 2 (165m ago) 20h 192.168.1.12 centos07-12 &lt;none&gt; &lt;none&gt;coredns-65dcc469f7-4twqh 1/1 Running 2 (165m ago) 21h 10.244.234.195 centos07-12 &lt;none&gt; &lt;none&gt;coredns-65dcc469f7-ltfc4 1/1 Running 7 (165m ago) 21h 10.244.234.196 centos07-12 &lt;none&gt; &lt;none&gt;etcd-centos07-12 1/1 Running 2 (20h ago) 21h 192.168.1.12 centos07-12 &lt;none&gt; &lt;none&gt;kube-apiserver-centos07-12 1/1 Running 2 (165m ago) 21h 192.168.1.12 centos07-12 &lt;none&gt; &lt;none&gt;kube-controller-manager-centos07-12 1/1 Running 2 (20h ago) 21h 192.168.1.12 centos07-12 &lt;none&gt; &lt;none&gt;kube-proxy-cznxr 1/1 Running 2 (20h ago) 20h 192.168.1.22 centos07-22 &lt;none&gt; &lt;none&gt;kube-proxy-xmkn4 1/1 Running 2 (165m ago) 21h 192.168.1.12 centos07-12 &lt;none&gt; &lt;none&gt;kube-scheduler-centos07-12 1/1 Running 2 (165m ago) 21h 192.168.1.12 centos07-12 &lt;none&gt; &lt;none&gt; 1234567891011121314[root@centos07-12 ~]# kubectl get pods -n kube-systemNAME READY STATUS RESTARTS AGEcalico-kube-controllers-75c9ddd877-86xrx 1/1 Running 1 (20h ago) 20hcalico-node-d7cqt 1/1 Running 2 (20h ago) 20hcalico-node-sn4cb 1/1 Running 2 (171m ago) 20hcoredns-65dcc469f7-4twqh 1/1 Running 2 (171m ago) 21hcoredns-65dcc469f7-ltfc4 1/1 Running 7 (171m ago) 21hetcd-centos07-12 1/1 Running 2 (20h ago) 21hkube-apiserver-centos07-12 1/1 Running 2 (171m ago) 21hkube-controller-manager-centos07-12 1/1 Running 2 (20h ago) 21hkube-proxy-cznxr 1/1 Running 2 (20h ago) 21hkube-proxy-xmkn4 1/1 Running 2 (171m ago) 21hkube-scheduler-centos07-12 1/1 Running 2 (171m ago) 21h pod使用k8s初始化时的网段 podSubnet: 10.244.0.0&#x2F;16 Docker容器互联的方式： 创建新容器的时候，通过–net container参数，指定其和已经存在的某个容器共享一个 Network Namespace。如下图所示，右方黄色新创建的container，其网卡共享左边容器。因此就不会拥有自己独立的 IP，而是共享左边容器的 IP 172.17.0.2,端口范围等网络资源 和已经存在的none容器共享网络docker run –name container2 –net&#x3D;container:none -it –privileged&#x3D;true centos Kubernetes中容器共享的方式 在k8s中，启动Pod时，会先启动⼀个pause 的容器，然后将后续的所有容器都 “link 到这个pause 的容器，以实现⽹络共享。 Pod存储 创建Pod的时候可以指定挂载的存储卷。 POD中的所有容器都可以访问共享卷，允许这些容器共享数据。 Pod只要挂载持久化数据卷，Pod重启之后数据还是会存在的。 之前学习过容器，为什么还需要Pod？ 1、Pod是由一组紧耦合的容器组成的容器组，当然目前最流行的就是Docker、containerd、podman容器，Pod就可以作为1或者多个容器的载体。2、Pod中的所用容器会被一致调度、同节点部署，并且在一个“共享环境”中运行。Pod想成一个车：车里面好多座位，每个座位都坐不同的人，每个座位想成是一个容器，这里的“共享环境”包括以下几点： 1）所有容器共享一个IP地址和端口空间，意味着容器之间可以通过localhost高效访问，不能有端口冲突 2）允许容器之间共享存储卷，通过文件系统交互信息 3、有些容器需要紧密联系，需要一起工作。Pod提供了比容器更高层次的抽象， Pod中的所有容器使用同一个网络的namespace，即相同的IP地址和Port空间。它们可以直接用localhost通信。同样的，这些容器可以共享存储，当K8s挂载Volume到Pod上，本质上是将volume挂载到Pod中的每一个容器里。 Pod工作方式 在K8s中，所有的资源都可以使用一个yaml文件来创建，创建Pod也可以使用yaml配置文件。或者使用kubectl run在命令行创建Pod（不常用）。 自主式Pod 所谓的自主式Pod，就是直接定义一个Pod资源，如下：kind: Pod，类型直接定义为pod 12345678910111213141516# vim pod-tomcat.yamlapiVersion: v1kind: Podmetadata: name: tomcat-test namespace: default labels: app: tomcatspec: containers: - name: tomcat-java ports: - containerPort: 8080 image: xianchao/tomcat-8.5-jre8:v1 imagePullPolicy: IfNotPresent 导入镜像 把 tomcat.tar.gz上传到centos07-22节点，手动解压：ctr -n&#x3D;k8s.io images import tomcat.tar.gz 12[root@centos07-22 ~]# ctr -n=k8s.io images import tomcat.tar.gzunpacking docker.io/xianchao/tomcat-8.5-jre8:v1 (sha256:14dae4798a335e2925e4ee07b3ccd519a67faab2a9155adeb76a4556478dd8d7)...done 更新资源清单文件 kubectl apply -f pod-tomcat.yaml 12[root@centos07-12 ~]# kubectl apply -f pod-tomcat.yamlpod/tomcat-test created 查看pod是否创建成功 kubectl get pods -o wide -l app&#x3D;tomcat 123[root@centos07-12 ~]# kubectl get pods -o wide -l app=tomcatNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATEStomcat-test 1/1 Running 0 74s 10.244.193.133 centos07-22 &lt;none&gt; &lt;none&gt; 但是自主式Pod是存在一个问题的，假如我们不小心删除了pod 通过上面可以看到，如果直接定义一个Pod资源，那Pod被删除，就彻底被删除了，不会再创建一个新的Pod，这在生产环境还是具有非常大风险的，所以今后我们接触的Pod，都是控制器管理的。删除pod: kubectl delete pods tomcat-test查看pod是否还在: kubectl get pods -l app&#x3D;tomcat 12[root@centos07-12 ~]# kubectl delete pods tomcat-testpod &quot;tomcat-test&quot; deleted 12[root@centos07-12 ~]# kubectl get pods -l app=tomcatNo resources found in default namespace. 自主pod简单来说，就是kind&#x3D;pod 控制器管理的Pod 常见的管理Pod的控制器：Replicaset、Deployment、Job、CronJob、Daemonset、Statefulset。控制器管理的Pod可以确保Pod始终维持在指定的副本数运行。如，通过Deployment管理Pod 导入镜像 把 nginx.tar.上传到centos07-22节点，手动解压：ctr -n&#x3D;k8s.io images import nginx.tar.gz 12[root@centos07-22 ~]# ctr -n=k8s.io images import nginx.tar.gzunpacking docker.io/xianchao/nginx:v1 (sha256:47f9a127fcda0c39a444b9ae608055abcf71f02351665aa2c450b7bdb7434aca)...done 创建一个资源清单文件123456789101112131415161718192021222324# vim nginx-deploy.yaml apiVersion: apps/v1kind: Deploymentmetadata: name: nginx-test labels: app: nginx-deployspec: selector: matchLabels: app: nginx replicas: 2 template: metadata: labels: app: nginx spec: containers: - name: my-nginx image: xianchao/nginx:v1 imagePullPolicy: IfNotPresent ports: - containerPort: 80 更新资源清单文件 kubectl apply -f nginx-deploy.yaml 12[root@centos07-12 ~]# kubectl apply -f nginx-deploy.yamldeployment.apps/nginx-test created 查看Deployment kubectl get deploy -l app&#x3D;nginx-deploy 123[root@centos07-12 ~]# kubectl get deploy -l app=nginx-deployNAME READY UP-TO-DATE AVAILABLE AGEnginx-test 2/2 2 2 27s 查看Replicaset kubectl get rs -l app&#x3D;nginx 123[root@centos07-12 ~]# kubectl get rs -l app=nginxNAME DESIRED CURRENT READY AGEnginx-test-54789c88c6 2 2 2 64s 查看pod kubectl get pods -o wide -l app&#x3D;nginx 1234[root@centos07-12 ~]# kubectl get pods -o wide -l app=nginxNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESnginx-test-54789c88c6-9vzvx 1/1 Running 0 99s 10.244.193.135 centos07-22 &lt;none&gt; &lt;none&gt;nginx-test-54789c88c6-s4wtn 1/1 Running 0 99s 10.244.193.134 centos07-22 &lt;none&gt; &lt;none&gt; 删除 nginx-test-54789c88c6-9vzvx 这个pod kubectl delete pods nginx-test-54789c88c6-9vzvx kubectl get pods -o wide -l app&#x3D;nginx 12[root@centos07-12 ~]# kubectl delete pods nginx-test-54789c88c6-9vzvxpod &quot;nginx-test-54789c88c6-9vzvx&quot; deleted 1234[root@centos07-12 ~]# kubectl get pods -o wide -l app=nginxNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESnginx-test-54789c88c6-55t77 1/1 Running 0 8s 10.244.193.136 centos07-22 &lt;none&gt; &lt;none&gt;nginx-test-54789c88c6-s4wtn 1/1 Running 0 2m56s 10.244.193.134 centos07-22 &lt;none&gt; &lt;none&gt; 发现重新创建一个新的pod是nginx-test-75c685fdb7-pr8gh通过上面可以发现通过deployment管理的pod，可以确保pod始终维持在指定副本数量 如何基于Pod运行应用 注创建pod流程：(面试100会问)kubectl apply -f nginx-deploy.yaml-&gt;找到config文件，基于config文件指定的用户访问指定的集群，这样就找到了apiserver 第一步： 通过 kubectl 命令向 apiserver 提交创建pod的请求，apiserver接收到pod创建请求后，会将pod的属性信息(metadata)写入etcd。 第二步： apiserver触发watch机制准备创建pod，信息转发给调度器scheduler，调度器使用调度算法选择node，调度器将node信息给apiserver，apiserver将绑定的node信息写入etcd 第三步： apiserver又通过watch机制，调用kubelet，指定pod信息，调用容器运行时创建并启动pod内的容器。 第四步： 创建完成之后反馈给kubelet, kubelet又将pod的状态信息给apiserver,apiserver又将pod的状态信息写入etcd。 只要掌握帮助命令：所有的YAML文件都能写出来！！！ 格式：kubectl explain + 命令 kubectl explain pod kubectl explain pod.metadata kubectl explain pod.metadata.anan 包含required字段是必写字段 通过资源清单文件创建第一个Pod12345678910111213141516# vim pod-first.yamlapiVersion: v1kind: Podmetadata: name: tomcat-test namespace: default labels: app: tomcatspec: containers: - name: tomcat-java ports: - containerPort: 8080 image: xianchao/tomcat-8.5-jre8:v1 imagePullPolicy: IfNotPresent 更新资源清单文件12[root@centos07-12 ~]# kubectl apply -f pod-first.yamlpod/tomcat-test created 查看pod是否创建成功123[root@centos07-12 ~]# kubectl get pods -l app=tomcatNAME READY STATUS RESTARTS AGEtomcat-test 1/1 Running 0 55s 查看pod的ip和pod调度到哪个节点上12345[root@centos07-12 ~]# kubectl get pods -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESnginx-test-54789c88c6-55t77 1/1 Running 0 19m 10.244.193.136 centos07-22 &lt;none&gt; &lt;none&gt;nginx-test-54789c88c6-s4wtn 1/1 Running 0 22m 10.244.193.134 centos07-22 &lt;none&gt; &lt;none&gt;tomcat-test 1/1 Running 0 83s 10.244.193.137 centos07-22 &lt;none&gt; &lt;none&gt; 查看pod日志12345678[root@centos07-12 ~]# kubectl logs tomcat-test04-Dec-2023 06:34:05.030 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Server version: Apache Tomcat/8.5.3404-Dec-2023 06:34:05.036 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Server built: Sep 4 2018 22:28:22 UTC04-Dec-2023 06:34:05.037 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Server number: 8.5.34.004-Dec-2023 06:34:05.037 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log OS Name: Linux04-Dec-2023 06:34:05.038 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log OS Version: 3.10.0-1160.102.1.el7.x86_6404-Dec-2023 06:34:05.038 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Architecture: amd6404-Dec-2023 06:34:05.038 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Java Home: /usr/lib/jvm/java-1.8-openjdk/jre 进入到刚才创建的pod，刚才创建的pod名字是web12[root@centos07-12 ~]# kubectl exec -it tomcat-test -- /bin/bashbash-4.4# exit 假如pod里有多个容器，进入到pod里的指定容器，按如下命令：12[root@centos07-12 ~]# kubectl exec -it tomcat-test -c tomcat-java -- /bin/bashbash-4.4# exit 查看pod详细信息1234567[root@centos07-12 ~]# kubectl describe pods tomcat-testName: tomcat-testNamespace: defaultPriority: 0Service Account: defaultNode: centos07-22/192.168.1.22Start Time: Mon, 04 Dec 2023 14:34:02 +0800 查看pod具有哪些标签：[root@xianchaomaster1 pod]# kubectl get pods –show-labels 12345[root@centos07-12 ~]# kubectl get pods --show-labelsNAME READY STATUS RESTARTS AGE LABELSnginx-test-54789c88c6-55t77 1/1 Running 0 23m app=nginx,pod-template-hash=54789c88c6nginx-test-54789c88c6-s4wtn 1/1 Running 0 26m app=nginx,pod-template-hash=54789c88c6tomcat-test 1/1 Running 0 5m41s app=tomcat 删除pod12[root@centos07-12 ~]# kubectl delete pods tomcat-testpod &quot;tomcat-test&quot; deleted 或者， 使用创建文件删除，使用控制器生成的pod，也不回再创建1[root@centos07-12 ~]# kubectl delete -f pod-first.yaml 我们上面创建的pod是一个自主式pod，也就是通过pod创建一个应用程序，如果pod出现故障停掉，那么我们通过pod部署的应用也就会停掉，不安全， 还有一种控制器管理的pod，通过控制器创建pod，可以对pod的生命周期做管理，可以定义pod的副本数，如果有一个pod意外停掉，那么会自动起来一个pod替代之前的pod，之后会讲解pod的控制器 Pod资源清单字段解读1234567891011121314apiVersion: v1 #api版本kind: Pod #创建的资源metadata: name: tomcat-test #Pod的名字 namespace: default #Pod所在的名称空间 labels: app: tomcat #Pod具有的标签spec: containers: - name: tomcat-java #Pod里容器的名字 ports: - containerPort: 8080 #容器暴露的端口 image: xianchao/tomcat-8.5-jre8:v1 #容器使用的镜像 imagePullPolicy: IfNotPresent #镜像拉取策略 Pod资源清单编写技巧 通过kubectl explain 查看定义Pod资源包含哪些字段。","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"09-kubeadm安装k8s1.27集群","slug":"运维/K8S/基础/09-kubeadm安装k8s1.27集群","date":"2023-05-05T02:00:50.000Z","updated":"2023-12-05T10:24:35.000Z","comments":true,"path":"2023/05/05/运维/K8S/基础/09-kubeadm安装k8s1.27集群/","link":"","permalink":"https://dbbruce.github.io/2023/05/05/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/09-kubeadm%E5%AE%89%E8%A3%85k8s1.27%E9%9B%86%E7%BE%A4/","excerpt":"k8s环境规划： podSubnet（pod网段） 10.244.0.0&#x2F;16 serviceSubnet（service网段）: 10.96.0.0&#x2F;16 K8S集群角色 ip 主机名 安装组件 控制节点master 192.168.1.12 centos07-12 apiserver、controller-manager、schedule、kubelet、etcd、kube-proxy、容器运行时、calico 工作节点-node 192.168.1.22 centos07-22 Kube-proxy、calico、coredns、容器运行时、kubelet","text":"k8s环境规划： podSubnet（pod网段） 10.244.0.0&#x2F;16 serviceSubnet（service网段）: 10.96.0.0&#x2F;16 K8S集群角色 ip 主机名 安装组件 控制节点master 192.168.1.12 centos07-12 apiserver、controller-manager、schedule、kubelet、etcd、kube-proxy、容器运行时、calico 工作节点-node 192.168.1.22 centos07-22 Kube-proxy、calico、coredns、容器运行时、kubelet 初始化安装k8s集群的实验环境1、修改机器IP，变成静态IP - centos07-12&#x2F;22 注意：&#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-ens33文件里的配置说明：NAME&#x3D;ens33 #网卡名字，跟DEVICE名字保持一致即可DEVICE&#x3D;ens33 #网卡设备名，大家ip addr可看到自己的这个网卡设备名，每个人的机器可能这个名字不一样，需要写自己的BOOTPROTO&#x3D;static #static表示静态ip地址ONBOOT&#x3D;yes #开机自启动网络，必须是yesIPADDR&#x3D;192.168.40.180 #ip地址，需要跟自己电脑所在网段一致NETMASK&#x3D;255.255.255.0 #子网掩码，需要跟自己电脑所在网段一致GATEWAY&#x3D;192.168.40.2 #网关，在自己电脑打开cmd，输入ipconfig &#x2F;all可看到DNS1&#x3D;192.168.40.2 #DNS，在自己电脑打开cmd，输入ipconfig &#x2F;all可看到 修改网卡配置12345678910111213141516171819[root@centos07-12 ~]# vim /etc/sysconfig/network-scripts/ifcfg-enp0s3TYPE=EthernetPROXY_METHOD=noneBROWSER_ONLY=noBOOTPROTO=staticIPADDR=192.168.1.12NETMASK=255.255.255.0GATEWAY=192.168.1.255DNS1=114.114.114.114DEFROUTE=yesIPV4_FAILURE_FATAL=noIPV6INIT=yesIPV6_AUTOCONF=yesIPV6_DEFROUTE=yesIPV6_FAILURE_FATAL=noIPV6_ADDR_GEN_MODE=stable-privacyNAME=enp0s3DEVICE=enp0s3ONBOOT=yes 全部重启12[root@centos07-12 ~]# service network restartRestarting network (via systemctl): [ OK ] 2、关闭selinux - centos07-12&#x2F;22 为什么要关闭selinux？SELinux 是 Linux 系统的一种安全机制，可以限制系统资源（如文件、网络等）的访问，提高系统的安全性。在 Kubernetes 运行过程中，需要访问系统资源，但 SELinux 可能会限制访问，从而影响 Kubernetes 的运行。因此，在安装 Kubernetes 时，需要关闭 SELinux，以避免它对 Kubernetes 的影响。 修改selinux配置文件之后，重启机器，selinux配置才能永久生效1sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config 显示Disabled说明selinux已经关闭123getenforceDisabled 3、配置机器主机名 - centos07-12&#x2F;221hostnamectl set-hostname CentOS07-12 &amp;&amp; bash 4、升级系统,由centos7.6升级到centos7.9 - centos07-12&#x2F;221yum update -y 5、配置主机hosts文件，相互之间通过主机名互相访问 - centos07-12&#x2F;22 修改每台机器的&#x2F;etc&#x2F;hosts文件，增加如下三行1234vim /etc/hosts192.168.1.12 centos07-12192.168.1.22 centos07-22 6、配置主机之间无密码登录 - centos07-12&#x2F;22 生成sshkey，一路回车，不输入密码1ssh-keygen 把本地生成的密钥文件和私钥文件拷贝到远程主机，保证3台机器可以无密登录12ssh-copy-id centos07-12ssh-copy-id centos07-22 7、关闭交换分区swap，提升性能 - centos07-12&#x2F;22 Swap交换分区是一种在计算机中使用的虚拟内存技术。当物理内存不足以容纳当前运行的程序时，操作系统将会把一部分内存空间暂时转移到硬盘上，以便为当前程序提供运行所需的内存空间。这个过程就称为交换。交换分区（Swap Partition）就是硬盘上专门预留给操作系统进行交换的一块空间。交换分区的使用可以有效避免程序因为内存不足而崩溃或运行缓慢的问题，但是硬盘的读写速度比内存要慢得多，因此交换分区的使用会对系统的性能产生一定的影响。当系统内存不足时，会将部分内存数据转移到交换分区中，以释放内存空间。但是，交换分区的读写速度较慢，会影响系统的性能。在 Kubernetes 运行过程中，需要频繁地使用内存和磁盘等系统资源。如果使用了交换分区，会导致 Kubernetes 的运行速度变慢，从而影响整个集群的性能。因此，在安装 Kubernetes 时，通常会建议关闭交换分区。以一个类比的方式来说，就好像开车上高速，如果路况通畅，车速可以很快，但是如果遇到堵车，就会耽误时间。交换分区就像是道路上的堵车，会影响系统的运行速度和效率。因此，为了让 Kubernetes 运行更加高效，通常会建议关闭交换分区。Kubeadm初始化的时候会检测swap是否关闭，如果没关闭，那就初始化失败。如果不想要关闭交换分区，安装k8s的时候可以指定–ignore-preflight-errors&#x3D;Swap来解决。 临时关闭1swapoff -a 永久关闭：注释swap挂载，给swap这行开头加一下注释123vim /etc/fstab# /dev/mapper/centos-swap swap swap defaults 0 0 8、修改机器内核参数 - centos07-12&#x2F;22 sysctl是做什么的？在运行时配置内核参数 -p 从指定的文件加载系统参数，如不指定即从&#x2F;etc&#x2F;sysctl.conf中加载 为什么要执行modprobe br_netfilter 修改&#x2F;etc&#x2F;sysctl.d&#x2F;k8s.conf文件，增加如下三行参数： net.bridge.bridge-nf-call-ip6tables &#x3D; 1 net.bridge.bridge-nf-call-iptables &#x3D; 1 net.ipv4.ip_forward &#x3D; 1 sysctl -p &#x2F;etc&#x2F;sysctl.d&#x2F;k8s.conf出现报错： sysctl: cannot stat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;bridge&#x2F;bridge-nf-call-ip6tables: No such file or directorysysctl: cannot stat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;bridge&#x2F;bridge-nf-call-iptables: No such file or directory 解决方法： modprobe br_netfilter 为什么开启net.bridge.bridge-nf-call-iptables内核参数 在centos下安装docker，执行docker info出现如下警告： WARNING: bridge-nf-call-iptables is disabled WARNING: bridge-nf-call-ip6tables is disabled 解决办法： vim &#x2F;etc&#x2F;sysctl.d&#x2F;k8s.conf net.bridge.bridge-nf-call-ip6tables &#x3D; 1 net.bridge.bridge-nf-call-iptables &#x3D; 1 为什么要开启net.ipv4.ip_forward &#x3D; 1参数kubeadm初始化k8s如果报错： 就表示没有开启ip_forward，需要开启。net.ipv4.ip_forward是数据包转发：出于安全考虑，Linux系统默认是禁止数据包转发的。所谓转发即当主机拥有多于一块的网卡时，其中一块收到数据包，根据数据包的目的ip地址将数据包发往本机另一块网卡，该网卡根据路由表继续发送数据包。这通常是路由器所要实现的功能。要让Linux系统具有路由转发功能，需要配置一个Linux的内核参数net.ipv4.ip_forward。这个参数指定了Linux系统当前对路由转发功能的支持情况；其值为0时表示禁止进行IP转发；如果是1,则说明IP转发功能已经打开。 8.1、加载 modprobe br_netfilter 手动加载模块1234567modprobe br_netfilter# 查看是否加载lsmod|grep br_netfilterbr_netfilter 22256 0bridge 151336 2 br_netfilter,ebtable_broute 自动加载 1echo &quot;modprobe br_netfilter&quot; &gt;&gt; /etc/profile 8.2、配置bridge和forward 这些参数的含义是：net.bridge.bridge-nf-call-ip6tables 和 net.bridge.bridge-nf-call-iptables 参数用于开启 Linux 系统的网络包过滤功能。当 Kubernetes 使用网络插件进行容器之间的通信时，需要通过 Linux 网桥进行数据包的转发和过滤。这些参数可以确保 Linux 系统的网络包过滤功能正常工作，以便 Kubernetes 能够正确地进行网络通信和路由。net.ipv4.ip_forward 参数用于开启 Linux 系统的 IP 转发功能。当 Kubernetes 使用网络插件进行容器之间的通信时，需要通过 Linux 网桥进行数据包的转发和过滤。这个参数可以确保 Linux 系统的 IP 转发功能正常工作，以便 Kubernetes 能够正确地进行网络路由。总的来说，这些命令的作用是确保 Kubernetes 能够正常使用网络功能，并且能够正确地转发和过滤网络数据包。 12345cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt;EOFnet.bridge.bridge-nf-call-ip6tables = 1net.bridge.bridge-nf-call-iptables = 1net.ipv4.ip_forward = 1EOF 8.3、运行配置内核参数1sysctl -p /etc/sysctl.d/k8s.conf 9、关闭firewalld防火墙 - centos07-12&#x2F;221systemctl stop firewalld ; systemctl disable firewalld 10、配置阿里云的repo源 - centos07-12&#x2F;22 安装scp1yum install openssh-clients 备份原有源-可做可不做，也可以使用系统的源123mkdir -p /root/repo.bak/mv /etc/yum.repos.d/* /root/repo.bak/ 下载阿里云的repo源- 可做可不做，也可以使用系统的源123yum install yum-utils -y # 这个就是yum-config-manger工具yum-config-manager --add-repo https://mirrors.aliyun.com/repo/Centos-vault-8.5.2111.repo 配置国内阿里云docker的repo源123yum install yum-utils -y # 这个就是yum-config-manger工具yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo 11、配置安装k8s组件需要的阿里云的repo源 - centos07-12&#x2F;22 其中baseurl是指定仓库的URL地址。在这个例子中，这个仓库是Kubernetes针对CentOS 7 x86_64架构的yum仓库，也就是说，当你在CentOS 7系统上使用yum安装Kubernetes时，yum会从这个指定的URL地址获取Kubernetes的安装包和依赖包，从而进行安装。使用阿里云镜像站可以提高安装速度和稳定性。 1234567vim /etc/yum.repos.d/kubernetes.repo[kubernetes]name=Kubernetesbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/enabled=1gpgcheck=0 12# 可以一个个编辑也可以使用scp同步scp /etc/yum.repos.d/kubernetes.repo centos07-22:/etc/yum.repos.d/ 12、配置时间同步 - centos07-12&#x2F;22 在Kubernetes集群中，建议每台机器的时间尽量保持一致，因为Kubernetes集群的正常运行需要时间同步，否则会出现各种问题。例如，在Kubernetes中使用到了TLS证书，而TLS证书的验证是基于时间戳的，如果节点之间时间不同步，就会导致证书验证失败。另外，Kubernetes中的各种组件之间也需要时间同步，否则可能会出现无法调度Pod、Pod网络异常等问题。 安装ntpdate命令1yum install ntpdate -y 跟网络时间做同步1ntpdate cn.pool.ntp.org 把时间同步做成计划任务123crontab -e* */1 * * * /usr/sbin/ntpdate cn.pool.ntp.org 重启crond服务1service crond restart 13、安装基础软件包 - centos07-12&#x2F;221yum install -y yum-utils device-mapper-persistent-data lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel python-devel epel-release openssh-server socat ipvsadm conntrack ntpdate telnet ipvsadm 安装containerd服务 在 Kubernetes 中，每个节点都需要运行一个容器运行时（containerd），用于管理和运行容器。就像我们在电脑上需要安装一个软件才能打开一个文件一样，在 Kubernetes 中需要安装一个容器运行时才能运行一个容器。Kubernetes 中的容器运行时就像一个保姆一样，它负责管理容器的生命周期和资源隔离，确保容器能够在节点上稳定地运行。其中，containerd 就是一个常用的容器运行时，它实现了 Kubernetes 规定的 CRI 接口，因此可以被 Kubernetes 作为容器运行时来使用。简单来说，就是 Kubernetes 需要容器运行时来管理和运行容器，而 containerd 就是 Kubernetes 中常用的一种容器运行时，能够让 Kubernetes 更加高效、稳定地运行容器化应用。在 Kubernetes 中，当一个 Pod 被创建时，Kubernetes 会根据 Pod 中定义的容器信息，将它们交给容器运行时来创建和运行。 1、安装containerd - centos07-12&#x2F;22 SystemdCgroup &#x3D; false修改成SystemdCgroup &#x3D; true，表示containerd驱动用systemd，在 Kubernetes 中，容器运行时需要与宿主机的 cgroup 和 namespace 进行交互，以管理容器的资源。而对于 cgroup 的驱动程序，Docker 和 Containerd 默认都使用的是 cgroupfs。而 systemd-cgroup 则是 Systemd 对 cgroup 的一个实现。相比 cgroupfs，systemd-cgroup 在资源隔离方面提供了更好的性能和更多的特性。例如，systemd-cgroup 可以使用更多的内存压缩算法，以便更有效地使用内存。此外，systemd-cgroup 还提供了更好的 cgroup 监控和控制机制，可以更精确地调整容器的资源使用量。总之，使用 systemd-cgroup 作为容器运行时的 cgroup 驱动程序，可以提高 Kubernetes 集群中容器的资源管理效率，从而提升整个集群的性能。将sandbox_image设置为阿里云镜像仓库中的pause:3.7，是因为国内的网络可以访问阿里云镜像仓库。在 Kubernetes 中，每个 Pod 中都有一个 pause 容器，这个容器不会运行任何应用，只是简单地 sleep。它的作用是为了保证 Pod 中所有的容器共享同一个网络命名空间和 IPC 命名空间。pause 容器会在 Pod 的初始化过程中首先启动，然后为 Pod 中的其他容器创建对应的网络和 IPC 命名空间，并且在其他容器启动之前保持运行状态，以保证其他容器可以加入到共享的命名空间中。简单来说，pause 容器就是一个占位符，它为 Pod 中的其他容器提供了一个共享的环境，使它们可以共享同一个网络和 IPC 命名空间。这也是 Kubernetes 实现容器间通信和网络隔离的重要机制之一。 1yum install -y containerd.io-1.6.6 2、接下来生成 containerd 的配置文件: - centos07-12&#x2F;2212mkdir -p /etc/containerdcontainerd config default &gt; /etc/containerd/config.toml 3、修改配置文件：- centos07-12&#x2F;22 打开&#x2F;etc&#x2F;containerd&#x2F;config.toml 把 SystemdCgroup &#x3D; false 修改成 SystemdCgroup &#x3D; true 把 sandbox_image &#x3D; “k8s.gcr.io&#x2F;pause:3.6”修改成sandbox_image&#x3D;”registry.aliyuncs.com&#x2F;google_containers&#x2F;pause:3.7” 1234vim /etc/containerd/config.toml 61 sandbox_image = &quot;registry.aliyuncs.com/google_containers/pause:3.7&quot;125 SystemdCgroup = true 4、配置 containerd 开机启动，并启动 containerd - centos07-12&#x2F;22123systemctl enable containerd --nowCreated symlink from /etc/systemd/system/multi-user.target.wants/containerd.service to /usr/lib/systemd/system/containerd.service. 5、查看下containerd状态，error忽略插件没有安装的错误1234567891011121314151617181920212223[root@centos07-12 ~]# systemctl status containerd.service● containerd.service - containerd container runtime Loaded: loaded (/usr/lib/systemd/system/containerd.service; enabled; vendor preset: disabled) Active: active (running) since 六 2023-12-02 22:18:03 CST; 5min ago Docs: https://containerd.io Process: 19116 ExecStartPre=/sbin/modprobe overlay (code=exited, status=0/SUCCESS) Main PID: 19118 (containerd) Tasks: 11 Memory: 26.2M CGroup: /system.slice/containerd.service └─19118 /usr/bin/containerd12月 02 22:18:03 centos07-12 containerd[19118]: time=&quot;2023-12-02T22:18:03.708356738+08:00&quot; level=error msg=&quot;failed to load cni durin...config&quot;12月 02 22:18:03 centos07-12 containerd[19118]: time=&quot;2023-12-02T22:18:03.708787339+08:00&quot; level=info msg=serving... address=/run/co...k.ttrpc12月 02 22:18:03 centos07-12 containerd[19118]: time=&quot;2023-12-02T22:18:03.708834065+08:00&quot; level=info msg=serving... address=/run/co...rd.sock12月 02 22:18:03 centos07-12 containerd[19118]: time=&quot;2023-12-02T22:18:03.708923088+08:00&quot; level=info msg=&quot;containerd successfully b...33763s&quot;12月 02 22:18:03 centos07-12 containerd[19118]: time=&quot;2023-12-02T22:18:03.720490658+08:00&quot; level=info msg=&quot;Start subscribing containerd event&quot;12月 02 22:18:03 centos07-12 containerd[19118]: time=&quot;2023-12-02T22:18:03.721454853+08:00&quot; level=info msg=&quot;Start recovering state&quot;12月 02 22:18:03 centos07-12 containerd[19118]: time=&quot;2023-12-02T22:18:03.721656196+08:00&quot; level=info msg=&quot;Start event monitor&quot;12月 02 22:18:03 centos07-12 containerd[19118]: time=&quot;2023-12-02T22:18:03.721718057+08:00&quot; level=info msg=&quot;Start snapshots syncer&quot;12月 02 22:18:03 centos07-12 containerd[19118]: time=&quot;2023-12-02T22:18:03.721754086+08:00&quot; level=info msg=&quot;Start cni network conf sy...efault&quot;12月 02 22:18:03 centos07-12 containerd[19118]: time=&quot;2023-12-02T22:18:03.721764670+08:00&quot; level=info msg=&quot;Start streaming server&quot;Hint: Some lines were ellipsized, use -l to show in full. 6、修改&#x2F;etc&#x2F;crictl.yaml文件 - centos07-12&#x2F;22 这个文件是 crictl 工具的配置文件，用于指定与 containerd 交互的相关设置：指定unix:&#x2F;&#x2F;&#x2F;run&#x2F;containerd&#x2F;containerd.sock 是为了告诉 crictl 使用 Unix 域套接字的方式来连接 containerd 的 API。containerd 提供了一个 socket 文件 &#x2F;run&#x2F;containerd&#x2F;containerd.sock，crictl 通过连接该 socket 文件，可以与 containerd 进行通信，管理容器和镜像等操作。1）runtime-endpoint：指定 containerd 的运行时接口地址，以便 crictl 可以与 containerd 通信来管理容器生命周期和资源隔离。2）image-endpoint：指定 containerd 的镜像接口地址，以便 crictl 可以与 containerd 通信来管理镜像的拉取和推送。3）timeout：指定 crictl 等待 containerd 响应的最大时间，避免出现无响应的情况。4）debug：开启或关闭 crictl 的调试模式，方便排查问题。 123456cat &gt; /etc/crictl.yaml &lt;&lt;EOFruntime-endpoint: unix:///run/containerd/containerd.sockimage-endpoint: unix:///run/containerd/containerd.socktimeout: 10debug: falseEOF 重启containerd： 1systemctl restart containerd 7、配置containerd镜像加速器，k8s所有节点均按照以下配置 - centos07-12&#x2F;22 使用containerd下载镜像的命令：ctr images pull编辑vim &#x2F;etc&#x2F;containerd&#x2F;config.toml文件找到config_path &#x3D; “”，修改成如下目录：config_path &#x3D; “&#x2F;etc&#x2F;containerd&#x2F;certs.d”保存退出 123vim /etc/containerd/config.toml145 config_path = &quot;/etc/containerd/certs.d&quot; 123456mkdir /etc/containerd/certs.d/docker.io/ -pvim /etc/containerd/certs.d/docker.io/hosts.toml#写入如下内容：[host.&quot;https://vh3bm52y.mirror.aliyuncs.com&quot;,host.&quot;https://registry.docker-cn.com&quot;]capabilities = [&quot;pull&quot;] 重启containerd： 1systemctl restart containerd 8、备注：docker也要安装，docker跟containerd不冲突，安装docker是为了能基于dockerfile构建镜像 - centos07-12&#x2F;22123yum install docker-ce -ysystemctl enable docker --now 9、配置docker镜像加速器，k8s所有节点均按照以下配置 - centos07-12&#x2F;221234567vim /etc/docker/daemon.json# 写入如下内容：&#123;&quot;registry-mirrors&quot;:[&quot;https://vh3bm52y.mirror.aliyuncs.com&quot;,&quot;https://registry.docker-cn.com&quot;,&quot;https://docker.mirrors.ustc.edu.cn&quot;,&quot;https://dockerhub.azk8s.cn&quot;,&quot;http://hub-mirror.c.163.com&quot;]&#125; 10、重启docker： - centos07-12&#x2F;221systemctl restart docker 12345678910111213141516171819202122[root@centos07-12 ~]# systemctl status docker● docker.service - Docker Application Container Engine Loaded: loaded (/usr/lib/systemd/system/docker.service; enabled; vendor preset: disabled) Active: active (running) since 六 2023-12-02 23:02:44 CST; 40s ago Docs: https://docs.docker.com Main PID: 19676 (dockerd) Tasks: 10 Memory: 33.3M CGroup: /system.slice/docker.service └─19676 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock12月 02 23:02:43 centos07-12 systemd[1]: Starting Docker Application Container Engine...12月 02 23:02:44 centos07-12 dockerd[19676]: time=&quot;2023-12-02T23:02:43.998989452+08:00&quot; level=info msg=&quot;Starting up&quot;12月 02 23:02:44 centos07-12 dockerd[19676]: time=&quot;2023-12-02T23:02:44.043889058+08:00&quot; level=info msg=&quot;[graphdriver] using prior st...erlay2&quot;12月 02 23:02:44 centos07-12 dockerd[19676]: time=&quot;2023-12-02T23:02:44.044231701+08:00&quot; level=info msg=&quot;Loading containers: start.&quot;12月 02 23:02:44 centos07-12 dockerd[19676]: time=&quot;2023-12-02T23:02:44.197828934+08:00&quot; level=info msg=&quot;Default bridge (docker0) is ...ddress&quot;12月 02 23:02:44 centos07-12 dockerd[19676]: time=&quot;2023-12-02T23:02:44.283541801+08:00&quot; level=info msg=&quot;Loading containers: done.&quot;12月 02 23:02:44 centos07-12 dockerd[19676]: time=&quot;2023-12-02T23:02:44.308745561+08:00&quot; level=info msg=&quot;Docker daemon&quot; commit=311b9f...=24.0.712月 02 23:02:44 centos07-12 dockerd[19676]: time=&quot;2023-12-02T23:02:44.308876736+08:00&quot; level=info msg=&quot;Daemon has completed initialization&quot;12月 02 23:02:44 centos07-12 dockerd[19676]: time=&quot;2023-12-02T23:02:44.356983479+08:00&quot; level=info msg=&quot;API listen on /run/docker.sock&quot;12月 02 23:02:44 centos07-12 systemd[1]: Started Docker Application Container Engine.Hint: Some lines were ellipsized, use -l to show in full. 11、安装初始化k8s需要的软件包 - centos07-12&#x2F;22123yum install -y kubelet-1.27.0 kubeadm-1.27.0 kubectl-1.27.0systemctl enable kubelet 注：每个软件包的作用Kubeadm: kubeadm是一个工具，用来初始化k8s集群的kubelet: 安装在集群所有节点上，用于启动Pod的，kubeadm安装k8s，k8s控制节点和工作节点的组件，都是基于pod运行的，只要pod启动，就需要kubeletkubectl: 通过kubectl可以部署和管理应用，查看各种资源，创建、删除和更新各种组件 12、kubeadm初始化k8s集群 - centos07-12&#x2F;221、设置容器运行时 - centos07-12&#x2F;22 设置容器后，crictl看到的都是containerd的容器 123crictl config runtime-endpoint unix:///run/containerd/containerd.sockcrictl ps 2、使用kubeadm初始化k8s集群 - centos07-121kubeadm config print init-defaults &gt; kubeadm.yaml 3、根据我们自己的需求修改配置 - centos07-12 修改kubeadm.yaml配置文件如下:advertiseAddress: 192.168.40.180 # 控制节点的icriSocket: unix:&#x2F;&#x2F;&#x2F;run&#x2F;containerd&#x2F;containerd.sock #指定containerd容器运行时name: centos07-12 #控制节点主机名imageRepository: registry.cn-hangzhou.aliyuncs.com&#x2F;google_containers # 指定阿里云镜像仓库地址kubernetesVersion: 1.27.0 #k8s版本，这里要是kubeadm,kubelet,kubectl版本一致podSubnet: 10.244.0.0&#x2F;16 #指定pod网段， 需要新增加这serviceSubnet: 10.96.0.0&#x2F;12 #指定Service网段#在文件最后，插入以下内容，（复制时，要带着—）： 12345678---apiVersion: kubeproxy.config.k8s.io/v1alpha1kind: KubeProxyConfigurationmode: ipvs---apiVersion: kubelet.config.k8s.io/v1beta1kind: KubeletConfigurationcgroupDriver: systemd 12345678910111213141516171819vim kubeadm.yaml 12 advertiseAddress: 192.168.1.12 15 criSocket: unix:///run/containerd/containerd.sock 17 name: centos07-12 30 imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers 32 kubernetesVersion: 1.27.0 35 serviceSubnet: 10.96.0.0/12 36 podSubnet: 10.244.0.0/16 # 在servicesubnet下插入#在文件最后，插入以下内容，（复制时，要带着---）：---apiVersion: kubeproxy.config.k8s.io/v1alpha1kind: KubeProxyConfigurationmode: ipvs---apiVersion: kubelet.config.k8s.io/v1beta1kind: KubeletConfigurationcgroupDriver: systemd 备注，kubeadm.yaml文件参数解释：1、localAPIEndpoint: Kubernetes API Server 监听的地址和端口。advertiseAddress: 指定控制节点的 IP 地址，即 API Server 暴露给集群内其他节点的地址。bindPort: 指定 API Server 监听的端口，默认为 6443。nodeRegistration: 控制节点的注册信息。criSocket: 指定容器运行时使用的 CRI Socket，即容器与 Kubernetes API Server 之间的通信通道。这里指定为 Containerd 的 Socket 地址。imagePullPolicy: 指定容器镜像拉取策略，这里指定为如果本地已有镜像则不拉取。name: 控制节点的名称，主机名taints: 控制节点的 taints，即节点的标记，用于限制哪些 Pod 可以调度到该节点。这里指定为空，即不对 Pod 的调度进行限制。2、podSubnet: 10.244.0.0&#x2F;16 #指定pod网段， 需要新增加这个serviceSubnet: 10.96.0.0&#x2F;12 #指定Service网段在Kubernetes集群中，每个Pod都会被分配一个IP地址，这些IP地址需要从一个预定义的IP地址池中分配。 podSubnet参数用于指定Pod IP地址池的范围，它定义了Pod的IP地址范围，例如10.244.0.0&#x2F;16表示IP地址从10.244.0.1到10.244.255.255。同样地，Kubernetes服务（Service）也会被分配一个IP地址，用于暴露Kubernetes服务的端口。 serviceSubnet参数用于指定Service IP地址池的范围，它定义了Service的IP地址范围，例如10.96.0.0&#x2F;12表示IP地址从10.96.0.1到10.111.255.255。3、mode: ipvs 表示kube-proxy代理模式是ipvs，如果不指定ipvs，会默认使用iptables，开启IPVS可以提高Kubernetes集群的性能和可靠性。IPVS是一个高性能的负载均衡器，与Kubernetes Service一起使用，可以在Pod之间分配负载。相比于Kubernetes自带的iptables模式，IPVS模式在处理大量流量时具有更好的性能和可靠性。此外，IPVS还支持四层和七层协议的负载均衡，能够满足更多的应用场景需求。因此，在安装Kubernetes集群时，建议开启IPVS以提高集群性能和可靠性。 4、基于kubeadm.yaml初始化k8s集群master - centos07-12 查看镜像，可以看到可以查询到了： crictl images &#x3D;&#x3D;&#x3D; ctr -n&#x3D;k8s.io images lsctr是containerd自带的工具，有命名空间的概念，若是k8s相关的镜像，都默认在k8s.io这个命名空间，所以导入镜像时需要指定命令空间为k8s.io使用ctr命令指定命名空间导入镜像:ctr -n&#x3D;k8s.io images import k8s_1.27.0.tar.gz备注：k8s_1.27.0.tar.gz这个文件如何来的？这个文件把安装k8s需要的镜像都集成好了，这个是我第一次安装1.27.0这个版本，获取到对应的镜像，通过ctr images export 这个命令把镜像输出到k8s_1.27.0.tar.gz文件，如果大家安装其他版本，那就不需要实现解压镜像，可以默认从网络拉取镜像即可。–ignore-preflight-errors&#x3D;SystemVerification 解决 centos把configs模块找不到的问题 在线方式安装，通过在线下载组件安装K8s - centos07-121kubeadm init --config=kubeadm.yaml --ignore-preflight-errors=SystemVerification 查看下载的镜像列表12345678910[root@centos07-12 ~]# crictl imagesIMAGE TAG IMAGE ID SIZEregistry.aliyuncs.com/google_containers/pause 3.7 221177c6082a8 311kBregistry.cn-hangzhou.aliyuncs.com/google_containers/coredns v1.10.1 ead0a4a53df89 16.2MBregistry.cn-hangzhou.aliyuncs.com/google_containers/etcd 3.5.7-0 86b6af7dd652c 102MBregistry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver v1.27.0 6f707f569b572 33.4MBregistry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager v1.27.0 95fe52ed44570 31MBregistry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy v1.27.0 5f82fc39fa816 23.9MBregistry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler v1.27.0 f73f1b39c3fe8 18.2MBregistry.cn-hangzhou.aliyuncs.com/google_containers/pause 3.9 e6f1816883972 322kB 导入包方式安装，通过导入已经镜像包安装 - centos07-12 导出镜像1ctr -n=k8s.io images export k8s_1.27.0.tar.gz registry.aliyuncs.com/google_containers/pause:3.7 registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.9.3 registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.6-0 registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.27.0 registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.27.0 registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.27.0 registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.27.0 registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.9 1234[root@centos07-12 ~]# ctr -n=k8s.io images export k8s_1.27.0.tar.gz registry.aliyuncs.com/google_containers/pause:3.7 registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.9.3 registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.6-0 registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.27.0 registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.27.0 registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.27.0 registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.27.0 registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.9[root@centos07-12 ~]# ll总用量 215692-rw-r--r-- 1 root root 220858880 12月 3 07:13 k8s_1.27.0.tar.gz 导入镜像1ctr -n=k8s.io images import k8s_1.27.0.tar.gz 5、配置kubectl的配置文件config，相当于对kubectl进行授权，这样kubectl命令可以使用这个证书对k8s集群进行管理- centos07-12123mkdir -p $HOME/.kubesudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/configsudo chown $(id -u):$(id -g) $HOME/.kube/config 配置后就可以看到节点了 1234kubectl get nodesNAME STATUS ROLES AGE VERSIONcentos07-12 NotReady control-plane 21m v1.27.0 查看配置文件&#x3D;kubectl config view 123456789101112131415161718192021[root@centos07-12 ~]# kubectl config viewapiVersion: v1clusters:- cluster: certificate-authority-data: DATA+OMITTED server: https://192.168.1.12:6443 name: kubernetescontexts:- context: cluster: kubernetes user: kubernetes-admin name: kubernetes-admin@kubernetescurrent-context: kubernetes-admin@kuberneteskind: Configpreferences: &#123;&#125;users:- name: kubernetes-admin user: client-certificate-data: DATA+OMITTED client-key-data: DATA+OMITTED 特别提醒：–image-repository registry.aliyuncs.com&#x2F;google_containers为保证拉取镜像不到国外站点拉取，手动指定仓库地址为registry.aliyuncs.com&#x2F;google_containers。kubeadm默认从k8s.gcr.io拉取镜像。 我们本地有导入到的离线镜像，所以会优先使用本地的镜像。 mode: ipvs 表示kube-proxy代理模式是ipvs，如果不指定ipvs，会默认使用iptables，但是iptables效率低，所以我们生产环境建议开启ipvs，阿里云和华为云托管的K8s，也提供ipvs模式，如下： 6、查看控制节点上启动了哪些pod - centos07-12 kubectl get pods -n kube-system -owide 123456789[root@centos07-12 ~]# kubectl get pods -n kube-system -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATEScoredns-65dcc469f7-4twqh 0/1 Pending 0 11m &lt;none&gt; &lt;none&gt; &lt;none&gt; &lt;none&gt;coredns-65dcc469f7-ltfc4 0/1 Pending 0 11m &lt;none&gt; &lt;none&gt; &lt;none&gt; &lt;none&gt;etcd-centos07-12 1/1 Running 0 11m 192.168.1.12 centos07-12 &lt;none&gt; &lt;none&gt;kube-apiserver-centos07-12 1/1 Running 0 11m 192.168.1.12 centos07-12 &lt;none&gt; &lt;none&gt;kube-controller-manager-centos07-12 1/1 Running 0 11m 192.168.1.12 centos07-12 &lt;none&gt; &lt;none&gt;kube-proxy-xmkn4 1/1 Running 0 11m 192.168.1.12 centos07-12 &lt;none&gt; &lt;none&gt;kube-scheduler-centos07-12 1/1 Running 0 11m 192.168.1.12 centos07-12 &lt;none&gt; &lt;none&gt; 扩容k8s集群-添加第一个工作节点1、在centos07-12上查看加入节点的命令 - centos07-12 kubeadm token create - -print-join-command 123[root@centos07-12 ~]# kubeadm token create - -print-join-commandkubeadm join 192.168.1.12:6443 --token 962xbf.hd3ydqqnbfsfs7qa --discovery-token-ca-cert-hash sha256:c6f09852bdb4dab2b4d70cb8eae9fbbd8a3219147834b1ad6a0ba99c0f825d7b 2、把centos07-22加入k8s集群 - centos07-221kubeadm join 192.168.1.12:6443 --token 962xbf.hd3ydqqnbfsfs7qa --discovery-token-ca-cert-hash sha256:c6f09852bdb4dab2b4d70cb8eae9fbbd8a3219147834b1ad6a0ba99c0f825d7b --ignore-preflight-errors=SystemVerification 1234567891011121314[root@centos07-22 ~]# kubeadm join 192.168.1.12:6443 --token 962xbf.hd3ydqqnbfsfs7qa --discovery-token-ca-cert-hash sha256:c6f09852bdb4dab2b4d70cb8eae9fbbd8a3219147834b1ad6a0ba99c0f825d7b --ignore-preflight-errors=SystemVerification[preflight] Running pre-flight checks[preflight] Reading configuration from the cluster...[preflight] FYI: You can look at this config file with &#x27;kubectl -n kube-system get cm kubeadm-config -o yaml&#x27;[kubelet-start] Writing kubelet configuration to file &quot;/var/lib/kubelet/config.yaml&quot;[kubelet-start] Writing kubelet environment file with flags to file &quot;/var/lib/kubelet/kubeadm-flags.env&quot;[kubelet-start] Starting the kubelet[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...This node has joined the cluster:* Certificate signing request was sent to apiserver and a response was received.* The Kubelet was informed of the new secure connection details.Run &#x27;kubectl get nodes&#x27; on the control-plane to see this node join the cluster. 3、看到上面说明centos07-12节点已经加入到集群了,充当工作节点 - centos07-1212345kubectl get nodesNAME STATUS ROLES AGE VERSIONcentos07-12 NotReady control-plane 15m v1.27.0centos07-22 NotReady &lt;none&gt; 36s v1.27.0 4、可以对centos07-22打个标签，显示work - centos07-121kubectl label nodes centos07-22 node-role.kubernetes.io/work=work 1234567root@centos07-12 ~]# kubectl label nodes centos07-22 node-role.kubernetes.io/work=worknode/centos07-22 labeled[root@centos07-12 ~]# kubectl get nodesNAME STATUS ROLES AGE VERSIONcentos07-12 NotReady control-plane 43m v1.27.0centos07-22 NotReady work 5m41s v1.27.0 安装kubernetes网络组件-Calico 注：官方提供的文件地址，下载后需要自己修改： https://docs.projectcalico.org/manifests/calico.yaml Calico是一个开源的网络和安全解决方案，它为容器、虚拟机、主机、k8s提供了高效、可扩展和安全的网络连接和策略管理。 Calico在K8s中的功能：1）支持网络隔离和多租户场景；2）为pod提供独立的IP地址；3）支持跨主机的容器通信，pod可以通过IP地址直接互相访问；4）提供网络安全策略，支持网络流量控制和访问授权，实现网络安全隔离。 Calico优点：1、网络性能高：Calico 使用 Linux 内核中的路由和过滤技术，避免了 NAT，因此可以提供更好的网络性能和更低的延迟。2、高可用性：Calico 的组件可以配置为高可用模式，从而保证集群的稳定性和可用性。3、安全：Calico 可以提供高级的安全策略和访问控制，以保护 Kubernetes 集群中的容器和服务。4、灵活性：Calico 的网络架构非常灵活，可以适应不同的应用场景和需求，支持不同的拓扑结构和部署模式。5、社区活跃：Calico 是一个开源项目，拥有庞大的社区支持和活跃的开发者社区，可以获得及时的技术支持和更新。 在k8s集群，常见的网络插件对比分析：1、Flannel：是一个轻量级的 CNI 插件，使用 VXLAN 技术来实现网络的通信和隔离，适用于小规模集群。它使用iptables来实现NAT，支持多种后端存储，包括 etcd、consul、zookeeper等。2、Calico：是一个完全基于BGP协议的CNI插件，可以实现高性能和高扩展性的网络功能。Calico使用了IPIP、BGP和VXLAN技术，可以轻松扩展网络规模。它还支持网络安全策略、网络流量策略和网络监控等功能。3、Weave Net：是一个简单易用的CNI插件，使用虚拟路由和Overlay网络实现容器之间的通信和隔离。它提供了一种快速、可靠和可扩展的解决方案，并支持多云环境。4、Cilium：是一个支持L3、L4和L7网络安全的CNI插件，具有网络和安全功能集成，使用eBPF技术，可以实现更好的性能和可观测性。 对于小规模的Kubernetes集群，Flannel和Weave Net比较适合，而对于大规模的集群，Calico、Cilium则是一个更好的选择。 删除，kubectl delete -f calico.yaml (如果上传镜像，就不在网络下载了，直接从本地安装了)把安装calico需要的镜像calico.tar.gz传到centos07-12和centos07-22节点，手动解压： - centos07-12&#x2F;221ctr -n=k8s.io images import calico.tar.gz 注意服务器多网卡，需要指定网卡。 1234vim calico.yaml3648 - name: IP_AUTODETECTION_METHOD3649 value: &quot;interface=enp0s3&quot; 在安装 Calico 网络插件时，指定 IP_AUTODETECTION_METHOD 环境变量是为了确保该插件能够在正确的网络接口上自动检测 Pod IP 地址。这个环境变量的值 “interface&#x3D;ens33” 指定了 Calico 插件使用 ens33 接口来分配 IP 地址给 Kubernetes Pod，而不是使用默认的自动检测方式。通常情况下，Kubernetes Pod 中容器的 IP 地址是由容器运行时（如 Docker 或 CRI-O）自动分配的。但是，对于某些网络插件（如 Calico）来说，为了能够正确地配置网络，需要手动指定使用哪个网络接口来自动检测 Pod IP 地址。因此，在安装 Calico 网络插件时，需要通过 IP_AUTODETECTION_METHOD 环境变量来指定使用 ens33 接口来分配 IP 地址给 Kubernetes Pod。这样可以确保 Calico 插件能够正确地配置 Pod 网络。 安装calico1kubectl apply -f calico.yaml node的状态pending变为ready123456kubectl get nodeNAME STATUS ROLES AGE VERSIONcentos07-12 Ready control-plane 67m v1.27.0centos07-22 Ready work 29m v1.27.0[root@centos07-12 ~]# pod， 状态都变成Running，ready变为1&#x2F;1;1234567891011121314kubectl get pod -n kube-systemNAME READY STATUS RESTARTS AGEcalico-kube-controllers-75c9ddd877-86xrx 1/1 Running 0 16mcalico-node-d7cqt 1/1 Running 1 (5m58s ago) 16mcalico-node-sn4cb 1/1 Running 1 (5m29s ago) 16mcoredns-65dcc469f7-4twqh 1/1 Running 1 (5m29s ago) 52mcoredns-65dcc469f7-ltfc4 1/1 Running 6 (5m29s ago) 52metcd-centos07-12 1/1 Running 1 (5m29s ago) 52mkube-apiserver-centos07-12 1/1 Running 1 (5m29s ago) 52mkube-controller-manager-centos07-12 1/1 Running 1 (5m29s ago) 52mkube-proxy-cznxr 1/1 Running 1 (5m58s ago) 37mkube-proxy-xmkn4 1/1 Running 1 (5m29s ago) 52mkube-scheduler-centos07-12 1/1 Running 1 (5m29s ago) 52m 查看日志1kubectl logs calico-node-f7pbl -n kube-system 显示一个或多个资源的详细状态，默认情况下包括未初始化的资源。1kubectl describe pods calico-kube-controllers-75c9ddd877-86xrx -n kube-system Calico架构图 Calico网络模型主要工作组件：1.Felix：运行在每一台 Host 的 agent 进程，主要负责网络接口管理和监听、路由、ARP 管理、ACL 管理和同步、状态上报等。保证跨主机容器网络互通。2.etcd：分布式键值存储，相当于k8s集群中的数据库，存储着Calico网络模型中IP地址等相关信息。主要负责网络元数据一致性，确保 Calico 网络状态的准确性；3.BGP Client（BIRD）：Calico 为每一台 Host 部署一个 BGP Client，即每台host上部署一个BIRD。 主要负责把 Felix 写入 Kernel 的路由信息分发到当前 Calico 网络，确保 Workload 间的通信的有效性；4.BGP Route Reflector：在大型网络规模中，如果仅仅使用 BGP client 形成 mesh 全网互联的方案就会导致规模限制，因为所有节点之间俩俩互联，需要 N^2 个连接，为了解决这个规模问题，可以采用 BGP 的 Router Reflector 的方法，通过一个或者多个 BGP Route Reflector 来完成集中式的路由分发。 1、Daemonset配置 ……containers: # Runs calico-node container on each Kubernetes node. This # container programs network policy and routes on each # host. - name: calico-node image: docker.io&#x2F;calico&#x2F;node:v3.18.0….. env: # Use Kubernetes API as the backing datastore. - name: DATASTORE_TYPE value: “kubernetes” # Cluster type to identify the deployment type - name: CLUSTER_TYPE value: “k8s,bgp” # Auto-detect the BGP IP address. - name: IP value: “autodetect” #pod网段 - name: CALICO_IPV4POOL_CIDR value: “10.244.0.0&#x2F;16” # Enable IPIP - name: CALICO_IPV4POOL_IPIP value: “Always” calico-node服务的主要参数如下:CALICO_IPV4POOL_IPIP：是否启用IPIP模式。启用IPIP模式时，Calico将在Node上创建一个名为tunl0的虚拟隧道。IP Pool可以使用两种模式：BGP或IPIP。使用IPIP模式时，设置CALICO_IPV4POOL_IPIP&#x3D;”Always”，不使用IPIP模式时，设置CALICO_IPV4POOL_IPIP&#x3D;”Off”，此时将使用BGP模式。IP_AUTODETECTION_METHOD：获取Node IP地址的方式，默认使用第1个网络接口的IP地址，对于安装了多块网卡的Node，可以使用正则表达式选择正确的网卡，例如”interface&#x3D;eth.*”表示选择名称以eth开头的网卡的IP地址。- name: IP_AUTODETECTION_METHOD value: “interface&#x3D;enp0s3” 扩展：calico的IPIP模式和BGP模式对比分析1）IPIP把一个IP数据包又套在一个IP包里，即把IP层封装到IP层的一个 tunnel，它的作用其实基本上就相当于一个基于IP层的网桥，一般来说，普通的网桥是基于mac层的，根本不需要IP，而这个ipip则是通过两端的路由做一个tunnel，把两个本来不通的网络通过点对点连接起来；calico以ipip模式部署完毕后，node上会有一个tunl0的网卡设备，这是ipip做隧道封装用的,也是一种overlay模式的网络。当我们把节点下线，calico容器都停止后，这个设备依然还在，执行 rmmodipip命令可以将它删除。2）BGPBGP模式直接使用物理机作为虚拟路由路（vRouter），不再创建额外的tunnel边界网关协议（BorderGateway Protocol, BGP）是互联网上一个核心的去中心化的自治路由协议。它通过维护IP路由表或‘前缀’表来实现自治系统（AS）之间的可达性，属于矢量路由协议。BGP不使用传统的内部网关协议（IGP）的指标，而是基于路径、网络策略或规则集来决定路由。因此，它更适合被称为矢量性协议，而不是路由协议，通俗的说就是将接入到机房的多条线路（如电信、联通、移动等）融合为一体，实现多线单IP；BGP 机房的优点：服务器只需要设置一个IP地址，最佳访问路由是由网络上的骨干路由器根据路由跳数与其它技术指标来确定的，不会占用服务器的任何系统；官方提供的calico.yaml模板里，默认打开了ip-ip功能，该功能会在node上创建一个设备tunl0，容器的网络数据会经过该设备被封装一个ip头再转发。这里，calico.yaml中通过修改calico-node的环境变量：CALICO_IPV4POOL_IPIP来实现ipip功能的开关：默认是Always，表示开启；Off表示关闭ipip。- name: CLUSTER_TYPE value: “k8s,bgp” # Auto-detect the BGP IP address.- name: IP value: “autodetect” # Enable IPIP- name: CALICO_IPV4POOL_IPIP value: “Always” 总结：calico BGP通信是基于TCP协议的，所以只要节点间三层互通即可完成，即三层互通的环境bird就能生成与邻居有关的路由。但是这些路由和flannel host-gateway模式一样，需要二层互通才能访问的通，因此如果在实际环境中配置了BGP模式生成了路由但是不同节点间pod访问不通，可能需要再确认下节点间是否二层互通。为了解决节点间二层不通场景下的跨节点通信问题，calico也有自己的解决方案——IPIP模式 9、测试在k8s创建pod是否可以正常访问网络，镜像放在node上，在master上执行命令 注意：把busybox-1-28.tar.gz上传到centos07-22 手动解压1scp busybox-1-28.tar.gz root@192.168.1.22:~ 12# centos07-22ctr -n k8s.io images import busybox-1-28.tar.gz 12[root@centos07-22 ~]# crictl images |grep busyboxdocker.io/library/busybox 1.28 8c811b4aec35f 1.36MB 在控制节点-centos07-121kubectl run busybox --image docker.io/library/busybox:1.28 --image-pull-policy=IfNotPresent --restart=Never --rm -it busybox -- sh 1234567891011# 通过下面可以看到能访问网络，说明calico网络插件已经被正常安装了[root@centos07-12 ~]# kubectl run busybox --image docker.io/library/busybox:1.28 --image-pull-policy=IfNotPresent --restart=Never --rm -it busybox -- shIf you don&#x27;t see a command prompt, try pressing enter./ # ping www.baidu.comPING www.baidu.com (39.156.66.14): 56 data bytes64 bytes from 39.156.66.14: seq=0 ttl=61 time=7.727 ms64 bytes from 39.156.66.14: seq=1 ttl=61 time=8.951 ms--- www.baidu.com ping statistics ---2 packets transmitted, 2 packets received, 0% packet lossround-trip min/avg/max = 7.727/8.339/8.951 ms 10、测试coredns是否正常 - centos07-12 0.96.0.10 就是我们coreDNS的clusterIP，说明coreDNS配置好了。解析内部Service的名称，是通过coreDNS去解析的。 12345678[root@centos07-12 ~]# kubectl run busybox --image docker.io/library/busybox:1.28 --image-pull-policy=IfNotPresent --restart=Never --rm -it busybox -- shIf you don&#x27;t see a command prompt, try pressing enter./ # nslookup kubernetes.default.svc.cluster.localServer: 10.96.0.10Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.localName: kubernetes.default.svc.cluster.localAddress 1: 10.96.0.1 kubernetes.default.svc.cluster.local 注意:busybox要用指定的1.28版本，不能用最新版本，最新版本，nslookup会解析不到dns和ip 11、kubeadm初始化k8s证书过期解决方案 - centos07-12 注意：更新证书或重启组件，会影响业务，最好先更新 查看证书有效时间：12openssl x509 -in /etc/kubernetes/pki/ca.crt -noout -text |grep Notopenssl x509 -in /etc/kubernetes/pki/apiserver.crt -noout -text |grep Not 12345678# 10年ca.crt[root@centos07-12 ~]# openssl x509 -in /etc/kubernetes/pki/ca.crt -noout -text |grep Not Not Before: Nov 30 08:09:20 2023 GMT Not After : Nov 27 08:09:20 2033 GMT# 1年apiserver.crt[root@centos07-12 ~]# openssl x509 -in /etc/kubernetes/pki/apiserver.crt -noout -text |grep Not Not Before: Nov 30 08:09:20 2023 GMT Not After : Nov 29 08:09:21 2024 GMT 延长证书过期时间 1.把update-kubeadm-cert.sh文件上传到centos07-12节点 1scp update-kubeadm-cert.sh root@192.168.1.12:~ 2.在centos07-12上执行如下： 1）给update-kubeadm-cert.sh证书授权可执行权限1chmod +x update-kubeadm-cert.sh 2）执行下面命令，修改证书过期时间，把时间延长到10年1./update-kubeadm-cert.sh all 3）在centos07-12节点查询Pod是否正常,能查询出数据说明证书签发完成1kubectl get pods -n kube-system 4）再次查看证书有效期，可以看到会延长到10年1234567[root@centos07-12 ~]# openssl x509 -in /etc/kubernetes/pki/ca.crt -noout -text |grep Not Not Before: Nov 30 08:09:20 2023 GMT Not After : Nov 27 08:09:20 2033 GMT [root@centos07-12 ~]# openssl x509 -in /etc/kubernetes/pki/apiserver.crt -noout -text |grep Not Not Before: Nov 30 11:13:01 2023 GMT Not After : Nov 27 11:13:01 2033 GMT","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"08-k8s节点删除","slug":"运维/K8S/基础/08-k8s节点删除","date":"2023-05-04T12:00:50.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2023/05/04/运维/K8S/基础/08-k8s节点删除/","link":"","permalink":"https://dbbruce.github.io/2023/05/04/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/08-k8s%E8%8A%82%E7%82%B9%E5%88%A0%E9%99%A4/","excerpt":"12345kubectl get nodeNAME STATUS ROLES AGE VERSIONcentos07-12 Ready control-plane 158m v1.26.0centos07-22 Ready work 121m v1.26.0 1.设置该节点为不可调度状态1kubectl cordon centos07-22 2.驱逐该节点上的pod1kubectl drain centos07-22 --ignore-daemonsets --delete-local-data 若是有pod删除不掉则加上–force参数强制驱逐 3.从集群中删除该node节点1kubectl delete node centos07-22","text":"12345kubectl get nodeNAME STATUS ROLES AGE VERSIONcentos07-12 Ready control-plane 158m v1.26.0centos07-22 Ready work 121m v1.26.0 1.设置该节点为不可调度状态1kubectl cordon centos07-22 2.驱逐该节点上的pod1kubectl drain centos07-22 --ignore-daemonsets --delete-local-data 若是有pod删除不掉则加上–force参数强制驱逐 3.从集群中删除该node节点1kubectl delete node centos07-22 4.在centos07-22节点上执行以下命令删除所有数据(以上命令都是在控制节点执行)1kubeadm reset 5.查看1234kubectl get nodeNAME STATUS ROLES AGE VERSIONcentos07-12 Ready control-plane 161m v1.26.0","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"07-扩容k8s集群，添加第二个控制节点","slug":"运维/K8S/基础/07-扩容k8s集群，添加第二个控制节点","date":"2023-05-04T02:00:50.000Z","updated":"2023-12-05T10:24:35.000Z","comments":true,"path":"2023/05/04/运维/K8S/基础/07-扩容k8s集群，添加第二个控制节点/","link":"","permalink":"https://dbbruce.github.io/2023/05/04/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/07-%E6%89%A9%E5%AE%B9k8s%E9%9B%86%E7%BE%A4%EF%BC%8C%E6%B7%BB%E5%8A%A0%E7%AC%AC%E4%BA%8C%E4%B8%AA%E6%8E%A7%E5%88%B6%E8%8A%82%E7%82%B9/","excerpt":"启动一台新的机器centos-22初始化安装k8s集群的实验环境1、修改机器IP，变成静态IP - centos07-22 注意：&#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-ens33文件里的配置说明：NAME&#x3D;ens33 #网卡名字，跟DEVICE名字保持一致即可DEVICE&#x3D;ens33 #网卡设备名，大家ip addr可看到自己的这个网卡设备名，每个人的机器可能这个名字不一样，需要写自己的BOOTPROTO&#x3D;static #static表示静态ip地址ONBOOT&#x3D;yes #开机自启动网络，必须是yesIPADDR&#x3D;192.168.40.180 #ip地址，需要跟自己电脑所在网段一致NETMASK&#x3D;255.255.255.0 #子网掩码，需要跟自己电脑所在网段一致GATEWAY&#x3D;192.168.40.2 #网关，在自己电脑打开cmd，输入ipconfig &#x2F;all可看到DNS1&#x3D;192.168.40.2 #DNS，在自己电脑打开cmd，输入ipconfig &#x2F;all可看到","text":"启动一台新的机器centos-22初始化安装k8s集群的实验环境1、修改机器IP，变成静态IP - centos07-22 注意：&#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-ens33文件里的配置说明：NAME&#x3D;ens33 #网卡名字，跟DEVICE名字保持一致即可DEVICE&#x3D;ens33 #网卡设备名，大家ip addr可看到自己的这个网卡设备名，每个人的机器可能这个名字不一样，需要写自己的BOOTPROTO&#x3D;static #static表示静态ip地址ONBOOT&#x3D;yes #开机自启动网络，必须是yesIPADDR&#x3D;192.168.40.180 #ip地址，需要跟自己电脑所在网段一致NETMASK&#x3D;255.255.255.0 #子网掩码，需要跟自己电脑所在网段一致GATEWAY&#x3D;192.168.40.2 #网关，在自己电脑打开cmd，输入ipconfig &#x2F;all可看到DNS1&#x3D;192.168.40.2 #DNS，在自己电脑打开cmd，输入ipconfig &#x2F;all可看到 修改网卡配置12345678910111213141516171819[root@centos07-22 ~]# vim /etc/sysconfig/network-scripts/ifcfg-enp0s3TYPE=EthernetPROXY_METHOD=noneBROWSER_ONLY=noBOOTPROTO=staticIPADDR=192.168.1.12NETMASK=255.255.255.0GATEWAY=192.168.1.255DNS1=114.114.114.114DEFROUTE=yesIPV4_FAILURE_FATAL=noIPV6INIT=yesIPV6_AUTOCONF=yesIPV6_DEFROUTE=yesIPV6_FAILURE_FATAL=noIPV6_ADDR_GEN_MODE=stable-privacyNAME=enp0s3DEVICE=enp0s3ONBOOT=yes 全部重启12[root@centos07-22 ~]# service network restartRestarting network (via systemctl): [ OK ] 2、关闭selinux - centos07-22 修改selinux配置文件之后，重启机器，selinux配置才能永久生效1sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config 显示Disabled说明selinux已经关闭12[root@centos07-22 ~]# getenforceDisabled 3、配置机器主机名 - centos07-221hostnamectl set-hostname centos07-22 &amp;&amp; bash 4、升级系统,由centos7.6升级到centos7.9 - centos07-221yum update -y 5、配置主机hosts文件，相互之间通过主机名互相访问 - centos07-22 修改每台机器的&#x2F;etc&#x2F;hosts文件，增加如下三行123vim /etc/hosts192.168.1.22 centos07-22 6、配置主机之间无密码登录 - centos07-22 生成sshkey，一路回车，不输入密码1ssh-keygen 把本地生成的密钥文件和私钥文件拷贝到远程主机，保证3台机器可以无密登录1ssh-copy-id centos07-22 7、关闭交换分区swap，提升性能 - centos07-22 为什么要关闭swap交换分区？Swap是交换分区，如果机器内存不够，会使用swap分区，但是swap分区的性能较低，k8s设计的时候为了能提升性能，默认是不允许使用交换分区的。Kubeadm初始化的时候会检测swap是否关闭，如果没关闭，那就初始化失败。如果不想要关闭交换分区，安装k8s的时候可以指定–ignore-preflight-errors&#x3D;Swap来解决。 临时关闭1swapoff -a 永久关闭：注释swap挂载，给swap这行开头加一下注释123vim /etc/fstab# /dev/mapper/centos-swap swap swap defaults 0 0 8、修改机器内核参数 - centos07-22 sysctl是做什么的？在运行时配置内核参数 -p 从指定的文件加载系统参数，如不指定即从&#x2F;etc&#x2F;sysctl.conf中加载 为什么要执行modprobe br_netfilter 修改&#x2F;etc&#x2F;sysctl.d&#x2F;k8s.conf文件，增加如下三行参数： net.bridge.bridge-nf-call-ip6tables &#x3D; 1 net.bridge.bridge-nf-call-iptables &#x3D; 1 net.ipv4.ip_forward &#x3D; 1 sysctl -p &#x2F;etc&#x2F;sysctl.d&#x2F;k8s.conf出现报错： sysctl: cannot stat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;bridge&#x2F;bridge-nf-call-ip6tables: No such file or directorysysctl: cannot stat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;bridge&#x2F;bridge-nf-call-iptables: No such file or directory 解决方法： modprobe br_netfilter 为什么开启net.bridge.bridge-nf-call-iptables内核参数 在centos下安装docker，执行docker info出现如下警告： WARNING: bridge-nf-call-iptables is disabled WARNING: bridge-nf-call-ip6tables is disabled 解决办法： vim &#x2F;etc&#x2F;sysctl.d&#x2F;k8s.conf net.bridge.bridge-nf-call-ip6tables &#x3D; 1 net.bridge.bridge-nf-call-iptables &#x3D; 1 为什么要开启net.ipv4.ip_forward &#x3D; 1参数kubeadm初始化k8s如果报错： 就表示没有开启ip_forward，需要开启。net.ipv4.ip_forward是数据包转发：出于安全考虑，Linux系统默认是禁止数据包转发的。所谓转发即当主机拥有多于一块的网卡时，其中一块收到数据包，根据数据包的目的ip地址将数据包发往本机另一块网卡，该网卡根据路由表继续发送数据包。这通常是路由器所要实现的功能。要让Linux系统具有路由转发功能，需要配置一个Linux的内核参数net.ipv4.ip_forward。这个参数指定了Linux系统当前对路由转发功能的支持情况；其值为0时表示禁止进行IP转发；如果是1,则说明IP转发功能已经打开。 8.1、加载 modprobe br_netfilter 手动加载模块1234567modprobe br_netfilter# 查看是否加载lsmod|grep br_netfilterbr_netfilter 22256 0bridge 151336 2 br_netfilter,ebtable_broute 自动加载 1echo &quot;modprobe br_netfilter&quot; &gt;&gt; /etc/profile 8.2、配置bridge和forward12345cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt;EOFnet.bridge.bridge-nf-call-ip6tables = 1net.bridge.bridge-nf-call-iptables = 1net.ipv4.ip_forward = 1EOF 8.3、运行配置内核参数1sysctl -p /etc/sysctl.d/k8s.conf 9、关闭firewalld防火墙 - centos07-221systemctl stop firewalld ; systemctl disable firewalld 10、配置阿里云的repo源 - centos07-22 安装scp1yum install openssh-clients 备份原有源-可做可不做，也可以使用系统的源12mkdir -p /root/repo.bak/mv /etc/yum.repos.d/* /root/repo.bak/ 下载阿里云的repo源- 可做可不做，也可以使用系统的源12yum install yum-utils -y # 这个就是yum-config-manger工具yum-config-manager --add-repo https://mirrors.aliyun.com/repo/Centos-vault-8.5.2111.repo 配置国内阿里云docker的repo源1yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo 11、配置安装k8s组件需要的阿里云的repo源 - centos07-221234567vim /etc/yum.repos.d/kubernetes.repo[kubernetes]name=Kubernetesbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/enabled=1gpgcheck=0 12# 可以一个个编辑也可以使用scp同步scp /etc/yum.repos.d/kubernetes.repo centos07-22:/etc/yum.repos.d/ 12、配置时间同步 - centos07-22 安装ntpdate命令1yum install ntpdate -y 跟网络时间做同步1ntpdate cn.pool.ntp.org 把时间同步做成计划任务123crontab -e* */1 * * * /usr/sbin/ntpdate cn.pool.ntp.org 重启crond服务1service crond restart 13、安装基础软件包 - centos07-221yum install -y yum-utils device-mapper-persistent-data lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel python-devel epel-release openssh-server socat ipvsadm conntrack ntpdate telnet ipvsadm 安装containerd服务1、安装containerd - centos07-221yum install -y containerd.io-1.6.6 2、接下来生成 containerd 的配置文件: - centos07-2212mkdir -p /etc/containerdcontainerd config default &gt; /etc/containerd/config.toml 3、修改配置文件：- centos07-22 打开&#x2F;etc&#x2F;containerd&#x2F;config.toml 把 SystemdCgroup &#x3D; false 修改成 SystemdCgroup &#x3D; true 把 sandbox_image &#x3D; “k8s.gcr.io&#x2F;pause:3.6”修改成sandbox_image&#x3D;”registry.aliyuncs.com&#x2F;google_containers&#x2F;pause:3.7” 1234vim /etc/containerd/config.toml 61 sandbox_image = &quot;registry.aliyuncs.com/google_containers/pause:3.7&quot;125 SystemdCgroup = true 4、配置 containerd 开机启动，并启动 containerd - centos07-22123systemctl enable containerd --nowCreated symlink from /etc/systemd/system/multi-user.target.wants/containerd.service to /usr/lib/systemd/system/containerd.service. 5、查看下containerd状态，error忽略插件没有安装的错误1234567891011121314151617181920212223[root@centos07-22 ~]# systemctl status containerd.service● containerd.service - containerd container runtime Loaded: loaded (/usr/lib/systemd/system/containerd.service; enabled; vendor preset: disabled) Active: active (running) since 六 2023-12-02 22:18:03 CST; 5min ago Docs: https://containerd.io Process: 19116 ExecStartPre=/sbin/modprobe overlay (code=exited, status=0/SUCCESS) Main PID: 19118 (containerd) Tasks: 11 Memory: 26.2M CGroup: /system.slice/containerd.service └─19118 /usr/bin/containerd12月 02 22:18:03 centos07-22 containerd[19118]: time=&quot;2023-12-02T22:18:03.708356738+08:00&quot; level=error msg=&quot;failed to load cni durin...config&quot;12月 02 22:18:03 centos07-22 containerd[19118]: time=&quot;2023-12-02T22:18:03.708787339+08:00&quot; level=info msg=serving... address=/run/co...k.ttrpc12月 02 22:18:03 centos07-22 containerd[19118]: time=&quot;2023-12-02T22:18:03.708834065+08:00&quot; level=info msg=serving... address=/run/co...rd.sock12月 02 22:18:03 centos07-22 containerd[19118]: time=&quot;2023-12-02T22:18:03.708923088+08:00&quot; level=info msg=&quot;containerd successfully b...33763s&quot;12月 02 22:18:03 centos07-22 containerd[19118]: time=&quot;2023-12-02T22:18:03.720490658+08:00&quot; level=info msg=&quot;Start subscribing containerd event&quot;12月 02 22:18:03 centos07-22 containerd[19118]: time=&quot;2023-12-02T22:18:03.721454853+08:00&quot; level=info msg=&quot;Start recovering state&quot;12月 02 22:18:03 centos07-22 containerd[19118]: time=&quot;2023-12-02T22:18:03.721656196+08:00&quot; level=info msg=&quot;Start event monitor&quot;12月 02 22:18:03 centos07-22 containerd[19118]: time=&quot;2023-12-02T22:18:03.721718057+08:00&quot; level=info msg=&quot;Start snapshots syncer&quot;12月 02 22:18:03 centos07-22 containerd[19118]: time=&quot;2023-12-02T22:18:03.721754086+08:00&quot; level=info msg=&quot;Start cni network conf sy...efault&quot;12月 02 22:18:03 centos07-22 containerd[19118]: time=&quot;2023-12-02T22:18:03.721764670+08:00&quot; level=info msg=&quot;Start streaming server&quot;Hint: Some lines were ellipsized, use -l to show in full. 6、修改&#x2F;etc&#x2F;crictl.yaml文件 - centos07-22123456cat &gt; /etc/crictl.yaml &lt;&lt;EOFruntime-endpoint: unix:///run/containerd/containerd.sockimage-endpoint: unix:///run/containerd/containerd.socktimeout: 10debug: falseEOF 重启containerd： 1systemctl restart containerd 7、配置containerd镜像加速器，k8s所有节点均按照以下配置 - centos07-22 使用containerd下载镜像的命令：ctr images pull编辑vim &#x2F;etc&#x2F;containerd&#x2F;config.toml文件找到config_path &#x3D; “”，修改成如下目录：config_path &#x3D; “&#x2F;etc&#x2F;containerd&#x2F;certs.d”保存退出 123vim /etc/containerd/config.toml145 config_path = &quot;/etc/containerd/certs.d&quot; 123456mkdir /etc/containerd/certs.d/docker.io/ -pvim /etc/containerd/certs.d/docker.io/hosts.toml#写入如下内容：[host.&quot;https://vh3bm52y.mirror.aliyuncs.com&quot;,host.&quot;https://registry.docker-cn.com&quot;]capabilities = [&quot;pull&quot;] 重启containerd： 1systemctl restart containerd 8、备注：docker也要安装，docker跟containerd不冲突，安装docker是为了能基于dockerfile构建镜像 - centos07-22123yum install docker-ce -ysystemctl enable docker --now 9、配置docker镜像加速器，k8s所有节点均按照以下配置 - centos07-221234567vim /etc/docker/daemon.json# 写入如下内容：&#123;&quot;registry-mirrors&quot;:[&quot;https://vh3bm52y.mirror.aliyuncs.com&quot;,&quot;https://registry.docker-cn.com&quot;,&quot;https://docker.mirrors.ustc.edu.cn&quot;,&quot;https://dockerhub.azk8s.cn&quot;,&quot;http://hub-mirror.c.163.com&quot;]&#125; 10、重启docker： - centos07-221systemctl restart docker 12345678910111213141516171819202122[root@centos07-22 ~]# systemctl status docker● docker.service - Docker Application Container Engine Loaded: loaded (/usr/lib/systemd/system/docker.service; enabled; vendor preset: disabled) Active: active (running) since 六 2023-12-02 23:02:44 CST; 40s ago Docs: https://docs.docker.com Main PID: 19676 (dockerd) Tasks: 10 Memory: 33.3M CGroup: /system.slice/docker.service └─19676 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock12月 02 23:02:43 centos07-22 systemd[1]: Starting Docker Application Container Engine...12月 02 23:02:44 centos07-22 dockerd[19676]: time=&quot;2023-12-02T23:02:43.998989452+08:00&quot; level=info msg=&quot;Starting up&quot;12月 02 23:02:44 centos07-22 dockerd[19676]: time=&quot;2023-12-02T23:02:44.043889058+08:00&quot; level=info msg=&quot;[graphdriver] using prior st...erlay2&quot;12月 02 23:02:44 centos07-22 dockerd[19676]: time=&quot;2023-12-02T23:02:44.044231701+08:00&quot; level=info msg=&quot;Loading containers: start.&quot;12月 02 23:02:44 centos07-22 dockerd[19676]: time=&quot;2023-12-02T23:02:44.197828934+08:00&quot; level=info msg=&quot;Default bridge (docker0) is ...ddress&quot;12月 02 23:02:44 centos07-22 dockerd[19676]: time=&quot;2023-12-02T23:02:44.283541801+08:00&quot; level=info msg=&quot;Loading containers: done.&quot;12月 02 23:02:44 centos07-22 dockerd[19676]: time=&quot;2023-12-02T23:02:44.308745561+08:00&quot; level=info msg=&quot;Docker daemon&quot; commit=311b9f...=24.0.712月 02 23:02:44 centos07-22 dockerd[19676]: time=&quot;2023-12-02T23:02:44.308876736+08:00&quot; level=info msg=&quot;Daemon has completed initialization&quot;12月 02 23:02:44 centos07-22 dockerd[19676]: time=&quot;2023-12-02T23:02:44.356983479+08:00&quot; level=info msg=&quot;API listen on /run/docker.sock&quot;12月 02 23:02:44 centos07-22 systemd[1]: Started Docker Application Container Engine.Hint: Some lines were ellipsized, use -l to show in full. 11、安装初始化k8s需要的软件包 - centos07-22123yum install -y kubelet-1.26.0 kubeadm-1.26.0 kubectl-1.26.0systemctl enable kubelet 注：每个软件包的作用Kubeadm: kubeadm是一个工具，用来初始化k8s集群的kubelet: 安装在集群所有节点上，用于启动Pod的，kubeadm安装k8s，k8s控制节点和工作节点的组件，都是基于pod运行的，只要pod启动，就需要kubeletkubectl: 通过kubectl可以部署和管理应用，查看各种资源，创建、删除和更新各种组件 把centos07-22加入到K8s集群1、把centos07-12节点的证书拷贝到centos07-22上 在centos07-22创建证书存放目录1cd /root &amp;&amp; mkdir -p /etc/kubernetes/pki/etcd &amp;&amp;mkdir -p ~/.kube/ 把centos07-12节点的证书拷贝到centos07-22上12345678scp /etc/kubernetes/pki/ca.crt centos07-22:/etc/kubernetes/pki/scp /etc/kubernetes/pki/ca.key centos07-22:/etc/kubernetes/pki/scp /etc/kubernetes/pki/sa.key centos07-22:/etc/kubernetes/pki/scp /etc/kubernetes/pki/sa.pub centos07-22:/etc/kubernetes/pki/scp /etc/kubernetes/pki/front-proxy-ca.crt centos07-22:/etc/kubernetes/pki/scp /etc/kubernetes/pki/front-proxy-ca.key centos07-22:/etc/kubernetes/pki/scp /etc/kubernetes/pki/etcd/ca.crt centos07-22:/etc/kubernetes/pki/etcd/scp /etc/kubernetes/pki/etcd/ca.key centos07-22:/etc/kubernetes/pki/etcd/ 证书拷贝之后在centos07-22上执行如下命令，大家复制自己的，这样就可以把centos07-22和加入到集群，成为控制节点： 在centos07-22上执行： 把安装calico需要的镜像calico.tar.gz传到centos07-22节点，手动解压：1ctr -n=k8s.io images import k8s_1.26.0.tar.gz centos07-12，检查 kubeadm-config ConfigMap 是否正确配置了 controlPlaneEndpointcentos07-12，可以使用 kubectl 命令获取 kubeadm-config ConfigMap 的信息 1kubectl -n kube-system edit cm kubeadm-config -o yaml centos07-12，添加如下字段，这个非常非常重要controlPlaneEndpoint: “192.168.1.12:6443” 1controlPlaneEndpoint: &quot;192.168.1.12:6443&quot; centos07-12，重启kubelet：1systemctl restart kubelet 2、在centos07-12上查看加入节点的命令： 在命令尾部加上： –control-plane –ignore-preflight-errors&#x3D;SystemVerification 1kubeadm token create - -print-join-command 显示如下： 1kubeadm join 192.168.1.12:6443 --token ourdjc.rhhew1jkj792xtwu --discovery-token-ca-cert-hash sha256:92aba936efedc2da22b28033da80041be3a4bc41c9654fedb1f29dd9099bde7f --control-plane --ignore-preflight-errors=SystemVerification 123[root@centos07-22 ~]# mkdir -p $HOME/.kube[root@centos07-22 ~]# sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config[root@centos07-22 ~]# sudo chown $(id -u):$(id -g) $HOME/.kube/config 12345kubectl get nodeNAME STATUS ROLES AGE VERSIONcentos07-12 Ready control-plane 161m v1.26.0centos07-22 Ready control-plane 10m v1.26.0","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"06-ctr和crictl区别","slug":"运维/K8S/基础/06-ctr和crictl区别","date":"2023-05-03T12:00:50.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2023/05/03/运维/K8S/基础/06-ctr和crictl区别/","link":"","permalink":"https://dbbruce.github.io/2023/05/03/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/06-ctr%E5%92%8Ccrictl%E5%8C%BA%E5%88%AB/","excerpt":"背景：在部署k8s的过程中，经常要对镜像进行操作（拉取、删除、查看等）问题：使用过程中会发现ctr和crictl有很多相同功能，也有些不同，那区别到底在哪里？","text":"背景：在部署k8s的过程中，经常要对镜像进行操作（拉取、删除、查看等）问题：使用过程中会发现ctr和crictl有很多相同功能，也有些不同，那区别到底在哪里？ ###说明： ctr是containerd自带的CLI命令行工具，crictl是k8s中CRI（容器运行时接口）的客户端，k8s使用该客户端和containerd进行交互； crictl crictl我们设置 runtime-endpoint 为 unix:&#x2F;&#x2F;&#x2F;run&#x2F;containerd&#x2F;containerd.sock 1234567[root@centos07-12 ~]# cat /etc/crictl.yamlruntime-endpoint: unix:///run/containerd/containerd.sock # 设置的运行时image-endpoint: unix:///run/containerd/containerd.socktimeout: 10debug: falsepull-image-on-create: falsedisable-pull-on-run: false 2.ctr和crictl命令具体区别如下，也可以–help查看。crictl缺少对具体镜像的管理能力，可能是k8s层面镜像管理可以由用户自行控制，能配置pod里面容器的统一镜像仓库，镜像的管理可以有habor等插件进行处理。","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"05-kubeadm安装k8s1.26集群","slug":"运维/K8S/基础/05-kubeadm安装k8s1.26集群","date":"2023-05-03T02:00:50.000Z","updated":"2023-12-05T10:24:35.000Z","comments":true,"path":"2023/05/03/运维/K8S/基础/05-kubeadm安装k8s1.26集群/","link":"","permalink":"https://dbbruce.github.io/2023/05/03/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/05-kubeadm%E5%AE%89%E8%A3%85k8s1.26%E9%9B%86%E7%BE%A4/","excerpt":"k8s环境规划： podSubnet（pod网段） 10.244.0.0&#x2F;16 serviceSubnet（service网段）: 10.96.0.0&#x2F;16 K8S集群角色 ip 主机名 安装组件 控制节点master 192.168.1.12 centos07-12 apiserver、controller-manager、schedule、kubelet、etcd、kube-proxy、容器运行时、calico 工作节点-node 192.168.1.22 centos07-22 Kube-proxy、calico、coredns、容器运行时、kubelet","text":"k8s环境规划： podSubnet（pod网段） 10.244.0.0&#x2F;16 serviceSubnet（service网段）: 10.96.0.0&#x2F;16 K8S集群角色 ip 主机名 安装组件 控制节点master 192.168.1.12 centos07-12 apiserver、controller-manager、schedule、kubelet、etcd、kube-proxy、容器运行时、calico 工作节点-node 192.168.1.22 centos07-22 Kube-proxy、calico、coredns、容器运行时、kubelet 初始化安装k8s集群的实验环境1、修改机器IP，变成静态IP - centos07-12&#x2F;22 注意：&#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-ens33文件里的配置说明：NAME&#x3D;ens33 #网卡名字，跟DEVICE名字保持一致即可DEVICE&#x3D;ens33 #网卡设备名，大家ip addr可看到自己的这个网卡设备名，每个人的机器可能这个名字不一样，需要写自己的BOOTPROTO&#x3D;static #static表示静态ip地址ONBOOT&#x3D;yes #开机自启动网络，必须是yesIPADDR&#x3D;192.168.40.180 #ip地址，需要跟自己电脑所在网段一致NETMASK&#x3D;255.255.255.0 #子网掩码，需要跟自己电脑所在网段一致GATEWAY&#x3D;192.168.40.2 #网关，在自己电脑打开cmd，输入ipconfig &#x2F;all可看到DNS1&#x3D;192.168.40.2 #DNS，在自己电脑打开cmd，输入ipconfig &#x2F;all可看到 修改网卡配置12345678910111213141516171819[root@centos07-12 ~]# vim /etc/sysconfig/network-scripts/ifcfg-enp0s3TYPE=EthernetPROXY_METHOD=noneBROWSER_ONLY=noBOOTPROTO=staticIPADDR=192.168.1.12NETMASK=255.255.255.0GATEWAY=192.168.1.255DNS1=114.114.114.114DEFROUTE=yesIPV4_FAILURE_FATAL=noIPV6INIT=yesIPV6_AUTOCONF=yesIPV6_DEFROUTE=yesIPV6_FAILURE_FATAL=noIPV6_ADDR_GEN_MODE=stable-privacyNAME=enp0s3DEVICE=enp0s3ONBOOT=yes 全部重启12[root@centos07-12 ~]# service network restartRestarting network (via systemctl): [ OK ] 2、关闭selinux - centos07-12&#x2F;22 修改selinux配置文件之后，重启机器，selinux配置才能永久生效1sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config 显示Disabled说明selinux已经关闭12[root@centos07-12 ~]# getenforceDisabled 3、配置机器主机名 - centos07-12&#x2F;221hostnamectl set-hostname CentOS07-12 &amp;&amp; bash 4、升级系统,由centos7.6升级到centos7.9 - centos07-12&#x2F;221yum update -y 5、配置主机hosts文件，相互之间通过主机名互相访问 - centos07-12&#x2F;22 修改每台机器的&#x2F;etc&#x2F;hosts文件，增加如下三行1234vim /etc/hosts192.168.1.12 centos07-12192.168.1.22 centos07-22 6、配置主机之间无密码登录 - centos07-12&#x2F;22 生成sshkey，一路回车，不输入密码1ssh-keygen 把本地生成的密钥文件和私钥文件拷贝到远程主机，保证3台机器可以无密登录12ssh-copy-id centos07-12ssh-copy-id centos07-22 7、关闭交换分区swap，提升性能 - centos07-12&#x2F;22 为什么要关闭swap交换分区？Swap是交换分区，如果机器内存不够，会使用swap分区，但是swap分区的性能较低，k8s设计的时候为了能提升性能，默认是不允许使用交换分区的。Kubeadm初始化的时候会检测swap是否关闭，如果没关闭，那就初始化失败。如果不想要关闭交换分区，安装k8s的时候可以指定–ignore-preflight-errors&#x3D;Swap来解决。 临时关闭1swapoff -a 永久关闭：注释swap挂载，给swap这行开头加一下注释123vim /etc/fstab# /dev/mapper/centos-swap swap swap defaults 0 0 8、修改机器内核参数 - centos07-12&#x2F;22 sysctl是做什么的？在运行时配置内核参数 -p 从指定的文件加载系统参数，如不指定即从&#x2F;etc&#x2F;sysctl.conf中加载 为什么要执行modprobe br_netfilter 修改&#x2F;etc&#x2F;sysctl.d&#x2F;k8s.conf文件，增加如下三行参数： net.bridge.bridge-nf-call-ip6tables &#x3D; 1 net.bridge.bridge-nf-call-iptables &#x3D; 1 net.ipv4.ip_forward &#x3D; 1 sysctl -p &#x2F;etc&#x2F;sysctl.d&#x2F;k8s.conf出现报错： sysctl: cannot stat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;bridge&#x2F;bridge-nf-call-ip6tables: No such file or directorysysctl: cannot stat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;bridge&#x2F;bridge-nf-call-iptables: No such file or directory 解决方法： modprobe br_netfilter 为什么开启net.bridge.bridge-nf-call-iptables内核参数 在centos下安装docker，执行docker info出现如下警告： WARNING: bridge-nf-call-iptables is disabled WARNING: bridge-nf-call-ip6tables is disabled 解决办法： vim &#x2F;etc&#x2F;sysctl.d&#x2F;k8s.conf net.bridge.bridge-nf-call-ip6tables &#x3D; 1 net.bridge.bridge-nf-call-iptables &#x3D; 1 为什么要开启net.ipv4.ip_forward &#x3D; 1参数kubeadm初始化k8s如果报错： 就表示没有开启ip_forward，需要开启。net.ipv4.ip_forward是数据包转发：出于安全考虑，Linux系统默认是禁止数据包转发的。所谓转发即当主机拥有多于一块的网卡时，其中一块收到数据包，根据数据包的目的ip地址将数据包发往本机另一块网卡，该网卡根据路由表继续发送数据包。这通常是路由器所要实现的功能。要让Linux系统具有路由转发功能，需要配置一个Linux的内核参数net.ipv4.ip_forward。这个参数指定了Linux系统当前对路由转发功能的支持情况；其值为0时表示禁止进行IP转发；如果是1,则说明IP转发功能已经打开。 8.1、加载 modprobe br_netfilter 手动加载模块1234567modprobe br_netfilter# 查看是否加载lsmod|grep br_netfilterbr_netfilter 22256 0bridge 151336 2 br_netfilter,ebtable_broute 自动加载 1echo &quot;modprobe br_netfilter&quot; &gt;&gt; /etc/profile 8.2、配置bridge和forward12345cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt;EOFnet.bridge.bridge-nf-call-ip6tables = 1net.bridge.bridge-nf-call-iptables = 1net.ipv4.ip_forward = 1EOF 8.3、运行配置内核参数1sysctl -p /etc/sysctl.d/k8s.conf 9、关闭firewalld防火墙 - centos07-12&#x2F;221systemctl stop firewalld ; systemctl disable firewalld 10、配置阿里云的repo源 - centos07-12&#x2F;22 安装scp1yum install openssh-clients 备份原有源-可做可不做，也可以使用系统的源12mkdir -p /root/repo.bak/mv /etc/yum.repos.d/* /root/repo.bak/ 下载阿里云的repo源- 可做可不做，也可以使用系统的源12yum install yum-utils -y # 这个就是yum-config-manger工具yum-config-manager --add-repo https://mirrors.aliyun.com/repo/Centos-vault-8.5.2111.repo 配置国内阿里云docker的repo源1yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo 11、配置安装k8s组件需要的阿里云的repo源 - centos07-12&#x2F;221234567vim /etc/yum.repos.d/kubernetes.repo[kubernetes]name=Kubernetesbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/enabled=1gpgcheck=0 12# 可以一个个编辑也可以使用scp同步scp /etc/yum.repos.d/kubernetes.repo centos07-22:/etc/yum.repos.d/ 12、配置时间同步 - centos07-12&#x2F;22 安装ntpdate命令1yum install ntpdate -y 跟网络时间做同步1ntpdate cn.pool.ntp.org 把时间同步做成计划任务123crontab -e* */1 * * * /usr/sbin/ntpdate cn.pool.ntp.org 重启crond服务1service crond restart 13、安装基础软件包 - centos07-12&#x2F;221yum install -y yum-utils device-mapper-persistent-data lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel python-devel epel-release openssh-server socat ipvsadm conntrack ntpdate telnet ipvsadm 安装containerd服务1、安装containerd - centos07-12&#x2F;221yum install -y containerd.io-1.6.6 2、接下来生成 containerd 的配置文件: - centos07-12&#x2F;2212mkdir -p /etc/containerdcontainerd config default &gt; /etc/containerd/config.toml 3、修改配置文件：- centos07-12&#x2F;22 打开&#x2F;etc&#x2F;containerd&#x2F;config.toml 把 SystemdCgroup &#x3D; false 修改成 SystemdCgroup &#x3D; true 把 sandbox_image &#x3D; “k8s.gcr.io&#x2F;pause:3.6”修改成sandbox_image&#x3D;”registry.aliyuncs.com&#x2F;google_containers&#x2F;pause:3.7” 1234vim /etc/containerd/config.toml 61 sandbox_image = &quot;registry.aliyuncs.com/google_containers/pause:3.7&quot;125 SystemdCgroup = true 4、配置 containerd 开机启动，并启动 containerd - centos07-12&#x2F;22123systemctl enable containerd --nowCreated symlink from /etc/systemd/system/multi-user.target.wants/containerd.service to /usr/lib/systemd/system/containerd.service. 5、查看下containerd状态，error忽略插件没有安装的错误1234567891011121314151617181920212223[root@centos07-12 ~]# systemctl status containerd.service● containerd.service - containerd container runtime Loaded: loaded (/usr/lib/systemd/system/containerd.service; enabled; vendor preset: disabled) Active: active (running) since 六 2023-12-02 22:18:03 CST; 5min ago Docs: https://containerd.io Process: 19116 ExecStartPre=/sbin/modprobe overlay (code=exited, status=0/SUCCESS) Main PID: 19118 (containerd) Tasks: 11 Memory: 26.2M CGroup: /system.slice/containerd.service └─19118 /usr/bin/containerd12月 02 22:18:03 centos07-12 containerd[19118]: time=&quot;2023-12-02T22:18:03.708356738+08:00&quot; level=error msg=&quot;failed to load cni durin...config&quot;12月 02 22:18:03 centos07-12 containerd[19118]: time=&quot;2023-12-02T22:18:03.708787339+08:00&quot; level=info msg=serving... address=/run/co...k.ttrpc12月 02 22:18:03 centos07-12 containerd[19118]: time=&quot;2023-12-02T22:18:03.708834065+08:00&quot; level=info msg=serving... address=/run/co...rd.sock12月 02 22:18:03 centos07-12 containerd[19118]: time=&quot;2023-12-02T22:18:03.708923088+08:00&quot; level=info msg=&quot;containerd successfully b...33763s&quot;12月 02 22:18:03 centos07-12 containerd[19118]: time=&quot;2023-12-02T22:18:03.720490658+08:00&quot; level=info msg=&quot;Start subscribing containerd event&quot;12月 02 22:18:03 centos07-12 containerd[19118]: time=&quot;2023-12-02T22:18:03.721454853+08:00&quot; level=info msg=&quot;Start recovering state&quot;12月 02 22:18:03 centos07-12 containerd[19118]: time=&quot;2023-12-02T22:18:03.721656196+08:00&quot; level=info msg=&quot;Start event monitor&quot;12月 02 22:18:03 centos07-12 containerd[19118]: time=&quot;2023-12-02T22:18:03.721718057+08:00&quot; level=info msg=&quot;Start snapshots syncer&quot;12月 02 22:18:03 centos07-12 containerd[19118]: time=&quot;2023-12-02T22:18:03.721754086+08:00&quot; level=info msg=&quot;Start cni network conf sy...efault&quot;12月 02 22:18:03 centos07-12 containerd[19118]: time=&quot;2023-12-02T22:18:03.721764670+08:00&quot; level=info msg=&quot;Start streaming server&quot;Hint: Some lines were ellipsized, use -l to show in full. 6、修改&#x2F;etc&#x2F;crictl.yaml文件 - centos07-12&#x2F;22123456cat &gt; /etc/crictl.yaml &lt;&lt;EOFruntime-endpoint: unix:///run/containerd/containerd.sockimage-endpoint: unix:///run/containerd/containerd.socktimeout: 10debug: falseEOF 重启containerd： 1systemctl restart containerd 7、配置containerd镜像加速器，k8s所有节点均按照以下配置 - centos07-12&#x2F;22 使用containerd下载镜像的命令：ctr images pull编辑vim &#x2F;etc&#x2F;containerd&#x2F;config.toml文件找到config_path &#x3D; “”，修改成如下目录：config_path &#x3D; “&#x2F;etc&#x2F;containerd&#x2F;certs.d”保存退出 123vim /etc/containerd/config.toml145 config_path = &quot;/etc/containerd/certs.d&quot; 123456mkdir /etc/containerd/certs.d/docker.io/ -pvim /etc/containerd/certs.d/docker.io/hosts.toml#写入如下内容：[host.&quot;https://vh3bm52y.mirror.aliyuncs.com&quot;,host.&quot;https://registry.docker-cn.com&quot;]capabilities = [&quot;pull&quot;] 重启containerd： 1systemctl restart containerd 8、备注：docker也要安装，docker跟containerd不冲突，安装docker是为了能基于dockerfile构建镜像 - centos07-12&#x2F;22123yum install docker-ce -ysystemctl enable docker --now 9、配置docker镜像加速器，k8s所有节点均按照以下配置 - centos07-12&#x2F;221234567vim /etc/docker/daemon.json# 写入如下内容：&#123;&quot;registry-mirrors&quot;:[&quot;https://vh3bm52y.mirror.aliyuncs.com&quot;,&quot;https://registry.docker-cn.com&quot;,&quot;https://docker.mirrors.ustc.edu.cn&quot;,&quot;https://dockerhub.azk8s.cn&quot;,&quot;http://hub-mirror.c.163.com&quot;]&#125; 10、重启docker： - centos07-12&#x2F;221systemctl restart docker 12345678910111213141516171819202122[root@centos07-12 ~]# systemctl status docker● docker.service - Docker Application Container Engine Loaded: loaded (/usr/lib/systemd/system/docker.service; enabled; vendor preset: disabled) Active: active (running) since 六 2023-12-02 23:02:44 CST; 40s ago Docs: https://docs.docker.com Main PID: 19676 (dockerd) Tasks: 10 Memory: 33.3M CGroup: /system.slice/docker.service └─19676 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock12月 02 23:02:43 centos07-12 systemd[1]: Starting Docker Application Container Engine...12月 02 23:02:44 centos07-12 dockerd[19676]: time=&quot;2023-12-02T23:02:43.998989452+08:00&quot; level=info msg=&quot;Starting up&quot;12月 02 23:02:44 centos07-12 dockerd[19676]: time=&quot;2023-12-02T23:02:44.043889058+08:00&quot; level=info msg=&quot;[graphdriver] using prior st...erlay2&quot;12月 02 23:02:44 centos07-12 dockerd[19676]: time=&quot;2023-12-02T23:02:44.044231701+08:00&quot; level=info msg=&quot;Loading containers: start.&quot;12月 02 23:02:44 centos07-12 dockerd[19676]: time=&quot;2023-12-02T23:02:44.197828934+08:00&quot; level=info msg=&quot;Default bridge (docker0) is ...ddress&quot;12月 02 23:02:44 centos07-12 dockerd[19676]: time=&quot;2023-12-02T23:02:44.283541801+08:00&quot; level=info msg=&quot;Loading containers: done.&quot;12月 02 23:02:44 centos07-12 dockerd[19676]: time=&quot;2023-12-02T23:02:44.308745561+08:00&quot; level=info msg=&quot;Docker daemon&quot; commit=311b9f...=24.0.712月 02 23:02:44 centos07-12 dockerd[19676]: time=&quot;2023-12-02T23:02:44.308876736+08:00&quot; level=info msg=&quot;Daemon has completed initialization&quot;12月 02 23:02:44 centos07-12 dockerd[19676]: time=&quot;2023-12-02T23:02:44.356983479+08:00&quot; level=info msg=&quot;API listen on /run/docker.sock&quot;12月 02 23:02:44 centos07-12 systemd[1]: Started Docker Application Container Engine.Hint: Some lines were ellipsized, use -l to show in full. 11、安装初始化k8s需要的软件包 - centos07-12&#x2F;22123yum install -y kubelet-1.26.0 kubeadm-1.26.0 kubectl-1.26.0systemctl enable kubelet 注：每个软件包的作用Kubeadm: kubeadm是一个工具，用来初始化k8s集群的kubelet: 安装在集群所有节点上，用于启动Pod的，kubeadm安装k8s，k8s控制节点和工作节点的组件，都是基于pod运行的，只要pod启动，就需要kubeletkubectl: 通过kubectl可以部署和管理应用，查看各种资源，创建、删除和更新各种组件 12、kubeadm初始化k8s集群 - centos07-12&#x2F;221、设置容器运行时 - centos07-12&#x2F;22 设置容器后，crictl看到的都是containerd的容器 123crictl config runtime-endpoint unix:///run/containerd/containerd.sockcrictl ps 2、使用kubeadm初始化k8s集群 - centos07-121kubeadm config print init-defaults &gt; kubeadm.yaml 3、根据我们自己的需求修改配置 - centos07-12 修改kubeadm.yaml配置文件如下:advertiseAddress: 192.168.40.180 # 控制节点的icriSocket: unix:&#x2F;&#x2F;&#x2F;run&#x2F;containerd&#x2F;containerd.sock #指定containerd容器运行时name: centos07-12 #控制节点主机名imageRepository: registry.cn-hangzhou.aliyuncs.com&#x2F;google_containers # 指定阿里云镜像仓库地址kubernetesVersion: 1.26.0 #k8s版本，这里要是kubeadm,kubelet,kubectl版本一致podSubnet: 10.244.0.0&#x2F;16 #指定pod网段， 需要新增加这serviceSubnet: 10.96.0.0&#x2F;12 #指定Service网段#在文件最后，插入以下内容，（复制时，要带着—）： 12345678---apiVersion: kubeproxy.config.k8s.io/v1alpha1kind: KubeProxyConfigurationmode: ipvs---apiVersion: kubelet.config.k8s.io/v1beta1kind: KubeletConfigurationcgroupDriver: systemd 12345678910111213141516171819vim kubeadm.yaml 12 advertiseAddress: 192.168.1.12 15 criSocket: unix:///run/containerd/containerd.sock 17 name: centos07-12 30 imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers 32 kubernetesVersion: 1.26.0 35 serviceSubnet: 10.96.0.0/12 36 podSubnet: 10.244.0.0/16 # 在servicesubnet下插入#在文件最后，插入以下内容，（复制时，要带着---）：---apiVersion: kubeproxy.config.k8s.io/v1alpha1kind: KubeProxyConfigurationmode: ipvs---apiVersion: kubelet.config.k8s.io/v1beta1kind: KubeletConfigurationcgroupDriver: systemd 4、基于kubeadm.yaml初始化k8s集群master - centos07-12 查看镜像，可以看到可以查询到了： crictl images &#x3D;&#x3D;&#x3D; ctr -n&#x3D;k8s.io images lsctr是containerd自带的工具，有命名空间的概念，若是k8s相关的镜像，都默认在k8s.io这个命名空间，所以导入镜像时需要指定命令空间为k8s.io使用ctr命令指定命名空间导入镜像:ctr -n&#x3D;k8s.io images import k8s_1.26.0.tar.gz备注：k8s_1.26.0.tar.gz这个文件如何来的？这个文件把安装k8s需要的镜像都集成好了，这个是我第一次安装1.26.0这个版本，获取到对应的镜像，通过ctr images export 这个命令把镜像输出到k8s_1.26.0.tar.gz文件，如果大家安装其他版本，那就不需要实现解压镜像，可以默认从网络拉取镜像即可。–ignore-preflight-errors&#x3D;SystemVerification 解决 centos把configs模块找不到的问题 在线方式安装，通过在线下载组件安装K8s - centos07-121kubeadm init --config=kubeadm.yaml --ignore-preflight-errors=SystemVerification 查看下载的镜像列表123456789101112[root@centos07-12 ~]# crictl imagesIMAGE TAG IMAGE ID SIZEregistry.aliyuncs.com/google_containers/pause 3.7 221177c6082a8 311kBregistry.cn-hangzhou.aliyuncs.com/google_containers/coredns v1.9.3 5185b96f0becf 14.8MBregistry.cn-hangzhou.aliyuncs.com/google_containers/etcd 3.5.6-0 fce326961ae2d 103MBregistry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver v1.26.0 a31e1d84401e6 35.3MBregistry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager v1.26.0 5d7c5dfd3ba18 32.2MBregistry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy v1.26.0 556768f31eb1d 21.5MBregistry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler v1.26.0 dafd8ad70b156 17.5MBregistry.cn-hangzhou.aliyuncs.com/google_containers/pause 3.9 e6f1816883972 322kB[root@centos07-12 ~]# 导入包方式安装，通过导入已经镜像包安装 - centos07-12 导出镜像1ctr -n=k8s.io images export k8s_1.26.0.tar.gz registry.aliyuncs.com/google_containers/pause:3.7 registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.9.3 registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.6-0 registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.26.0 registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.26.0 registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.26.0 registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.26.0 registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.9 1234[root@centos07-12 ~]# ctr -n=k8s.io images export k8s_1.26.0.tar.gz registry.aliyuncs.com/google_containers/pause:3.7 registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.9.3 registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.6-0 registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.26.0 registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.26.0 registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.26.0 registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.26.0 registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.9[root@centos07-12 ~]# ll总用量 215692-rw-r--r-- 1 root root 220858880 12月 3 07:13 k8s_1.26.0.tar.gz 导入镜像1ctr -n=k8s.io images import k8s_1.26.0.tar.gz 5、配置kubectl的配置文件config，相当于对kubectl进行授权，这样kubectl命令可以使用这个证书对k8s集群进行管理- centos07-12123mkdir -p $HOME/.kubesudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/configsudo chown $(id -u):$(id -g) $HOME/.kube/config 配置后就可以看到节点了 1234kubectl get nodesNAME STATUS ROLES AGE VERSIONcentos07-12 NotReady control-plane 21m v1.26.0 查看配置文件&#x3D;kubectl config view 123456789101112131415161718192021[root@centos07-12 ~]# kubectl config viewapiVersion: v1clusters:- cluster: certificate-authority-data: DATA+OMITTED server: https://192.168.1.12:6443 name: kubernetescontexts:- context: cluster: kubernetes user: kubernetes-admin name: kubernetes-admin@kubernetescurrent-context: kubernetes-admin@kuberneteskind: Configpreferences: &#123;&#125;users:- name: kubernetes-admin user: client-certificate-data: DATA+OMITTED client-key-data: DATA+OMITTED 特别提醒：–image-repository registry.aliyuncs.com&#x2F;google_containers为保证拉取镜像不到国外站点拉取，手动指定仓库地址为registry.aliyuncs.com&#x2F;google_containers。kubeadm默认从k8s.gcr.io拉取镜像。 我们本地有导入到的离线镜像，所以会优先使用本地的镜像。 mode: ipvs 表示kube-proxy代理模式是ipvs，如果不指定ipvs，会默认使用iptables，但是iptables效率低，所以我们生产环境建议开启ipvs，阿里云和华为云托管的K8s，也提供ipvs模式，如下： 6、查看控制节点上启动了哪些pod - centos07-12 kubectl get pods -n kube-system -owide 123456789[root@centos07-12 ~]# kubectl get pods -n kube-system -owideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATEScoredns-567c556887-gz24c 0/1 Pending 0 28m &lt;none&gt; &lt;none&gt; &lt;none&gt; &lt;none&gt;coredns-567c556887-q8pg2 0/1 Pending 0 28m &lt;none&gt; &lt;none&gt; &lt;none&gt; &lt;none&gt;etcd-centos07-12 1/1 Running 0 28m 192.168.1.12 centos07-12 &lt;none&gt; &lt;none&gt;kube-apiserver-centos07-12 1/1 Running 0 28m 192.168.1.12 centos07-12 &lt;none&gt; &lt;none&gt;kube-controller-manager-centos07-12 1/1 Running 0 28m 192.168.1.12 centos07-12 &lt;none&gt; &lt;none&gt;kube-proxy-wxnfr 1/1 Running 0 28m 192.168.1.12 centos07-12 &lt;none&gt; &lt;none&gt;kube-scheduler-centos07-12 1/1 Running 0 28m 192.168.1.12 centos07-12 &lt;none&gt; &lt;none&gt; 扩容k8s集群-添加第一个工作节点1、在centos07-12上查看加入节点的命令 - centos07-12 kubeadm token create - -print-join-command 123[root@centos07-12 ~]# kubeadm token create - -print-join-commandkubeadm join 192.168.1.12:6443 --token 2ttvy2.sk1yuq8gbmkwaj2h --discovery-token-ca-cert-hash sha256:92aba936efedc2da22b28033da80041be3a4bc41c9654fedb1f29dd9099bde7f 2、把centos07-22加入k8s集群 - centos07-221kubeadm join 192.168.1.12:6443 --token 2ttvy2.sk1yuq8gbmkwaj2h --discovery-token-ca-cert-hash sha256:92aba936efedc2da22b28033da80041be3a4bc41c9654fedb1f29dd9099bde7f --ignore-preflight-errors=SystemVerification 1234567891011121314[root@centos07-22 ~]# kubeadm join 192.168.1.12:6443 --token 2ttvy2.sk1yuq8gbmkwaj2h --discovery-token-ca-cert-hash sha256:92aba936efedc2da22b28033da80041be3a4bc41c9654fedb1f29dd9099bde7f --ignore-preflight-errors=SystemVerification[preflight] Running pre-flight checks[preflight] Reading configuration from the cluster...[preflight] FYI: You can look at this config file with &#x27;kubectl -n kube-system get cm kubeadm-config -o yaml&#x27;[kubelet-start] Writing kubelet configuration to file &quot;/var/lib/kubelet/config.yaml&quot;[kubelet-start] Writing kubelet environment file with flags to file &quot;/var/lib/kubelet/kubeadm-flags.env&quot;[kubelet-start] Starting the kubelet[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...This node has joined the cluster:* Certificate signing request was sent to apiserver and a response was received.* The Kubelet was informed of the new secure connection details.Run &#x27;kubectl get nodes&#x27; on the control-plane to see this node join the cluster. 3、看到上面说明centos07-12节点已经加入到集群了,充当工作节点 - centos07-1212345[root@centos07-12 ~]# kubectl get nodesNAME STATUS ROLES AGE VERSIONcentos07-12 NotReady control-plane 40m v1.26.0centos07-22 NotReady &lt;none&gt; 2m57s v1.26.0 4、可以对centos07-22打个标签，显示work - centos07-121kubectl label nodes centos07-22 node-role.kubernetes.io/work=work 1234567root@centos07-12 ~]# kubectl label nodes centos07-22 node-role.kubernetes.io/work=worknode/centos07-22 labeled[root@centos07-12 ~]# kubectl get nodesNAME STATUS ROLES AGE VERSIONcentos07-12 NotReady control-plane 43m v1.26.0centos07-22 NotReady work 5m41s v1.26.0 安装kubernetes网络组件-Calico 注：官方提供的文件地址，下载后需要自己修改： https://docs.projectcalico.org/manifests/calico.yaml删除，kubectl delete -f calico.yaml (如果上传镜像，就不在网络下载了，直接从本地安装了)把安装calico需要的镜像calico.tar.gz传到centos07-12和centos07-22节点，手动解压： - centos07-12&#x2F;221ctr -n=k8s.io images import calico.tar.gz 注意服务器多网卡，需要指定网卡。 1234vim calico.yaml3648 - name: IP_AUTODETECTION_METHOD3649 value: &quot;interface=enp0s3&quot; 安装calico1kubectl apply -f calico.yaml node的状态pending变为ready123456kubectl get nodeNAME STATUS ROLES AGE VERSIONcentos07-12 Ready control-plane 67m v1.26.0centos07-22 Ready work 29m v1.26.0[root@centos07-12 ~]# pod， 状态都变成Running，ready变为1&#x2F;1;1234567891011121314kubectl get pod -n kube-systemNAME READY STATUS RESTARTS AGEcalico-kube-controllers-d886b8fff-fj5rt 1/1 Running 0 18mcalico-node-cmldb 1/1 Running 0 18mcalico-node-f7pbl 1/1 Running 0 18mcoredns-567c556887-gz24c 1/1 Running 0 73mcoredns-567c556887-q8pg2 1/1 Running 0 73metcd-centos07-12 1/1 Running 0 73mkube-apiserver-centos07-12 1/1 Running 0 73mkube-controller-manager-centos07-12 1/1 Running 0 73mkube-proxy-kf9q2 1/1 Running 0 35mkube-proxy-wxnfr 1/1 Running 0 73mkube-scheduler-centos07-12 1/1 Running 0 73m 查看日志1kubectl logs calico-node-f7pbl -n kube-system Calico架构图 Calico网络模型主要工作组件：1.Felix：运行在每一台 Host 的 agent 进程，主要负责网络接口管理和监听、路由、ARP 管理、ACL 管理和同步、状态上报等。保证跨主机容器网络互通。2.etcd：分布式键值存储，相当于k8s集群中的数据库，存储着Calico网络模型中IP地址等相关信息。主要负责网络元数据一致性，确保 Calico 网络状态的准确性；3.BGP Client（BIRD）：Calico 为每一台 Host 部署一个 BGP Client，即每台host上部署一个BIRD。 主要负责把 Felix 写入 Kernel 的路由信息分发到当前 Calico 网络，确保 Workload 间的通信的有效性；4.BGP Route Reflector：在大型网络规模中，如果仅仅使用 BGP client 形成 mesh 全网互联的方案就会导致规模限制，因为所有节点之间俩俩互联，需要 N^2 个连接，为了解决这个规模问题，可以采用 BGP 的 Router Reflector 的方法，通过一个或者多个 BGP Route Reflector 来完成集中式的路由分发。 1、Daemonset配置 ……containers: # Runs calico-node container on each Kubernetes node. This # container programs network policy and routes on each # host. - name: calico-node image: docker.io&#x2F;calico&#x2F;node:v3.18.0….. env: # Use Kubernetes API as the backing datastore. - name: DATASTORE_TYPE value: “kubernetes” # Cluster type to identify the deployment type - name: CLUSTER_TYPE value: “k8s,bgp” # Auto-detect the BGP IP address. - name: IP value: “autodetect” #pod网段 - name: CALICO_IPV4POOL_CIDR value: “10.244.0.0&#x2F;16” # Enable IPIP - name: CALICO_IPV4POOL_IPIP value: “Always” calico-node服务的主要参数如下:CALICO_IPV4POOL_IPIP：是否启用IPIP模式。启用IPIP模式时，Calico将在Node上创建一个名为tunl0的虚拟隧道。IP Pool可以使用两种模式：BGP或IPIP。使用IPIP模式时，设置CALICO_IPV4POOL_IPIP&#x3D;”Always”，不使用IPIP模式时，设置CALICO_IPV4POOL_IPIP&#x3D;”Off”，此时将使用BGP模式。IP_AUTODETECTION_METHOD：获取Node IP地址的方式，默认使用第1个网络接口的IP地址，对于安装了多块网卡的Node，可以使用正则表达式选择正确的网卡，例如”interface&#x3D;eth.*”表示选择名称以eth开头的网卡的IP地址。- name: IP_AUTODETECTION_METHOD value: “interface&#x3D;enp0s3” 扩展：calico的IPIP模式和BGP模式对比分析1）IPIP把一个IP数据包又套在一个IP包里，即把IP层封装到IP层的一个 tunnel，它的作用其实基本上就相当于一个基于IP层的网桥，一般来说，普通的网桥是基于mac层的，根本不需要IP，而这个ipip则是通过两端的路由做一个tunnel，把两个本来不通的网络通过点对点连接起来；calico以ipip模式部署完毕后，node上会有一个tunl0的网卡设备，这是ipip做隧道封装用的,也是一种overlay模式的网络。当我们把节点下线，calico容器都停止后，这个设备依然还在，执行 rmmodipip命令可以将它删除。2）BGPBGP模式直接使用物理机作为虚拟路由路（vRouter），不再创建额外的tunnel边界网关协议（BorderGateway Protocol, BGP）是互联网上一个核心的去中心化的自治路由协议。它通过维护IP路由表或‘前缀’表来实现自治系统（AS）之间的可达性，属于矢量路由协议。BGP不使用传统的内部网关协议（IGP）的指标，而是基于路径、网络策略或规则集来决定路由。因此，它更适合被称为矢量性协议，而不是路由协议，通俗的说就是将接入到机房的多条线路（如电信、联通、移动等）融合为一体，实现多线单IP；BGP 机房的优点：服务器只需要设置一个IP地址，最佳访问路由是由网络上的骨干路由器根据路由跳数与其它技术指标来确定的，不会占用服务器的任何系统；官方提供的calico.yaml模板里，默认打开了ip-ip功能，该功能会在node上创建一个设备tunl0，容器的网络数据会经过该设备被封装一个ip头再转发。这里，calico.yaml中通过修改calico-node的环境变量：CALICO_IPV4POOL_IPIP来实现ipip功能的开关：默认是Always，表示开启；Off表示关闭ipip。- name: CLUSTER_TYPE value: “k8s,bgp” # Auto-detect the BGP IP address.- name: IP value: “autodetect” # Enable IPIP- name: CALICO_IPV4POOL_IPIP value: “Always” 总结：calico BGP通信是基于TCP协议的，所以只要节点间三层互通即可完成，即三层互通的环境bird就能生成与邻居有关的路由。但是这些路由和flannel host-gateway模式一样，需要二层互通才能访问的通，因此如果在实际环境中配置了BGP模式生成了路由但是不同节点间pod访问不通，可能需要再确认下节点间是否二层互通。为了解决节点间二层不通场景下的跨节点通信问题，calico也有自己的解决方案——IPIP模式 9、测试在k8s创建pod是否可以正常访问网络，镜像放在node上，在master上执行命令 注意：把busybox-1-28.tar.gz上传到centos07-22 手动解压1scp busybox-1-28.tar.gz root@192.168.1.22:~ 12# centos07-22ctr -n k8s.io images import busybox-1-28.tar.gz 12[root@centos07-22 ~]# crictl images |grep busyboxdocker.io/library/busybox 1.28 8c811b4aec35f 1.36MB 在控制节点-centos07-121kubectl run busybox --image docker.io/library/busybox:1.28 --image-pull-policy=IfNotPresent --restart=Never --rm -it busybox -- sh 1234567891011# 通过下面可以看到能访问网络，说明calico网络插件已经被正常安装了[root@centos07-12 ~]# kubectl run busybox --image docker.io/library/busybox:1.28 --image-pull-policy=IfNotPresent --restart=Never --rm -it busybox -- shIf you don&#x27;t see a command prompt, try pressing enter./ # ping www.baidu.comPING www.baidu.com (39.156.66.14): 56 data bytes64 bytes from 39.156.66.14: seq=0 ttl=61 time=7.727 ms64 bytes from 39.156.66.14: seq=1 ttl=61 time=8.951 ms--- www.baidu.com ping statistics ---2 packets transmitted, 2 packets received, 0% packet lossround-trip min/avg/max = 7.727/8.339/8.951 ms 10、测试coredns是否正常 - centos07-12 0.96.0.10 就是我们coreDNS的clusterIP，说明coreDNS配置好了。解析内部Service的名称，是通过coreDNS去解析的。 12345678[root@centos07-12 ~]# kubectl run busybox --image docker.io/library/busybox:1.28 --image-pull-policy=IfNotPresent --restart=Never --rm -it busybox -- shIf you don&#x27;t see a command prompt, try pressing enter./ # nslookup kubernetes.default.svc.cluster.localServer: 10.96.0.10Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.localName: kubernetes.default.svc.cluster.localAddress 1: 10.96.0.1 kubernetes.default.svc.cluster.local 注意:busybox要用指定的1.28版本，不能用最新版本，最新版本，nslookup会解析不到dns和ip 11、kubeadm初始化k8s证书过期解决方案 - centos07-12 注意：更新证书或重启组件，会影响业务，最好先更新 查看证书有效时间：12openssl x509 -in /etc/kubernetes/pki/ca.crt -noout -text |grep Notopenssl x509 -in /etc/kubernetes/pki/apiserver.crt -noout -text |grep Not 12345678# 10年ca.crt[root@centos07-12 ~]# openssl x509 -in /etc/kubernetes/pki/ca.crt -noout -text |grep Not Not Before: Nov 30 08:09:20 2023 GMT Not After : Nov 27 08:09:20 2033 GMT# 1年apiserver.crt[root@centos07-12 ~]# openssl x509 -in /etc/kubernetes/pki/apiserver.crt -noout -text |grep Not Not Before: Nov 30 08:09:20 2023 GMT Not After : Nov 29 08:09:21 2024 GMT 延长证书过期时间 1.把update-kubeadm-cert.sh文件上传到centos07-12节点 1scp update-kubeadm-cert.sh root@192.168.1.12:~ 2.在centos07-12上执行如下： 1）给update-kubeadm-cert.sh证书授权可执行权限1chmod +x update-kubeadm-cert.sh 2）执行下面命令，修改证书过期时间，把时间延长到10年1./update-kubeadm-cert.sh all 3）在centos07-12节点查询Pod是否正常,能查询出数据说明证书签发完成1kubectl get pods -n kube-system 4）再次查看证书有效期，可以看到会延长到10年1234567[root@centos07-12 ~]# openssl x509 -in /etc/kubernetes/pki/ca.crt -noout -text |grep Not Not Before: Nov 30 08:09:20 2023 GMT Not After : Nov 27 08:09:20 2033 GMT [root@centos07-12 ~]# openssl x509 -in /etc/kubernetes/pki/apiserver.crt -noout -text |grep Not Not Before: Nov 30 11:13:01 2023 GMT Not After : Nov 27 11:13:01 2033 GMT","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"04-安装K8S可视化UI界面Dashboard","slug":"运维/K8S/基础/04-安装K8S可视化UI界面Dashboard","date":"2023-05-02T12:00:50.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2023/05/02/运维/K8S/基础/04-安装K8S可视化UI界面Dashboard/","link":"","permalink":"https://dbbruce.github.io/2023/05/02/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/04-%E5%AE%89%E8%A3%85K8S%E5%8F%AF%E8%A7%86%E5%8C%96UI%E7%95%8C%E9%9D%A2Dashboard/","excerpt":"1、安装dashboard安装dashboard - centos07-22&#x2F;42 把安装kubernetes-dashboard需要的镜像上传到工作节点centos07-22和centos07-42，手动解压：12scp dashboard_2_0_0.tar.gz metrics-scrapter-1-0-1.tar.gz root@192.168.1.22:~scp dashboard_2_0_0.tar.gz metrics-scrapter-1-0-1.tar.gz root@192.168.1.42:~ 12docker load -i dashboard_2_0_0.tar.gzdocker load -i metrics-scrapter-1-0-1.tar.gz","text":"1、安装dashboard安装dashboard - centos07-22&#x2F;42 把安装kubernetes-dashboard需要的镜像上传到工作节点centos07-22和centos07-42，手动解压：12scp dashboard_2_0_0.tar.gz metrics-scrapter-1-0-1.tar.gz root@192.168.1.22:~scp dashboard_2_0_0.tar.gz metrics-scrapter-1-0-1.tar.gz root@192.168.1.42:~ 12docker load -i dashboard_2_0_0.tar.gzdocker load -i metrics-scrapter-1-0-1.tar.gz 安装dashboard组件 - centos07-12 在centos07-12节点操作如下命令: kubectl apply -f kubernetes-dashboard.yaml 123456789101112131415[root@centos07-12 ~]# kubectl apply -f kubernetes-dashboard.yamlnamespace/kubernetes-dashboard createdserviceaccount/kubernetes-dashboard createdservice/kubernetes-dashboard createdsecret/kubernetes-dashboard-certs createdsecret/kubernetes-dashboard-csrf createdsecret/kubernetes-dashboard-key-holder createdconfigmap/kubernetes-dashboard-settings createdrole.rbac.authorization.k8s.io/kubernetes-dashboard createdclusterrole.rbac.authorization.k8s.io/kubernetes-dashboard createdrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard createdclusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard createddeployment.apps/kubernetes-dashboard createdservice/dashboard-metrics-scraper createddeployment.apps/dashboard-metrics-scraper created 查看集群部署了哪些应用: kubectl get pods -A1234567891011121314151617[root@centos07-12 ~]# kubectl get pods -ANAMESPACE NAME READY STATUS RESTARTS AGEkube-system calico-kube-controllers-6949477b58-22zbl 1/1 Running 3 141mkube-system calico-node-9hqdh 1/1 Running 2 141mkube-system calico-node-vxjkc 1/1 Running 13 141mkube-system calico-node-z6p24 1/1 Running 8 141mkube-system coredns-7f89b7bc75-lt6lr 1/1 Running 1 3h47mkube-system coredns-7f89b7bc75-q5sz7 1/1 Running 1 3h47mkube-system etcd-centos07-12 1/1 Running 1 3h47mkube-system kube-apiserver-centos07-12 1/1 Running 1 3h47mkube-system kube-controller-manager-centos07-12 1/1 Running 3 3h47mkube-system kube-proxy-cskcq 1/1 Running 1 3h8mkube-system kube-proxy-mc5sv 1/1 Running 1 3h47mkube-system kube-proxy-ndz4x 1/1 Running 1 3h8mkube-system kube-scheduler-centos07-12 1/1 Running 3 3h47mkubernetes-dashboard dashboard-metrics-scraper-7445d59dfd-lxkzr 1/1 Running 0 8m40skubernetes-dashboard kubernetes-dashboard-54f5b6dc4b-zvl2k 1/1 Running 0 8m42s 查看dashboard的状态 -centos07-12 kubectl get pods -n kubernetes-dashboard 123456[root@centos07-12 ~]# kubectl get pods -n kubernetes-dashboard# 显示如下，说明dashboard安装成功了NAME READY STATUS RESTARTS AGEdashboard-metrics-scraper-7445d59dfd-lxkzr 1/1 Running 0 63skubernetes-dashboard-54f5b6dc4b-zvl2k 1/1 Running 0 65s 查看dashboard前端的service kubectl get svc -n kubernetes-dashboard修改service type类型变成NodePort把type: ClusterIP 变成 type: NodePort，保存退出即可。 修改前 - type：ClusterIP12345# 查看指定名称空间的service信息[root@centos07-12 ~]# kubectl get svc -n kubernetes-dashboardNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGEdashboard-metrics-scraper ClusterIP 10.100.127.24 &lt;none&gt; 8000/TCP 2m34skubernetes-dashboard ClusterIP 10.106.111.83 &lt;none&gt; 443/TCP 2m36s 修改service type类型变成NodePort12345678# 辑修改servicekubectl edit svc kubernetes-dashboard -n kubernetes-dashboard 28 selector: 29 k8s-app: kubernetes-dashboard 30 sessionAffinity: None 31 type: ClusterIP # 这里改为NodePort，保存wq 32 status: 修改后1234[root@centos07-12 ~]# kubectl get svc -n kubernetes-dashboardNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGEdashboard-metrics-scraper ClusterIP 10.100.127.24 &lt;none&gt; 8000/TCP 16mkubernetes-dashboard NodePort 10.106.111.83 &lt;none&gt; 443:30089/TCP 16m 上面可看到service类型是NodePort，访问任何一个工作节点ip:30089端口即可访问kubernetes dashboard，在浏览器(使用火狐浏览器)访问如下地址:https://192.168.1.12:30089 https://192.168.1.22:30089 https://192.168.1.32:30089 都能访问 chrome解决 “您的连接不是私密连接” 问题 解决办法：在chrome该页面上，在当前页面（也就是上图页面）注意是在当前页面打开的时候点网页任意地方，不是输入框，直接输入thisisunsafe回车，直接就打开页面了点击页面，直接输入”thisisunsafe” + 回车；在输入是完全看不到任何反应，必须回车后，才会看到页面刷新重新载入，跳过安全验证了； 2、通过token令牌访问dashboard查看 sa SA简介K8S自动为每个Pod注入一个 ServiceAccount 及 配套的令牌在每个名称空间中，会自动存在(由ServiceAccount准入控制器负责)一个ServiceAccount，将被该空间下的每个Pod共享使用。认证令牌保存于该空间下的一个Secret对象中，该对象中共有三个信息：namespace、ca.crt、token 1234kubectl get sa -n kubernetes-dashboardNAME SECRETS AGEdefault 1 177mkubernetes-dashboard 1 177m vim kubernetes-dashboard.yaml 创建管理员token，具有查看任何空间的权限，可以管理所有资源对象12# 把命名空间kubernetes-dashboard下的kubernetes-dashboard绑定到clusterrole的cluster-admin(超级管理员权限)kubectl create clusterrolebinding dashboard-cluster-admin --clusterrole=cluster-admin --serviceaccount=kubernetes-dashboard:kubernetes-dashboard 12[root@centos07-12 ~]# kubectl create clusterrolebinding dashboard-cluster-admin --clusterrole=cluster-admin --serviceaccount=kubernetes-dashboard:kubernetes-dashboardclusterrolebinding.rbac.authorization.k8s.io/dashboard-cluster-admin created 查看kubernetes-dashboard名称空间下的secret kubectl get secret -n kubernetes-dashboard 1234567[root@centos07-12 ~]# kubectl get secret -n kubernetes-dashboardNAME TYPE DATA AGEdefault-token-sn4lg kubernetes.io/service-account-token 3 3h24mkubernetes-dashboard-certs Opaque 0 3h24mkubernetes-dashboard-csrf Opaque 1 3h24mkubernetes-dashboard-key-holder Opaque 2 3h24mkubernetes-dashboard-token-8lvdn kubernetes.io/service-account-token 3 3h24m 找到对应的带有token的kubernetes-dashboard-token-8lvdn kubectl describe secret kubernetes-dashboard-token-8lvdn -n kubernetes-dashboard 1234567891011121314[root@centos07-12 ~]# kubectl describe secret kubernetes-dashboard-token-8lvdn -n kubernetes-dashboardName: kubernetes-dashboard-token-8lvdnNamespace: kubernetes-dashboardLabels: &lt;none&gt;Annotations: kubernetes.io/service-account.name: kubernetes-dashboard kubernetes.io/service-account.uid: adc41318-9bfd-4a9b-9629-8ea1122615d6Type: kubernetes.io/service-account-tokenData====ca.crt: 1066 bytesnamespace: 20 bytestoken: eyJhbGciOiJSUzI1NiIsImtpZCI6IkpUUlZENnZKcEVjZVNfODlHZDBQOTdOSFc5LWhILUFiUHlGSTEwck9NYUUifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC10b2tlbi04bHZkbiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImFkYzQxMzE4LTliZmQtNGE5Yi05NjI5LThlYTExMjI2MTVkNiIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDprdWJlcm5ldGVzLWRhc2hib2FyZCJ9.MQ2tZXtN-BYZ5uO0Kp0g2e2IPVhnUR-y9NtVpszi_gpUF6PcqVg0nmFTV-YZuohfRkQszzXFIiMOYMBb9fq8893ypjbfEIFGh0D_RaU1ysQNvMCRbm9fMrMWHBM95EJd4EaIeXooFfl4Ao9J-9iKvSBu2aVCNUXQE3NJ4nyTClgXyVdfdfw4lazc56SlVdAI16utq0rAzc7zGa6nJv9zJR1gAKZ67ndb2rIthPyePFE-13kFetM3CIu0RpbJ0j5Zoq6LkmJHp_pjPw270KiAkzdlhZ-dw5-i3CVrPfboa7AW6f6SO-QVEbm0E17dfEMudAxBJDOBJ8_4ISXJ4FIL0g 记住token后面的值，把下面的token值复制到浏览器token登陆处即可登陆： 3、通过kubeconfig文件访问dashboard创建cluster集群 注意：替换自己的server地址 cd &#x2F;etc&#x2F;kubernetes&#x2F;pki kubectl config set-cluster kubernetes –certificate-authority&#x3D;.&#x2F;ca.crt –server&#x3D;”https://192.168.1.12:30089“ –embed-certs&#x3D;true –kubeconfig&#x3D;&#x2F;root&#x2F;dashboard-admin.conf cat -n &#x2F;root&#x2F;dashboard-admin.conf 1234567891011121314151617[root@centos07-12 ~]# cd /etc/kubernetes/pki[root@centos07-12 pki]# kubectl config set-cluster kubernetes --certificate-authority=./ca.crt --server=&quot;https://192.168.1.12:30089&quot; --embed-certs=true --kubeconfig=/root/dashboard-admin.confCluster &quot;kubernetes&quot; set.[root@centos07-12 pki]# cat -n /root/dashboard-admin.conf 1 apiVersion: v1 2 clusters: 3 - cluster: 4 certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM1ekNDQWMrZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJek1URXpNREE0TURreU1Gb1hEVE16TVRFeU56QTRNRGt5TUZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTnMrCmEzd2NwL3UrN3U1enlNdnl1ZzRtTUJ1dk5HaVFDeDZOZFFmeEZ2dWhJL1QzdUpFVTJ4anJCZk5HZXI1MjRQUEIKNUhmVERsT0hWdjErRFdCNnU0VXI0UUlueEwwMVpLSzlURndFd0dLbG1URE5EdDRhNE15SXZqY3NGSWdRRjZnbgpNdmJuS0ltV3J2YldVRkRPS01EdUo2b1lwdWFTUHU3NUZzMDVjYWloTGwwY1FtbEJaeVRaRUVPZWh3alhIaVFvCkViVnFKaG1xRWI1VXRGWTAzY0lyQ3EyRkd0bGsySGhQWWpwWTNYdWlMNDBkalpseU11em1nZ2FmelFmZ1B4WjYKczcvMFhxNjJMUExRVXRGZlRrU2JwYkI3NnpJenE4bVlvTkN3dnJiemdkM21ZRStnd0dVNjRZZzRMUXFwT3ZhcgpsOWtJVXNnekI0NVU4S0JlZC8wQ0F3RUFBYU5DTUVBd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZIbHJYdkRzNzFZbW1DUGF2NFlSZW01MzBsMk5NQTBHQ1NxR1NJYjMKRFFFQkN3VUFBNElCQVFBRDFsMUtXU3lkcmZmNCtUcWFlOTRtT3AzWjlwTUJmQXBGVzlKYXpIc0RWbCtWNmxKTwp1bGFLZ21QbFlxNkhkMHUrRUVwYldlUmN1L2gwaWlVTU0wcHA3dEJoZ3YrcEhpMDBkallLSXF6U2xYNlF4bHA1CnhzWEhGN1htWW9MV1FENUdQTmtNWVpUMUViSDNoU1dwWkFWL09CSU5TZEdvejVFRDBwRkxkWFhETUlsbGN5ek8KMXBmQzdMVENEZERkVEIxOUI4Y0JHdVZEOU9iL1dwSitSeFBoVDlMblZVQzFrVk5jNTllSGNSb0RBSXdPeW1LdAp3VTR5QXNWWXB6a0V0TEVqODBYOUdSRkVtT01JYko5MHRvbmhzdFFINTZraCt3ak4ySWZQOGhwSjYxcURuSzFtCkVhNjBXbll3NktSZlFkaG16NXpRRzNMYXhoWkZUNHA2bzRKZgotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg== 5 server: https://192.168.1.12:30089 6 name: kubernetes 7 contexts: null 8 current-context: &quot;&quot; 9 kind: Config 10 preferences: &#123;&#125; 11 users: null 创建credentials 创建credentials需要使用上面的kubernetes-dashboard-token-ppc8c对应的token信息注意：替换下自己的token：DEF_NS_ADMIN_TOKEN&#x3D;$(kubectl get secret kubernetes-dashboard-token-8lvdn -n kubernetes-dashboard -o jsonpath&#x3D;{.data.token}|base64 -d)kubectl config set-credentials dashboard-admin –token&#x3D;$DEF_NS_ADMIN_TOKEN –kubeconfig&#x3D;&#x2F;root&#x2F;dashboard-admin.confcat -n &#x2F;root&#x2F;dashboard-admin.conf 12345678910111213141516171819202122232425262728293031[root@centos07-12 pki]# kubectl get secret -n kubernetes-dashboardNAME TYPE DATA AGEdefault-token-sn4lg kubernetes.io/service-account-token 3 19hkubernetes-dashboard-certs Opaque 0 19hkubernetes-dashboard-csrf Opaque 1 19hkubernetes-dashboard-key-holder Opaque 2 19hkubernetes-dashboard-token-8lvdn kubernetes.io/service-account-token 3 19h[root@centos07-12 pki]# DEF_NS_ADMIN_TOKEN=$(kubectl get secret kubernetes-dashboard-token-8lvdn -n kubernetes-dashboard -o jsonpath=&#123;.data.token&#125;|base64 -d)[root@centos07-12 pki]# echo $DEF_NS_ADMIN_TOKENeyJhbGciOiJSUzI1NiIsImtpZCI6IkpUUlZENnZKcEVjZVNfODlHZDBQOTdOSFc5LWhILUFiUHlGSTEwck9NYUUifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC10b2tlbi04bHZkbiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImFkYzQxMzE4LTliZmQtNGE5Yi05NjI5LThlYTExMjI2MTVkNiIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDprdWJlcm5ldGVzLWRhc2hib2FyZCJ9.MQ2tZXtN-BYZ5uO0Kp0g2e2IPVhnUR-y9NtVpszi_gpUF6PcqVg0nmFTV-YZuohfRkQszzXFIiMOYMBb9fq8893ypjbfEIFGh0D_RaU1ysQNvMCRbm9fMrMWHBM95EJd4EaIeXooFfl4Ao9J-9iKvSBu2aVCNUXQE3NJ4nyTClgXyVdfdfw4lazc56SlVdAI16utq0rAzc7zGa6nJv9zJR1gAKZ67ndb2rIthPyePFE-13kFetM3CIu0RpbJ0j5Zoq6LkmJHp_pjPw270KiAkzdlhZ-dw5-i3CVrPfboa7AW6f6SO-QVEbm0E17dfEMudAxBJDOBJ8_4ISXJ4FIL0g[root@centos07-12 pki]# kubectl config set-credentials dashboard-admin --token=$DEF_NS_ADMIN_TOKEN --kubeconfig=/root/dashboard-admin.confUser &quot;dashboard-admin&quot; set.[root@centos07-12 pki]# cat -n /root/dashboard-admin.conf 1 apiVersion: v1 2 clusters: 3 - cluster: 4 certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM1ekNDQWMrZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJek1URXpNREE0TURreU1Gb1hEVE16TVRFeU56QTRNRGt5TUZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTnMrCmEzd2NwL3UrN3U1enlNdnl1ZzRtTUJ1dk5HaVFDeDZOZFFmeEZ2dWhJL1QzdUpFVTJ4anJCZk5HZXI1MjRQUEIKNUhmVERsT0hWdjErRFdCNnU0VXI0UUlueEwwMVpLSzlURndFd0dLbG1URE5EdDRhNE15SXZqY3NGSWdRRjZnbgpNdmJuS0ltV3J2YldVRkRPS01EdUo2b1lwdWFTUHU3NUZzMDVjYWloTGwwY1FtbEJaeVRaRUVPZWh3alhIaVFvCkViVnFKaG1xRWI1VXRGWTAzY0lyQ3EyRkd0bGsySGhQWWpwWTNYdWlMNDBkalpseU11em1nZ2FmelFmZ1B4WjYKczcvMFhxNjJMUExRVXRGZlRrU2JwYkI3NnpJenE4bVlvTkN3dnJiemdkM21ZRStnd0dVNjRZZzRMUXFwT3ZhcgpsOWtJVXNnekI0NVU4S0JlZC8wQ0F3RUFBYU5DTUVBd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZIbHJYdkRzNzFZbW1DUGF2NFlSZW01MzBsMk5NQTBHQ1NxR1NJYjMKRFFFQkN3VUFBNElCQVFBRDFsMUtXU3lkcmZmNCtUcWFlOTRtT3AzWjlwTUJmQXBGVzlKYXpIc0RWbCtWNmxKTwp1bGFLZ21QbFlxNkhkMHUrRUVwYldlUmN1L2gwaWlVTU0wcHA3dEJoZ3YrcEhpMDBkallLSXF6U2xYNlF4bHA1CnhzWEhGN1htWW9MV1FENUdQTmtNWVpUMUViSDNoU1dwWkFWL09CSU5TZEdvejVFRDBwRkxkWFhETUlsbGN5ek8KMXBmQzdMVENEZERkVEIxOUI4Y0JHdVZEOU9iL1dwSitSeFBoVDlMblZVQzFrVk5jNTllSGNSb0RBSXdPeW1LdAp3VTR5QXNWWXB6a0V0TEVqODBYOUdSRkVtT01JYko5MHRvbmhzdFFINTZraCt3ak4ySWZQOGhwSjYxcURuSzFtCkVhNjBXbll3NktSZlFkaG16NXpRRzNMYXhoWkZUNHA2bzRKZgotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg== 5 server: https://192.168.1.12:30089 6 name: kubernetes 7 contexts: null 8 current-context: &quot;&quot; 9 kind: Config 10 preferences: &#123;&#125; 11 users: 12 - name: dashboard-admin 13 user: 14 token: eyJhbGciOiJSUzI1NiIsImtpZCI6IkpUUlZENnZKcEVjZVNfODlHZDBQOTdOSFc5LWhILUFiUHlGSTEwck9NYUUifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC10b2tlbi04bHZkbiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImFkYzQxMzE4LTliZmQtNGE5Yi05NjI5LThlYTExMjI2MTVkNiIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDprdWJlcm5ldGVzLWRhc2hib2FyZCJ9.MQ2tZXtN-BYZ5uO0Kp0g2e2IPVhnUR-y9NtVpszi_gpUF6PcqVg0nmFTV-YZuohfRkQszzXFIiMOYMBb9fq8893ypjbfEIFGh0D_RaU1ysQNvMCRbm9fMrMWHBM95EJd4EaIeXooFfl4Ao9J-9iKvSBu2aVCNUXQE3NJ4nyTClgXyVdfdfw4lazc56SlVdAI16utq0rAzc7zGa6nJv9zJR1gAKZ67ndb2rIthPyePFE-13kFetM3CIu0RpbJ0j5Zoq6LkmJHp_pjPw270KiAkzdlhZ-dw5-i3CVrPfboa7AW6f6SO-QVEbm0E17dfEMudAxBJDOBJ8_4ISXJ4FIL0g 创建context kubectl config set-context dashboard-admin@kubernetes –cluster&#x3D;kubernetes –user&#x3D;dashboard-admin –kubeconfig&#x3D;&#x2F;root&#x2F;dashboard-admin.conf cat -n &#x2F;root&#x2F;dashboard-admin.conf 12345678910111213141516171819202122[root@centos07-12 pki]# kubectl config set-context dashboard-admin@kubernetes --cluster=kubernetes --user=dashboard-admin --kubeconfig=/root/dashboard-admin.confContext &quot;dashboard-admin@kubernetes&quot; created.[root@centos07-12 pki]# cat -n /root/dashboard-admin.conf 1 apiVersion: v1 2 clusters: 3 - cluster: 4 certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM1ekNDQWMrZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJek1URXpNREE0TURreU1Gb1hEVE16TVRFeU56QTRNRGt5TUZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTnMrCmEzd2NwL3UrN3U1enlNdnl1ZzRtTUJ1dk5HaVFDeDZOZFFmeEZ2dWhJL1QzdUpFVTJ4anJCZk5HZXI1MjRQUEIKNUhmVERsT0hWdjErRFdCNnU0VXI0UUlueEwwMVpLSzlURndFd0dLbG1URE5EdDRhNE15SXZqY3NGSWdRRjZnbgpNdmJuS0ltV3J2YldVRkRPS01EdUo2b1lwdWFTUHU3NUZzMDVjYWloTGwwY1FtbEJaeVRaRUVPZWh3alhIaVFvCkViVnFKaG1xRWI1VXRGWTAzY0lyQ3EyRkd0bGsySGhQWWpwWTNYdWlMNDBkalpseU11em1nZ2FmelFmZ1B4WjYKczcvMFhxNjJMUExRVXRGZlRrU2JwYkI3NnpJenE4bVlvTkN3dnJiemdkM21ZRStnd0dVNjRZZzRMUXFwT3ZhcgpsOWtJVXNnekI0NVU4S0JlZC8wQ0F3RUFBYU5DTUVBd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZIbHJYdkRzNzFZbW1DUGF2NFlSZW01MzBsMk5NQTBHQ1NxR1NJYjMKRFFFQkN3VUFBNElCQVFBRDFsMUtXU3lkcmZmNCtUcWFlOTRtT3AzWjlwTUJmQXBGVzlKYXpIc0RWbCtWNmxKTwp1bGFLZ21QbFlxNkhkMHUrRUVwYldlUmN1L2gwaWlVTU0wcHA3dEJoZ3YrcEhpMDBkallLSXF6U2xYNlF4bHA1CnhzWEhGN1htWW9MV1FENUdQTmtNWVpUMUViSDNoU1dwWkFWL09CSU5TZEdvejVFRDBwRkxkWFhETUlsbGN5ek8KMXBmQzdMVENEZERkVEIxOUI4Y0JHdVZEOU9iL1dwSitSeFBoVDlMblZVQzFrVk5jNTllSGNSb0RBSXdPeW1LdAp3VTR5QXNWWXB6a0V0TEVqODBYOUdSRkVtT01JYko5MHRvbmhzdFFINTZraCt3ak4ySWZQOGhwSjYxcURuSzFtCkVhNjBXbll3NktSZlFkaG16NXpRRzNMYXhoWkZUNHA2bzRKZgotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg== 5 server: https://192.168.1.12:30089 6 name: kubernetes 7 contexts: 8 - context: 9 cluster: kubernetes 10 user: dashboard-admin 11 name: dashboard-admin@kubernetes 12 current-context: &quot;&quot; 13 kind: Config 14 preferences: &#123;&#125; 15 users: 16 - name: dashboard-admin 17 user: 18 token: eyJhbGciOiJSUzI1NiIsImtpZCI6IkpUUlZENnZKcEVjZVNfODlHZDBQOTdOSFc5LWhILUFiUHlGSTEwck9NYUUifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC10b2tlbi04bHZkbiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImFkYzQxMzE4LTliZmQtNGE5Yi05NjI5LThlYTExMjI2MTVkNiIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDprdWJlcm5ldGVzLWRhc2hib2FyZCJ9.MQ2tZXtN-BYZ5uO0Kp0g2e2IPVhnUR-y9NtVpszi_gpUF6PcqVg0nmFTV-YZuohfRkQszzXFIiMOYMBb9fq8893ypjbfEIFGh0D_RaU1ysQNvMCRbm9fMrMWHBM95EJd4EaIeXooFfl4Ao9J-9iKvSBu2aVCNUXQE3NJ4nyTClgXyVdfdfw4lazc56SlVdAI16utq0rAzc7zGa6nJv9zJR1gAKZ67ndb2rIthPyePFE-13kFetM3CIu0RpbJ0j5Zoq6LkmJHp_pjPw270KiAkzdlhZ-dw5-i3CVrPfboa7AW6f6SO-QVEbm0E17dfEMudAxBJDOBJ8_4ISXJ4FIL0g 切换context的current-context是dashboard-admin@kubernetes kubectl config use-context dashboard-admin@kubernetes –kubeconfig&#x3D;&#x2F;root&#x2F;dashboard-admin.conf cat &#x2F;root&#x2F;dashboard-admin.conf 12345678910111213141516171819202122[root@centos07-12 pki]# kubectl config use-context dashboard-admin@kubernetes --kubeconfig=/root/dashboard-admin.confSwitched to context &quot;dashboard-admin@kubernetes&quot;.[root@centos07-12 pki]# cat /root/dashboard-admin.confapiVersion: v1clusters:- cluster: certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM1ekNDQWMrZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJek1URXpNREE0TURreU1Gb1hEVE16TVRFeU56QTRNRGt5TUZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTnMrCmEzd2NwL3UrN3U1enlNdnl1ZzRtTUJ1dk5HaVFDeDZOZFFmeEZ2dWhJL1QzdUpFVTJ4anJCZk5HZXI1MjRQUEIKNUhmVERsT0hWdjErRFdCNnU0VXI0UUlueEwwMVpLSzlURndFd0dLbG1URE5EdDRhNE15SXZqY3NGSWdRRjZnbgpNdmJuS0ltV3J2YldVRkRPS01EdUo2b1lwdWFTUHU3NUZzMDVjYWloTGwwY1FtbEJaeVRaRUVPZWh3alhIaVFvCkViVnFKaG1xRWI1VXRGWTAzY0lyQ3EyRkd0bGsySGhQWWpwWTNYdWlMNDBkalpseU11em1nZ2FmelFmZ1B4WjYKczcvMFhxNjJMUExRVXRGZlRrU2JwYkI3NnpJenE4bVlvTkN3dnJiemdkM21ZRStnd0dVNjRZZzRMUXFwT3ZhcgpsOWtJVXNnekI0NVU4S0JlZC8wQ0F3RUFBYU5DTUVBd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZIbHJYdkRzNzFZbW1DUGF2NFlSZW01MzBsMk5NQTBHQ1NxR1NJYjMKRFFFQkN3VUFBNElCQVFBRDFsMUtXU3lkcmZmNCtUcWFlOTRtT3AzWjlwTUJmQXBGVzlKYXpIc0RWbCtWNmxKTwp1bGFLZ21QbFlxNkhkMHUrRUVwYldlUmN1L2gwaWlVTU0wcHA3dEJoZ3YrcEhpMDBkallLSXF6U2xYNlF4bHA1CnhzWEhGN1htWW9MV1FENUdQTmtNWVpUMUViSDNoU1dwWkFWL09CSU5TZEdvejVFRDBwRkxkWFhETUlsbGN5ek8KMXBmQzdMVENEZERkVEIxOUI4Y0JHdVZEOU9iL1dwSitSeFBoVDlMblZVQzFrVk5jNTllSGNSb0RBSXdPeW1LdAp3VTR5QXNWWXB6a0V0TEVqODBYOUdSRkVtT01JYko5MHRvbmhzdFFINTZraCt3ak4ySWZQOGhwSjYxcURuSzFtCkVhNjBXbll3NktSZlFkaG16NXpRRzNMYXhoWkZUNHA2bzRKZgotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg== server: https://192.168.1.12:30089 name: kubernetescontexts:- context: cluster: kubernetes user: dashboard-admin name: dashboard-admin@kubernetescurrent-context: dashboard-admin@kuberneteskind: Configpreferences: &#123;&#125;users:- name: dashboard-admin user: token: eyJhbGciOiJSUzI1NiIsImtpZCI6IkpUUlZENnZKcEVjZVNfODlHZDBQOTdOSFc5LWhILUFiUHlGSTEwck9NYUUifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC10b2tlbi04bHZkbiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImFkYzQxMzE4LTliZmQtNGE5Yi05NjI5LThlYTExMjI2MTVkNiIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDprdWJlcm5ldGVzLWRhc2hib2FyZCJ9.MQ2tZXtN-BYZ5uO0Kp0g2e2IPVhnUR-y9NtVpszi_gpUF6PcqVg0nmFTV-YZuohfRkQszzXFIiMOYMBb9fq8893ypjbfEIFGh0D_RaU1ysQNvMCRbm9fMrMWHBM95EJd4EaIeXooFfl4Ao9J-9iKvSBu2aVCNUXQE3NJ4nyTClgXyVdfdfw4lazc56SlVdAI16utq0rAzc7zGa6nJv9zJR1gAKZ67ndb2rIthPyePFE-13kFetM3CIu0RpbJ0j5Zoq6LkmJHp_pjPw270KiAkzdlhZ-dw5-i3CVrPfboa7AW6f6SO-QVEbm0E17dfEMudAxBJDOBJ8_4ISXJ4FIL0g 把刚才的kubeconfig文件dashboard-admin.conf复制到桌面，使用kubeconfig登录 4、通过kubernetes-dashboard创建容器 把nginx.tar.gz镜像压缩包上传到centos07-22和centos07-42上，手动解压：docker load -i nginx.tar.gz 12[root@centos07-22 ~]# docker load -i nginx.tar.gz[root@centos07-42 ~]# docker load -i nginx.tar.gz 创建容器 应用名称：nginx容器镜像：nginxpod数量：2service： external 外部网络port：80targetport：80注：表单中创建pod时没有创建nodeport的选项，会自动创建在30000+以上的端口。关于port、targetport、nodeport的说明：nodeport是集群外流量访问集群内服务的端口，比如客户访问nginx，apache，port是集群内的pod互相通信用的端口类型，比如nginx访问mysql，而mysql是不需要让客户访问到的，port是service的的端口targetport目标端口，也就是最终端口，也就是pod的端口。 在dashboard的左侧选择Services 上图可看到刚才创建的nginx的service在宿主机映射的端口是30107，在浏览器访问：http://192.168.1.12:30107/","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"03-kubeadm安装单master多node节点k8s-1.20.6集群","slug":"运维/K8S/基础/03-kubeadm安装单master多node节点k8s-1.20.6集群","date":"2023-05-02T02:00:52.000Z","updated":"2023-12-05T10:24:35.000Z","comments":true,"path":"2023/05/02/运维/K8S/基础/03-kubeadm安装单master多node节点k8s-1.20.6集群/","link":"","permalink":"https://dbbruce.github.io/2023/05/02/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/03-kubeadm%E5%AE%89%E8%A3%85%E5%8D%95master%E5%A4%9Anode%E8%8A%82%E7%82%B9k8s-1.20.6%E9%9B%86%E7%BE%A4/","excerpt":"网段注意项，3个网段一定不能有冲突 podSubnet（pod网段） 10.244.0.0&#x2F;16 serviceSubnet（service网段）: 10.96.0.0&#x2F;16物理机网段：192.168.40.0&#x2F;24 实验环境规划 k8s角色 ip 主机名 安装组件 控制节点 192.168.1.12 centos07-12 apiserver、ontroller-manager、 scheduler、 etcd、 docker、 kubeproxy 、calico 工作节点 192.168.1.22 centos07-22 kubelet、kube-proxy、docker、calico、coredns 工作节点 192.168.1.42 centos07-42 kubelet、kube-proxy、docker、calico、coredns","text":"网段注意项，3个网段一定不能有冲突 podSubnet（pod网段） 10.244.0.0&#x2F;16 serviceSubnet（service网段）: 10.96.0.0&#x2F;16物理机网段：192.168.40.0&#x2F;24 实验环境规划 k8s角色 ip 主机名 安装组件 控制节点 192.168.1.12 centos07-12 apiserver、ontroller-manager、 scheduler、 etcd、 docker、 kubeproxy 、calico 工作节点 192.168.1.22 centos07-22 kubelet、kube-proxy、docker、calico、coredns 工作节点 192.168.1.42 centos07-42 kubelet、kube-proxy、docker、calico、coredns 1、初始化安装k8s集群的实验环境1.1 修改机器IP，变成静态IP - centos07-12&#x2F;22&#x2F;421234567891011121314151617181920vim /etc/sysconfig/network-scripts/ifcfg-enp0s3TYPE=EthernetPROXY_METHOD=noneBROWSER_ONLY=noBOOTPROTO=staticIPADDR=192.168.1.12NETMASK=255.255.255.0GATEWAY=192.168.1.1DNS1=192.168.1.1DEFROUTE=yesIPV4_FAILURE_FATAL=noIPV6INIT=yesIPV6_AUTOCONF=yesIPV6_DEFROUTE=yesIPV6_FAILURE_FATAL=noIPV6_ADDR_GEN_MODE=stable-privacyNAME=enp0s3DEVICE=enp0s3ONBOOT=yes 修改配置文件之后需要重启网络服务才能使配置生效，重启网络服务命令如下1service network restart 注：&#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-enp0s3文件里的配置说明：NAME&#x3D;enp0s3 #网卡名字，跟DEVICE名字保持一致即可DEVICE&#x3D;enp0s3 #网卡设备名，大家ip addr可看到自己的这个网卡设备名，每个人的机器可能这个名字不一样，需要写自己的BOOTPROTO&#x3D;static #static表示静态ip地址ONBOOT&#x3D;yes #开机自启动网络，必须是yesIPADDR&#x3D;192.168.1.12 #ip地址，需要跟自己电脑所在网段一致NETMASK&#x3D;255.255.255.0 #子网掩码，需要跟自己电脑所在网段一致GATEWAY&#x3D;192.168.1.1 #网关，在自己电脑打开cmd，输入ipconfig &#x2F;all可看到DNS1&#x3D;192.168.1.1 #DNS，在自己电脑打开cmd，输入ipconfig &#x2F;all可看到 1.2 关闭selinux - centos07-12&#x2F;22&#x2F;42 #修改selinux配置文件之后，重启机器，selinux配置才能永久生效 1sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config reboot-n : 在重开机前不做将记忆体资料写回硬盘的动作-w : 并不会真的重开机，只是把记录写到 &#x2F;var&#x2F;log&#x2F;wtmp 档案里-d : 不把记录写到 &#x2F;var&#x2F;log&#x2F;wtmp 档案里（-n 这个参数包含了 -d）-f : 强迫重开机，不呼叫 shutdown 这个指令-i : 在重开机之前先把所有网络相关的装置先停止 1reboot -f 显示Disabled说明selinux已经关闭 1getenforce 1.3 配置机器主机名 - centos07-12&#x2F;22&#x2F;42123hostnamectl set-hostname centos07-12 &amp;&amp; bash hostnamectl set-hostname centos07-22 &amp;&amp; bash hostnamectl set-hostname centos07-42 &amp;&amp; bash 1.4 升级操作系统，k8s集群每台机器都操作 - centos07-12&#x2F;22&#x2F;421yum update -y 1.5 配置主机hosts文件，相互之间通过主机名互相访问 - centos07-12&#x2F;22&#x2F;42 修改每台机器的&#x2F;etc&#x2F;hosts文件，增加如下三行： 12345vim /etc/hosts192.168.1.12 centos07-12 192.168.1.22 centos07-22 192.168.1.42 centos07-42 1.6 配置主机之间无密码登录 - centos07-12&#x2F;22&#x2F;4212345678910111213141516171819202122ssh-keygenGenerating public/private rsa key pair.Enter file in which to save the key (/root/.ssh/id_rsa):Enter passphrase (empty for no passphrase):Enter same passphrase again:Your identification has been saved in /root/.ssh/id_rsa.Your public key has been saved in /root/.ssh/id_rsa.pub.The key fingerprint is:SHA256:UWxG5OFiWTD1+Lf0Nk9ulqAcJ5vbnnDUAx7DMewR7FI root@centos07-12The key&#x27;s randomart image is:+---[RSA 2048]----+| o*B o+. || B++.Eo || =o+ ==. || . o o.o= || S oooo || o.= o.|| ..B.o.=|| =+ .==|| .o+ oo|+----[SHA256]-----+ 123ssh-copy-id centos07-12ssh-copy-id centos07-22ssh-copy-id centos07-42 1.7 关闭交换分区swap，提升性能 - centos07-12&#x2F;22&#x2F;42 K8S为了提高性能，需要关闭交换分区，swap问题1：为什么要关闭swap交换分区？ swap是交换分区，如果机器内存不够，会使用swap分区，但是swap分区的性能较低，k8s设计的时候为了能提升性能，默认是不允许使用交换分区的。Kubeadm初始化的时候会检测swap是否关闭，如果没关闭，那就初始化失败。如果不想要关闭交换分区，安装k8s的时候可以指定–ignore-preflight-errors&#x3D;Swap来解决。 临时关闭1swapoff -a 永久关闭：注释swap挂载，给swap这行开头加一下注释123vim /etc/fstab#/dev/mapper/centos-swap swap swap defaults 0 0 1.8 修改机器内核参数 - centos07-12&#x2F;22&#x2F;42 注意：加载模块报错，提示没有这个模块，centos8就没有这个模块，加载是就会报错，可以跳过加载，直接做下面的开启转发； 1modprobe br_netfilter 查看是否加载123[root@centos07-12 ~]# lsmod |grep br_netfilterbr_netfilter 22256 0bridge 151336 2 br_netfilter,ebtable_broute 123456789echo &quot;modprobe br_netfilter&quot; &gt;&gt; /etc/profilecat &gt; /etc/sysctl.d/k8s.conf &lt;&lt;EOFnet.bridge.bridge-nf-call-ip6tables = 1net.bridge.bridge-nf-call-iptables = 1net.ipv4.ip_forward = 1EOFsysctl -p /etc/sysctl.d/k8s.conf 问题1：sysctl是做什么的？ 在运行时配置内核参数，从指定的文件加载系统参数，如不指定即从&#x2F;etc&#x2F;sysctl.conf中加载问题2：为什么要执行modprobe br_netfilter？修改&#x2F;etc&#x2F;sysctl.d&#x2F;k8s.conf文件，增加如下三行参数：net.bridge.bridge-nf-call-ip6tables &#x3D; 1net.bridge.bridge-nf-call-iptables &#x3D; 1net.ipv4.ip_forward &#x3D; 1sysctl -p &#x2F;etc&#x2F;sysctl.d&#x2F;k8s.conf出现报错：sysctl: cannot stat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;bridge&#x2F;bridge-nf-call-ip6tables: No such file or directorsysctl: cannot stat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;bridge&#x2F;bridge-nf-call-iptables: No such file or directory解决方法：modprobe br_netfilter问题3：为什么开启net.bridge.bridge-nf-call-iptables内核参数？在centos下安装docker，执行docker info出现如下警告：WARNING: bridge-nf-call-iptables is disabledWARNING: bridge-nf-call-ip6tables is disabled解决办法：vim &#x2F;etc&#x2F;sysctl.d&#x2F;k8s.confnet.bridge.bridge-nf-call-ip6tables &#x3D; 1net.bridge.bridge-nf-call-iptables &#x3D; 1问题4：为什么要开启net.ipv4.ip_forward &#x3D; 1参数？kubeadm初始化k8s如果报错 ：就表示没有开启ip_forward，需要开启。net.ipv4.ip_forward是数据包转发：出于安全考虑，Linux系统默认是禁止数据包转发的。所谓转发即当主机拥有多于一块的网卡时，其中一块收到数据包，根据数据包的目的ip地址将数据包发往本机另一块要让Linux系统具有路由转发功能，需要配置一个Linux的内核参数net.ipv4.ip_forward。这个参数指定了Linux系统当前对路由转发功能的支持情况；其值为0时表示禁止进行IP转发；如果是1,则说明IP转发功能已经打开。 1.9 关闭firewalld防火墙 - centos07-12&#x2F;22&#x2F;421systemctl stop firewalld ; systemctl disable firewalld 2.0 配置阿里云的repo源 - centos07-12&#x2F;22&#x2F;42 配置国内阿里云docker的repo源 1yum install -y yum-utils 1yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo 2.1 安装基础软件 - centos07-12&#x2F;22&#x2F;421yum install -y yum-utils device-mapper-persistent-data lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel python-devel epel-release openssh-server socat ipvsadm conntrack ntpdate telnet ipvsadm 2.2 配置安装k8s组件需要的阿里云的repo源 - centos07-12&#x2F;22&#x2F;421234567vim /etc/yum.repos.d/kubernetes.repo[kubernetes]name=Kubernetesbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/enabled=1gpgcheck=0 或者通过scp把已经配置好的同步到别的机器上 12scp /etc/yum.repos.d/kubernetes.repo centos07-22:/etc/yum.repos.d/scp /etc/yum.repos.d/kubernetes.repo centos07-42:/etc/yum.repos.d/ 2.3 配置时间同步 - centos07-12&#x2F;22&#x2F;42 安装ntpdate命令1yum install ntpdate -y 跟网络时间做同步1ntpdate cn.pool.ntp.org 把时间同步做成计划任务123crontab -e* */1 * * * /usr/sbin/ntpdate cn.pool.ntp.org 重启crond服务1service crond restart 2、安装docker服务2.1 安装docker-ce - centos07-12&#x2F;22&#x2F;42 启动docker 并设置为开机启动，用一条命令就是：systemctl start docker &amp;&amp; systemctl enable docker.service systemctl enable docker –now 123yum install docker-ce-20.10.6 -ysystemctl start docker &amp;&amp; systemctl enable docker.service 2.2 配置docker镜像加速器和驱动 - centos07-12&#x2F;22&#x2F;42 修改docker文件驱动为systemd，默认为cgroupfs，kubelet默认使用systemd，两者必须一致才可以。 123456vim /etc/docker/daemon.json &#123; &quot;registry-mirrors&quot;:[&quot;https://rsbud4vc.mirror.aliyuncs.com&quot;,&quot;https://registry.docker-cn.com&quot;,&quot;https://docker.mirrors.ustc.edu.cn&quot;,&quot;https://dockerhub.azk8s.cn&quot;,&quot;http://hub-mirror.c.163.com&quot;], &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]&#125; 123systemctl daemon-reload &amp;&amp; systemctl restart dockersystemctl status docker 3、安装初始化k8s需要的软件包 - centos07-12&#x2F;22&#x2F;42 注：每个软件包的作用Kubeadm: kubeadm是一个工具，用来初始化k8s集群的kubelet: 安装在集群所有节点上，用于启动Pod的kubectl: 通过kubectl可以部署和管理应用，查看各种资源，创建、删除和更新各种组件 123yum install -y kubelet-1.20.6 kubeadm-1.20.6 kubectl-1.20.6systemctl enable kubelet 4、kubeadm初始化k8s集群 - centos07-12&#x2F;22&#x2F;42 把初始化k8s集群需要的离线镜像包上传到机器上，手动解压 1docker load -i k8simage-1-20-6.tar.gz 5、使用kubeadm初始化k8s集群 - centos07-12 根据我们自己的需求修改配置，advertiseAddress: 192.168.1.12 #控制节点的ipname: centos07-12 #控制节点主机名imageRepository: registry.aliyuncs.com&#x2F;google_containers # 修改 imageRepository 的值kubernetesVersion: v1.20.6 # 版本podSubnet: 10.244.0.0&#x2F;16 #指定pod网段， 需要新增加这个追加如下几行 —apiVersion: kubeproxy.config.k8s.io&#x2F;v1alpha1kind: KubeProxyConfigurationmode: ipvs # kube-proxy 的模式为 ipvs—apiVersion: kubelet.config.k8s.io&#x2F;v1beta1kind: KubeletConfigurationcgroupDriver: systemd 初始化节点的时候需要指定cgroupDriver为systemd 比如修改 imageRepository 的值，kube-proxy 的模式为 ipvs，初始化节点的时候需要指定cgroupDriver为systemd 123# 生成K8S初始化的yaml文件kubeadm config print init-defaults &gt; kubeadm.yaml 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051# kubeadm.yaml配置如下：vim kubeadm.yamlapiVersion: kubeadm.k8s.io/v1beta2bootstrapTokens:- groups: - system:bootstrappers:kubeadm:default-node-token token: abcdef.0123456789abcdef ttl: 24h0m0s usages: - signing - authenticationkind: InitConfigurationlocalAPIEndpoint: advertiseAddress: 192.168.1.12 #控制节点的ip bindPort: 6443nodeRegistration: # 看下上面的图片 criSocket: /var/run/dockershim.sock name: centos07-12 #控制节点主机名 taints: - effect: NoSchedule key: node-role.kubernetes.io/master---apiServer: timeoutForControlPlane: 4m0sapiVersion: kubeadm.k8s.io/v1beta2certificatesDir: /etc/kubernetes/pkiclusterName: kubernetescontrollerManager: &#123;&#125;dns: type: CoreDNSetcd: local: dataDir: /var/lib/etcdimageRepository: registry.aliyuncs.com/google_containers # 修改 imageRepository 的值kind: ClusterConfigurationkubernetesVersion: v1.20.6 # 版本networking: dnsDomain: cluster.local serviceSubnet: 10.96.0.0/12 podSubnet: 10.244.0.0/16 #指定pod网段， 需要新增加这个scheduler: &#123;&#125;#追加如下几行---apiVersion: kubeproxy.config.k8s.io/v1alpha1kind: KubeProxyConfigurationmode: ipvs # kube-proxy 的模式为 ipvs---apiVersion: kubelet.config.k8s.io/v1beta1kind: KubeletConfigurationcgroupDriver: systemd 初始化节点的时候需要指定cgroupDriver为systemd 注意：centos7.9 需要加参数：–ignore-preflight-errors&#x3D;SystemVerification， 作用检测SystemVerification模块忽略错误；centos7.9没有SystemVerification模块会报错，这样就可以忽略这个错误了在初始化时，有问题，或者想要修改yaml重新初始化，需要先执行下kubeadm reset; 1kubeadm init --config=kubeadm.yaml --ignore-preflight-errors=SystemVerification 显示如下，说明安装完成： 注意：初始化时发下版本有问题，可以使用yum卸载，重新安装yum remove kubectl kubeadm kubelet -y特别提醒： –image-repository registry.aliyuncs.com&#x2F;google_containers为保证拉取镜像不到国外站点拉取，手动指定仓库地址为registry.aliyuncs.com&#x2F;google_containers。kubeadm默认从k8s.gcr.io拉取镜像。 我们本地有导入到的离线镜像，所以会优先使用本地的镜像。mode: ipvs 表示kube-proxy代理模式是ipvs，如果不指定ipvs，会默认使用iptables，但是iptables效率低，所以我们生产环境建议开启ipvs，阿里云和华为云托管的K8s，也提供ipvs模式，如下 6、配置kubectl的配置文件config - centos07-12 未配置config，未做下面的操作就会有这个问题，相当于没有授权 12[root@centos07-12 ~]# kubectl get nodesThe connection to the server localhost:8080 was refused - did you specify the right host or port? 相当于对kubectl进行授权，这样kubectl命令可以使用这个证书对k8s集群进行管理 123mkdir -p $HOME/.kubesudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/configsudo chown $(id -u):$(id -g) $HOME/.kube/config 12345kubectl get nodes# 此时集群状态还是NotReady状态，因为没有安装网络插件。NAME STATUS ROLES AGE VERSIONcentos07-12 NotReady control-plane,master 7m45s v1.20.6 扩展：kubeadm init初始化流程分析 kubeadm 在执行安装之前进行了相当细致的环境检测，下面看一看 注意：操作系统需要我们手动配置好，包括防火墙、swap、selinux关掉 检查执行 init 命令的用户是否为 root，如果不是 root，直接快速失败（fail fast）； 检查待安装的 k8s 版本是否被当前版本的 kubeadm 支持（kubeadm 版本 &gt;&#x3D; 待安装 k8s 版本）； 检查防火墙，如果防火墙未关闭，提示开放端口 10250； 检查端口是否已被占用，6443（或你指定的监听端口）、10257、10259； 检查文件是否已经存在，&#x2F;etc&#x2F;kubernetes&#x2F;manifests&#x2F;*.yaml； ll &#x2F;etc&#x2F;kubernetes&#x2F;manifests&#x2F;-rw——- 1 root root 2216 11月 30 16:09 etcd.yaml-rw——- 1 root root 3325 11月 30 16:09 kube-apiserver.yaml-rw——- 1 root root 2827 11月 30 16:09 kube-controller-manager.yaml-rw——- 1 root root 1413 11月 30 16:09 kube-scheduler.yaml 检查是否存在代理，连接本机网络、服务网络、Pod网络，都会检查，目前不允许代理； 检查容器运行时，使用 CRI 还是 Docker，如果是 Docker，进一步检查 Docker 服务是否已启动，是否设置了开机自启动； 对于 Linux 系统，会额外检查以下内容： 8.1) 检查以下命令是否存在：crictl、ip、iptables、mount、nsenter、ebtables、ethtool、socat、tc、touch；8.2) 检查 &#x2F;proc&#x2F;sys&#x2F;net&#x2F;bridge&#x2F;bridge-nf-call-iptables、&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;ip-forward 内容是否为 1；8.3) 检查 swap 是否是关闭状态； 检查内核是否被支持，Docker 版本及后端存储 GraphDriver 是否被支持； 对于 Linux 系统，还需检查 OS 版本和 cgroup 支持程度（支持哪些资源的隔离）； 检查主机名访问可达性； 检查 kubelet 版本，要高于 kubeadm 需要的最低版本，同时不高于待安装的 k8s 版本； 检查 kubelet 服务是否开机自启动； 检查 10250 端口是否被占用； 如果开启 IPVS 功能，检查系统内核是否加载了 ipvs 模块； 对于 etcd，如果使用 Local etcd，则检查 2379 端口是否被占用， &#x2F;var&#x2F;lib&#x2F;etcd&#x2F; 是否为空目录； 如果使用 External etcd，则检查证书文件是否存在（CA、key、cert），验证 etcd 服务版本是否符合要求； 如果使用 IPv6， 检查 &#x2F;proc&#x2F;sys&#x2F;net&#x2F;bridge&#x2F;bridge-nf-call-iptables、&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv6&#x2F;conf&#x2F;default&#x2F;forwarding 内容是否为 1； 以上就是 kubeadm init 需要检查的所有项目了！ 完成安装前的配置 在 kube-system 命名空间创建 ConfigMap kubeadm-config，同时对其配置 RBAC 权限； 在 kube-system 命名空间创建 ConfigMap kubelet-config-，同时对其配置 RBAC 权限； 为当前节点（Master）打标记：node-role.kubernetes.io&#x2F;master&#x3D;； 为当前节点（Master）补充 Annotation； 如果启用了 DynamicKubeletConfig 特性，设置本节点 kubelet 的配置数据源为 ConfigMap 形式； 创建 BootStrap token Secret，并对其配置 RBAC 权限； 在 kube-public 命名空间创建 ConfigMap cluster-info，同时对其配置 RBAC 权限； 与 apiserver 通信，部署 DNS 服务； 与 apiserver 通信，部署 kube-proxy 服务； 如果启用了 self-hosted 特性，将 Control Plane 转为 DaemonSet 形式运行； 打印 join 语句； 扩展：Kubeadm生成的k8s证书内容说明 一、证书分组 Kubernetes把证书放在了两个文件夹中 &#x2F;etc&#x2F;kubernetes&#x2F;pki &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd 二、Kubernetes 集群根证书 Kubernetes 集群根证书CA(Kubernetes集群组件的证书签发机构) &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;ca.crt &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;ca.key 以上这组证书为签发其他Kubernetes组件证书使用的根证书, 可以认为是Kubernetes集群中证书签发机构之一由此根证书签发的证书有:1、kube-apiserver apiserver证书&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;apiserver.crt&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;apiserver.key2、kubelet客户端证书, 用作 kube-apiserver 主动向 kubelet 发起请求时的客户端认证&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;apiserver-kubelet-client.crt&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;apiserver-kubelet-client.key 三、kube-apiserver 代理根证书(客户端证书)用在requestheader-client-ca-file配置选项中, kube-apiserver 使用该证书来验证客户端证书是否为自己所签发&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;front-proxy-ca.crt&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;front-proxy-ca.key由此根证书签发的证书只有一组:代理层(如汇聚层aggregator)使用此套代理证书来向 kube-apiserver 请求认证代理端使用的客户端证书, 用作代用户与 kube-apiserver 认证&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;front-proxy-client.crt&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;front-proxy-client.key三、etcd 集群根证书etcd集群所用到的证书都保存在&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd这路径下, 很明显, 这一套证书是用来专门给etcd集群服务使用的, 设计以下证书文件etcd 集群根证书CA(etcd 所用到的所有证书的签发机构)&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;ca.crt&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;ca.key由此根证书签发机构签发的证书有:1、etcd server 持有的服务端证书&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;server.crt&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;server.key2、peer 集群中节点互相通信使用的客户端证书&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;peer.crt&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;peer.key注: Peer：对同一个etcd集群中另外一个Member的称呼3、pod 中定义 Liveness 探针使用的客户端证书kubeadm 部署的 Kubernetes 集群是以 pod 的方式运行 etcd 服务的, 在该 pod 的定义中, 配置了 Liveness 探活探针&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;healthcheck-client.crt&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;healthcheck-client.key当你 describe etcd 的 pod 时, 会看到如下一行配置:Liveness: exec [&#x2F;bin&#x2F;sh -ec ETCDCTL_API&#x3D;3 etcdctl –endpoints&#x3D;https:&#x2F;&#x2F;[127.0.0.1]:2379 –cacert&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;ca.crt –cert&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;healthcheck-client.crt –key&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;healthcheck-client.key get foo] delay&#x3D;15s timeout&#x3D;15s period&#x3D;10s #success&#x3D;1 #failure&#x3D;84、配置在 kube-apiserver 中用来与 etcd server 做双向认证的客户端证书&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;apiserver-etcd-client.crt&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;apiserver-etcd-client.key 7、扩容k8s集群-添加第一个工作节点 在centos07-12上查看加入节点的命令, 注意博客上直接复制可能有问题，是（双横线） - -print-join-command1kubeadm token create - -print-join-command 把centos07-22&#x2F;centos07-42加入k8s集群1kubeadm join 192.168.1.12:6443 --token b6kj57.ufm161f5uz6sz9lf --discovery-token-ca-cert-hash sha256:f0380afe2ae751ea1b4083759574654f3d05821ffdface9ed358ea04f965c586 --ignore-preflight-errors=SystemVerification 看到下面面说明centos07-22&#x2F;centos07-42节点已经加入到集群了,充当工作节点 在centos07-12上查看集群节点状况： 可以看到centos07-22&#x2F;centos07-42的ROLES角色为空，就表示这个节点是工作节点。 123456kubectl get nodesNAME STATUS ROLES AGE VERSIONcentos07-12 NotReady control-plane,master 40m v1.20.6centos07-22 NotReady &lt;none&gt; 82s v1.20.6centos07-42 NotReady &lt;none&gt; 84s v1.20.6 可以把centos07-22&#x2F;centos07-42的ROLES变成work，按照如下方法：123kubectl label node centos07-22 node-role.kubernetes.io/worker=workerkubectl label node centos07-42 node-role.kubernetes.io/worker=worker 1234567kubectl get nodes# roles变为workNAME STATUS ROLES AGE VERSIONcentos07-12 NotReady control-plane,master 42m v1.20.6centos07-22 NotReady worker 3m43s v1.20.6centos07-42 NotReady worker 3m45s v1.20.6 注意：上面状态都是NotReady状态，说明没有安装网络插件 8、安装kubernetes网络组件-Calico 注：官方提供的文件地址，下载后需要自己修改： https://docs.projectcalico.org/manifests/calico.yaml删除，kubectl delete -f calico.yaml 上传calico.yaml到centos07-12上，使用yaml文件安装calico 网络插件 注意服务器多网卡，需要指定网卡。 1234vim calico.yaml3648 - name: IP_AUTODETECTION_METHOD3649 value: &quot;interface=enp0s3&quot; 安装calico1kubectl apply -f calico.yaml node的状态pending变为ready123456kubectl get nodesNAME STATUS ROLES AGE VERSIONcentos07-12 Ready control-plane,master 87m v1.20.6centos07-22 Ready worker 48m v1.20.6centos07-42 Ready worker 48m v1.20.6 pod， 状态都变成Running，ready变为1&#x2F;1;12345678910111213141516kubectl get pod -n kube-systemNAME READY STATUS RESTARTS AGEcalico-kube-controllers-6949477b58-22zbl 1/1 Running 1 3m5scalico-node-9hqdh 1/1 Running 0 3m5scalico-node-vxjkc 1/1 Running 0 3m5scalico-node-z6p24 1/1 Running 0 3m5scoredns-7f89b7bc75-lt6lr 1/1 Running 0 89mcoredns-7f89b7bc75-q5sz7 1/1 Running 0 89metcd-centos07-12 1/1 Running 0 89mkube-apiserver-centos07-12 1/1 Running 0 89mkube-controller-manager-centos07-12 1/1 Running 1 89mkube-proxy-cskcq 1/1 Running 0 50mkube-proxy-mc5sv 1/1 Running 0 89mkube-proxy-ndz4x 1/1 Running 0 50mkube-scheduler-centos07-12 1/1 Running 1 89m 查看日志1kubectl logs calico-node-9hqdh -n kube-system Calico架构图 Calico网络模型主要工作组件：1.Felix：运行在每一台 Host 的 agent 进程，主要负责网络接口管理和监听、路由、ARP 管理、ACL 管理和同步、状态上报等。保证跨主机容器网络互通。2.etcd：分布式键值存储，相当于k8s集群中的数据库，存储着Calico网络模型中IP地址等相关信息。主要负责网络元数据一致性，确保 Calico 网络状态的准确性；3.BGP Client（BIRD）：Calico 为每一台 Host 部署一个 BGP Client，即每台host上部署一个BIRD。 主要负责把 Felix 写入 Kernel 的路由信息分发到当前 Calico 网络，确保 Workload 间的通信的有效性；4.BGP Route Reflector：在大型网络规模中，如果仅仅使用 BGP client 形成 mesh 全网互联的方案就会导致规模限制，因为所有节点之间俩俩互联，需要 N^2 个连接，为了解决这个规模问题，可以采用 BGP 的 Router Reflector 的方法，通过一个或者多个 BGP Route Reflector 来完成集中式的路由分发。 1、Daemonset配置 ……containers: # Runs calico-node container on each Kubernetes node. This # container programs network policy and routes on each # host. - name: calico-node image: docker.io&#x2F;calico&#x2F;node:v3.18.0….. env: # Use Kubernetes API as the backing datastore. - name: DATASTORE_TYPE value: “kubernetes” # Cluster type to identify the deployment type - name: CLUSTER_TYPE value: “k8s,bgp” # Auto-detect the BGP IP address. - name: IP value: “autodetect” #pod网段 - name: CALICO_IPV4POOL_CIDR value: “10.244.0.0&#x2F;16” # Enable IPIP - name: CALICO_IPV4POOL_IPIP value: “Always” calico-node服务的主要参数如下:CALICO_IPV4POOL_IPIP：是否启用IPIP模式。启用IPIP模式时，Calico将在Node上创建一个名为tunl0的虚拟隧道。IP Pool可以使用两种模式：BGP或IPIP。使用IPIP模式时，设置CALICO_IPV4POOL_IPIP&#x3D;”Always”，不使用IPIP模式时，设置CALICO_IPV4POOL_IPIP&#x3D;”Off”，此时将使用BGP模式。IP_AUTODETECTION_METHOD：获取Node IP地址的方式，默认使用第1个网络接口的IP地址，对于安装了多块网卡的Node，可以使用正则表达式选择正确的网卡，例如”interface&#x3D;eth.*”表示选择名称以eth开头的网卡的IP地址。- name: IP_AUTODETECTION_METHOD value: “interface&#x3D;enp0s3” 扩展：calico的IPIP模式和BGP模式对比分析1）IPIP把一个IP数据包又套在一个IP包里，即把IP层封装到IP层的一个 tunnel，它的作用其实基本上就相当于一个基于IP层的网桥，一般来说，普通的网桥是基于mac层的，根本不需要IP，而这个ipip则是通过两端的路由做一个tunnel，把两个本来不通的网络通过点对点连接起来；calico以ipip模式部署完毕后，node上会有一个tunl0的网卡设备，这是ipip做隧道封装用的,也是一种overlay模式的网络。当我们把节点下线，calico容器都停止后，这个设备依然还在，执行 rmmodipip命令可以将它删除。2）BGPBGP模式直接使用物理机作为虚拟路由路（vRouter），不再创建额外的tunnel边界网关协议（BorderGateway Protocol, BGP）是互联网上一个核心的去中心化的自治路由协议。它通过维护IP路由表或‘前缀’表来实现自治系统（AS）之间的可达性，属于矢量路由协议。BGP不使用传统的内部网关协议（IGP）的指标，而是基于路径、网络策略或规则集来决定路由。因此，它更适合被称为矢量性协议，而不是路由协议，通俗的说就是将接入到机房的多条线路（如电信、联通、移动等）融合为一体，实现多线单IP；BGP 机房的优点：服务器只需要设置一个IP地址，最佳访问路由是由网络上的骨干路由器根据路由跳数与其它技术指标来确定的，不会占用服务器的任何系统；官方提供的calico.yaml模板里，默认打开了ip-ip功能，该功能会在node上创建一个设备tunl0，容器的网络数据会经过该设备被封装一个ip头再转发。这里，calico.yaml中通过修改calico-node的环境变量：CALICO_IPV4POOL_IPIP来实现ipip功能的开关：默认是Always，表示开启；Off表示关闭ipip。- name: CLUSTER_TYPE value: “k8s,bgp” # Auto-detect the BGP IP address.- name: IP value: “autodetect” # Enable IPIP- name: CALICO_IPV4POOL_IPIP value: “Always” 总结：calico BGP通信是基于TCP协议的，所以只要节点间三层互通即可完成，即三层互通的环境bird就能生成与邻居有关的路由。但是这些路由和flannel host-gateway模式一样，需要二层互通才能访问的通，因此如果在实际环境中配置了BGP模式生成了路由但是不同节点间pod访问不通，可能需要再确认下节点间是否二层互通。为了解决节点间二层不通场景下的跨节点通信问题，calico也有自己的解决方案——IPIP模式 9、测试在k8s创建pod是否可以正常访问网络，镜像放在node上，在master上执行命令 注意：把busybox-1-28.tar.gz上传到centos07-22、centos07-42节点，手动解压12scp busybox-1-28.tar.gz root@192.168.1.22:~scp busybox-1-28.tar.gz root@192.168.1.42:~ 123# centos07-22、centos07-42docker load -i busybox-1-28.tar.gzdocker load -i busybox-1-28.tar.gz 在控制节点-centos07-121kubectl run busybox --image busybox:1.28 --image-pull-policy=IfNotPresent --restart=Never --rm -it busybox -- sh 123456789# 通过下面可以看到能访问网络，说明calico网络插件已经被正常安装了[root@centos07-12 ~]# kubectl run busybox --image busybox:1.28 --image-pull-policy=IfNotPresent --restart=Never --rm -it busybox -- shIf you don&#x27;t see a command prompt, try pressing enter./ # ping www.baidu.comPING www.baidu.com (39.156.66.18): 56 data bytes64 bytes from 39.156.66.18: seq=0 ttl=61 time=710.812 ms64 bytes from 39.156.66.18: seq=1 ttl=61 time=798.976 ms64 bytes from 39.156.66.18: seq=2 ttl=61 time=822.153 ms64 bytes from 39.156.66.18: seq=3 ttl=61 time=1031.787 ms 10、测试coredns是否正常 - centos07-12 0.96.0.10 就是我们coreDNS的clusterIP，说明coreDNS配置好了。解析内部Service的名称，是通过coreDNS去解析的。 12345678[root@centos07-12 ~]# kubectl run busybox --image busybox:1.28 --restart=Never --rm -it busybox -- shIf you don&#x27;t see a command prompt, try pressing enter./ # nslookup kubernetes.default.svc.cluster.localServer: 10.96.0.10Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.localName: kubernetes.default.svc.cluster.localAddress 1: 10.96.0.1 kubernetes.default.svc.cluster.local 注意:busybox要用指定的1.28版本，不能用最新版本，最新版本，nslookup会解析不到dns和ip 11、kubeadm初始化k8s证书过期解决方案 - centos07-12 注意：更新证书或重启组件，会影响业务，最好先更新 查看证书有效时间：12openssl x509 -in /etc/kubernetes/pki/ca.crt -noout -text |grep Notopenssl x509 -in /etc/kubernetes/pki/apiserver.crt -noout -text |grep Not 12345678# 10年ca.crt[root@centos07-12 ~]# openssl x509 -in /etc/kubernetes/pki/ca.crt -noout -text |grep Not Not Before: Nov 30 08:09:20 2023 GMT Not After : Nov 27 08:09:20 2033 GMT# 1年apiserver.crt[root@centos07-12 ~]# openssl x509 -in /etc/kubernetes/pki/apiserver.crt -noout -text |grep Not Not Before: Nov 30 08:09:20 2023 GMT Not After : Nov 29 08:09:21 2024 GMT 延长证书过期时间 1.把update-kubeadm-cert.sh文件上传到centos07-12节点 1scp update-kubeadm-cert.sh root@192.168.1.12:~ 2.在centos07-12上执行如下： 1）给update-kubeadm-cert.sh证书授权可执行权限1chmod +x update-kubeadm-cert.sh 2）执行下面命令，修改证书过期时间，把时间延长到10年1./update-kubeadm-cert.sh all 3）在centos07-12节点查询Pod是否正常,能查询出数据说明证书签发完成1kubectl get pods -n kube-system 4）再次查看证书有效期，可以看到会延长到10年1234567[root@centos07-12 ~]# openssl x509 -in /etc/kubernetes/pki/ca.crt -noout -text |grep Not Not Before: Nov 30 08:09:20 2023 GMT Not After : Nov 27 08:09:20 2033 GMT [root@centos07-12 ~]# openssl x509 -in /etc/kubernetes/pki/apiserver.crt -noout -text |grep Not Not Before: Nov 30 11:13:01 2023 GMT Not After : Nov 27 11:13:01 2033 GMT","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"02-kubeadm安装k8s如何卸载","slug":"运维/K8S/基础/02-kubeadm安装k8s如何卸载","date":"2023-05-01T12:00:52.000Z","updated":"2023-12-05T02:51:40.000Z","comments":true,"path":"2023/05/01/运维/K8S/基础/02-kubeadm安装k8s如何卸载/","link":"","permalink":"https://dbbruce.github.io/2023/05/01/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/02-kubeadm%E5%AE%89%E8%A3%85k8s%E5%A6%82%E4%BD%95%E5%8D%B8%E8%BD%BD/","excerpt":"kubeadm安装k8s如何卸载 kubeadm reset - 卸载k8s","text":"kubeadm安装k8s如何卸载 kubeadm reset - 卸载k8s 123456789101112131415161718192021222324[root@centos07-42 ~]# kubeadm reset[reset] WARNING: Changes made to this host by &#x27;kubeadm init&#x27; or &#x27;kubeadm join&#x27; will be reverted.[reset] Are you sure you want to proceed? [y/N]: y # 输入Y[preflight] Running pre-flight checksW1130 09:42:11.974187 8085 removeetcdmember.go:79] [reset] No kubeadm config, using etcd pod spec to get data directory[reset] No etcd config found. Assuming external etcd[reset] Please, manually reset etcd to prevent further issues[reset] Stopping the kubelet service[reset] Unmounting mounted directories in &quot;/var/lib/kubelet&quot;[reset] Deleting contents of config directories: [/etc/kubernetes/manifests /etc/kubernetes/pki][reset] Deleting files: [/etc/kubernetes/admin.conf /etc/kubernetes/kubelet.conf /etc/kubernetes/bootstrap-kubelet.conf /etc/kubernetes/controller-manager.conf /etc/kubernetes/scheduler.conf][reset] Deleting contents of stateful directories: [/var/lib/kubelet /var/lib/dockershim /var/run/kubernetes /var/lib/cni]The reset process does not clean CNI configuration. To do so, you must remove /etc/cni/net.dThe reset process does not reset or clean up iptables rules or IPVS tables.If you wish to reset iptables, you must do so manually by using the &quot;iptables&quot; command.If your cluster was setup to utilize IPVS, run ipvsadm --clear (or similar)to reset your system&#x27;s IPVS tables.The reset process does not clean your kubeconfig files and you must remove them manually.Please, check the contents of the $HOME/.kube/config file. node节点，可以直接添加到集群master节点，需要重新同步那一堆key，不知道哪些key可以看01文字； 如何区分控制节点master和工作节点node 控制节点：kube-apiserver,kube-controller-manager,kube-proxy,kube-scheduler,calico 工作节点：coredns,calico","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"01-kubeadm安装多master节点k8s-1.20.6高可用集群","slug":"运维/K8S/基础/01-kubeadm安装多master节点k8s-1.20.6高可用集群","date":"2023-05-01T02:00:52.000Z","updated":"2023-12-05T10:24:35.000Z","comments":true,"path":"2023/05/01/运维/K8S/基础/01-kubeadm安装多master节点k8s-1.20.6高可用集群/","link":"","permalink":"https://dbbruce.github.io/2023/05/01/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/01-kubeadm%E5%AE%89%E8%A3%85%E5%A4%9Amaster%E8%8A%82%E7%82%B9k8s-1.20.6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4/","excerpt":"kubeadm和二进制安装k8s适用场景分析 kubeadm kubeadm是官方提供的开源工具，是一个开源项目，用于快速搭建kubernetes集群，目前是比较方便和推荐使用的。kubeadm init 以及 kubeadm join 这两个命令可以快速创建 kubernetes 集群。Kubeadm初始化k8s，所有的组件都是以pod形式运行的，具备故障自恢复能力。 kubeadm是工具，可以快速搭建集群，也就是相当于用程序脚本帮我们装好了集群，属于自动部署，简化部署操作，自动部署屏蔽了很多细节，使得对各个模块感知很少，如果对k8s架构组件理解不深的话，遇到问题比较难排查。 kubeadm适合需要经常部署k8s，或者对自动化要求比较高的场景下使用。 二进制 在官网下载相关组件的二进制包，如果手动安装，对kubernetes理解也会更全面。 总结 Kubeadm和二进制都适合生产环境，在生产环境运行都很稳定，具体如何选择，可以根据实际项目进行评估。","text":"kubeadm和二进制安装k8s适用场景分析 kubeadm kubeadm是官方提供的开源工具，是一个开源项目，用于快速搭建kubernetes集群，目前是比较方便和推荐使用的。kubeadm init 以及 kubeadm join 这两个命令可以快速创建 kubernetes 集群。Kubeadm初始化k8s，所有的组件都是以pod形式运行的，具备故障自恢复能力。 kubeadm是工具，可以快速搭建集群，也就是相当于用程序脚本帮我们装好了集群，属于自动部署，简化部署操作，自动部署屏蔽了很多细节，使得对各个模块感知很少，如果对k8s架构组件理解不深的话，遇到问题比较难排查。 kubeadm适合需要经常部署k8s，或者对自动化要求比较高的场景下使用。 二进制 在官网下载相关组件的二进制包，如果手动安装，对kubernetes理解也会更全面。 总结 Kubeadm和二进制都适合生产环境，在生产环境运行都很稳定，具体如何选择，可以根据实际项目进行评估。 k8s环境规划： podSubnet（pod网段） 10.244.0.0&#x2F;16 serviceSubnet（service网段）: 10.96.0.0&#x2F;16 K8S集群角色 ip 主机名 安装组件 控制节点master 192.168.1.12 centos07-12 apiserver、ontroller-manager、 scheduler、kubelet、 etcd、 docker、 kubeproxy 、 keepalived、 nginx、calico 控制节点master 192.168.1.22 centos07-22 apiserver、ontroller-manager、 scheduler、kubelet、 etcd、 docker、 kubeproxy 、 keepalived、 nginx、calico 工作节点-node 192.168.1.42 centos07-42 kubelet、 kube-proxy、docker、 calico、coredns vip 192.168.1.188 初始化安装k8s集群的实验环境1、修改机器IP，变成静态IP - centos07-12&#x2F;22&#x2F;42 注意：&#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-ens33文件里的配置说明：NAME&#x3D;ens33 #网卡名字，跟DEVICE名字保持一致即可DEVICE&#x3D;ens33 #网卡设备名，大家ip addr可看到自己的这个网卡设备名，每个人的机器可能这个名字不一样，需要写自己的BOOTPROTO&#x3D;static #static表示静态ip地址ONBOOT&#x3D;yes #开机自启动网络，必须是yesIPADDR&#x3D;192.168.40.180 #ip地址，需要跟自己电脑所在网段一致NETMASK&#x3D;255.255.255.0 #子网掩码，需要跟自己电脑所在网段一致GATEWAY&#x3D;192.168.40.2 #网关，在自己电脑打开cmd，输入ipconfig &#x2F;all可看到DNS1&#x3D;192.168.40.2 #DNS，在自己电脑打开cmd，输入ipconfig &#x2F;all可看到 修改网卡配置12345678910111213141516171819[root@centos07-12 ~]# vim /etc/sysconfig/network-scripts/ifcfg-enp0s3TYPE=EthernetPROXY_METHOD=noneBROWSER_ONLY=noBOOTPROTO=staticIPADDR=192.168.1.12NETMASK=255.255.255.0GATEWAY=192.168.1.255DNS1=114.114.114.114DEFROUTE=yesIPV4_FAILURE_FATAL=noIPV6INIT=yesIPV6_AUTOCONF=yesIPV6_DEFROUTE=yesIPV6_FAILURE_FATAL=noIPV6_ADDR_GEN_MODE=stable-privacyNAME=enp0s3DEVICE=enp0s3ONBOOT=yes 全部重启12[root@centos07-12 ~]# service network restartRestarting network (via systemctl): [ OK ] 2、关闭selinux - centos07-12&#x2F;22&#x2F;42 修改selinux配置文件之后，重启机器，selinux配置才能永久生效1sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config 显示Disabled说明selinux已经关闭12[root@centos07-12 ~]# getenforceDisabled 3、配置机器主机名 - centos07-12&#x2F;22&#x2F;421hostnamectl set-hostname CentOS07-12 &amp;&amp; bash 4、升级系统,由centos7.6升级到centos7.9 - centos07-12&#x2F;22&#x2F;421yum update -y 5、配置主机hosts文件，相互之间通过主机名互相访问 - centos07-12&#x2F;22&#x2F;42 修改每台机器的&#x2F;etc&#x2F;hosts文件，增加如下三行12345vim /etc/hosts192.168.1.12 centos07-12192.168.1.22 centos07-22192.168.1.42 centos07-42 6、配置主机之间无密码登录 - centos07-12&#x2F;22&#x2F;42 生成sshkey，一路回车，不输入密码1ssh-keygen 把本地生成的密钥文件和私钥文件拷贝到远程主机，保证3台机器可以无密登录123ssh-copy-id centos07-12ssh-copy-id centos07-22ssh-copy-id centos07-42 7、关闭交换分区swap，提升性能 - centos07-12&#x2F;22&#x2F;42 为什么要关闭swap交换分区？Swap是交换分区，如果机器内存不够，会使用swap分区，但是swap分区的性能较低，k8s设计的时候为了能提升性能，默认是不允许使用交换分区的。Kubeadm初始化的时候会检测swap是否关闭，如果没关闭，那就初始化失败。如果不想要关闭交换分区，安装k8s的时候可以指定–ignore-preflight-errors&#x3D;Swap来解决。 临时关闭1swapoff -a 永久关闭：注释swap挂载，给swap这行开头加一下注释123vim /etc/fstab# /dev/mapper/centos-swap swap swap defaults 0 0 8、修改机器内核参数 - centos07-12&#x2F;22&#x2F;42 sysctl是做什么的？在运行时配置内核参数 -p 从指定的文件加载系统参数，如不指定即从&#x2F;etc&#x2F;sysctl.conf中加载 为什么要执行modprobe br_netfilter 修改&#x2F;etc&#x2F;sysctl.d&#x2F;k8s.conf文件，增加如下三行参数： net.bridge.bridge-nf-call-ip6tables &#x3D; 1 net.bridge.bridge-nf-call-iptables &#x3D; 1 net.ipv4.ip_forward &#x3D; 1 sysctl -p &#x2F;etc&#x2F;sysctl.d&#x2F;k8s.conf出现报错： sysctl: cannot stat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;bridge&#x2F;bridge-nf-call-ip6tables: No such file or directorysysctl: cannot stat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;bridge&#x2F;bridge-nf-call-iptables: No such file or directory 解决方法： modprobe br_netfilter 为什么开启net.bridge.bridge-nf-call-iptables内核参数 在centos下安装docker，执行docker info出现如下警告： WARNING: bridge-nf-call-iptables is disabled WARNING: bridge-nf-call-ip6tables is disabled 解决办法： vim &#x2F;etc&#x2F;sysctl.d&#x2F;k8s.conf net.bridge.bridge-nf-call-ip6tables &#x3D; 1 net.bridge.bridge-nf-call-iptables &#x3D; 1 为什么要开启net.ipv4.ip_forward &#x3D; 1参数kubeadm初始化k8s如果报错： 就表示没有开启ip_forward，需要开启。net.ipv4.ip_forward是数据包转发：出于安全考虑，Linux系统默认是禁止数据包转发的。所谓转发即当主机拥有多于一块的网卡时，其中一块收到数据包，根据数据包的目的ip地址将数据包发往本机另一块网卡，该网卡根据路由表继续发送数据包。这通常是路由器所要实现的功能。要让Linux系统具有路由转发功能，需要配置一个Linux的内核参数net.ipv4.ip_forward。这个参数指定了Linux系统当前对路由转发功能的支持情况；其值为0时表示禁止进行IP转发；如果是1,则说明IP转发功能已经打开。 8.1、加载 modprobe br_netfilter 手动加载模块1234567modprobe br_netfilter# 查看是否加载lsmod|grep br_netfilterbr_netfilter 22256 0bridge 151336 2 br_netfilter,ebtable_broute 自动加载 1echo &quot;modprobe br_netfilter&quot; &gt;&gt; /etc/profile 8.2、配置bridge和forward12345cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt;EOFnet.bridge.bridge-nf-call-ip6tables = 1net.bridge.bridge-nf-call-iptables = 1net.ipv4.ip_forward = 1EOF 8.3、运行配置内核参数1sysctl -p /etc/sysctl.d/k8s.conf 9、关闭firewalld防火墙 - centos07-12&#x2F;22&#x2F;421systemctl stop firewalld ; systemctl disable firewalld 10、配置阿里云的repo源 - centos07-12&#x2F;22&#x2F;42 安装scp1yum install openssh-clients 备份原有源-可做可不做，也可以使用系统的源12mkdir -p /root/repo.bak/mv /etc/yum.repos.d/* /root/repo.bak/ 下载阿里云的repo源- 可做可不做，也可以使用系统的源12yum install yum-utils -y # 这个就是yum-config-manger工具yum-config-manager --add-repo https://mirrors.aliyun.com/repo/Centos-vault-8.5.2111.repo 配置国内阿里云docker的repo源1yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo 11、配置安装k8s组件需要的阿里云的repo源 - centos07-12&#x2F;22&#x2F;421234567vim /etc/yum.repos.d/kubernetes.repo[kubernetes]name=Kubernetesbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/enabled=1gpgcheck=0 123# 可以一个个编辑也可以使用scp同步scp /etc/yum.repos.d/kubernetes.repo centos07-22:/etc/yum.repos.d/scp /etc/yum.repos.d/kubernetes.repo centos07-42:/etc/yum.repos.d/ 12、配置时间同步 - centos07-12&#x2F;22&#x2F;42 安装ntpdate命令1yum install ntpdate -y 跟网络时间做同步1ntpdate cn.pool.ntp.org 把时间同步做成计划任务123crontab -e* */1 * * * /usr/sbin/ntpdate cn.pool.ntp.org 重启crond服务1service crond restart 13、安装基础软件包 - centos07-12&#x2F;22&#x2F;421yum install -y yum-utils device-mapper-persistent-data lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel python-devel epel-release openssh-server socat ipvsadm conntrack ntpdate telnet ipvsadm 安装docker服务1、安装docker-ce - centos07-12&#x2F;22&#x2F;4212yum install docker-ce-20.10.6 docker-ce-cli-20.10.6 containerd.io -ysystemctl start docker &amp;&amp; systemctl enable docker &amp;&amp; systemctl status docker 2、配置docker镜像加速器和驱动 - centos07-12&#x2F;22&#x2F;42 修改docker文件驱动为systemd，默认为cgroupfs，kubelet默认使用systemd，两者必须一致才可以。123456vim /etc/docker/daemon.json &#123; &quot;registry-mirrors&quot;: [&quot;https://882k7j67.mirror.aliyuncs.com&quot;], &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]&#125; 重启12systemctl daemon-reload &amp;&amp; systemctl restart dockersystemctl status docker 3、安装初始化k8s需要的软件包 - centos07-12&#x2F;22&#x2F;42 注：每个软件包的作用Kubeadm: kubeadm是一个工具，用来初始化k8s集群的kubelet: 安装在集群所有节点上，用于启动Pod的kubectl: 通过kubectl可以部署和管理应用，查看各种资源，创建、删除和更新各种组件 12yum install -y kubelet-1.20.6 kubeadm-1.20.6 kubectl-1.20.6systemctl enable kubelet 4、通过keepalive+nginx实现k8s-apiserver节点高可用 - centos07-12&#x2F;221、安装nginx和keepalive- centos07-12&#x2F;22 在centos07-12和centos07-22上做nginx主备安装1yum install nginx keepalived -y yum安装不了nginx，就用下面的办法123wget https://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpmrpm -ivh nginx-release-centos-7-0.el7.ngx.noarch.rpmyum -y install nginx 2、配置nginx，主从- centos07-12&#x2F;22 修改nginx配置文件。主备一样 下面的配置用到了stream 四层代理，nginx 1.20不支持四层代理，升级到1.24 解决报错问题 12# 备份下cp /etc/nginx/nginx.conf /etc/nginx/nginx.confbak 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455vim /etc/nginx/nginx.confuser nginx;worker_processes auto;error_log /var/log/nginx/error.log;pid /run/nginx.pid;include /usr/share/nginx/modules/*.conf;events &#123; worker_connections 1024;&#125;# 四层负载均衡，为两台Master apiserver组件提供负载均衡stream &#123; log_format main &#x27;$remote_addr $upstream_addr - [$time_local] $status $upstream_bytes_sent&#x27;; access_log /var/log/nginx/k8s-access.log main; upstream k8s-apiserver &#123; server 192.168.1.12:6443; # Master1 APISERVER IP:PORT server 192.168.1.22:6443; # Master2 APISERVER IP:PORT &#125; server &#123; listen 16443; # 由于nginx与master节点复用，这个监听端口不能是6443，否则会冲突 proxy_pass k8s-apiserver; &#125;&#125;http &#123; log_format main &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27; &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27; &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;; access_log /var/log/nginx/access.log main; sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65; types_hash_max_size 2048; include /etc/nginx/mime.types; default_type application/octet-stream; server &#123; listen 80 default_server; server_name _; location / &#123; &#125; &#125;&#125; 12# 测试下nginx配置文件nginx -t 3、keepalive配置- centos07-12&#x2F;22 备份 - centos07-12&#x2F;221cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.confbak 主 keepalived，注意网卡名和ip地址 - centos07-12 #vrrp_script：指定检查nginx工作状态脚本（根据nginx状态判断是否故障转移）#virtual_ipaddress：虚拟IP（VIP） 123456789101112131415161718192021222324252627282930313233343536vim /etc/keepalived/keepalived.conf global_defs &#123; notification_email &#123; acassen@firewall.loc failover@firewall.loc sysadmin@firewall.loc &#125; notification_email_from Alexandre.Cassen@firewall.loc smtp_server 127.0.0.1 smtp_connect_timeout 30 router_id NGINX_MASTER&#125; vrrp_script check_nginx &#123; script &quot;/etc/keepalived/check_nginx.sh&quot;&#125;vrrp_instance VI_1 &#123; state MASTER interface enp0s3 # 修改为实际网卡名 virtual_router_id 51 # VRRP 路由 ID实例，每个实例是唯一的 priority 100 # 优先级，备服务器设置 90 advert_int 1 # 指定VRRP 心跳包通告间隔时间，默认1秒 authentication &#123; auth_type PASS auth_pass 1111 &#125; # 虚拟IP virtual_ipaddress &#123; 192.168.1.188/24 &#125; track_script &#123; check_nginx &#125; &#125; 1234567891011121314151617# 注：keepalived根据脚本返回状态码（0为工作正常，非0不正常）判断是否故障转移。vim /etc/keepalived/check_nginx.sh #!/bin/bash#1、判断Nginx是否存活counter=$(ps -ef |grep nginx | grep sbin | egrep -cv &quot;grep|$$&quot; )if [ $counter -eq 0 ]; then #2、如果不存活则尝试启动Nginx service nginx start sleep 2 #3、等待2秒后再次获取一次Nginx状态 counter=$(ps -ef |grep nginx | grep sbin | egrep -cv &quot;grep|$$&quot; ) #4、再次进行判断，如Nginx还不存活则停止Keepalived，让地址进行漂移 if [ $counter -eq 0 ]; then service keepalived stop fifi 1chmod +x /etc/keepalived/check_nginx.sh 备 keepalive - centos07-221234567891011121314151617181920212223242526272829303132333435vim /etc/keepalived/keepalived.conf global_defs &#123; notification_email &#123; acassen@firewall.loc failover@firewall.loc sysadmin@firewall.loc &#125; notification_email_from Alexandre.Cassen@firewall.loc smtp_server 127.0.0.1 smtp_connect_timeout 30 router_id NGINX_BACKUP&#125; vrrp_script check_nginx &#123; script &quot;/etc/keepalived/check_nginx.sh&quot;&#125;vrrp_instance VI_1 &#123; state BACKUP interface enp0s3 virtual_router_id 51 # VRRP 路由 ID实例，每个实例是唯一的 priority 90 advert_int 1 authentication &#123; auth_type PASS auth_pass 1111 &#125; virtual_ipaddress &#123; 192.168.1.188/24 &#125; track_script &#123; check_nginx &#125; &#125; 1234567891011121314151617# 注：keepalived根据脚本返回状态码（0为工作正常，非0不正常）判断是否故障转移。vim /etc/keepalived/check_nginx.sh #!/bin/bash#1、判断Nginx是否存活counter=$(ps -ef |grep nginx | grep sbin | egrep -cv &quot;grep|$$&quot; )if [ $counter -eq 0 ]; then #2、如果不存活则尝试启动Nginx service nginx start sleep 2 #3、等待2秒后再次获取一次Nginx状态 counter=$(ps -ef |grep nginx | grep sbin | egrep -cv &quot;grep|$$&quot; ) #4、再次进行判断，如Nginx还不存活则停止Keepalived，让地址进行漂移 if [ $counter -eq 0 ]; then service keepalived stop fifi 1chmod +x /etc/keepalived/check_nginx.sh 4、启动服务 - centos07-12&#x2F;22123456systemctl daemon-reloadyum install nginx-mod-stream -ysystemctl start nginxsystemctl start keepalivedsystemctl enable nginx keepalivedsystemctl status keepalived 测试vip是否绑定成功，停掉centos07-12上的keepalived，Vip会漂移到centos07-2212# 192.168.1.188在centos07-12的网卡上ip addr 123# 停止centos07-12的keepalivesystemctl stop keepalived# 虚拟ip自动转移到centos07-22上了 12# 启动centos07-12的keepalivesystemctl start keepalived 5、kubeadm初始化k8s集群 - centos07-12 在centos07-12上创建kubeadm-config.yaml文件123456789101112131415161718192021cd /root/vim kubeadm-config.yaml apiVersion: kubeadm.k8s.io/v1beta2kind: ClusterConfigurationkubernetesVersion: v1.20.6controlPlaneEndpoint: 192.168.1.188:16443imageRepository: registry.aliyuncs.com/google_containersapiServer: certSANs: - 192.168.1.12 - 192.168.1.22 - 192.168.1.42 - 192.168.1.188networking: podSubnet: 10.244.0.0/16 serviceSubnet: 10.96.0.0/16---apiVersion: kubeproxy.config.k8s.io/v1alpha1kind: KubeProxyConfigurationmode: ipvs mode: ipvs 表示kube-proxy代理模式是ipvs，如果不指定ipvs，会默认使用iptables，但是iptables效率低，所以我们生产环境建议开启ipvs，阿里云和华为云托管的K8s，也提供ipvs模式，如下： 使用kubeadm初始化k8s集群1、导入镜像 - centos07-12&#x2F;22&#x2F;431docker load -i k8simage-1-20-6.tar.gz 特别提醒：–image-repository registry.aliyuncs.com&#x2F;google_containers为保证拉取镜像不到国外站点拉取，手动指定仓库地址为registry.aliyuncs.com&#x2F;google_containers。kubeadm默认从k8s.gcr.io拉取镜像。 我们本地有导入到的离线镜像，所以会优先使用本地的镜像。 2、初始化k8s集群 - centos07-121kubeadm init --config kubeadm-config.yaml --ignore-preflight-errors=SystemVerification 重新初始化需要执行：kubeadm reset 显示如下，说明安装完成： 3、配置kubectl的配置文件config，相当于对kubectl进行授权，这样kubectl命令可以使用这个证书对k8s集群进行管理 - centos07-12123mkdir -p $HOME/.kubesudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/configsudo chown $(id -u):$(id -g) $HOME/.kube/config 12345# 此时集群状态还是NotReady状态，因为没有安装网络插件kubectl get nodesNAME STATUS ROLES AGE VERSIONcentos07-12 NotReady control-plane,master 5m6s v1.20.6 4、扩容k8s集群-添加master节点 在centos07-22创建证书存放目录1cd /root &amp;&amp; mkdir -p /etc/kubernetes/pki/etcd &amp;&amp;mkdir -p ~/.kube/ 把centos07-12节点的证书拷贝到centos07-22上12345678scp /etc/kubernetes/pki/ca.crt centos07-22:/etc/kubernetes/pki/scp /etc/kubernetes/pki/ca.key centos07-22:/etc/kubernetes/pki/scp /etc/kubernetes/pki/sa.key centos07-22:/etc/kubernetes/pki/scp /etc/kubernetes/pki/sa.pub centos07-22:/etc/kubernetes/pki/scp /etc/kubernetes/pki/front-proxy-ca.crt centos07-22:/etc/kubernetes/pki/scp /etc/kubernetes/pki/front-proxy-ca.key centos07-22:/etc/kubernetes/pki/scp /etc/kubernetes/pki/etcd/ca.crt centos07-22:/etc/kubernetes/pki/etcd/scp /etc/kubernetes/pki/etcd/ca.key centos07-22:/etc/kubernetes/pki/etcd/ 证书拷贝之后在centos07-22上执行如下命令，大家复制自己的，这样就可以把centos07-22和加入到集群，成为控制节点： 在centos07-12查看加入节点的命令： kubeadm token create - -print-join-command (双杠，浏览器有事复制有问题，自己打下)kubeadm join 192.168.1.188:16443 –token fk06dr.fh7dmugfqmpp7ktk –discovery-token-ca-cert-hash sha256:c01f613210804bccdf4906ba02c1e20c7317bdcf5d9180a9c6780a47456401e1添加失败，执行：kubeadm reset，就可以重新添加了token会自动过期 在centos07-22上执行1kubeadm join 192.168.1.188:16443 --token fseo5l.l4psip7pqmzc6m6t --discovery-token-ca-cert-hash sha256:c01f613210804bccdf4906ba02c1e20c7317bdcf5d9180a9c6780a47456401e1 --control-plane --ignore-preflight-errors=SystemVerification 在centos07-12上查看集群状况：123456# 上面可以看到centos07-22已经加入到集群了kubectl get nodesNAME STATUS ROLES AGE VERSIONcentos07-12 NotReady control-plane,master 39m v1.20.6centos07-22 NotReady &lt;none&gt; 18s v1.20.6 5、扩容k8s集群-添加node节点 在centos07-12上查看加入节点的命令：1kubeadm token create - -print-join-command 显示如下123kubeadm token create - -print-join-commandkubeadm join 192.168.1.188:16443 --token s6aq8g.reqwgku1pf5cvhiv --discovery-token-ca-cert-hash sha256:c01f613210804bccdf4906ba02c1e20c7317bdcf5d9180a9c6780a47456401e1 --discovery-token-ca-cert-hash 把centos07-42加入k8s集群1kubeadm join 192.168.1.188:16443 --token s6aq8g.reqwgku1pf5cvhiv --discovery-token-ca-cert-hash sha256:c01f613210804bccdf4906ba02c1e20c7317bdcf5d9180a9c6780a47456401e1 --discovery-token-ca-cert-hash 看到下面说明centos07-42节点已经加入到集群了,充当工作节点 在centos07-12上查看集群节点状况：123456kubectl get nodesNAME STATUS ROLES AGE VERSIONcentos07-12 NotReady control-plane,master 45m v1.20.6centos07-22 NotReady &lt;none&gt; 7m5s v1.20.6centos07-42 NotReady &lt;none&gt; 2m25s v1.20.6 可以看到centos07-42的ROLES角色为空，就表示这个节点是工作节点; 可以把centos07-42的ROLES变成work，按照如下方法1kubectl label node centos07-42 node-role.kubernetes.io/worker=worker 123456789101112[root@centos07-12 ~]# kubectl get nodesNAME STATUS ROLES AGE VERSIONcentos07-12 NotReady control-plane,master 102m v1.20.6centos07-42 NotReady &lt;none&gt; 58m v1.20.6[root@centos07-12 ~]# kubectl label node centos07-42 node-role.kubernetes.io/worker=workernode/centos07-42 labeled[root@centos07-12 ~]# kubectl get nodesNAME STATUS ROLES AGE VERSIONcentos07-12 NotReady control-plane,master 103m v1.20.6centos07-42 NotReady worker 60m v1.20.6 获取全部命名空间的pod - centos07-12 pending状态，这是因为还没有安装网络插件，等到下面安装好网络插件之后这个cordns就会变成running了 1kubectl get pods -n kube-system 12345678910[root@centos07-12 ~]# kubectl get pods -n kube-systemNAME READY STATUS RESTARTS AGEcoredns-7f89b7bc75-6rpcc 0/1 Pending 0 104mcoredns-7f89b7bc75-dhzb9 0/1 Pending 0 104metcd-centos07-12 1/1 Running 0 104mkube-apiserver-centos07-12 1/1 Running 1 104mkube-controller-manager-centos07-12 1/1 Running 0 104mkube-proxy-hjrl2 1/1 Running 0 61mkube-proxy-x2765 1/1 Running 0 104mkube-scheduler-centos07-12 1/1 Running 0 104m 注意：kubectl操作k8s时，走的是”&#x2F;root&#x2F;.kube&#x2F;config”，这个文件指定访问的k8s；kubectl访问k8s使用的是虚拟ip：1.188；别的机器安装kubectl，复制这个文件后，就可以操作k8s了查看方式如下：kubectl config view 12345678910111213141516171819apiVersion: v1clusters:- cluster: certificate-authority-data: DATA+OMITTED server: https://192.168.1.188:16443 # 虚拟ip name: kubernetescontexts:- context: cluster: kubernetes user: kubernetes-admin name: kubernetes-admin@kubernetescurrent-context: kubernetes-admin@kuberneteskind: Configpreferences: &#123;&#125;users:- name: kubernetes-admin user: client-certificate-data: REDACTED client-key-data: REDACTED 6、安装kubernetes网络组件-Calico - centos07-12 注：在线下载配置文件地址是： https://docs.projectcalico.org/manifests/calico.yaml 上传calico.yaml到centos07-12上，使用yaml文件安装calico 网络插件 1kubectl apply -f calico.yaml 安装calico后，coredns-* 从 pending 变为 running 1234567891011121314kubectl get pod -n kube-systemNAME READY STATUS RESTARTS AGEcalico-kube-controllers-6949477b58-9jmmc 1/1 Running 0 87scalico-node-bcs7b 1/1 Running 0 86scalico-node-dtfjt 1/1 Running 0 86scoredns-7f89b7bc75-6rpcc 1/1 Running 0 23hcoredns-7f89b7bc75-dhzb9 1/1 Running 0 23hetcd-centos07-12 1/1 Running 3 23hkube-apiserver-centos07-12 1/1 Running 3 23hkube-controller-manager-centos07-12 1/1 Running 8 23hkube-proxy-hjrl2 1/1 Running 1 22hkube-proxy-x2765 1/1 Running 2 23hkube-scheduler-centos07-12 1/1 Running 8 23h 再次查看集群状态，状态变为ready，STATUS状态是Ready，说明k8s集群正常运行了12345kubectl get nodesNAME STATUS ROLES AGE VERSIONcentos07-12 Ready control-plane,master 23h v1.20.6centos07-42 Ready worker 7、测试在k8s创建pod是否可以正常访问网络 把busybox-1-28.tar.gz上传到centos07-12节点，手动解压 123docker load -i busybox-1-28.tar.gzkubectl run busybox --image busybox:1.28 --restart=Never --rm -it busybox -- sh 通过下面面可以看到能访问网络，说明calico网络插件已经被正常安装了 1234/ # ping www.baidu.com # 输入PING www.baidu.com (39.156.66.18): 56 data bytes64 bytes from 39.156.66.18: seq=0 ttl=127 time=39.3 ms 8、测试coredns是否正常 注意：busybox要用指定的1.28版本，不能用最新版本，最新版本，nslookup会解析不到dns和ip 12345678kubectl run busybox --image busybox:1.28 --restart=Never --rm -it busybox --sh/ # nslookup kubernetes.default.svc.cluster.local # 输入Server: 10.96.0.10Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.localName: kubernetes.default.svc.cluster.localAddress 1: 10.96.0.1 kubernetes.default.svc.cluster.local nslookup kubernetes.default.svc.cluster.local怎么来的？service name + service所在名称空间（默认命名空间就是default） + 默认后缀（svc.cluster.local） 查看service name : kubectl get svc1234kubectl get svcNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGEkubernetes ClusterIP 10.96.0.1 &lt;none&gt; 443/TCP 24h 9、延长k8s证书 证书修改后会重启，影响业务 查看证书有效时间：1openssl x509 -in /etc/kubernetes/pki/ca.crt -noout -text |grep Not 显示如下，通过下面可看到ca证书有效期是10年，从2025到2035年：12Not Before: Apr 22 04:09:07 2025 GMTNot After : Apr 20 04:09:07 2035 GMT 显示如下，通过下面可看到apiserver证书有效期是1年，从2025到2026年： 1openssl x509 -in /etc/kubernetes/pki/apiserver.crt -noout -text |grep Not 12Not Before: Apr 22 04:09:07 2025 GMTNot After : Apr 22 04:09:07 2026 GMT 延长证书过期时间: - centos07-12&#x2F;22 把update-kubeadm-cert.sh文件上传centos07-12和centos07-22节点，在centos07-12和centos07-22上执行如下： 12345# 1）给update-kubeadm-cert.sh证书授权可执行权限chmod +x update-kubeadm-cert.sh# 2）执行下面命令，修改证书过期时间，把时间延长到10年./update-kubeadm-cert.sh all 在centos07-12节点查询Pod是否正常,能查询出数据说明证书签发完成1kubectl get pods -n kube-system 显示如下，能够看到pod信息，说明证书签发正常123.....calico-node-b5ks5 1/1 Running 0 157mcalico-node-r6bfr 1/1 Running 0 155m 验证证书有效时间是否延长到10年12345openssl x509 -in /etc/kubernetes/pki/ca.crt -noout -text |grep Not# 显示如下，通过下面可看到ca证书有效期是10年，从2025到2035年：Not Before: Apr 22 04:09:07 2025 GMTNot After : Apr 20 04:09:07 2035 GMT 12345openssl x509 -in /etc/kubernetes/pki/apiserver.crt -noout -text |grep Not# 显示如下，通过下面可看到apiserver证书有效期是10年，从2025到2035年：Not Before: Apr 22 11:15:53 2025 GMTNot After : Apr 20 11:15:53 2035 GMT","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"00-kubernetes基础知识扩展.","slug":"运维/K8S/基础/00-kubernetes基础知识扩展","date":"2023-04-30T18:00:52.000Z","updated":"2024-02-02T03:42:24.000Z","comments":true,"path":"2023/05/01/运维/K8S/基础/00-kubernetes基础知识扩展/","link":"","permalink":"https://dbbruce.github.io/2023/05/01/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/00-kubernetes%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E6%89%A9%E5%B1%95/","excerpt":"知识扩展Containerd 常见命令操作更换 Containerd 后，以往我们常用的 docker 命令也不再使用，取而代之的分别是 crictl 和 ctr 两个命令客户端。crictl 是遵循 CRI 接口规范的一个命令行工具，通常用它来检查和管理kubelet节点上的容器运行时和镜像。ctr 是 containerd 的一个客户端工具。ctr -v 输出的是 containerd 的版本，crictl -v 输出的是当前 k8s 的版本，从结果显而易见你可以认为 crictl 是用于 k8s 的。一般来说你某个主机安装了 k8s 后，命令行才会有 crictl 命令。而 ctr 是跟 k8s 无关的，你主机安装了 containerd 服务后就可以操作 ctr 命令。","text":"知识扩展Containerd 常见命令操作更换 Containerd 后，以往我们常用的 docker 命令也不再使用，取而代之的分别是 crictl 和 ctr 两个命令客户端。crictl 是遵循 CRI 接口规范的一个命令行工具，通常用它来检查和管理kubelet节点上的容器运行时和镜像。ctr 是 containerd 的一个客户端工具。ctr -v 输出的是 containerd 的版本，crictl -v 输出的是当前 k8s 的版本，从结果显而易见你可以认为 crictl 是用于 k8s 的。一般来说你某个主机安装了 k8s 后，命令行才会有 crictl 命令。而 ctr 是跟 k8s 无关的，你主机安装了 containerd 服务后就可以操作 ctr 命令。 docker | ctr（containerd）| crictl（kubernetes） 命令 docker ctr（containerd） crictl（kubernetes） 查看运行的容器 docker ps ctr task ls&#x2F;ctr container ls crictl ps 查看镜像 docker images ctr image ls crictl images 查看容器日志 docker logs 无 crictl logs 查看容器数据信息 docker inspect ctr container info crictl inspect 查看容器资源 docker stats 无 crictl stats 启动&#x2F;关闭已有的容器 docker start&#x2F;stop ctr task start&#x2F;kill crictl start&#x2F;stop 运行一个新的容器 docker run ctr run 无 （最小单元为 pod） 打标签 docker tag ctr image tag 无 创建一个新的容器 docker create ctr container create crictl create 导入镜像 docker load ctr image import 无 导出镜像 docker save ctr image export 无 删除容器 docker rm ctr container rm crictl rm 删除镜像 docker rmi ctr image rm crictl rmi 拉取镜像 docker pull ctr image pull crictl pull 推送镜像 docker push ctr image push 无 登录或在容器内部执行命令 docker exec 无 crictl exec 清空不用的容器 docker image prune 无 crictl rmi –prune 指令介绍 查看资源信息类指令12345678910111213141516171819202122232425kubectl get pods # 获取pod列表kubectl get pods -n ingress-nginx # 获取指定名称空间pod列表kubectl get pods -o wide # 获取pod详细信息kubectl get pods --show-labels # 获取pod并查看pod标签kubectl get pod -w # 监视pod资源变动信息kubectl get pods -A|grep -v Running # 获取集群所有非Running状态podkubectl get pods,services -o wide # 格式化输出pod及services信息kubectl exec podname env # 查看运行的pod的环境变量kubectl describe pods podname --namespace=xxxnamespace # 查看指定名称空间下指定pod的详细信息kubectl logs podname kubectl logs podname -f -c container_name -n kube-system # 查看pod日志(-f 持续监控，-c如果pod中只有一个容器不用加)kubectl get namespaces # 查看集群内所有名称空间kubectl get cs # 查看集群健康状态kubectl get events # 查看事件kubectl get nodes # 查看集群全部节点kubectl get deployment --all-namespaces/-A # 查看集群内所有deploymentkubectl get deployments deployment_name --watch # 监控deployment的更新过程kubectl get rc,services # 查看集群默认名称空间的副本控制器和serviceskubectl get pods podname -o yaml # 查看pod的yaml信息kubectl version --short=true # 查看客户端及服务端程序版本信息kubectl api-versions # 查看api版本信息kubectl cluster-info # 查看集群信息kubectl top nodes #查看节点资源使用情况(集群内需安装metric-server组件)kubectl top pod --all-namespaces # 查看pod资源使用率kubectl config view # 显示合并的kubeconfig配置 查看 deploy 的资源分配情1kubectl get pod -o=custom-columns=name:.metadata.name,ns:.metadata.namespace,request-cpu:.spec.containers[0].resources.requests.cpu,limit-cpu:.spec.containers[0].resources.limits.cpu,request-memory:.spec.containers[0].resources.requests.memory,limit-memory:.spec.containers[0].resources.limits.memory,nodeName:.spec.nodeName,node:.spec.nodeName,affinity:.spec.affinity 操作编辑类指令123456789101112131415161718kubectl drain &lt;nodename&gt; --force --ignore-daemonsets # 排空节点忽略daemonsets应用并设置节点为不可调度kubectl uncordon &lt;nodename&gt; # 将节点设置为可调度kubectl scale deployment --replicas=&lt;期望pod数&gt; # 扩缩容pod数kubectl rollout history deployments deployment-demo # 查看历史版本# 创建一个名字为nginx-demo 副本数为3 标签为app=nginx_demo 镜像为nginx:1.17 容器端口为80的容器实例kubectl run nginx-demo --replicas=3 --labels=&quot;app=nginx_demo&quot; --image=nginx:1.17 --port=80# 为容器组nginx-demo创建一个services端口类型为nodeportr 暴漏的端口为88可以让外部可以访问kubectl expose deployment nginx-demo --port=88 --type=NodePort --target-port=80 --name=nginx-svc# 设置容器组nginx-demo中所有容器的request(请求)和limit(限制)值kubectl set resources deployment nginx-demo - --limits=cpu=200m,memory=512Mi# 将deployment中的nginx-demo容器镜像修改为nginx-1.10kubectl set image deployment/nginx-demo busybox=busybox nginx=nginx:1.10# 编辑deployment中nginx-demo的资源信息kubectl edit deployment nginx-demo# 给pod名为nginx-demo的pod打标签kubectl label pods nginx-demo app=nginx# 覆盖现有标签的valuekubectl label --overwrite pods nginx-demo app=nginx2 复制pod内文件到宿主机方法一使用kubectl cp命令:这边要注意的是k8s复制的时候不要用绝对路径，他这个默认是从工作目录开始的，#还有要注意的是目标路径不能为路径，只能是一个文件名 1kubectl cp -n namespace xxxxx:logs/testfile ./testfile.txt (namespace: 为pod所在名称空间 xxxxx：是pod的名称) 方法二使用docker cp： 12345#需要进入pod所在node节点服务器中#查找到pod所运行的docker container iddocker ps -a|grep test-app-name#然后cp 容器内文件到宿主机docker cp container id:dir/filename ./tmp 将宿主机文件复制到pod中1kubectl cp -n &lt;本地宿主机的文件路径&gt; namespace xxxxx:logs/testfile (namespace: 为pod所在名称空间 xxxxx：是pod的名称) k8s添加本地hosts解析注意层级 1234hostAliases: - ip: 192.168.1.135 hostnames: - &quot;test.app.com&quot; 删除资源类命令12345kubectl delete -f demo-deployment.yaml # 根据yaml文件删除对应资源，只删除资源不删除yaml文件kubectl delete node &lt;nodename&gt; # 删除node节点kubectl delete &lt;resources_name&gt; # 删除指定资源# 批量删除驱逐状态podkubectl get pods -n namespace | grep Evicted| awk &#x27;&#123;print $1&#125;&#x27; | xargs -n 1 kubectl delete pods -n namespace 创建资源类命令12#创建ingress tls证书kubectl create secret tls \\&lt;tls-name\\&gt; --cert=\\&lt;/tls/xxx.crt\\&gt; --key=\\&lt;/tls/xxxxx.key\\&gt; --namespace=xxx kubelet、kubectl 和 kubeadm 是 Kubernetes 中的三个不同组件，各自具有不同的作用和功能： kubelet：kubelet 是运行在每个节点上的主要组件之一。它负责管理节点上的容器和 Pod。具体作用包括： 与控制平面通信，接收来自 API Server 的指令，以及将节点上的状态报告给控制平面。 监控分配给节点的 Pod，并确保它们按照所定义的规范运行。 拉取容器镜像并启动容器。 挂载和管理容器的卷和数据卷。 处理节点上的资源限制和容器的健康检查。 kubectl：kubectl 是 Kubernetes 的命令行工具，用于与 Kubernetes 集群进行交互和管理。它允许用户执行各种操作，包括： 创建、管理和删除各种 Kubernetes 资源，如 Pod、Deployment、Service 等。 查看集群状态和资源信息。 执行命令和操作，如在 Pod 中执行命令、查看日志等。 调试和故障排除，如描述资源、查看事件等。 kubeadm：kubeadm 是 Kubernetes 的引导工具，用于在新的集群中初始化和设置主控节点（Master Node）。它的主要功能包括： 初始化主控节点，并生成所需的证书和密钥。 加入其他节点到集群中。 设置所需的网络插件和容器运行时（如CRI-O、Docker）。 提供了一组命令行工具，以便用户管理和维护集群的各个方面。以下是一些使用 kubectl的具体案例和示例命令： 创建和管理资源 1、创建一个pod kubectl create pod mypod –image&#x3D;nginx 2、使用配置文件创建或更新一个Deployment kubectl apply -f deployment.yaml 3、获取所有Pod的列表 kubectl get pods 4、删除一个Service： kubectl delete service myservice 资源管理 1、调整Deployment的副本数为3： kubectl scale deployment mydeployment –replicas&#x3D;3 2、暴露一个Deployment的服务给外部访问： kubectl expose deployment mydeployment –port&#x3D;80 –target-port&#x3D;8080 3、为一个Pod添加标签 kubectl label pod mypod app&#x3D;backend 4、为一个Deployment添加注释： kubectl annotate deployment mydeployment description&#x3D;”Production deployment 集群信息 1、查看集群的信息： kubectl cluster-info 2、获取所有节点的列表 kubectl get nodes 3、获取特定命名空间的Pod列表 kubectl get pods -n mynamespace 4、获取是有命名空间的Pod列表 kubectl get pods –all-namespaces 调试和故障排 1、查看Pod的 kubectl logs mypod 2、在Pod中执行一个命令 kubectl exec mypod – ls &#x2F;app 3、查看Pod的详细信息： kubectl describe pod mypod 4、查看Service的详细信 kubectl describe service myservice 5、查看节点的详细信 kubectl describe node mynode nodePort，targetPort，port的区别和意义 nodePort 外部机器可访问的端口。比如一个Web应用需要被其他用户访问，那么需要配置type&#x3D;NodePort，而且配置nodePort&#x3D;30001，那么其他机器就可以通过浏览器访问scheme:&#x2F;&#x2F;node:30001访问到该服务，例如http://node:30001。 例如MySQL数据库可能不需要被外界访问，只需被内部服务访问，那么不必设置NodePort targetPort 容器的端口（最根本的端口入口），与制作容器时暴露的端口一致（DockerFile中EXPOSE），例如docker.io官方的nginx暴露的是80端口。 docker.io官方的nginx容器的DockerFile参考https://github.com/nginxinc/docker-nginx port kubernetes中的服务之间访问的端口，尽管mysql容器暴露了3306端口（https://github.com/docker-library/mysql/的DockerFile），但是集群内其他容器需要通过33306端口访问该服务，外部机器不能访问mysql服务，因为他没有配置NodePort类型 k8s 1.24前后版本区别k8s 1.24 之前，1.23使用容器运行时：docker；镜像导入：docker load -i *.tar.gz;k8s.1.24 之后，容器运行时: containerd；镜像导入：ctr -n&#x3D;k8s.io images import *.tar.gz;使用 ctr拉取镜像，必须写完整的镜像地址（地址+项目+镜像名+版本）: ctr -n&#x3D;k8s.io images pull docker.io&#x2F;library&#x2F;centos:latest使用docker拉镜像：docker pull nginx 查找所有命名空间中的pod，svckubectl get svc –all-namespaceskubectl get svc -A 123456789101112131415[root@centos07-12 manifests]# kubectl get pods --all-namespaces -owideNAMESPACE NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESkube-system calico-kube-controllers-677cd97c8d-j2782 1/1 Running 0 48m 10.244.193.131 centos07-22 &lt;none&gt; &lt;none&gt;kube-system calico-node-hs9h5 1/1 Running 0 48m 192.168.1.42 centos07-42 &lt;none&gt; &lt;none&gt;kube-system calico-node-pt9md 1/1 Running 0 48m 192.168.1.12 centos07-12 &lt;none&gt; &lt;none&gt;kube-system calico-node-xddmf 1/1 Running 0 48m 192.168.1.22 centos07-22 &lt;none&gt; &lt;none&gt;kube-system coredns-6d8c4cb4d-dgw22 1/1 Running 0 88m 10.244.193.129 centos07-22 &lt;none&gt; &lt;none&gt;kube-system coredns-6d8c4cb4d-j4c6b 1/1 Running 0 88m 10.244.193.130 centos07-22 &lt;none&gt; &lt;none&gt;kube-system etcd-centos07-12 1/1 Running 0 88m 192.168.1.12 centos07-12 &lt;none&gt; &lt;none&gt;kube-system kube-apiserver-centos07-12 1/1 Running 0 88m 192.168.1.12 centos07-12 &lt;none&gt; &lt;none&gt;kube-system kube-controller-manager-centos07-12 1/1 Running 0 88m 192.168.1.12 centos07-12 &lt;none&gt; &lt;none&gt;kube-system kube-proxy-4nx9c 1/1 Running 0 81m 192.168.1.22 centos07-22 &lt;none&gt; &lt;none&gt;kube-system kube-proxy-v87c6 1/1 Running 0 88m 192.168.1.12 centos07-12 &lt;none&gt; &lt;none&gt;kube-system kube-proxy-v9lx5 1/1 Running 0 74m 192.168.1.42 centos07-42 &lt;none&gt; &lt;none&gt;kube-system kube-scheduler-centos07-12 1/1 Running 0 88m 192.168.1.12 centos07-12 &lt;none&gt; &lt;none&gt; 1234[root@centos07-12 manifests]# kubectl get svc --all-namespacesNAMESPACE NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGEdefault kubernetes ClusterIP 10.96.0.1 &lt;none&gt; 443/TCP 88mkube-system kube-dns ClusterIP 10.96.0.10 &lt;none&gt; 53/UDP,53/TCP,9153/TCP 88m 查看 podSubnet 网段， serviceSubnet 网段serviceSubnet（service网段): 1234vim kube-apiserver.yaml--service-cluster-ip-range=10.96.0.0/12 podSubnet（pod网段）: 123vim kube-controller-manager.yaml --cluster-cidr=10.244.0.0/16 角色和绑定方法的区别1234567角色：Role: 针对单个命名空间的权限控制ClusterRole：针对集群的权限控制绑定方式：RoleBinding: 使用 RoleBinding 对 User 和权限（可以是 Role 或 ClusterRole）绑定，用户只能操作 RoleBinding 所在的命名空间。ClusterRoleBinding: 通过 ClusterRoleBinding 将 User 和 ClusterRole 进行绑定，User 有操作所有命名空间的权限 查看kubernetes相关配置信息123456789[root@centos07-12 manifests]# pwd/etc/kubernetes/manifests[root@centos07-12 manifests]# ll总用量 16-rw------- 1 root root 2248 12月 24 22:34 etcd.yaml-rw------- 1 root root 3367 12月 24 22:34 kube-apiserver.yaml-rw------- 1 root root 2878 12月 24 22:34 kube-controller-manager.yaml-rw------- 1 root root 1464 12月 24 22:34 kube-scheduler.yaml","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"00-kubernetes常用命令","slug":"运维/K8S/基础/00-kubernetes常用命令","date":"2023-04-30T16:00:59.000Z","updated":"2024-02-16T14:52:47.000Z","comments":true,"path":"2023/05/01/运维/K8S/基础/00-kubernetes常用命令/","link":"","permalink":"https://dbbruce.github.io/2023/05/01/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/00-kubernetes%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/","excerpt":"","text":"集群信息：1234567显示 Kubernetes 版本：kubectl version显示集群信息：kubectl cluster-info要进一步调试和诊断集群问题：kubectl cluster-info dump列出集群中的所有节点：kubectl get nodes查看一个具体的节点详情：kubectl describe node &lt;node-name&gt;列出所有命名空间：kubectl get namespaces列出所有命名空间中的所有 pod：kubectl get pods --all-namespaces === kubectl get pods -A Pod 诊断：12345列出特定命名空间中的 pod：kubectl get pods -n &lt;namespace&gt;查看一个 Pod 详情：kubectl describe pod &lt;pod-name&gt; -n &lt;namespace&gt;查看 Pod 日志：kubectl logs &lt;pod-name&gt; -n &lt;namespace&gt;尾部 Pod 日志：kubectl logs -f &lt;pod-name&gt; -n &lt;namespace&gt;在 pod 中执行命令：kubectl exec -it &lt;pod-name&gt; -n &lt;namespace&gt; -- &lt;command&gt; Pod 健康检查：12检查 Pod 准备情况：kubectl get pods &lt;pod-name&gt; -n &lt;namespace&gt; -o jsonpath=&#x27;&#123;.status.conditions[?(@.type==&quot;Ready&quot;)].status&#125;&#x27;检查 Pod 事件：kubectl get events -n &lt;namespace&gt; --field-selector involvedObject.name=&lt;pod-name&gt; Service诊断：12列出命名空间中的所有服务：kubectl get svc -n &lt;namespace&gt;查看一个服务详情：kubectl describe svc &lt;service-name&gt; -n &lt;namespace&gt; Deployment诊断：1234列出命名空间中的所有Deployment：kubectl get deployments -n &lt;namespace&gt;查看一个Deployment详情：kubectl describe deployment &lt;deployment-name&gt; -n &lt;namespace&gt;查看滚动发布状态：kubectl rollout status deployment/&lt;deployment-name&gt; -n &lt;namespace&gt;查看滚动发布历史记录：kubectl rollout history deployment/&lt;deployment-name&gt; -n &lt;namespace&gt; StatefulSet诊断：12列出命名空间中的所有 StatefulSet：kubectl get statefulsets -n &lt;namespace&gt;查看一个 StatefulSet详情：kubectl describe statefulset &lt;statefulset-name&gt; -n &lt;namespace&gt; ConfigMap 和Secret诊断：1234列出命名空间中的 ConfigMap：kubectl get configmaps -n &lt;namespace&gt;查看一个ConfigMap详情：kubectl describe configmap &lt;configmap-name&gt; -n &lt;namespace&gt;列出命名空间中的 Secret：kubectl get secrets -n &lt;namespace&gt;查看一个Secret详情：kubectl describe secret &lt;secret-name&gt; -n &lt;namespace&gt; 命名空间诊断：12查看一个命名空间详情：kubectl describe namespace &lt;namespace-name&gt; 资源使用情况：12检查 pod 的资源使用情况：kubectl top pod &lt;pod-name&gt; -n &lt;namespace&gt;检查节点资源使用情况：kubectl top nodes 网络诊断：123显示命名空间中 Pod 的 IP 地址：kubectl get pods -n &lt;namespace&gt; -o custom-columns=POD:metadata.name,IP:status.podIP --no-headers列出命名空间中的所有网络策略：kubectl get networkpolicies -n &lt;namespace&gt;查看一个网络策略详情：kubectl describe networkpolicy &lt;network-policy-name&gt; -n &lt;namespace&gt; 持久卷 (PV) 和持久卷声明 (PVC) 诊断：1234列出PV：kubectl get pv查看一个PV详情：kubectl describe pv &lt;pv-name&gt;列出命名空间中的 PVC：kubectl get pvc -n &lt;namespace&gt;查看PVC详情：kubectl describe pvc &lt;pvc-name&gt; -n &lt;namespace&gt; 节点诊断：12获取特定节点上运行的 Pod 列表：kubectl get pods --field-selector spec.nodeName=&lt;node-name&gt; -n &lt;namespace&gt; 资源配额和限制：12列出命名空间中的资源配额：kubectl get resourcequotas -n &lt;namespace&gt;查看一个资源配额详情：kubectl describe resourcequota &lt;resource-quota-name&gt; -n &lt;namespace&gt; 自定义资源定义 (CRD) 诊断：1234列出命名空间中的自定义资源：kubectl get &lt;custom-resource-name&gt; -n &lt;namespace&gt;查看自定义资源详情：kubectl describe &lt;custom-resource-name&gt; &lt;custom-resource-instance-name&gt; -n &lt;namespace&gt;使用这些命令时，请记住将&lt;namespace&gt;, &lt;pod-name&gt;, &lt;service-name&gt;, &lt;deployment-name&gt;, &lt;statefulset-name&gt;, &lt;configmap-name&gt;, &lt;secret-name&gt;, &lt;namespace-name&gt;, &lt;pv-name&gt;, &lt;pvc-name&gt;, &lt;node-name&gt;, &lt;network-policy-name&gt;, &lt;resource-quota-name&gt;, &lt;custom-resource-name&gt;, 和替换为你的特定值。&lt;custom-resource-instance-name&gt;这些命令应该可以帮助你诊断 Kubernetes 集群以及在其中运行的应用程序。 资源伸缩和自动伸缩123Deployment伸缩：kubectl scale deployment &lt;deployment-name&gt; --replicas=&lt;replica-count&gt; -n &lt;namespace&gt;设置Deployment的自动伸缩：kubectl autoscale deployment &lt;deployment-name&gt; --min=&lt;min-pods&gt; --max=&lt;max-pods&gt; --cpu-percent=&lt;cpu-percent&gt; -n &lt;namespace&gt;检查水平伸缩器状态：kubectl get hpa -n &lt;namespace&gt; 作业和 CronJob 诊断：1234列出命名空间中的所有作业：kubectl get jobs -n &lt;namespace&gt;查看一份工作详情：kubectl describe job &lt;job-name&gt; -n &lt;namespace&gt;列出命名空间中的所有 cron 作业：kubectl get cronjobs -n &lt;namespace&gt;查看一个 cron 作业详情：kubectl describe cronjob &lt;cronjob-name&gt; -n &lt;namespace&gt; 容量诊断：123列出按容量排序的持久卷 (PV)：kubectl get pv --sort-by=.spec.capacity.storage查看PV回收策略：kubectl get pv &lt;pv-name&gt; -o=jsonpath=&#x27;&#123;.spec.persistentVolumeReclaimPolicy&#125;&#x27;列出所有存储类别：kubectl get storageclasses Ingress和服务网格诊断：1234列出命名空间中的所有Ingress：kubectl get ingress -n &lt;namespace&gt;查看一个Ingress详情：kubectl describe ingress &lt;ingress-name&gt; -n &lt;namespace&gt;列出命名空间中的所有 VirtualServices (Istio)：kubectl get virtualservices -n &lt;namespace&gt;查看一个 VirtualService (Istio)详情：kubectl describe virtualservice &lt;virtualservice-name&gt; -n &lt;namespace&gt; Pod 网络故障排除：1234运行网络诊断 Pod（例如 busybox）进行调试：kubectl run -it --rm --restart=Never --image=busybox net-debug-pod -- /bin/sh测试从 Pod 到特定端点的连接：kubectl exec -it &lt;pod-name&gt; -n &lt;namespace&gt; -- curl &lt;endpoint-url&gt;跟踪从一个 Pod 到另一个 Pod 的网络路径：kubectl exec -it &lt;source-pod-name&gt; -n &lt;namespace&gt; -- traceroute &lt;destination-pod-ip&gt;检查 Pod 的 DNS 解析：kubectl exec -it &lt;pod-name&gt; -n &lt;namespace&gt; -- nslookup &lt;domain-name&gt; 配置和资源验证：12验证 Kubernetes YAML 文件而不应用它：kubectl apply --dry-run=client -f &lt;yaml-file&gt;验证 pod 的安全上下文和功能：kubectl auth can-i list pods --as=system:serviceaccount:&lt;namespace&gt;:&lt;serviceaccount-name&gt; RBAC 和安全性：12列出命名空间中的角色和角色绑定：kubectl get roles,rolebindings -n &lt;namespace&gt;查看角色或角色绑定详情：kubectl describe role &lt;role-name&gt; -n &lt;namespace&gt; 服务帐户诊断：12列出命名空间中的服务帐户：kubectl get serviceaccounts -n &lt;namespace&gt;查看一个服务帐户详情：kubectl describe serviceaccount &lt;serviceaccount-name&gt; -n &lt;namespace&gt; 清空节点和解除封锁：12清空节点以进行维护：kubectl drain &lt;node-name&gt; --ignore-daemonsets解除对节点的封锁：kubectl uncordon &lt;node-name&gt; 资源清理：12强制删除 pod（不推荐）：kubectl delete pod &lt;pod-name&gt; -n &lt;namespace&gt; --grace-period=0 --force Pod 亲和性和反亲和性：12列出 pod 的 pod 亲和性规则：kubectl get pod &lt;pod-name&gt; -n &lt;namespace&gt; -o=jsonpath=&#x27;&#123;.spec.affinity&#125;&#x27;列出 pod 的 pod 反亲和性规则：kubectl get pod &lt;pod-name&gt; -n &lt;namespace&gt; -o=jsonpath=&#x27;&#123;.spec.affinity.podAntiAffinity&#125;&#x27; Pod 安全策略 (PSP)：12列出所有 Pod 安全策略（如果启用）：kubectl get psp 事件：12查看最近的集群事件：kubectl get events --sort-by=.metadata.creationTimestamp按特定命名空间过滤事件：kubectl get events -n &lt;namespace&gt; 节点故障排除：12检查节点情况：kubectl describe node &lt;node-name&gt; | grep Conditions -A5列出节点容量和可分配资源：kubectl describe node &lt;node-name&gt; | grep -E &quot;Capacity|Allocatable&quot; 临时容器（Kubernetes 1.18+）：12运行临时调试容器：kubectl debug -it &lt;pod-name&gt; -n &lt;namespace&gt; --image=&lt;debug-image&gt; -- /bin/sh 资源指标（需要指标服务器）：12获取 Pod 的 CPU 和内存使用情况：kubectl top pod -n &lt;namespace&gt; kuelet诊断：12查看节点上的kubelet日志：kubectl logs -n kube-system kubelet-&lt;node-name&gt; 使用Telepresence 进行高级调试：12使用 Telepresence 调试 pod：telepresence --namespace &lt;namespace&gt; --swap-deployment &lt;pod-name&gt; Kubeconfig 和上下文：12列出可用的上下文：kubectl config get-contexts切换到不同的上下文：kubectl config use-context &lt;context-name&gt; Pod 安全标准（PodSecurity 准入控制器）：12列出 PodSecurityPolicy (PSP) 违规行为：kubectl get psp -A | grep -vE &#x27;NAME|REVIEWED&#x27; Pod 中断预算 (PDB) 诊断：12列出命名空间中的所有 PDB：kubectl get pdb -n &lt;namespace&gt;查看一个PDB详情：kubectl describe pdb &lt;pdb-name&gt; -n &lt;namespace&gt; 资源锁诊断（如果使用资源锁）：12列出命名空间中的资源锁：kubectl get resourcelocks -n &lt;namespace&gt; 服务端点和 DNS：12列出服务的服务端点：kubectl get endpoints &lt;service-name&gt; -n &lt;namespace&gt;检查 Pod 中的 DNS 配置：kubectl exec -it &lt;pod-name&gt; -n &lt;namespace&gt; -- cat /etc/resolv.conf 自定义指标（Prometheus、Grafana）：12查询Prometheus指标：用于kubectl port-forward访问Prometheus和Grafana服务来查询自定义指标。 Pod 优先级和抢占：12列出优先级：kubectl get priorityclasses Pod 开销（Kubernetes 1.18+）：12列出 pod 中的开销：kubectl get pod &lt;pod-name&gt; -n &lt;namespace&gt; -o=jsonpath=&#x27;&#123;.spec.overhead&#125;&#x27; 存储卷快照诊断（如果使用存储卷快照）：12列出存储卷快照：kubectl get volumesnapshot -n &lt;namespace&gt;查看存储卷快照详情：kubectl describe volumesnapshot &lt;snapshot-name&gt; -n &lt;namespace&gt; 资源反序列化诊断：12反序列化并打印 Kubernetes 资源：kubectl get &lt;resource-type&gt; &lt;resource-name&gt; -n &lt;namespace&gt; -o=json 节点污点：12列出节点污点：kubectl describe node &lt;node-name&gt; | grep Taints 更改和验证 Webhook 配置：12列出变异 webhook 配置：kubectl get mutatingwebhookconfigurations列出验证 Webhook 配置：kubectl get validatingwebhookconfigurations Pod 网络策略：12列出命名空间中的 pod 网络策略：kubectl get networkpolicies -n &lt;namespace&gt; 节点条件（Kubernetes 1.17+）：1自定义查询输出：kubectl get nodes -o custom-columns=NODE:.metadata.name,READY:.status.conditions[?(@.type==&quot;Ready&quot;)].status -l &#x27;node-role.kubernetes.io/worker=&#x27; 审核日志：1检索审核日志（如果启用）：检查 Kubernetes 审核日志配置以了解审核日志的位置。 节点操作系统详细信息：12获取节点的操作系统信息：kubectl get node &lt;node-name&gt; -o jsonpath=&#x27;&#123;.status.nodeInfo.osImage&#125;&#x27;这些命令应该涵盖 Kubernetes 中的各种诊断场景。确保将&lt;namespace&gt;、&lt;pod-name&gt;、&lt;deployment-name&gt;等占位符替换为你的集群和用例的实际值。","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"00-kubernetes简介","slug":"运维/K8S/基础/00-kubernetes简介","date":"2023-04-30T16:00:52.000Z","updated":"2023-12-05T02:55:30.000Z","comments":true,"path":"2023/05/01/运维/K8S/基础/00-kubernetes简介/","link":"","permalink":"https://dbbruce.github.io/2023/05/01/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/00-kubernetes%E7%AE%80%E4%BB%8B/","excerpt":"Kubernetes简介Kubernetes单词起源于希腊语, 是“舵手”或者“领航员、飞行员”的意思。","text":"Kubernetes简介Kubernetes单词起源于希腊语, 是“舵手”或者“领航员、飞行员”的意思。 K8s的物理架构是master&#x2F;node模式 Master节点是集群的控制节点，负责整个集群的管理和控制，主节点主要用于暴露API，调度部署和节点的管理 工作节点主要是运行容器的 多master节点架构图如下 什么是控制器12345678kubernetes中内建了很多controller（控制器），这些相当于一个状态机，用来控制pod的具体状态和行为。部分控制器类型如下：ReplicationController 和 ReplicaSetDeploymentDaemonSetStatefulSetJob/CronJobHorizontalPodAutoscaler 组件介绍 kubectl：管理K8s的命令行工具，可以操作K8s中的资源对象。 etcd： 是一个高可用的键值数据库，存储K8s的资源状态信息和网络信息的，etcd中的数据变更是通过api server进行的。 apiserver: 提供K8s api，是整个系统的对外接口，提供资源操作的唯一入口，供客户端和其它组件调用，提供了K8s各类资源对象（pod,deployment,Service等）的增删改查，是整个系统的数据总线和数据中心，并提供认证、授权、访问控制、API注册和发现等机制，并将操作对象持久化到etcd中。相当于“营业厅”。 scheduler：负责K8s集群中pod的调度的 ， scheduler通过与apiserver交互监听到创建Pod副本的信息后，它会检索所有符合该Pod要求的工作节点列表，开始执行Pod调度逻辑。调度成功后将Pod绑定到目标节点上，相当于“调度室”。 controller-manager：与apiserver交互，实时监控和维护K8s集群的控制器的健康情况，对有故障的进行处理和恢复，相当于“大总管”。 kubelet： 每个Node节点上的kubelet定期就会调用API Server的REST接口报告自身状态，API Server接收这些信息后，将节点状态信息更新到etcd中。kubelet也通过API Server监听Pod信息，从而对Node机器上的POD进行管理，如创建、删除、更新Pod kube-proxy：提供网络代理和负载均衡，是实现service的通信与负载均衡机制的重要组件，kube-proxy负责为Pod创建代理服务，从apiserver获取所有service信息，并根据service信息创建代理服务，实现service到Pod的请求路由和转发，从而实现K8s层级的虚拟转发网络，将到service的请求转发到后端的pod上。 Kubernetes中的资源对象 Pod Pod是Kubernetes中的最小调度单元，当指派容器时，容器实际上并不会指派到物理硬件上，容器会被分配到一个Pod里。Pod代表集群上正在运行的一个进程，一个Pod封装一个容器（也可以封装多个容器），Pod里的容器共享存储、网络等。也就是说，应该把整个pod看作虚拟机，然后每个容器相当于运行在虚拟机的进程。白话解释：可以把pod看成是一个“豌豆荚”，里面有很多“豆子”（容器）。一个豌豆荚里的豆子，它们吸收着共同的营养成分、肥料、水分等，Pod和容器的关系也是一样，Pod里面的容器共享pod的空间、资源、网络、存储等。 Replicaset Kubernetes中的副本控制器，管理Pod，使pod副本的数量始终维持在预设的个数。 Deployment 管理Replicaset和Pod的副本控制器，Deployment可以管理多个Replicaset，是比Replicaset更高级的控制器，也即是说在创建Deployment的时候，会自动创建Replicaset，由Replicaset再创建Pod，Deployment能对Pod扩容、缩容、滚动更新和回滚、维持Pod数量。 Service 在kubernetes中，Pod是有生命周期的，如果Pod重启IP很有可能会发生变化。如果我们的服务都是将Pod的IP地址写死，Pod的挂掉或者重启，和刚才重启的pod相关联的其他服务将会找不到它所关联的Pod，为了解决这个问题，在kubernetes中定义了service资源对象，Service 定义了一个服务访问的入口，客户端通过这个入口即可访问服务背后的应用集群实例，service是一组Pod的逻辑集合，这一组 Pod 能够被 Service 访问到，通常是通过 Label Selector实现的。可以看下面的图： StatefulSet 是一个Kubernetes资源对象，它提供了一种方法来管理有状态应用程序。它是一个控制器，负责确保一组Pods按顺序启动和停止，并确保每个Pod有唯一的标识符。这使得它更容易管理有状态应用程序，并且可以在需要时方便地扩展和收缩它们StatefulSet是为了管理有状态服务的问题而设计的有状态服务StatefulSet是有状态的集合，管理有状态的服务，它所管理的Pod的名称不能随意变化。数据持久化的目录也是不一样，每一个Pod都有自己独有的数据持久化存储目录。比如MySQL主从、redis集群等。无状态服务 RC、Deployment、DaemonSet都是管理无状态的服务，它们所管理的Pod的IP、名字，启停顺序等都是随机的。个体对整体无影响，所有pod都是共用一个数据卷的，部署的tomcat就是无状态的服务，tomcat被删除，在启动一个新的tomcat，加入到集群即可，跟tomcat的名字无关 Job 负责批处理任务，Job创建一个或多个Pod，并确保指定数量的Pod成功终止。Pod成功完成后，Job将跟踪成功完成的情况。当达到指定的成功完成次数时，任务（即Job）就完成了。删除Job将清除其创建的Pod CronJob Cron Job 创建是基于时间调度的 Jobs，一个 CronJob 对象就像 crontab (cron table) 文件中的一行。它用 Cron 格式进行编写，并周期性地在给定的调度时间执行 Job。 Ingress提供外部访问集群的入口，将外部的HTTP或者HTTPS请求转发到集群内Service上，流量规则是在Ingress资源上定义。 提供外部访问集群的入口，将外部的HTTP或者HTTPS请求转发到集群内Service上，流量规则是在Ingress资源上定义。 Configmap Configmap 是 k8s 中的资源对象，用于保存非机密性的配置的，数据可以用 key&#x2F;value 键值对的形式保存，也可通过文件的形式保存。k8s 中引入了 Configmap 资源对象，可以当成 volume 挂载到 pod 中，实现统一的配置管理。 Secret Secret 是 Kubernetes 中的一种资源类型，可以用来储存机密信息，如：密码，token，密钥等；信息被存入 Secret 后，可以通过挂载卷的方式挂载到 Pod 内；也可以用于存放 docker 私有镜像库的登录名和密码，用于拉取私有镜像使用；","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"00-zabbix5.0-报错集锦","slug":"运维/zabbix/5.0/00-zabbix5.0-报错集锦","date":"2022-11-01T12:00:00.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2022/11/01/运维/zabbix/5.0/00-zabbix5.0-报错集锦/","link":"","permalink":"https://dbbruce.github.io/2022/11/01/%E8%BF%90%E7%BB%B4/zabbix/5.0/00-zabbix5.0-%E6%8A%A5%E9%94%99%E9%9B%86%E9%94%A6/","excerpt":"1.Connection refused 问题server web报错提示 Get value from agent failed: cannot connect to [[192.168.1.32]:10050]: [111] Connection refused","text":"1.Connection refused 问题server web报错提示 Get value from agent failed: cannot connect to [[192.168.1.32]:10050]: [111] Connection refused 解决agent关掉了 1systemctl start zabbix-agent2.service 2.Interrupted system call 问题server web报错提示 Get value from agent failed: cannot connect to [[192.168.1.33]:10050]: [4] Interrupted system call 解决IP错误了","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"zabbix","slug":"运维/zabbix","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/"},{"name":"5.0LTS","slug":"运维/zabbix/5-0LTS","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/5-0LTS/"}],"tags":[]},{"title":"wireshark","slug":"运维/抓包工具/02-wireshark","date":"2022-09-01T13:00:30.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2022/09/01/运维/抓包工具/02-wireshark/","link":"","permalink":"https://dbbruce.github.io/2022/09/01/%E8%BF%90%E7%BB%B4/%E6%8A%93%E5%8C%85%E5%B7%A5%E5%85%B7/02-wireshark/","excerpt":"wireshark下载官网：https://www.wireshark.org/ 1链接:https://pan.baidu.com/s/1VfyLSWtAHVSV90X0Oe8ezw 密码:yphj","text":"wireshark下载官网：https://www.wireshark.org/ 1链接:https://pan.baidu.com/s/1VfyLSWtAHVSV90X0Oe8ezw 密码:yphj 使用 选择网卡","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"抓包工具","slug":"运维/抓包工具","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/%E6%8A%93%E5%8C%85%E5%B7%A5%E5%85%B7/"}],"tags":[]},{"title":"tcpdump","slug":"运维/抓包工具/01-tcpdump","date":"2022-09-01T12:00:30.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2022/09/01/运维/抓包工具/01-tcpdump/","link":"","permalink":"https://dbbruce.github.io/2022/09/01/%E8%BF%90%E7%BB%B4/%E6%8A%93%E5%8C%85%E5%B7%A5%E5%85%B7/01-tcpdump/","excerpt":"tcpdump命令行抓取数据包的工具，默认抓eth0口的包； 12[root@centos07-12 ~]# rpm -qa tcpdumptcpdump-4.9.2-4.el7_7.1.x86_64 基本用法tcpdump [选项] [过滤条件] 常见监控选项-i 指定监控的网络接口","text":"tcpdump命令行抓取数据包的工具，默认抓eth0口的包； 12[root@centos07-12 ~]# rpm -qa tcpdumptcpdump-4.9.2-4.el7_7.1.x86_64 基本用法tcpdump [选项] [过滤条件] 常见监控选项-i 指定监控的网络接口 1234567[root@centos07-12 ~]# tcpdump -i enp0s3tcpdump: verbose output suppressed, use -v or -vv for full protocol decodelistening on enp0s3, link-type EN10MB (Ethernet), capture size 262144 bytes05:03:35.042309 IP centos07-12.ssh &gt; 192.168.1.8.57632: Flags [P.], seq 279250607:279250795, ack 3084078337, win 431, options [nop,nop,TS val 90494825 ecr 199517448], length 18805:03:35.042931 IP 192.168.1.8.57632 &gt; centos07-12.ssh: Flags [.], ack 188, win 2045, options [nop,nop,TS val 199523971 ecr 90494825], length 005:03:35.044249 ARP, Request who-has gateway tell centos07-12, length 2805:03:36.810192 ARP, Request who-has gateway tell centos07-12, length 28 -A 转换为 ACSII码，以方便阅读，写和读都加，显示的东西更多 123456789101112131415[root@centos07-12 ~]# tcpdump -i enp0s3 -A -c 2 -w f1.captcpdump: listening on enp0s3, link-type EN10MB (Ethernet), capture size 262144 bytes2 packets captured5 packets received by filter0 packets dropped by kernel[root@centos07-12 ~]# tcpdump -A -r f1.capreading from file f1.cap, link-type EN10MB (Ethernet)05:17:43.566353 IP centos07-12.ssh &gt; 192.168.1.8.57632: Flags [P.], seq 279263123:279263247, ack 3084085009, win 431, options [nop,nop,TS val 91343349 ecr 200300184], length 124E.....@.@.............. ..7...g.............q....V..=0.....At...&#123;...t\\..|.]..(....bb&#x27;..l..3.a...,]a.3..,.....&#125;...&lt;z...h~./......=N........$&lt;..g.....&quot;...?.%.E..M..gEC... ......05:17:43.566842 IP 192.168.1.8.57632 &gt; centos07-12.ssh: Flags [.], ack 124, win 2046, options [nop,nop,TS val 200307213 ecr 91343349], length 0EH.4..@.@............ ....g...8.....U&amp;.......r..q.. -w 将数据包信息保存到指定文件 12345[root@centos07-12 ~]# tcpdump -i enp0s3 -c 2 -w f1.captcpdump: listening on enp0s3, link-type EN10MB (Ethernet), capture size 262144 bytes2 packets captured12 packets received by filter0 packets dropped by kernel -r 从指定文件读取数据包信息 1234[root@centos07-12 ~]# tcpdump -r f1.capreading from file f1.cap, link-type EN10MB (Ethernet)05:15:15.674306 IP centos07-12.ssh &gt; 192.168.1.8.57632: Flags [P.], seq 279257791:279257915, ack 3084081641, win 431, options [nop,nop,TS val 91195455 ecr 200160665], length 12405:15:15.674755 IP 192.168.1.8.57632 &gt; centos07-12.ssh: Flags [.], ack 124, win 2046, options [nop,nop,TS val 200170701 ecr 91195455], length 0 -c 定义抓包个数 12345678[root@centos07-12 ~]# tcpdump -i enp0s3 -c 2tcpdump: verbose output suppressed, use -v or -vv for full protocol decodelistening on enp0s3, link-type EN10MB (Ethernet), capture size 262144 bytes05:04:25.221590 IP centos07-12.ssh &gt; 192.168.1.8.57632: Flags [P.], seq 279252227:279252415, ack 3084078945, win 431, options [nop,nop,TS val 90544999 ecr 199570184], length 18805:04:25.222467 IP 192.168.1.8.57632 &gt; centos07-12.ssh: Flags [.], ack 188, win 2045, options [nop,nop,TS val 199570288 ecr 90544999], length 02 packets captured28 packets received by filter0 packets dropped by kernel 包解析105:04:25.222467 IP 192.168.1.8.57632 &gt; centos07-12.ssh: Flags [.], ack 188, win 2045, options [nop,nop,TS val 199570288 ecr 90544999], length 0 05:04:25.222467 &#x2F;&#x2F;数据包被抓到的时间IP &#x2F;&#x2F; 协议192.168.1.8 &#x2F;&#x2F;源地址.57632 &#x2F;&#x2F;端口号centos07-12.ssh &#x2F;&#x2F; 目标Flags [.], ack 188, win 2045, options [nop,nop,TS val 199570288 ecr 90544999], length 0 &#x2F;&#x2F;传输的标记位 tcpdump的过滤条件类型 : host、net、port、portrange方向 : src、dst协议 : tcp、udp、ip、wlan、arp、…..多个条件组合: and、or、not 抓取ping本机的包，ping使用icmp协议12345[root@centos07-12 ~]# tcpdump -i enp0s3 -c 2 icmptcpdump: verbose output suppressed, use -v or -vv for full protocol decodelistening on enp0s3, link-type EN10MB (Ethernet), capture size 262144 bytes05:37:14.396460 IP 192.168.1.8 &gt; centos07-12: ICMP echo request, id 11914, seq 0, length 6405:37:14.396492 IP centos07-12 &gt; 192.168.1.8: ICMP echo reply, id 11914, seq 0, length 64 抓取1.8主机ping的包: icmp and host 192.168.1.812345678[root@centos07-12 ~]# tcpdump -i enp0s3 -c 2 icmp and host 192.168.1.8tcpdump: verbose output suppressed, use -v or -vv for full protocol decodelistening on enp0s3, link-type EN10MB (Ethernet), capture size 262144 bytes05:41:43.125119 IP 192.168.1.8 &gt; centos07-12: ICMP echo request, id 11914, seq 263, length 6405:41:43.125209 IP centos07-12 &gt; 192.168.1.8: ICMP echo reply, id 11914, seq 263, length 642 packets captured27 packets received by filter0 packets dropped by kernel 抓取源1.8主机ping的包: icmp and src host 192.168.1.812345678[root@centos07-12 ~]# tcpdump -i enp0s3 -c 2 icmp and src host 192.168.1.8tcpdump: verbose output suppressed, use -v or -vv for full protocol decodelistening on enp0s3, link-type EN10MB (Ethernet), capture size 262144 bytes05:44:06.601108 IP 192.168.1.8 &gt; centos07-12: ICMP echo request, id 11914, seq 400, length 6405:44:07.688382 IP 192.168.1.8 &gt; centos07-12: ICMP echo request, id 11914, seq 401, length 642 packets captured14 packets received by filter0 packets dropped by kernel 抓取ssh， 主机时1.812345678[root@centos07-12 ~]# tcpdump -i enp0s3 -c 2 tcp and port 22 and host 192.168.1.8tcpdump: verbose output suppressed, use -v or -vv for full protocol decodelistening on enp0s3, link-type EN10MB (Ethernet), capture size 262144 bytes05:50:27.665404 IP centos07-12.ssh &gt; 192.168.1.8.57632: Flags [P.], seq 280661391:280661579, ack 3084099841, win 431, options [nop,nop,TS val 93307448 ecr 202439288], length 18805:50:27.665735 IP 192.168.1.8.57632 &gt; centos07-12.ssh: Flags [.], ack 188, win 2045, options [nop,nop,TS val 202439330 ecr 93307448], length 02 packets captured2 packets received by filter0 packets dropped by kernel 过滤1[root@centos07-12 ~]# tcpdump -A -r f1.cap |egrep user","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"抓包工具","slug":"运维/抓包工具","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/%E6%8A%93%E5%8C%85%E5%B7%A5%E5%85%B7/"}],"tags":[]},{"title":"mac多git账号配置","slug":"git/基础/mac多git账号配置","date":"2022-08-10T03:14:52.000Z","updated":"2024-07-30T07:16:11.000Z","comments":true,"path":"2022/08/10/git/基础/mac多git账号配置/","link":"","permalink":"https://dbbruce.github.io/2022/08/10/git/%E5%9F%BA%E7%A1%80/mac%E5%A4%9Agit%E8%B4%A6%E5%8F%B7%E9%85%8D%E7%BD%AE/","excerpt":"修改项目文件 修改&#x2F;Users&#x2F;dbbruce&#x2F;workspace&#x2F;git项目目录&#x2F;.deploy_git&#x2F;.git&#x2F;config","text":"修改项目文件 修改&#x2F;Users&#x2F;dbbruce&#x2F;workspace&#x2F;git项目目录&#x2F;.deploy_git&#x2F;.git&#x2F;config 123456789101112131415% cat /Users/dbbruce/workspace/MyBlog/sixamclub/.deploy_git/.git/config[core] repositoryformatversion = 0 filemode = true bare = false logallrefupdates = true ignorecase = true precomposeunicode = true[user] name = sixamclub@163.com email = sixamclub@163.com[branch &quot;master&quot;] remote = git@sixamclub:sixamclub/sixamclub.github.io.git merge = refs/heads/main","categories":[{"name":"git","slug":"git","permalink":"https://dbbruce.github.io/categories/git/"},{"name":"基础","slug":"git/基础","permalink":"https://dbbruce.github.io/categories/git/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"0-GO 之基础命令","slug":"go/基础/00-GO 之基础命令","date":"2022-08-10T03:14:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2022/08/10/go/基础/00-GO 之基础命令/","link":"","permalink":"https://dbbruce.github.io/2022/08/10/go/%E5%9F%BA%E7%A1%80/00-GO%20%E4%B9%8B%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4/","excerpt":"go mod命令12345678go mod download 下载依赖的module到本地cache（默认为$GOPATH/pkg/mod目录）go mod edit 编辑go.mod文件go mod graph 打印模块依赖图go mod init 初始化当前文件夹, 创建go.mod文件go mod tidy 增加缺少的module，删除无用的modulego mod vendor 将依赖复制到vendor下go mod verify 校验依赖go mod why 解释为什么需要依赖","text":"go mod命令12345678go mod download 下载依赖的module到本地cache（默认为$GOPATH/pkg/mod目录）go mod edit 编辑go.mod文件go mod graph 打印模块依赖图go mod init 初始化当前文件夹, 创建go.mod文件go mod tidy 增加缺少的module，删除无用的modulego mod vendor 将依赖复制到vendor下go mod verify 校验依赖go mod why 解释为什么需要依赖","categories":[{"name":"GO语言","slug":"GO语言","permalink":"https://dbbruce.github.io/categories/GO%E8%AF%AD%E8%A8%80/"},{"name":"基础","slug":"GO语言/基础","permalink":"https://dbbruce.github.io/categories/GO%E8%AF%AD%E8%A8%80/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"05-varnish","slug":"运维/java生态/05-varnish","date":"2022-08-05T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2022/08/05/运维/java生态/05-varnish/","link":"","permalink":"https://dbbruce.github.io/2022/08/05/%E8%BF%90%E7%BB%B4/java%E7%94%9F%E6%80%81/05-varnish/","excerpt":"Varnish是一款高性能的开源HTTP加速器，具有反向代理，缓存的功能。1.部署Varmish缓存服务器官网： http://varnish-cache.org/ 12345yum -y install gcc readline-develyum -y install ncurses-develyum -y install pcre-develyum -y install python-docutilsyum install python-sphinx 12345678//创建账户useradd -s /sbin/nologin varnish06[root@proxy ~]# tar -xf varnish-5.2.1.tar.gz07[root@proxy ~]# cd varnish-5.2.108[root@proxy varnish-5.2.1]# ./configure09[root@proxy varnish-5.2.1]# make &amp;&amp; make install","text":"Varnish是一款高性能的开源HTTP加速器，具有反向代理，缓存的功能。1.部署Varmish缓存服务器官网： http://varnish-cache.org/ 12345yum -y install gcc readline-develyum -y install ncurses-develyum -y install pcre-develyum -y install python-docutilsyum install python-sphinx 12345678//创建账户useradd -s /sbin/nologin varnish06[root@proxy ~]# tar -xf varnish-5.2.1.tar.gz07[root@proxy ~]# cd varnish-5.2.108[root@proxy varnish-5.2.1]# ./configure09[root@proxy varnish-5.2.1]# make &amp;&amp; make install 1234[root@master ~]# wget &quot;http://varnish-cache.org/downloads/varnish-5.2.1.tgz&quot;[root@master ~]# tar xvf varnish-7.3.0.tgz[root@master varnish-7.3.0]# ./configure[root@master varnish-7.3.0]# make &amp;&amp; make install 测试，varnish命令正常 123456789[root@master varnish-5.2.1]# varnishaclocal.m4 config.status libtool README.rstautogen.sh configure LICENSE stamp-h1bin/ configure.ac m4/ varnishapi.pcbuild-aux/ doc/ Makefile varnishapi.pc.inChangeLog etc/ Makefile.am varnishapi-uninstalled.pcconfig.h include/ Makefile.in varnishapi-uninstalled.pc.inconfig.h.in INSTALL man/ varnish-legacy.m4config.log lib/ README.Packaging varnish.m4 2.修改代理配置文件安装完成后，没有配置文件，需要自己从安装包复制一份 1[root@master varnish-5.2.1]# cp /root/varnish-5.2.1/etc/example.vcl /usr/local/etc/default.vcl 12345[root@master local]# vim /usr/local/etc/default.vclbackend default &#123; .host = &quot;192.168.1.12&quot;; .port = &quot;80&quot;;&#125; 3.启动varnish1[root@master varnish-5.2.1]# varnishd -f /usr/local/etc/default.vcl 4.varnish 缓存数据的存储地方varnishd -s malloc,128M 默认内存缓存，定义varnish使用内存作为缓存 ,空间128Mvarnishd -s file,&#x2F;var&#x2F;lib&#x2F;varnish_strong.bin,1G 定义varnish使用文件作为缓存，空间1G 5.查看日志&#x2F;&#x2F;varnish日志，比较详细 1234567891011121314151617[root@master sbin]# varnishlog* &lt;&lt; Request &gt;&gt; 32770- Begin req 32769 rxreq- Timestamp Start: 1694034545.734984 0.000000 0.000000- Timestamp Req: 1694034545.734984 0.000000 0.000000- ReqStart 192.168.1.8 55620- ReqMethod GET- ReqURL /test.html- ReqProtocol HTTP/1.1- ReqHeader Host: 192.168.1.12- ReqHeader Connection: keep-alive- ReqHeader Cache-Control: max-age=0- ReqHeader Upgrade-Insecure-Requests: 1- ReqHeader User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Safari/537.36- ReqHeader Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7- ReqHeader Accept-Encoding: gzip, deflate- ReqHeader Accept-Language: zh-CN,zh;q=0.9,en;q=0.8 &#x2F;&#x2F;访问日志 12[root@master sbin]# varnishncsa192.168.1.8 - - [07/Sep/2023:05:10:03 +0800] &quot;GET http://192.168.1.12/test.html HTTP/1.1&quot; 304 0 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Safari/537.36&quot; 6.更新缓存数据在后台web服务器更新页面内容后，用户访问代理服务器看到的还是之前的数据， 说明缓存中的数据过期了需要更新 (默认也会自动更新，但非实时更新,3,5分钟)。varnishadmban req.url ~ test.html &#x2F;&#x2F;精确清空urlban req.url ~ .* &#x2F;&#x2F;清空缓存数据，支持正则表达式 1234567891011121314151617[root@master sbin]# varnishadm200-----------------------------Varnish Cache CLI 1.0-----------------------------Linux,3.10.0-1160.el7.x86_64,x86_64,-junix,-smalloc,-smalloc,-hcritbitvarnish-5.2.1 revision 67e562482Type &#x27;help&#x27; for command list.Type &#x27;quit&#x27; to close CLI session.varnish&gt; ban req.url ~ a.html200varnish&gt; ban req.url ~ test.html200","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"Java生态","slug":"运维/Java生态","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/Java%E7%94%9F%E6%80%81/"}],"tags":[]},{"title":"04-Git服务器","slug":"运维/Git/04-Git服务器","date":"2022-08-04T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2022/08/04/运维/Git/04-Git服务器/","link":"","permalink":"https://dbbruce.github.io/2022/08/04/%E8%BF%90%E7%BB%B4/Git/04-Git%E6%9C%8D%E5%8A%A1%E5%99%A8/","excerpt":"04-Git服务器 1.Git服务器SSH协议服务器Git协议服务器HTTP协议服务器Git支持很多服务器协议形式，不同协议的Git服务器，客户端就可以使用不同的形式访问服务器。创建的服务器协议有SSH协议、Git协议、HTTP协议","text":"04-Git服务器 1.Git服务器SSH协议服务器Git协议服务器HTTP协议服务器Git支持很多服务器协议形式，不同协议的Git服务器，客户端就可以使用不同的形式访问服务器。创建的服务器协议有SSH协议、Git协议、HTTP协议 2.ssh协议服务器 创建基于密码验证的SSH协议服务器 12[root@web1 ~]# git init --bare /var/git/dongprojectlnitialized empty Git repository in /var/git/dongproject 客户端访问的方式 1[root@web2 ~]# git clone root@192.168.2.100:/var/git/dongproject 客户端生成SSH密钥，实现免密码登陆git服务器生成公钥 1[root@web2 ~]# ssh-keygen -f /root/.ssh/id_rsa -N &#x27;&#x27; 向服务发送公钥 1[root@web2 ~]# ssh-copy-id 192.168.1.12 拉代码，无需密码 1[root@web2 ~]# git clone root@192.168.2.100:/var/git/dongproject 3.Git协议服务器 安装git包 1[root@web1 ~]# yum -y install git-daemon 创建版本库 1[root@web1 ~]# git init --bare /var/git/dongproject 修改配置文件，启动gt服务修改前 1234[Service]User=nobodyExecStart=-/usr/libexec/git-core/git-daemon --base-path=/var/lib/git --export-all --user-path=public_git --syslog --inetd --verboseStandardInput=socket 修改后，–base-path 1234[Service]User=nobodyExecStart=-/usr/libexec/git-core/git-daemon --base-path=/var/git/dongproject --export-all --user-path=public_git --syslog --inetd --verboseStandardInput=socket 启动 1[root@master git]# systemctl start git.socket 访问 1dbbruce@dbburce linuxtest % git clone git://192.168.1.12/var/git/dongproject 4.HTTP协议服务器1[root@master ~]# yum -y install httpd gitweb 打开文件，并到第11行去 12[root@master ~]# vim +11 /etc/gitweb.conf 11 our $projectroot = &quot;/var/git/&quot;; 创建版本仓库 (web1主机操作) 12[root@master ~]# git init --bare /var/git/dongproject2初始化空的 Git 版本库于 /var/git/dongproject2/ 启动httpd服务器 1[root@master ~]# systemctl start httpd 访问浏览器：http://192.168.1.12","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"Git","slug":"运维/Git","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/Git/"}],"tags":[]},{"title":"04-tomcat日志管理","slug":"运维/java生态/04-tomcat日志管理","date":"2022-08-04T03:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2022/08/04/运维/java生态/04-tomcat日志管理/","link":"","permalink":"https://dbbruce.github.io/2022/08/04/%E8%BF%90%E7%BB%B4/java%E7%94%9F%E6%80%81/04-tomcat%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86/","excerpt":"tomcat日志管理1.日志&#x2F;usr&#x2F;local&#x2F;tomcat&#x2F;logs 123456789[root@master logs]# cd /usr/local/tomcat/logs[root@master logs]# ll总用量 76-rw-r-----. 1 root root 5919 9月 6 23:55 catalina.2023-09-06.log # tomcat的日志，启动，关闭日志，自动切分，每天一个日志-rw-r-----. 1 root root 29261 9月 7 02:46 catalina.out -rw-r-----. 1 root root 0 9月 6 23:55 host-manager.2023-09-06.log # host-manager网站日志-rw-r-----. 1 root root 465 9月 6 23:55 localhost.2023-09-06.log-rw-r-----. 1 root root 0 9月 6 23:55 localhost_access_log.2023-09-06.txt # 访问日志-rw-r-----. 1 root root 0 9月 6 23:55 manager.2023-09-06.log # manager网站 ,http://www.a.com:8080/manager/","text":"tomcat日志管理1.日志&#x2F;usr&#x2F;local&#x2F;tomcat&#x2F;logs 123456789[root@master logs]# cd /usr/local/tomcat/logs[root@master logs]# ll总用量 76-rw-r-----. 1 root root 5919 9月 6 23:55 catalina.2023-09-06.log # tomcat的日志，启动，关闭日志，自动切分，每天一个日志-rw-r-----. 1 root root 29261 9月 7 02:46 catalina.out -rw-r-----. 1 root root 0 9月 6 23:55 host-manager.2023-09-06.log # host-manager网站日志-rw-r-----. 1 root root 465 9月 6 23:55 localhost.2023-09-06.log-rw-r-----. 1 root root 0 9月 6 23:55 localhost_access_log.2023-09-06.txt # 访问日志-rw-r-----. 1 root root 0 9月 6 23:55 manager.2023-09-06.log # manager网站 ,http://www.a.com:8080/manager/ 123456789[root@master ROOT]# cd /usr/local/tomcat/webapps[root@master webapps]# ll总用量 4drwxr-x---. 16 root root 4096 9月 6 23:39 docsdrwxr-x---. 7 root root 99 9月 6 23:39 examples #examples网站drwxr-x---. 6 root root 79 9月 6 23:39 host-manager #host-manager网站drwxr-x---. 6 root root 114 9月 6 23:39 manager # manager网站drwxr-x---. 3 root root 239 9月 7 00:30 ROOT #默认网站[root@master webapps]#","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"Java生态","slug":"运维/Java生态","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/Java%E7%94%9F%E6%80%81/"}],"tags":[]},{"title":"03-Git分支操作","slug":"运维/Git/03-Git分支操作","date":"2022-08-03T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2022/08/03/运维/Git/03-Git分支操作/","link":"","permalink":"https://dbbruce.github.io/2022/08/03/%E8%BF%90%E7%BB%B4/Git/03-Git%E5%88%86%E6%94%AF%E6%93%8D%E4%BD%9C/","excerpt":"Git分支操作1.常见的分支规范如下MASTER分支(MASTER是主分支，是代码的核心DEVELOP分支 (DEVELOP最新开发成果的分支)大功能RELEASE分支 (为发布新产品设置的分支)HOTFIX分支 (为了修复软件BUG缺陷的分支)FEATURE分支 (为开发新功能设置的分支)小功能","text":"Git分支操作1.常见的分支规范如下MASTER分支(MASTER是主分支，是代码的核心DEVELOP分支 (DEVELOP最新开发成果的分支)大功能RELEASE分支 (为发布新产品设置的分支)HOTFIX分支 (为了修复软件BUG缺陷的分支)FEATURE分支 (为开发新功能设置的分支)小功能 2.查看位于那个分支 查看当前分支git status12345dbbruce@dbburce dongproject % git status位于分支 master您的分支与上游分支 &#x27;origin/master&#x27; 一致。无文件要提交，干净的工作区 查看所有分支信息12dbbruce@dbburce dongproject % git branch -v* master 1751078 5555num 创建分支12345678dbbruce@dbburce dongproject % git branch hotfixdbbruce@dbburce dongproject % git branch featuredbbruce@dbburce dongproject % git branch -v feature 1751078 5555num hotfix 1751078 5555num* master 1751078 5555num 切换分支123456dbbruce@dbburce dongproject % git checkout master切换到分支 &#x27;master&#x27;您的分支与上游分支 &#x27;origin/master&#x27; 一致。dbbruce@dbburce dongproject % git checkout hotfix切换到分支 &#x27;hotfix&#x27; 合并分支将hotfix修改的数据合并到master分支注意，合并前必须要先切换到master分支，然后再执行merge命令123dbbruce@dbburce dongproject % git checkout master切换到分支 &#x27;master&#x27;您的分支与上游分支 &#x27;origin/master&#x27; 一致。 12345dbbruce@dbburce dongproject % git merge hotfix更新 1751078..bd6e074Fast-forward init.txt | 1 + 1 file changed, 1 insertion(+) 解决版本分支的冲突问题 1234dbbruce@dbburce dongproject % git merge hotfix自动合并 init.txt冲突（内容）：合并冲突于 init.txt自动合并失败，修正冲突然后提交修正的结果。 12345678910dbbruce@dbburce dongproject % cat init.txt3333344444455551231&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD909090=======99888&gt;&gt;&gt;&gt;&gt;&gt;&gt; hotfix 手动解决冲突 1234567dbbruce@dbburce dongproject % vim init.txt333334444445555123190909099888 再次提交，解决冲突 12345dbbruce@dbburce dongproject % git add .dbbruce@dbburce dongproject % git commit -m &quot;jj冲突&quot;[master 205c7b5] jj冲突dbbruce@dbburce dongproject % git merge hotfix已经是最新的。 更新分支 1234dbbruce@dbburce dongproject % gitcheckout hotfixzsh: command not found: gitcheckoutdbbruce@dbburce dongproject % git merge master已经是最新的。","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"Git","slug":"运维/Git","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/Git/"}],"tags":[]},{"title":"03-配置tomcat支持SSL加密网站","slug":"运维/java生态/03-配置tomcat支持ssl加密网站","date":"2022-08-03T03:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2022/08/03/运维/java生态/03-配置tomcat支持ssl加密网站/","link":"","permalink":"https://dbbruce.github.io/2022/08/03/%E8%BF%90%E7%BB%B4/java%E7%94%9F%E6%80%81/03-%E9%85%8D%E7%BD%AEtomcat%E6%94%AF%E6%8C%81ssl%E5%8A%A0%E5%AF%86%E7%BD%91%E7%AB%99/","excerpt":"配置Tomcat支持SSL加密网站1.创建加密用的私钥和证书文件keytool :装JDK是自动装的工具 12345keytool -genkeypair -alias tomcat -keyalg RSA -keystore /usr/local/tomcat/keystore//-genkeypair 生成密钥对//-alias tomcat 密钥别名//-keyalg RSA 定义密钥算法为RSA算法//-keystore 定义密钥文件存储在:/usr/local/tomcat/keystore","text":"配置Tomcat支持SSL加密网站1.创建加密用的私钥和证书文件keytool :装JDK是自动装的工具 12345keytool -genkeypair -alias tomcat -keyalg RSA -keystore /usr/local/tomcat/keystore//-genkeypair 生成密钥对//-alias tomcat 密钥别名//-keyalg RSA 定义密钥算法为RSA算法//-keystore 定义密钥文件存储在:/usr/local/tomcat/keystore 1234567891011121314151617181920212223242526[root@master ~]# keytool -genkeypair -alias tomcat -keyalg RSA -keystore /usr/local/tomcat/keystore输入密钥库口令:密钥库口令太短 - 至少必须为 6 个字符输入密钥库口令:再次输入新口令:您的名字与姓氏是什么? [Unknown]: dong您的组织单位名称是什么? [Unknown]: bossdong您的组织名称是什么? [Unknown]: bossdong2您所在的城市或区域名称是什么? [Unknown]: bj您所在的省/市/自治区名称是什么? [Unknown]: bj该单位的双字母国家/地区代码是什么? [Unknown]: cnCN=dong, OU=bossdong, O=bossdong2, L=bj, ST=bj, C=cn是否正确? [否]: y # 这里输入y，不要输入yes，yes会重新来输入 &lt;tomcat&gt; 的密钥口令 (如果和密钥库口令相同, 按回车):再次输入新口令:Warning:JKS 密钥库使用专用格式。建议使用 &quot;keytool -importkeystore -srckeystore /usr/local/tomcat/keystore -destkeystore /usr/local/tomcat/keystore -deststoretype pkcs12&quot; 迁移到行业标准格式 PKCS12。 2.再次修改server.xml配置文件，创建支持加密连接的Connector&#x2F;&#x2F;备注，默认这段Connector被注释掉了，打开注释，添加密钥信息即可新增 keystoreFile&#x3D;”&#x2F;usr&#x2F;local&#x2F;tomcat&#x2F;keystore” keystorePass&#x3D;”123456” 12345678910 92 &lt;Connector port=&quot;8443&quot; protocol=&quot;org.apache.coyote.http11.Http11NioProtocol&quot; 93 maxThreads=&quot;150&quot; SSLEnabled=&quot;true&quot; 94 maxParameterCount=&quot;1000&quot; keystoreFile=&quot;/usr/local/tomcat/keystore&quot; keystorePass=&quot;123456&quot; ### 这个是新增的 95 &gt; 96 &lt;SSLHostConfig&gt; 97 &lt;Certificate certificateKeystoreFile=&quot;conf/localhost-rsa.jks&quot; 98 type=&quot;RSA&quot; /&gt; 99 &lt;/SSLHostConfig&gt;100 &lt;/Connector&gt;","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"Java生态","slug":"运维/Java生态","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/Java%E7%94%9F%E6%80%81/"}],"tags":[]},{"title":"02-Git指针操作","slug":"运维/Git/02-Git指针操作","date":"2022-08-02T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2022/08/02/运维/Git/02-Git指针操作/","link":"","permalink":"https://dbbruce.github.io/2022/08/02/%E8%BF%90%E7%BB%B4/Git/02-Git%E6%8C%87%E9%92%88%E6%93%8D%E4%BD%9C/","excerpt":"Git指针操作0.git还原个人理解是：用指针回到某个历史，把需要的文件拷贝回来；然后在回到最新版本，替换原文件； 1.查看提交日志1234567dbbruce@dbburce dongproject % git reflog1751078 (HEAD -&gt; master, origin/master) HEAD@&#123;0&#125;: commit: 5555numb2bdf9d HEAD@&#123;1&#125;: commit: 44444dd4be4c9 HEAD@&#123;2&#125;: commit: 44444f991541 HEAD@&#123;3&#125;: commit: 333333333de6fe4c HEAD@&#123;4&#125;: commit: update contenteef077b HEAD@&#123;5&#125;: commit (initial): 初始化","text":"Git指针操作0.git还原个人理解是：用指针回到某个历史，把需要的文件拷贝回来；然后在回到最新版本，替换原文件； 1.查看提交日志1234567dbbruce@dbburce dongproject % git reflog1751078 (HEAD -&gt; master, origin/master) HEAD@&#123;0&#125;: commit: 5555numb2bdf9d HEAD@&#123;1&#125;: commit: 44444dd4be4c9 HEAD@&#123;2&#125;: commit: 44444f991541 HEAD@&#123;3&#125;: commit: 333333333de6fe4c HEAD@&#123;4&#125;: commit: update contenteef077b HEAD@&#123;5&#125;: commit (initial): 初始化 2.移动HEAD指针，将数据还原到任意版本提示:当前HEAD指针为HEAD@{0}, HEAD@{0} 就是当前指针位置 还原前 123456dbbruce@dbburce dongproject % lsdemo init.txt num.txtdbbruce@dbburce dongproject % cat init.txt333334444445555 还原12dbbruce@dbburce dongproject % git reset --hard f991541HEAD 现在位于 f991541 333333333 还原后1234dbbruce@dbburce dongproject % lsdemo init.txtdbbruce@dbburce dongproject % cat init.txt33333 日志123456789dbbruce@dbburce dongproject % git reflogf991541 (HEAD -&gt; master) HEAD@&#123;0&#125;: reset: moving to f9915411751078 (origin/master) HEAD@&#123;1&#125;: commit: 5555numb2bdf9d HEAD@&#123;2&#125;: commit: 44444dd4be4c9 HEAD@&#123;3&#125;: commit: 44444f991541 (HEAD -&gt; master) HEAD@&#123;4&#125;: commit: 333333333de6fe4c HEAD@&#123;5&#125;: commit: update contenteef077b HEAD@&#123;6&#125;: commit (initial): 初始化dbbruce@dbburce dongproject % 3.还原误删除文件12dbbruce@dbburce dongproject % lsdemo init.txt 12dbbruce@dbburce dongproject % git rm init.txtrm &#x27;init.txt&#x27; 12dbbruce@dbburce dongproject % lsdemo 1234dbbruce@dbburce dongproject % git commit -m &quot;delete&quot;[master baf9444] delete 1 file changed, 1 deletion(-) delete mode 100644 init.txt 123456dbbruce@dbburce dongproject % git log --onelinebaf9444 (HEAD -&gt; master) deletef991541 333333333de6fe4c update contenteef077b 初始化dbbruce@dbburce dongproject % 12dbbruce@dbburce dongproject % git reset --hard f991541HEAD 现在位于 f991541 333333333 12dbbruce@dbburce dongproject % lsdemo init.txt 1dbbruce@dbburce dongproject % cp init.txt /tmp 12dbbruce@dbburce dongproject % git reset --hard baf9444HEAD 现在位于 baf9444 delete 12dbbruce@dbburce dongproject % lsdemo 1dbbruce@dbburce dongproject % cp /tmp/init.txt ./ 12dbbruce@dbburce dongproject % lsdemo init.txt 12345dbbruce@dbburce dongproject % git add .dbbruce@dbburce dongproject % git commit -m &quot;HY2&quot;[master 59dff78] HY2 1 file changed, 1 insertion(+) create mode 100644 init.txt","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"Git","slug":"运维/Git","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/Git/"}],"tags":[]},{"title":"02-tomcat部署","slug":"运维/java生态/02-tomcat部署","date":"2022-08-02T03:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2022/08/02/运维/java生态/02-tomcat部署/","link":"","permalink":"https://dbbruce.github.io/2022/08/02/%E8%BF%90%E7%BB%B4/java%E7%94%9F%E6%80%81/02-tomcat%E9%83%A8%E7%BD%B2/","excerpt":"1.安装tomcat简单来说，tomcat本身就是java写的一个脚本，所有不用安装 1wget https://dlcdn.apache.org/tomcat/tomcat-8/v8.5.93/bin/apache-tomcat-8.5.93.tar.gz --no-check-certificate","text":"1.安装tomcat简单来说，tomcat本身就是java写的一个脚本，所有不用安装 1wget https://dlcdn.apache.org/tomcat/tomcat-8/v8.5.93/bin/apache-tomcat-8.5.93.tar.gz --no-check-certificate 12345678910111213141516171819tar xvf apache-tomcat-8.5.93.tar.gzmv apache-tomcat-8.5.93 /usr/local/tomcatcd /usr/local/tomcat/[root@master tomcat]# ll总用量 128drwxr-x---. 2 root root 4096 9月 6 23:39 bin //主程序目录-rw-r-----. 1 root root 19992 8月 24 06:43 BUILDING.txtdrwx------. 2 root root 238 8月 24 06:43 conf //配置文件目录-rw-r-----. 1 root root 6210 8月 24 06:43 CONTRIBUTING.mddrwxr-x---. 2 root root 4096 9月 6 23:39 lib //库文件目录-rw-r-----. 1 root root 57011 8月 24 06:43 LICENSEdrwxr-x---. 2 root root 6 8月 24 06:43 logs //日志目录-rw-r-----. 1 root root 1726 8月 24 06:43 NOTICE-rw-r-----. 1 root root 3398 8月 24 06:43 README.md-rw-r-----. 1 root root 7139 8月 24 06:43 RELEASE-NOTES-rw-r-----. 1 root root 16505 8月 24 06:43 RUNNING.txtdrwxr-x---. 2 root root 30 9月 6 23:39 temp //临时目录drwxr-x---. 7 root root 81 8月 24 06:43 webapps //页面目录drwxr-x---. 2 root root 6 8月 24 06:43 work //自动编译目录isp代码转换servlet 2.启动服务启动后进程不叫tomcat，使用netstat要过滤java，ps最好过滤java 123456TALINA_HOME: /usr/local/tomcatUsing CATALINA_TMPDIR: /usr/local/tomcat/tempUsing JRE_HOME: /usrUsing CLASSPATH: /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jarUsing CATALINA_OPTS:Tomcat started. 注意：8005，8080端口一定要启动，如果不能启动，稍等下，可能慢，tomcat需要内存里的大量数据 123456netstat -nlptu|grep javatcp6 0 0 127.0.0.1:8005 :::* LISTEN 4635/javatcp6 0 0 :::8080 :::* LISTEN 4635/javaps axf|grep tomcat 4670 pts/0 S+ 0:00 \\_ grep --color=auto tomcat 4635 pts/0 Sl 0:08 /usr/bin/java -Djava.util.logging.config.file=/usr/local/tomcat/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djdk.tls.ephemeralDHKeySize=2048 -Djava.protocol.handler.pkgs=org.apache.catalina.webresources -Dorg.apache.catalina.security.SecurityListener.UMASK=0027 -Dignore.endorsed.dirs= -classpath /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar -Dcatalina.base=/usr/local/tomcat -Dcatalina.home=/usr/local/tomcat -Djava.io.tmpdir=/usr/local/tomcat/temp org.apache.catalina.startup.Bootstrap start 3.启动的特别慢提示:如果检查端口时，8005端口启动非常慢，可用使用下面的命令用urandom替换random (非必须操作) 12mv /dev/random /dev/random.bakln -s /dev/urandom /dev/random 使用cat &#x2F;dev&#x2F;random,看下是否有大量随机数，有表示正常cat &#x2F;dev&#x2F;random # 乱码strings &#x2F;dev&#x2F;random # 好点，可以看的乱码 4.关闭&#x2F;usr&#x2F;local&#x2F;tomcat&#x2F;bin&#x2F;shutdown.sh 12345678/usr/local/tomcat/bin/shutdown.shUsing CATALINA_BASE: /usr/local/tomcatUsing CATALINA_HOME: /usr/local/tomcatUsing CATALINA_TMPDIR: /usr/local/tomcat/tempUsing JRE_HOME: /usrUsing CLASSPATH: /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jarUsing CATALINA_OPTS:[root@master ~]# 5.访问http://192.168.1.12:8080 6.写一个简单测试页面12345678vim /usr/local/tomcat/webapps/ROOT/test.jsp&lt;html&gt; &lt;body&gt; &lt;center&gt; Now time is: &lt;%=new java.util.Date()%&gt; &lt;/center&gt; &lt;/body&gt;&lt;/html&gt; http://192.168.1.12:8080/test.jsp 7.修改server.xml配置文件 tomcat配置文件严格分隔大小写 配置文件成对出现，必须注意结尾在哪里，如 &lt;Host …..&gt;,成对，注意结束标志 1vim /usr/local/tomcat/conf/server.xml 连接端口 1234569 &lt;Connector port=&quot;8080&quot; protocol=&quot;HTTP/1.1&quot;70 connectionTimeout=&quot;20000&quot;71 redirectPort=&quot;8443&quot;72 maxParameterCount=&quot;1000&quot;73 /&gt; 虚拟主机 1234567&lt;Host name=&quot;localhost&quot; # 虚拟主机 appBase=&quot;webapps&quot; # 根目录 unpackWARs=&quot;true&quot; # 自动解包 autoDeploy=&quot;true&quot; # 代码变化，自动部署&gt;&lt;/Host&gt; 默认打开的的虚拟主机 12&lt;Engine name=&quot;Catalina&quot; defaultHost=&quot;localhost&quot;&gt;&lt;/Engine&gt; docBase设置首页,在Host中，新增Context，原文件没有，需要自己新增 123&lt;Host&gt; &lt;Context path=&quot;&quot; docBase=&quot;base&quot;/&gt;&lt;/Host&gt; 在webapps下新建一个base，添加一个index.jps文件 跳转访问&#x2F;abc跳转到&#x2F;var&#x2F;www&#x2F;htmlwww.a.com/abc 实际打开的是 &#x2F;var&#x2F;www&#x2F;html文件 123&lt;Host&gt; &lt;Context path=&quot;/abc&quot; docBase=&quot;/var/www/html&quot;/&gt;&lt;/Host&gt; 8.原理图","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"Java生态","slug":"运维/Java生态","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/Java%E7%94%9F%E6%80%81/"}],"tags":[]},{"title":"02-数据库操作","slug":"运维/memcached/02-数据库操作","date":"2022-08-02T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2022/08/02/运维/memcached/02-数据库操作/","link":"","permalink":"https://dbbruce.github.io/2022/08/02/%E8%BF%90%E7%BB%B4/memcached/02-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/","excerpt":"1.写入数据 数据格式set 写数据dong 变量名0 不压缩180 缓存时间3 存储几个数据字节的数据123set dong 0 180 5aaaaaSTORED #### 存储","text":"1.写入数据 数据格式set 写数据dong 变量名0 不压缩180 缓存时间3 存储几个数据字节的数据123set dong 0 180 5aaaaaSTORED #### 存储 3个数据字节，写4个数据，报错信息 ，CLIENT_ERROR bad data chunk12345678[root@master system]# telnet 192.168.1.12 11211Trying 192.168.1.12...Connected to 192.168.1.12.Escape character is &#x27;^]&#x27;.set name 0 180 3aaaaCLIENT_ERROR bad data chunkERROR ### 报错 2.读取数据 获取变量值1234get dongVALUE dong 0 5aaaaaEND 获取没有的变量，不报错，空12get dong111END 3.常用命令12345678add dong 0 180 10 // 新建，myname不存在则添加，存在则报错set dong 0 180 10 // 添加、替换replace dong 0 180 10 // 替换，如果myname不存在则报错get dong // 读取变量append dong 0 180 10 // 向变量中追加数据delete dong // 删除变量flush_all // 清空所有quit // 退出登录","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"memcached","slug":"运维/memcached","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/memcached/"}],"tags":[]},{"title":"01-Git基础知识","slug":"运维/Git/01-Git基础知识","date":"2022-08-01T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2022/08/01/运维/Git/01-Git基础知识/","link":"","permalink":"https://dbbruce.github.io/2022/08/01/%E8%BF%90%E7%BB%B4/Git/01-Git%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/","excerpt":"Git基础知识1.git提交流程","text":"Git基础知识1.git提交流程 #### 2.安装git123yum -y install gitgit -vgit version 2.41.0搭建远程服务器1.初始化一个空仓库–bare # 注意要加一个bare ，代表空仓库的意思1234567891011121314[root@master sbin]# mkdir /var/git[root@master sbin]# cd /var/git/[root@master git]# git init /var/git/dongproject --bare # 注意要加一个bare ，代表空仓库的意思初始化空的 Git 版本库于 /var/git/dongproject/[root@master git]# ll /var/git/dongproject/总用量 12drwxr-xr-x. 2 root root 6 9月 7 06:01 branches-rw-r--r--. 1 root root 66 9月 7 06:01 config-rw-r--r--. 1 root root 73 9月 7 06:01 description-rw-r--r--. 1 root root 23 9月 7 06:01 HEADdrwxr-xr-x. 2 root root 242 9月 7 06:01 hooksdrwxr-xr-x. 2 root root 21 9月 7 06:01 infodrwxr-xr-x. 4 root root 30 9月 7 06:01 objectsdrwxr-xr-x. 4 root root 31 9月 7 06:01 refs客户端1.clone克隆服务器仓库到本地安装git 1[dbbruce@dbburce linuxtest %] yum -y install git 克隆代码，工作区 &#x3D;&#x3D;&#x3D; dongproject 1234[dbbruce@dbburce linuxtest %] git clone root@192.168.1.12:/var/git/dongproject正克隆到 &#x27;dongproject&#x27;...root@192.168.1.12&#x27;s password:警告：您似乎克隆了一个空仓库。 查看, .git &#x3D;&#x3D;&#x3D; 本地仓库 12345[dbbruce@dbburce linuxtest %] ls -al dongprojecttotal 0drwxr-xr-x 3 dbbruce staff 96 9 7 20:05 .drwxr-xr-x 3 dbbruce staff 96 9 7 20:05 ..drwxr-xr-x 9 dbbruce staff 288 9 7 20:05 .git # 这里的git就是本地的仓库 3.注意这个过程： git add : 将工作区（dongproject）里的更改，添加到本地git仓库（.git）; git commit :将本地git仓库（.git）上传到远程git服务器； 4.新增文件12345678dbbruce@dbburce dongproject % echo &quot;init&quot; &gt; init.txtdbbruce@dbburce dongproject % mkdir demototal 8drwxr-xr-x 5 dbbruce staff 160 9 7 20:16 .drwxr-xr-x 3 dbbruce staff 96 9 7 20:05 ..drwxr-xr-x 9 dbbruce staff 288 9 7 20:20 .gitdrwxr-xr-x 2 dbbruce staff 64 9 7 20:16 demo-rw-r--r-- 1 dbbruce staff 5 9 7 20:20 init.txt 5.查看状态12345678910dbbruce@dbburce dongproject % git status 位于分支 master 尚无提交 未跟踪的文件: （使用 &quot;git add &lt;文件&gt;...&quot; 以包含要提交的内容） init.txt 提交为空，但是存在尚未跟踪的文件（使用 &quot;git add&quot; 建立跟踪） 6.添加 ,加入暂存区12345678910dbbruce@dbburce dongproject % git add . # .（点）表示全部dbbruce@dbburce dongproject % git status位于分支 master尚无提交要提交的变更： （使用 &quot;git rm --cached &lt;文件&gt;...&quot; 以取消暂存） 新文件： init.txt 7.提交，提交到本地git仓库（.git)1234567891011dbbruce@dbburce dongproject % git commit -m &quot;初始化&quot;[master（根提交） eef077b] 初始化 1 file changed, 1 insertion(+) create mode 100644 init.txt dbbruce@dbburce dongproject % git status位于分支 master您的分支基于 &#x27;origin/master&#x27;，但此上游分支已经不存在。 （使用 &quot;git branch --unset-upstream&quot; 来修复）无文件要提交，干净的工作区 8.推送到远程git服务器12345678dbbruce@dbburce dongproject % git pushroot@192.168.1.12&#x27;s password:枚举对象中: 3, 完成.对象计数中: 100% (3/3), 完成.写入对象中: 100% (3/3), 215 字节 | 215.00 KiB/s, 完成.总共 3（差异 0），复用 0（差异 0），包复用 0To 192.168.1.12:/var/git/dongproject * [new branch] master -&gt; master 9.注意:在远程的服务器上，找不相关的文件10.git 拉代码123dbbruce@dbburce dongproject % git pullroot@192.168.1.12&#x27;s password:已经是最新的。 11.查看版本日志123456dbbruce@dbburce dongproject % git logcommit eef077b47c405f27a88aaf08d8a703d89571744c (HEAD -&gt; master, origin/master)Author: dbbruce@163.com &lt;dbbruce@163.com&gt;Date: Thu Sep 7 20:29:30 2023 +0800 初始化 12dbbruce@dbburce dongproject % git log --pretty=onelineeef077b47c405f27a88aaf08d8a703d89571744c (HEAD -&gt; master, origin/master) 初始化 12dbbruce@dbburce dongproject % git log --onelineeef077b (HEAD -&gt; master, origin/master) 初始化 12dbbruce@dbburce dongproject % git reflogeef077b (HEAD -&gt; master, origin/master) HEAD@&#123;0&#125;: commit (initial): 初始化","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"Git","slug":"运维/Git","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/Git/"}],"tags":[]},{"title":"01-java生态概述","slug":"运维/java生态/01-java生态概述","date":"2022-08-01T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2022/08/01/运维/java生态/01-java生态概述/","link":"","permalink":"https://dbbruce.github.io/2022/08/01/%E8%BF%90%E7%BB%B4/java%E7%94%9F%E6%80%81/01-java%E7%94%9F%E6%80%81%E6%A6%82%E8%BF%B0/","excerpt":"1.Java Servlet （服务器）Servlet是java扩展Web服务器功能的组件规范常见Servlet容器 IBM websphere Oracle weblogic Apache tomcat RedHat jboss","text":"1.Java Servlet （服务器）Servlet是java扩展Web服务器功能的组件规范常见Servlet容器 IBM websphere Oracle weblogic Apache tomcat RedHat jboss 2.Java体系 Java SE(标准版) Java EE ( 企业版) Java ME(移动版) 3.java代码在java虚拟机中运行jvm: java虚拟机(javavirtual machine) 4.安装java，就是安装JDK， java是一个解释器JDK(Java Development Kit)是Sun针对Java开发者推出的Java诺言的软件开发工具包JDK是整个Java的核心 包括了Java运行环境 Java工具(如编译、排错、打包等工具 ) Java基础的类库 4.安装openjdk12# 查看java有哪些版本yum list|grep openjdk 123456[root@master system]# yum -y install java-1.8.0-openjdk # 安装openjdk，下面的headless自动安装[root@master system]# yum -y install java-1.8.0-openjdk-headless[root@master system]# java -version # 查看java版本openjdk version &quot;1.8.0_382&quot;OpenJDK Runtime Environment (build 1.8.0_382-b05)OpenJDK 64-Bit Server VM (build 25.382-b05, mixed mode)","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"Java生态","slug":"运维/Java生态","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/Java%E7%94%9F%E6%80%81/"}],"tags":[]},{"title":"01-源码安装","slug":"运维/memcached/01-安装与配置","date":"2022-08-01T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2022/08/01/运维/memcached/01-安装与配置/","link":"","permalink":"https://dbbruce.github.io/2022/08/01/%E8%BF%90%E7%BB%B4/memcached/01-%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/","excerpt":"1.memcached简介memcached是高性能的分布式缓存服务器用来集中缓存数据库查询结果，减少数据库访问次数以提高动态Web应用的响应速度端口 11211没有库，表的概念 2.数据存储对比 性能CPU缓存 &gt; 内存 &gt; 磁盘 &gt; 数据库 价格CPU缓存 &gt; 内存 &gt; 磁盘 &gt; 数据库","text":"1.memcached简介memcached是高性能的分布式缓存服务器用来集中缓存数据库查询结果，减少数据库访问次数以提高动态Web应用的响应速度端口 11211没有库，表的概念 2.数据存储对比 性能CPU缓存 &gt; 内存 &gt; 磁盘 &gt; 数据库 价格CPU缓存 &gt; 内存 &gt; 磁盘 &gt; 数据库 3.安装123[root@master ~]# yum -y install memcached[root@master ~]# rpm -qa memcachedmemcached-1.4.15-10.el7_3.1.x86_64 4.配置文件（不要修改）启动文件1234567891011121314[root@master ~]# cat /usr/lib/systemd/system/memcached.service[Unit]Description=MemcachedBefore=httpd.serviceAfter=network.target[Service]Type=simpleEnvironmentFile=-/etc/sysconfig/memcachedExecStart=/usr/bin/memcached -u $USER -p $PORT -m $CACHESIZE -c $MAXCONN $OPTIONS[Install]WantedBy=multi-user.target[root@master system]# 配置文件1[root@master system]# cat /etc/sysconfig/memcached 123456[root@master system]# cat /etc/sysconfig/memcachedPORT=&quot;11211&quot;USER=&quot;memcached&quot;MAXCONN=&quot;1024&quot;CACHESIZE=&quot;64&quot;OPTIONS=&quot;&quot; 5.memcached命令123456789101112[root@master system]# systemctl start memcached[root@master system]# ps -axf|grep memcached 4036 ? Ssl 0:00 /usr/bin/memcached -u memcached -p 11211 -m 64 -c 1024[root@master system]# systemctl restart memcached[root@master system]# ps -axf|grep memcached 4060 ? Ssl 0:00 /usr/bin/memcached -u memcached -p 11211 -m 64 -c 1024[root@master system]# systemctl stop memcached[root@master system]# ps -axf|grep memcached 6.memcached缓存数据库(kv数据库)key&#x3D;value 5.连接memcached1234[root@master system]# telnet 192.168.1.12 11211Trying 192.168.1.12...Connected to 192.168.1.12.Escape character is &#x27;^]&#x27;.","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"memcached","slug":"运维/memcached","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/memcached/"}],"tags":[]},{"title":"01-Could not fetch save url","slug":"运维/docker/错误集锦/01-Could not fetch save url","date":"2022-05-01T02:00:00.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2022/05/01/运维/docker/错误集锦/01-Could not fetch save url/","link":"","permalink":"https://dbbruce.github.io/2022/05/01/%E8%BF%90%E7%BB%B4/docker/%E9%94%99%E8%AF%AF%E9%9B%86%E9%94%A6/01-Could%20not%20fetch%20save%20url/","excerpt":"","text":"Could not fetch&#x2F;save url http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo to file &#x2F;etc&#x2F;yum.repos.d&#x2F;docker-ce.repo: [Errno 12] Timeout on http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo: (28, ‘Connection timed out after 33442 milliseconds’)现在阿里docker-ce源报错12345[root@centos07-42 yum.repos.d]# yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo已加载插件：fastestmirror, langpacksadding repo from: http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repograbbing file http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo to /etc/yum.repos.d/docker-ce.repoCould not fetch/save url http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo to file /etc/yum.repos.d/docker-ce.repo: [Errno 14] HTTP Error 403 - Forbidden 原因123403原因：访问该网址次数过多把你屏蔽了解决：换一下网(wifi)就好了","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"docker","slug":"运维/docker","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/"},{"name":"错误集锦","slug":"运维/docker/错误集锦","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/%E9%94%99%E8%AF%AF%E9%9B%86%E9%94%A6/"}],"tags":[]},{"title":"00-Failed to set locale","slug":"运维/docker/错误集锦/00-Failed to set locale","date":"2022-04-30T16:00:00.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2022/05/01/运维/docker/错误集锦/00-Failed to set locale/","link":"","permalink":"https://dbbruce.github.io/2022/05/01/%E8%BF%90%E7%BB%B4/docker/%E9%94%99%E8%AF%AF%E9%9B%86%E9%94%A6/00-Failed%20to%20set%20locale/","excerpt":"","text":"Failed to set locale, defaulting to C.UTF-8使用官方提供的centos镜像，执行yum命令报错1234[root@f54a789287fd /]# yum -y install vim net-tools psmisc iprouteFailed to set locale, defaulting to C.UTF-8CentOS Linux 8 - AppStream 56 B/s | 38 B 00:00Error: Failed to download metadata for repo &#x27;appstream&#x27;: Cannot prepare internal mirrorlist: No URLs in mirrorlist 原因在2022年1月31日，CentOS团队终于从官方镜像中移除CentOS 8的所有包。CentOS 8已于2021年12月31日寿终正非，但软件包仍在官方镜像上保留了一段时间。现在他们被转移到https://vault.centos.org如果你仍然需要运行你的旧CentOS 8，你可以在&#x2F;etc&#x2F;yum.repos中更新repos.d使用vault.centos.org代替mirror.centos.org 12345678# yum源仍然使用的是旧地址[baseos]name=CentOS Linux $releasever - BaseOSmirrorlist=http://mirrorlist.centos.org/?release=$releasever&amp;arch=$basearch&amp;repo=BaseOS&amp;infra=$infra#baseurl=http://mirror.centos.org/$contentdir/$releasever/BaseOS/$basearch/os/gpgcheck=1enabled=1gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-centosofficial 解决方法一：使用新官方源替换旧源123456789[root@f54a789287fd /]# cd /etc/yum.repos.d/[root@0bfcd7be51ba yum.repos.d]# sed -i &#x27;s/mirrorlist/#mirrorlist/g&#x27; /etc/yum.repos.d/CentOS-*[root@0bfcd7be51ba yum.repos.d]# sed -i &#x27;s|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g&#x27; /etc/yum.repos.d/CentOS-*[root@0bfcd7be51ba yum.repos.d]# yum update -yFailed to set locale, defaulting to C.UTF-8CentOS Linux 8 - AppStream 26% [===================- ] 432 kB/s | 2.2 MB 00:14 ETA 解决办法二：使用阿里云源替换旧源12345678910[root@df27314f2ef2 yum.repos.d]# rm -rf /etc/yum.repos.d/*[root@df27314f2ef2 yum.repos.d]# curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-vault-8.5.2111.repo# 测试[root@df27314f2ef2 yum.repos.d]# yum install wget -yFailed to set locale, defaulting to C.UTF-8CentOS-8.5.2111 - Base - mirrors.aliyun.com 6.0 MB/s | 4.6 MB 00:00CentOS-8.5.2111 - Extras - mirrors.aliyun.com 37 kB/s | 10 kB 00:00CentOS-8.5.2111 - AppStream - mirrors.aliyun.com 7.6 MB/s | 8.4 MB 00:01","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"docker","slug":"运维/docker","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/"},{"name":"错误集锦","slug":"运维/docker/错误集锦","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/%E9%94%99%E8%AF%AF%E9%9B%86%E9%94%A6/"}],"tags":[]},{"title":"django支持三种风格的模型继承","slug":"python/Django/0002.django支持三种风格的模型继承","date":"2022-04-11T11:14:52.000Z","updated":"2024-11-04T03:58:44.000Z","comments":true,"path":"2022/04/11/python/Django/0002.django支持三种风格的模型继承/","link":"","permalink":"https://dbbruce.github.io/2022/04/11/python/Django/0002.django%E6%94%AF%E6%8C%81%E4%B8%89%E7%A7%8D%E9%A3%8E%E6%A0%BC%E7%9A%84%E6%A8%A1%E5%9E%8B%E7%BB%A7%E6%89%BF/","excerpt":"Django支持三种风格的模型继承 抽象类继承：父类继承自models.Model，但不会在底层数据库中生成相应的数据表。父类的属性列存储在其子类的数据表中。 多表继承：多表继承的每个模型类都在底层数据库中生成相应的数据表管理数据。 代理模型继承：父类用于在底层数据库中管理数据表；而子类不定义数据列，只定义查询数据集的排序方式等元数据。","text":"Django支持三种风格的模型继承 抽象类继承：父类继承自models.Model，但不会在底层数据库中生成相应的数据表。父类的属性列存储在其子类的数据表中。 多表继承：多表继承的每个模型类都在底层数据库中生成相应的数据表管理数据。 代理模型继承：父类用于在底层数据库中管理数据表；而子类不定义数据列，只定义查询数据集的排序方式等元数据。 1．抽象类继承抽象类继承的作用是在多个表有若干相同的字段时，可以使开发者将这些字段统一定义在抽象基类中，免于重复定义这些字段。抽象基类的定义通过在模型的Meta中定义属性abstract &#x3D;True来实现。抽象基类的举例如下： 123456789101112from django.db import modelsclass MessageBase(models.Model): id = models.AutoField() content = models.CharField(max_length=100) user_name = models.CharField(max_length=80) pub_date = models.DateField() class Meta: abstract = True #定义本类为抽象基类class Moment(MessageBase): headline = models.CharField(max_length=50) 2．多表继承在多表继承技术中，无论是父表还是子表都会用数据库中相对应的数据表维护模型数据，父类中的字段不会重复地在多个子类的相关数据表中进行定义。从这种意义上讲，多表继承才是真正面向对象的ORM技术。多表继承的定义不需要特殊的关键字。在Django内部通过在父模型和子模型之间建立一对一关系来实现多表继承技术。如下代码定义了MessageBase及其子类的多表继承版本： 12345678910from django.db import modelsclass MessageBase(models.Model): id = models.AutoField() content = models.CharField(max_length=100) user_name = models.CharField(max_length=80) pub_date = models.DateField()class Moment(MessageBase): headline = models.CharField(max_length=50)class Comment(MessageBase): level = models.CharField(max_length=1, […]) 3．代理模型继承在前两种继承模型中子类模型都有实际存储数据的作用；而代理模型继承中子类只用于管理父类的数据，而不实际存储数据。代理模型继承通过在子类的Meta中定义proxy&#x3D;True属性来实现，举例如下： 1234567891011from django.db import modelsclass Moment(models.Model): id = models.AutoField() headline = models.CharField(max_length=50) content = models.CharField(max_length=100) user_name = models.CharField(max_length=80) pub_date = models.DateField()class OrderedMoment(Moment): class Meta: proxy = True ordering = [&quot;-pub_date&quot;] 4.反向解析12Django还提供了反向的从映射名到URL地址的解析功能。Django的URL反向解析功能在模板文件和Python程序中有不同的调用方法：在模板文件中用&#123;%url %&#125;标签调用反向解析； 在Python程序中用django.core.urlresolvers.reverse（）函数调用反向解析123&lt;a href=&quot;&#123;% url &#x27;moments_2015&#x27; %&#125;&quot;&gt;from django.core.urlresolvers import reversereverse(&#x27;moments_2015&#x27;) 带参数的反向解析12&lt;a href=&quot;&#123;% url &#x27;moments&#x27;, 2014 %&#125;&quot;&gt;(reverse(&#x27;moments&#x27;, args=(2013, )) 5.Django为继承自Form类的表单维护了一个绑定（bound）123如果一个表单对象在实例化后被赋予过数据内容，则称该表单处于bound状态。只有处于bound状态的表单才具有表单数据验证（validate data）的功能。如果未被赋予过数据内容，则表单处于unbound状态。只有处于unbound状态的表单才能被赋予数据，使该表单变为bound状态。注意： 已经处于bound状态的表单不能在Python代码中修改其数据，而只能由网页用户在页面中输入数据进行修改。 6.在Python中，同步I&#x2F;O可以被理解为一个被调用的I&#x2F;O函数会阻塞调用函数的执行，而异步I&#x2F;O则不会阻塞调用函数的执行。代码举例如下：123456from tornado.httpclient import HTTPClient #Tornado的HTTP客户端类def synchronous_visit(): http_client = HTTPClient() response = http_client.fetch(&quot;www.baidu.com&quot;) #阻塞，直到对www.baidu.com访问完成 print(response.body) 7.协程是Torando中进行异步I&#x2F;O代码开发的方法。协程使用了Python关键字yield将调用者挂起和恢复执行迭代器（Iterator）是访问集合内元素的一种方式。迭代器对象从集合的第1个元素开始访问，直到所有元素都被访问一遍后结束。迭代器不能回退，只能往前进行迭代。使用iter（）调用可以将列表、集合转换为迭代器，比如： 1234&gt;&gt;&gt;numbers = [1, 3, 5, 7, 8]&gt;&gt;&gt;t = iter(numbers)&gt;&gt;&gt;print t&lt;listiterator object at 0x0012B3F0&gt; 迭代器与普通Python对象的区别是迭代器有一个next（）方法，每次调用该方法可以返回一个元素。调用者（比如for语句）可以通过不断调用next（）方法来逐个访问集合元素。比如： 1234&gt;&gt;&gt;iter = iter(range(5))&gt;&gt;&gt;print iter.next()0&gt;&gt;&gt;print iter.next() 8.编写协程函数用协程技术开发网页访问功能的代码如下： 1234567from tornado import gen # 引入协程库genfrom tornado.httpclient import AsyncHTTPClient@gen.coroutine # 使用gen.coroutine修饰器def coroutine_visit(): http_client = AsyncHTTPClient() response = yield http_client.fetch(&quot;www.baidu.com&quot;) print(response.body) 在Python中，使用yield关键字定义的迭代器也被称为“生成器”。因为协程本身不使用线程，所以减少了线程上下文切换的开销，是一种更高效的开发模式。 协程函数可以通过以下三种方式进行调用。 在本身是协程的函数内通过yield关键字调用。 在IOLoop尚未启动时，通过IOLoop的run_sync（）函数调用。 在IOLoop已经启动时，通过IOLoop的spawn_callback（）函数调用。 IOLoop是Torando的主事件循环对象，Tornado程序通过它监听外部客户端的访问请求，并执行相应的操作。当程序尚未进入IOLoop的running状态时，可以通过run_sync（）函数调用协程函数 Tornado要求协程函数在IOLoop的running状态中才能被调用，只不过run_sync函数自动完成了启动、停止IOLoop的步骤，它的实现逻辑为：启动IOLoop→调用被lambda封装的协程函数→停止IOLoop","categories":[{"name":"Python基础","slug":"Python基础","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/"},{"name":"Django","slug":"Python基础/Django","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/Django/"}],"tags":[]},{"title":"django配置fcgi参数解释","slug":"python/Django/0001.django配置fcgi参数解释","date":"2022-04-10T11:14:52.000Z","updated":"2024-11-04T02:16:43.000Z","comments":true,"path":"2022/04/10/python/Django/0001.django配置fcgi参数解释/","link":"","permalink":"https://dbbruce.github.io/2022/04/10/python/Django/0001.django%E9%85%8D%E7%BD%AEfcgi%E5%8F%82%E6%95%B0%E8%A7%A3%E9%87%8A/","excerpt":"1.参数简介manage.py runfcgi minspare&#x3D;50 maxspare&#x3D;200 maxchildren&#x3D;1000 maxrequests&#x3D;99999 host&#x3D;127.0.0.1 port&#x3D;8080 pidfile&#x3D;.&#x2F;django.pid method&#x3D;threaded maxspare为初始化的进程／线程数，也是最少个数minspare为最少空闲进程／线程数, 注意空闲二字maxchildren 进程／线程上限，以每个py进程20～30M算，自己算下服务器内存能创建最大进程数吧！maxrequests 处理多少个请求后，销毁进&#x2F;线程，防内存泄漏，默认不销毁method &#x3D; prefork|threaded 进程或线程跑你的程序，默认进程。","text":"1.参数简介manage.py runfcgi minspare&#x3D;50 maxspare&#x3D;200 maxchildren&#x3D;1000 maxrequests&#x3D;99999 host&#x3D;127.0.0.1 port&#x3D;8080 pidfile&#x3D;.&#x2F;django.pid method&#x3D;threaded maxspare为初始化的进程／线程数，也是最少个数minspare为最少空闲进程／线程数, 注意空闲二字maxchildren 进程／线程上限，以每个py进程20～30M算，自己算下服务器内存能创建最大进程数吧！maxrequests 处理多少个请求后，销毁进&#x2F;线程，防内存泄漏，默认不销毁method &#x3D; prefork|threaded 进程或线程跑你的程序，默认进程。","categories":[{"name":"Python基础","slug":"Python基础","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/"},{"name":"Django","slug":"Python基础/Django","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/Django/"}],"tags":[]},{"title":"16-优化","slug":"运维/zabbix/5.0/16-优化","date":"2022-02-16T12:00:00.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2022/02/16/运维/zabbix/5.0/16-优化/","link":"","permalink":"https://dbbruce.github.io/2022/02/16/%E8%BF%90%E7%BB%B4/zabbix/5.0/16-%E4%BC%98%E5%8C%96/","excerpt":"server端1.zabbix server模板监控项：搜集数据： Zabbix server: Data gathering processes处理数据： Zabbix server: Data handling processes缓存使用率： Zabbix server: Zabbix cache usage, % free搜集数据进程使用率： Zabbix server: Zabbix data gathering process busy %","text":"server端1.zabbix server模板监控项：搜集数据： Zabbix server: Data gathering processes处理数据： Zabbix server: Data handling processes缓存使用率： Zabbix server: Zabbix cache usage, % free搜集数据进程使用率： Zabbix server: Zabbix data gathering process busy % 2.zabbx服务端配置优化zabbx参数数的置: 缓存和进程数量xxxxcache - 用于zabbix服务端缓存获取的各类数据(历史数据趋势数据.)poller - zabbix用于接收各类数据的进程的数量 (接收agent的数据的进程 接snmp 接收imx 接收ipmi 3.缓存配置123456789101112131415 vim /etc/zabbix/zabbix_server.conf# 用于存储主机、监控项、触发器数据的共享内存大小 CacheSize=8M #512M 边调节边看监控 Zabbix seryer; Zabbix cache usage,% free # 历史数据缓存HistoryCacheSize=16M#历史数据索引的缓存HistoryIndexCacheSize=4M#趋势数据缓存TrendCacheSize=4M#值的缓存ValueCacheSize=8M 调整时，结合下面的图看效果 4.进程数量调整123456789101112131415161718 vim /etc/zabbix/zabbix_server.conf# 收集数据进程的数量StartPollers=5# 客户端/主机 不可达 可达主机 (包括IPMI 和 Java)的轮询进程的初始实例数量StartPollersUnreachable=1#用于接收http客户端的数据StartHTTPPollers=1#用于收集客户端jmx的数据 (默认是) java-eateway的时候使用StartJavaPollers=0#用于收集zabbix proxy代理的数据的进程数 默认是1StartProxyPollers=5#收集ipmi客户端数据StartIPMIPollers=0 调整时，结合下面的图看效果 agent端1.Zabbix客户端配置优化 不在使用客户端的默认的被动模式 使用主动模式 Server 和 Serverative, web页面选择zabbix客户端(主动模式）123 vim /etc/zabbix/zabbix_agent2.confServer=192.168.1.12ServerActive=192.168.1.12 # agent主动方式，必须配置这个 agent 主动方式 其他1.zabbix键值与监控项处理 增加更新间隔时间5m 10m; 推荐使用自定义模板，控制功能全面监控，监控项少精简监控项(精简) 历史数据保留时长, 减少设置为30d或7d, 增加趋势存储时间保留时间 365d 2.zabbix占用磁盘空间的计算关于历史数据的管家设置Zabbix将接收到的值保存一段固定的时间，通常为几周或几个月。 每个新值都需要一定量的班盘空间用于数据和索引。所以，如果我们每秒收到50个值，且希望保留30天的历史数据，值的总数将大约在 (30243600)* 50 &#x3D; 129600000，即大约 130M。根据所使用的数据库引擎，接收值的类型（浮点数、整数、字符串、日志、文件等），单个值的出盘空间可能在49字节到数百字节之间变化。通常，数值类型的每个值大约为90个字节。在上面的例子中，这意味着 130M 个需要占用 130M * 9 bytes &#x3D; 10.9GB 盘空间。 3.触发器优化 尽量使用 last()(最新数括) diff() (是否有变化) nodata() (是否有数据) 避免使用需要计算函数 max() min() avg() 整体目标:不要让zabbix服务端进行计算&#x2F;数据库进行计数,需要计算的内容放在客户端(自定义监控项) 4.zabbix数据库优化根据业务类型调整: 读少写多 1、zabbix是一个写多读少的业务,优化数据库的写入性能,建议使用ImnoDB存储引警或tokudb存储引擎 2、数据库分离或数据库拆分","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"zabbix","slug":"运维/zabbix","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/"},{"name":"5.0LTS","slug":"运维/zabbix/5-0LTS","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/5-0LTS/"}],"tags":[]},{"title":"15-分布式监控","slug":"运维/zabbix/5.0/15-分布式监控","date":"2022-02-15T12:00:00.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2022/02/15/运维/zabbix/5.0/15-分布式监控/","link":"","permalink":"https://dbbruce.github.io/2022/02/15/%E8%BF%90%E7%BB%B4/zabbix/5.0/15-%E5%88%86%E5%B8%83%E5%BC%8F%E7%9B%91%E6%8E%A7/","excerpt":"1.安装 proxy12wget https://mirrors.aliyun.com/zabbix/zabbix/5.0/rhel/7/x86_64/zabbix-proxy-mysql-5.0.0-1.el7.x86_64.rpmyum -y install zabbix-proxy-mysql-5.0.0-1.el7.x86_64.rpm 2.安装zabbix所需的数据库，mariadb1yum install mariadb-server -y","text":"1.安装 proxy12wget https://mirrors.aliyun.com/zabbix/zabbix/5.0/rhel/7/x86_64/zabbix-proxy-mysql-5.0.0-1.el7.x86_64.rpmyum -y install zabbix-proxy-mysql-5.0.0-1.el7.x86_64.rpm 2.安装zabbix所需的数据库，mariadb1yum install mariadb-server -y 3.配置数据库，开机启动12[root@master ~]# systemctl enable --now mariadbCreated symlink from /etc/systemd/system/multi-user.target.wants/mariadb.service to /usr/lib/systemd/system/mariadb.service. 4.初始化数据库，设置密码，1234561[root@master ~]# mysql_secure_installation 5.添加数据库用户，以及zabbix_proxy所需的数据库信息1234567create database zabbix_proxy character set utf8 collate utf8_bin;create user zabbix_proxy@localhost identified by &#x27;123456&#x27;;grant all privileges on zabbix_proxy.* to zabbix_proxy@localhost;flush privileges; 6.查询数据文件1234567891011121314151617[root@centos07-22 ~]# rpm -ql zabbix-proxy-mysql/etc/logrotate.d/zabbix-proxy/etc/zabbix/zabbix_proxy.conf/usr/lib/systemd/system/zabbix-proxy.service/usr/lib/tmpfiles.d/zabbix-proxy.conf/usr/lib/zabbix/externalscripts/usr/sbin/zabbix_proxy_mysql/usr/share/doc/zabbix-proxy-mysql-5.0.0/usr/share/doc/zabbix-proxy-mysql-5.0.0/AUTHORS/usr/share/doc/zabbix-proxy-mysql-5.0.0/COPYING/usr/share/doc/zabbix-proxy-mysql-5.0.0/ChangeLog/usr/share/doc/zabbix-proxy-mysql-5.0.0/NEWS/usr/share/doc/zabbix-proxy-mysql-5.0.0/README/usr/share/doc/zabbix-proxy-mysql-5.0.0/schema.sql.gz/usr/share/man/man8/zabbix_proxy.8.gz/var/log/zabbix/var/run/zabbix 7.导入数据&#x2F;usr&#x2F;share&#x2F;doc&#x2F;zabbix-proxy-mysql-5.0.0&#x2F;schema.sql.gz mysql -u用户名 -p 数据库名1zcat /usr/share/doc/zabbix-proxy-mysql-5.0.0/schema.sql.gz | mysql -uzabbix_proxy -p zabbix_proxy 12use zabbix_proxy;show tables; 8.配置proxy1234567vim /etc/zabbix/zabbix_proxy.conf 30 Server=192.168.1.12 49 Hostname=Zabbix_proxy_centos7-22 # 代理的名称，随意，但必须唯一162 DBHost=localhost # 本地数据库173 DBName=zabbix_proxy188 DBUser=zabbix_proxy196 DBPassword=123456 12345678910111213141516[root@centos07-22 ~]# grep &#x27;^[a-Z]&#x27; /etc/zabbix/zabbix_proxy.confServer=127.0.0.1Hostname=Zabbix_proxy_centos7-22LogFile=/var/log/zabbix/zabbix_proxy.logLogFileSize=0PidFile=/var/run/zabbix/zabbix_proxy.pidSocketDir=/var/run/zabbixDBHost=localhostDBName=zabbix_proxyDBUser=zabbix_proxyDBPassword=123456SNMPTrapperFile=/var/log/snmptrap/snmptrap.logTimeout=4ExternalScripts=/usr/lib/zabbix/externalscriptsLogSlowQueries=3000StatsAllowedIP=127.0.0.1 8.启动proxy12systemctl start zabbix-proxy.servicesystemctl enable zabbix-proxy.service 123[root@centos07-22 ~]# netstat -anput |grep proxytcp 0 0 0.0.0.0:10051 0.0.0.0:* LISTEN 30587/zabbix_proxytcp6 0 0 :::10051 :::* LISTEN 30587/zabbix_proxy 9.修改zabbix server端12vim /etc/zabbix/zabbix_server.conf585 StartProxyPollers=5 # 搜集proxy数据的进程数 10.web页面添加proxy注意：agent代理程序名称 要与第8步配置的hostname一致 11.将agent指向proxy 修改配置文件12 80 Server=192.168.1.22125 ServerActive=192.168.1.22 修改页面注意主机的代理信息，如果不是proxy的名称，需要手动修改下，一般会自动添加；","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"zabbix","slug":"运维/zabbix","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/"},{"name":"5.0LTS","slug":"运维/zabbix/5-0LTS","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/5-0LTS/"}],"tags":[]},{"title":"14-监控数据库","slug":"运维/zabbix/5.0/14-监控数据库","date":"2022-02-14T12:00:00.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2022/02/14/运维/zabbix/5.0/14-监控数据库/","link":"","permalink":"https://dbbruce.github.io/2022/02/14/%E8%BF%90%E7%BB%B4/zabbix/5.0/14-%E7%9B%91%E6%8E%A7%E6%95%B0%E6%8D%AE%E5%BA%93/","excerpt":"1.安装 percona-zabbix-templates注意：这里使用的PHP版本必须7+，如果不用7下面测试时，会报错。 1rpm -ivh https://www.percona.com/downloads/percona-monitoring-plugins/percona-monitoring-plugins-1.1.8/binary/redhat/7/x86_64/percona-zabbix-templates-1.1.8-1.noarch.rpm 12345678[root@master ~]# rpm -ql percona-zabbix-templates/var/lib/zabbix/percona/var/lib/zabbix/percona/scripts/var/lib/zabbix/percona/scripts/get_mysql_stats_wrapper.sh/var/lib/zabbix/percona/scripts/ss_get_mysql_stats.php/var/lib/zabbix/percona/templates/var/lib/zabbix/percona/templates/userparameter_percona_mysql.conf/var/lib/zabbix/percona/templates/zabbix_agent_template_percona_mysql_server_ht_2.0.9-sver1.1.8.xml","text":"1.安装 percona-zabbix-templates注意：这里使用的PHP版本必须7+，如果不用7下面测试时，会报错。 1rpm -ivh https://www.percona.com/downloads/percona-monitoring-plugins/percona-monitoring-plugins-1.1.8/binary/redhat/7/x86_64/percona-zabbix-templates-1.1.8-1.noarch.rpm 12345678[root@master ~]# rpm -ql percona-zabbix-templates/var/lib/zabbix/percona/var/lib/zabbix/percona/scripts/var/lib/zabbix/percona/scripts/get_mysql_stats_wrapper.sh/var/lib/zabbix/percona/scripts/ss_get_mysql_stats.php/var/lib/zabbix/percona/templates/var/lib/zabbix/percona/templates/userparameter_percona_mysql.conf/var/lib/zabbix/percona/templates/zabbix_agent_template_percona_mysql_server_ht_2.0.9-sver1.1.8.xml 2.复制conf文件到zabbix配置目录1cp /var/lib/zabbix/percona/templates/userparameter_percona_mysql.conf /etc/zabbix/zabbix_agent2.d/ 3.修改ss_get_mysql_stats.php 文件 现在数据库创建监控用户 生产环境 需要一个对数据库有只读权限的用户即可select,show1234# 全部权限grant all privileges on *.* to &#x27;zbx_monitor&#x27;@&#x27;%&#x27; identified by &#x27;123456&#x27;;# select和show权限grant select,show on *.* to &#x27;zbx_monitor&#x27;@&#x27;%&#x27; identified by &#x27;123456&#x27;; 修改配置文件,修改用户名和密码1234vim /var/lib/zabbix/percona/scripts/ss_get_mysql_stats.php$mysql_user = &#x27;zbx_monitor&#x27;;$mysql_pass = &#x27;123456&#x27;;$mysql_port = 3306; 3.重启agent1systemctl restart zabbix-agent2 4.测试下，zabbix server 执行下面命令12zabbix_get -s &#x27;192.168.1.22&#x27; -p 10050 -k &#x27;login.user&#x27;1 5.web页面导入Percona模板导入 1.8的模板报错了，后来使用的1.6模板正常； 1.6模板，放在了百度云盘 链接: https://pan.baidu.com/s/1KRCKiPpKySXFDnzc4QkM-w?pwd=dong 提取码: dong 6.mysql主机关联模板","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"zabbix","slug":"运维/zabbix","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/"},{"name":"5.0LTS","slug":"运维/zabbix/5-0LTS","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/5-0LTS/"}],"tags":[]},{"title":"13-监控日志中的状态码的数量","slug":"运维/zabbix/5.0/13-监控日志中的状态码的数量","date":"2022-02-13T12:00:00.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2022/02/13/运维/zabbix/5.0/13-监控日志中的状态码的数量/","link":"","permalink":"https://dbbruce.github.io/2022/02/13/%E8%BF%90%E7%BB%B4/zabbix/5.0/13-%E7%9B%91%E6%8E%A7%E6%97%A5%E5%BF%97%E4%B8%AD%E7%9A%84%E7%8A%B6%E6%80%81%E7%A0%81%E7%9A%84%E6%95%B0%E9%87%8F/","excerpt":"1.获取nginx日志中状态码数量 nginx_status_code.sh12345#!/bin/bash#author: dbruce dong#desc: 检查某状态码的数量CHOICE=$1awk -v s=$CHOICE &#x27;&#123;code[$9]++&#125;END&#123;if( s in code) print code[s]&#125;&#x27; /usr/local/nginx/logs/access.log 使用123chmod +x nginx_status_code.sh./nginx_status_code.sh 40417","text":"1.获取nginx日志中状态码数量 nginx_status_code.sh12345#!/bin/bash#author: dbruce dong#desc: 检查某状态码的数量CHOICE=$1awk -v s=$CHOICE &#x27;&#123;code[$9]++&#125;END&#123;if( s in code) print code[s]&#125;&#x27; /usr/local/nginx/logs/access.log 使用123chmod +x nginx_status_code.sh./nginx_status_code.sh 40417 2.编写脚本 通过脚本获取证书的相关时间 zabbix agent端，编写自定义监控脚本 web页面添加自定义监控","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"zabbix","slug":"运维/zabbix","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/"},{"name":"5.0LTS","slug":"运维/zabbix/5-0LTS","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/5-0LTS/"}],"tags":[]},{"title":"12-监控端口进程","slug":"运维/zabbix/5.0/12-监控端口进程","date":"2022-02-12T12:00:00.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2022/02/12/运维/zabbix/5.0/12-监控端口进程/","link":"","permalink":"https://dbbruce.github.io/2022/02/12/%E8%BF%90%E7%BB%B4/zabbix/5.0/12-%E7%9B%91%E6%8E%A7%E7%AB%AF%E5%8F%A3%E8%BF%9B%E7%A8%8B/","excerpt":"zabbix 自带的监控项：https://www.zabbix.com/documentation/5.0/zh/manual/config/items/itemtypes/zabbix_agent 1.使用zabbix自动key，获取进程和端口信息 net.tcp.port[,80] — 检查是否可以将TCP连接到指定的端口。 0 - 不能连接 proc.num[nginx] — 进程数量 123456[root@master ~]# zabbix_get -s 192.168.1.22 -k net.tcp.port[,80] # 1运行 0关闭1 [root@master ~]# zabbix_get -s 192.168.1.22 -k proc.num[nginx]2[root@master ~]# zabbix_get -s 192.168.1.22 -k proc.num[]108","text":"zabbix 自带的监控项：https://www.zabbix.com/documentation/5.0/zh/manual/config/items/itemtypes/zabbix_agent 1.使用zabbix自动key，获取进程和端口信息 net.tcp.port[,80] — 检查是否可以将TCP连接到指定的端口。 0 - 不能连接 proc.num[nginx] — 进程数量 123456[root@master ~]# zabbix_get -s 192.168.1.22 -k net.tcp.port[,80] # 1运行 0关闭1 [root@master ~]# zabbix_get -s 192.168.1.22 -k proc.num[nginx]2[root@master ~]# zabbix_get -s 192.168.1.22 -k proc.num[]108 2.编写脚本 通过脚本获取证书的相关时间 zabbix agent 端，编写自定义监控脚本 web页面添加自定义监控","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"zabbix","slug":"运维/zabbix","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/"},{"name":"5.0LTS","slug":"运维/zabbix/5-0LTS","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/5-0LTS/"}],"tags":[]},{"title":"11-监控证书过期","slug":"运维/zabbix/5.0/11-监控证书过期","date":"2022-02-11T12:00:00.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2022/02/11/运维/zabbix/5.0/11-监控证书过期/","link":"","permalink":"https://dbbruce.github.io/2022/02/11/%E8%BF%90%E7%BB%B4/zabbix/5.0/11-%E7%9B%91%E6%8E%A7%E8%AF%81%E4%B9%A6%E8%BF%87%E6%9C%9F/","excerpt":"1.查看证书信息 openssl x509 -in cert.pem -noout -text","text":"1.查看证书信息 openssl x509 -in cert.pem -noout -text 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859[root@centos07-22 conf]# openssl x509 -in cert.pem -noout -textCertificate: Data: Version: 3 (0x2) Serial Number: c1:a1:27:fc:9d:be:4c:9d Signature Algorithm: sha256WithRSAEncryption Issuer: C=CN, ST=BJ, L=BJ, O=dong, OU=dong, CN=dong/emailAddress=dbbruce@163.com Validity Not Before: Sep 15 16:20:54 2023 GMT Not After : Oct 15 16:20:54 2023 GMT Subject: C=CN, ST=BJ, L=BJ, O=dong, OU=dong, CN=dong/emailAddress=dbbruce@163.com Subject Public Key Info: Public Key Algorithm: rsaEncryption Public-Key: (2048 bit) Modulus: 00:a9:94:45:ea:0a:2b:42:05:16:cf:5b:c1:af:ef: ab:64:cb:9d:da:08:bb:34:5e:58:83:03:35:32:ea: f1:14:0a:f9:74:2e:82:1a:82:61:ff:7c:70:38:9b: 93:7c:c8:86:93:88:09:c7:f9:72:e0:50:8d:29:b4: c2:e3:61:45:b7:4c:2b:6f:c1:88:15:d0:4c:9c:4f: 9f:21:a9:d5:a7:a1:3c:b6:65:7b:c9:78:01:da:4a: 54:2c:8e:8d:6d:47:40:ac:82:c5:ea:49:5b:86:9e: 12:a6:da:46:e9:d1:c7:9f:23:c8:be:ec:ca:5f:65: dd:bf:15:1b:2f:82:31:9f:8e:6a:2e:80:6d:19:7a: c8:c5:a3:a5:ea:60:79:fb:c9:14:d2:cb:a9:5f:e5: 92:47:5d:40:55:40:22:b6:16:6d:fd:84:3c:5a:b1: b9:02:1f:55:cb:12:85:e3:ad:a6:e1:c8:f6:38:67: bd:a0:e9:2b:32:53:e0:ba:cb:8f:a1:4d:83:11:58: 30:fd:62:3f:f9:cb:3b:19:27:16:74:a2:19:3a:47: 6e:f3:0c:f2:e6:98:ce:54:d7:5a:f1:66:9e:a5:ae: 89:79:b8:75:c2:70:a3:92:98:c4:8e:ba:11:88:76: c6:eb:44:7a:06:7d:b9:59:9d:91:1f:7b:b1:68:bc: fb:05 Exponent: 65537 (0x10001) X509v3 extensions: X509v3 Subject Key Identifier: 15:C4:F4:E2:FA:36:48:A6:93:10:B2:BF:9B:84:4D:0F:7A:C8:22:29 X509v3 Authority Key Identifier: keyid:15:C4:F4:E2:FA:36:48:A6:93:10:B2:BF:9B:84:4D:0F:7A:C8:22:29 X509v3 Basic Constraints: CA:TRUE Signature Algorithm: sha256WithRSAEncryption 45:ac:7d:e9:7c:8a:2a:ae:f8:1f:dd:1f:09:14:e7:4e:98:12: b2:1d:5c:a8:20:89:c0:3d:e2:b9:9f:48:43:75:28:d5:aa:84: e8:ca:66:54:e2:66:2a:ba:56:60:4f:e6:4d:2f:76:0f:4d:ce: 9c:b3:bf:68:29:d7:b7:b4:52:b7:fa:a6:3f:56:96:4c:98:97: 40:a5:de:bc:1a:55:ec:de:4d:75:63:e9:a2:87:c5:57:ee:b1: e6:c5:69:47:42:13:c6:4f:60:85:7e:90:35:5a:9a:9c:02:f8: 90:b4:1e:63:d8:76:97:47:23:2e:97:3e:59:c6:71:a2:03:46: 16:41:06:3d:c5:81:39:e0:10:bd:35:13:27:14:02:45:d8:ab: 01:50:65:d9:ca:7d:0a:ad:f9:1b:a7:9e:05:34:bd:1f:48:41: 28:56:76:1f:91:1c:7a:b4:0a:1d:a1:b0:2a:6d:30:fb:d2:27: 02:1c:0a:bb:4b:71:75:27:bc:a8:25:28:97:e7:8b:d0:e9:dc: 56:84:ce:33:c0:ea:89:2d:c6:09:66:fa:b3:9e:79:97:a0:ae: 2e:a3:2a:4a:93:66:be:80:d6:78:94:12:db:86:ee:81:c0:76: 6d:7c:c3:c9:f6:0d:da:87:bf:4e:53:f0:c3:32:3b:83:60:98: 2d:19:9b:6c 2.编写脚本 通过脚本获取证书的相关时间 12Not Before: Sep 15 16:20:54 2023 GMTNot After : Oct 15 16:20:54 2023 GMT check_ssl_crt.sh 脚本 1234567891011#!/bin/bash#author: dbruce dong#desc: check one ssl crt expire time#desc: 检查 https证书还有多少天过明#获取过期时间last_day=`openssl x509 -in /usr/local/nginx/conf/cert.pem -noout -text | awk &#x27;/After/&#123;gsub(/Oct/,&quot;10&quot;);print $7&quot;-&quot;$4&quot;-&quot;$5&#125;&#x27;`#获取秒last_day_sec=`date +%s -d &quot;$last_day&quot;`today_sec=`date +%s`#进行计算awk -vlast=$last_day_sec -vnow=$today_sec &#x27;BEGIN&#123;print ( last - non )/60/60/24&#125;&#x27; 执行结果 12[root@centos07-22 ~]# bash check_ssl_crt.sh19644.7 zabbix agent 端，编写自定义监控脚本 web页面添加自定义监控","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"zabbix","slug":"运维/zabbix","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/"},{"name":"5.0LTS","slug":"运维/zabbix/5-0LTS","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/5-0LTS/"}],"tags":[]},{"title":"10-监控tcp","slug":"运维/zabbix/5.0/10-监控tcp","date":"2022-02-10T12:00:00.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2022/02/10/运维/zabbix/5.0/10-监控tcp/","link":"","permalink":"https://dbbruce.github.io/2022/02/10/%E8%BF%90%E7%BB%B4/zabbix/5.0/10-%E7%9B%91%E6%8E%A7tcp/","excerpt":"","text":"0. tcp连接状态SYN_SEND: client发送连接请求SYN_RECD: server接收到连接请求ESTABLISHED: 连接CLOSE_WAIT: 收到client端口请求LAST_ACK: Server发送确认（fin）TIME-WAIT1：等待1， clinet发起断开请求（fin ack），等待server回复TIME-WAIT2：等待2， server回复（ack），收到请求，但是没有确认TIME-WAIT： 断开， server发送（fin）， client收到确认 连接： 断开： 1.查看tcp连接ss -ant |grep -i ‘estab’ # -i 忽略大小写查看tcp连接中22端口的连接 1[root@centos07-22 conf]# ss -ant |grep -i &#x27;estab&#x27; |awk &#x27;$4~/:22/&#x27; 查看tcp 22端口连接数量 1[root@centos07-22 conf]# ss -ant |grep -i &#x27;estab&#x27; |awk &#x27;$4~/:22/&#x27; | wc -l 2.编写脚本 通过脚本获取证书的相关时间 zabbix agent端，编写自定义监控脚本 web页面添加自定义监控","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"zabbix","slug":"运维/zabbix","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/"},{"name":"5.0LTS","slug":"运维/zabbix/5-0LTS","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/5-0LTS/"}],"tags":[]},{"title":"09-监控负载均衡","slug":"运维/zabbix/5.0/09-监控负载均衡","date":"2022-02-09T12:00:00.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2022/02/09/运维/zabbix/5.0/09-监控负载均衡/","link":"","permalink":"https://dbbruce.github.io/2022/02/09/%E8%BF%90%E7%BB%B4/zabbix/5.0/09-%E7%9B%91%E6%8E%A7%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/","excerpt":"1.Nginx 开启状态统计 编译安装时使用–with-http_stub_status_module开启状态页面模块 12345[root@master nginx-1.22.1]# ./configure --prefix=/usr/local/nginx # 安装路径--with-http_ssl_module # 开启ssl加密功能--with-stream # 开启tcp udp代理--with-http_stub_status_module # 开通status状态统计","text":"1.Nginx 开启状态统计 编译安装时使用–with-http_stub_status_module开启状态页面模块 12345[root@master nginx-1.22.1]# ./configure --prefix=/usr/local/nginx # 安装路径--with-http_ssl_module # 开启ssl加密功能--with-stream # 开启tcp udp代理--with-http_stub_status_module # 开通status状态统计 修改nginx配置文件 12345678listen 80; server_name www.a.com; location /status &#123; stub_status on; #allow IP地址; # 允许访问 #deny IP地址/all; #拒绝访问 &#125; 重启nginx 1[root@centos07-22 conf]# /usr/local/nginx/sbin/nginx -s reload curl 查看 12345[root@centos07-22 conf]# curl 192.168.1.22/statusActive connections: 1server accepts handled requests 2 2 2Reading: 0 Writing: 1 Waiting: 0 2.使用模板 配置 → nginx主机 → 模板 → 选择 “Template App Nginx by Zabbix agent” 模板 nginx模板不能直接使用，需要配置，配置 → nginx主机 → 模板 → 点击模板 “Template App Nginx by Zabbix agent” → 宏 → 修改 url地址","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"zabbix","slug":"运维/zabbix","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/"},{"name":"5.0LTS","slug":"运维/zabbix/5-0LTS","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/5-0LTS/"}],"tags":[]},{"title":"08-监控java（待完善）","slug":"运维/zabbix/5.0/08-监控java（待完善）","date":"2022-02-08T12:00:00.000Z","updated":"2023-12-05T03:07:40.000Z","comments":true,"path":"2022/02/08/运维/zabbix/5.0/08-监控java（待完善）/","link":"","permalink":"https://dbbruce.github.io/2022/02/08/%E8%BF%90%E7%BB%B4/zabbix/5.0/08-%E7%9B%91%E6%8E%A7java%EF%BC%88%E5%BE%85%E5%AE%8C%E5%96%84%EF%BC%89/","excerpt":"","text":"","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"zabbix","slug":"运维/zabbix","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/"},{"name":"5.0LTS","slug":"运维/zabbix/5-0LTS","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/5-0LTS/"}],"tags":[]},{"title":"07-监控SNMP","slug":"运维/zabbix/5.0/07-监控SNMP","date":"2022-02-07T12:00:00.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2022/02/07/运维/zabbix/5.0/07-监控SNMP/","link":"","permalink":"https://dbbruce.github.io/2022/02/07/%E8%BF%90%E7%BB%B4/zabbix/5.0/07-%E7%9B%91%E6%8E%A7SNMP/","excerpt":"1.SNMP 开启SNMP snmp版本 V3 通过用户名和密码 访问 snmp信息 y2c 通过团体名id 访问设备 访问 snmp信息 v1 基本不用","text":"1.SNMP 开启SNMP snmp版本 V3 通过用户名和密码 访问 snmp信息 y2c 通过团体名id 访问设备 访问 snmp信息 v1 基本不用 配置团体名 snmp版本 V3 通过用户名和密码 访问 snmp信息 v2c 通过团体名id 访问设备 访问 snmp信息 v1 基本不用 测试1[root@master alertscripts]# yum -y install net-snmp-utils 1[root@master alertscripts]# snmpwalk -v 2c -c lidao-snmp 192.168.1.55 2.zabbix配置 添加设备，注意客户端选snmp 如果使用变量，在宏里配置 配置模板 3.查看主机","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"zabbix","slug":"运维/zabbix","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/"},{"name":"5.0LTS","slug":"运维/zabbix/5-0LTS","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/5-0LTS/"}],"tags":[]},{"title":"06-企业微信告警","slug":"运维/zabbix/5.0/06-企业微信告警","date":"2022-02-06T12:00:00.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2022/02/06/运维/zabbix/5.0/06-企业微信告警/","link":"","permalink":"https://dbbruce.github.io/2022/02/06/%E8%BF%90%E7%BB%B4/zabbix/5.0/06-%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E5%91%8A%E8%AD%A6/","excerpt":"1.查看脚本的路径12[root@master ~]# rpm -ql zabbix-server-mysql |grep alert/usr/lib/zabbix/alertscripts","text":"1.查看脚本的路径12[root@master ~]# rpm -ql zabbix-server-mysql |grep alert/usr/lib/zabbix/alertscripts 2.微信告警脚本- 名词解释 1、企业ID 2、应用管理的Secret 3、AgentId - 脚本代码wechat.py 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051#!/usr/bin/env python#_*_coding:utf-8_*_ #导入python模块import requestsimport sysimport osimport jsonimport logging #自定义logging模块的格式,具体日志会存放在&quot;/var/log/weixin.log&quot;中，你也可以自定义到其它目录中,该文件默认以追加方式写入，你可以写一个周期性任务进行滚动操作logging.basicConfig(level = logging.DEBUG, format = &#x27;%(asctime)s, %(filename)s, %(levelname)s, %(message)s&#x27;,datefmt = &#x27;%a, %d %b %Y %H:%M:%S&#x27;,filename = os.path.join(&#x27;/var/log&#x27;,&#x27;weixin.log&#x27;),filemode = &#x27;a&#x27;) #指定企业IDcorpid=&#x27;&#x27;#指定应用管理的Secretappsecret=&quot;&quot;#指定应用管理的AgentIdagentid=&quot;&quot;#指定Token_urltoken_url=&#x27;https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=&#x27; + corpid + &#x27;&amp;corpsecret=&#x27; + appsecret#获取tockenreq=requests.get(token_url)#获取tocken中access_token字段对应的值accesstoken=req.json()[&#x27;access_token&#x27;]#定义消息发送的URLmsgsend_url=&#x27;https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=&#x27; + accesstoken#定义要发送的人,也就是zabbix webUI配置的&quot;&#123;ALERT.SENDTO&#125;&quot;参数对应的值touser=sys.argv[1]#定义要发送的主题，也就是zabbix webUI配置的&quot;&#123;ALERT.SUBJECT&#125;&quot;参数对应的值subject=sys.argv[2]#定义要发送的消息内容，也就是zabbix webUI配置的&quot;&#123;ALERT.MESSAGE&#125;&quot;参数对应的值message=sys.argv[2] + &quot;\\n\\n&quot; +sys.argv[3]#指定参数params=&#123; &quot;touser&quot;: touser, &quot;msgtype&quot;: &quot;text&quot;, &quot;agentid&quot;: agentid, &quot;text&quot;: &#123; &quot;content&quot;: message &#125;, &quot;safe&quot;:0&#125;#基于requests模块的post方法发送企业微信报警消息req=requests.post(msgsend_url, data=json.dumps(params))#发送消息后记得打印日志信息，在本地的配置文件中可以查看logging.info(&#x27;sendto:&#x27; + touser + &#x27;;;subject:&#x27; + subject + &#x27;;;message:&#x27; + message) - 脚本用法1python wechat.py 用户id 主题 内容 用户id：是用户的账号 - 脚本执行权限1234[root@master alertscripts]# chmod +x wechat.py[root@master alertscripts]# ll总用量 0-rwxr-xr-x. 1 root root 0 9月 15 09:15 wechat.py 3.zabbix web配置- 配置报警媒介类型 - 配置消息模板 4.配置用户","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"zabbix","slug":"运维/zabbix","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/"},{"name":"5.0LTS","slug":"运维/zabbix/5-0LTS","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/5-0LTS/"}],"tags":[]},{"title":"05-邮件报警","slug":"运维/zabbix/5.0/05-邮件报警","date":"2022-02-05T12:00:00.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2022/02/05/运维/zabbix/5.0/05-邮件报警/","link":"","permalink":"https://dbbruce.github.io/2022/02/05/%E8%BF%90%E7%BB%B4/zabbix/5.0/05-%E9%82%AE%E4%BB%B6%E6%8A%A5%E8%AD%A6/","excerpt":"1.配置发件人","text":"1.配置发件人 2.消息模板问题和恢复#信息类型是: 问题( 发生故障主题:故障名称: {EVENT.NAME}消息:故障始于 时间: {EVENT.TIME} 日期: {EVENT.DATE}故障名称: {EVENT.NAME}故障主机: {HOST.NAME}严重程度: {EVENT.SEVERITY}额外信息: {EVENT.OPDATA}故障ID: {EVENT.ID}触发器地址: {TRIGGER.URL} #信息类型是: Problem recov故障解决的时候主题:故障解决 in {EVENT.DURATION}: {EVENTNAME}消息:故障已经解决 时间:{EVENT.RECOVERY.TIME} 日期: {EVENTRECOVERY.DATE}故障名称: {EVENT.NAME}故障持续时间: {EVENT.DURATION}故障主机: {HOST.NAME}故障级别: {EVENT.SEVERITY}故障ID: {EVENT.ID}{TRIGGER.URL} 3.配置收件人 4.配置动作","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"zabbix","slug":"运维/zabbix","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/"},{"name":"5.0LTS","slug":"运维/zabbix/5-0LTS","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/5-0LTS/"}],"tags":[]},{"title":"03-自定义key","slug":"运维/zabbix/5.0/03-自定义key","date":"2022-02-04T12:00:00.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2022/02/04/运维/zabbix/5.0/03-自定义key/","link":"","permalink":"https://dbbruce.github.io/2022/02/04/%E8%BF%90%E7%BB%B4/zabbix/5.0/03-%E8%87%AA%E5%AE%9A%E4%B9%89key/","excerpt":"1.使用key获取信息 系统自带的key key的使用12[root@master ~]# zabbix_get -s &#x27;192.168.1.22&#x27; -p 10050 -k &#x27;vm.memory.size[available]&#x27;1554325504","text":"1.使用key获取信息 系统自带的key key的使用12[root@master ~]# zabbix_get -s &#x27;192.168.1.22&#x27; -p 10050 -k &#x27;vm.memory.size[available]&#x27;1554325504 自定义监控服务器登录的人数需求:限制登录人数不超过三个，超过三个就发出报警信息 手动创建zabbix的配置文件，用于自定义key&#x2F;etc&#x2F;zabbix&#x2F;zabbix_agent2.conf123vim /etc/zabbix/zabbix_agent2.conf 273 Include=/etc/zabbix/zabbix_agent2.d/*.conf #包含配置文件的目录 296 # Format: UserParameter=&lt;key&gt;,&lt;shell command&gt; # 自定义key格式 创建一个自定义key文件12345[root@localhost ~]# cd /etc/zabbix/zabbix_agent2.d/[root@localhost zabbix_agent2.d]# pwd/etc/zabbix/zabbix_agent2.d[root@localhost zabbix_agent2.d]# vim userparameter_login.confUserParameter=login.user,who|wc -l # key=login.user 重启agent1[root@localhost zabbix_agent2.d]# systemctl restart zabbix-agent2.service zabbix server测试可以12[root@master ~]# zabbix_get -s &#x27;192.168.1.22&#x27; -p 10050 -k &#x27;login.user&#x27;1 web页面上添加自定义key 创建模板 创建应用集 （应用集像是一个文件夹，放入一堆监控项） 创建监控项，自定义item，你具体想监控的内容 创建触发器，当监控项获取到值的时候，进行和触发器比较，判断，决定是否报警 创建图形 将具体的主机和该模板链接，关联 验证","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"zabbix","slug":"运维/zabbix","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/"},{"name":"5.0LTS","slug":"运维/zabbix/5-0LTS","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/5-0LTS/"}],"tags":[]},{"title":"04-自动发现与自动注册","slug":"运维/zabbix/5.0/04-自动发现自动注册","date":"2022-02-04T12:00:00.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2022/02/04/运维/zabbix/5.0/04-自动发现自动注册/","link":"","permalink":"https://dbbruce.github.io/2022/02/04/%E8%BF%90%E7%BB%B4/zabbix/5.0/04-%E8%87%AA%E5%8A%A8%E5%8F%91%E7%8E%B0%E8%87%AA%E5%8A%A8%E6%B3%A8%E5%86%8C/","excerpt":"1.自动发现，自动注册 准备好一台客户端机器 12[root@localhost ~]# systemctl is-active zabbix-agent2active","text":"1.自动发现，自动注册 准备好一台客户端机器 12[root@localhost ~]# systemctl is-active zabbix-agent2active 2.什么是自动发现，自动注册 自动发现 123zabbix server主动的去发现所有的客户端，然后将客户端的信息，登记在服务端的机器上缺点是，zabbix-server压力会较大如果说你定义了一个网段 199~200网段，耗时较久，且压力大 自动注册 12zabbix agent2主动上报自己的信息，发给zabbxi-server缺点是agent2可能找不到server (配置文件写错了，网络不通) 被动模式，主动模式的区别 (站在agent2立场) 12被动模式，对于agent2来说，就是server来找agent2拿数据主动模式，agent2主动吧数据发给server 配置hosts解析 (我没有配置hosts也自动发现了)自动发现agent端，修改配置文件 vim &#x2F;etc&#x2F;zabbix&#x2F;zabbix_agent2.conf12345 80 Server=192.168.1.12 # 1.修改为zabbix server ip125 ServerActive=192.168.1.12 # 2.修改为zabbix server ip136 #Hostname=Zabbix server # 3.注释掉这行144 HostnameItem=system.hostname # 4.去掉注释，自动获取主机名 ，页面配置时，主机名，使用的值166 HostMetadataItem= system.uname # 5.去掉注释，自动获取原数据 ，页面配置时，主机元数据，使用的值 重启1systemctl restart zabbix-agent2.service web页面配置 配置动作 配置操作","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"zabbix","slug":"运维/zabbix","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/"},{"name":"5.0LTS","slug":"运维/zabbix/5-0LTS","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/5-0LTS/"}],"tags":[]},{"title":"02-修改图形乱码问题","slug":"运维/zabbix/5.0/02-修改图形乱码问题","date":"2022-02-02T12:00:00.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2022/02/02/运维/zabbix/5.0/02-修改图形乱码问题/","link":"","permalink":"https://dbbruce.github.io/2022/02/02/%E8%BF%90%E7%BB%B4/zabbix/5.0/02-%E4%BF%AE%E6%94%B9%E5%9B%BE%E5%BD%A2%E4%B9%B1%E7%A0%81%E9%97%AE%E9%A2%98/","excerpt":"","text":"zabbix默认检测了服务端本身，但是编码有问题 1.安装字体1[root@master ~]# yum -y install wqy-microhei-fonts 2.复制字体1[root@master ~]# \\cp /usr/share/fonts/wqy-microhei/wqy-microhei.ttc /usr/share/fonts/dejavu/DejaVuSans.ttf 3.中文显示","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"zabbix","slug":"运维/zabbix","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/"},{"name":"5.0LTS","slug":"运维/zabbix/5-0LTS","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/5-0LTS/"}],"tags":[]},{"title":"01-centos-release-scl说明","slug":"运维/zabbix/5.0/01-centos-release-scl说明","date":"2022-02-01T12:00:00.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2022/02/01/运维/zabbix/5.0/01-centos-release-scl说明/","link":"","permalink":"https://dbbruce.github.io/2022/02/01/%E8%BF%90%E7%BB%B4/zabbix/5.0/01-centos-release-scl%E8%AF%B4%E6%98%8E/","excerpt":"SCL（Software Collections）软件库安装高版本的PHP。SCL属于CentOS官方的软件库，经过充分测试，安装软件时不会替换系统的核心文件，保证了系统的稳定性。 1.CentOS 7 安装 SCL 71yum install centos-release-scl 2.安装高版本的PHP1yum install rh-php72","text":"SCL（Software Collections）软件库安装高版本的PHP。SCL属于CentOS官方的软件库，经过充分测试，安装软件时不会替换系统的核心文件，保证了系统的稳定性。 1.CentOS 7 安装 SCL 71yum install centos-release-scl 2.安装高版本的PHP1yum install rh-php72 3.Bash中启用php7.21scl_enabled /opt/rh/rh-php72 bash 4.开机启用scl的软件以 PHP 7 为例，在 ~&#x2F;.bashrc 里加入一行： 1source /opt/rh/rh-php72/enable 5.SCL的安装目录 所有软件包都安装在 &#x2F;opt 下，","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"zabbix","slug":"运维/zabbix","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/"},{"name":"5.0LTS","slug":"运维/zabbix/5-0LTS","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/5-0LTS/"}],"tags":[]},{"title":"01-zabbix5.0-日志目录","slug":"运维/zabbix/5.0/01-zabbix5.0-日志目录","date":"2022-02-01T12:00:00.000Z","updated":"2023-12-05T03:07:40.000Z","comments":true,"path":"2022/02/01/运维/zabbix/5.0/01-zabbix5.0-日志目录/","link":"","permalink":"https://dbbruce.github.io/2022/02/01/%E8%BF%90%E7%BB%B4/zabbix/5.0/01-zabbix5.0-%E6%97%A5%E5%BF%97%E7%9B%AE%E5%BD%95/","excerpt":"","text":"Serverserver日志 &#x2F;var&#x2F;log&#x2F;zabbix&#x2F;zabbix_server.log agent日志 &#x2F;var&#x2F;log&#x2F;zabbix&#x2F;zabbix_agentd.log message日志 (zabbix启动的信息有时会写在message里) &#x2F;var&#x2F;log&#x2F;messages","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"zabbix","slug":"运维/zabbix","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/"},{"name":"5.0LTS","slug":"运维/zabbix/5-0LTS","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/5-0LTS/"}],"tags":[]},{"title":"01-zabbix5.0-阿里源安装","slug":"运维/zabbix/5.0/01-zabbix5.0-阿里源安装","date":"2022-02-01T12:00:00.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2022/02/01/运维/zabbix/5.0/01-zabbix5.0-阿里源安装/","link":"","permalink":"https://dbbruce.github.io/2022/02/01/%E8%BF%90%E7%BB%B4/zabbix/5.0/01-zabbix5.0-%E9%98%BF%E9%87%8C%E6%BA%90%E5%AE%89%E8%A3%85/","excerpt":"阿里源地址： https://developer.aliyun.com/mirror/ 测试环境信息： zabbix-server:192.168.1.12:Admin+123456 mysql:root+123456，zabbix+zabbix","text":"阿里源地址： https://developer.aliyun.com/mirror/ 测试环境信息： zabbix-server:192.168.1.12:Admin+123456 mysql:root+123456，zabbix+zabbix server1.关闭防火墙1234[root@master sbin]# systemctl stop firewalld.service[root@master sbin]# systemctl disable firewalld.serviceRemoved symlink /etc/systemd/system/multi-user.target.wants/firewalld.service.Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service. 2.关闭selinux1234[root@master sbin]# setenforce 0config final/ semanage.conf targeted/ tmp/[root@master sbin]# vim /etc/selinux/configSELINUX=disabled 3.获取zabbix的下载源1rpm -Uvh https://mirrors.aliyun.com/zabbix/zabbix/5.0/rhel/7/x86_64/zabbix-release-5.0-1.el7.noarch.rpm 4.更换zabbix.repo源，为阿里的 替换1[root@master ~]# sed -i &#x27;s#http://repo.zabbix.com#https://mirrors.aliyun.com/zabbix#&#x27; /etc/yum.repos.d/zabbix.repo 或者12vim :%s#http://repo.zabbix.com#https://mirrors.aliyun.com/zabbix#g 查看12345678910111213141516171819202122232425262728[root@master ~]# cat /etc/yum.repos.d/zabbix.repo[zabbix]name=Zabbix Official Repository - $basearchbaseurl=https://mirrors.aliyun.com/zabbix/zabbix/5.0/rhel/7/$basearch/enabled=1gpgcheck=1gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-ZABBIX-A14FE591[zabbix-frontend]name=Zabbix Official Repository frontend - $basearchbaseurl=https://mirrors.aliyun.com/zabbix/zabbix/5.0/rhel/7/$basearch/frontendenabled=0gpgcheck=1gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-ZABBIX-A14FE591[zabbix-debuginfo]name=Zabbix Official Repository debuginfo - $basearchbaseurl=https://mirrors.aliyun.com/zabbix/zabbix/5.0/rhel/7/$basearch/debuginfo/enabled=0gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-ZABBIX-A14FE591gpgcheck=1[zabbix-non-supported]name=Zabbix Official Repository non-supported - $basearchbaseurl=https://mirrors.aliyun.com/zabbix/non-supported/rhel/7/$basearch/enabled=1gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-ZABBIXgpgcheck=1 5.清空缓存，下载zabbix服务端12yum clean allyum makecache 1yum install zabbix-server-mysql zabbix-agent2 -y 6.安装 centos-release-scl，解决软件版本冲突问题 安装 Software Collections，便于后续安装高版本的 php，默认 yum 安装的 php 版本为 54 过低sCl(Software Collections可以让你在同一个操作系统上安装和使用多个版本的软任，而不会影整个系统的安装包软件包会安装在&#x2F;opt&#x2F;rh目录下为了避免系统广泛冲突，&#x2F;opt&#x2F;rh包安装在目录中，例如，这允许你在CentOS 7机器上安装Python 3.5，而不会删除或干扰Pyletc&#x2F;opt&#x2F;rh&#x2F;软件包的所有配置文件都存储在目录中相应的目录中，SCL包提供了定义使用所包含应用程序所需的环境变量的s安装后软件会被放在目录:&#x2F;opt&#x2F;rh&#x2F;1yum install centos-release-scl -y 7.修改zabbix-front前端源，修改zabbix-frontend的enabled&#x3D;11234567[root@master ~]# vim /etc/yum.repos.d/zabbix.repo[zabbix-frontend]name=Zabbix Official Repository frontend - $basearchbaseurl=https://mirrors.aliyun.com/zabbix/zabbix/5.0/rhel/7/$basearch/frontendenabled=1gpgcheck=1gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-ZABBIX-A14FE591 8.安装zabbix前端环境，且是安装到scl环境下1[root@master ~]# yum install zabbix-web-mysql-scl zabbix-apache-conf-scl -y 9.安装zabbix所需的数据库，mariadb1yum install mariadb-server -y 10.配置数据库，开机启动12[root@master ~]# systemctl enable --now mariadbCreated symlink from /etc/systemd/system/multi-user.target.wants/mariadb.service to /usr/lib/systemd/system/mariadb.service. 11.初始化数据库，设置密码，1234561[root@master ~]# mysql_secure_installation 12.添加数据库用户，以及zabbix所需的数据库信息1234567create database zabbix character set utf8 collate utf8_bin;create user zabbix@localhost identified by &#x27;zabbix&#x27;;grant all privileges on zabbix.* to zabbix@localhost;flush privileges; 13.使用zabbix-mysq1命令，导入数据库信息mysql -u用户名 -p 数据库名1zcat /usr/share/doc/zabbix-server-mysql*/create.sql.gz | mysql -uzabbix -p zabbix 14.修改zabbix server配置文件，修改数据库的密码12[root@master ~]# grep &#x27;^DBPa&#x27; /etc/zabbix/zabbix_server.confDBPassword=zabbix 15.修改zabbix的php配置文件&#x2F;etc&#x2F;opt&#x2F;rh&#x2F;rh-php72&#x2F;php-fpm.d&#x2F;zabbix.conf 12[root@master ~]# vim /etc/opt/rh/rh-php72/php-fpm.d/zabbix.confphp_value[date.timezone] = Asia/Shanghai 16.启动zabbix相关服务器service zabbix-server startsystemctl restart zabbix-server zabbix-agent httpd rh-php72-php-fpmsystemctl enable zabbix-server zabbix-agent httpd rh-php72-php-fpm 17.web页面123http://192.168.1.12/zabbixAdminzabbix agent1.获取zabbix的下载源1rpm -Uvh https://mirrors.aliyun.com/zabbix/zabbix/5.0/rhel/7/x86_64/zabbix-release-5.0-1.el7.noarch.rpm 2.更换zabbix.repo源，为阿里的 替换1[root@master ~]# sed -i &#x27;s#http://repo.zabbix.com#https://mirrors.aliyun.com/zabbix#&#x27; /etc/yum.repos.d/zabbix.repo 3.安装agent1yum install zabbix-agent2 -y 4.查看配置文件1[root@localhost ~]# ll /etc/zabbix/zabbix_agent2.conf 启动命令12[root@localhost ~]# systemctl enable --now zabbix-agent2Created symlink from /etc/systemd/system/multi-user.target.wants/zabbix-agent2.service to /usr/lib/systemd/system/zabbix-agent2.service. 修改agent2配置文件，查看配置信息，根据自己的机器环境修改即可123456789[root@localhost ~]# grep -Ev &#x27;^#|^$&#x27; /etc/zabbix/zabbix_agent2.confPidFile=/var/run/zabbix/zabbix_agent2.pidLogFile=/var/log/zabbix/zabbix_agent2.logLogFileSize=0Server=192.168.1.12 # 修改 ***** 只修改这里就可以成功，sever就能添加主机ServerActive=192.168.1.12 # 修改Hostname=centos02-22 # 修改Include=/etc/zabbix/zabbix_agent2.d/*.confControlSocket=/tmp/agent.sock #最后一步，进行重启zabbix-agent21systemctl restart zabbix-agent2 验证zabbix-agent2的连通性0.关闭防火墙1234[root@master sbin]# systemctl stop firewalld.service[root@master sbin]# systemctl disable firewalld.serviceRemoved symlink /etc/systemd/system/multi-user.target.wants/firewalld.service.Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service. 1.在服务端上通过命令，主动获取数据1yum install zabbix-get -y 2.命令检测服务端是否连接上客户端12[root@master ~]# zabbix_get -s &#x27;192.168.1.22&#x27; -p 10050 -k &#x27;system.hostname&#x27;localhost.localdomain","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"zabbix","slug":"运维/zabbix","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/"},{"name":"5.0LTS","slug":"运维/zabbix/5-0LTS","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/5-0LTS/"}],"tags":[]},{"title":"01-grafana安装","slug":"运维/grafana/01-grafana安装","date":"2022-02-01T02:00:00.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2022/02/01/运维/grafana/01-grafana安装/","link":"","permalink":"https://dbbruce.github.io/2022/02/01/%E8%BF%90%E7%BB%B4/grafana/01-grafana%E5%AE%89%E8%A3%85/","excerpt":"1.grafana 安装 (装个高版本，后期使用grafana提供的模板可能报错，7版本就报错了，网上说9版本OK) https://mirrors.aliyun.com/grafana/ yum → rpm → Packages → grafana-7.3.5-1.x86_64.rpm 下载包 1wget -P ~/ https://mirrors.aliyun.com/grafana/yum/rpm/Packages/grafana-7.3.5-1.x86_64.rpm 安装方法一： 1234# 安装依赖yum -y install fontconfig urw-fonts# 安装grafanarpm -ivh grafana-7.3.5-1.x86_64.rpm 安装方法二： 12# 安装依赖，安装grafanayum -y localinstall grafana-7.3.5-1.x86_64.rpm","text":"1.grafana 安装 (装个高版本，后期使用grafana提供的模板可能报错，7版本就报错了，网上说9版本OK) https://mirrors.aliyun.com/grafana/ yum → rpm → Packages → grafana-7.3.5-1.x86_64.rpm 下载包 1wget -P ~/ https://mirrors.aliyun.com/grafana/yum/rpm/Packages/grafana-7.3.5-1.x86_64.rpm 安装方法一： 1234# 安装依赖yum -y install fontconfig urw-fonts# 安装grafanarpm -ivh grafana-7.3.5-1.x86_64.rpm 安装方法二： 12# 安装依赖，安装grafanayum -y localinstall grafana-7.3.5-1.x86_64.rpm 查看是否安装成功 12rpm -qa|grep grafanagrafana-7.3.5-1.x86_64 启动 12systemctl start grafana-server.servicesystemctl enable grafana-server.service 查看启动状态 1[root@master ~]# ss -anput |grep grafana web访问，端口3000 http://192.168.1.12:3000/login默认:admin &#x2F; admin grafana添加插件方式一：grafana-cli 123# 网络不好，下的慢grafana-cli plugins list-remote |grep zabbixgrafana-cli plugins install alexanderzobnin-zabbix-app 方式二：手动，自己分享一个 链接:https://pan.baidu.com/s/1PwYXozan5WnMJePrlcTQ0Q 密码:2la3 12unzip alexanderzobnin-zabbix-app-4.1.5.zipmv alexanderzobnin-zabbix-app /var/lib/grafana/plugins/ 启动插件 插件安装成功，页面插件就有zabbix了 启动插件，提示启动成功 添加数据源 添加数据源 手动测试下，api接口，提示412代表接口没有问题 123456789101112131415161718192021curl -v http://192.168.1.12/zabbix/api_jsonrpc.php* About to connect() to 192.168.1.12 port 80 (#0)* Trying 192.168.1.12...* Connected to 192.168.1.12 (192.168.1.12) port 80 (#0)&gt; GET /zabbix/api_jsonrpc.php HTTP/1.1&gt; User-Agent: curl/7.29.0&gt; Host: 192.168.1.12&gt; Accept: */*&gt;&lt; HTTP/1.1 412 Precondition Failed&lt; Date: Fri, 15 Sep 2023 22:49:42 GMT&lt; Server: Apache/2.4.6 (CentOS) OpenSSL/1.0.2k-fips mod_fcgid/2.3.9&lt; X-Powered-By: PHP/7.2.24&lt; Access-Control-Allow-Origin: *&lt; Access-Control-Allow-Headers: Content-Type&lt; Access-Control-Allow-Methods: POST&lt; Access-Control-Max-Age: 1000&lt; Transfer-Encoding: chunked&lt; Content-Type: text/html; charset=UTF-8&lt;* Connection #0 to host 192.168.1.12 left intact 页面配置zabbix接口信息和账号密码http://192.168.1.12/zabbix/api_jsonrpc.php zabbix的用户和密码 导入图形 查看图形 grafana查询简介 名称 默认值 简介 Query Mode Metrics 查询类型，监控项 Group Zabbix servers 主机组 Application CPU 应用集 Host Zabbix server 主机 Item &#x2F;CPU (?!idle)&#x2F; 监控项名称， 支持正在，(?!idle):排除idle（空闲），其他的cpu指标都显示 修改图形的方式 创建一个故障集合 grafana的模板 地址：https://grafana.com/grafana/dashboards/ 下载模板，json格式 grafana导入模板，将下载的json格式模板内容，直接粘在里面就可以了 默认模板不能编辑，开启编辑权限","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"grafana","slug":"运维/grafana","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/grafana/"}],"tags":[]},{"title":"mysql错误集锦","slug":"mysql/mysql错误集锦","date":"2021-12-31T17:01:01.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2022/01/01/mysql/mysql错误集锦/","link":"","permalink":"https://dbbruce.github.io/2022/01/01/mysql/mysql%E9%94%99%E8%AF%AF%E9%9B%86%E9%94%A6/","excerpt":"1. 密码1wget -i -c http://dev.mysql.com/get/mysql57-community-release-el7-10.noarch.rpm","text":"1. 密码1wget -i -c http://dev.mysql.com/get/mysql57-community-release-el7-10.noarch.rpm 2.yum安装源1yum -y install mysql57-community-release-el7-10.noarch.rpm 3.导入key1rpm --import https://repo.mysql.com/RPM-GPG-KEY-mysql-2022 不导入，可能报错 123456789101112导入 GPG key 0x5072E1F5: 用户ID : &quot;MySQL Release Engineering &lt;mysql-build@oss.oracle.com&gt;&quot; 指纹 : a4a9 4068 76fc bd3c 4567 70c8 8c71 8d3b 5072 e1f5 软件包 : mysql57-community-release-el7-10.noarch (@/mysql57-community-release-el7-10.noarch) 来自 : /etc/pki/rpm-gpg/RPM-GPG-KEY-mysqlmysql-community-common-5.7.43-1.el7.x86_64.rpm 的公钥尚未安装 失败的软件包是：mysql-community-common-5.7.43-1.el7.x86_64 GPG 密钥配置为：file:///etc/pki/rpm-gpg/RPM-GPG-KEY-mysql 4.安装mysql1yum -y install mysql-community-server 5.启动MySQL12systemctl start mysqld.servicesystemctl enable mysqld.service 查看运行状态 1systemctl status mysqld.service 6.查看安装mysql时，初始密码12grep &quot;password&quot; /var/log/mysqld.log2023-09-22T15:12:52.363569Z 1 [Note] A temporary password is generated for root@localhost: d)RaWyi%i2d6 7.进入数据库，密码使用单引号，密码中的特殊字符无效1mysql -uroot -p&#x27;d)RaWyi%i2d6&#x27; 8.修改密码1ALTER USER &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;Dong@123456&#x27;; 9.开启mysql的远程访问12grant all privileges on *.* to &#x27;root&#x27;@&#x27;%&#x27; identified by &#x27;Dong@123456&#x27; with grant option;flush privileges; 10.为firewalld添加开放端口12firewall-cmd --zone=public --add-port=3306/tcp --permanentfirewall-cmd --reload 11.更改mysql的语言首先重新登录mysql，然后输入status： 12345678910111213141516171819202122mysql&gt; status;--------------mysql Ver 14.14 Distrib 5.7.43, for Linux (x86_64) using EditLine wrapperConnection id: 5Current database:Current user: root@localhostSSL: Not in useCurrent pager: stdoutUsing outfile: &#x27;&#x27;Using delimiter: ;Server version: 5.7.43 MySQL Community Server (GPL)Protocol version: 10Connection: Localhost via UNIX socketServer characterset: latin1 # 这里部署utf8Db characterset: latin1 Client characterset: utf8Conn. characterset: utf8UNIX socket: /var/lib/mysql/mysql.sockUptime: 30 min 18 secThreads: 1 Questions: 14 Slow queries: 0 Opens: 113 Flush tables: 1 Open tables: 106 Queries per second avg: 0.007 进入文件后，新增四行代码： 123456vim /etc/my.cnf[client]default-character-set=utf8character-set-server=utf8collation-server=utf8_general_ci 保存更改后的my.cnf文件后，重启下mysql，然后输入status再次查看 1systemctl restart mysqld.service 1234567891011121314151617181920212223mysql&gt; status--------------mysql Ver 14.14 Distrib 5.7.43, for Linux (x86_64) using EditLine wrapperConnection id: 2Current database:Current user: root@localhostSSL: Not in useCurrent pager: stdoutUsing outfile: &#x27;&#x27;Using delimiter: ;Server version: 5.7.43 MySQL Community Server (GPL)Protocol version: 10Connection: Localhost via UNIX socketServer characterset: utf8Db characterset: utf8Client characterset: utf8Conn. characterset: utf8UNIX socket: /var/lib/mysql/mysql.sockUptime: 10 secThreads: 1 Questions: 5 Slow queries: 0 Opens: 106 Flush tables: 1 Open tables: 99 Queries per second avg: 0.500--------------","categories":[{"name":"mysql","slug":"mysql","permalink":"https://dbbruce.github.io/categories/mysql/"}],"tags":[]},{"title":"62-查看Linux硬件配置信息","slug":"运维/Linux云计算教程/62-查看Linux硬件配置信息","date":"2021-10-01T04:00:52.000Z","updated":"2024-11-04T03:27:28.000Z","comments":true,"path":"2021/10/01/运维/Linux云计算教程/62-查看Linux硬件配置信息/","link":"","permalink":"https://dbbruce.github.io/2021/10/01/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/62-%E6%9F%A5%E7%9C%8BLinux%E7%A1%AC%E4%BB%B6%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF/","excerpt":"","text":"查看Linux硬件配置信息1.查看机器所有硬件信息:12dmidecode |moredmesg |more 这2个命令出来的信息都非常多,所以建议后面使用”|more”便于查看 2.查看CPU信息 方法一:Linux下CPU相关的参数保存在 &#x2F;proc&#x2F;cpuinfo 文件里1cat /proc/cpuinfo |more 方法二:采用命令dmesg | grep CPU可以查看到相关CPU的启动信息查看CPU的位数:1getconf LONG_BIT 3.查看Mem信息123cat /proc/meminfo |more （注意输出信息的最后一行:MachineMem:41932272 kB）free -mtop 4.查看磁盘信息 方法一:1fdisk -l 可以看到系统上的磁盘(包括U盘)的分区以及大小相关信息。 方法二:直接查看1cat/proc/partitions 5.查看网卡信息 方法一：12345# 采用此命令可以查看到网卡相关的技术指标ethtool eth0 # 查看网卡驱动ethtool -i eth1 加上 -i 参数 方法二：12345678#看到网卡名字(厂家)等信息dmesg | grep eth0 # 可以看到当前的网卡配置包括IP、网关地址等信息。/etc/sysconfig/network-scripts/ifcfg-eth0 #当然也可以通过ifconfig命令查看。ifconfig 6.如何查看主板信息？1lspci 7.如何挂载ISO文件1mount -o loop *.iso mount_point 8.如何查看光盘相关信息 方法一：插入CD光碟后，在本人的RHEL5系统里，光碟文件是 &#x2F;dev&#x2F;cdrom，因此只需 mount &#x2F;dev&#x2F;cdrom mount_point 即可。12[root@miix tmp]# mount /dev/cdrom mount_pointmount: block device /dev/cdrom is write-protected, mounting read-only 其实仔细看一下，光驱的设备文件是 hdc 123[root@miix tmp]# ls -l /dev/cdrom*lrwxrwxrwx 1 root root 3 01-08 08:54 /dev/cdrom -&gt; hdclrwxrwxrwx 1 root root 3 01-08 08:54 /dev/cdrom-hdc -&gt; hdc 因此我们也可以这样 mount &#x2F;dev&#x2F;hdc mount_point如果光驱里没放入有效光盘，则报错： 1[root@miix tmp]# mount /dev/hdc mount_point mount: 找不到介质 9.如何查看USB设备相关 方法一：其实通过 fdisk -l 命令可以查看到接入的U盘信息，本人的U盘信息如下：123456Disk /dev/sda: 2012 MB, 2012217344 bytes16 heads, 32 sectors/track, 7676 cylindersUnits = cylinders of 512 * 512 = 262144 bytesDevice BootStartEndBlocksId System/dev/sda1*1676761961024b W95 FAT32 U盘的设备文件是 &#x2F;dev&#x2F;sda，2G大小，FAT32格式。 如果用户登陆的不是Linux图形界面，U盘不会自动挂载上来。此时可以通过手工挂载(mount)：mount &#x2F;dev&#x2F;sda1 mount_point以上命令将U盘挂载到当前目录的 mount_point 目录，注意挂的是 sda1 不是 sda。卸载命令是 umount mount_point Linux默认没有自带支持NTFS格式磁盘的驱动，但对FAT32支持良好，挂载的时候一般不需要 -t vfat 参数 。如果支持ntfs，对ntfs格式的磁盘分区应使用 -t ntfs 参数。如果出现乱码情况，可以考虑用 -o iocharset&#x3D;字符集 参数。 可以通过 lsusb 命令查看 USB 设备信息哦： 123456[root@miix tmp]# lsusbBus 001 Device 001: ID 0000:0000Bus 002 Device 001: ID 0000:0000Bus 003 Device 001: ID 0000:0000Bus 004 Device 002: ID 0951:1613 Kingston TechnologyBus 004 Device 001: ID 0000:0000 1、创建多目录-p 如果文件存在,不报错 如果文件不存在,创建文件 补充[可以递归创建文件夹 例如 test&#x2F;test]-v 为每个创建的目录打印一条消息 例如 mkdir -v test 则会显示 已创建目录’test’123456789[root@Centos7-56 ~]# mkdir -vp ./&#123;a,b&#125;-&#123;a,c&#125;-&#123;t,y&#125;mkdir: created directory ‘./a-a-t’mkdir: created directory ‘./a-a-y’mkdir: created directory ‘./a-c-t’mkdir: created directory ‘./a-c-y’mkdir: created directory ‘./b-a-t’mkdir: created directory ‘./b-a-y’mkdir: created directory ‘./b-c-t’mkdir: created directory ‘./b-c-y’ 2、打印环境变量：printenv 3、文件类型1234567-普通文件d目录文件b块设备文件c字符设备文件l符号链接文件p管道命令文件s套接字文件 4、ls -h 文件单位自动转换 5、时间date，clock， hwclock， cal 6、head -n 10 查看前10行 7、tail -n 10 查看后10行 8、cut文件切分12345-d 指定分隔符-f 指定要显示的字符 -f 1,3 显示第一个和第三个-f 1-3 显示第一到第三实例：cut -d : -f1,3 /etc/passwd 9、sort 排序，对内容排序12345678-r 反向排序-n 数值排序-t 分隔符-k 指定字段-u 去重-f 忽略大小写sort 1.txtsort -t : -k3 /etc/passwd 用：分隔，第3个字段排序 10、uniq1234-c 显示重复次数-d 只显示重复的行uniq -c 1.txtuniq -d 1.txt 11、wc 123456wc /etc/fstab8 48 608 /etc/fstab 8行 48个单词 608个字符（包含空格）-l 行数-w 单词-c 字符-L 最长一行多少字符 12、tr 替换或删除字符123tr &#x27;ab&#x27; &#x27;AB&#x27;-d 删除tr -d ‘a&#x27; 13、设置英文 export LANG&#x3D;en 14、ctrl+a 跳到命令行首 ctrl+e 跳到命令行尾 ctrl+u 删除光标到行首 ctrl+k 删除光标到行尾 ctrl+l 清屏 15、history （默认1000条）123-c 清空命令历史-d 清空指定位置历史 -d 501 10 从501开始删除10个-w 将缓存中命令历史保存至文件中","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"00-错误集锦-414 Request-URI Too Large","slug":"运维/nginx/00-错误集锦-414 Request-URI Too Large","date":"2021-10-01T03:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2021/10/01/运维/nginx/00-错误集锦-414 Request-URI Too Large/","link":"","permalink":"https://dbbruce.github.io/2021/10/01/%E8%BF%90%E7%BB%B4/nginx/00-%E9%94%99%E8%AF%AF%E9%9B%86%E9%94%A6-414%20Request-URI%20Too%20Large/","excerpt":"1.414 Request-URI Too Large现象1234567&lt;html&gt;&lt;head&gt;&lt;title&gt;414 Request-URI Too Large&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;center&gt;&lt;h1&gt;414 Request-URI Too Large&lt;/h1&gt;&lt;/center&gt;&lt;hr&gt;&lt;center&gt;nginx/1.22.1&lt;/center&gt;&lt;/body&gt;&lt;/html&gt;","text":"1.414 Request-URI Too Large现象1234567&lt;html&gt;&lt;head&gt;&lt;title&gt;414 Request-URI Too Large&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;center&gt;&lt;h1&gt;414 Request-URI Too Large&lt;/h1&gt;&lt;/center&gt;&lt;hr&gt;&lt;center&gt;nginx/1.22.1&lt;/center&gt;&lt;/body&gt;&lt;/html&gt; 原因 URL过长 nginx内存太小 解决办法 修改nginx配置生产环境用这个配置就可以123456http &#123; include mime.types; default_type application/octet-stream; client_header_buffer_size 1k; # 默认开1K内存 large_client_header_buffers 4 4k; # 最大开4个4K，16K；","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"nginx","slug":"运维/nginx","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/nginx/"}],"tags":[]},{"title":"00-错误集锦-nginx1.22 配置证书报错","slug":"运维/nginx/00-错误集锦-nginx1.22 配置证书报错","date":"2021-10-01T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/10/01/运维/nginx/00-错误集锦-nginx1.22 配置证书报错/","link":"","permalink":"https://dbbruce.github.io/2021/10/01/%E8%BF%90%E7%BB%B4/nginx/00-%E9%94%99%E8%AF%AF%E9%9B%86%E9%94%A6-nginx1.22%20%E9%85%8D%E7%BD%AE%E8%AF%81%E4%B9%A6%E6%8A%A5%E9%94%99/","excerpt":"1.nginx1.22 配置证书报错现象123[root@master conf]# /usr/local/nginx/sbin/nginx -s reloadnginx: [emerg] cannot load certificate &quot;/usr/local/nginx/conf/cert.pem&quot;: PEM_read_bio_X509_AUX() failed (SSL: error:0906D06C:PEM routines:PEM_read_bio:no start line:Expecting: TRUSTED CERTIFICATE) 12[root@master conf]# /usr/local/nginx/sbin/nginx -vnginx version: nginx/1.22.1 原因1未指定证书格式 -x509","text":"1.nginx1.22 配置证书报错现象123[root@master conf]# /usr/local/nginx/sbin/nginx -s reloadnginx: [emerg] cannot load certificate &quot;/usr/local/nginx/conf/cert.pem&quot;: PEM_read_bio_X509_AUX() failed (SSL: error:0906D06C:PEM routines:PEM_read_bio:no start line:Expecting: TRUSTED CERTIFICATE) 12[root@master conf]# /usr/local/nginx/sbin/nginx -vnginx version: nginx/1.22.1 原因1未指定证书格式 -x509 解决办法重新生成证书，指定格式 -x509 123456789101112131415[root@master conf]# openssl req -new -x509 -key cert.key &gt; cert.pemYou are about to be asked to enter information that will be incorporatedinto your certificate request.What you are about to enter is what is called a Distinguished Name or a DN.There are quite a few fields but you can leave some blankFor some fields there will be a default value,If you enter &#x27;.&#x27;, the field will be left blank.-----Country Name (2 letter code) [XX]:CNState or Province Name (full name) []:bjLocality Name (eg, city) [Default City]:bjOrganization Name (eg, company) [Default Company Ltd]:dOrganizational Unit Name (eg, section) []:dCommon Name (eg, your name or your server&#x27;s hostname) []:c01Email Address []:dbbrcue@163.com","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"nginx","slug":"运维/nginx","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/nginx/"}],"tags":[]},{"title":"00-错误集锦-nginx未启动，reload报错","slug":"运维/nginx/00-错误集锦-nginx未启动，reload报错","date":"2021-10-01T03:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2021/10/01/运维/nginx/00-错误集锦-nginx未启动，reload报错/","link":"","permalink":"https://dbbruce.github.io/2021/10/01/%E8%BF%90%E7%BB%B4/nginx/00-%E9%94%99%E8%AF%AF%E9%9B%86%E9%94%A6-nginx%E6%9C%AA%E5%90%AF%E5%8A%A8%EF%BC%8Creload%E6%8A%A5%E9%94%99/","excerpt":"1.nginx未启动，reload报错现象12[root@master conf]# /usr/local/nginx/sbin/nginx -s reloadnginx: [error] open() &quot;/usr/local/nginx/logs/nginx.pid&quot; failed (2: No such file or directory) 原因1nginx未启动","text":"1.nginx未启动，reload报错现象12[root@master conf]# /usr/local/nginx/sbin/nginx -s reloadnginx: [error] open() &quot;/usr/local/nginx/logs/nginx.pid&quot; failed (2: No such file or directory) 原因1nginx未启动 解决办法123[root@master conf]# /usr/local/nginx/sbin/nginx[root@master conf]# /usr/local/nginx/sbin/nginx -s reload[root@master conf]#","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"nginx","slug":"运维/nginx","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/nginx/"}],"tags":[]},{"title":"00-错误集锦-socket-Too many open files (24)","slug":"运维/nginx/00-错误集锦-socket: Too many open files (24)","date":"2021-10-01T03:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2021/10/01/运维/nginx/00-错误集锦-socket: Too many open files (24)/","link":"","permalink":"https://dbbruce.github.io/2021/10/01/%E8%BF%90%E7%BB%B4/nginx/00-%E9%94%99%E8%AF%AF%E9%9B%86%E9%94%A6-socket:%20Too%20many%20open%20files%20(24)/","excerpt":"1.socket: Too many open files (24)现象1234567dbbruce@dbburce githubblog % ab -n 2000 -c 2000 http://www.a.com/This is ApacheBench, Version 2.3 &lt;$Revision: 1903618 $&gt;Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/Licensed to The Apache Software Foundation, http://www.apache.org/Benchmarking www.a.com (be patient)socket: Too many open files (24)","text":"1.socket: Too many open files (24)现象1234567dbbruce@dbburce githubblog % ab -n 2000 -c 2000 http://www.a.com/This is ApacheBench, Version 2.3 &lt;$Revision: 1903618 $&gt;Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/Licensed to The Apache Software Foundation, http://www.apache.org/Benchmarking www.a.com (be patient)socket: Too many open files (24) 原因nginx 配置小 1worker_processes 1; # 比较低的问题 linux 有限制 1234567891011121314151617[root@master conf]# ulimit -acore file size (blocks, -c) 0data seg size (kbytes, -d) unlimitedscheduling priority (-e) 0file size (blocks, -f) unlimitedpending signals (-i) 15063max locked memory (kbytes, -l) 64max memory size (kbytes, -m) unlimitedopen files (-n) 1024 # 1024个文件pipe size (512 bytes, -p) 8POSIX message queues (bytes, -q) 819200real-time priority (-r) 0stack size (kbytes, -s) 8192cpu time (seconds, -t) unlimitedmax user processes (-u) 15063virtual memory (kbytes, -v) unlimitedfile locks (-x) unlimited 解决办法 修改nginx配置 查看机器cpu数量，cpu2颗 12345[root@master conf]# lscpuArchitecture: x86_64CPU op-mode(s): 32-bit, 64-bitByte Order: Little EndianCPU(s): 2 worker_processes和cpu数量一致性能最高 123456worker_processes 2;events &#123; worker_connections 65535; # 这里写大写不要紧，因为达不到这么大&#125; 修改linux限制 hard: 硬限制，实际限制值soft: 软限制，相当于警告值临时修改 12[root@master conf]# ulimit -Hn 100000[root@master conf]# ulimit -Sn 100000 永久修改,需要重启，新增加 123[root@master conf]# vim /etc/security/limits.conf#* soft nofile 100000#* hard nofile 100000","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"nginx","slug":"运维/nginx","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/nginx/"}],"tags":[]},{"title":"61-Linux设置本地yum源","slug":"运维/Linux云计算教程/61-Linux设置本地yum源","date":"2021-09-30T04:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/09/30/运维/Linux云计算教程/61-Linux设置本地yum源/","link":"","permalink":"https://dbbruce.github.io/2021/09/30/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/61-Linux%E8%AE%BE%E7%BD%AE%E6%9C%AC%E5%9C%B0yum%E6%BA%90/","excerpt":"","text":"Linux设置本地yum源关防火墙12[root@centos7-05 ~]# systemctl stop firewalld.service[root@centos7-05 ~]# systemctl disable firewalld.service 系统光盘开机自动挂载&#x2F;dev&#x2F;cdrom：是Linux系统中的光驱目录，只能以只读方式挂载。mnt：镜像挂载点，可以自定义创建，这里以系统已有的mnt目录为挂载点。&#x2F;dev&#x2F;cdrom &#x2F;mnt：就是将光驱设备挂载到系统根分区的mnt目录下。iso9660：这是光盘的文件格式，这个不可修改。defaults和0 0：这个是操作权限，无需修改，默认即可。 123[root@centos7-05 ~]# vim /etc/fstab/dev/cdrom /mnt iso9660 defaults 0 0 验证配置是否生效，会自动挂载配置文件生效会出现下字样 12[root@centos7-05 dev]# mount -amount: /dev/sr0 写保护，将以只读方式挂载 查看挂载是否正常1234567891011121314[root@centos7-05 dev]# ll /mnt/总用量 696-rw-r--r--. 3 root root 14 10月 29 2020 CentOS_BuildTagdrwxr-xr-x. 3 root root 2048 10月 26 2020 EFI-rw-rw-r--. 21 root root 227 8月 30 2017 EULA-rw-rw-r--. 21 root root 18009 12月 9 2015 GPLdrwxr-xr-x. 3 root root 2048 10月 26 2020 imagesdrwxr-xr-x. 2 root root 2048 11月 2 2020 isolinuxdrwxr-xr-x. 2 root root 2048 10月 26 2020 LiveOSdrwxr-xr-x. 2 root root 673792 11月 4 2020 Packagesdrwxr-xr-x. 2 root root 4096 11月 4 2020 repodata-rw-rw-r--. 21 root root 1690 12月 9 2015 RPM-GPG-KEY-CentOS-7-rw-rw-r--. 21 root root 1690 12月 9 2015 RPM-GPG-KEY-CentOS-Testing-7-r--r--r--. 1 root root 2883 11月 4 2020 TRANS.TBL 删除其他yum源123456[root@centos7-05 dev]# cd /etc/yum.repos.d/[root@centos7-05 yum.repos.d]# lsCentOS-Base.repo CentOS-CR.repo CentOS-Debuginfo.repo CentOS-fasttrack.repo CentOS-Media.repo CentOS-Sources.repo CentOS-Vault.repo CentOS-x86_64-kernel.repo[root@centos7-05 yum.repos.d]# rm -fr *.repo 创建yum源文件 CentOS7.repo[CentOS7] # 这是文件id，必须和文件名一致，区分大小写；name&#x3D;CentOS7Yum # 这个是描述性信息，可以随意写，建议规范；baseurl&#x3D;file:&#x2F;&#x2F;&#x2F;mnt # mnt表示光盘挂载点，用该光驱里的文件作为我的yum；enabled&#x3D;1 # 1表示启动，0表示停用；gpgcheck&#x3D;0 # 0表示不效验，由于是光驱是本地的，所以这里不校验 12345678[root@centos7-05 ~]# vim /etc/yum.repos.d/CentOS7.repo[CentOS7]name=CentOS7yumbaseurl=file:///mntgpgcheck=1enabled=1gpgkey=file:///mnt/RPM-GPG-KEY-CentOS-7 启用yum源1[root@centos7-05 yum.repos.d]# yum-config-manager --enable CentOS7 清除缓存并新建缓存123[root@centos7-05 ~]# yum clean all[root@centos7-05 ~]# yum makecache 测试1[root@centos7-05 ~]# yum list 安装并启动httpd服务123[root@centos7-05 ~]# yum -y install httpd[root@centos7-05 ~]# systemctl start httpd.service 建立centos软连接1[root@centos7-05 ~]# ln -s /mnt /var/www/html/centos7 访问http://192.168.1.52/centos7/","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"60-ftp","slug":"运维/Linux云计算教程/60-ftp","date":"2021-09-29T04:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2021/09/29/运维/Linux云计算教程/60-ftp/","link":"","permalink":"https://dbbruce.github.io/2021/09/29/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/60-ftp/","excerpt":"","text":"vsFTP安装vsftp yum -y install vsftpd systemctl start vsftpd mkdir &#x2F;var&#x2F;ftp&#x2F;share chmod o+w &#x2F;var&#x2F;ftp&#x2F;share vim +29 &#x2F;etc&#x2F;vsftpd&#x2F;vsftpd.confanon_upload_enable&#x3D;YES # 开启匿名上传功能更 systemctl restart vsftpd 使用，默认用户ftp，密码空1234567891011121314151617181920212223242526272829303132333435363738394041424344454647[root@centos07-12 ftp]# ftp 192.168.1.12 21Connected to 192.168.1.12 (192.168.1.12).220 (vsFTPd 3.0.2)Name (192.168.1.12:root): ftp # 用户名331 Please specify the password.Password: # 密码空，直接回车230 Login successful. # 看到success登录成功Remote system type is UNIX.Using binary mode to transfer files.ftp&gt; ls227 Entering Passive Mode (192,168,1,12,111,226).150 Here comes the directory listing.-rw-r--r-- 1 0 0 0 Nov 03 00:06 1.txt-rw-r--r-- 1 0 0 0 Nov 03 00:06 2.txtdrwxr-xr-x 2 0 0 19 Nov 03 00:10 pubdrwxr-xrwx 2 0 0 20 Nov 03 00:39 share226 Directory send OK.ftp&gt; cd share/250 Directory successfully changed.ftp&gt; ls227 Entering Passive Mode (192,168,1,12,162,213).150 Here comes the directory listing.-rw-r--rw- 1 0 0 1195 Nov 03 00:39 passwd226 Directory send OK.ftp&gt; ll?Invalid commandftp&gt; get passwd # 下载，默认下载目录，是执行ftp命令的目录local: passwd remote: passwd227 Entering Passive Mode (192,168,1,12,127,183).150 Opening BINARY mode data connection for passwd (1195 bytes).226 Transfer complete.1195 bytes received in 4.3e-05 secs (27790.70 Kbytes/sec)ftp&gt; put 1.txt # 上传local: 1.txt remote: 1.txt227 Entering Passive Mode (192,168,1,12,131,28).553 Could not create file.ftp&gt; exit # 退出221 Goodbye.","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"59-SELinux","slug":"运维/Linux云计算教程/59-SELinux","date":"2021-09-29T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/09/29/运维/Linux云计算教程/59-SELinux/","link":"","permalink":"https://dbbruce.github.io/2021/09/29/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/59-SELinux/","excerpt":"","text":"SELinux概念 Security-Enhanced Linux一套强化Linux安全的扩展模块美国国家安全局主导开发 SELinux的运作机制集成到Linux内核( 2.6及以上)操作系统提供可定制的策略、管理工具 查看selinux状态：sestatus12345678910[root@centos07-12 ~]# sestatusSELinux status: enabledSELinuxfs mount: /sys/fs/selinux # 文件加载目录SELinux root directory: /etc/selinux # 工作目录Loaded policy name: targetedCurrent mode: enforcingMode from config file: enforcing # 配置文件模式Policy MLS status: enabledPolicy deny_unknown status: allowedMax kernel policy version: 31 配置文件:&#x2F;etc&#x2F;selinux&#x2F;config12345678910111213[root@centos07-12 ~]# vim /etc/selinux/config# This file controls the state of SELinux on the system.# SELINUX= can take one of these three values:# enforcing - SELinux security policy is enforced.# permissive - SELinux prints warnings instead of enforcing.# disabled - No SELinux policy is loaded.SELINUX=enforcing# SELINUXTYPE= can take one of three values:# targeted - Targeted processes are protected,# minimum - Modification of targeted policy. Only selected processes are protected.# mls - Multi Level Security protection.SELINUXTYPE=targeted 重置安全上下文，也就是开启selinux的步骤，只重启并不生效，需要创建autorelable文件 修改配置文件，开启selinux12vim /etc/selinux/configSELINUX=enforcing 根下创建.autorelable文件, 注意不要缺失了点，创建的是隐藏文件，重启后这个文件会自动消失； 1touch /.autorelable 重启 1reboot SELinux开关控制 非Disabled状态下才可可用 临时调整，setenforce 命令 设为 1，对应强制模式 设为 0，对应宽松模式1234[root@centos07-12 ~]# getenforceEnforcing[root@centos07-12 ~]# setenforce 0[root@centos07-12 ~]# setenforce 1 查看安全上下文(安全上下文，就是安全策略), 使用大写Z Security Context，安全上下文为文件&#x2F;目录&#x2F;设备标记访问控制属性 属性构成，比较关注的是访问类型用户:角色:访问类型:选项. 查看文件的安全上下文12[root@centos07-12 ~]# ls -Z /etc/hosts-rw-r--r--. root root system_u:object_r:net_conf_t:s0 /etc/hosts 查看目录的安全上下文12[root@centos07-12 ~]# ls -dZ /etc/drwxr-xr-x. root root system_u:object_r:etc_t:s0 /etc/ 查看进程的安全上下文123[root@centos07-12 ~]# ps -aux -Z |grep pythonsystem_u:system_r:tuned_t:s0 root 1031 0.0 0.5 574284 19492 ? Ssl 11月02 0:11 /usr/bin/python2 -Es /usr/sbin/tuned -l -Punconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 root 5123 0.0 0.0 112824 988 pts/0 R+ 07:29 0:00 grep --color=auto python 修改安全上下文，一般操作规律移动的文件，原有的上下文属性不变 1234567891011# 查看下原文件安全属性，net_conf_t[root@centos07-12 ~]# ll -Z /etc/hosts-rw-r--r--. root root system_u:object_r:net_conf_t:s0 /etc/hosts# 复制文件[root@centos07-12 ~]# cp /etc/hosts /root# 查看下复制后的文件属性，admin_home_t[root@centos07-12 ~]# ll -Z /root/hosts-rw-r--r--. root root unconfined_u:object_r:admin_home_t:s0 /root/hosts# 查看目录文件属性[root@centos07-12 ~]# ls -dZ /rootdr-xr-x---. root root system_u:object_r:admin_home_t:s0 /root 创建或复制的文件，自动继承目标位置的上下文 12345678# 查看下目录的访问类型， admin_home_t[root@centos07-12 ~]# ls -dZ /rootdr-xr-x---. root root system_u:object_r:admin_home_t:s0 /root# 新创建一个文件[root@centos07-12 ~]# vim 1.txt# 查看下新文件访问类型， admin_home_t，继承目录访问类型[root@centos07-12 ~]# ls -dZ 1.txt-rw-r--r--. root root unconfined_u:object_r:admin_home_t:s0 1.txt 修改文件的访问类型，使用chcon工具 t，指定访问类型 123456789101112# 原访问类型[root@centos07-12 ftp]# ll -Z 1.txt-rw-r--r--. root root unconfined_u:object_r:public_content_t:s0 1.txt# 修改访问类型[root@centos07-12 ftp]# ll -dZ /var/www/htmldrwxr-xr-x. root root system_u:object_r:httpd_sys_content_t:s0 /var/www/html[root@centos07-12 ftp]# chcon -t httpd_sys_content_t 1.txt# 新访问类型[root@centos07-12 ftp]# ll -Z 1.txt-rw-r--r--. root root unconfined_u:object_r:httpd_sys_content_t:s0 1.txt -R，递归修改 1[root@centos07-12 ftp]# chcon -R -t httpd_sys_content_t /temp/files/ 恢复访问类型， restorecon 恢复为所在位置的默认上下文属性 1234567[root@centos07-12 ftp]# ll -Z 1.txt-rw-r--r--. root root unconfined_u:object_r:httpd_sys_content_t:s0 1.txt[root@centos07-12 ftp]# restorecon 1.txt[root@centos07-12 ftp]# ll -Z 1.txt-rw-r--r--. root root unconfined_u:object_r:public_content_t:s0 1.txt -R，递归修改 1234[root@centos07-12 ftp]# restorecon -R /var/ftp/[root@centos07-12 ftp]# ll -Z 1.txt-rw-r--r--. root root unconfined_u:object_r:public_content_t:s0 1.txt 调整SELinux布尔值 使用 getsebool 查看a，可列出所有布尔值，on 开启， off 关闭1234567891011121314[root@centos07-12 ftp]# getsebool -a |grep ftpftpd_anon_write --&gt; offftpd_connect_all_unreserved --&gt; offftpd_connect_db --&gt; offftpd_full_access --&gt; offftpd_use_cifs --&gt; offftpd_use_fusefs --&gt; offftpd_use_nfs --&gt; offftpd_use_passive_mode --&gt; offhttpd_can_connect_ftp --&gt; offhttpd_enable_ftp_server --&gt; offtftp_anon_write --&gt; offtftp_home_dir --&gt; off 使用 setsebool 设置-P，永久更改，重启后仍然有效 123[root@centos07-12 ftp]# setsebool -P ftpd_anon_write on[root@centos07-12 ftp]# setsebool -P ftpd_anon_write off 查看SELinux日志排查 开启selinux，严格模式123[root@centos07-12 ftp]# setenforce 1[root@centos07-12 ftp]# getenforceEnforcing 启动httpd服务，修改为非80端口，无法启动，启动报错123[root@centos07-12 ftp]# vim /etc/httpd/conf/httpd.confListen 8070 12[root@centos07-12 ftp]# systemctl start httpdJob for httpd.service failed because the control process exited with error code. See &quot;systemctl status httpd.service&quot; and &quot;journalctl -xe&quot; for details. 查看SELinux日志，排查问题，需要用到setrubleshoot1234567[root@centos07-12 ftp]# rpm -aq|grep shoot[root@centos07-12 ftp]# yum list|grep shootsetroubleshoot.x86_64 3.2.30-8.el7 basesetroubleshoot-plugins.noarch 3.0.67-4.el7 basesetroubleshoot-server.x86_64 3.2.30-8.el7 base[root@centos07-12 ftp]# yum -y install setroubleshoot*[root@centos07-12 ftp]# reboot 12[root@centos07-12 ~]# systemctl restart httpd.serviceJob for httpd.service failed because the control process exited with error code. See &quot;systemctl status httpd.service&quot; and &quot;journalctl -xe&quot; for details. 查看日志，执行下面命令，sealert -l 0f7e3663-d739-4bd1-bbca-c08c652b48cd，查看如何修改 12[root@centos07-12 ~]# grep setroubleshoot /var/log/messages |tail -1Nov 6 13:59:42 centos07-12 setroubleshoot: SELinux is preventing /usr/sbin/httpd from name_bind access on the tcp_socket port 8070. For complete SELinux messages run: sealert -l 0f7e3663-d739-4bd1-bbca-c08c652b48cd 执行DO里的内容，注意里面的变量，PORT_TYPE 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859[root@centos07-12 ~]# sealert -l 0f7e3663-d739-4bd1-bbca-c08c652b48cdSELinux is preventing /usr/sbin/httpd from name_bind access on the tcp_socket port 8070.***** 插件 bind_ports (92.2 置信度) 建议 ******************************************如果你想允许 /usr/sbin/httpd绑定到网络端口 $PORT_数Then you need to modify the port type.Do ####注意这里..., PORT_TYPE# semanage port -a -t PORT_TYPE -p tcp 8070 其中 PORT_TYPE 是以下之一：http_cache_port_t, http_port_t, jboss_management_port_t, jboss_messaging_port_t, ntop_port_t, puppet_port_t。***** 插件 catchall_boolean (7.83 置信度) 建议 ************************************如果你想 allow nis to enabledThen 必须启用 &#x27;nis_enabled&#x27; 布尔值告知 SELinux 此情况。Dosetsebool -P nis_enabled 1***** 插件 catchall (1.41 置信度) 建议 ********************************************如果你相信 httpd应该允许_BASE_PATH name_bind 访问 port 8070 tcp_socket默认情况下。Then 应该将这个情况作为 bug 报告。可以生成本地策略模块以允许此访问。Do暂时允许此访问权限执行：# ausearch -c &#x27;httpd&#x27; --raw | audit2allow -M my-httpd# semodule -i my-httpd.pp更多信息:源环境 (Context) system_u:system_r:httpd_t:s0目标环境 system_u:object_r:unreserved_port_t:s0目标对象 port 8070 [ tcp_socket ]源 httpd源路径 /usr/sbin/httpd端口 8070主机 centos07-12源 RPM 软件包 httpd-2.4.6-95.el7.centos.x86_64目标 RPM 软件包策略 RPM selinux-policy-3.13.1-268.el7.noarchSelinux 已启用 True策略类型 targeted强制模式 Enforcing主机名 centos07-12平台 Linux centos07-12 3.10.0-1160.el7.x86_64 #1 SMP Mon Oct 19 16:18:59 UTC 2020 x86_64 x86_64警报计数 1第一个 2023-11-06 13:59:40 CST最后一个 2023-11-06 13:59:40 CST本地 ID 0f7e3663-d739-4bd1-bbca-c08c652b48cd原始核查信息type=AVC msg=audit(1699250380.724:118): avc: denied &#123; name_bind &#125; for pid=1619 comm=&quot;httpd&quot; src=8070 scontext=system_u:system_r:httpd_t:s0 tcontext=system_u:object_r:unreserved_port_t:s0 tclass=tcp_socket permissive=0type=SYSCALL msg=audit(1699250380.724:118): arch=x86_64 syscall=bind success=no exit=EACCES a0=3 a1=558d7078f180 a2=10 a3=7ffc7b98312c items=0 ppid=1 pid=1619 auid=4294967295 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=(none) ses=4294967295 comm=httpd exe=/usr/sbin/httpd subj=system_u:system_r:httpd_t:s0 key=(null)Hash: httpd,httpd_t,unreserved_port_t,tcp_socket,name_bind 总结就是，开启selinux后，想使用非标准接口，那就需要使用selinux命令，允许使用其他的端口；","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"58-制作本地yum源","slug":"运维/Linux云计算教程/58-制作本地yum源","date":"2021-09-28T03:00:52.000Z","updated":"2023-12-05T02:57:27.000Z","comments":true,"path":"2021/09/28/运维/Linux云计算教程/58-制作本地yum源/","link":"","permalink":"https://dbbruce.github.io/2021/09/28/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/58-%E5%88%B6%E4%BD%9C%E6%9C%AC%E5%9C%B0yum%E6%BA%90/","excerpt":"构建本地yum源构建本地yum源，然后通过yum 进行安装。 准备rpm包rpm包源建议使用对应的iso文件进行解压获得。 安装 createrepo 工具","text":"构建本地yum源构建本地yum源，然后通过yum 进行安装。 准备rpm包rpm包源建议使用对应的iso文件进行解压获得。 安装 createrepo 工具 123[root@hostlocal ~]# yum -y install createrepo[root@hostlocal ~]# createrepo /data/rpm-packet #将本地rpm打包[root@hostlocal ~]# createrepo --update /data/rpm-packet #更新本地rpm包 制作本地yum源对应的repo文件 123456[root@hostlocal ~]# vim /etc/yum.repos.d/local_base.repo[local_base]name=local_basebaseurl=file:///data/rpm-packet #此路径和放置rpm包路径对应gpgcheck=0enabled=1 123[root@hostlocal ~]# yum clean all [root@hostlocal ~]# yum makecache [root@hostlocal ~]# yum list |grep 你的包名 #此时就可以看到我们制作的rpm包名 查看全部yum源1234567891011[root@centos-02 ~]# yum repolist已加载插件：fastestmirror, langpacksLoading mirror speeds from cached hostfile * base: ftp.sjtu.edu.cn * extras: ftp.sjtu.edu.cn * updates: ftp.sjtu.edu.cn源标识 源名称 状态base/7/x86_64 CentOS-7 - Base 10,072extras/7/x86_64 CentOS-7 - Extras 518updates/7/x86_64 CentOS-7 - Updates 5,176repolist: 15,766","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"57-haproxy","slug":"运维/Linux云计算教程/57-haproxy","date":"2021-09-27T03:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2021/09/27/运维/Linux云计算教程/57-haproxy/","link":"","permalink":"https://dbbruce.github.io/2021/09/27/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/57-haproxy/","excerpt":"haproxy优点 支持session、cookie功能 可以通过url进行健康检查 效率、负载均衡速度，高于Nginx，低于LVS HAProxy支持TCP，可以对MySQL进行负载均衡 调度算法丰富缺点 正则弱于Nginx 日志依赖于syslogd","text":"haproxy优点 支持session、cookie功能 可以通过url进行健康检查 效率、负载均衡速度，高于Nginx，低于LVS HAProxy支持TCP，可以对MySQL进行负载均衡 调度算法丰富缺点 正则弱于Nginx 日志依赖于syslogd 1.安装HAProxy1yum -y install haproxy 2.实例 安装2台web服务器1234567[root@web1]# yum -y install httpd[root@web1]# echo &quot;192.168.1.22&quot; &gt;&gt; /var/www/html/index.html[root@web1]# systemctl start httpd.service[root@web2]# yum -y install httpd[root@web2]# echo &quot;192.168.1.32&quot; &gt;&gt; /var/www/html/index.html[root@web2]# systemctl start httpd.service 修改haproxy配置文件12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788[root@localhost ~]# cat /etc/haproxy/haproxy.cfg#---------------------------------------------------------------------# Example configuration for a possible web application. See the# full configuration options online.## http://haproxy.1wt.eu/download/1.4/doc/configuration.txt##---------------------------------------------------------------------#---------------------------------------------------------------------# Global settings#---------------------------------------------------------------------global # 全局设置 # to have these messages end up in /var/log/haproxy.log you will # need to: # # 1) configure syslog to accept network log events. This is done # by adding the &#x27;-r&#x27; option to the SYSLOGD_OPTIONS in # /etc/sysconfig/syslog # # 2) configure local2 events to go to the /var/log/haproxy.log # file. A line like the following can be added to # /etc/sysconfig/syslog # # local2.* /var/log/haproxy.log # log 127.0.0.1 local2 chroot /var/lib/haproxy pidfile /var/run/haproxy.pid # pid文件存放路径 maxconn 4000 #最大并发连接数, 全部集群加起来不能超过4000 user haproxy #启动haproxy使用的用户 group haproxy #启动haproxy使用的组 daemon 创建1个进程进入deamon模式运行 # turn on stats unix socket stats socket /var/lib/haproxy/stats#---------------------------------------------------------------------# common defaults that all the &#x27;listen&#x27; and &#x27;backend&#x27; sections will# use if not designated in their block#---------------------------------------------------------------------defaults # 默认设置 mode http #默认的模式mode &#123; tcp | http | health&#125; log global option httplog #日志类别http日志格式 option dontlognull #不记录健康检查的日志信愿 option http-server-close ##每次请求完些后主动关闭http通道 option forwardfor except 127.0.0.0/8 #后端服务器可以从Http Header中获取客户端IP option redispatch #serverid服务器挂掉后强制定向到其他健康服务器 retries 3 #3次连接失败就认为服务不可用，也可以通后面设置 timeout http-request 10s timeout queue 1m timeout connect 10s #如果backend没有指定，默认为 timeout client 1m #客户端连接超时 timeout server 1m #服务器连接超时 timeout http-keep-alive 10s timeout check 10s maxconn 3000 #最大并发连接数，每台不能超过3000########## 下面都删除，使用listen的方式，简单#---------------------------------------------------------------------# main frontend which proxys to the backends#---------------------------------------------------------------------frontend main *:5000 acl url_static path_beg -i /static /images /javascript /stylesheets acl url_static path_end -i .jpg .gif .png .css .js use_backend static if url_static default_backend app#---------------------------------------------------------------------# static backend for serving up images, stylesheets and such#---------------------------------------------------------------------backend static balance roundrobin server static 127.0.0.1:4331 check#---------------------------------------------------------------------# round robin balancing between the various backends#---------------------------------------------------------------------backend app balance roundrobin server app1 127.0.0.1:5001 check server app2 127.0.0.1:5002 check server app3 127.0.0.1:5003 check server app4 127.0.0.1:5004 check 新增下面1234listen servers *:8880 balance roundrobin # 轮询 server web1 192.168.1.22:80 check inter 2000 rise 2 fall 5 # inter 2000 每2秒做一次监控检测；fall 5：做5次检测，都失败down掉；rise 2：检测2次成功，up。 server web2 192.168.1.32:80 check inter 2000 rise 2 fall 5 重启服务1234567[root@localhost haproxy]# systemctl restart haproxy[root@localhost haproxy]# ps -axf|grep haproxy 2995 pts/1 S+ 0:00 \\_ grep --color=auto haproxy 2991 ? Ss 0:00 /usr/sbin/haproxy-systemd-wrapper -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid 2992 ? S 0:00 \\_ /usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid -Ds 2993 ? Ss 0:00 \\_ /usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid -Ds[root@localhost haproxy]# 测试，轮询1234[root@localhost haproxy]# curl &quot;http://192.168.1.22:8880&quot;192.168.1.22[root@localhost haproxy]# curl &quot;http://192.168.1.22:8880&quot;192.168.1.32 开启统计功能123456listen stats 0.0.0.0:1080 #监听端口 * == 0.0.0.0 stats refresh 30s #统计页面自动刷新时间 stats uri /stats #统计页面url stats realm Haproxy Manager #进入管理解面查看状态信息 stats auth admin:admin #统计页面用户名和密码设置# stats hide-version #隐藏统计页面上HAProxy的版本信息 http://192.168.1.22:1080/stats 备注:Queue队列数据的信息 (当前队列数量，最大值，队列限制数Session rate每秒会话率 (当前值，最大值，限制数量)Sessions总会话量(当前值，最大值，总量，Lbtot: total numberof times a server was selected选中一台服务器所用的总时间)Bytes (入站、出站流量)Denied (拒绝请求、拒绝回应)Errors (错误请求、错误连接、错误回应)Warnings (重新尝试警告retry、重新连接redispatches)Server(状态、最后检查的时间 (多久前执行的最后一次检查),权重、备份服务器数量、down机服务器数量、down机时长。","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"56-keepalived","slug":"运维/Linux云计算教程/56-keepalived","date":"2021-09-26T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/09/26/运维/Linux云计算教程/56-keepalived/","link":"","permalink":"https://dbbruce.github.io/2021/09/26/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/56-keepalived/","excerpt":"Keepalived概述调度器出现单点故障，如何解决 ?Keepalived实现了高可用集群Keepalived最初是为LVS设计的，专门监控各服务器节点的状态Keepalived后来加入了VRRP功能，防止单点故障","text":"Keepalived概述调度器出现单点故障，如何解决 ?Keepalived实现了高可用集群Keepalived最初是为LVS设计的，专门监控各服务器节点的状态Keepalived后来加入了VRRP功能，防止单点故障 1.keepalived 主要3个 功能1.自动配置LVS规则2.健康检查3.VRRP 虚拟路由 2.Keepalived 步骤二:安装Keepalived软件 注意: 两台Web服务器做相同的操作1201.[root@web1 ~]# yum install -y keepalived02.[root@web2 ~]# yum install -y keepalived 部署Keepalived服务 — VRRP 虚拟路由实例 修改web1服务器Keepalived配置文件12345678910111213141516171819202122232425262728[root@web1 ~]# vim /etc/keepalived/keepalived.conf# 邮箱的配置global defs &#123; notification email &#123; admin@tarena.com.cn //设置报警收件人邮箱 &#125; notification email from ka@localhost //设置发件人 smtp server 127.0.0.1 //定义邮件服务器 smtp connect timeout 30 router id web1 //设置路由ID号 (实验需要修改) &#125;vrrp_instance VI_1&#123; state MASTER //主服务器为MASTER (备服务器需要修改为BACKUP) interface ethO //定义网络接口，注意网卡，我的是虚拟网卡enp0s3 virtual_router id 51 //主备服务器VRID号必须一致 priority 100 //服务器优先级,优先级高优先获取VIP（备用服务器改小点） advert_int 1 authentication &#123; auth_type pass auth_pass 1111 //主备服务器密码必须一致 &#125; virtual_ipaddress&#123; //谁是主服务器谁获得该VIP (实验需要修改) 192.168.1.88 //配置一个需要ip &#125;&#125; 修改web2服务器Keepalived配置文件12345678[root@web1 ~]# vim /etc/keepalived/keepalived.conf router id web1 //设置路由ID号 (实验需要修改) state BACKUP //主服务器为MASTER (备服务器需要修改为BACKUP) priority 100 //服务器优先级,优先级高优先获取VIP（备用服务器改小点） virtual_ipaddress&#123; //谁是主服务器谁获得该VIP (实验需要修改) 192.168.1.88 &#125; 启动服务1201.[root@web1 ~]# systemctl start keepalived02.[root@web2 ~]# systemctl start reepalived 配置防火培和SELinux12345[root@web1 ~]# iptables -F[root@web1 ~]# setenforce 0[root@web2 ~]# iptables -F[root@web2 ~]# setenforce 0 测试12345678910111213141516171819202122[root@web1 ~]# ip addr show enp0s32: enp0s3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 08:00:27:ab:32:79 brd ff:ff:ff:ff:ff:ff inet 192.168.1.22/24 brd 192.168.1.255 scope global noprefixroute enp0s3 valid_lft forever preferred_lft forever inet 192.168.1.88/32 scope global enp0s3 # 现在master是活着的，这个就在mater上，如果挂了，web就会有这个。 valid_lft forever preferred_lft forever inet6 2409:8a00:6036:7000:1def:d244:9ac1:3f1a/64 scope global noprefixroute dynamic valid_lft 259142sec preferred_lft 172742sec inet6 fe80::885:90eb:3a46:25fa/64 scope link noprefixroute valid_lft forever preferred_lft forever# 现在BACKUP上没有虚拟ip的信息[root@web2 ~]# ip addr show enp0s32: enp0s3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 08:00:27:36:38:52 brd ff:ff:ff:ff:ff:ff inet 192.168.1.32/24 brd 192.168.1.255 scope global noprefixroute enp0s3 valid_lft forever preferred_lft forever inet6 2409:8a00:6036:7000:2f11:7058:2f3c:34b1/64 scope global noprefixroute dynamic valid_lft 259077sec preferred_lft 172677sec inet6 fe80::8a3f:32d1:23e4:f5d8/64 scope link noprefixroute valid_lft forever preferred_lft forever 找一台机器，ping 192.168.1.88虚拟IP123456789101112131415161718192021222324252627282930313233# 开始PING# ping 1.88 先走 1.32materdbbruce@dbburce githubblog % ping 192.168.1.88PING 192.168.1.88 (192.168.1.88): 56 data bytes92 bytes from 192.168.1.32: Redirect Host(New addr: 192.168.1.88)Vr HL TOS Len ID Flg off TTL Pro cks Src Dst 4 5 00 0054 d540 0 0000 3f 01 22b8 192.168.1.8 192.168.1.88Request timeout for icmp_seq 092 bytes from 192.168.1.32: Redirect Host(New addr: 192.168.1.88)Vr HL TOS Len ID Flg off TTL Pro cks Src Dst 4 5 00 0054 79d8 0 0000 3f 01 7e20 192.168.1.8 192.168.1.88Request timeout for icmp_seq 192 bytes from 192.168.1.32: Redirect Host(New addr: 192.168.1.88)Vr HL TOS Len ID Flg off TTL Pro cks Src Dst 4 5 00 0054 1640 0 0000 3f 01 e1b8 192.168.1.8 192.168.1.88# 停止web1（1.32）的keepalived服务# [root@localhost ~]# systemctl stop keepalivedRequest timeout for icmp_seq 4Request timeout for icmp_seq 5# backup启动# 流量走backup64 bytes from 192.168.1.88: icmp_seq=7 ttl=64 time=13.051 ms64 bytes from 192.168.1.88: icmp_seq=8 ttl=64 time=10.165 ms64 bytes from 192.168.1.88: icmp_seq=9 ttl=64 time=6.889 ms64 bytes from 192.168.1.88: icmp_seq=10 ttl=64 time=6.005 ms64 bytes from 192.168.1.88: icmp_seq=11 ttl=64 time=2.730 ms64 bytes from 192.168.1.88: icmp_seq=12 ttl=64 time=1.044 ms 2.Keepalived 健康检测部门123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051virtual_server 10.10.10.3 1358 &#123; //设置ipvsadm的VIP规则 delay_loop 3 lb_algo rr //设置LVS调度算法为WRR lb_kind NAT //设置LVS的模式为DR // persistence_timeout 50 # 注释掉 protocol TCP real_server 192.168.200.4 1358 &#123; //设置后端web服务器真实IP weight 1 //设置权重为1 HTTP_GET &#123; //对后台real_server做健康检育 url &#123; path /testurl/test.jsp // 健康检查的URL digest 640205b7b0fc66c1ea91c463fac6334d // 页面的md5值 &#125; url &#123; path /testurl2/test.jsp digest 640205b7b0fc66c1ea91c463fac6334d &#125; url &#123; path /testurl3/test.jsp digest 640205b7b0fc66c1ea91c463fac6334d &#125; connect_timeout 3 // 连接超时时间，3秒，连接3秒无反应 nb_get_retry 3 // 监控检测超时，重试3次 delay_before_retry 3 //每隔3秒做一次健康检查 &#125; &#125; real_server 192.168.200.5 1358 &#123; weight 1 HTTP_GET &#123; url &#123; path /testurl/test.jsp digest 640205b7b0fc66c1ea91c463fac6334d &#125; url &#123; path /testurl2/test.jsp digest 640205b7b0fc66c1ea91c463fac6334d &#125; url &#123; path /testurl3/test.jsp digest 640205b7b0fc66c1ea91c463fac6334d &#125; connect_timeout 3 nb_get_retry 3 delay_before_retry 3 &#125; &#125; &#125;","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"55-LVS集群","slug":"运维/Linux云计算教程/55-LVS集群","date":"2021-09-25T03:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2021/09/25/运维/Linux云计算教程/55-LVS集群/","link":"","permalink":"https://dbbruce.github.io/2021/09/25/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/55-LVS%E9%9B%86%E7%BE%A4/","excerpt":"集群集群分类 高性能计算集群HPC通过以集群开发的并行应用程序，解决复杂的科学问题 负载均衡( LB )集群客户端负载在计算机集群中尽可能平均分摊[ 高可用( HA)集群避免单点故障，当一个系统发生故障时，可以快速迁移 原理LVS原理和nginx不同lvs原理是路由器，转发数据包，性能高，只能做转发，功能单一；nginx原始代理，需要处理下数据包，功能多，比如健康检查；","text":"集群集群分类 高性能计算集群HPC通过以集群开发的并行应用程序，解决复杂的科学问题 负载均衡( LB )集群客户端负载在计算机集群中尽可能平均分摊[ 高可用( HA)集群避免单点故障，当一个系统发生故障时，可以快速迁移 原理LVS原理和nginx不同lvs原理是路由器，转发数据包，性能高，只能做转发，功能单一；nginx原始代理，需要处理下数据包，功能多，比如健康检查； 1.LVS项目介绍 Linux 虚拟服务器(LVS)是章文在国防科技大学就读博士期间创建的 LVS可以实现高可用的、可伸缩的Web、Mail.Cache和Media等网络服务 最终目标是利用Linux操作系统和LVS集群软件实现一个高可用、高性能、低成本的服务器应用集群优点负载能力强，工作在4层，对内存、CPU消耗低 配置性低，没有太多可配置性，减少人为错误 应用面广，几乎可以为所有应用提供负载均衡缺点 不支持正则表达式，不能实现动静分离 如果网站架构庞大，LVS-DR配置比较繁琐 2.LVS集群组成 前端 : 负载均衡层由一台或多台负载调度器构成 中间 : 服务器群组层- 由一组实际运行应用服务的服务器组成 底端 : 数据共享存储层提供共享存储空间的存储区域 3.LVS术语 Director Server : 调度服务器- 将负载分发到Real Server的服务器 Real Server: 真实服务器- 真正提供应用服务的服务器 VIP: 虚拟IP地址公布给用户访问的虚拟IP地址] RIP: 真实IP地址集群节点上使用的IP地址 DIP : 调度器连接节点服务器的IP地址 4.LVS工作模式VS&#x2F;NAT 小型网络，流量小通过网络地址转换实现的虚拟服务器- 大并发访问时，调度器的性能成为瓶颈 VS&#x2F;DR 大型网络，流量大直接使用路由技术实现虚拟服务器- 节点服务器需要配置VIP，注意MAC地址广播,服务器直接返回数据给客户； VS&#x2F;TUN 使用专线，比较少通过隧道方式实现虚拟服务器 5.如何查看流量 ifconfig enp0s3 查看enp0s3网卡流量 RX 接收数据量 TX 发送数据量 12345678910[root@master ~]# ifconfig enp0s3enp0s3: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500 inet 192.168.1.12 netmask 255.255.255.0 broadcast 192.168.1.255 inet6 2409:8a00:6036:7000:adcf:79c4:6eec:72f prefixlen 64 scopeid 0x0&lt;global&gt; inet6 fe80::f1a3:a1af:6006:3ae6 prefixlen 64 scopeid 0x20&lt;link&gt; ether 08:00:27:79:a3:b8 txqueuelen 1000 (Ethernet) RX packets 85345 bytes 96857833 (92.3 MiB) # 接收 92.3M RX errors 0 dropped 0 overruns 0 frame 0 TX packets 48872 bytes 5052032 (4.8 MiB) #发送 4.8M TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 6.负载均衡调度算法 LVS目前实现了10种调度算法 常用调度算法有4种轮询( Round Robin )加权轮询( Weighted Round Robin )最少连接( Least Connections )-加权最少连接( Weighted Least Connections ) 7.安装ipvs工具1[root@master ~]# yum -y install ipvsadm 常用命令 命令选项 含义 针对虚拟服务 ipvsadm -A 添加虚拟服务器 ipvsadm -E 修改虚拟服务器 ipwsadm -D 删除虚拟服务器 ipvsadm -C 清空所有 针对真实服务器 ipvsadm -a 添加真实服务器 ipvsadm -e 修改真实服务器 ipvsadm -d 删除真实服务器 ipvsadm -L 查看LVS 规则表 -s [rr| wrr |lc |wlc |sh] 指定集群算法 ipvsadm语法案例 命令 含义 ipvsadm -A -t|u 192.168.4.5:80 -s [算法] 添加虚拟服务器，协议为 tcp ( -t )或者 udp ( -u ) ipvsadm -E -t|u 192.168.4.5:80 -s [算法] 修改虚拟服务器 协议为tcp或udp ipvsadm -D -t|u 192.168.4.5:80 删除虚坝服务器 协议为tcp或udp ipvsadm -C 清空所有 ipvsadm -a -t|u 192.168.4.5:80 -r 192.168.2.100 [-g | i | m] [-w 权] 添加真实服务器 -g(DR模式) -i(隧道道式) -m (NAT 模式) ipvsadm -e -t|u 192.168.4.5:80 -r 192.168.2.100 [-g | i | m] [-w 权] 修改真实服务器 ipvsadm -d -t|u 192.168.4.5:80 -r 192.168.2.100 [-g | i | m] 删除真实服务器 ipvsadm -Ln 查看 LVS 规则表 创建一个虚拟服务器 1234-A 新建一个虚拟服务器-t tcp协议-s 算法 -wrr 加权轮询 1234567[root@master ~]# ipvsadm -A -t 192.168.4.5:80 -s wrr[root@master ~]# ipvsadm -Ln #n数字方式显示IP Virtual Server version 1.2.1 (size=4096)Prot LocalAddress:Port Scheduler Flags -&gt; RemoteAddress:Port Forward Weight ActiveConn InActConnTCP 192.168.4.5:80 wrr 为集群添加若 real server ，添加真实服务器， 默认DR模式-a 添加真实服务器-t 哪个虚拟服务器-r 真实服务器-w 权重，默认权重1 12345678[root@master ~]# ipvsadm -a -t 192.168.4.5:80 -r 192.168.1.12 -w 1[root@master ~]# ipvsadm -lnIP Virtual Server version 1.2.1 (size=4096)Prot LocalAddress:Port Scheduler Flags -&gt; RemoteAddress:Port Forward Weight ActiveConn InActConnTCP 192.168.4.5:80 wrr -&gt; 192.168.1.12:80 Route 1 0 0 永久保存所有规则 1ipvsadm -save -n &gt; /etc/sysconfig/ipvsadm 清空所有规则 1ipvsadm -C 确定路由转发功能是否开启 0关闭 1开启 12[root@localhost ~]# cat /proc/sys/net/ipv4/ip_forward0 12345# 临时有效[root@localhost ~]# echo 1 &gt; /proc/sys/net/ipv4/ip_forward# 修改配置文件，设置永久规则[root@localhost ~]# echo &quot;net.ipv4.ip_forward = 1&quot;&gt;&gt; /etc/sysctl.conf 创建 123456[root@localhost ~]# ipvsadm -A -t 192.168.1.32:80 -s wrr[root@localhost ~]# ipvsadm -lnIP Virtual Server version 1.2.1 (size=4096)Prot LocalAddress:Port Scheduler Flags -&gt; RemoteAddress:Port Forward Weight ActiveConn InActConnTCP 192.168.1.32:80 wrr 1234567[root@localhost ~]# ipvsadm -a -t 192.168.1.32:80 -r 192.168.1.22 -w 1 -m[root@localhost ~]# ipvsadm -lnIP Virtual Server version 1.2.1 (size=4096)Prot LocalAddress:Port Scheduler Flags -&gt; RemoteAddress:Port Forward Weight ActiveConn InActConnTCP 192.168.1.32:80 wrr -&gt; 192.168.1.22:80 Masq 1 0 0 1[root@localhost ~]# ipvsadm-save -n &gt; /etc/sysconfig/ipvsadm","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"54-NTP服务器","slug":"运维/Linux云计算教程/54-NTP服务器","date":"2021-09-24T03:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2021/09/24/运维/Linux云计算教程/54-NTP服务器/","link":"","permalink":"https://dbbruce.github.io/2021/09/24/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/54-NTP%E6%9C%8D%E5%8A%A1%E5%99%A8/","excerpt":"NTPNetwork Time Protocol (网络时间协议)采用的是分层设计，最多不能超过15层","text":"NTPNetwork Time Protocol (网络时间协议)采用的是分层设计，最多不能超过15层 1.服务器 安装1yum - y install chrony 配置文件server O.centos.pool.ntp.org iburst &#x2F;&#x2F;server用户客户端指 iburst ，尽快同步时间allow 192.168.4.0&#x2F;24 &#x2F;&#x2F;允许那个IP或网络访问 可以写多个 allow xxxxx;allow xxxxxx;allow xxxxx; #deny 192.168.4.1 &#x2F;&#x2F;拒绝那个IP或网络访问local stratum 10 &#x2F;&#x2F;设置NTP服务器的层数量 ，不能超过15 1234server O.centos.pool.ntp.org iburstallow 192.168.1.0/24 # 开启这里就是NTP服务器了#deny 192.168.4.1local stratum 10 # 开启这里就是NTP服务器了 启动NTP服务12systemctl restart chronydsystemctl enable chronyd 2.客户端 安装软件包1yum -y install chrony 修改配置文件12345vim /etc/chrony.confserver 192.168.4.5 iburst//设置与哪台服务器同步数据//iburst参数设置重启服务后尽快同步时间Top 将客户端时间修改为错误的时间12date s &quot;hour:minute //调整时间 (小时 : 分钟)date //查看修改后的时间 重启chrony与服务器同步时间1systemctl restart chrony","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"53-VPN","slug":"运维/Linux云计算教程/53-VPN(待续)","date":"2021-09-23T03:00:52.000Z","updated":"2023-12-05T02:57:27.000Z","comments":true,"path":"2021/09/23/运维/Linux云计算教程/53-VPN(待续)/","link":"","permalink":"https://dbbruce.github.io/2021/09/23/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/53-VPN(%E5%BE%85%E7%BB%AD)/","excerpt":"VPNVirtual Private Network ( 虚拟专用网络)在公用网络上建立专用私有网络，进行加密通讯多用于为集团公司的各地子公司建立连接连接完成后，各个地区的子公司可以像局域网一样通讯在企业网络中有广泛应用偶尔可以用于翻墙目前主流的VPN技术( GRE，PPTP，L2TP+IPSec，SSL )gre &gt; pptp &gt; l2tp+ipsec (安装, 易 -&gt; 难)l2tcp+ipsec &gt; pptp &gt; gre (安全, 高 -&gt; 底)","text":"VPNVirtual Private Network ( 虚拟专用网络)在公用网络上建立专用私有网络，进行加密通讯多用于为集团公司的各地子公司建立连接连接完成后，各个地区的子公司可以像局域网一样通讯在企业网络中有广泛应用偶尔可以用于翻墙目前主流的VPN技术( GRE，PPTP，L2TP+IPSec，SSL )gre &gt; pptp &gt; l2tp+ipsec (安装, 易 -&gt; 难)l2tcp+ipsec &gt; pptp &gt; gre (安全, 高 -&gt; 底)","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"52-RPM打包","slug":"运维/Linux云计算教程/52-rpm打包","date":"2021-09-22T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/09/22/运维/Linux云计算教程/52-rpm打包/","link":"","permalink":"https://dbbruce.github.io/2021/09/22/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/52-rpm%E6%89%93%E5%8C%85/","excerpt":"RPM打包原理：先把源码安装一遍，对安装好的结果打包，包的扩展名为rpm，rpm就是一个压缩包 1.将源码包转为RPM包 安装rpm-build软件包1[root@master ~]# yum -y install rpm-build","text":"RPM打包原理：先把源码安装一遍，对安装好的结果打包，包的扩展名为rpm，rpm就是一个压缩包 1.将源码包转为RPM包 安装rpm-build软件包1[root@master ~]# yum -y install rpm-build 生成rpmbuild目录结构123456789101112131415[root@master ~]# rpmbuild -ba nginx.spec //会报错错误：stat /root/nginx.spec 失败：没有那个文件或目录[root@master ~]# lsanaconda-ks.cfg rpmbuild //自动生成目录[root@master ~]# ls -al rpmbuild/总用量 0drwxr-xr-x. 8 root root 89 9月 8 19:05 .dr-xr-x---. 5 root root 212 9月 8 19:05 ..drwxr-xr-x. 2 root root 6 9月 8 19:05 BUILDdrwxr-xr-x. 2 root root 6 9月 8 19:05 BUILDROOTdrwxr-xr-x. 2 root root 6 9月 8 19:05 RPMS # 放生成的RPM包的地方drwxr-xr-x. 2 root root 6 9月 8 19:05 SOURCES # 源码包放的地方drwxr-xr-x. 2 root root 6 9月 8 19:05 SPECS # 写配置文件drwxr-xr-x. 2 root root 6 9月 8 19:05 SRPMS[root@master ~]# 将源码软件复制到SOURCES目录1[root@master ~]# cp nginx-1.22.1.tar.gz rpmbuild/SOURCES/ 创建并修改SPEC配置文件新建一个扩展名为xxx.spec的文件123456789101112131415161718192021222324252627282930[root@master SPECS]# cd /root/rpmbuild/SPECS# Name，Version，Source0 这3个一定不能错[root@master SPECS]# vim nginx.spec#描述信息Name:nginx #软件名称，软件名不能乱写，拷贝的一样Version:1.22.1 #版本，不能乱写，拷贝文件Release: 1%&#123;?dist&#125; #rpm版本Summary:this is nginx # 说明#Group: #组包 yum grouplist ，把多个软件放在一个组里，组包 yum groupinstall 组包名License:GPLURL:Source0:nginx-1.22.1.tar.gz #拷贝文件的一样#BuildRequires: #依赖包#Requires:%description# 生成信息%post # 打包后执行的命令useradd -s /sbin/nologin nginx%prep%setup -q # 解压，cd 目录%build # configure./configure --prefix=/usr/local/nginx --user=nginx --group=nginx --with-http_ssl_modulemake %&#123;?_smp_mflags&#125;%installmake install DESTDIR=%&#123;buildroot&#125;%files%doc/usr/local/nginx/* # 将哪个目录打包成RPM%changelog 生成PRM1[root@master SPECS]# rpmbuild -ba /root/rpmbuild/SPECS/nginx.spec 123456[root@master x86_64]# pwd/root/rpmbuild/RPMS/x86_64[root@master x86_64]# ll总用量 1324-rw-r--r--. 1 root root 319352 9月 8 20:10 nginx-1.22.1-1.el7.x86_64.rpm-rw-r--r--. 1 root root 1033648 9月 8 20:10 nginx-debuginfo-1.22.1-1.el7.x86_64.rpm RPM包安装1234[root@master x86_64]# rpm -ivh nginx-1.22.1-1.el7.x86_64.rpm准备中... ################################# [100%]正在升级/安装... 1:nginx-1.22.1-1.el7 ################################# [100%] 1234567891011121314[root@master x86_64]# id nginxuid=1001(nginx) gid=1001(nginx) 组=1001(nginx)[root@master x86_64]# cd /usr/local/nginx/[root@master nginx]# ll总用量 4drwxr-xr-x. 2 root root 4096 9月 8 20:12 confdrwxr-xr-x. 2 root root 40 9月 8 20:12 htmldrwxr-xr-x. 2 root root 6 9月 8 20:10 logsdrwxr-xr-x. 2 root root 19 9月 8 20:12 sbin[root@master nginx]# sbin/nginx[root@master nginx]# ps axf|grep nginx 2699 pts/0 S+ 0:00 \\_ grep --color=auto nginx 2695 ? Ss 0:00 nginx: master process sbin/nginx 2696 ? S 0:00 \\_ nginx: worker process","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"51-Linux下实现免密码登录","slug":"运维/Linux云计算教程/51-Linux下实现免密码登录","date":"2021-09-21T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/09/21/运维/Linux云计算教程/51-Linux下实现免密码登录/","link":"","permalink":"https://dbbruce.github.io/2021/09/21/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/51-Linux%E4%B8%8B%E5%AE%9E%E7%8E%B0%E5%85%8D%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95/","excerpt":"Linux下实现免密码登录第一步：检查本机是否已经存在密钥对为了实现免密码登录，我们需要在本机上生成一对密钥，如果你已经有了密钥对的话，可以跳过这一步。如果没有，可以通过以下命令进行检查： 1$ ls ~/.ssh/id_* 如果返回以下错误信息，说明你还没有生成密钥对： 1ls: /home/user/.ssh/id_*: No such file or directory","text":"Linux下实现免密码登录第一步：检查本机是否已经存在密钥对为了实现免密码登录，我们需要在本机上生成一对密钥，如果你已经有了密钥对的话，可以跳过这一步。如果没有，可以通过以下命令进行检查： 1$ ls ~/.ssh/id_* 如果返回以下错误信息，说明你还没有生成密钥对： 1ls: /home/user/.ssh/id_*: No such file or directory 生成密钥对其中，-t 表示指定密钥类型，这里我们使用 rsa 类型；-C 表示注释，可将其替换成自己的邮箱。 1$ ssh-keygen -t rsa -C &quot;your_email@example.com&quot; 在执行命令后，将出现以下提示： 12Generating public/private rsa key pair.Enter file in which to save the key (/home/user/.ssh/id_rsa) 按下回车，即可使用默认路径保存密钥文件。 在输入完路径后，还会提示你设置密码，如下所示： 12Enter passphrase (empty for no passphrase):Enter same passphrase again: 这里的密码不是你的账户密码，而是用于加密私钥的密码。如果只是为了方便，可以不设置密码，直接回车即可。 第三步：将公钥复制到目标主机上我们需要将生成的公钥文件复制到目标主机。可以使用以下命令： 1$ ssh-copy-id user@remotehost 其中，user 是目标主机上的用户名，remotehost 是目标主机的 IP 或域名。执行命令后，系统会要求你输入目标主机的密码，这是因为你还没有进行免密码登录，需要输入密码进行验证。一旦验证成功，公钥就会被复制并写入目标主机当前用户的 authorized_keys 文件中。如果你需要复制多个公钥，可以将多个公钥文件的内容都写入 authorized_keys 文件中，每个公钥文件的内容之间用换行符进行分隔。","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"50-vim常用快捷键","slug":"运维/Linux云计算教程/50-vim常用快捷键","date":"2021-09-20T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/09/20/运维/Linux云计算教程/50-vim常用快捷键/","link":"","permalink":"https://dbbruce.github.io/2021/09/20/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/50-vim%E5%B8%B8%E7%94%A8%E5%BF%AB%E6%8D%B7%E9%94%AE/","excerpt":"vim常用快捷键vim编辑器的三种模式转换插入模式&lt;&#x3D;&gt;命令模式&lt;&#x3D;&gt;末行模式 123插入模式 =&gt; 命令模式 按Esc键命令模式 =&gt; 末行模式 按冒号键末行模式 =&gt; 命令模式 输入末行命令之后回车键","text":"vim常用快捷键vim编辑器的三种模式转换插入模式&lt;&#x3D;&gt;命令模式&lt;&#x3D;&gt;末行模式 123插入模式 =&gt; 命令模式 按Esc键命令模式 =&gt; 末行模式 按冒号键末行模式 =&gt; 命令模式 输入末行命令之后回车键 各种插入模式在光标后插入123A 在当前行末尾插入o 在当前行的下一行插入O 在当前行的上一行插入 简单移动光标数字零，到行首1234^ 到本行第一个不是blank的字符（blank字符有空格、tab、换行、回车）$ 到本行行尾g_ 到本行最后一个不是blank的字符/pattern 搜索 pattern 字符串，如果多个匹配，按n切换到下一个 复制、粘贴当前位置后粘贴12345P 当前位置前粘贴yy 复制当前行nyy n不是字母，而是数字，相当于要复制多少行，相样也有ndd，删除多少行yw 将光标处开始到字结尾处的所有字符复制nyw n不是字母，而是数字，将光标处开始的n个字复制 删除对应光标左、下、上、右移动123456x 一次删除当前光标处的一个字符n x 一次删除当前光标处开始的n个字符X 一次删除当前光标前面的一个字符n X 一次删除当前光标前面的n个字符dd 一次删除一行字符n dd 一次删除n行字符 撤销和恢复撤销最近一次的操作123456ctrl+r 恢复最近一次的撤销操作页数操作ctrl+b 往回移动一页ctrl+f 向前移动一页ctrl+u 往回移动半页ctrl+d 向前移动半页 光标快速移动到第n行，注意G是大写，也可以在 command 模式输入 :n ，到第n行1234567gg 到第一行，相当于1GG 到最后一行w/W 到下一单词的开头，大小写均可，但w认为是单词是字母数字下划线组成，其它字符均为分隔符；W只认为blank字符（空格，tab）为分隔符e/E 到下一单词的结尾，说明同上% 匹配括号移动，包话 （，&#123;，[* 和 # 匹配光标当前所在的单词，移动光标到下一个匹配单词是 * , 上一个是 #r/R 替换一个字符/全局替换模式 在末行模式下的高效按键保存退出12345678:q! 放弃最后一次保存之后做的修改并退出:q （最后一次保存之后，没有对文档进行任何修改）退出:z 将缓冲区内容写入文件，不退出:x 保存退出:set number 或者 :set nu 显示行号:set nonumber 或者 :set nonu 不显示行号:n 表示将光标移动到第n行的行首 :！ 不退出vi，执行shell命令 替换命令 【这里详细讲解一下】 格式 ： : [范围] s /string1/string2 /[c e g i] 【注】如果省略范围，默认从当前光标处开始 选项： c 每次替换之前，询问师范替换？ y确认 n拒绝 a确认全部 q返回 默认全部替换 g 所有符合的部分，都做替换 没有g，只对每行第一次出现的符合的部分进行替换 e:不显示errors i:不区分大小写 示例： :1,7 s /deep/abcd/g 【注】表示从1行到7行中所有deep替换成abcd","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"49-Linux中的虚拟设备/dev/null、/dev/zero、/dev/random和/dev/urandom[转载]","slug":"运维/Linux云计算教程/49-Linux中的虚拟设备[转载]","date":"2021-09-19T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/09/19/运维/Linux云计算教程/49-Linux中的虚拟设备[转载]/","link":"","permalink":"https://dbbruce.github.io/2021/09/19/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/49-Linux%E4%B8%AD%E7%9A%84%E8%99%9A%E6%8B%9F%E8%AE%BE%E5%A4%87[%E8%BD%AC%E8%BD%BD]/","excerpt":"Unix&#x2F;Linux将每一个设备都当成一个文件，放在&#x2F;dev目录下。这些文件有的对应着一个真实存在的物理设备；有的则代表一个虚拟设备，提供一些特定的功能。下面介绍三个常用的虚拟设备： &#x2F;dev&#x2F;null“空”设备，也有人称它为黑洞。任何输入到这个“设备”的数据都将被直接丢弃。最常用的用法是把不需要的输出重定向到这个文件。例如： $ run.sh 1&gt;&#x2F;dev&#x2F;null 2&gt;&amp;1 #将标准输出和错误输出重定向到&#x2F;dev&#x2F;null，运行这个脚本不会输出任何信息到终端","text":"Unix&#x2F;Linux将每一个设备都当成一个文件，放在&#x2F;dev目录下。这些文件有的对应着一个真实存在的物理设备；有的则代表一个虚拟设备，提供一些特定的功能。下面介绍三个常用的虚拟设备： &#x2F;dev&#x2F;null“空”设备，也有人称它为黑洞。任何输入到这个“设备”的数据都将被直接丢弃。最常用的用法是把不需要的输出重定向到这个文件。例如： $ run.sh 1&gt;&#x2F;dev&#x2F;null 2&gt;&amp;1 #将标准输出和错误输出重定向到&#x2F;dev&#x2F;null，运行这个脚本不会输出任何信息到终端 &#x2F;dev&#x2F;zero“零”设备，可以无限的提供空字符（0x00，ASCII代码NUL）。常用来生成一个特定大小的文件。例如： $ dd if&#x3D;&#x2F;dev&#x2F;zero of&#x3D;.&#x2F;output.txt bs&#x3D;1024 count&#x3D;1 #产生一个1k大小的文件output.txt &#x2F;dev&#x2F;random和&#x2F;dev&#x2F;urandom随机数设备，提供不间断的随机字节流。二者的区别是&#x2F;dev&#x2F;random产生随机数据依赖系统中断，当系统中断不足时，&#x2F;dev&#x2F;random设备会“挂起”，因而产生数据速度较慢，但随机性好；&#x2F;dev&#x2F;urandom不依赖系统中断，数据产生速度快，但随机性较低。读取这两个文件的输出如下： $ cat &#x2F;dev&#x2F;random | od -x0000000 34fa b5ea 0901 b7e0 27a9 623a 0879 d9eb0000020 d212 4f6f d928 6637 84a4 8ec5 fc2c 4896$ cat &#x2F;dev&#x2F;urandom | od -x | head -n 50000000 8048 4dbd 07c9 2119 02d0 221b 89ba af7f0000020 3d6f 6a72 3752 4a09 5a47 a3fb dc98 ed9f0000040 f3e8 e82d 6748 2e14 de80 7554 bb52 f56c0000060 de73 0e51 262f 5a63 af69 b45c ee49 c1bf0000100 76b4 6db5 4e5b e438 70fb d207 a28c 04a8 在上面的例子中，读取&#x2F;dev&#x2F;random文件在输出了两行之后就停住了（系统中断不足），而&#x2F;dev&#x2F;urandom产生数据速度很快，没有任何停顿。下面这个例子，利用&#x2F;dev&#x2F;urandom设备产生一个128位的随机字符串： $ str&#x3D;$(cat &#x2F;dev&#x2F;urandom | od -x | tr -d ‘ ‘ | head -n 1)$ echo ${str:7}17539187d2e8b8e26d49bec90465c14d","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"19-nginx参数说明","slug":"运维/nginx/19-nginx参数说明","date":"2021-09-19T03:00:52.000Z","updated":"2024-11-04T02:59:01.000Z","comments":true,"path":"2021/09/19/运维/nginx/19-nginx参数说明/","link":"","permalink":"https://dbbruce.github.io/2021/09/19/%E8%BF%90%E7%BB%B4/nginx/19-nginx%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E/","excerpt":"对全局配置文件（&#x2F;etc&#x2F;nginx&#x2F;nginx.conf）中的关键可设置参数解析如下","text":"对全局配置文件（&#x2F;etc&#x2F;nginx&#x2F;nginx.conf）中的关键可设置参数解析如下 123456789101112131415161718192021222324user www-data; ##定义运行Nginx的用户worker_processes 4; ##Nginx进程数，应设置与系统CPU数量相等的数值worker_rlimit_nofile 65535; ##每个Nginx进程可以打开的最大文件数events &#123; worker_connections 768; ##每个Nginx进程允许的最大客户端连接数 #在Nginx接到一个新连接通知后调用accept()来接受尽量多的连接 multi_accept off;&#125;http &#123; # Basic Settings sendfile on; ##是否允许文件上传 client_header_buffer_size 32k; ##上传文件大小限制 tcp_nopush on; ##防止网络阻塞 tcp_nodelay on; ##防止网络阻塞 keepalive_timeout 65; ##允许的客户端长连接最大秒数 ##Nginx散列表大小。本值越大，占用的内存空间越大，但路由速度越快 types_hash_max_size 2048; access_log /var/log/nginx/access.log; ##访问日志文件路径名 error_log /var/log/nginx/error.log; ##错误日志文件路径名 ## 如下两条用include命令加载站点配置文件 include /etc/nginx/conf.d/＊.conf; include /etc/nginx/sites-enabled/＊;&#125;","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"nginx","slug":"运维/nginx","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/nginx/"}],"tags":[]},{"title":"48-awk","slug":"运维/Linux云计算教程/48-awk","date":"2021-09-18T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/09/18/运维/Linux云计算教程/48-awk/","link":"","permalink":"https://dbbruce.github.io/2021/09/18/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/48-awk/","excerpt":"1.awkawk编程语言&#x2F;数据处理引擎基于模式匹配检查输入文本，逐行处理并输出通常用在Shell脚本中，获取指定的数据单独用时，可对文本数据做统计","text":"1.awkawk编程语言&#x2F;数据处理引擎基于模式匹配检查输入文本，逐行处理并输出通常用在Shell脚本中，获取指定的数据单独用时，可对文本数据做统计 2.主要用法 格式1: 前置命令 | awk [选项] ‘[条件]{指令}’ 格式2 : awk [选项] ‘[条件]{指令}’ 文件…. # 指令：多条语句可以分号分隔； # print 是最常用的指令 内置变量： NF 列数 NR 行数 $n $1 第一行12345678910awk &#x27;&#123;print&#125;&#x27; txt ///输出文档所有内容awk &#x27;&#123;print $1&#125;&#x27; txt //输出文档每行第1列,默认用空格做分隔符awk &#x27;&#123;print $1 $3&#125;&#x27; txt //输出文档每行第1列,第3列awk &#x27;&#123;print $2&#125;&#x27; txt2 //输出第2列,无显示,没有空格做默认分隔符,当前文档一整行算一列awk -F: &#x27;&#123;print $5&#125;&#x27; txt2 //使用:做分隔符,显示第5列awk -F[:/] &#x27;&#123;print $9&#125;&#x27; txt /使用多个分隔符后显示第9列awk - F[:/]&#x27;[print NF ]&#x27; txt2 // 使用 ：或者 /作为分隔符，显示列数awk - F[:/]&#x27;[print NR ]&#x27; txt2 // 使用 ：或者 /作为分隔符，显示行数awk -F[:/] &#x27;&#123;print NR,NF&#125;&#x27; txt 加逗号有空格效果awk -F[:/] &#x27;&#123;print NR &quot; &quot;NF]&#x27; txt //或把空格引起来 12awk中使用正则awk &#x27;/Failed/(print $11&#125;&#x27; /var/log/secure #根据/var/log/secure日志文件，过滤远程连接密码失败的IP地址 3.awk处理的时机awk会逐行处理文本，支持在处理第一行之前做一些准备工作，以及在处理完最后一行之后做一些总结性质的工作。在命令格式上分别体现如下 awk [选项] ‘[条件]{指令}’ 文件 awk [选项] ‘BEGIN{指令} {指令} END{指令}’ 文件 BEGIN{}行前处理，读取文件内容前执行，指令执行1次 {}逐行处理，读取文件过程中执行，指令执行n次 {END} 行后处理，读取文件结束后执行，指令执行1次12awk -F: &#x27;BEGIN&#123;print &quot;User\\tUID\\tHome&quot;&#125;&#123;print$1&quot;\\t&quot;$3&quot;\\t&quot;$6&#125;END&#123;print &quot;总计&quot;,NR，&quot;行&#125;&#x27; txt3//按需求的格式输出文档内容，有表头,有结尾统计 4.awk处理条件 正则 ~包含 !~不包含12awk -F: &#x27;$1~/root/&#x27; /etc/passwd //输出第1列包含root的行awk -F: &#x27;$7!~/nologin$/&#123;print&#125; $1,$7&#x27; /etc/passwd //输出第7列不包含nologin的行的第1列第7列 使用数值&#x2F;字符串比较设置条件 &#x3D;&#x3D;(等于) !(不等于) &gt; (大于) &gt;&#x3D;(大于等于) &gt; &lt;(小于) &#x3D; 等于123456789awk &#x27;NR==5(print&#125;&#x27; txt3 //输出第5行awk &#x27;NR!=5&#x27; txt3 //输出的结果不要第5行/awk -F: &#x27;$3==0&#x27; txt3 //输出第三列等于0的行awk -F: &#x27;$1==root&#x27; txt3 //输出第1列等于root的行,没加引号无效awk -F: &#x27;$1==&quot;root&quot;&#x27; txt3 //要求同上,加引号可以正常输出awk -F: &#x27;$1!=&quot;root&quot;&#x27; txt3 //输出第一列不是root的行awk -F: &#x27;$3&gt;1000&#x27; /etc/passwd //输出第3列大于1000的行awk -F: &#x27;$3&gt;=1000&#x27; /etc/passwd //大于等于awk -F: &#x27;$3&lt;=10&#x27; /etc/passwd //小于等于 使用逻辑符号 &amp;&amp; ||1234awk -F: &#x27;$3&lt;=10 &amp;&amp; $3&gt;1000&#x27; /etc/passwd //找小于等于10并且大于1000的,逻辑错误,找不到awk -F: &#x27;$3&lt;=10 || 3&gt;1000&#x27; /etc/passwd //改成或者可以找到awk -F: &#x27;$3&gt;10 &amp;&amp; $3&lt;1000&#x27; /etc/passwd //找大于10并且小于1000的awk -F: &#x27;$3&lt;10 &amp;&amp; $3&gt;1000&#x27; /etc/passwd //逻辑错误找不到 5.awk流程控制if分支结构 1awk -F: &#x27;&#123;if($3&lt;=1000)&#123;i++1&#125;&#125;END&#123;print i&#125;&#x27; /etc/passwd 分支 1awk -F: &#x27;&#123;if($3&lt;=1000)&#123;i++&#125;else&#123;j++&#125;&#125;END&#123;print i,j&#125;&#x27; /etc/passwd 6.awk数组 数组的语法格式数组是一个可以存储多个值的变量，具体使用的格式如下定义数组的格式:数组名[下标]&#x3D;元素值调用数组的格式:数组名[下标]遍历数组的用法: for(变量 in 数组名){print 数组名[变量]} 7.编写监控脚本,如果查到有人访问本机密码输错三次则发邮件通知管理员12345678#!/bin/bashx=`awk&#x27;/Failed/&#123;ip[$11]++&#125;END&#123;for(i in ip)&#123;print i&quot;, &quot;ip[i]&#125;&#125;&#x27; /var/log/secure` for i in $x do p=$&#123;i%,*&#125; //变量p内容是ip S=$&#123;i#*,&#125; / /变量s内容是输错密码的次数 [ $s -gt 3 ] &amp;&amp; echo &quot;报警! $p访问本机失败了$s次,赶紧处理&quot; | mail -s test rootdone","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"18-nginx在线升级","slug":"运维/nginx/18-nginx在线升级","date":"2021-09-18T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/09/18/运维/nginx/18-nginx在线升级/","link":"","permalink":"https://dbbruce.github.io/2021/09/18/%E8%BF%90%E7%BB%B4/nginx/18-nginx%E5%9C%A8%E7%BA%BF%E5%8D%87%E7%BA%A7/","excerpt":"1.查看nginx版本 [root@centos07-12 nginx]# nginx -V nginx version: nginx&#x2F;1.20.1built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC)built with OpenSSL 1.1.1k FIPS 25 Mar 2021TLS SNI support enabledconfigure arguments: –prefix&#x3D;&#x2F;usr&#x2F;share&#x2F;nginx –sbin-path&#x3D;&#x2F;usr&#x2F;sbin&#x2F;nginx –modules-path&#x3D;&#x2F;usr&#x2F;lib64&#x2F;nginx&#x2F;modules –conf-path&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf –error-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log –http-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log –http-client-body-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;client_body –http-proxy-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;proxy –http-fastcgi-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;fastcgi –http-uwsgi-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;uwsgi –http-scgi-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;scgi –pid-path&#x3D;&#x2F;run&#x2F;nginx.pid –lock-path&#x3D;&#x2F;run&#x2F;lock&#x2F;subsys&#x2F;nginx –user&#x3D;nginx –group&#x3D;nginx –with-compat –with-debug –with-file-aio –with-google_perftools_module –with-http_addition_module –with-http_auth_request_module –with-http_dav_module –with-http_degradation_module –with-http_flv_module –with-http_gunzip_module –with-http_gzip_static_module –with-http_image_filter_module&#x3D;dynamic –with-http_mp4_module –with-http_perl_module&#x3D;dynamic –with-http_random_index_module –with-http_realip_module –with-http_secure_link_module –with-http_slice_module –with-http_ssl_module –with-http_stub_status_module –with-http_sub_module –with-http_v2_module –with-http_xslt_module&#x3D;dynamic –with-mail&#x3D;dynamic –with-mail_ssl_module –with-pcre –with-pcre-jit –with-stream&#x3D;dynamic –with-stream_ssl_module –with-stream_ssl_preread_module –with-threads –with-cc-opt&#x3D;’-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE&#x3D;2 -fexceptions -fstack-protector-strong –param&#x3D;ssp-buffer-size&#x3D;4 -grecord-gcc-switches -specs&#x3D;&#x2F;usr&#x2F;lib&#x2F;rpm&#x2F;redhat&#x2F;redhat-hardened-cc1 -m64 -mtune&#x3D;generic’ –with-ld-opt&#x3D;’-Wl,-z,relro -specs&#x3D;&#x2F;usr&#x2F;lib&#x2F;rpm&#x2F;redhat&#x2F;redhat-hardened-ld -Wl,-E’","text":"1.查看nginx版本 [root@centos07-12 nginx]# nginx -V nginx version: nginx&#x2F;1.20.1built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC)built with OpenSSL 1.1.1k FIPS 25 Mar 2021TLS SNI support enabledconfigure arguments: –prefix&#x3D;&#x2F;usr&#x2F;share&#x2F;nginx –sbin-path&#x3D;&#x2F;usr&#x2F;sbin&#x2F;nginx –modules-path&#x3D;&#x2F;usr&#x2F;lib64&#x2F;nginx&#x2F;modules –conf-path&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf –error-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log –http-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log –http-client-body-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;client_body –http-proxy-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;proxy –http-fastcgi-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;fastcgi –http-uwsgi-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;uwsgi –http-scgi-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;scgi –pid-path&#x3D;&#x2F;run&#x2F;nginx.pid –lock-path&#x3D;&#x2F;run&#x2F;lock&#x2F;subsys&#x2F;nginx –user&#x3D;nginx –group&#x3D;nginx –with-compat –with-debug –with-file-aio –with-google_perftools_module –with-http_addition_module –with-http_auth_request_module –with-http_dav_module –with-http_degradation_module –with-http_flv_module –with-http_gunzip_module –with-http_gzip_static_module –with-http_image_filter_module&#x3D;dynamic –with-http_mp4_module –with-http_perl_module&#x3D;dynamic –with-http_random_index_module –with-http_realip_module –with-http_secure_link_module –with-http_slice_module –with-http_ssl_module –with-http_stub_status_module –with-http_sub_module –with-http_v2_module –with-http_xslt_module&#x3D;dynamic –with-mail&#x3D;dynamic –with-mail_ssl_module –with-pcre –with-pcre-jit –with-stream&#x3D;dynamic –with-stream_ssl_module –with-stream_ssl_preread_module –with-threads –with-cc-opt&#x3D;’-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE&#x3D;2 -fexceptions -fstack-protector-strong –param&#x3D;ssp-buffer-size&#x3D;4 -grecord-gcc-switches -specs&#x3D;&#x2F;usr&#x2F;lib&#x2F;rpm&#x2F;redhat&#x2F;redhat-hardened-cc1 -m64 -mtune&#x3D;generic’ –with-ld-opt&#x3D;’-Wl,-z,relro -specs&#x3D;&#x2F;usr&#x2F;lib&#x2F;rpm&#x2F;redhat&#x2F;redhat-hardened-ld -Wl,-E’ 2.添加新的Nginx源，并安装，如下：12wget https://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpmrpm -ivh nginx-release-centos-7-0.el7.ngx.noarch.rpm 3.清除当前的yum缓存后，升级Nginx，命令如下：12yum clean all &amp;&amp; yum makecacheyum update nginx #升级nginx 4.再次检查Nginx版本，已经升级到最新版本，如图： [root@centos07-12 ~]# nginx -Vnginx version: nginx&#x2F;1.24.0built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC)built with OpenSSL 1.0.2k-fips 26 Jan 2017TLS SNI support enabledconfigure arguments: –prefix&#x3D;&#x2F;etc&#x2F;nginx –sbin-path&#x3D;&#x2F;usr&#x2F;sbin&#x2F;nginx –modules-path&#x3D;&#x2F;usr&#x2F;lib64&#x2F;nginx&#x2F;modules –conf-path&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf –error-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log –http-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log –pid-path&#x3D;&#x2F;var&#x2F;run&#x2F;nginx.pid –lock-path&#x3D;&#x2F;var&#x2F;run&#x2F;nginx.lock –http-client-body-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;client_temp –http-proxy-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;proxy_temp –http-fastcgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;fastcgi_temp –http-uwsgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;uwsgi_temp –http-scgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;scgi_temp –user&#x3D;nginx –group&#x3D;nginx –with-compat –with-file-aio –with-threads –with-http_addition_module –with-http_auth_request_module –with-http_dav_module –with-http_flv_module –with-http_gunzip_module –with-http_gzip_static_module –with-http_mp4_module –with-http_random_index_module –with-http_realip_module –with-http_secure_link_module –with-http_slice_module –with-http_ssl_module –with-http_stub_status_module –with-http_sub_module –with-http_v2_module –with-mail –with-mail_ssl_module –with-stream –with-stream_realip_module –with-stream_ssl_module –with-stream_ssl_preread_module –with-cc-opt&#x3D;’-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE&#x3D;2 -fexceptions -fstack-protector-strong –param&#x3D;ssp-buffer-size&#x3D;4 -grecord-gcc-switches -m64 -mtune&#x3D;generic -fPIC’ –with-ld-opt&#x3D;’-Wl,-z,relro -Wl,-z,now -pie’","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"nginx","slug":"运维/nginx","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/nginx/"}],"tags":[]},{"title":"47-sed","slug":"运维/Linux云计算教程/47-sed","date":"2021-09-17T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/09/17/运维/Linux云计算教程/47-sed/","link":"","permalink":"https://dbbruce.github.io/2021/09/17/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/47-sed/","excerpt":"1.sed流式编辑器,可以非交互式修改文本,逐行操作 使用方法12前置命令 | sed 选项 (定址符)指令sed | 选项 (定址符)指令 文本","text":"1.sed流式编辑器,可以非交互式修改文本,逐行操作 使用方法12前置命令 | sed 选项 (定址符)指令sed | 选项 (定址符)指令 文本 选项123-n 屏蔽默认输出-r 支持扩展正则-i 写入文件 指令 p 输出指定内容123456789101112131415161718df | sed -n &#x27;1p&#x27; //输出df指令生成的文本中第1行sed &#x27;p&#x27; txt //输出所有行2次sed -n &#x27;p&#x27; txt //输出所有行1次sed -n &#x27;1p&#x27; txt //输出第1行sed -n &#x27;2p&#x27; txt //输出第2行sed -n &#x27;1,2p&#x27; txt //输出1到2行sed -n &#x27;1,3p&#x27; txt //输出1到3行sed -n &#x27;2,+4p&#x27; txt //输出1到3行sed -n &#x27;2,+4p&#x27; txt //输出第2行,以及后面的4行sed -n &#x27;2p;4p&#x27; txt //输出第2行,第4行sed -n &#x27;1~2p&#x27; txt //输出第1行后间隔2行才输出一次,也就是135sed -n &#x27;/^root/p&#x27; txt //使用正则匹配查找内容 sed -n &#x27;/bash$/p&#x27; txt //输出以bash结尾的行sed -n &#x27;/bash$/p&#x27; /etc/passwdsed -n &#x27;/bin/p&#x27; txtsed -n &#x27;^bin/p&#x27; txtsed -n &#x27;$=&#x27; txt //输出最后一行的行号sed -n &#x27;=&#x27; txt //输出每行的行号 d 删除12345678910111213141516sed &#x27;1d&#x27; txtsed //删第1行sed &#x27;2d&#x27; txtsedsed &#x27;2,5d&#x27; txt //删2到5行sed &#x27;2,+ld&#x27; txt //删第2行以及后面1行sed &#x27;2d;4d&#x27; txt //删第2行,第4行sed &#x27;1~2d&#x27;txt //删奇数行sed &#x27;2~2d&#x27;txt //删偶数行sed -i &#x27;5d&#x27; txt //删除第5行,并写入文件sed &#x27;/^root/d&#x27; txt //删除以root开头的行 正则sed -r&#x27;/bashlnologin/d&#x27; txt //删除有bash或nologin的行 扩展正则sed &#x27;3,5d&#x27; a.txt //删除第3~5行sed &#x27;/xml/d&#x27; a.txt //删除所有包含xml的行sed &#x27;/xml/!d&#x27; a.txt //删除不包含xml的行，!符号表示取反sed &#x27;/^install/d&#x27; a.txt //删除以install开头的行sed &#x27;$d&#x27; a.txt //删除文件的最后一行sed &#x27;/^$/d&#x27; a.txt //删除所有空行 s sed命令的s替换基本功能 (s&#x2F;日内容&#x2F;新内容&#x2F;选项)sed ‘s&#x2F;old&#x2F;new&#x2F;‘123456sed &#x27;s/2017/xxxx/&#x27; //更换第一个sed &#x27;s/2017/xxxx/g&#x27; //全部更换sed &#x27;s/2017/xxxx/2&#x27; //更换第二行的内容sed &#x27;s/2017//2&#x27; //第二行换位空sed -n &#x27;s/2017/xxxx/p&#x27; //更换显示的内容sed &#x27;4,7s/^/#/&#x27; a.txt //在4到7行，头部插入# 1234/bin/bash 替换成 /sbin/shsed &#x27;s//bin/bash//sbin/sh/&#x27; txt //替换失败,替换符号冲突sed &#x27;s#/bin/bash#/sbin/sh#&#x27; txt //更换替换符号为#sed &#x27;s(/bin/bash(/sbin/sh(&#x27; txt //更换替换符号为( 123//将文本中第一个字符和最后一个字符互换sed -r &#x27;s/^(.)(.*)(.)$/\\3\\2\\1/&#x27; txt a 行后追加1234sed &#x27;a 888&#x27; txt5 //每行下添加888sed &#x27;2a 888&#x27; txt5 //第二行下添加888sed &#x27;1,2a 888&#x27; txt5 //第1到2行下添加888sed &#x27;/A/a 888&#x27; txt5 //有A的行下添加888 i 行前添加12sed &#x27;i 888&#x27; txt5 //每行上添加888sed &#x27;3i 888&#x27; txt5 //第3行上添加888 c 替换行12sed &#x27;c 888&#x27; txt5 //所有行替换成888sed &#x27;1c 888&#x27; txt5 //第1行替换成888 2.实例编写脚本,实现vsftpd服务装包配置启服务的全过程,开启上传功能 123456#!/bin/bashyum -y install vsftpd &amp;&gt; /dev/nullsed -i&#x27;s/~#anon u/anon u/&#x27; /etc/vsftpd/vsftpd.confsystemctl restart vsftpdsystemctl enable vsftpdchmod o+w /var/ftp/pub","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"17-静态文件缓存","slug":"运维/nginx/17-静态文件缓存","date":"2021-09-17T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/09/17/运维/nginx/17-静态文件缓存/","link":"","permalink":"https://dbbruce.github.io/2021/09/17/%E8%BF%90%E7%BB%B4/nginx/17-%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6%E7%BC%93%E5%AD%98/","excerpt":"1.如果需要处理大量静态文件，可以将文件缓存在内存，下次访问会更快。123456http &#123; open_file_cache max=2000 inactive=20s; //设置服务器最大缓存2000个文件句柄，关闭20秒内无请求的文件句柄 open_file_cache_valid 60s; //文件句柄的有效时间是60秒，60秒后过期 open_file_cache_min_uses 5; //只有访问次数超过5次会被缓存 open_file_cache_errors off; //关闭无缓存报错&#125;","text":"1.如果需要处理大量静态文件，可以将文件缓存在内存，下次访问会更快。123456http &#123; open_file_cache max=2000 inactive=20s; //设置服务器最大缓存2000个文件句柄，关闭20秒内无请求的文件句柄 open_file_cache_valid 60s; //文件句柄的有效时间是60秒，60秒后过期 open_file_cache_min_uses 5; //只有访问次数超过5次会被缓存 open_file_cache_errors off; //关闭无缓存报错&#125;","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"nginx","slug":"运维/nginx","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/nginx/"}],"tags":[]},{"title":"46-正则表达式","slug":"运维/Linux云计算教程/46-正则表达式","date":"2021-09-16T03:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2021/09/16/运维/Linux云计算教程/46-正则表达式/","link":"","permalink":"https://dbbruce.github.io/2021/09/16/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/46-%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/","excerpt":"1.基本正则列表 (grep) 正则符号 描述 ^ 匹配行首 $ 匹配行尾 [] 集台，匹配集合中的任意单个字符 [^] 对集台取反 . 点 匹配任意单个字符 *米号 匹配前一个字符任意次数 [不允许单独使用] {n,m} 匹配前一个字符n到m次 {n} 匹配前一个字符 n 次 {n, } 匹配前一个字符 n 次及以上 () 保留","text":"1.基本正则列表 (grep) 正则符号 描述 ^ 匹配行首 $ 匹配行尾 [] 集台，匹配集合中的任意单个字符 [^] 对集台取反 . 点 匹配任意单个字符 *米号 匹配前一个字符任意次数 [不允许单独使用] {n,m} 匹配前一个字符n到m次 {n} 匹配前一个字符 n 次 {n, } 匹配前一个字符 n 次及以上 () 保留 2.扩展正则列表 (grep -E 或者 egrep) 正则符号 描述 + 加号 最少匹配一次 ？ 问号 最多匹配一次 或者0次 {n, m} 匹配n到m次 () 组合为整体， 保留 ,相当于复制，使用\\1\\2\\3提取 | 竖号 或 \\b 单词边界:空,空格,tab,特殊符号; 不能是字母，数字，下划线 123456789101112[root@master ~]# cat txtroot:x:0:0:root:/root:/bin/bashbin:x:1:1:bin:/bin:/sbin/nologin_sbin_-sbin-%sbin*asbina12sbin21[root@master ~]# egrep &quot;\\bsbin\\b&quot; txt #\\bsbin\\b 等于 \\sbin\\ 这里\\b等于字符串里\\bin:x:1:1:bin:/bin:/sbin/nologin-sbin-%sbin*","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"16-对页面进行压缩处理","slug":"运维/nginx/16-对页面进行压缩处理","date":"2021-09-16T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/09/16/运维/nginx/16-对页面进行压缩处理/","link":"","permalink":"https://dbbruce.github.io/2021/09/16/%E8%BF%90%E7%BB%B4/nginx/16-%E5%AF%B9%E9%A1%B5%E9%9D%A2%E8%BF%9B%E8%A1%8C%E5%8E%8B%E7%BC%A9%E5%A4%84%E7%90%86/","excerpt":"1.修改Nginx配置文件1234567http &#123; gzip on; //开启压缩 gzip_min length 1000; //小文件不压缩 gzip_comp_level 4; //压缩比率 1~9,越高压缩力度越强，压缩时间也越长； gzip_types text/plain text/css ; //对特定文件压缩，类型参考下面 ，媒体文件不要压缩&#125;","text":"1.修改Nginx配置文件1234567http &#123; gzip on; //开启压缩 gzip_min length 1000; //小文件不压缩 gzip_comp_level 4; //压缩比率 1~9,越高压缩力度越强，压缩时间也越长； gzip_types text/plain text/css ; //对特定文件压缩，类型参考下面 ，媒体文件不要压缩&#125; 2.文件类型123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103[root@master ~]# ll /usr/local/nginx/conf/mime.types-rw-r--r--. 1 root root 5349 9月 4 18:05 /usr/local/nginx/conf/mime.types[root@master ~]# cat /usr/local/nginx/conf/mime.typestypes &#123; text/html html htm shtml; text/css css; text/xml xml; image/gif gif; image/jpeg jpeg jpg; application/javascript js; application/atom+xml atom; application/rss+xml rss; text/mathml mml; text/plain txt; text/vnd.sun.j2me.app-descriptor jad; text/vnd.wap.wml wml; text/x-component htc; image/avif avif; image/png png; image/svg+xml svg svgz; image/tiff tif tiff; image/vnd.wap.wbmp wbmp; image/webp webp; image/x-icon ico; image/x-jng jng; image/x-ms-bmp bmp; font/woff woff; font/woff2 woff2; application/java-archive jar war ear; application/json json; application/mac-binhex40 hqx; application/msword doc; application/pdf pdf; application/postscript ps eps ai; application/rtf rtf; application/vnd.apple.mpegurl m3u8; application/vnd.google-earth.kml+xml kml; application/vnd.google-earth.kmz kmz; application/vnd.ms-excel xls; application/vnd.ms-fontobject eot; application/vnd.ms-powerpoint ppt; application/vnd.oasis.opendocument.graphics odg; application/vnd.oasis.opendocument.presentation odp; application/vnd.oasis.opendocument.spreadsheet ods; application/vnd.oasis.opendocument.text odt; application/vnd.openxmlformats-officedocument.presentationml.presentation pptx; application/vnd.openxmlformats-officedocument.spreadsheetml.sheet xlsx; application/vnd.openxmlformats-officedocument.wordprocessingml.document docx; application/vnd.wap.wmlc wmlc; application/wasm wasm; application/x-7z-compressed 7z; application/x-cocoa cco; application/x-java-archive-diff jardiff; application/x-java-jnlp-file jnlp; application/x-makeself run; application/x-perl pl pm; application/x-pilot prc pdb; application/x-rar-compressed rar; application/x-redhat-package-manager rpm; application/x-sea sea; application/x-shockwave-flash swf; application/x-stuffit sit; application/x-tcl tcl tk; application/x-x509-ca-cert der pem crt; application/x-xpinstall xpi; application/xhtml+xml xhtml; application/xspf+xml xspf; application/zip zip; application/octet-stream bin exe dll; application/octet-stream deb; application/octet-stream dmg; application/octet-stream iso img; application/octet-stream msi msp msm; audio/midi mid midi kar; audio/mpeg mp3; audio/ogg ogg; audio/x-m4a m4a; audio/x-realaudio ra; video/3gpp 3gpp 3gp; video/mp2t ts; video/mp4 mp4; video/mpeg mpeg mpg; video/quicktime mov; video/webm webm; video/x-flv flv; video/x-m4v m4v; video/x-mng mng; video/x-ms-asf asx asf; video/x-ms-wmv wmv; video/x-msvideo avi;&#125;[root@master ~]#","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"nginx","slug":"运维/nginx","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/nginx/"}],"tags":[]},{"title":"45-shell","slug":"运维/Linux云计算教程/45-shell","date":"2021-09-15T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/09/15/运维/Linux云计算教程/45-shell/","link":"","permalink":"https://dbbruce.github.io/2021/09/15/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/45-shell/","excerpt":"1.快捷键 快捷键 描述 Ctrl+A 将光标移至行首 Ctr+E 将光标移至行尾 Ctrl+C 终止提作 Ctn+D 一般为结束输入 Ctrl+M 回车 Ctr+U 删除光标至行首的所有内容 Ctrl+W 删除光标前面的一个单词( 空格分隔) Ctr+S 挂起，冻结终端 Ctrl+Q 解除东结终端 Alt+. 使用前一个命令的最后一个词 方向键( 上下键 ) 历史命令 Tab键 补齐命令、选项、路径与文件名","text":"1.快捷键 快捷键 描述 Ctrl+A 将光标移至行首 Ctr+E 将光标移至行尾 Ctrl+C 终止提作 Ctn+D 一般为结束输入 Ctrl+M 回车 Ctr+U 删除光标至行首的所有内容 Ctrl+W 删除光标前面的一个单词( 空格分隔) Ctr+S 挂起，冻结终端 Ctrl+Q 解除东结终端 Alt+. 使用前一个命令的最后一个词 方向键( 上下键 ) 历史命令 Tab键 补齐命令、选项、路径与文件名 2.脚本执行方式:1,赋予x执行权限,然后使用绝对或相对路径运行该文件；2,使用解释器直接执行脚本,即使没有X权限也,可以bash test1.sh,这种是新调用一个bash执行，执行后，还原到原窗口；3,使用source命令执行脚本，使用当前窗口bash执行，执行后保持原样； 12345678910[root@master ~]# cat 1.sh#!/bin/bashcd /echo &quot;done&quot;[root@master ~]# bash 1.sh #新解析器， 执行后还在~目录done[root@master ~]# source 1.sh #使用原解析器，执行后进入根目录done 3.变量置空1234567[root@master ~]# a=10[root@master ~]# echo $a10[root@master ~]# unset a[root@master ~]# echo $a # 输出空[root@master ~]# 4.环境变量: （大写）查看环境变量：env 1234567891011[root@master ~]# envXDG_SESSION_ID=1HOSTNAME=masterSELINUX_ROLE_REQUESTED=TERM=xterm-256colorSHELL=/bin/bashHISTSIZE=1000SSH_CLIENT=192.168.1.9 62447 22SELINUX_USE_CURRENT_RANGE=SSH_TTY=/dev/pts/0USER=root 5.位置变量： $1 $2 $3 … $n1234567891011121314151617181920[root@master ~]# cat 2.sh#!/usr/bin/bashecho $0echo $1echo $2echo $$ #进程号echo $? #检测上一条指令使用有问题，0代表正常echo $# #参数数量echo $* #显示所有变量echo $! #显示上一条放在后台的进程号[root@master ~]# bash 2.sh hello word2.sh helloword201702hello word 6.查看命令查看所有环境变量：env查看所有变量：set 7.引号“” 界定范围‘’ 界定范围,可以屏蔽特殊符号&#96;&#96;(反撇) 获取指令的结果 12345678910111213//创建2个文件touch a b //创建2个文件touch&quot;a b&quot; //创建1个文件touch&#x27;x y&#x27; //创建1个文件a=10echo &quot;$a&quot; // 显示变量a的值(内容)echo &#x27;$a&#x27; //显示$a,$是特殊符号,功能被屏蔽//定义变量a,内容是date,下面3个结果一样a=date // a = 2023-09-02 21:30:55a=`date` //定义变量a，内容是date命令执行的结果， a= 2023-09-02 21:30:55a=$(data) //定义变量a，内容是date命令执行的结果， a= 2023-09-02 21:30:55 8.反撤号或$()的应用使用反撤号或$()时，可以将命令执行的标准输出作为字符串存储，因此称为命令替换 1 [root@svr5 ~]# tar -czf log-date+%Y%m%d.tar.gz &#x2F;var&#x2F;log 9.使用read命令从键盘读取变量值执行后从会等待并接受用户输入 (无任何提示的情况) ，并赋值给变量str 1[root@svr5 ~]# read str 10.回显控制stty -echo &#x2F;&#x2F;关闭回显stty echo &#x2F;&#x2F; 恢复回显 11.全局变量123456局部变量 a=10 全局变量export a=10 //创建新变量,并发布成全局变量export a //对已有的变量,发布全局export -n a //撤销全局变量,恢复局部变量 12. \\转移字符，,屏蔽之后一个字符的特殊含义‘’单引号，用于多个字符屏蔽特殊含义 13.计算 expr :同时具有输出和运算能力123456789expr 1 + 1 expr 1 - 1 expr 1 \\* 1 expr 1 / 1 expr 1 % 1 # 使用变量a = 10expr $a + $a $[…]:只有运算能力123456789echo $[1+1]echo $[1-1]echo $[1*1]echo $[1/1]echo $[1%1]# 使用变量a = 10echo $[a + 10] # 这个简单，少些$ let :改变变量本身的值，不显示结果12345let a = a + 1 # 不优雅# 只要用法let a--let a++let a+=2 bc 小数计算123echo &quot;1+1&quot; | bc //使用bc进行非交互式计算echo &quot;1.1+1&quot; | bc //并且可以计算小数echo &quot;scale=3;10/3&quot; | bc //定义小数点后面长度是3位 14.条件判断 &#x3D;&#x3D; !&#x3D; 字符判断语法：空格[空格a空格&#x3D;&#x3D;空格空格]空格 123456[root@master ~]# [ $USER == root ][root@master ~]# echo $?0[root@master ~]# [ $USER == root1 ][root@master ~]# echo $?1 15.逻辑判断&amp;&amp; :前面任务成功,才执行后续任务|| :前面任务失败,才执行后续任务; :前面任务执行完毕后,继续执行后续任务,前后无逻辑关系; 省行，多行写一行 123[ $USER == root ] &amp;&amp; echo 123 //如果当前用户是管理员,才输出123[ $USER != root ] &amp;&amp; echo 123 //如果当前用户不是管理员,才输出123[ $USER == root ] || echo 123 / /如果当前用户不是管理员,才输出123 16. -z 判断是否为空使用 -z 优化创建用户的脚本,如果没有输入用户名直接回车则退出脚本 [ -z $a ] [ ! -z $a ]1234#!/bin/bashread -p &quot;请输入账户名” u[ -z $u ] &amp;&amp; exituseradd $u 17.数字判断-eq等于 -ne不等于 -gt大于 -ge大于等于 -lt小于 -le小于等于 123456[root@master ~]# [ 1 == 1 ] # wrong[root@master ~]# echo $?127[root@master ~]# [ 1 -eq 1 ] # right[root@master ~]# echo $?0 18. 文件，目录存在判断-e 判断文件或者目录是否存在，文件和目录都可以-d 判断目录是否存在-f 判断文件是否存在 123456789101112131415# -e[root@master ~]# [ -e /root/ ][root@master ~]# echo $?0[root@master ~]# [ -e /root/1.sh ][root@master ~]# echo $?0# -d[root@master ~]# [ -d /root/ ][root@master ~]# echo $?0# -f[root@master ~]# [ -f /root/1.sh ][root@master ~]# echo $?0 18.权限判断-r 读权限（root无效）-w 写权限 （root无效）-x 执行权限 123456789[root@master ~]# [ -r /root/ ][root@master ~]# echo $?0[root@master ~]# [ -w /root/ ][root@master ~]# echo $?0[root@master ~]# [ -x /root/ ][root@master ~]# echo $?0 19.if单分支if 条件测试 ;then 命令序列fi 20.if双分支if 条件测试;then 命令序列1else 命令序列2fi 21.if多分支if 条件测试，then 命令序列1elif 条件测试;then 命令序列2elif 条件测试;then 命令序列3else 命令序列4fi 21.for循环for 变量名 in 值列表do 命令序列done 12345678910111213141516171819for循环,执行多次相同任务时使用基本用法:#!/bin/bashfor i in a b//有a b两个值,循环两次do //执行两次任务 echo 123done利用for循环测试多台主机是否可以连通#!/bin/bashfor i in [l..15]//准备15个值,循环15次,第一次pingdo ping -c 3 -i 0.2 -W 1 172.25.0.si &amp;&gt; /dev/nullif [ $? -eq 0 ];then echo &quot;172.25..$i通了&quot;else echo &quot;172.25.0.$i不通&quot;fidone 22.case分支，是简化版本的if,代码编写比if精简,但功能不如if强大case 变量 in式1) 命令序列;;模式2) 命令序列2;;esac 123456case $1 in aa) echo aaaaa;;bb) echo bbbbb;;esac 12345678910111213#!/bin/bashcase $1 in st start) /usr/local/nginx/sbin/nginx;; stop) /usr/local/nginx/sbin/nginx - s stop;; rest) /usr/local/nginx/sbin/nginx - s stop /usr/local/nginx/sbin/nginx;; stat) netstat - ntulp grep - q nginx [ $? - eq o] &amp;&amp; echo&quot;服务已启动&quot; echo &quot;服务未启动&quot;; *) echo &quot;st stop rest stat&quot;esac 23.echo带颜色 24.函数函数名 (){ XXXXX} 123456#!/bin/bashabc () &#123; mkdir $1 # 注意这个$1,是函数调用后的，第一个参数，不是执行脚本的第一个参数 cd $1&#125;abc abc 25.中断控制exit 终止脚本程序break 跳出循环,执行循环后任务continue 结束本次循环,继续下一次循环 12345678#!/bin/bashX=0while :doread -p &quot;请输入数字(0是结束)&quot; n[ sn -eq 0 ] &amp;&amp; break let x+=ndoneecho &quot;所有数字之和是$x&quot; 26.字符串处理 截取123[root@master ~] a=abcdef[root@master ~] echo $&#123;a: 3: 2&#125; # 从第三个开始截取，取2个值[root@master ~] de 替换 只替换第1个子串${变量名&#x2F;old&#x2F;new} 替换全部子串${变量名&#x2F;&#x2F;od&#x2F;new}12345[root@master ~]# a=aabbccdd[root@master ~]#echo $&#123;a/a/b&#125; #替换一个babbccdd [root@master ~]#echo $&#123;a//a/b&#125; #替换全部bbbbccdd 删除 从左向右，最短匹配删除${变量名#关键词} # 1个#号，删除从左侧第1个字符到最近的关键词“root”的部分，作通配符理1234567[root@master ~]# a=`head -1 /etc/passwd`[root@master ~]# echo $aroot:x:0:0:root:/root:/bin/bash[root@master ~]# echo $&#123;a#*root&#125; # 1个#号删除第一root:x:0:0:root:/root:/bin/bash[root@master ~]# echo $&#123;a##*root&#125; # 最左边一个root:/bin/bash 从左向右，最长匹配删除${变量名##*关键词} # 2个#号， 删除从左侧第1个字符到最远的关键词“root”的部分 :12345[root@master ~]# a=`head -1 /etc/passwd`[root@master ~]# echo $a:x:0:0:root:/root:/bin/bash[root@master ~]# echo $&#123;a##*root&#125; # 最右边一个root:/bin/bash 从右向左，最短匹配删除格式:${变量名%关键词*} # 一个% 删除从右侧最后1个字符到往左最近的关键词“:”的部分，*做通配符理解:12[root@master ~]# echo $&#123;a%:*&#125;root:x:0:0:root:/root 从右向左，最长匹配删除格式:${变量名%%关键词*} # 2个% 删除从右侧最后1个字符到往左最远的关键词“:”的部分 12[root@master ~]# echo $&#123;a%%:*&#125;root 赋初值格式:${变量名:-初始值} # 当变量没有值时，使用初始化123456[root@master ~]# c=888[root@master ~]# echo $&#123;c:-1234&#125;888[root@master ~]# c=[root@master ~]# echo $&#123;c:-1234&#125;1234","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"15-日志切分","slug":"运维/nginx/15-日志切分","date":"2021-09-15T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/09/15/运维/nginx/15-日志切分/","link":"","permalink":"https://dbbruce.github.io/2021/09/15/%E8%BF%90%E7%BB%B4/nginx/15-%E6%97%A5%E5%BF%97%E5%88%87%E5%88%86/","excerpt":"手动切分1. 重命名旧日志文件12[root@master ~]# mv /usr/local/nginx/logs/access.log /usr/local/nginx/logs/access.log.2[root@master ~]# mv /usr/local/nginx/logs/error.log /usr/local/nginx/logs/error.log.2","text":"手动切分1. 重命名旧日志文件12[root@master ~]# mv /usr/local/nginx/logs/access.log /usr/local/nginx/logs/access.log.2[root@master ~]# mv /usr/local/nginx/logs/error.log /usr/local/nginx/logs/error.log.2 注意：linux是用file id对文件进行失败，即使修改了文件名，file id没有变化仍向旧文件中写日志 1234567[root@master ~]# tail -f /usr/local/nginx/logs/access.log.2192.168.1.9 - - [06/Sep/2023:18:58:29 +0800] &quot;GET /day.jpg HTTP/1.1&quot; 200 961243 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15&quot;192.168.1.9 - - [06/Sep/2023:18:59:57 +0800] &quot;GET / HTTP/1.1&quot; 499 0 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15&quot;192.168.1.9 - - [06/Sep/2023:19:00:00 +0800] &quot;GET /index.html HTTP/1.1&quot; 502 497 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15&quot;192.168.1.9 - - [06/Sep/2023:19:00:03 +0800] &quot;GET /index.html HTTP/1.1&quot; 502 497 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15&quot;192.168.1.9 - - [06/Sep/2023:19:00:04 +0800] &quot;GET / HTTP/1.1&quot; 502 497 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15&quot;192.168.1.9 - - [06/Sep/2023:19:00:07 +0800] &quot;GET / HTTP/1.1&quot; 502 497 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15&quot; 2. user方式重启nginx，产生新日志文件nginx服务不会重启，日志文件 file id 会变化kill -USR1 $(cat &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;nginx.pid) 启动前1234567891011[root@master ~]# ll /usr/local/nginx/logs/总用量 300-rw-r--r--. 1 root root 288548 9月 6 19:00 access.log.2-rw-r--r--. 1 root root 8774 9月 6 19:00 error.log.2-rw-r--r--. 1 root root 5 9月 6 18:58 nginx.pid[root@master ~]# ps axf |grep nginx 1582 pts/0 S+ 0:00 \\_ grep --color=auto nginx 1510 ? Ss 0:00 nginx: master process /usr/local/nginx/sbin/nginx 1511 ? S 0:00 \\_ nginx: worker process 1512 ? S 0:00 \\_ nginx: worker process[root@master ~]# 重启file id备注:&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;nginx.pid文件中存放的是nginx的进程PID号 12[root@master ~]# kill -USR1 $(cat /usr/local/nginx/logs/nginx.pid) 重启后12345678910111213[root@master ~]# ps axf |grep nginx 1585 pts/0 S+ 0:00 \\_ grep --color=auto nginx 1510 ? Ss 0:00 nginx: master process /usr/local/nginx/sbin/nginx 1511 ? S 0:00 \\_ nginx: worker process 1512 ? S 0:00 \\_ nginx: worker process[root@master ~]# ll /usr/local/nginx/logs/总用量 300-rw-r--r--. 1 nobody root 0 9月 6 19:13 access.log-rw-r--r--. 1 root root 288548 9月 6 19:00 access.log.2-rw-r--r--. 1 nobody root 0 9月 6 19:13 error.log-rw-r--r--. 1 root root 8774 9月 6 19:00 error.log.2-rw-r--r--. 1 root root 5 9月 6 18:58 nginx.pid[root@master ~]# 自动切分每周5的03点03分自动执行脚本完成日志切割工作 logbak.sh 1234567#!/bin/bashdate=`date +%Y%m%d`logpath=/usr/local/nginx/logsmv $logpath/access.log $logpath/access-$datamv $logpath/error.log $logpath/error-$datekill -USR1 $(cat $logpath/nginx.pid) 12Top[root@proxy ~]# crontab -e03 03 * * 5 /usr/local/nginx/logbak.sh","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"nginx","slug":"运维/nginx","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/nginx/"}],"tags":[]},{"title":"44-网络管理-vrrp","slug":"运维/Linux云计算教程/44-网络管理-vrrp","date":"2021-09-14T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/09/14/运维/Linux云计算教程/44-网络管理-vrrp/","link":"","permalink":"https://dbbruce.github.io/2021/09/14/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/44-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86-vrrp/","excerpt":"1.vrrp虚拟路由几余协议，用来做网关备份,增加网络可靠个人理解就是：使用2个路由，创建一个虚拟路由，相互做备份","text":"1.vrrp虚拟路由几余协议，用来做网关备份,增加网络可靠个人理解就是：使用2个路由，创建一个虚拟路由，相互做备份 123456789101112131415161718路由器配置ospf[Huawei] ospf[Huawei-ospf-1] area 0[Huawei-ospf-1-area-0.0.0.0] network 192.168.2.0 0.0.0.255[Huawei-ospf-1-area-0.0.0.0] network 192.168.3.0 0.0.0.255[Huawei-ospf-1-area-0.0.0.0] network 192.168.4.0 0.0.0.255三层交换机sw1[Huawei] ospf[Huawei-ospf-1] area 0[Huawei-ospf-1-area-0.0.0.0] network 192.168.1.0 0.0.0.255[Huawei-ospf-1-area-0.0.0.0] network 192.168.2.0 0.0.0.255三层交换机sw2[Huawei] ospf[Huawei-ospf-1] area 0[Huawei-ospf-1-area-0.0.0.0] network 192.168.1.0 0.0.0.255[Huawei-ospf-1-area-0.0.0.0] network 192.168.3.0 0.0.0.255 2.常用查询命令1234//查ipdisplay ip interface brief//查看路由表display ip routing-table 3.创建虚拟路由两台三层交换机同时配置vrrp协议[ 123456789101112//第一台路由[Huawei] interface Vlanif 1 // 进入vlan 1//vrid 1 代表组号1，2个路由在一个组里[Huawei-Vlanif1] vrrp vrid 1 virtual-ip 192.168.1.254 [Huawei-Vlanif1] display vrrp brief //查看虚拟路由的配置//第二台路由[Huawei] interface Vlanif 1 // 进入vlan 1 //vrid 1 代表组号1，2个路由在一个组里[Huawei-Vlanif1] vrrp vrid 1 virtual-ip 192.168.1.254 [Huawei-Vlanif1] display vrrp brief //查看虚拟路由的配置//master 主//backup 备份 4.vrrp实现负载均衡 1、创建所需vlan vlan10 vlan202、所有交换机之间的链路配置trunkdisplay vlan &#x2F;&#x2F;查vlandisplay cur &#x2F;&#x2F;查接口配置,按空格翻页3、为s5700配置vlan10和20的ip地址 12345678910sw1in vlan 10ip add 192.168.10.252 24in vlan 20ip add 192.168.20.252 24sw2in vlan 10ip add 192.168.10.253 24in vlan 20ip add 192.168.20.253 24 12345678910111213141516171819sw1vlan 10 主vlan 20 备in vlan 10vrrp vrid 10 virtual-ip 192.168.10.254vrrp vrid 10 priority 105 // 更改vrid的优先级，默认100，大于100就可以in vlan 20vrrp vrid 20 virtual-ip 192.168.20.254display vrrpsw2vlan 10 备vlan 20 主in vlan 10vrrp vrid 10 virtual-ip 192.168.10.254in vlan 20vrrp vrid 20 virtual-ip 192.168.20.254vrrp vrid 20 priority 105 // 更改vrid的优先级，默认100，大于100就可以display vrrp","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"14-图片加缓冲","slug":"运维/nginx/14-图片加缓冲","date":"2021-09-14T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/09/14/运维/nginx/14-图片加缓冲/","link":"","permalink":"https://dbbruce.github.io/2021/09/14/%E8%BF%90%E7%BB%B4/nginx/14-%E5%9B%BE%E7%89%87%E5%8A%A0%E7%BC%93%E5%86%B2/","excerpt":"1.图片加缓存1. 修改nginx在server里新增 1234location ~* \\.(jpg|jpeg|gif)&#123; #~* 正则忽略大小写 expires 30d; # 30天&#125;","text":"1.图片加缓存1. 修改nginx在server里新增 1234location ~* \\.(jpg|jpeg|gif)&#123; #~* 正则忽略大小写 expires 30d; # 30天&#125; 1[root@master conf]# cp /usr/share/backgrounds/day.jpg /usr/local/nginx/html/ 1[root@master conf]# /usr/local/nginx/sbin/nginx -s reload 2.查看缓存访问：http://www.a.com/day.jpg查看缓存about:cache","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"nginx","slug":"运维/nginx","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/nginx/"}],"tags":[]},{"title":"43-网络管理-stp生成树协议","slug":"运维/Linux云计算教程/43-网络管理-stp生成树协议","date":"2021-09-13T03:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2021/09/13/运维/Linux云计算教程/43-网络管理-stp生成树协议/","link":"","permalink":"https://dbbruce.github.io/2021/09/13/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/43-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86-stp%E7%94%9F%E6%88%90%E6%A0%91%E5%8D%8F%E8%AE%AE/","excerpt":"1.注意这个，会形成数据风暴，导致网络瘫痪环形交换机","text":"1.注意这个，会形成数据风暴，导致网络瘫痪环形交换机 2.stp智能交换机，我自动启动stp，防止数据风暴 12[Huawei] undo stp en[Huawei] undostp enable","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"13-指标统计","slug":"运维/nginx/13-指标统计","date":"2021-09-13T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/09/13/运维/nginx/13-指标统计/","link":"","permalink":"https://dbbruce.github.io/2021/09/13/%E8%BF%90%E7%BB%B4/nginx/13-%E6%8C%87%E6%A0%87%E7%BB%9F%E8%AE%A1/","excerpt":"1.nginx指标并发量总连接数等待PV page view 页面查看次数UV user view 用户量","text":"1.nginx指标并发量总连接数等待PV page view 页面查看次数UV user view 用户量 1. 如何查看服务器状态信息编译安装时使用–with-http_stub_status_module开启状态页面模块 123456789101112[root@master nginx-1.22.1]# ./configure --prefix=/usr/local/nginx # 安装路径--with-http_ssl_module # 开启ssl加密功能--with-stream # 开启tcp udp代理--with-http_stub_status_module # 开通status状态统计[root@master nginx-1.22.1]# mv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.bak.0905-02[root@master nginx-1.22.1]# cd objs/[root@master objs]# cp nginx /usr/local/nginx/sbin/[root@master nginx-1.22.1]# cd ..[root@master nginx-1.22.1]# make upgrade 2.开启统计功能123456789listen 80; server_name www.a.com; location /status &#123; stub_status on; #allow IP地址; # 允许访问 #deny IP地址/all; #拒绝访问 &#125; 123Active connections: 2 server accepts handled requests 2 2 2 | 统计值，只能增加，不会减少Reading: 0 Writing: 1 Waiting: 1 tcp协议(3次握手建立连接,4次断开 Active connections 并发连接数，当前活动的连接数量 实时值 server accepts 建立连接的次数，3次握手(syn,syn+ack,ack)，已经接受客户端的连接总数量 统计值，只能增加，不会减少 server handled 请求建立的次数和处理的次数，已经处理客户端的连接总数量，一般与accepts一致，除非服务器限制了连接数量 统计值，只能增加，不会减少 server requests 请求的次数 ，客户端发送的请求数量 统计值，只能增加，不会减少 Reading 正在读的数据包 ，当前服务器正在读取客户端请求数量 实时值 Writing 写回应的数据包，当前服务器正在写响应信息的数量 实时值 Waiting 等待，当前多少客户端在等待服务器的响应 实时值","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"nginx","slug":"运维/nginx","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/nginx/"}],"tags":[]},{"title":"42-网络管理-easy ip","slug":"运维/Linux云计算教程/42-网络管理-easyip","date":"2021-09-12T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/09/12/运维/Linux云计算教程/42-网络管理-easyip/","link":"","permalink":"https://dbbruce.github.io/2021/09/12/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/42-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86-easyip/","excerpt":"1.easy ip用在仅需要由内到外的访问,1对多转换","text":"1.easy ip用在仅需要由内到外的访问,1对多转换 2.easy ip配置步骤:1,定义允许访问外部网络的设备 利用acl定义2,在接口开启nat(easy ip) 123456[Huawei] acl 2000[Huawei-acl-basic-2000] rule permit source any //使用acl定义任何内部地址都可以访问外网[Huawei] interface g0/0/0 //进入外网接[Huawei-GigabitEtherneto/0/0] nat outbound 2000//可以利用g0/0/0的ip访问外网,此处配置的是easy ip","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"12-nginx状态码","slug":"运维/nginx/12-nginx状态码","date":"2021-09-12T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/09/12/运维/nginx/12-nginx状态码/","link":"","permalink":"https://dbbruce.github.io/2021/09/12/%E8%BF%90%E7%BB%B4/nginx/12-nginx%E7%8A%B6%E6%80%81%E7%A0%81/","excerpt":"1.404报错自定义报错页面 123charset utf-8; //仅需要中文时需要error_page 404 /404.html: //自定义错误页面vim ../html/404.html","text":"1.404报错自定义报错页面 123charset utf-8; //仅需要中文时需要error_page 404 /404.html: //自定义错误页面vim ../html/404.html 2.nginx状态码 200 一切正常 301 永久重定向 302 临时重定向 401 用户名或密码错误 403 禁止访问(客户端IP地址被拒绝 ) 404 文件不存在 414 请求URI头部过长 500 服务器内部错误 502 Bad Gateway","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"nginx","slug":"运维/nginx","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/nginx/"}],"tags":[]},{"title":"41-网络管理-NAT","slug":"运维/Linux云计算教程/41-网络管理-NAT","date":"2021-09-11T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/09/11/运维/Linux云计算教程/41-网络管理-NAT/","link":"","permalink":"https://dbbruce.github.io/2021/09/11/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/41-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86-NAT/","excerpt":"1.NAT地址转换,将内部与外部地址进行转换,实现内外网互通 2.内部私有地址a 10.0.0. ~ 10.255.255.255b 172.16.0.0172.31.255.255c 192.168.0.0192.168.255.255","text":"1.NAT地址转换,将内部与外部地址进行转换,实现内外网互通 2.内部私有地址a 10.0.0. ~ 10.255.255.255b 172.16.0.0172.31.255.255c 192.168.0.0192.168.255.255 3.无效临时地址169.254.xxx.xxx无效的临时地址,选择DHCP方式获取ip，却没有找到DHCP服务器时出现 4.静态nat主要在服务器连接外部网络时使用,1对1转换192 .168 .2.1 &gt;&gt;&gt;&gt;&gt; 100.0.xxx.xxx内网地址 &gt;&gt;&gt; nat转换表 &gt;&gt;&gt; 公网地址配置静态nat实现内网设备与外网互通 12345678[Huawei] interface GigabitEthernet 0/0/0 //进入路由器的外网接[Huawei-GigabitEtherneto/0/0] ip address 100.0.0.1 8 [Huawei-GigabitEthernet0/0/0] nat static global 100.0.0.2 inside 192.168.2.1//配置静态nat将2.1与100.0.0.2进行转换[Huawei-GigabitEthernet0/0/1]nat static global 100.0.0.3 inside 192.168.2.2//配置静态nat将2.2与100.0.0.3进行转换//外部设备访问内网的2.1时只要连接100.0.0.2即可","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"11-nginx反向代理","slug":"运维/nginx/11-nginx反向代理","date":"2021-09-11T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/09/11/运维/nginx/11-nginx反向代理/","link":"","permalink":"https://dbbruce.github.io/2021/09/11/%E8%BF%90%E7%BB%B4/nginx/11-nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/","excerpt":"0.添加2台web服务器1台 12345vim /var/www/html/index.html192.168.1.12systemctl restart httpd[root@localhost ~]# curl http://192.168.1.12:90192.168.1.12","text":"0.添加2台web服务器1台 12345vim /var/www/html/index.html192.168.1.12systemctl restart httpd[root@localhost ~]# curl http://192.168.1.12:90192.168.1.12 2台 12345vim /var/www/html/index.html192.168.1.22systemctl restart httpd[root@localhost ~]# curl http://192.168.1.22192.168.1.22 1.配置反向代理在server上添加一个upstream 1234567891011121314# 在server上添加upstreamupstream webserver11&#123; server 192.168.1.12:90; server 192.168.1.22:80;&#125;server &#123; listen 80; server_name www.a.com; location / &#123; proxy_pass http://webserver11 # 这个写在location里任意位置都可以 root html; index index.html index.htm; &#125; 12345# nginx默认轮询dbbruce@dbburce githubblog % curl www.a.com192.168.1.22dbbruce@dbburce githubblog % curl www.a.com192.168.1.12 2.集群池属性 weight 设置后台服务器的权重， max_fails 设置服务器的失败次数 fail_timeout 设置后台服务器的超时时间，单位秒 down 标记服务器关闭，不参与集群调度1234upstream webserver11&#123; server 192.168.1.12:90 weight=1 max_fails=1 fail_timeout=30; server 192.168.1.22:80 weight=2 max_fails=2 fail_timeout=30;&#125; 3.相同客户端访问相同服务器 ip_hash12345upstream webserver11&#123; ip_hash; server 192.168.1.12:90 weight=1 max_fails=1 fail_timeout=30; server 192.168.1.22:80 weight=2 max_fails=2 fail_timeout=30;&#125; 同一台webserver 12345678dbbruce@dbburce githubblog % curl www.a.com192.168.1.22dbbruce@dbburce githubblog % curl www.a.com192.168.1.22dbbruce@dbburce githubblog % curl www.a.com192.168.1.22dbbruce@dbburce githubblog % curl www.a.com192.168.1.22 4.ngx_stream_core_module模块(支持给其他协议做代理，比如ssh，ftp)使用–with-stream开启该模块注意:nginx从1.9版本才开始支持该功能 1[root@master nginx-1.22.1]# ./configure --prefix=/usr/local/nginx --with-http_ssl_module --with-stream 5.给ssh做代理在http上加一个upstream 123456789101112131415stream &#123; upstream backup &#123; server 192.168.1.12:22; server 192.168.1.22:22; &#125; server &#123; listen 12345; // 端口随意，不要被占用 proxy_pass backup; proxy_connect_timeout 1S; //连接超时时间 proxy_timeout 3s; &#125;&#125;http &#123; 测试 12dbbruce@dbburce githubblog % ssh root@192.168.1.12 -p 12345root@192.168.1.12&#x27;s password:","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"nginx","slug":"运维/nginx","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/nginx/"}],"tags":[]},{"title":"40-网络管理-ACL","slug":"运维/Linux云计算教程/40-网络管理-ACL","date":"2021-09-10T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/09/10/运维/Linux云计算教程/40-网络管理-ACL/","link":"","permalink":"https://dbbruce.github.io/2021/09/10/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/40-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86-ACL/","excerpt":"1.acl 访问控制列表2.配置ACl禁止2.1访问 1234[Huawei] acl 2000 //定义基本acl,列表号是2000[Huawei-acl-basic-2000] rule deny source 192.168.2.1 0 //源地址是192.168.2.1的数据通过[Huawei] interface GigabitEthernet 0/0/1[Huawei-GigabitEthernet0/0/1] traffic-filter inbound acl 2000 //进入接口后,应用acl","text":"1.acl 访问控制列表2.配置ACl禁止2.1访问 1234[Huawei] acl 2000 //定义基本acl,列表号是2000[Huawei-acl-basic-2000] rule deny source 192.168.2.1 0 //源地址是192.168.2.1的数据通过[Huawei] interface GigabitEthernet 0/0/1[Huawei-GigabitEthernet0/0/1] traffic-filter inbound acl 2000 //进入接口后,应用acl 3.只允许2.1访问，其他禁止访问1,允许2.1通过2,拒绝所有人通过[Huawei] acl 2000[Huawei-acl-basic-2000]undo rule 5 &#x2F;&#x2F;删除旧规则[Huawei-acl-basic-2000]rule permit source 192.168.2.1 0 &#x2F;&#x2F;创建新规则允许2.1通过[Huawei-acl-basic-2000]rule deny source any &#x2F;&#x2F;拒绝所有人[Huawei] interface GigabitEthernet 0&#x2F;0&#x2F;1[Huawei-GigabitEthernet0&#x2F;0&#x2F;1] traffic-filter inbound acl2000 &#x2F;&#x2F;在接口的入方向应用规则,如果之前应用过则不用设置 4.使用高级acl满足新需求:注意先要在g0&#x2F;0&#x2F;1口中,删除acl 2000 命令是,进入接口后,输入: undo trafficfilter inbound 123[Huawei] acl 3000[Huawei-acl-adv-3000]rule deny tcp source 192.168.2.1 0 destination 192.168.1.1 0 destination-port eg 21 //拒绝2.1访问1.1的21号端口(ftp服务) 12[Huawei-acl-adv-3000]rule deny tcp source 192.168.2.2 0 destination 192.168.1.1 0 destination-port eq 80//拒绝2.2访问1.1的80号端口(http服务","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"10-地址重写","slug":"运维/nginx/10-地址重写","date":"2021-09-10T03:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2021/09/10/运维/nginx/10-地址重写/","link":"","permalink":"https://dbbruce.github.io/2021/09/10/%E8%BF%90%E7%BB%B4/nginx/10-%E5%9C%B0%E5%9D%80%E9%87%8D%E5%86%99/","excerpt":"1.地址重写(地址栏被重写)rewrite regex replacement flagrewrite 旧地址 新地址 [选项]http://www.a.com/a.html &gt;&gt;&gt;&gt; http://www.a.com/a.html 12345server &#123; listen 80; server_name www.a.com; # 地址栏不变化 rewrite /a.html b.html;","text":"1.地址重写(地址栏被重写)rewrite regex replacement flagrewrite 旧地址 新地址 [选项]http://www.a.com/a.html &gt;&gt;&gt;&gt; http://www.a.com/a.html 12345server &#123; listen 80; server_name www.a.com; # 地址栏不变化 rewrite /a.html b.html; redirect 地址栏变化http://www.a.com/a.html &gt;&gt;&gt; http://www.a.com/b.html 12345server &#123; listen 80; server_name www.a.com; rewrite /a.html /b.html redirect; 2. 修改配置文件 访问www.a.com的请求重定向至 https://dbbruce.github.io12345server &#123; listen 80; server_name www.a.com; rewrite ^/ https://dbbruce.github.io; 3.修改配置文件(访问192.168.45&#x2F;下面子页面，重定向至www.tmooc.cn/下相同的页面)域名修改，路径不变比如访问 www.a.com/home &gt;&gt;&gt; www.b.com/home 12345server &#123; listen 80; server_name www.a.com; rewrite ^/(.*) www.b.com/$1; # (xxx)保留提前 $1 复制粘贴 4.根据不同来源跳转不同页面，比如手机端和电脑端1234567server &#123; listen 80; server_name www.a.com; if ($http_user_agent ~* firefox)&#123; rewrite ^/(.*) /firefox/$1; &#125; 5.地址重写格式rewrite 旧地址 新地址[选项]last 不再读其他rewrite 12rewrite /a.html /b.html last;rewrite /b.html /d.html ; brehk 不再读其他语句，结束请求 12rewrite /a.html /b.html break;rewrite /b.html /d.html ; redirect 临时重定向 1rewrite /a.html /b.html redirect; permament 永久重定向 1rewrite /a.html /b.html permament;","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"nginx","slug":"运维/nginx","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/nginx/"}],"tags":[]},{"title":"39-网络管理-传输层解析","slug":"运维/Linux云计算教程/39-网络管理-传输层解析","date":"2021-09-09T03:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2021/09/09/运维/Linux云计算教程/39-网络管理-传输层解析/","link":"","permalink":"https://dbbruce.github.io/2021/09/09/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/39-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86-%E4%BC%A0%E8%BE%93%E5%B1%82%E8%A7%A3%E6%9E%90/","excerpt":"1.传输层的作用网络层：提供点到点的连接传输层：提供端到端的连接","text":"1.传输层的作用网络层：提供点到点的连接传输层：提供端到端的连接 2.传输层的协议TCP ( Transmission Control Protocol )传输控制协议可靠的、面向连接的协议传输效率低 UDP ( User Datagram Protocol )用户数据报协议不可靠的、无连接的服务传输效率高 3.TCP的封装格式6个标志位，下面3个很重要tcp建立链接标志位: 123syn 打算建立连接ack 确认fin 打算断开连接 4.TCP&#x2F;IP协议族的组成 5.TCP三次握手 6.TCP的四次断开 7.TCP应用tcp: ftp 21 http 80 smtp 25 ssh 22 https 443 dns 53 mariadb 3306 udp： tftp 69 dns 53 ntp 123","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"09-日志","slug":"运维/nginx/09-日志","date":"2021-09-09T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/09/09/运维/nginx/09-日志/","link":"","permalink":"https://dbbruce.github.io/2021/09/09/%E8%BF%90%E7%BB%B4/nginx/09-%E6%97%A5%E5%BF%97/","excerpt":"1.访问日志tailf 动态看 1tailf -10 /usr/local/nginx/logs/error.log Nginx的默认访问日志文件为&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;access.log 1234567891011[root@master conf]# tail -10f /usr/local/nginx/logs/access.log192.168.1.9 - - [05/Sep/2021:03:39:47 +0800] &quot;GET / HTTP/1.1&quot; 200 615 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15&quot;192.168.1.9 - - [05/Sep/2021:03:40:43 +0800] &quot;GET / HTTP/1.1&quot; 200 615 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15&quot;192.168.1.9 - - [05/Sep/2021:03:40:43 +0800] &quot;GET /favicon.ico HTTP/1.1&quot; 404 153 &quot;https://www.b.com/&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15&quot;192.168.1.9 - - [05/Sep/2021:03:42:06 +0800] &quot;GET / HTTP/1.1&quot; 200 615 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Safari/537.36&quot;192.168.1.9 - - [05/Sep/2021:05:16:04 +0800] &quot;GET / HTTP/1.1&quot; 304 0 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15&quot;192.168.1.9 - - [05/Sep/2021:05:16:06 +0800] &quot;GET / HTTP/1.1&quot; 200 615 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15&quot;192.168.1.9 - - [05/Sep/2021:05:16:06 +0800] &quot;GET /favicon.ico HTTP/1.1&quot; 404 153 &quot;http://www.a.com/&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15&quot;192.168.1.9 - - [05/Sep/2021:05:16:26 +0800] &quot;GET / HTTP/1.1&quot; 304 0 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15&quot;192.168.1.9 - - [05/Sep/2021:05:31:43 +0800] &quot;GET / HTTP/1.1&quot; 304 0 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15&quot;192.168.1.9 - - [05/Sep/2021:05:31:46 +0800] &quot;GET /test.php HTTP/1.1&quot; 200 12 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15&quot;","text":"1.访问日志tailf 动态看 1tailf -10 /usr/local/nginx/logs/error.log Nginx的默认访问日志文件为&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;access.log 1234567891011[root@master conf]# tail -10f /usr/local/nginx/logs/access.log192.168.1.9 - - [05/Sep/2021:03:39:47 +0800] &quot;GET / HTTP/1.1&quot; 200 615 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15&quot;192.168.1.9 - - [05/Sep/2021:03:40:43 +0800] &quot;GET / HTTP/1.1&quot; 200 615 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15&quot;192.168.1.9 - - [05/Sep/2021:03:40:43 +0800] &quot;GET /favicon.ico HTTP/1.1&quot; 404 153 &quot;https://www.b.com/&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15&quot;192.168.1.9 - - [05/Sep/2021:03:42:06 +0800] &quot;GET / HTTP/1.1&quot; 200 615 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Safari/537.36&quot;192.168.1.9 - - [05/Sep/2021:05:16:04 +0800] &quot;GET / HTTP/1.1&quot; 304 0 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15&quot;192.168.1.9 - - [05/Sep/2021:05:16:06 +0800] &quot;GET / HTTP/1.1&quot; 200 615 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15&quot;192.168.1.9 - - [05/Sep/2021:05:16:06 +0800] &quot;GET /favicon.ico HTTP/1.1&quot; 404 153 &quot;http://www.a.com/&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15&quot;192.168.1.9 - - [05/Sep/2021:05:16:26 +0800] &quot;GET / HTTP/1.1&quot; 304 0 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15&quot;192.168.1.9 - - [05/Sep/2021:05:31:43 +0800] &quot;GET / HTTP/1.1&quot; 304 0 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15&quot;192.168.1.9 - - [05/Sep/2021:05:31:46 +0800] &quot;GET /test.php HTTP/1.1&quot; 200 12 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15&quot; 2. 错误日志Nginx的默认错误日志文件为&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;error.log 1234567891011[root@master conf]# tail -10f /usr/local/nginx/logs/error.log2021/09/05 03:27:55 [emerg] 18340#0: cannot load certificate &quot;/usr/local/nginx/conf/cert.pem&quot;: PEM_read_bio_X509_AUX() failed (SSL: error:0906D06C:PEM routines:PEM_read_bio:no start line:Expecting: TRUSTED CERTIFICATE)2021/09/05 03:29:45 [emerg] 18408#0: cannot load certificate &quot;/usr/local/nginx/conf/cert.pem&quot;: PEM_read_bio_X509_AUX() failed (SSL: error:0906D06C:PEM routines:PEM_read_bio:no start line:Expecting: TRUSTED CERTIFICATE)2021/09/05 03:32:24 [notice] 18492#0: signal process started2021/09/05 03:36:51 [error] 18493#0: *66 open() &quot;/usr/local/nginx/html/favicon.ico&quot; failed (2: No such file or directory), client: 192.168.1.9, server: www.b.com, request: &quot;GET /favicon.ico HTTP/1.1&quot;, host: &quot;www.b.com&quot;, referrer: &quot;https://www.b.com/&quot;2021/09/05 03:37:51 [error] 18493#0: *71 open() &quot;/usr/local/nginx/html/favicon.ico&quot; failed (2: No such file or directory), client: 192.168.1.9, server: www.b.com, request: &quot;GET /favicon.ico HTTP/1.1&quot;, host: &quot;www.b.com&quot;, referrer: &quot;https://www.b.com/&quot;2021/09/05 03:40:43 [error] 18493#0: *72 open() &quot;/usr/local/nginx/html/favicon.ico&quot; failed (2: No such file or directory), client: 192.168.1.9, server: www.b.com, request: &quot;GET /favicon.ico HTTP/1.1&quot;, host: &quot;www.b.com&quot;, referrer: &quot;https://www.b.com/&quot;2021/09/05 05:10:33 [notice] 20422#0: signal process started2021/09/05 05:16:00 [notice] 20559#0: signal process started2021/09/05 05:16:06 [error] 20560#0: *79 open() &quot;/usr/local/nginx/html/favicon.ico&quot; failed (2: No such file or directory), client: 192.168.1.9, server: www.a.com, request: &quot;GET /favicon.ico HTTP/1.1&quot;, host: &quot;www.a.com&quot;, referrer: &quot;http://www.a.com/&quot;2021/09/05 05:29:04 [notice] 20876#0: signal process started 3.日志格式123456789$remote_addr 远端地址$remote_user 用户名$time_local 时间$request 访问地址：方法和地址 协议/版本$status 状态$body_bytes_sent 访问字节数，多大$http_referer 访问来源$http_user_agent 代理 UA，浏览器$http_x_forwarded_for 真实IP","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"nginx","slug":"运维/nginx","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/nginx/"}],"tags":[]},{"title":"38-网络管理-三层交换机","slug":"运维/Linux云计算教程/38-网络管理-三层交换机","date":"2021-09-08T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/09/08/运维/Linux云计算教程/38-网络管理-三层交换机/","link":"","permalink":"https://dbbruce.github.io/2021/09/08/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/38-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86-%E4%B8%89%E5%B1%82%E4%BA%A4%E6%8D%A2%E6%9C%BA/","excerpt":"1.交换机和路由器区别交换机：数据帧转发，使用IP进行数据转发路由器：不同网段的路由转发，交换机不能直接配置ip，使用mac地址数据转发","text":"1.交换机和路由器区别交换机：数据帧转发，使用IP进行数据转发路由器：不同网段的路由转发，交换机不能直接配置ip，使用mac地址数据转发 2.三层交换机 &#x3D; 交换机 + 路由器交换机不支持直接配置IP，三层交换机在vlan中配置ip 123456789101112131415161718// 创建VLAN[Huawei]vlan batch 1 to 3//进入虚拟接口vlan1[Huawei]interface Vlanif 1 //简写 in v1[Huawei-Vlanif1] ip address 192.168.1.254 24[Huawei] interface Vlanif 2[Huawei-Vlanif1] ip address 192.168.2.254 24[Huawei] interface Vlanif 3[Huawei-Vlanif1] ip address 192.168.3.254 24//将2口加入vlan2[Huawei] interface g0/0/2 [Huawei-GigabitEthernet0/0/2] port link-type access[Huawei-GigabitEthernet0/0/2] port default vlan 2[Huawei] interface g0/0/3[Huawei-GigabitEthernet0/0/3] port link-type access[Huawei-GigabitEthernet0/0/3] port default vlan 3 3.查看设备的ip地址配置情况1display ip interface brief 4.s5700为接口配置ip思路1,创建新vlan2,进入此vlan,配置ip3,将接口加入此vlan 5.配置动态路由使用动态路由协议ospf配置网络,达到全网互通的目的 三层交换机1,开启ospf 12[Huawei] ospf 1[Huawei-ospf-1] area 0 //区域0,默认的首个区域必须使用0 2,宣告所在网段 1234[Huawei-ospf-1-area-0.0.0.0] network 192.168.1.0 0.0.0.255[Huawei-ospf-1-area-0.0.0.0] network 192.168.2.0 0.0.0.255[Huawei-ospf-1-area-0.0.0.0] network 192.168.3.0 0.0.0.255[Huawei-ospf-1-area-0.0.0.0] network 192.168.4.0 0.0.0.255 3,配置默认路由,使三层交换机可以到达外部网络任意地址 1[Huawei] ip route-static 0.0.0.0 0.0.0.0 192.168.4.2 路由器1,开启ospf2,宣告所在网段 1[Huawei-ospf-1-area-0.0.0.0] network 192.168.4.0 0.0.0.255 多使用查看路由表验证配置1display ip routing-table 6.一个比较典型的企业网络","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"08-动静分离","slug":"运维/nginx/08-动静分离","date":"2021-09-08T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/09/08/运维/nginx/08-动静分离/","link":"","permalink":"https://dbbruce.github.io/2021/09/08/%E8%BF%90%E7%BB%B4/nginx/08-%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB/","excerpt":"1.location 匹配用户的地址栏 支持正则 从&#x2F;开始匹配 “&#x2F;“匹配级最低，最后匹配根&#x2F;12http://www.baidu.com/test# 从/test开始匹配","text":"1.location 匹配用户的地址栏 支持正则 从&#x2F;开始匹配 “&#x2F;“匹配级最低，最后匹配根&#x2F;12http://www.baidu.com/test# 从/test开始匹配 123location /abc &#123; deny all;&#125;location /ttt &#123; allow 1.1.1.1;&#125;location /test &#123; allow all;&#125; 2. location正则匹配 ~符号： ~ （波浪线） 1234# 匹配 以 .php结尾location ~ \\.php$ &#123; root html;&#125; 3.php配置nginx123456location ~ \\.php$ &#123; root html; fastcgi_pass 127.0.0.1:9000; fastcgi_index index.php; include fastcgi.conf;&#125;","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"nginx","slug":"运维/nginx","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/nginx/"}],"tags":[]},{"title":"37-网络管理-路由器","slug":"运维/Linux云计算教程/37-网络管理-路由器","date":"2021-09-07T03:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2021/09/07/运维/Linux云计算教程/37-网络管理-路由器/","link":"","permalink":"https://dbbruce.github.io/2021/09/07/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/37-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86-%E8%B7%AF%E7%94%B1%E5%99%A8/","excerpt":"1.路由器传递不同网络的数据路由器是连接两个或多个网络的硬件设备解决不同IP段的通信问题","text":"1.路由器传递不同网络的数据路由器是连接两个或多个网络的硬件设备解决不同IP段的通信问题 2.为路由器的接口配置IP地址12[Huawei] interface GigabitEthernet 0/0/0 //进入对应接口 简写: in g0/0/0[Huawei-GigabitEthernet0/0/0] ip address 192.168.1.254 24 3.ICMP协议Internet控制报文协议,可以传递网状状态信息工具：ping -t 持续ping -l 2000 指定包大小 -c ping的次数 -i 每隔多久ping一次,单位是秒 -w 反馈结果的时间,如果不通时可加快反馈时间,单位是秒 4.解决不同网段通信的问题 路由器配置不同网段的IP192.168.1.254192.168.2.254 主机网关配置路由器的地址 5.静态路由多路由，不同IP段通信ip route-static 目标网段 子网掩码 下一跳地址AR1 1ip route-static 192.168.3.0 24 192.168.2.2 AR2 1ip route-static 192.168.1.0 24 192.168.2.1 6.路由表查看路由表 1display ip routing-table 1ip route-static 192.168.4.0 24 192.168.2.2 direct 直连路由，由设备接口配置好IP并开启后，自动生成直连路由static 静态路由，由管理员手工配置 7.动态路由. 动态路由 基于某种路由协议实现.动态路由特点 减少了管理任务 占用了网络带宽 8.动态路由协议OSPF全称为Open Shortest Path First (开放式最短路径优先 )适合大中型网络使用 9.OSPF区域 为了适应大型的网络，OSPF在网络内部划分多个区域 为了适应大型的网络，OSPF在网络内部划分多个区域 10.区域ID 区域ID可以表示成一个十进制的数字 也可以表 示成一个IP 11.骨干区域Area 0 负责区域间路由信息传播 12.连接外网和内网一般使用：动态路由 + 默认路由直连路由静态路由动态路由 宣告默认路由 特殊的静态路由,可以匹配任意网段 13.配置动态路由1,开启ospf 123[Huawei] ospf 1[Huawei-ospf-1] area 0[Huawei-ospf-1-area-0.0.0.0] network 192.168.4.0 0.0.0.255 14.多使用查看路由表验证配置1display ip routing-table","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"07-LNMP","slug":"运维/nginx/07-lnmp","date":"2021-09-07T03:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2021/09/07/运维/nginx/07-lnmp/","link":"","permalink":"https://dbbruce.github.io/2021/09/07/%E8%BF%90%E7%BB%B4/nginx/07-lnmp/","excerpt":"1.LNMPl linuxN nginxM mariadbP php","text":"1.LNMPl linuxN nginxM mariadbP php 3.安装PHPphp 编译器php-fpm：进程管理服务 1yum -y install php php-mysql php-fpm 启动 123systemctl start php-fpm //启动服务systemctl status php-fpm //查看服务状态systemctl enable php-fpm //设置开机启动 12[root@master conf]# netstat -antpu |grep phptcp 0 0 127.0.0.1:9000 0.0.0.0:* LISTEN 19508/php-fpm: mast php-fpm配置文件 4.安装mariadb1yum -y install mariadb mariadb-server mariadb-devel 启动 123systemctl start mariadb //启动服务器systemctl status mariadb //查看服务状态systemctl enable mariadb //设置开机启动 12[root@master conf]# netstat -antpu |grep mysql # 这里叫mysqltcp 0 0 0.0.0.0:3306 0.0.0.0:* LISTEN 19775/mysqld 5.PHP默认错误日志文件为&#x2F;var&#x2F;log&#x2F;php-fpm&#x2F;www-error.log1234[root@master conf]# tail -10f /var/log/php-fpm/error.log[05-Sep-2023 04:30:02] NOTICE: fpm is running, pid 19508[05-Sep-2023 04:30:02] NOTICE: ready to handle connections[05-Sep-2023 04:30:02] NOTICE: systemd monitor interval set to 10000ms","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"nginx","slug":"运维/nginx","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/nginx/"}],"tags":[]},{"title":"36-网络管理-交换机","slug":"运维/Linux云计算教程/36-网络管理-交换机","date":"2021-09-06T03:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2021/09/06/运维/Linux云计算教程/36-网络管理-交换机/","link":"","permalink":"https://dbbruce.github.io/2021/09/06/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/36-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86-%E4%BA%A4%E6%8D%A2%E6%9C%BA/","excerpt":"1.OSIOSI（Open System Interconnect），即开放式系统互联。是OSI组织为了互联网各层之间协作而制定的标准模型。再具体点来说是为了使互联网各个基础组件厂商统一标准而制定的标准，这样就能实现互联了。OSI七层模型的划分OSI划分为：物理层、数据链路层、网络层、传输层、会话层、表示层、应用层","text":"1.OSIOSI（Open System Interconnect），即开放式系统互联。是OSI组织为了互联网各层之间协作而制定的标准模型。再具体点来说是为了使互联网各个基础组件厂商统一标准而制定的标准，这样就能实现互联了。OSI七层模型的划分OSI划分为：物理层、数据链路层、网络层、传输层、会话层、表示层、应用层 2.一张图先了解各层间的基本功能 3.TCP&#x2F;IP协议,TCP&#x2F;IP五层模型 4.TCP&#x2F;IP协议族的组成 5.数据封装与解封装传输过程数据的流向是 发送端A–&gt;接收端B，然后途径两个过程A：应用层 –&gt; 物理层：数据封装过程B：物理层 –&gt; 应用层：数据解封装过程数据从应用层开始向下层流动，经过层层封装，最终在物理层转为字节流发送到接收方。 注意以下 源 &#x3D;&#x3D; 发送方，目标 &#x3D;&#x3D; 接收方经过传输层：加上TCP头，组成数据段，所谓的TCP头主要就是加上对源端口和目标端口的描述。经过网络层：加上IP头，组成数据包，IP头其实就是源IP和目标IP。经过数据链路层：加上MAC头，组成数据帧，MAC头其实就是源MAC和目标MAC。另外还有一个LLC头和一个FCS帧尾标识（用于差错检测）经过物理层：将数据帧转为bit流，发送到接收方对应数据封装过程，解封装过程数据从物理层向上层流动，最终经过层层解封，到达对应的应用程序。各层数据流名称 6.网络模拟软件eNSP放在百度云盘了https://pan.baidu.com/disk/main#/index?category=all&amp;path=%2F 7.交换机的命令行视图 华为交换机的命令行 用户视图 # 带尖括号的是用户视图 系统视图system-view # 输入system-view 进入系统视图[Huaweil] # 带中括号的是系统视图 接口视图[Huawei] interface Ethernet0&#x2F;0&#x2F;1 # 百兆接口，E开头[Huawei-Ethernet0&#x2F;0&#x2F;1] # 进入接口视图[Huawei-Ethernet0&#x2F;0&#x2F;1] interface Ethernet0&#x2F;0&#x2F;2[Huawei-Ethernet0&#x2F;0&#x2F;2]interface : 接口Ethernet : 接门类型0&#x2F;0&#x2F;1 : 第一个“0”代表槽位号，第二个“0”代表了卡号，“1”代表接口号 返回上一个视图[Huawei-Ethernet0&#x2F;0&#x2F;1] quit # 快捷键 ctrl+z 视图间转换quit命令return命令快捷键&lt;Ctrl+Z回到用户视图 8.修改交换机主机名123&lt;Huawei&gt;system-view[Huawei]sysname SW1[SW1] 9.显示VRP版本[Huawei] display version 10.看ios名称及版本信息[Huawei]display current-configuration 11.使用账户和密码登录终端12345601.&lt;Huawei&gt; system-view02.[Huawei]aaa //进入aaa认证03.[Huawei-aaa] localuser admin01 password cipher 123 ### cipher将密码加密04.[Huawei-aaa] quit05.[Huawei] user-interface console 006.[Huawei-ui-consoleo] authentication-mode aaa 12.保存交换机的配置save 13.恢复设备出厂默认值1234567891011121314151617181920//重置配置文件&lt;Huawei&gt;reset saved-configuration //恢复设备Warning: The action will delete the saved configuration in the deThe configuration will be erased to reconfigure. Continue? [Y/N]:Warning: Now clearing the configuration in the device.Mar 12 2019 19:13:50-08:00 Huawei %%01CFM/4/RST CFG(deciding whether tp reset the saved configuration.Info: Succeeded in clearing the configuration in the deviceTop//重启设备&lt;Huawei&gt;reboot Info: The system is now comparing the configuration, please waitWarning: All the configuration will be saved to the configuration fi//提示是否再次保存，选指ext startup:, Continue?[Y/N]:n //第一个NInfo: If want to reboot with saving diagnostic information, inputxecute &#x27;reboot save diagnostic-information&#x27;System will rebootl Continue?[Y/N]:y // 第二个Y 14.各层对应的机器 应用层 pc 传输层 防火墙 数据段 网络层 路由器 数据包 数据链路层 交换机 数据帧 物理层 网卡 比特流 0101010110 15.以太网MAC地址MAC：十六进制：82:17:0d:ef:fb:00 12345en1: flags=8963&lt;UP,BROADCAST,SMART,RUNNING,PROMISC,SIMPLEX,MULTICAST&gt; mtu 1500 options=460&lt;TSO4,TSO6,CHANNEL_IO&gt; ether 82:17:0d:ef:fb:00 # 以太网，MAC地址 media: autoselect &lt;full-duplex&gt; status: inactive 用来识别一个以太网上的某个单独的设备或一组设备 16.单播 1对1组播 1对多广播 1对所有 17.数据帧mtu:最大字节1500 12345en1: flags=8963&lt;UP,BROADCAST,SMART,RUNNING,PROMISC,SIMPLEX,MULTICAST&gt; mtu 1500 # 这里 options=460&lt;TSO4,TSO6,CHANNEL_IO&gt; ether 82:17:0d:ef:fb:00 media: autoselect &lt;full-duplex&gt; status: inactive 数据链路层的协议数据单元 18.交换机工作原理学习：学习源mac地址,记录对应的接口号广播：向除了数据来源之外的所有接口发送信息转发：1对1进行数据传递更新：超过300秒无任何数据通讯.mac地址记录将被删除接口设备更换,或者接口down掉 19.交换机查看mac地址表display mac-address 20.vlan相同广播域0，交换机默认创建vlan11,控制广播2,增加安全3,提高带宽利用率4,降低数据延迟 21.创建vlan 1、创建vlan123[Huawei]vlan 2[Huawei]vlan batch 2 3 4 //创建VLAN2、3[Huawei]vlan batch 2 to 3 2、查看vlan信息1[Huawei]display vlan 3、将交换机3口添加到vlan2 （单口加法）123[Huawei] interface Ethernet0/0/3 //进入3口[Huawei-Ethernet0/0/3] port link-type access //将3口设置为access模式,即将加入某vlan(头某一vlan服务)[Huawei-Ethernet0/0/3] port default vlan 2 //将3门加入vlan2 3、将交换机3口，4口添加到vlan2 （多口加法）1234[Huawei]port-group 1 //创建1号接口组[Huawei-port-group-1]group-member Ethernet0/0/3 Ethernet0/0/4 //添加成员 5口 6口[Huawei-port-group-1]port link-type access[Huawei-port-group-1]port default vlan 2 //将此组中所有接口加入vlan3 1[Huawei]undo vlan 4 //如果创建vlan错误,可以使用undo删除 1&lt;Huawei&gt;undo terminal monitor //关闭提示信息 22.trunktrunk： 1条链路上可以承载多个vlan access(接入链路)承载1个vlantrunk(中继链路)可以承载多个vlan 123[Huawei]interface Ethernet0/0/10[Huawei-Ethernet0/0/10]port link-type trunk //将接口类型设置为trunk[Huawei-Ethernet0/0/10]port trunk allow-pass vlan all //允许通过所有vlan 23.恢复接口的默认配置123[Huawei]clear configuration interface ethernet 0/0/7//恢复接口的默认配置,被改动过配置的接口无法直接配置trunk,可以通过此命令恢复,恢复之后的接口不要忘记从新进入此接口使用undo shutdown命令开启接 24.配置链路聚合,增加网络可靠,提高带宽[Huawei]interface Eth-trunk 1 &#x2F;&#x2F;进入(创建) 1号聚合接口[Huawei- Eth-trunk1]trunkport ethernet 0&#x2F;0&#x2F;1 0&#x2F;0&#x2F;2 &#x2F;&#x2F;添加2个需要捆绑在一起的接口[Huawei- Eth-trunkl]port link-type trunk &#x2F;&#x2F;将1号聚合接口配置trunk[Huawei- Eth-trunk1]port trunk allow-pass vlan all &#x2F;&#x2F;允许1号聚合接口传递所有vlan的数据","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"06-配置证书","slug":"运维/nginx/06-配置证书","date":"2021-09-06T03:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2021/09/06/运维/nginx/06-配置证书/","link":"","permalink":"https://dbbruce.github.io/2021/09/06/%E8%BF%90%E7%BB%B4/nginx/06-%E9%85%8D%E7%BD%AE%E8%AF%81%E4%B9%A6/","excerpt":"1.名词解释 私钥 自己生成 CSR公钥 由私钥生成 CRT证书 公钥 + 签名 证书 server.crt 文件就是证书 签名 使用私钥key与公钥csr进行证书crt生成的构成叫签名 注意：证书都是买的，个人的浏览器不认同","text":"1.名词解释 私钥 自己生成 CSR公钥 由私钥生成 CRT证书 公钥 + 签名 证书 server.crt 文件就是证书 签名 使用私钥key与公钥csr进行证书crt生成的构成叫签名 注意：证书都是买的，个人的浏览器不认同 2.生成私钥openssl genrsa &gt; cert.key 12345678910[root@master .ssh]# cd /usr/local/nginx/conf/[root@master conf]# openssl genrsa &gt; cert.keyGenerating RSA private key, 2048 bit long modulus.....................................................+++.....................................+++e is 65537 (0x10001)[root@master conf]# ll总用量 76-rw-r--r--. 1 root root 1675 9月 5 02:55 cert.key[root@master conf]# 1234567891011[root@master conf]# cat cert.key-----BEGIN RSA PRIVATE KEY-----MIIEowIBAAKCAQEA5r/5DzMVBaE/2xTh3wR2xTAzE2j+jMO/GBWxBjsgJN8ISL0h5QO9K/sG1S7d+F9tPoRXZlpGC2EKX08kAoKSF3UhXVVb8dIVSBcG0gQIFv6hQFccX8neL3eXEivz0TmbH4iqA58SIXNCuS1+AB0RNcfImfj4aGZLBzaKm8WLQlEuFB6/rDeU0hvNpjyTxK2wt+8JkdWhR66heDYyDybQyMRsoUV10H523CRVJWqWV0MlLPRlkpZGLSsTOpMeclFgMMqyoBsqjx39vQWST/YqwUMOkZOHRpzKnsKGv7vRIQfes+mK2bHgQQKBgA+Tg0Bs+9qoCTy7IT3vMsvq/9ovvCey6RX1/7tokkWSnvG4sEUkLnp2zDatfNruf18NfFZ+s4eb7lzhBW5Xh2a778xLzIje3K1zbODWtaI+mVkvVCGI4JJR4hLc9TDIPqzdicQGGOpcgQgI/PsOY+5HOLrXBiwvgHH24vgLrX0m-----END RSA PRIVATE KEY----- 3.生成证书 .pem文件这里 -x509很重要，不指定报错，nginx1.22版本 12345678910111213141516171819[root@master conf]# openssl req -new -x509 -key cert.key &gt; cert.pemYou are about to be asked to enter information that will be incorporatedinto your certificate request.What you are about to enter is what is called a Distinguished Name or a DN.There are quite a few fields but you can leave some blankFor some fields there will be a default value,If you enter &#x27;.&#x27;, the field will be left blank.-----Country Name (2 letter code) [XX]:CNState or Province Name (full name) []:bjLocality Name (eg, city) [Default City]:bjOrganization Name (eg, company) [Default Company Ltd]:dOrganizational Unit Name (eg, section) []:dCommon Name (eg, your name or your server&#x27;s hostname) []:c01Email Address []:dbbrcue@163.com[root@master conf]# ll总用量 80-rw-r--r--. 1 root root 1675 9月 5 02:55 cert.key-rw-r--r--. 1 root root 1033 9月 5 03:00 cert.pem 123456[root@master conf]# cat cert.pem-----BEGIN CERTIFICATE REQUEST-----MIICwTCCAakCAQAwfDELMAkGA1UEBhMCY24xEDAOBgNVBAgMB2JlaWppbmcxEDAOBgNVBAcMB2JlaWppbmcxDTALBgNVBAoMBGRvbmcxDTALBgNVBAsMBGRvbmcxCzAJA99LBhOy5Qo356YC485QTWITg7IFufaEiDTEotSIetouqOWtd80N8y5G7VbTmd0u-----END CERTIFICATE REQUEST----- 4.配置私钥和证书123456789101112131415161718server &#123; listen 443 ssl; # 443端口 server_name www.b.com; ssl_certificate cert.pem; #证书，加密 ssl_certificate_key cert.key; # 私钥，解密 ssl_session_cache shared:SSL:1m; ssl_session_timeout 5m; #超时时间5分钟 ssl_ciphers HIGH:!aNULL:!MD5; #加密方式 ssl_prefer_server_ciphers on; #开启加密 location / &#123; root html; index index.html index.htm; &#125;&#125; 1[root@master conf]# /usr/local/nginx/sbin/nginx -s reload 5.查看 6.证书的过期时间1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859[root@centos07-22 conf]# openssl x509 -in cert.pem -noout -textCertificate: Data: Version: 3 (0x2) Serial Number: c1:a1:27:fc:9d:be:4c:9d Signature Algorithm: sha256WithRSAEncryption Issuer: C=CN, ST=BJ, L=BJ, O=dong, OU=dong, CN=dong/emailAddress=dbbruce@163.com Validity Not Before: Sep 15 16:20:54 2023 GMT # 证书之前不能用 2023年09月15号前，无效 Not After : Oct 15 16:20:54 2023 GMT # 证书之后不能用，2023年10月15号后，无效 Subject: C=CN, ST=BJ, L=BJ, O=dong, OU=dong, CN=dong/emailAddress=dbbruce@163.com Subject Public Key Info: Public Key Algorithm: rsaEncryption Public-Key: (2048 bit) Modulus: 00:a9:94:45:ea:0a:2b:42:05:16:cf:5b:c1:af:ef: ab:64:cb:9d:da:08:bb:34:5e:58:83:03:35:32:ea: f1:14:0a:f9:74:2e:82:1a:82:61:ff:7c:70:38:9b: 93:7c:c8:86:93:88:09:c7:f9:72:e0:50:8d:29:b4: c2:e3:61:45:b7:4c:2b:6f:c1:88:15:d0:4c:9c:4f: 9f:21:a9:d5:a7:a1:3c:b6:65:7b:c9:78:01:da:4a: 54:2c:8e:8d:6d:47:40:ac:82:c5:ea:49:5b:86:9e: 12:a6:da:46:e9:d1:c7:9f:23:c8:be:ec:ca:5f:65: dd:bf:15:1b:2f:82:31:9f:8e:6a:2e:80:6d:19:7a: c8:c5:a3:a5:ea:60:79:fb:c9:14:d2:cb:a9:5f:e5: 92:47:5d:40:55:40:22:b6:16:6d:fd:84:3c:5a:b1: b9:02:1f:55:cb:12:85:e3:ad:a6:e1:c8:f6:38:67: bd:a0:e9:2b:32:53:e0:ba:cb:8f:a1:4d:83:11:58: 30:fd:62:3f:f9:cb:3b:19:27:16:74:a2:19:3a:47: 6e:f3:0c:f2:e6:98:ce:54:d7:5a:f1:66:9e:a5:ae: 89:79:b8:75:c2:70:a3:92:98:c4:8e:ba:11:88:76: c6:eb:44:7a:06:7d:b9:59:9d:91:1f:7b:b1:68:bc: fb:05 Exponent: 65537 (0x10001) X509v3 extensions: X509v3 Subject Key Identifier: 15:C4:F4:E2:FA:36:48:A6:93:10:B2:BF:9B:84:4D:0F:7A:C8:22:29 X509v3 Authority Key Identifier: keyid:15:C4:F4:E2:FA:36:48:A6:93:10:B2:BF:9B:84:4D:0F:7A:C8:22:29 X509v3 Basic Constraints: CA:TRUE Signature Algorithm: sha256WithRSAEncryption 45:ac:7d:e9:7c:8a:2a:ae:f8:1f:dd:1f:09:14:e7:4e:98:12: b2:1d:5c:a8:20:89:c0:3d:e2:b9:9f:48:43:75:28:d5:aa:84: e8:ca:66:54:e2:66:2a:ba:56:60:4f:e6:4d:2f:76:0f:4d:ce: 9c:b3:bf:68:29:d7:b7:b4:52:b7:fa:a6:3f:56:96:4c:98:97: 40:a5:de:bc:1a:55:ec:de:4d:75:63:e9:a2:87:c5:57:ee:b1: e6:c5:69:47:42:13:c6:4f:60:85:7e:90:35:5a:9a:9c:02:f8: 90:b4:1e:63:d8:76:97:47:23:2e:97:3e:59:c6:71:a2:03:46: 16:41:06:3d:c5:81:39:e0:10:bd:35:13:27:14:02:45:d8:ab: 01:50:65:d9:ca:7d:0a:ad:f9:1b:a7:9e:05:34:bd:1f:48:41: 28:56:76:1f:91:1c:7a:b4:0a:1d:a1:b0:2a:6d:30:fb:d2:27: 02:1c:0a:bb:4b:71:75:27:bc:a8:25:28:97:e7:8b:d0:e9:dc: 56:84:ce:33:c0:ea:89:2d:c6:09:66:fa:b3:9e:79:97:a0:ae: 2e:a3:2a:4a:93:66:be:80:d6:78:94:12:db:86:ee:81:c0:76: 6d:7c:c3:c9:f6:0d:da:87:bf:4e:53:f0:c3:32:3b:83:60:98: 2d:19:9b:6c","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"nginx","slug":"运维/nginx","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/nginx/"}],"tags":[]},{"title":"35-Cobbler部署","slug":"运维/Linux云计算教程/35-Cobbler部署","date":"2021-09-05T03:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2021/09/05/运维/Linux云计算教程/35-Cobbler部署/","link":"","permalink":"https://dbbruce.github.io/2021/09/05/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/35-Cobbler%E9%83%A8%E7%BD%B2/","excerpt":"1.Cobbler简介基本概念 Cobbler是一款快速的网络系统部署工具 集中管理所需服务，如DHCP、DNS、TFTP、Web Cobbler内部集成了一个镜像版本仓库 Cobbler内部集成了一个ks应答文件仓库 Cobbler还提供了包括yum源管理、Web界面管理API接口、电源管理等功能","text":"1.Cobbler简介基本概念 Cobbler是一款快速的网络系统部署工具 集中管理所需服务，如DHCP、DNS、TFTP、Web Cobbler内部集成了一个镜像版本仓库 Cobbler内部集成了一个ks应答文件仓库 Cobbler还提供了包括yum源管理、Web界面管理API接口、电源管理等功能","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"05-加密和解密","slug":"运维/nginx/05-加密和解密","date":"2021-09-05T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/09/05/运维/nginx/05-加密和解密/","link":"","permalink":"https://dbbruce.github.io/2021/09/05/%E8%BF%90%E7%BB%B4/nginx/05-%E5%8A%A0%E5%AF%86%E5%92%8C%E8%A7%A3%E5%AF%86/","excerpt":"1.加密算法一般分为对称算法、非对称算法、信息摘要对称算法有 : AES、DES，主要应用在单机数据加密非对称算法有 : RSA、DSA，主要应用在网络数据加密信息摘要:MD5、sha256，主要应用在数据完整性校验","text":"1.加密算法一般分为对称算法、非对称算法、信息摘要对称算法有 : AES、DES，主要应用在单机数据加密非对称算法有 : RSA、DSA，主要应用在网络数据加密信息摘要:MD5、sha256，主要应用在数据完整性校验 2.nginx使用ssl–with-http ssl module安装Nginx时必须使用–with-http ssl module参数，启用加密模块，对于需要进行SSL加密处理的站点，添加ssl相关指令 (设置网站需要的私钥和证书) 3.md5,信息摘要，文件完整性验证12[root@master conf]# md5sum nginx.conf991a45eee0b6ed7a18cb6837d38c1925 nginx.conf","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"nginx","slug":"运维/nginx","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/nginx/"}],"tags":[]},{"title":"34-inotify监控目录内容变化","slug":"运维/Linux云计算教程/34-inotify监控","date":"2021-09-04T03:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2021/09/04/运维/Linux云计算教程/34-inotify监控/","link":"","permalink":"https://dbbruce.github.io/2021/09/04/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/34-inotify%E7%9B%91%E6%8E%A7/","excerpt":"1.安装inotify 步骤1:安装make与gcc,开发工具12]# yum -y install make gcc 步骤2:tar解包,释放源代码至指定目录1]# tar -xf /tools/inotify-tools-3.13.tar.gz -C /usr/local 步骤3:&#x2F;configure 配置,指定安装目录&#x2F;功能模块等选项12]# cd /usr/localinotify-tools-3.13/]# ./confiqure 步骤4:make 编译,生成可执行的二进制程序文件1]# cd /usr/localinotify-tools-3.13]# make 步骤5: make instalL 安装,将编译好的文件复制到安装目录12]# cd /usr/localinotify-tools-3.13]# make install","text":"1.安装inotify 步骤1:安装make与gcc,开发工具12]# yum -y install make gcc 步骤2:tar解包,释放源代码至指定目录1]# tar -xf /tools/inotify-tools-3.13.tar.gz -C /usr/local 步骤3:&#x2F;configure 配置,指定安装目录&#x2F;功能模块等选项12]# cd /usr/localinotify-tools-3.13/]# ./confiqure 步骤4:make 编译,生成可执行的二进制程序文件1]# cd /usr/localinotify-tools-3.13]# make 步骤5: make instalL 安装,将编译好的文件复制到安装目录12]# cd /usr/localinotify-tools-3.13]# make install 2.基本用法inotifywait [选项] 目标文件央常用命令选项-m,持续监控(捕获一个事件后不退出)-r,递归监控、包括子目录及文件-q，减少屏幕输出信息1-e,指定监视的 modify、move、 create、delete、attrib 等事件类别 1234[root@master ~]# inotifywait - mrq /dir//dir/ OPEN,ISDIR/dir/CLOSE NOWRITE,CLOSE,ISDIR/dir/OPEN，ISDIRdirCLOSE NOWRITE,CLOSE,ISDIR/dir/ DELETE 10.txt 3.监控脚本12345678[rootasvr7 /]# vim /root/rsync.sh# !/bin/bashwhile inotifywait -rqq /dir/ do rsync -a --delete /dir/ root@192.168.4.207:/opt done[root@svr7 /]# chmod +x /root/rsync.sh# [root@svr7 /]# /root/rsync.sh","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"04-基于域名的虚拟主机","slug":"运维/nginx/04-基于域名的虚拟主机","date":"2021-09-04T03:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2021/09/04/运维/nginx/04-基于域名的虚拟主机/","link":"","permalink":"https://dbbruce.github.io/2021/09/04/%E8%BF%90%E7%BB%B4/nginx/04-%E5%9F%BA%E4%BA%8E%E5%9F%9F%E5%90%8D%E7%9A%84%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA/","excerpt":"1.虚拟主机一般可用分为:基于域名基于IP基于端口","text":"1.虚拟主机一般可用分为:基于域名基于IP基于端口 2.基于域名的虚拟主机12345678910111213141516171819202122232425server &#123; listen 80; //端口 server_name www.a.com; //域名 auth_basic &quot;input user and pass:&quot;; #提示用户输入密码 auth_basic_user_file &quot;/usr/local/nginx/pass&quot;; #密码文件 location / &#123; root html; //指定网站根路径 index index.html index.htm; &#125; server &#123; listen 80; //端口 server_name www.b.com; //域名 location / &#123; root nginx; //指定网站根路径 index index.html index.htm; &#125; ``` #### 3.重启nginx```shell[root@master conf]# /usr/local/nginx/sbin/nginx -s reload 4.修改本地域名解析文件hosts12sudo vim /etc/hosts192.168.1.12 www.a.com www.b.com 5.基于端口 6.基于ip","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"nginx","slug":"运维/nginx","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/nginx/"}],"tags":[]},{"title":"03-用户认证","slug":"运维/nginx/03-用户认证","date":"2021-09-03T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/09/03/运维/nginx/03-用户认证/","link":"","permalink":"https://dbbruce.github.io/2021/09/03/%E8%BF%90%E7%BB%B4/nginx/03-%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81/","excerpt":"1.nginx配置文件 （&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf）首页 123443 location / &#123;44 root html; # 文件目录 document45 index index.html index.htm; # 第一个找不到，找第二个46 &#125;","text":"1.nginx配置文件 （&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf）首页 123443 location / &#123;44 root html; # 文件目录 document45 index index.html index.htm; # 第一个找不到，找第二个46 &#125; 2.修改配置文件添加密码提示和密码文件位置1234567server &#123; listen 80; server_name localhost; auth_basic &quot;input user and pass:&quot;; #提示用户输入密码 auth_basic_user_file &quot;/usr/local/nginx/pass&quot;; #密码文件 3.生成密码文件，创建用户及密码 使用htpasswd命令创建账户文件，需要确保系统中已经安装了httpd-tools.1yum -y install httpd-tools 使用htpasswd创建用户和密码注意：-c是创建密码文件1234567[root@master conf]# htpasswd -c /usr/local/nginx/pass dongbrruceNew password:Re-type new password:Adding password for user dongbruce[root@master conf]#[root@master conf]# cat /usr/local/nginx/passdongbruce:$apr1$QpNe3clI123123123adsfasdf. 新增一个用户,没有-c12345678[root@master conf]# htpasswd /usr/local/nginx/pass dong2New password:Re-type new password:Adding password for user dong2[root@master conf]# cat /usr/local/nginx/passdongbruce:$apr1$d8PPjf3u$Q1XGtLs7TIXxLN7syZQef1dong2:$apr1$eJUh3L07$07cLQ.5vWt9VsYw3LO72U.[root@master conf]# 重新加载配置1[root@master conf]# /usr/local/nginx/sbin/nginx -s reload 验证 认证失败提示","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"nginx","slug":"运维/nginx","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/nginx/"}],"tags":[]},{"title":"33-rsync同步","slug":"运维/Linux云计算教程/33-rsync同步","date":"2021-09-02T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/09/02/运维/Linux云计算教程/33-rsync同步/","link":"","permalink":"https://dbbruce.github.io/2021/09/02/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/33-rsync%E5%90%8C%E6%AD%A5/","excerpt":"1.内核及系统日志由系统服务rsyslog统一记录&#x2F;管理日志消息采用文本格式主要记录事件发生的时间、主机、进程、内容 123[root@master ~]# tail -f /var/log/messagesAug 25 19:13:45 master dhclient[916]: DHCPREQUEST on team0 to 192.168.1.1 port 67 (xid=0x62cb920a)Aug 25 19:13:53 master dhclient[916]: DHCPREQUEST on team0 to 192.168.1.1 port 67 (xid=0x62cb920a)","text":"1.内核及系统日志由系统服务rsyslog统一记录&#x2F;管理日志消息采用文本格式主要记录事件发生的时间、主机、进程、内容 123[root@master ~]# tail -f /var/log/messagesAug 25 19:13:45 master dhclient[916]: DHCPREQUEST on team0 to 192.168.1.1 port 67 (xid=0x62cb920a)Aug 25 19:13:53 master dhclient[916]: DHCPREQUEST on team0 to 192.168.1.1 port 67 (xid=0x62cb920a) 2.rsync操作选项-n:测试同步过程,不做实际修改–delete:删除目标文件夹内多余的文档,保持源和目标文件一直-a:归档模式,相当于-rlptgoD-v:显示详细操作信息-z:传输过程中启用压缩&#x2F;解压 12345678[root@master ~]# rsync -av /var/log/messages-20230822 /opt/sending incremental file listmessages-20230822sent 1,202,369 bytes received 35 bytes 2,404,808.00 bytes/sectotal size is 1,201,982 speedup is 1.00rsync -av --delete /var/log/messages-20230822 /opt/ 3.与远程的 SSH目录保持同步下行:rsync […] user@host:远程目录 本地目录上行:rsync […l 本地目录 user@host:远程目录 4.实时同步 生成公钥 私钥1234567891011121314151617181920212223[root@master ~]# ssh-keygenGenerating public/private rsa key pair.Enter file in which to save the key (/root/.ssh/id_rsa):Enter passphrase (empty for no passphrase):Enter same passphrase again:Your identification has been saved in /root/.ssh/id_rsa.Your public key has been saved in /root/.ssh/id_rsa.pub.The key fingerprint is:SHA256:u0Utiju9HGW9h7pRiWoCMq0MsJLPdpvTUFrw07S7ZC0 root@masterThe key&#x27;s randomart image is:+---[RSA 2048]----+| || . . ||. o o . ||.o . = o + . ||= o o+ .So* = ||.= +o. .EB.o o || * .oo+*oo o . || . ..oo=o+ o . || o...+.o. |+----[SHA256]-----+[root@master ~]# ls /root/.ssh/id_rsa id_rsa.pub known_hosts 将公钥放在别的服务器 &#x2F;root&#x2F;.ssh&#x2F;1234[root@master ~]# ssh-copy-id root@192.168.4.207[root@master ~]# cat /root/.ssh/id_rsa.pubssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDXXUDSgvf6d1IR4BtRFF4wWY1fKL2lk3JKj583gHPTgybQ3D5j68jm9oHIawoGkfF+jgJSxRcmRPpXgxhlix5dOjTjWHcH root@master","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"02-平滑升级","slug":"运维/nginx/02-平滑升级","date":"2021-09-02T03:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2021/09/02/运维/nginx/02-平滑升级/","link":"","permalink":"https://dbbruce.github.io/2021/09/02/%E8%BF%90%E7%BB%B4/nginx/02-%E5%B9%B3%E6%BB%91%E5%8D%87%E7%BA%A7/","excerpt":"1.平滑升级nginx可以跨版本升级，不要跨太多；注意：conf，html，log文件不需要升级，升级需要的文件是sbin0) 升级前，版本1.0.15 1234[root@master sbin]# ./nginx -V nginx version: nginx/1.0.15 TLS SNI support enabled configure arguments: --prefix=/usr/local/nginx1.0.15 --user=nginx --group=nginx --with-http_ssl_module","text":"1.平滑升级nginx可以跨版本升级，不要跨太多；注意：conf，html，log文件不需要升级，升级需要的文件是sbin0) 升级前，版本1.0.15 1234[root@master sbin]# ./nginx -V nginx version: nginx/1.0.15 TLS SNI support enabled configure arguments: --prefix=/usr/local/nginx1.0.15 --user=nginx --group=nginx --with-http_ssl_module 编译新版本nginx软件12345tar -zxvf nginx-1.2.9.tar.gzcd nginx-1.2.9/./configure --prefix=/usr/local/nginx1.0.15 --user=nginx --group=nginx --with-http_ssl_module# 注意这里，这里是make，没有安装，只有编译；不make objs目录里没有可执行nginx文件make 编译后多一个objs文件123456789101112131415[root@master nginx-1.2.9]# ll总用量 556drwxr-xr-x. 6 nginx nginx 4096 9月 4 19:16 auto-rw-r--r--. 1 nginx nginx 216470 5月 13 2013 CHANGES-rw-r--r--. 1 nginx nginx 330113 5月 13 2013 CHANGES.rudrwxr-xr-x. 2 nginx nginx 168 9月 4 19:16 conf-rwxr-xr-x. 1 nginx nginx 2369 5月 13 2013 configuredrwxr-xr-x. 3 nginx nginx 61 9月 4 19:16 contribdrwxr-xr-x. 2 nginx nginx 40 9月 4 19:16 html-rw-r--r--. 1 nginx nginx 1397 5月 13 2013 LICENSE-rw-r--r--. 1 root root 390 9月 4 19:41 Makefiledrwxr-xr-x. 2 nginx nginx 21 9月 4 19:16 mandrwxr-xr-x. 3 root root 125 9月 4 19:41 objs ### 目录,注意如果objs里没有可执行nginx，make下-rw-r--r--. 1 nginx nginx 49 5月 13 2013 READMEdrwxr-xr-x. 8 nginx nginx 77 9月 4 19:16 src 使用新nginx替换老nginx123456789# 备份老的nginx主程序mv /usr/local/nginx1.0.15/sbin/nginx /usr/local/nginx1.0.15/sbin/nginx.old# 替换新版本ngixn主程序[root@master nginx-1.2.9]# cp objs/nginx /usr/local/nginx1.0.15/sbin/[root@master nginx-1.2.9]# ll /usr/local/nginx1.0.15/sbin/总用量 5480-rwxr-xr-x. 1 root root 4703920 9月 4 19:51 nginx-rwxr-xr-x. 1 root root 904664 9月 4 19:39 nginx.old[root@master nginx-1.2.9]# 升级 make upgrade1234567[root@master nginx-1.2.9]# make upgrade/usr/local/nginx1.0.15/sbin/nginx -tnginx: the configuration file /usr/local/nginx1.0.15/conf/nginx.conf syntax is oknginx: configuration file /usr/local/nginx1.0.15/conf/nginx.conf test is successfulkill -USR2 `cat /usr/local/nginx1.0.15/logs/nginx.pid`kill: 用法:kill [-s 信号声明 | -n 信号编号 | -信号声明] 进程号 | 任务声明 ... 或 kill -l [信号声明]make: *** [upgrade] 错误 1 查看12345[root@master nginx-1.2.9]# /usr/local/nginx1.0.15/sbin/nginx -V nginx version: nginx/1.2.9 built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) TLS SNI support enabled configure arguments: --prefix=/usr/local/nginx1.0.15 --user=nginx --group=nginx --with-http_ssl_module","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"nginx","slug":"运维/nginx","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/nginx/"}],"tags":[]},{"title":"32-dncp（缺失）","slug":"运维/Linux云计算教程/32-DHCP","date":"2021-09-01T03:00:52.000Z","updated":"2023-12-05T02:57:27.000Z","comments":true,"path":"2021/09/01/运维/Linux云计算教程/32-DHCP/","link":"","permalink":"https://dbbruce.github.io/2021/09/01/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/32-DHCP/","excerpt":"","text":"","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"01-源码安装","slug":"运维/nginx/01-源码安装","date":"2021-09-01T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/09/01/运维/nginx/01-源码安装/","link":"","permalink":"https://dbbruce.github.io/2021/09/01/%E8%BF%90%E7%BB%B4/nginx/01-%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85/","excerpt":"nginx优点 工作在7层，可以针对http做分流策略 1.9版本开始支持4层代理 正则表达式比HAProxy强大 安装、配置、测试简单，通过日志可以解决多数问题 并发量可以达到几万次 Nginx还可以作为Web服务器使用缺点 仅支持http、https、mail协议，应用面小 监控检查仅通过端口，无法使用url检查","text":"nginx优点 工作在7层，可以针对http做分流策略 1.9版本开始支持4层代理 正则表达式比HAProxy强大 安装、配置、测试简单，通过日志可以解决多数问题 并发量可以达到几万次 Nginx还可以作为Web服务器使用缺点 仅支持http、https、mail协议，应用面小 监控检查仅通过端口，无法使用url检查 1.nginx安装1http://nginx.org/download/nginx-1.18.0.tar.gz 123456789yum -y install gcc pcre-devel openssl openssl-develuseradd -s /sbin/nologin nginxtar -xf nginx-1.10.3.tar.gzcd nginx-1.10.3./configure --prefix=/usr/local/nginx //指定安装路径 --user=nginx //指定用户 --group=nginx //指定组 --with-http_ssl_module //开启SSL加密功能make &amp;&amp; make install 2.错误提示：原因缺失依赖包[root@master nginx-1.22.1]# make &amp;&amp; make installmake: *** 没有规则可以创建“default”需要的目标“build”。 停止。查看configure步骤： 123456checking for OpenSSL library in /opt/local/ ... not found./configure: error: SSL modules require the OpenSSL library.You can either do not enable the modules, or install the OpenSSL libraryinto the system, or build the OpenSSL library statically from the sourcewith nginx by using --with-openssl=&lt;path&gt; option. 1yum install pcre-devel zlib zlib-devel openssl openssl-devel 3.源码安装的软件，systemctl基本不好使4.nginx命令1234/usr/local/nginx/sbin/nginx ///启动服务/usr/local/nginx/sbin/nginx -s stop //关闭服务/usr/local/nginx/sbin/nginx -s reload //重新加载配置文件/usr/local/nginx/sbin/nginx -V //查看软件信息 5.方便后期使用1ln -s /usr/local/nginx/sbin/nginx /sbin 6.nginx服务默认通过TCP 80端口监听客户端请求12[root@master sbin]# netstat -anptu | grep nginxtcp 0 0 0.0.0.0:80 0.0.0.0:* LISTEN 8343/nginx: master","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"nginx","slug":"运维/nginx","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/nginx/"}],"tags":[]},{"title":"31-日志管理","slug":"运维/Linux云计算教程/31-日志管理","date":"2021-08-31T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/31/运维/Linux云计算教程/31-日志管理/","link":"","permalink":"https://dbbruce.github.io/2021/08/31/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/31-%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86/","excerpt":"0.系统日志12345678910111. /var/log/messages：这个文件包含了系统各种服务的日志信息，可以通过tail命令来实时检查日志的变化，如`tail -f /var/log/messages`2. /var/log/syslog：这个文件主要是记录系统的运行信息，比如内存映像文件的反转、系统守护进程的信息等等。3. /var/log/auth.log：这个日志记录的是用户登录和身份验证信息，可以查看谁登录了系统，以及登录操作是否成功等等。4. /var/log/dmesg：这个文件记录的是系统启动时的信息，比如硬件检测、驱动加载等等。5. /var/log/kern.log：这个文件记录了内核的信息，包括内核错误、警告信息以及调试信息等等。6. /var/log/cron.log：这个文件记录了定时任务的执行情况，可以查看定时任务是否执行成功等等。7. /var/log/lastlog：这个文件记录了所有用户最后一次登录的时间和信息。8. /var/log/secure 系统登录日志9. /var/log/cron 定时任务日志10. /var/log/maillog 邮件日志11. /var/log/boot.log 系统启动日志 1.内核及系统日志由系统服务rsyslog统一记录&#x2F;管理日志消息采用文本格式主要记录事件发生的时间、主机、进程、内容 123[root@master ~]# tail -f /var/log/messagesAug 25 19:13:45 master dhclient[916]: DHCPREQUEST on team0 to 192.168.1.1 port 67 (xid=0x62cb920a)Aug 25 19:13:53 master dhclient[916]: DHCPREQUEST on team0 to 192.168.1.1 port 67 (xid=0x62cb920a)","text":"0.系统日志12345678910111. /var/log/messages：这个文件包含了系统各种服务的日志信息，可以通过tail命令来实时检查日志的变化，如`tail -f /var/log/messages`2. /var/log/syslog：这个文件主要是记录系统的运行信息，比如内存映像文件的反转、系统守护进程的信息等等。3. /var/log/auth.log：这个日志记录的是用户登录和身份验证信息，可以查看谁登录了系统，以及登录操作是否成功等等。4. /var/log/dmesg：这个文件记录的是系统启动时的信息，比如硬件检测、驱动加载等等。5. /var/log/kern.log：这个文件记录了内核的信息，包括内核错误、警告信息以及调试信息等等。6. /var/log/cron.log：这个文件记录了定时任务的执行情况，可以查看定时任务是否执行成功等等。7. /var/log/lastlog：这个文件记录了所有用户最后一次登录的时间和信息。8. /var/log/secure 系统登录日志9. /var/log/cron 定时任务日志10. /var/log/maillog 邮件日志11. /var/log/boot.log 系统启动日志 1.内核及系统日志由系统服务rsyslog统一记录&#x2F;管理日志消息采用文本格式主要记录事件发生的时间、主机、进程、内容 123[root@master ~]# tail -f /var/log/messagesAug 25 19:13:45 master dhclient[916]: DHCPREQUEST on team0 to 192.168.1.1 port 67 (xid=0x62cb920a)Aug 25 19:13:53 master dhclient[916]: DHCPREQUEST on team0 to 192.168.1.1 port 67 (xid=0x62cb920a) 2.用户登录分析users、who、w 命令查看已登录的用户信息,详细度不同 12345678910111213[root@master ~]# usersroot root root[root@master ~]# whoroot tty1 2023-08-25 18:30root pts/0 2023-08-24 18:12 (192.168.1.9)root pts/1 2023-08-25 18:31 (master)[root@master ~]# w 19:30:09 up 1 day, 1:21, 3 users, load average: 0.01, 0.02, 0.05USER TTY FROM LOGIN@ IDLE JCPU PCPU WHATroot tty1 18:30 59:21 0.03s 0.03s -bashroot pts/0 192.168.1.9 四18 1.00s 1.78s 0.19s ssh root@192.168.1.13 -p 22root pts/1 master 18:31 1.00s 0.42s 0.00s w[root@master ~]# last、lastb 命令查看最近登录成功&#x2F;失败的用户信息 12345678910[root@master ~]# last -2root pts/1 master Fri Aug 25 18:31 still logged inroot tty1 Fri Aug 25 18:30 still logged inwtmp begins Mon Aug 14 15:14:58 2023[root@master ~]# lastb -2root pts/0 Thu Aug 17 23:29 - 23:29 (00:00)btmp begins Thu Aug 17 23:29:37 2023 3.日志消息的优先级Linux内核定义的事件紧急程度分为 0~7 共8种优先级别其数值越小,表示对应事件越紧急&#x2F;重要 等级 英文 描述 0 EMERG (紧急) 导致主机系统不可用的情况 1 ALERT (警告) 必须须马上采取措施解决的问题 2 CRIT (严重) 比较严重的情况 3 ERR (错误) 行出现错误 4 WARNING (提醒) 能会影响系统功能的事件 5 NOTICE (注意) 会影响系统但值得注意 6 INFO (信息) 一般信息 7 DEBUG (调试) 程序或系统调试信息等 4.使用journalctl工具提取由 systemd-journal 服务搜集的日志主要包括内核&#x2F;系统日志、服务日志常见用法 journalctl grep 关键词 journalctl -u 服务名 [-p 优先级j journalctl -n 消息条数l journalctl –since&#x3D;”yyyy-mm-dd HH:MM:SSuntil&#x3D;”yyyy-mm-dd HH:MM:SS” 最常用 #查询某一个服务日志信息：[root@svr7 ~]# journalctl -u httpd#最近报错日志： [root@svr7 ~]# journalctl -xe 123[root@master ~]# journalctl -xe # 最常用8月 25 19:37:40 master dhclient[916]: DHCPREQUEST on team0 to 192.168.1.1 port 67 (xid=0x62cb920a)8月 25 19:38:00 master dhclient[916]: DHCPREQUEST on team0 to 192.168.1.1 port 67 (xid=0x62cb920a) 5.systemd一个更高效的系统&amp;服务管理器开机服务并行启动，各系统服务间的精确依赖配置目录: &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;服务目录: &#x2F;lib&#x2F;systemd&#x2F;system&#x2F;主要管理工具: systemctl 对于服务的管理#重起服务 systemctl restart 服务名#开启服务 systemctl start 服务名#停止服务 systemctl stop 服务名#查看服务当前的状态 systemctl status 服务名#设置服务开机自启动服务名 systemctl enable 服务名#设置服务不开机自启动 systemctl disable 服务名 6.","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"30-进程","slug":"运维/Linux云计算教程/30-进程","date":"2021-08-30T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/30/运维/Linux云计算教程/30-进程/","link":"","permalink":"https://dbbruce.github.io/2021/08/30/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/30-%E8%BF%9B%E7%A8%8B/","excerpt":"1.唯一标识 PID 父进程、子进程 pstree命令-a:显示完整的命令行-p:列出对应PID编号","text":"1.唯一标识 PID 父进程、子进程 pstree命令-a:显示完整的命令行-p:列出对应PID编号 2.所有进程父进程systemd:所有进程的父进程上帝进程 3.ps 查看进程快照ps - Processes Snapshot ps aux 操作列出正在运行的所有进程,信息非常的详细 aux: 显示当前终端所有进程 (a)、当前用户在所有终端下的进程 (x)， 以用户格式输出 (u)用户 进程ID %CPU %内存 虚拟内存 固定内存 终端 状态 起始时间 CPU时间 程序指令123456[root@master ~]# ps aux |grep sshroot 1228 0.0 0.1 112900 4308 ? Ss 8月24 0:00 /usr/sbin/sshd -Droot 1805 0.0 0.1 160988 5748 ? Ss 8月24 0:01 sshd: root@pts/0root 4009 0.0 0.1 178828 4596 pts/0 S+ 18:31 0:00 ssh root@192.168.1.13 -p 22root 4010 0.1 0.1 160976 5800 ? Ss 18:31 0:01 sshd: root@pts/1root 4109 0.0 0.0 112824 976 pts/1 S+ 18:40 0:00 grep --color=auto ssh ps -elf 操作列出正在运行的所有进程,查询进程的父进程-elf: 显示系统内所有进程 (-e) 、以长格式输出 (-l)信息、包括最完整的进程信息 (-f)PPID:父进程的ID123456ps -elf |grep ssh4 S root 1228 1 0 80 0 - 28225 poll_s 8月24 ? 00:00:00 /usr/sbin/sshd -D4 S root 1805 1228 0 80 0 - 40247 poll_s 8月24 ? 00:00:01 sshd: root@pts/04 S root 4009 1809 0 80 0 - 44707 poll_s 18:31 pts/0 00:00:00 ssh root@192.168.1.13 -p 224 S root 4010 1228 0 80 0 - 40244 poll_s 18:31 ? 00:00:01 sshd: root@pts/10 S root 4112 4016 0 80 0 - 28207 pipe_w 18:41 pts/1 00:00:00 grep --color=auto ssh 4.进程动态排名top 交互式工具格式:top [-d 刷新秒数] [-U 用户名][rootasvr7 ~]# top -d 1 #每一秒刷新一次大写P 进行CPU排序大写M 进行内存排序 5.pgrep - Process Grep12345[root@master ~]# pgrep -l ssh1228 sshd1805 sshd4009 ssh4010 sshd -L:输出进程名,而不仅仅是 PID-U:检索指定用户的进程-x:精确配完整的进程名 6.进程的前后台调度&amp;: 后台启动在命令行末尾添加“&amp;”符号,不占用当前终端ctrl + Z 组合键 :挂起当前进程(暂停并转入后台)jobs -l：查看后台进程bg：将后台的任务继续运行fg：将后台任务放回前台 1234567891011121314[root@master ~]# sleep 111111^Z[1]+ 已停止 sleep 111111[root@master ~]# sleep 1111111 &amp;[1] 4172[root@master ~]# jobs[1]+ 已停止 sleep 111111[root@master ~]# bg 1[1]+ sleep 111111 &amp;[root@master ~]# jobs[1]+ 运行中 sleep 111111 &amp;[root@master ~]# fg 1sleep 111111^C 7.杀死进程干掉进程的不同方法令程序ctrl+c 组合键,中断当前命令kill [-9] %后台任务编号 kill [-9] PID.killall [-9] 进程名…pkill 查找条件 abc abcd #不建议使用这个，模糊查杀，有可能误杀 8.强制踢出一个用户(杀死该用户开启的所有进程)[root@svr7 ~]# killall -9 -u 用户名","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"29-DNS概述（待完善）","slug":"运维/Linux云计算教程/29-dns概述","date":"2021-08-29T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/29/运维/Linux云计算教程/29-dns概述/","link":"","permalink":"https://dbbruce.github.io/2021/08/29/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/29-dns%E6%A6%82%E8%BF%B0/","excerpt":"1.DNS服务器的功能 正向解析: 根据注册的域名查找其对应的IP地址 反向解析: 根据IP地址查找对应的注册域名，不常用","text":"1.DNS服务器的功能 正向解析: 根据注册的域名查找其对应的IP地址 反向解析: 根据IP地址查找对应的注册域名，不常用 2.DNS的分布式结构 3.域名代理&#x2F;注册&#x2F;购买服务商 新网，http://www.xinnet.com 万网，http://www.net.cn 中国互联，http://hulian.top 4.","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"28-源码编译安装","slug":"运维/Linux云计算教程/28-源码编译安装","date":"2021-08-28T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/28/运维/Linux云计算教程/28-源码编译安装/","link":"","permalink":"https://dbbruce.github.io/2021/08/28/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/28-%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/","excerpt":"源码包安装步骤1:安装make与gcc,开发工具12[root@svr7 ~]# yum -y install make[rootasvr7 ~]# yum -y install gcc","text":"源码包安装步骤1:安装make与gcc,开发工具12[root@svr7 ~]# yum -y install make[rootasvr7 ~]# yum -y install gcc 2:tar解包,释放源代码至指定目录步骤123tar -xf /tools/inotify-tools-3.13.tar.gz -C /opt/]# ls /opt/ls /opt/inotify-tools-3.13/ 3:.&#x2F;configure 配置,指定安装目录&#x2F;功能模块等选项步骤12cd /opt/inotify-tools-3.13/./configure --prefix=/mnt/myrpm 4:make 编译,生成可执行的二进制程序文件步骤1make 5:make instalL 安装将编译好的文件复制到安装目录1make install","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"27-vim技巧","slug":"运维/Linux云计算教程/27-vim技巧","date":"2021-08-27T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/27/运维/Linux云计算教程/27-vim技巧/","link":"","permalink":"https://dbbruce.github.io/2021/08/27/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/27-vim%E6%8A%80%E5%B7%A7/","excerpt":"1.光标跳转Home 键 或^、数字 0 跳转到行首End 键 或“$”键 跳转到行尾PgUp 键、PgDn 键 向上翻页、向下翻页1G 或 gg 跳转到文件的首行G跳转到文件的末尾行","text":"1.光标跳转Home 键 或^、数字 0 跳转到行首End 键 或“$”键 跳转到行尾PgUp 键、PgDn 键 向上翻页、向下翻页1G 或 gg 跳转到文件的首行G跳转到文件的末尾行 2.复制&#x2F;粘贴&#x2F;删除yy、#yy 复制光标处的一行、#行p、P 粘贴到光标处之后、之前x 或 Delete键 删除光标处的单个字符dd、#dd 删除光标处的一行、#行d^ 从光标处之前删除至行首d$ 从光标处删除到行尾C(大写) 从光标处删除到行尾,并且进入插入模式 3.查找&#x2F;撤销&#x2F;保存&#x2F;word 向后查找字符串“word”n、N 跳至后&#x2F;前一个结果u 撤销最近的一次操作U 撤销对当前行的所有修改Ctrl + r 取消前一次撤销操作ZZ() 保存修改并退出 4.字符串替换:s&#x2F;old&#x2F;new 替换当前行第一个“old”:s&#x2F;old&#x2F;new&#x2F;g 替换当前行所有的“old”:n,m s&#x2F;old&#x2F;new&#x2F;g 替换第n-m行所有的“old”:% s&#x2F;old&#x2F;new&#x2F;g 替换文件内所有的“old” 5.开关参数的控制:set nu或nonu 显示&#x2F;不显示行号:set ai或noai 启用&#x2F;关闭自动缩进","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"26-parted分区工具","slug":"运维/Linux云计算教程/26-parted分区工具","date":"2021-08-26T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/26/运维/Linux云计算教程/26-parted分区工具/","link":"","permalink":"https://dbbruce.github.io/2021/08/26/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/26-parted%E5%88%86%E5%8C%BA%E5%B7%A5%E5%85%B7/","excerpt":"1.parted分区工具,适用于GPT分区模式GPT分区模式:最多可以划分128个主分区","text":"1.parted分区工具,适用于GPT分区模式GPT分区模式:最多可以划分128个主分区 2.[root@A ~]# parted &#x2F;dev&#x2F;vdb(parted) mktable gpt #指定分区表类型,指定分区模式(parted) print #输出分区表信息(parted) mkpart #划分新的分区分区名称? []? haha #分区名称随意写文件系统类型? [ext2]? xfs #文件系统随意写,不起实际作用起始点? 0结束点? 2G#选择忽略忽略&#x2F;Ignore&#x2F;放弃&#x2F;Cancel? Ignore #选择忽略(parted) unit GB #使用GB作为单位(parted) print起始点? 2G结束点? 4G(parted) print(parted) quit","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"25-链路聚合","slug":"运维/Linux云计算教程/25-链路聚合","date":"2021-08-25T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/25/运维/Linux云计算教程/25-链路聚合/","link":"","permalink":"https://dbbruce.github.io/2021/08/25/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/25-%E9%93%BE%E8%B7%AF%E8%81%9A%E5%90%88/","excerpt":"1.链路聚合的优势team,聚合连接(也称为链路聚合 网卡绑定 网卡组队)备份网卡设备,提高可靠性 eth0 和 eth1组成一个 虚拟网卡: team0: 192.168.1.1 作用1:轮询式(roundrobin)的流量负载均衡作用2:热备份(activebackup)连接几余","text":"1.链路聚合的优势team,聚合连接(也称为链路聚合 网卡绑定 网卡组队)备份网卡设备,提高可靠性 eth0 和 eth1组成一个 虚拟网卡: team0: 192.168.1.1 作用1:轮询式(roundrobin)的流量负载均衡作用2:热备份(activebackup)连接几余 2.建立虚拟网卡team0参考: man teamd .conf 123[root@master ~]# nmcli connection add type team ifname team0 con-name team0 autoconnect yes config &#x27;&#123;&quot;runner&quot;:&#123;&quot;name&quot;:&quot;activebackup&quot;&#125;&#125;&#x27;连接 &quot;team0&quot; (ee2026a6-51c6-42e8-84fe-8d72c6625ce9) 已成功添加。[root@master ~]# 3.添加成员12[root@master ~]# nmcli connection add type team-slave ifname enp0s3 con-name team0-1 autoconnect yes master team0连接 &quot;team0-1&quot; (f459e340-d1d5-4117-8c7e-2dab292c7fe6) 已成功添加。 12[root@master ~]# nmcli connection add type team-slave ifname enp0s8 con-name team0-2 autoconnect yes master team0连接 &quot;team0-2&quot; (4a0a665b-c787-4c1c-b5a0-f12dc4522316) 已成功添加。 4.设置team0的IP地址与子网掩码[rootaA ~]# nmcli connection modify team0 ipv4.method manual ipv4.addresses 192.168.1.1&#x2F;24 connection.autoconnect yes[root@A ~]# nmcli connection up team0[root@A ~]# ifconfig 查看链路信息[root@A ~]# teamdctl team0 state 主动down掉一个网卡[root@A ~]# ifconfig eth2 down [rootaA ~]# teamdctl team0 state 5.如果有敲错[root@A ~]# nmcli connection delete team 0[rootaA ~]# nmcli connection delete team0-1[root@A ~]# nmcli connection delete team0-2","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"24-网络配置","slug":"运维/Linux云计算教程/24-网络配置","date":"2021-08-24T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/24/运维/Linux云计算教程/24-网络配置/","link":"","permalink":"https://dbbruce.github.io/2021/08/24/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/24-%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/","excerpt":"1.查看网卡名称12345nmcli connection showNAME UUID TYPE DEVICEenp0s3 7418e7f8-60e3-41cd-a265-f24c5ef8cd48 ethernet enp0s3# 注意这个名称可能和我们用ifconfig看到的不一样","text":"1.查看网卡名称12345nmcli connection showNAME UUID TYPE DEVICEenp0s3 7418e7f8-60e3-41cd-a265-f24c5ef8cd48 ethernet enp0s3# 注意这个名称可能和我们用ifconfig看到的不一样 2.永久设置: IP地址 子网掩码 网关地址12nmcli connection modify &#x27;enp0s8&#x27; ipv4.method manual ipv4.addresses &#x27;192.168.1.13/24 192.168.1.255&#x27; connection.autoconnect yes nmcli connection 修改’识别的网卡名’ipv4.方法 手工配置ipv4.地址为 IP地址&#x2F;子网掩码 网关地址 # 子网掩码 只能写24这种格式每次开机启用配置 3.激活配置12[root@A ~]# nmcli connection up &#x27;System etho&#x27; 4.DNS服务器地址123456#配置文件DNS服务器地址]# ls /etc/resolv.conf]# echo &#x27;nameserver 172.25.254.254&#x27; &gt; /etc/resolv.conf]# cat /etc/resolv.confnameserver 172.25.254.254 5.查看网关信息12345[root@master ~]# routeKernel IP routing tableDestination Gateway Genmask Flags Metric Ref Use Ifacedefault gateway 0.0.0.0 UG 100 0 0 enp0s3192.168.1.0 0.0.0.0 255.255.255.0 U 100 0 0 enp0s3 6.IPv6地址的组成IPv4 地址表示 -32个二进制位，点分隔的十进制数 -例如: 172.25.0.11、127.0.0.1 IPv6 地址表示 -128个二进制位，冒号分隔的十六进制数 -每段内连续的前置 0 可省略、连续的多个:可简化为 :: -例: 2003:ac18:0000:0000:0000:0000:0000:0305 简化为：2003:ac18::305 7.永久设置: IPV6地址 子网掩码 网关地址123456789#配置nmcli connection modify &#x27;System etho&#x27; ipv6.method manual ipv6.addresses &#x27;2003:ac18::305/64&#x27; connection.autoconnect yes#激活nmcli connection up &#x27;System etho&#x27;#ping6 ipv6专用pingping6 2003:ac18::305 nmcli connection 修改’识别的网卡名’ipv6.方法 手工配置ipv6.地址为 IP地址&#x2F;子网掩码每次开机启用配置","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"23-安全web服务","slug":"运维/Linux云计算教程/23-安全web服务","date":"2021-08-23T03:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2021/08/23/运维/Linux云计算教程/23-安全web服务/","link":"","permalink":"https://dbbruce.github.io/2021/08/23/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/23-%E5%AE%89%E5%85%A8web%E6%9C%8D%E5%8A%A1/","excerpt":"1.Public Key Infrastruc公钥:主要用来加密数据私钥:主要用来解密数据(与相的公钥匹配)数字证书:证明拥有者的合法&#x2F;权威性(单位名称、有效期、公钥、颁发机 构及签名、……)Certificate Authority 数字证书授权中心:负责证书的申请&#x2F;审核&#x2F;颁发&#x2F;鉴定&#x2F;撤销等管理工作","text":"1.Public Key Infrastruc公钥:主要用来加密数据私钥:主要用来解密数据(与相的公钥匹配)数字证书:证明拥有者的合法&#x2F;权威性(单位名称、有效期、公钥、颁发机 构及签名、……)Certificate Authority 数字证书授权中心:负责证书的申请&#x2F;审核&#x2F;颁发&#x2F;鉴定&#x2F;撤销等管理工作 2.httpd安全1.下载网站证书 12[root@master ~]# cd /etc/pki/tls/certs/ 2.下载根证书 12[root@master ~]# cd /etc/pki/tls/certs/ 3.下载解密私钥 12[root@master ~]# cd /etc/pki/tls/private 4.安装mod_ssl软件，安全软件 123456789101112131415161718[root@master ~]# yum -y install mod_ssl[root@master private]# vim /etc/httpd/conf.d/ssl.conf# 修改如下 59 DocumentRoot &quot;/var/www/html&quot; 60 ServerName www.example.com:443 #指定网站证书 100 SSLCertificateFile /etc/pki/tls/certs/localhost.crt #指定私钥 107 SSLCertificateKeyFile /etc/pki/tls/private/localhost.key # 指定跟证书 122 SSLCACertificateFile /etc/pki/tls/certs/ca-bundle.crt [root@master private]# systemctl restart httpd","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"22-nfs","slug":"运维/Linux云计算教程/22-nfs","date":"2021-08-22T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/22/运维/Linux云计算教程/22-nfs/","link":"","permalink":"https://dbbruce.github.io/2021/08/22/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/22-nfs/","excerpt":"1.NFS共享概述Network File System，网络文件系统用途:为客户机提供共享使用的文件夹 协议: NFS (TCP&#x2F;UDP 2049) 、RPC (TCP&#x2F;UDP 111)所需软件包: nfs-utils系统服务: nfs-server1rpm -q nfs-utilsnfs-utils-1.3.0-0.el7.x86 64","text":"1.NFS共享概述Network File System，网络文件系统用途:为客户机提供共享使用的文件夹 协议: NFS (TCP&#x2F;UDP 2049) 、RPC (TCP&#x2F;UDP 111)所需软件包: nfs-utils系统服务: nfs-server1rpm -q nfs-utilsnfs-utils-1.3.0-0.el7.x86 64 2.配置exports文件解析修改 &#x2F;etc&#x2F;exports 文件夹路径 客户机地址(权限) 客户机地址(权限) …. 使用 exportfs 可以重载更新过的配置 exportfs -r 12345# vim /etc/exportspublic 172.25.0.0/24(ro)/protected*(rw)# exportfs -r]# systemctl restart nfs-server[root@server0 3.步骤1.安装软件包nfs-utils[rootserver0 ~]# rpm -g nfs-utilsnfs-utils-1.3.0-,el7.x86 64 2.创建共享目录及完成共享配置rootaservero ~]# mkdir &#x2F;public[root@server0 ~]# echo haha &gt; &#x2F;public&#x2F;1.txt[root@server0 ~]# ls &#x2F;public&#x2F;[rootaserver0 ]# vim &#x2F;etc&#x2F;exports文件夹路径客户机地址(权限) 客户机地址(权限) ….&#x2F;public *(ro) 3重启nfs-server服务[rootaserver0 ~]# systemctl restart nfs-server[rootaserver0 ~]# systemctl enable nfs-serverln -s ‘&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;nfs-server,service’ ‘&#x2F;etc&#x2F;systemd&#x2F;system&#x2F;nfs target.wants&#x2F;nfs-server.service’ 4.客户端挂载1.进行手动挂载[rootadesktop0 ]# mkdir &#x2F;mnt&#x2F;nsd[rootadesktop0 ~]# ls &#x2F;mnt&#x2F;nsd[rootadesktop0 ~]# mount 172.25.0.11:&#x2F;public &#x2F;mnt&#x2F;nsd&#x2F;[rootadesktop0]# ls &#x2F;mnt&#x2F;nsd&#x2F;[rootadesktop0~]# df -h 2.开机自动挂载[rootadesktop0 ~]# vim &#x2F;etc&#x2F;fstab172.25.0.11:&#x2F;public &#x2F;mnt&#x2F;nsd nfs defaults,_netdev 0 0 5.查看服务端共享[rootadesktop0 ~]# showmount -e 172.25.0.11Export list for 172.25.0.11&#x2F;public *","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"21-数据库","slug":"运维/Linux云计算教程/21-数据库","date":"2021-08-21T03:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2021/08/21/运维/Linux云计算教程/21-数据库/","link":"","permalink":"https://dbbruce.github.io/2021/08/21/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/21-%E6%95%B0%E6%8D%AE%E5%BA%93/","excerpt":"1.虚拟机Server0:部署数据库1安装mariadb-server软件包 1[rootaserver0 ~]# yum -y install mariadb-server 2.重启mariadb服务 123[root@server0 ~]# systemctl restart mariadb[rootaserver0 ~]# systemctl enable mariadbln -s&#x27;/usr/lib/systemd/system/mariadb.service&#x27;/etcsystemd/system/multi-user.target.wants/mariadb.service","text":"1.虚拟机Server0:部署数据库1安装mariadb-server软件包 1[rootaserver0 ~]# yum -y install mariadb-server 2.重启mariadb服务 123[root@server0 ~]# systemctl restart mariadb[rootaserver0 ~]# systemctl enable mariadbln -s&#x27;/usr/lib/systemd/system/mariadb.service&#x27;/etcsystemd/system/multi-user.target.wants/mariadb.service 2.为数据库账号修改密码mysqladmin [-u用户名] [-p[日密码]] password新密码 无密码设置密码： 1mysqladmin -u root password &#x27;123&#x27; 有密码修改密码： 1mysqladmin - u root -p456 password &#x27;123&#x27; [root@server0 ~]# mysql -uroot -p123MariaDB [(none)]&gt;&#x2F;&#x2F;测试新密码登录成功 3.卸载数据库1yum remove mariadb- server 4.导入&#x2F;恢复到数据库mysql [-u用户名] [-p[密码]] 数据库名 &lt; 备份文件.sql 5.用户授权设置GRANT 权限列表 ON 数据库名.表名 TO 用户名@客户机地址 IDENTIFIED BY密码 123GRANT select ON Contacts.* toRaikon@localhost IDENTIFIED BY &#x27;atenorth&#x27;//授予用户 Raikon 查询 Contacts 库的权限","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"20-iSCSI磁盘","slug":"运维/Linux云计算教程/20-iSCSI磁盘","date":"2021-08-20T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/20/运维/Linux云计算教程/20-iSCSI磁盘/","link":"","permalink":"https://dbbruce.github.io/2021/08/20/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/20-iSCSI%E7%A3%81%E7%9B%98/","excerpt":"0.Internet SCSI,网际SCSI接口 （默认端口3260）一种基于C&#x2F;S架构的虚拟磁盘技术服务器提供磁盘空间,客户机连接并当成本地磁盘使用","text":"0.Internet SCSI,网际SCSI接口 （默认端口3260）一种基于C&#x2F;S架构的虚拟磁盘技术服务器提供磁盘空间,客户机连接并当成本地磁盘使用 1.iSCSI磁盘的工作模式 2.iSCSI磁盘的构成backstore，后端存储 对应到服务端提供实际存储空间的设备，需要起一个管理名称target，磁盘组 是客户端的访问目标，作为一个框架，由多个lun组成lun，逻辑单元 每一个lun需要关联到某一个后端存储设备，在客户端会视为一块虚拟硬盘 3.ISCSI Qualified Name 名称规范- iqn.yyyy-mm.倒序域名:自定义标识用来识别 target 磁盘组，也用来识别客户机身份 名称示例 - ign.2016-02.com.example:server0-ign.2016-02.com:example:desktop0 4.安装targetcli[root@master dong]# yum -y install targetcli 5.运行targetcli命令进行配置1.生成及指定后端存储(backstore，后端存储) 1234567891011121314151617[root@master dong]# targetcliWarning: Could not load preferences file /root/.targetcli/prefs.bin.targetcli shell version 2.1.53Copyright 2011-2013 by Datera, Inc and others.For help on commands, type &#x27;help&#x27;./&gt; lso- / ......................................................................................................................... [...] o- backstores .............................................................................................................. [...] | o- block .................................................................................................. [Storage Objects: 0] | o- fileio ................................................................................................. [Storage Objects: 0] | o- pscsi .................................................................................................. [Storage Objects: 0] | o- ramdisk ................................................................................................ [Storage Objects: 0] o- iscsi ............................................................................................................ [Targets: 0] o- loopback ......................................................................................................... [Targets: 0]/&gt; backstores/block create name=dongiscsi dev=/dev/sdb1Created block storage object dongiscsi using /dev/sdb1. 2.生成target磁盘组(木质的箱子)使用iscsi命名规范 12345/&gt; iscsi/ create iqn.2023-08.dongiscsi.com:dongCreated target iqn.2023-08.dongiscsi.com:dong.Created TPG 1.Global pref auto_add_default_portal=trueCreated default portal listening on all IPs (0.0.0.0), port 3260. 123456789101112131415161718/&gt; lso- / ......................................................................................................................... [...] o- backstores .............................................................................................................. [...] | o- block .................................................................................................. [Storage Objects: 1] | | o- dongiscsi ..................................................................... [/dev/sdb1 (3.0GiB) write-thru deactivated] | | o- alua ................................................................................................... [ALUA Groups: 1] | | o- default_tg_pt_gp ....................................................................... [ALUA state: Active/optimized] | o- fileio ................................................................................................. [Storage Objects: 0] | o- pscsi .................................................................................................. [Storage Objects: 0] | o- ramdisk ................................................................................................ [Storage Objects: 0] o- iscsi ............................................................................................................ [Targets: 1] | o- iqn.2023-08.dongiscsi.com:dong .................................................................................... [TPGs: 1] | o- tpg1 ............................................................................................... [no-gen-acls, no-auth] | o- acls .......................................................................................................... [ACLs: 0] | o- luns .......................................................................................................... [LUNs: 0] | o- portals .................................................................................................... [Portals: 1] | o- 0.0.0.0:3260 ..................................................................................................... [OK] o- loopback ......................................................................................................... [Targets: 0] 3.进行Lun关联 12/&gt; iscsi/iqn.2023-08.dongiscsi.com:dong/tpg1/luns create /backstores/block/dongiscsiCreated LUN 0. 1234567891011121314151617181920/&gt; lso- / ......................................................................................................................... [...] o- backstores .............................................................................................................. [...] | o- block .................................................................................................. [Storage Objects: 1] | | o- dongiscsi ....................................................................... [/dev/sdb1 (3.0GiB) write-thru activated] | | o- alua ................................................................................................... [ALUA Groups: 1] | | o- default_tg_pt_gp ....................................................................... [ALUA state: Active/optimized] | o- fileio ................................................................................................. [Storage Objects: 0] | o- pscsi .................................................................................................. [Storage Objects: 0] | o- ramdisk ................................................................................................ [Storage Objects: 0] o- iscsi ............................................................................................................ [Targets: 1] | o- iqn.2023-08.dongiscsi.com:dong .................................................................................... [TPGs: 1] | o- tpg1 ............................................................................................... [no-gen-acls, no-auth] | o- acls .......................................................................................................... [ACLs: 0] | o- luns .......................................................................................................... [LUNs: 1] | | o- lun0 ................................................................. [block/dongiscsi (/dev/sdb1) (default_tg_pt_gp)] | o- portals .................................................................................................... [Portals: 1] | o- 0.0.0.0:3260 ..................................................................................................... [OK] o- loopback ......................................................................................................... [Targets: 0]/&gt; 4.设置ACL验证,设置客户端需声称的名字符合iqn名称规范 123/&gt; iscsi/iqn.2023-08.dongiscsi.com:dong/tpg1/acls create iqn.2023-08.dongiscsi.com:dongaclCreated Node ACL for iqn.2023-08.dongiscsi.com:dongaclCreated mapped LUN 0. 12345678910111213141516171819202122/&gt; lso- / ......................................................................................................................... [...] o- backstores .............................................................................................................. [...] | o- block .................................................................................................. [Storage Objects: 1] | | o- dongiscsi ....................................................................... [/dev/sdb1 (3.0GiB) write-thru activated] | | o- alua ................................................................................................... [ALUA Groups: 1] | | o- default_tg_pt_gp ....................................................................... [ALUA state: Active/optimized] | o- fileio ................................................................................................. [Storage Objects: 0] | o- pscsi .................................................................................................. [Storage Objects: 0] | o- ramdisk ................................................................................................ [Storage Objects: 0] o- iscsi ............................................................................................................ [Targets: 1] | o- iqn.2023-08.dongiscsi.com:dong .................................................................................... [TPGs: 1] | o- tpg1 ............................................................................................... [no-gen-acls, no-auth] | o- acls .......................................................................................................... [ACLs: 1] | | o- iqn.2023-08.dongiscsi.com:dongacl .................................................................... [Mapped LUNs: 1] | | o- mapped_lun0 ............................................................................. [lun0 block/dongiscsi (rw)] | o- luns .......................................................................................................... [LUNs: 1] | | o- lun0 ................................................................. [block/dongiscsi (/dev/sdb1) (default_tg_pt_gp)] | o- portals .................................................................................................... [Portals: 1] | o- 0.0.0.0:3260 ..................................................................................................... [OK] o- loopback ......................................................................................................... [Targets: 0]/&gt; 5.指定本机提供服务的IP地址及端口(默认为3260) 12345678910111213141516171819202122232425262728293031323334/&gt; iscsi/iqn.2023-08.dongiscsi.com:dong/tpg1/portals create ip_address=127.0.0.1Using default IP port 3260Could not create NetworkPortal in configFS/&gt; lso- / ......................................................................................................................... [...] o- backstores .............................................................................................................. [...] | o- block .................................................................................................. [Storage Objects: 1] | | o- dongiscsi ....................................................................... [/dev/sdb1 (3.0GiB) write-thru activated] | | o- alua ................................................................................................... [ALUA Groups: 1] | | o- default_tg_pt_gp ....................................................................... [ALUA state: Active/optimized] | o- fileio ................................................................................................. [Storage Objects: 0] | o- pscsi .................................................................................................. [Storage Objects: 0] | o- ramdisk ................................................................................................ [Storage Objects: 0] o- iscsi ............................................................................................................ [Targets: 1] | o- iqn.2023-08.dongiscsi.com:dong .................................................................................... [TPGs: 1] | o- tpg1 ............................................................................................... [no-gen-acls, no-auth] | o- acls .......................................................................................................... [ACLs: 1] | | o- iqn.2023-08.dongiscsi.com:dongacl .................................................................... [Mapped LUNs: 1] | | o- mapped_lun0 ............................................................................. [lun0 block/dongiscsi (rw)] | o- luns .......................................................................................................... [LUNs: 1] | | o- lun0 ................................................................. [block/dongiscsi (/dev/sdb1) (default_tg_pt_gp)] | o- portals .................................................................................................... [Portals: 1] | o- 0.0.0.0:3260 ..................................................................................................... [OK] o- loopback ......................................................................................................... [Targets: 0]/&gt;/&gt; iscsi/iqn.2023-08.dongiscsi.com:dong/tpg1/portals delete ip_address=0.0.0.0 ip_port=3260Deleted network portal 0.0.0.0:3260/&gt; iscsi/iqn.2023-08.dongiscsi.com:dong/tpg1/portals create ip_address=192.168.1.12 ip_port=3260Using default IP port 3260Created network portal 192.168.1.12:3260. 6.退出自动保存 123/&gt; exitGlobal pref auto_save_on_exit=trueConfiguration saved to /etc/target/saveconfig.json 5四重启服务1234[root@master dong]# systemctl restart target[root@master dong]# systemctl enable targetCreated symlink from /etc/systemd/system/multi-user.target.wants/target.service to /usr/lib/systemd/system/target.service.[root@master dong]# 6.客户端安装1.安装软件 12# yum -y install iscsi-initiator-utils 2.修改配置文件 12[root@master dong]# vim /etc/iscsi/initiatorname.iscsiInitiatorName=iqn.2023-08.dongiscsi.com:dongacl # 使用ACL名称 3.客户端重启服务 1[root@master dong]# systemctl restart iscsid 4.发现共享存储iscsiadm –m discoverydb –type sendtargets –portal 192.168.1.12 –discover 192.168.1.12:3260,1 iqn.2023-08.dongiscsi.com:dong 12[root@master dong]# iscsiadm --m discoverydb --type sendtargets --portal 192.168.1.12 --discover 192.168.1.12:3260,1 iqn.2023-08.dongiscsi.com:dong192.168.1.12:3260,1 iqn.2023-08.dongiscsi.com:dong 5.加载使用 12345678910[root@master dong]# lsblkNAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINTsda 8:0 0 30G 0 disk├─sda1 8:1 0 1G 0 part /boot└─sda2 8:2 0 29G 0 part ├─centos-root 253:0 0 26G 0 lvm / └─centos-swap 253:1 0 3G 0 lvm [SWAP]sdb 8:16 0 5G 0 disk└─sdb1 8:17 0 3G 0 partsr0 11:0 1 1024M 0 rom 12[root@master dong]# systemctl restart iscsi.service[root@master dong]# systemctl enable iscsi.service 1234567891011[root@master dong]# lsblkNAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINTsda 8:0 0 30G 0 disk├─sda1 8:1 0 1G 0 part /boot└─sda2 8:2 0 29G 0 part ├─centos-root 253:0 0 26G 0 lvm / └─centos-swap 253:1 0 3G 0 lvm [SWAP]sdb 8:16 0 5G 0 disk└─sdb1 8:17 0 3G 0 partsdc 8:32 0 3G 0 disk # 这块磁盘sr0 11:0 1 1024M 0 rom","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"19-交换分区","slug":"运维/Linux云计算教程/19-交换分区","date":"2021-08-19T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/19/运维/Linux云计算教程/19-交换分区/","link":"","permalink":"https://dbbruce.github.io/2021/08/19/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/19-%E4%BA%A4%E6%8D%A2%E5%88%86%E5%8C%BA/","excerpt":"1.交换空间(虚拟内存)当真实物理内存不够用时,会启用交换空间,将不常用的内存数据暂时放入到,交换空间中,缓解内存不足利用硬盘的空间来充当交换空间(虚拟内存)","text":"1.交换空间(虚拟内存)当真实物理内存不够用时,会启用交换空间,将不常用的内存数据暂时放入到,交换空间中,缓解内存不足利用硬盘的空间来充当交换空间(虚拟内存) 2.划分新的分区~]# fdisk &#x2F;dev&#x2F;vdb #划分两个主分区分别为2G~]# lsblk~]#ls &#x2F;dev&#x2F;vdb[1-2] 3.查看交换空间的组成swapon -s 123[root@master dong]# swapon -s文件名 类型 大小 已用 权限/dev/dm-1 partition 3145724 0 -2 4.~]# mkswap &#x2F;dev&#x2F;vdb1~]# mkswap &#x2F;dev&#x2F;vdb1正在设置交换空间版本 1，大小 &#x3D; 2097148 KiB无标签 ，UUID&#x3D;4f8a8388- 58f3 4cbb- ab41- 668fb303459e~]# blkid &#x2F;dev&#x2F;vdb1&#x2F;dev&#x2F;vdb1: UUID&#x3D;”4f8a8388 58f3 4cbb- ab41- 668fb303459eTYPE” swap” 5..格式化交换分区~]# mkswap &#x2F;dev&#x2F;vdb1~]# blkid &#x2F;dev&#x2F;vdb1 6.启用交换分区~]# swapon &#x2F;dev&#x2F;vdb1~]# swapon -s 7.停用交换分区~]# swapoff &#x2F;dev&#x2F;vdb1~]# swapon -s 8.开机自动交换分区vim &#x2F;etc&#x2F;fstab&#x2F;dev&#x2F;vdb2 swap swap defaults 0 0 swapoff &#x2F;dev&#x2F;vdb2swapon -a # 测试很重要swapon -s 显示","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"18-防火墙","slug":"运维/Linux云计算教程/18-防火墙","date":"2021-08-18T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/18/运维/Linux云计算教程/18-防火墙/","link":"","permalink":"https://dbbruce.github.io/2021/08/18/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/18-%E9%98%B2%E7%81%AB%E5%A2%99/","excerpt":"1.firewalld服务基础系统服务:firewalld管理工具:firewall-cmd、firewall-config","text":"1.firewalld服务基础系统服务:firewalld管理工具:firewall-cmd、firewall-config 2.预设安全区域根据所在的网络场所区分，预设保护规则集public: 仅允许访问本机的sshd等少数几个服务trusted: 允许任何访问block: 阻塞任何来访请求drop: 丢弃任何来访的数据包 配置规则的位置运行时 (runtime)永久 (permanent 3.根据所在的网络场所区分,预设保护规则集ping服务public:仅允许访同本机的 sshd dhcptrusted:允许任何访同block:阻塞任何来访请求(明确拒绝)drop:丢弃任何来访的数据包(直接丢弃不给客户端回应,节省资源)数据包: 源IP地址 目标IP 地址 防火墙匹配原则:匹配及停止1.查看数据包中源IP地址,然后查询所有区域中规则,哪一个区域中有该源IP地址的规则,则进入哪一个区域2.进入默认区域(public) 4.#查看防火墙默认区域firewall-cmd –get-default-zone 5.互联网常见协议:http:超文本传输协议https:安全超文本传输协议FTP:文件传输协议TFTP:简单的文件传输协议telnet:远程管理协议DNS:域名解析协议snmp:简单的网络管理协议smtp:邮件协议(发邮件)pop3:邮件协议(收邮件) 6.#查看区域策略firewall-cmd –zone&#x3D;public –list-all 1234567891011121314[root@master dong]# firewall-cmd --zone=public --list-allpublic (active) target: default icmp-block-inversion: no interfaces: enp0s3 sources: services: dhcpv6-client ssh ports: protocols: masquerade: no forward-ports: source-ports: icmp-blocks: rich rules: 7.添加服务firewall-cmd –permanent –zone&#x3D;public –add-service&#x3D;http 8.生效规则firewall-cmd –reload 9.单独拒绝虚拟机desktop，所有的访问将虚拟机desktop的源IP地址,写入区域block虚拟机server:]# firewall-cmd –zone&#x3D;block –add-source&#x3D;172.25.0.10]# firewall-cmd –zone&#x3D;block –list-all 10.实现本机的端口映射本地应用的端口重定向(端口1 –&gt; 端口2)从客户机访问端口1的请求,自动映射到本机端口2比如,访问以下两个地址可以看到相同的页面:客户端: 172.25.0.11:5423—-&gt;172.25.0.11:80 ]# firewall-cmd –permanent-zone&#x3D;public –add-forward-port&#x3D;port&#x3D;5423:proto&#x3D;tcp:toport&#x3D;80","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"17-shell","slug":"运维/Linux云计算教程/17-shell","date":"2021-08-17T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/17/运维/Linux云计算教程/17-shell/","link":"","permalink":"https://dbbruce.github.io/2021/08/17/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/17-shell/","excerpt":"1.shell头部内容12#! /bin/bashifconfig | head -2","text":"1.shell头部内容12#! /bin/bashifconfig | head -2 2.单引号，将特殊字符转为普通字符‘’ 3.&#96;&#96; 和 $() 用法一样命令替换语法，它可以将命令的输出结果作为字符串使用。使用$()的方式可以简化命令的书写，提高命令的可维护性。一个简单的示例： 123# 使用ls命令列出当前目录的所有文件，然后使用wc命令统计文件数量file_num=$(ls | wc -l)echo &quot;The number of files in current directory is $file_num&quot; 4.变量a &#x3D;1234echo $a 5.向脚本中传递命令行参数read :1.产生交互2.记录用户在键盘输入3.将记录的信息赋值给一个变量储存 -p：屏幕输出信息 123#! /bin/bashread -p &quot;请输入&quot;: aecho $a 执行： 123[dong@master ~]$ ./1.sh请输入:12312311231231 6.shell注意：等号两边不能有空格7.变量使用$a &#x3D;&#x3D; ${a}{}的特殊使用场景：用于拼接${a}7 : a变量后拼接7 8.位置变量 $1 $2双数的值要用{}: ${10} ${11} &#x2F;root&#x2F;userc.sh tom dong $1 $2 12echo $1echo $2 12tomdong 9.预定义变量用来保存脚本程序的执行信息直接使用这些变量不能直接为这些变量赋值 变量名 含义 $# 已加载的位置变量的个数 $? 程序退出后的状态值，0表示正常，其他值异常 10.变量4种类型 类型 说 明 环境变量 变量名一般都大写，用来设置用户&#x2F;系统环境 位置变量 bash内置，存储执行脚本时提供的命令行参数 预定义变量 bash内置，可直接调用的特殊值，不能直接修改 自定义变量 用户自主设置、修改及使用 11.常用的测试选项[]:必须有空格：[空格 xxxx 空格]检查文件状态 -e:文档存在才为真 -d:文档存在,且必须为目录才为真 -f:文档存在,且必须为文件才为真 1[dong@master ~]$ [ -e /etc ] 比较整数大小 -gt:大于 -ge:大于等于 -eq:等于 -ne:不等于 -lt:小于 -le:小于等于 1[dong@master ~]$ [ 10 -le 11 ] 字符串比对 &#x3D;&#x3D; 一致为真 !&#x3D; 不一致为真 1[dong@master ~]$ [ bbb == 1231 ] 12.if语句12345if[条件测试];then 命令序列xxelse 命令序列yyif 13.for语句1234for 变量名 in 值列表do 命令序列done 123456#! /bin/bashfor a in dong1 dong2 dong3do echo $adone","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"16-NTP时间同步","slug":"运维/Linux云计算教程/16-NTP时间同步","date":"2021-08-16T03:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2021/08/16/运维/Linux云计算教程/16-NTP时间同步/","link":"","permalink":"https://dbbruce.github.io/2021/08/16/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/16-NTP%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5/","excerpt":"1.NTP网络时间协议Network Time Protocol NTP服务器为客户机提供标准时间- NTP客户机需要与NTP服务器保持沟通RHEL7客户端的校时服务软件包: chrony配置文件: &#x2F;etc&#x2F;chrony.conf系统服务: chronyd","text":"1.NTP网络时间协议Network Time Protocol NTP服务器为客户机提供标准时间- NTP客户机需要与NTP服务器保持沟通RHEL7客户端的校时服务软件包: chrony配置文件: &#x2F;etc&#x2F;chrony.conf系统服务: chronyd 使用ntp软件同步，一般这个就可以了安装包 1yum install -y ntp ntpdate 同步测试，看到下面信息表示成功 123ntpdate cn.pool.ntp.org19 Nov 18:08:07 ntpdate[1828]: step time server 119.28.183.184 offset 5941.769388 sec 添加定时任务，定时同步，1小时同步一次 123crontab -e* */1 * * * /usr/sbin/ntpdate cn.pool.ntp.org 重启守护进程crond 1systemctl restart crond.service 使用chrony同步,精度更高点安装 1[root@master ~]# yum -y install chrony 配置 12[root@master ~]# vim /etc/chrony.confserver ntp1.aliyun.com iburst 重启 1[root@master ~]# systemctl restart chronyd","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"15-find命令","slug":"运维/Linux云计算教程/15-find命令","date":"2021-08-15T03:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2021/08/15/运维/Linux云计算教程/15-find命令/","link":"","permalink":"https://dbbruce.github.io/2021/08/15/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/15-find%E5%91%BD%E4%BB%A4/","excerpt":"1.查找文件根据预设的条件递归查找对应的文件 find [目录] [条件1] [-a and |-o or] [条件2] 常用条件表示 -type 类型 (f文件、d目录、f快捷方式)” -name 文档名称 -size +(大于)|-(小于) 文件大小 (k小写、M大写、G大写) -user 用户名 -mtime 根据文件修改时间","text":"1.查找文件根据预设的条件递归查找对应的文件 find [目录] [条件1] [-a and |-o or] [条件2] 常用条件表示 -type 类型 (f文件、d目录、f快捷方式)” -name 文档名称 -size +(大于)|-(小于) 文件大小 (k小写、M大写、G大写) -user 用户名 -mtime 根据文件修改时间 123[root@master ~]# find ./ -name &quot;*k*&quot;./anaconda-ks.cfg./.pki 123[root@master ~]# find ./ -type f./.bash_logout./.bash_profile 12[root@master ~]# find ./ -size 2k./anaconda-ks.cfg 1234[root@master ~]# find ./ -size +1k # 大于1k./anaconda-ks.cfg./.bash_history./.viminfo 2.find扩展使用使用find命令的 –exec 操作find …. -exec 处理命令 {} ;优势: 以{}代替每一个结果，逐个处理，遇 ; 结束 1234[root@master ~]# find ./ -name &quot;*k*&quot; -exec ls -l &#123;&#125; \\;-rw-------. 1 root root 1455 8月 14 15:10 ./anaconda-ks.cfg总用量 0drwxr-----. 2 root root 6 8月 17 03:03 nssdb","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"18-Docker-Compose概述","slug":"运维/docker/基础/18-Docker-Compose概述","date":"2021-08-15T02:00:52.000Z","updated":"2023-12-05T02:55:54.000Z","comments":true,"path":"2021/08/15/运维/docker/基础/18-Docker-Compose概述/","link":"","permalink":"https://dbbruce.github.io/2021/08/15/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/18-Docker-Compose%E6%A6%82%E8%BF%B0/","excerpt":"Docker-Compose概述 Compose 项目是 Docker 官方的开源项目，负责实现对 Docker 容器集群的快速编排。使用前面介绍的Dockerfile我们很容易定义一个单独的应用容器。然而在日常开发工作中，经常会碰到需要多个容器相互配合来完成某项任务的情况。例如要实现一个 Web 项目，除了 Web 服务容器本身，往往还需要再加上后端的数据库服务容器；再比如在分布式应用一般包含若干个服务，每个服务一般都会部署多个实例。如果每个服务都要手动启停，那么效率之低、维护量之大可想而知。这时候就需要一个工具能够管理一组相关联的的应用容器，这就是Docker Compose。","text":"Docker-Compose概述 Compose 项目是 Docker 官方的开源项目，负责实现对 Docker 容器集群的快速编排。使用前面介绍的Dockerfile我们很容易定义一个单独的应用容器。然而在日常开发工作中，经常会碰到需要多个容器相互配合来完成某项任务的情况。例如要实现一个 Web 项目，除了 Web 服务容器本身，往往还需要再加上后端的数据库服务容器；再比如在分布式应用一般包含若干个服务，每个服务一般都会部署多个实例。如果每个服务都要手动启停，那么效率之低、维护量之大可想而知。这时候就需要一个工具能够管理一组相关联的的应用容器，这就是Docker Compose。 Compose有2个重要的概念： 项目（Project）：由一组关联的应用容器组成的一个完整业务单元，在 docker-compose.yml 文件中定义。 服务（Service）：一个应用的容器，实际上可以包括若干运行相同镜像的容器实例。 docker-compose运行目录下的所有yml文件组成一个工程，一个工程包含多个服务，每个服务中定义了容器运行的镜像、参数、依赖。一个服务可包括多个容器实例。docker-compose就是docker容器的编排工具，主要就是解决相互有依赖关系的多个容器的管理。 安装docker-compose 官方文档地址：https://docs.docker.com/compose/install/最新下载地址：https://github.com/goharbor/harbor/releases/download/v2.9.1/harbor-offline-installer-v2.9.1.tgz官方下载地址：curl -SL https://github.com/docker/compose/releases/download/v2.23.3/docker-compose-linux-x86_64 -o &#x2F;usr&#x2F;local&#x2F;bin&#x2F;docker-compose 添加可执行权限1[root@dbbruce-harbor ~]# chmod +x /usr/bin/docker-compose 12[root@dbbruce-harbor ~]# docker-compose versionDocker Compose version v2.23.3","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"docker","slug":"运维/docker","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/"},{"name":"基础","slug":"运维/docker/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"17-Docker私有镜像仓库harbor","slug":"运维/docker/基础/17-Docker私有镜像仓库harbor","date":"2021-08-14T12:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2021/08/14/运维/docker/基础/17-Docker私有镜像仓库harbor/","link":"","permalink":"https://dbbruce.github.io/2021/08/14/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/17-Docker%E7%A7%81%E6%9C%89%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93harbor/","excerpt":"Docker私有镜像仓库harborHarbor介绍 Harbor官方github地址： https://github.com/goharbor/harborHarbor官方地址： https://goharbor.io/官网地址：https://github.com/goharbor/harborDocker容器应用的开发和运行离不开可靠的镜像管理，虽然Docker官方也提供了公共的镜像仓库，但是从安全和效率等方面考虑，部署我们私有环境内的Registry也是非常必要的。Harbor是由VMware公司开源的企业级的Docker Registry管理项目，它包括权限管理(RBAC)、LDAP、日志审核、管理界面、自我注册、镜像复制和中文支持等功能。","text":"Docker私有镜像仓库harborHarbor介绍 Harbor官方github地址： https://github.com/goharbor/harborHarbor官方地址： https://goharbor.io/官网地址：https://github.com/goharbor/harborDocker容器应用的开发和运行离不开可靠的镜像管理，虽然Docker官方也提供了公共的镜像仓库，但是从安全和效率等方面考虑，部署我们私有环境内的Registry也是非常必要的。Harbor是由VMware公司开源的企业级的Docker Registry管理项目，它包括权限管理(RBAC)、LDAP、日志审核、管理界面、自我注册、镜像复制和中文支持等功能。 实验环境： 安装harbor的机器，主机名设置成 : dbbruce-harbor[root@loaclhost ~]# hostnamectl set-hostname dbbruce-harbor机器需要的内存至少要2G，我分配的是4G机器ip：192.168.1.324vCPU&#x2F;4G内存&#x2F;30G硬盘 为Harbor自签发证书12[root@dbbruce-harbor ~]# mkdir /data/ssl -p[root@dbbruce-harbor ~]# cd /data/ssl/ 生成ca证书 生成一个3072位的key，也就是私钥 openssl genrsa -out ca.key 3072 123456789[root@dbbruce-harbor ssl]# openssl genrsa -out ca.key 3072Generating RSA private key, 3072 bit long modulus..............................................................................................++..++e is 65537 (0x10001)[root@dbbruce-harbor ssl]# lsca.key 生成一个数字证书ca.pem，3650表示证书的有效时间是3年，按箭头提示填写即可，没有箭头标注的为空： openssl req -new -x509 -days 3650 -key ca.key -out ca.pem 123456[root@dbbruce-harbor ssl]# openssl req -new -x509 -days 3650 -key ca.key -out ca.pem[root@dbbruce-harbor ssl]# ll总用量 8-rw-r--r--. 1 root root 2459 11月 24 16:56 ca.key-rw-r--r--. 1 root root 1574 11月 24 16:58 ca.pem 生成域名的证书 生成一个3072位的key，也就是私钥 openssl genrsa -out dbbruce-harbor.key 3072 123456789101112[root@dbbruce-harbor ssl]# openssl genrsa -out dbbruce-harbor.key 3072Generating RSA private key, 3072 bit long modulus..................................++....................................................................................................++e is 65537 (0x10001)[root@dbbruce-harbor ssl]# ll -t总用量 12-rw-r--r--. 1 root root 2459 11月 24 17:09 dbbruce-harbor.key-rw-r--r--. 1 root root 1574 11月 24 16:58 ca.pem-rw-r--r--. 1 root root 2459 11月 24 16:56 ca.key 生成一个证书请求，一会签发证书时需要的，标箭头的按提示填写，没有箭头标注的为空： openssl req -new -key dbbruce-harbor.key -out dbbruce-harbor.csr 1[root@dbbruce-harbor ssl]# openssl req -new -key dbbruce-harbor.key -out dbbruce-harbor.csr 签发证书 openssl x509 -req -in dbbruce-harbor.csr -CA ca.pem -CAkey ca.key -CAcreateserial -out dbbruce-harbor.pem -days 3650显示如下，说明证书签发好了： 1234[root@dbbruce-harbor ssl]# openssl x509 -req -in harbor.csr -CA ca.pem -CAkey ca.key -CAcreateserial -out dbbruce-harbor.pem -days 3650Signature oksubject=/C=CH/ST=BJ/L=BJ/O=Default Company Ltd/CN=dbbruce-harborGetting CA Private Key 安装安装Docker 关闭防火墙1[root@dbbruce-harbor ~]# systemctl stop firewalld &amp;&amp; systemctl disable firewalld 关闭iptables防火墙123456789# 安装iptables[root@dbbruce-harbor ~]# yum install iptables-services -y# 禁用iptables[root@dbbruce-harbor ~]# service iptables stop &amp;&amp; systemctl disable iptablesRedirecting to /bin/systemctl stop iptables.service# 清空防火墙规则[root@dbbruce-harbor ~]# iptables -F 关闭selinux1234[root@dbbruce-harbor ~]# setenforce 0# 注意：修改selinux配置文件之后，重启机器，selinux才能永久生效[root@dbbruce-harbor ~]# sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config 配置时间同步12345678910[root@dbbruce-harbor ~]# yum install -y ntp ntpdate[root@dbbruce-harbor ~]# ntpdate cn.pool.ntp.org# 编写计划任务[root@dbbruce-harbor ~]# crontab -e[root@dbbruce-harbor ~]# crontab -l* */1 * * * /usr/sbin/ntpdate cn.pool.ntp.org# 重启crond服务使配置生效：[root@dbbruce-harbor ~]# systemctl restart crond 配置hosts文件123[root@dbbruce-harbor ~]# sudo vim /etc/hosts192.168.1.32 dbbruce-harbor192.168.1.12 CentOS07-12 安装基础软件包1[root@dbbruce-harbor ~]# yum install -y wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel python-devel epel-release openssh-server socat ipvsadm conntrack 配置docker-ce国内yum源（阿里云）1[root@dbbruce-harbor ~]# yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo 安装docker依赖包1[root@dbbruce-harbor ~]# yum install -y yum-utils device-mapper-persistent-data lvm2 安装docker-ce1[root@dbbruce-harbor ~]# yum install docker-ce -y 启动docker服务12[root@dbbruce-harbor ~]# systemctl start docker &amp;&amp; systemctl enable docker[root@dbbruce-harbor ~]# systemctl status docker 查看Docker 版本信息12345678910111213141516171819202122232425262728[root@dbbruce-harbor ~]# docker versionClient: Docker Engine - Community Version: 24.0.7 API version: 1.43 Go version: go1.20.10 Git commit: afdd53b Built: Thu Oct 26 09:11:35 2023 OS/Arch: linux/amd64 Context: defaultServer: Docker Engine - Community Engine: Version: 24.0.7 API version: 1.43 (minimum version 1.12) Go version: go1.20.10 Git commit: 311b9ff Built: Thu Oct 26 09:10:36 2023 OS/Arch: linux/amd64 Experimental: false containerd: Version: 1.6.25 GitCommit: d8f198a4ed8892c764191ef7b3b06d8a2eeb5c7f runc: Version: 1.1.10 GitCommit: v1.1.10-0-g18a0cb0 docker-init: Version: 0.19.0 GitCommit: de40ad0 开启包转发功能和修改内核参数: 内核参数修改：br_netfilter模块用于将桥接流量转发至iptables链，br_netfilter内核参数需要开启转发 Docker 安装后出现：WARNING: bridge-nf-call-iptables is disabled 的解决办法：net.bridge.bridge-nf-call-ip6tables &#x3D; 1net.bridge.bridge-nf-call-iptables &#x3D; 1net.ipv4.ip_forward &#x3D; 1将Linux系统作为路由或者VPN服务就必须要开启IP转发功能。当linux主机有多个网卡时一个网卡收到的信息是否能够传递给其他的网卡，如果设置成1的话，可以进行数据包转发，可以实现VxLAN 等功能。不开启会导致docker部署应用无法访问。 123456789101112[root@dbbruce-harbor ~]# modprobe br_netfilter[root@dbbruce-harbor ~]# cat &gt; /etc/sysctl.d/docker.conf &lt;&lt;EOF&gt; net.bridge.bridge-nf-call-ip6tables = 1&gt; net.bridge.bridge-nf-call-iptables = 1&gt; net.ipv4.ip_forward = 1&gt; EOF[root@dbbruce-harbor ~]# sysctl -p /etc/sysctl.d/docker.confnet.bridge.bridge-nf-call-ip6tables = 1net.bridge.bridge-nf-call-iptables = 1net.ipv4.ip_forward = 1 重启docker1[root@dbbruce-harbor ~]# systemctl restart docker docker镜像加速1234567[root@dbbruce-harbor ~]# vim /etc/docker/daemon.json&#123; &quot;registry-mirrors&quot;: [&quot;https://882k7j67.mirror.aliyuncs.com&quot;]&#125;[root@dbbruce-harbor ~]# systemctl daemon-reload[root@dbbruce-harbor ~]# systemctl restart docker 安装harbor 创建安装目录12[root@dbbruce-harbor ~]# mkdir /data/install -p[root@dbbruce-harbor ~]# cd /data/install &#x2F;data&#x2F;ssl目录下有如下文件123[root@dbbruce-harbor ssl]# cd /data/ssl/[root@dbbruce-harbor ssl]# lsca.key ca.pem ca.srl dbbruce-harbor.csr dbbruce-harbor.key dbbruce-harbor.pem 下载harbor压缩包1wget https://github.com/goharbor/harbor/releases/download/v2.9.1/harbor-offline-installer-v2.9.1.tgz 解压harbor压缩包12345678[root@dbbruce-harbor ~]# cd /data/install/[root@dbbruce-harbor install]# lsharbor-offline-installer-v2.9.1.tgz[root@dbbruce-harbor install]# tar zxvf harbor-offline-installer-v2.9.1.tgz[root@dbbruce-harbor install]# lsharbor harbor-offline-installer-v2.9.1.tgz[root@dbbruce-harbor install]# cd harbor/[root@dbbruce-harbor harbor]# cp harbor.yml.tmpl harbor.yml 修改配置文件 修改hostname，跟上面签发的证书域名保持一致; &#x3D;&#x3D;&#x3D;&#x3D; hostname: dbbruce-harbor协议用https; certificate: &#x2F;data&#x2F;ssl&#x2F;dbbruce-harbor.pem &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; private_key: &#x2F;data&#x2F;ssl&#x2F;dbbruce-harbor.key邮件和ldap不需要配置，在harbor的web界面可以配置其他配置采用默认即可注：harbor默认的账号密码：admin&#x2F;Harbor12345 1234[root@dbbruce-harbor harbor]# vim harbor.yml 5 hostname: dbbruce-harbor 17 certificate: /data/ssl/dbbruce-harbor.pem 18 private_key: /data/ssl/dbbruce-harbor.key 安装docker-compose docker-compose项目是Docker官方的开源项目，负责实现对Docker容器集群的快速编排。Docker-Compose的工程配置文件默认为docker-compose.yml，Docker-Compose运行目录下的必要有一个docker-compose.yml。docker-compose可以管理多个docker实例。官方下载地址: curl -SL https://github.com/docker/compose/releases/download/v2.23.3/docker-compose-linux-x86_64 -o &#x2F;usr&#x2F;local&#x2F;bin&#x2F;docker-compose 12[root@dbbruce-harbor ~]# mv docker-compose-linux-x86_64 /usr/bin/docker-compose[root@dbbruce-harbor ~]# chmod +x /usr/bin/docker-compose 安装harbor需要的离线镜像包docker-harbor-2-3-0.tar.gz在课件，可上传到harbor机器，通过docker load -i解压 百度网盘：链接:https://pan.baidu.com/s/1568CF7vQQseRD7vGFUaoVA 密码:gnvt 1234567891011121314151617181920[root@dbbruce-harbor ~]# docker load -i docker-harbor-2-3-0.tar.gz[root@dbbruce-harbor ~]# docker imagesREPOSITORY TAG IMAGE ID CREATED SIZEgoharbor/harbor-exporter v2.3.0 fa4ecf260b3a 2 years ago 80.7MBgoharbor/chartmuseum-photon v2.3.0 199be7eb1b5b 2 years ago 178MBgoharbor/redis-photon v2.3.0 3cc2c3e315a2 2 years ago 191MBgoharbor/trivy-adapter-photon v2.3.0 3c3dc5fc0529 2 years ago 164MBgoharbor/notary-server-photon v2.3.0 a8e3a26ef25a 2 years ago 105MBgoharbor/notary-signer-photon v2.3.0 e8776cc92436 2 years ago 102MBgoharbor/harbor-registryctl v2.3.0 4cf0d9bc3086 2 years ago 132MBgoharbor/registry-photon v2.3.0 222f05a9ab07 2 years ago 81MBgoharbor/nginx-photon v2.3.0 78f6ae7adc04 2 years ago 44MBgoharbor/harbor-log v2.3.0 9446a5b39706 2 years ago 194MBgoharbor/harbor-jobservice v2.3.0 bac328ac1a47 2 years ago 170MBgoharbor/harbor-core v2.3.0 7bbebce7798c 2 years ago 157MBgoharbor/harbor-portal v2.3.0 c4f22964cbf3 2 years ago 57.3MBgoharbor/harbor-db v2.3.0 fc74663d9e30 2 years ago 262MBgoharbor/prepare v2.3.0 a830321ca695 2 years ago 291MB 开始安装harbor1234567891011121314[root@dbbruce-harbor ~]# cd /data/install/harbor[root@dbbruce-harbor harbor]# ./install.sh ✔ Network harbor_harbor Created 0.3s ✔ Container harbor-log Started 0.1s ✔ Container harbor-db Started 0.2s ✔ Container harbor-portal Started 0.2s ✔ Container redis Started 0.1s ✔ Container registry Started 0.2s ✔ Container registryctl Started 0.2s ✔ Container harbor-core Started 0.1s ✔ Container harbor-jobservice Started 0.1s ✔ Container nginx Started 0.1s✔ ----Harbor has been installed and started successfully.---- 查看容器状态1234567891011[root@dbbruce-harbor harbor]# docker compose psNAME IMAGE COMMAND SERVICE CREATED STATUS PORTSharbor-core goharbor/harbor-core:v2.9.1 &quot;/harbor/entrypoint.sh&quot; core About a minute ago Up 54 seconds (healthy)harbor-db goharbor/harbor-db:v2.9.1 &quot;/docker-entrypoint.sh 13 14&quot; postgresql About a minute ago Up 55 seconds (healthy)harbor-jobservice goharbor/harbor-jobservice:v2.9.1 &quot;/harbor/entrypoint.sh&quot; jobservice About a minute ago Up 32 seconds (healthy)harbor-log goharbor/harbor-log:v2.9.1 &quot;/bin/sh -c /usr/local/bin/start.sh&quot; log About a minute ago Up 57 seconds (healthy) 127.0.0.1:1514-&gt;10514/tcpharbor-portal goharbor/harbor-portal:v2.9.1 &quot;nginx -g &#x27;daemon off;&#x27;&quot; portal About a minute ago Up 55 seconds (healthy)nginx goharbor/nginx-photon:v2.9.1 &quot;nginx -g &#x27;daemon off;&#x27;&quot; proxy About a minute ago Up 52 seconds (healthy) 0.0.0.0:80-&gt;8080/tcp, :::80-&gt;8080/tcp, 0.0.0.0:443-&gt;8443/tcp, :::443-&gt;8443/tcpredis goharbor/redis-photon:v2.9.1 &quot;redis-server /etc/redis.conf&quot; redis About a minute ago Up 55 seconds (healthy)registry goharbor/registry-photon:v2.9.1 &quot;/home/harbor/entrypoint.sh&quot; registry About a minute ago Up 55 seconds (healthy)registryctl goharbor/harbor-registryctl:v2.9.1 &quot;/home/harbor/start.sh&quot; registryctl About a minute ago Up 55 seconds (healthy) 访问：修改本机的hosts，用于通过域名访问harbor12dbbruce@dbburce githubblog % sudo vim /etc/hosts192.168.1.32 dbbruce-harbor 123dbbruce@dbburce githubblog % ping dbbruce-harborPING dbbruce-harbor (192.168.1.32): 56 data bytes64 bytes from 192.168.1.32: icmp_seq=0 ttl=64 time=30.397 ms https://dbbruce-harbor/ &#x3D;&#x3D;&#x3D; admin &#x3D;&#x3D;&#x3D; Harbor12345 所有基础镜像都会放在library里面，这是一个公开的镜像仓库 新建项目-&gt;起个项目名字test（把访问级别公开那个选中，让项目才可以被公开使用） 测试使用harbor私有镜像仓库 修改docker配置 “insecure-registries”:[“192.168.1.32”]上面增加的内容表示我们内网访问harbor的时候走的是http，192.168.1.32是安装harbor机器的ip 12345[root@centos07-12 ~]# vim /etc/docker/daemon.json 1 &#123; 2 &quot;registry-mirrors&quot;: [&quot;https://882k7j67.mirror.aliyuncs.com&quot;], 3 &quot;insecure-registries&quot;: [&quot;192.168.1.32&quot;,&quot;dbbruce-harbor&quot;] 4 &#125; 修改配置之后使配置生效1[root@centos07-12 ~]# systemctl daemon-reload &amp;&amp; systemctl restart docker 查看docker是否启动成功12345678910[root@centos07-12 ~]# systemctl status docker● docker.service - Docker Application Container Engine Loaded: loaded (/usr/lib/systemd/system/docker.service; enabled; vendor preset: disabled) Active: active (running) since 六 2023-11-25 01:18:26 CST; 20s ago Docs: https://docs.docker.com Main PID: 7768 (dockerd) Tasks: 14 Memory: 33.6M CGroup: /system.slice/docker.service └─7768 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock 登录harbor12345678[root@centos07-12 ~]# docker login 192.168.1.32Username: adminPassword: Harbor12345WARNING! Your password will be stored unencrypted in /root/.docker/config.json.Configure a credential helper to remove this warning. Seehttps://docs.docker.com/engine/reference/commandline/login/#credentials-storeLogin Succeeded # 这里表示成功 导入tomcat镜像1[root@centos07-12 ~]# docker load -i tomcat.tar.gz 把tomcat镜像打标签，注意这里由于docker push 不支持指定仓库ip，使用打标签带仓库ip的方式，上传到指定仓库 docker tag 原镜像 仓库ip&#x2F;仓库项目名&#x2F;镜像名:镜像版本 12345[root@centos07-12 ~]# docker tag tomcat:latest 192.168.1.32/test/tomcat:v1[root@centos07-12 ~]# docker imagesREPOSITORY TAG IMAGE ID CREATED SIZE192.168.1.32/test/tomcat v1 921ef208ab56 2 years ago 668MBtomcat latest 921ef208ab56 2 years ago 668MB 上传：执行命令就会把192.168.1.32&#x2F;test&#x2F;tomcat:v1上传到harbor里的test项目下12345678910111213[root@centos07-12 ~]# docker push 192.168.1.32/test/tomcat:v1The push refers to repository [192.168.1.32/test/tomcat]a9502f3f1738: Pushed26cdef4ed0c4: Pushede48093759a19: Pushedc47f8e016290: Pushedc0848348e2f7: Pushed79c550eb7bd2: Pushed7095af798ace: Pushedfe6a4fdbedc0: Pushede4d0e810d54a: Pushed4e006334a6fd: Pushedv1: digest: sha256:a3e9f6c942098d3b32c7810d3ec00079719198c9af41c3a32f6fc5d66124155f size: 2421 web查看 下载-从harbor仓库下载镜像123456789101112[root@centos07-12 ~]# docker rmi 192.168.1.32/test/tomcat:v1[root@centos07-12 ~]# docker pull 192.168.1.32/test/tomcat:v1v1: Pulling from test/tomcatDigest: sha256:a3e9f6c942098d3b32c7810d3ec00079719198c9af41c3a32f6fc5d66124155fStatus: Downloaded newer image for 192.168.1.32/test/tomcat:v1192.168.1.32/test/tomcat:v1[root@centos07-12 ~]# docker imagesREPOSITORY TAG IMAGE ID CREATED SIZE192.168.1.32/test/tomcat v1 921ef208ab56 2 years ago 668MBtomcat latest 921ef208ab56 2 years ago 668MB harbor高可用方案 可用将仓库A本地的镜像推送到另一个仓库B，从而实现高可用；系统管理 → 复制管理 → 新建规则 keeplive做vip，这样仓库A和仓库B故障了，就可以保证另一个还可以用","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"docker","slug":"运维/docker","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/"},{"name":"基础","slug":"运维/docker/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"14-逻辑卷管理","slug":"运维/Linux云计算教程/14-逻辑卷管理","date":"2021-08-14T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/14/运维/Linux云计算教程/14-逻辑卷管理/","link":"","permalink":"https://dbbruce.github.io/2021/08/14/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/14-%E9%80%BB%E8%BE%91%E5%8D%B7%E7%AE%A1%E7%90%86/","excerpt":"1.逻辑卷1.整合分散的空间，可以是一个磁盘上的空间，也可以是几个磁盘上的空间2.空间可以扩大，不影响原数据","text":"1.逻辑卷1.整合分散的空间，可以是一个磁盘上的空间，也可以是几个磁盘上的空间2.空间可以扩大，不影响原数据 2.逻辑卷制作思路将众多的PV(物理卷)组成VG(卷组)，再从VG(卷组)中划分LV(逻辑卷） 功能 物理卷管理 卷组管理 逻辑卷管理 Scan 扫描 pvscan vgscan lvscan Create 创建 pvcreate vgcreate lvcreate Display 显示 pvdisplay vgdisplay lvdisplay Remove 删除 pvremove vgremove lvremove Extend 扩展 &#x2F; vgextend lvextend","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"16-Docker资源配额","slug":"运维/docker/基础/16-Docker资源配额","date":"2021-08-14T02:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/14/运维/docker/基础/16-Docker资源配额/","link":"","permalink":"https://dbbruce.github.io/2021/08/14/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/16-Docker%E8%B5%84%E6%BA%90%E9%85%8D%E9%A2%9D/","excerpt":"Docker资源配额Docker通过cgroup来控制容器使用的资源限制，可以对docker限制的资源包括CPU、内存、磁盘 指定docker容器可以使用的cpu份额 查看配置份额的帮助命令：cpu配额参数：-c, –cpu-shares int 12[root@centos07-12 ~]# docker run --help | grep cpu-shares -c, --cpu-shares int CPU shares (relative weight)","text":"Docker资源配额Docker通过cgroup来控制容器使用的资源限制，可以对docker限制的资源包括CPU、内存、磁盘 指定docker容器可以使用的cpu份额 查看配置份额的帮助命令：cpu配额参数：-c, –cpu-shares int 12[root@centos07-12 ~]# docker run --help | grep cpu-shares -c, --cpu-shares int CPU shares (relative weight) 默认每个docker容器的cpu份额值都是1024 CPU shares (relative weight) 在创建容器时指定容器所使用的CPU份额值。cpu-shares的值不能保证可以获得1个vcpu或者多少GHz的CPU资源，仅仅只是一个弹性的加权值。 –cpu-shares 500-个人理解就是：这个500不是一个准确使用值，而是一个权重值； 在同一个CPU核心上，同时运行多个容器时，容器的cpu加权的效果才能体现出来。 宿主机查看绑定的信息： [root@centos07-12 b47da8a3d40ba472a8cd45fa20ad99aed5e9fa70eded4dffd2086cf1f87b1e57]# cd &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpuset&#x2F;docker&#x2F;b47da8a3d40ba472a8cd45fa20ad99aed5e9fa70eded4dffd2086cf1f87b1e57root@centos07-12 b47da8a3d40ba472a8cd45fa20ad99aed5e9fa70eded4dffd2086cf1f87b1e57]# ll用量 0rw-r–r–. 1 root root 0 11月 24 14:30 cgroup.clone_childrenw–w–w-. 1 root root 0 11月 24 14:30 cgroup.event_controlrw-r–r–. 1 root root 0 11月 24 14:30 cgroup.procsrw-r–r–. 1 root root 0 11月 24 14:30 cpuset.cpu_exclusiverw-r–r–. 1 root root 0 11月 24 14:30 cpuset.cpusr–r–r–. 1 root root 0 11月 24 14:30 cpuset.effective_cpusr–r–r–. 1 root root 0 11月 24 14:30 cpuset.effective_memsrw-r–r–. 1 root root 0 11月 24 14:30 cpuset.mem_exclusiverw-r–r–. 1 root root 0 11月 24 14:30 cpuset.mem_hardwallrw-r–r–. 1 root root 0 11月 24 14:30 cpuset.memory_migrater–r–r–. 1 root root 0 11月 24 14:30 cpuset.memory_pressurerw-r–r–. 1 root root 0 11月 24 14:30 cpuset.memory_spread_pagerw-r–r–. 1 root root 0 11月 24 14:30 cpuset.memory_spread_slabrw-r–r–. 1 root root 0 11月 24 14:30 cpuset.memsrw-r–r–. 1 root root 0 11月 24 14:30 cpuset.sched_load_balancerw-r–r–. 1 root root 0 11月 24 14:30 cpuset.sched_relax_domain_levelrw-r–r–. 1 root root 0 11月 24 14:30 notify_on_releaserw-r–r–. 1 root root 0 11月 24 14:30 tasks 例： 两个容器A、B的cpu份额分别为1000和500，结果会怎么样？ 1情况1：A和B正常运行，占用同一个CPU，在cpu进行时间片分配的时候，容器A比容器B多一倍的机会获得CPU的时间片。 12情况2：分配的结果取决于当时其他容器的运行状态。比如容器A的进程一直是空闲的，那么容器B是可以获取比容器A更多的CPU时间片的； 比如主机上只运行了一个容器，即使它的cpu份额只有50，它也可以独占整个主机的cpu资源。 cgroups只在多个容器同时争抢同一个cpu资源时，cpu配额才会生效。因此，无法单纯根据某个容器的cpu份额来确定有多少cpu资源分配给它，资源分配结果取决于同时运行的其他容器的cpu分配和容器中进程运行情况。 给容器实例分配512权重的cpu使用份额-参数:–cpu-shares 512 注：稍后，我们启动多个容器，测试一下是不是只能使用512份额的cpu资源。单独一个容器，看不出来使用的cpu的比例。 因没有docker实例同此docker实例竞争。 123[root@centos07-12 ~]# docker run -it --cpu-shares 512 centos bash[root@811221fc842a /]# cat /sys/fs/cgroup/cpu/cpu.shares512 总结：通过-c设置的 cpu share 并不是 CPU 资源的绝对数量，而是一个相对的权重值。某个容器最终能分配到的 CPU 资源取决于它的 cpu share 占所有容器 cpu share 总和的比例。通过 cpu share 可以设置容器使用 CPU 的优先级。 比如在 host 中启动了两个容器： container_A 的 cpu share 1024，是 container_B 的两倍。当两个容器都需要 CPU 资源时，container_A 可以得到的 CPU 是 container_B 的两倍。 12[root@centos07-12 ~]# docker run -it --name &quot;container_A&quot; -c 1024 centos bash[root@centos07-12 ~]# docker run -it --name &quot;container_B&quot; -c 512 centos bash 需要注意的是，这种按权重分配 CPU只会发生在 CPU资源紧张的情况下。如果 container_A 处于空闲状态，为了充分利用 CPU资源，container_B 也可以分配到全部可用的 CPU。 CPU core核心控制-参数:–cpuset 可以绑定CPU，指定使用的cpu： –cpuset cpu0 cpu1 对多核CPU的服务器，docker还可以控制容器运行限定使用哪些cpu内核和内存节点，即使用–cpuset-cpus和–cpuset-mems参数。对具有NUMA拓扑（具有多CPU、多内存节点）的服务器尤其有用，可以对需要高性能计算的容器进行性能最优的配置。如果服务器只有一个内存节点，则–cpuset-mems的配置基本上不会有明显效果。查看容器绑定的cpu核号：对应的Cgroup文件为&#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpuset&#x2F;docker&#x2F;容器ID号&#x2F;cpuset.cpus扩展：服务器架构一般分： SMP、NUMA、MPP体系结构介绍从系统架构来看，目前的商用服务器大体可以分为三类：1.即对称多处理器结构(SMP ： Symmetric Multi-Processor) 例： x86 服务器，双路服务器。主板上有两个物理cpu2.非一致存储访问结构 (NUMA ： Non-Uniform Memory Access) 例： IBM 小型机 pSeries 6903.海量并行处理结构 (MPP ： Massive ParallelProcessing) 。 例： 大型机 Z14 CPU配额控制参数的混合使用 在上面这些参数中，cpu-shares控制只发生在容器竞争同一个cpu的时间片时有效。如果通过cpuset-cpus指定容器A使用cpu 0，容器B只是用cpu1，在主机上只有这两个容器使用对应内核的情况，它们各自占用全部的内核资源，cpu-shares没有明显效果 如何才能有效果？123容器A和容器B配置上cpuset-cpus值并都绑定到同一个cpu上，然后同时抢占cpu资源，就可以看出效果了。例1：测试cpu-shares和cpuset-cpus混合使用运行效果，就需要一个压缩力测试工具stress来让容器实例把cpu跑满。 如何把cpu跑满？1如何把4核心的cpu中第一和第三核心跑满？可以运行stress，然后使用taskset绑定一下cpu。 先扩展：stress命令123456789101112131415161718概述：linux系统压力测试软件Stressstress参数解释-? 显示帮助信息-v 显示版本号-q 不显示运行信息-n 显示已完成的指令情况-t --timeout N 指定运行N秒后停止 --backoff N 等待N微妙后开始运行-c 产生n个进程 ：每个进程都反复不停的计算随机数的平方根，测试cpu-i 产生n个进程 ：每个进程反复调用sync()，sync()用于将内存上的内容写到硬盘上，测试磁盘io-m --vm n 产生n个进程,每个进程不断调用内存分配malloc（）和内存释放free（）函数 ，测试内存 --vm-bytes B 指定malloc时内存的字节数 （默认256MB） --vm-hang N 指定在free栈的秒数 -d --hadd n 产生n个执行write和unlink函数的进程 -hadd-bytes B 指定写的字节数 --hadd-noclean 不unlink 注：时间单位可以为秒s，分m，小时h，天d，年y，文件大小单位可以为K，M，G 12[root@centos07-12 ~]# yum install -y epel-release[root@centos07-12 ~]# yum -y install stress 例1：产生2个cpu进程，2个io进程，20秒后停止运行12# 如果执行时间为分钟，改20s 为1m[root@centos07-12 ~]# stress -c 2 -i 2 --verbose --timeout 20s 例2：测试cpuset-cpus和cpu-shares混合使用运行效果，就需要一个压缩力测试工具stress来让容器实例把cpu跑满。 当跑满后，会不会去其他cpu上运行。 如果没有在其他cpu上运行，说明cgroup资源限制成功。 注意：查看容器绑定的CPU核心：宿主机对应的Cgroup文件为：&#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpuset&#x2F;docker&#x2F;容器ID号&#x2F;cpuset.cpus1docker run -itd --name docker10 --cpuset-cpus 0 --cpu-shares 512 centos /bin/bash 例3：创建两个容器实例:docker10 和docker20。 让docker10和docker20只运行在cpu0和cpu1上，最终测试一下docker10和docker20使用cpu的百分比。实验拓扑图如下： 123456# 指定docker10只能在cpu0和cpu1上运行，而且docker10的使用cpu的份额512# 参数-itd就是又能打开一个伪终端，又可以在后台运行着docker实例[root@centos07-12 ~]# docker run -itd --name docker10 --cpuset-cpus 0,1 --cpu-shares 512 centos /bin/bash# 指定docker20只能在cpu0和cpu1上运行，而且docker20的使用cpu的份额1024，比dcker10多一倍[root@centos07-12 ~]# docker run -itd --name docker20 --cpuset-cpus 0,1 --cpu-shares 1024 centos /bin/bash 12345678910# 进入docker10，使用stress测试进程是不是只在cpu0,1上运行：[root@centos07-12 ~]# docker exec -it docker10 bash[root@b47da8a3d40b /]# stress -c 2 -v -t 10mstress: info: [123] dispatching hogs: 2 cpu, 0 io, 0 vm, 0 hddstress: dbug: [123] using backoff sleep of 6000usstress: dbug: [123] setting timeout to 600sstress: dbug: [123] --&gt; hogcpu worker 2 [124] forkedstress: dbug: [123] using backoff sleep of 3000usstress: dbug: [123] setting timeout to 600sstress: dbug: [123] --&gt; hogcpu worker 1 [125] forked 在物理机另外一个虚拟终端上运行top命令，按1快捷键，查看每个cpu使用情况，可看到正常。只在cpu0,1上运行： 12345678910# 进入docker20，使用stress测试进程是不是只在cpu0,1上运行，且docker20上运行的stress使用cpu百分比是docker10的2倍 [root@centos07-12 ~]# docker exec -it docker20 bash[root@3b103f5c23cf /]# stress -c 2 -v -t 10mstress: info: [122] dispatching hogs: 2 cpu, 0 io, 0 vm, 0 hddstress: dbug: [122] using backoff sleep of 6000usstress: dbug: [122] setting timeout to 600sstress: dbug: [122] --&gt; hogcpu worker 2 [123] forkedstress: dbug: [122] using backoff sleep of 3000usstress: dbug: [122] setting timeout to 600sstress: dbug: [122] --&gt; hogcpu worker 1 [124] forked 在另外一个虚拟终端上运行top命令，按1快捷键，查看每个cpu使用情况：注：两个容器只在cpu0,1上运行，说明cpu绑定限制成功。而docker20是docker10使用cpu的2倍。说明–cpu-shares限制资源成功 docker容器控制内存 Docker提供参数-m, –memory&#x3D;””限制容器的内存使用量。 例1：允许容器使用的内存上限为128M： -m &#x3D;&#x3D; –memory 相等 cat &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory&#x2F;memory.limit_in_bytes123[root@centos07-12 ~]# docker run -it -m 128m centos[root@d7291cfb7240 /]# cat /sys/fs/cgroup/memory/memory.limit_in_bytes134217728 注：也可以使用tress进行测试，到现在，我可以限制docker实例使用cpu的核心数和权重，可以限制内存大小 例2：创建一个docker，只使用2个cpu核心，只能使用128M内存 –cpuset-cpus 0,1 -m 128m 1[root@centos07-12 ~]# docker run -it --cpuset-cpus 0,1 -m 128m centos docker容器控制IO12[root@centos07-12 ~]# docker run --help | grep write-b --device-write-bps list Limit write rate (bytes per second) to a device (default []) 123# 限制此设备上的写速度（bytes per second），单位可以是kb、mb或者gb。 --device-read-bps value #限制此设备上的读速度（bytes per second），单位可以是kb、mb或者gb。 情景：防止某个 Docker 容器吃光你的磁盘 I / O 资源 例1：限制容器实例对硬盘的最高写入速度设定为 2MB&#x2F;s。 –device参数：将主机设备添加到容器 注：dd 参数：direct：读写数据采用直接IO方式，不走缓存。直接从内存写硬盘上。nonblock：读写数据采用非阻塞IO方式，优先写dd命令的数据 12[root@centos07-12 ~]# docker run -it -v /var/www/html/:/var/www/html/ --device /dev/sda:/dev/sda --device-write-bps /dev/sda:2mb centos bash[root@9cd29b258646 /]# time dd if=/dev/sda of=/var/www/html/test.out bs=2M count=50 oflag=direct,nonblock docker容器运行结束自动释放资源 作用：当容器命令运行结束后，自动删除容器，自动释放资源 12[root@centos07-12 ~]# docker run --help | grep rm --rm Automatically remove the container when it exits 例：1234[root@centos07-12 ~]# docker run -it --rm --name dbbruce centos sleep 6# 6秒后查看[root@centos07-12 ~]# docker ps |grep dbbruce","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"docker","slug":"运维/docker","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/"},{"name":"基础","slug":"运维/docker/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"15-Docker容器互联","slug":"运维/docker/基础/15-Docker容器互联","date":"2021-08-13T12:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2021/08/13/运维/docker/基础/15-Docker容器互联/","link":"","permalink":"https://dbbruce.github.io/2021/08/13/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/15-Docker%E5%AE%B9%E5%99%A8%E4%BA%92%E8%81%94/","excerpt":"Docker容器互联docker run创建Docker容器时，可以用–net选项指定容器的网络模式，Docker有以下4种网络模式： bridge模式：使–net &#x3D;bridge指定，默认设置； host模式：使–net &#x3D;host指定； none模式：使–net &#x3D;none指定；没有ip地址 container模式：使用–net &#x3D;container:NAME orID指定。","text":"Docker容器互联docker run创建Docker容器时，可以用–net选项指定容器的网络模式，Docker有以下4种网络模式： bridge模式：使–net &#x3D;bridge指定，默认设置； host模式：使–net &#x3D;host指定； none模式：使–net &#x3D;none指定；没有ip地址 container模式：使用–net &#x3D;container:NAME orID指定。 docker容器的网络基础 docker012安装docker的时候，会生成一个docker0的虚拟网桥；Linux虚拟网桥的特点:可以设置ip地址，相当于拥有一个隐藏的虚拟网卡； 123456789[root@centos07-12 volumetest]# ifconfigdocker0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500 inet 172.17.0.1 netmask 255.255.0.0 broadcast 172.17.255.255 inet6 fe80::42:3cff:fe9d:7a9d prefixlen 64 scopeid 0x20&lt;link&gt; ether 02:42:3c:9d:7a:9d txqueuelen 0 (Ethernet) RX packets 1 bytes 28 (28.0 B) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 5 bytes 446 (446.0 B) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 veth设备对1每运行一个docker容器都会生成一个veth设备对，这个veth一个接口在容器里，一个接口在物理机上。 安装网桥管理工具1[root@centos07-12 volumetest]# yum install bridge-utils -y brctl show1234567# brctl show 可以查看到有一个docker0的网桥设备，下面有很多接口，每个接口都表示一个启动的docker容器，# 因为我在docker上启动了很多容器，所以interfaces较多，如下所示[root@centos07-12 volumetest]# brctl showbridge name bridge id STP enabled interfacesdocker0 8000.02423c9d7a9d no veth61c3727 vethe53304c docker容器的互联实例 dockerfile12345678FROM centosRUN rm -rf /etc/yum.repos.d/*COPY Centos-vault-8.5.2111.repo /etc/yum.repos.d/RUN yum install wget -yRUN yum install nginx -yRUN sed -i &quot;7s/^/#/g&quot; /etc/nginx/conf.d/default.confEXPOSE 80CMD /bin/bash 构建1[root@centos07-12 inter-image]# docker build -t=&quot;inter-image&quot; . docker link 设置网络别名：docker run –link&#x3D;[CONTAINER_NAME]:[ALIAS] [IMAGE][COMMAND]12可以给容器起一个代号，这样可以直接以代号访问，避免了容器重启ip变化带来的问题；ping容器的代号，容器重启即使ip变了，也可以ping通 1234567891011121314151617# 正常启动一个容器，容器ip=172.17.0.4docker run --name test1 -itd inter-image /bin/bash# 启动一个test2容器，--link做链接，那么当我们重新启动test2容器时，就算ip变了，也没关系，我们可以在test2上ping别名webtest[root@centos07-12 inter-image]# docker run --name test2 -itd --link=test1:webtest inter-image /bin/bash[root@centos07-12 inter-image]# docker exec -it test2 bash[root@99a63f2be65b /]# ping webtestPING webtest (172.17.0.4) 56(84) bytes of data.64 bytes from webtest (172.17.0.4): icmp_seq=1 ttl=64 time=0.940 ms64 bytes from webtest (172.17.0.4): icmp_seq=2 ttl=64 time=0.118 ms# 重启test1，ip变为：172.17.0.6，使用webtest仍然能ping通[root@centos07-12 inter-image]# docker restart test1[root@centos07-12 inter-image]# docker exec -it test2 bash[root@99a63f2be65b /]# ping webtestPING webtest (172.17.0.6) 56(84) bytes of data.64 bytes from webtest (172.17.0.6): icmp_seq=1 ttl=64 time=0.144 ms docker容器的网络模式12345docker run创建docker容器时，可以用--net选项指定容器的网络模式，Docker有以下4种网络模式：bridge模式：使--net =bridge指定，默认设置；host模式：使--net =host指定；none模式：使--net =none指定；container模式：使用--net =container:NAME orID指定。 开启特权模式：–privileged&#x3D;true none模式：Docker网络none模式是指创建的容器没有网络地址，只有lo网卡，没有ip，只有本地loop；12345678910[root@centos07-12 ~]# docker run -itd --name net-none --net=none --privileged=true centos[root@centos07-12 ~]# docker exec -it net-none /bin/bash# 只有lo网卡[root@d396a0dc6b38 /]# ip a s1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever container模式12345Docker网络container模式是指，创建新容器的时候，通过--net container参数，指定其和已经存在的某个容器，共享一个 Network Namespace。如下图所示，右方黄色新创建的container，其网卡共享左边容器。因此就不会拥有自己独立的 IP，而是共享左边容器的 IP 172.17.0.2,端口范围等网络资源，两个容器的进程通过 lo 网卡设备通信格式：docker run --name 新容器名 --net=container:共享的容器名 -it --privileged=true centos注意：和共享的容器ip信息完全相同，这是因为共用网络导致； 12345678[root@centos07-12 ~]# docker run --name container1 --net=container:net-none -it --privileged=true centos# 和已经存在的net-none容器共享网络[root@d396a0dc6b38 /]# ip a s1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever bridge模式1默认选择bridge的情况下，容器启动后会通过DHCP获取一个地址；宿主机可以访问外网，桥接也可以。 123456789101112131415# 创建桥接网络[root@centos07-12 ~]# docker run --name bridge -itd --privileged=true centos bash[root@centos07-12 ~]# docker exec -it bridge bash[root@a0fbf3d5c35d /]# ip a s1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever53: eth0@if54: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0 inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0 valid_lft forever preferred_lft forever host模式1Docker网络host模式是指共享宿主机的网络;会和宿主机的网络一样，宿主机的网卡，容器全都有； 1# 共享宿主机网络 123456789101112131415161718192021222324252627282930313233343536[root@centos07-12 ~]# docker run --name host2 -itd --net=host --privileged=true centos bash275c2d0a3c0eeaac1a70d7c2f5983adeebcb8e17a282a11cced508908587dda9[root@centos07-12 ~]# docker exec -it host2 bash[root@centos07-12 /]# ip a s1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever inet6 ::1/128 scope host valid_lft forever preferred_lft forever2: enp0s3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 08:00:27:79:a3:b8 brd ff:ff:ff:ff:ff:ff inet 192.168.1.12/24 brd 192.168.1.255 scope global noprefixroute enp0s3 valid_lft forever preferred_lft forever inet6 2409:8a00:603d:21c0:ea29:1f44:4e6:a610/64 scope global dynamic noprefixroute valid_lft 259166sec preferred_lft 172766sec inet6 fe80::6810:86a3:8a2:f1ca/64 scope link noprefixroute valid_lft forever preferred_lft forever3: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 08:00:27:38:9e:7a brd ff:ff:ff:ff:ff:ff inet 10.0.3.15/24 brd 10.0.3.255 scope global dynamic noprefixroute eth0 valid_lft 74302sec preferred_lft 74302sec inet6 fe80::a3d2:b68c:7f54:985f/64 scope link noprefixroute valid_lft forever preferred_lft forever4: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default link/ether 02:42:3c:9d:7a:9d brd ff:ff:ff:ff:ff:ff inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0 valid_lft forever preferred_lft forever inet6 fe80::42:3cff:fe9d:7a9d/64 scope link valid_lft forever preferred_lft forever54: vethe2ca0ad@if53: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default link/ether de:6b:28:2d:95:fa brd ff:ff:ff:ff:ff:ff link-netnsid 0 inet6 fe80::dc6b:28ff:fe2d:95fa/64 scope link valid_lft forever preferred_lft forever","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"docker","slug":"运维/docker","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/"},{"name":"基础","slug":"运维/docker/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"13-磁盘分区","slug":"运维/Linux云计算教程/13-磁盘分区","date":"2021-08-13T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/13/运维/Linux云计算教程/13-磁盘分区/","link":"","permalink":"https://dbbruce.github.io/2021/08/13/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/13-%E7%A3%81%E7%9B%98%E5%88%86%E5%8C%BA/","excerpt":"1.显示磁盘信息12345678[dong@master t1]$ lsblkNAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINTsda 8:0 0 30G 0 disk├─sda1 8:1 0 1G 0 part /boot└─sda2 8:2 0 29G 0 part ├─centos-root 253:0 0 26G 0 lvm / └─centos-swap 253:1 0 3G 0 lvm [SWAP]sr0 11:0 1 4.4G 0 rom","text":"1.显示磁盘信息12345678[dong@master t1]$ lsblkNAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINTsda 8:0 0 30G 0 disk├─sda1 8:1 0 1G 0 part /boot└─sda2 8:2 0 29G 0 part ├─centos-root 253:0 0 26G 0 lvm / └─centos-swap 253:1 0 3G 0 lvm [SWAP]sr0 11:0 1 4.4G 0 rom 2.格式化磁盘mkfs.ext4 &#x2F;dev&#x2F;sdbmkfs.xfs &#x2F;dev&#x2F;sdb 3.挂载磁盘mkdir &#x2F;data1mount &#x2F;dev&#x2F;sdb &#x2F;data1df 查看 123456789[dong@master t1]$ df -h文件系统 容量 已用 可用 已用% 挂载点devtmpfs 1.9G 0 1.9G 0% /devtmpfs 1.9G 0 1.9G 0% /dev/shmtmpfs 1.9G 17M 1.9G 1% /runtmpfs 1.9G 0 1.9G 0% /sys/fs/cgroup/dev/mapper/centos-root 26G 1.5G 25G 6% //dev/sda1 1014M 153M 862M 16% /boottmpfs 379M 0 379M 0% /run/user/0 4.开机挂载注意：写错了，重启会导致系统打不开 配置文件：&#x2F;etc&#x2F;fstab格式如下 设备路径 挂载点 文件类型 参数 备份标记 检测顺序&#x2F;dev&#x2F;sdb &#x2F;data1 ext4 default 0 0&#x2F;dev&#x2F;mapper&#x2F;centos-root &#x2F; xfs defaults 0 0 检测文件写的是否正确：mount -a 5.添加磁盘1、查看新磁盘123456789[root@master ~]# lsblkNAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINTsda 8:0 0 30G 0 disk├─sda1 8:1 0 1G 0 part /boot└─sda2 8:2 0 29G 0 part ├─centos-root 253:0 0 26G 0 lvm / └─centos-swap 253:1 0 3G 0 lvm [SWAP]sdb 8:16 0 5G 0 disksr0 11:0 1 1024M 0 rom 2、创建分区12345678910111213141516171819202122232425[root@master ~]# fdisk /dev/sdb欢迎使用 fdisk (util-linux 2.23.2)。更改将停留在内存中，直到您决定将更改写入磁盘。使用写入命令前请三思。Device does not contain a recognized partition table使用磁盘标识符 0x34e98317 创建新的 DOS 磁盘标签。命令(输入 m 获取帮助)：n # 开始分区Partition type: p primary (0 primary, 0 extended, 4 free) e extendedSelect (default p): p # 主分区分区号 (1-4，默认 1)：起始 扇区 (2048-10485759，默认为 2048)：+2G # 大小2GLast 扇区, +扇区 or +size&#123;K,M,G&#125; (4194304-10485759，默认为 10485759)：将使用默认值 10485759分区 1 已设置为 Linux 类型，大小设为 3 GiB命令(输入 m 获取帮助)：w #写入The partition table has been altered!Calling ioctl() to re-read partition table.正在同步磁盘。 3.刷新查看，分区partprobe 1234567891011[root@master ~]# partprobe# [root@master ~]# lsblkNAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINTsda 8:0 0 30G 0 disk├─sda1 8:1 0 1G 0 part /boot└─sda2 8:2 0 29G 0 part ├─centos-root 253:0 0 26G 0 lvm / └─centos-swap 253:1 0 3G 0 lvm [SWAP]sdb 8:16 0 5G 0 disk└─sdb1 8:17 0 3G 0 partsr0 11:0 1 1024M 0 rom 4.格式化分区mkfs.xfs &#x2F;dev&#x2F;sdb1 12345678910[root@master ~]# mkfs.xfs /dev/sdb1meta-data=/dev/sdb1 isize=512 agcount=4, agsize=196608 blks = sectsz=512 attr=2, projid32bit=1 = crc=1 finobt=0, sparse=0data = bsize=4096 blocks=786432, imaxpct=25 = sunit=0 swidth=0 blksnaming =version 2 bsize=4096 ascii-ci=0 ftype=1log =internal log bsize=4096 blocks=2560, version=2 = sectsz=512 sunit=0 blks, lazy-count=1realtime =none extsz=4096 blocks=0, rtextents=0 查看blkid &#x2F;dev&#x2F;sdb1 12[root@master ~]# blkid /dev/sdb1/dev/sdb1: UUID=&quot;7b0868c1-433f-4734-b66d-c9af1e3af20b&quot; TYPE=&quot;xfs&quot; 5.开机自动挂载vim &#x2F;etc&#x2F;fstab 123456789101112[root@master /]# vim /etc/fstab## /etc/fstab# Created by anaconda on Mon Aug 14 14:57:45 2023## Accessible filesystems, by reference, are maintained under &#x27;/dev/disk&#x27;# See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info#/dev/mapper/centos-root / xfs defaults 0 0UUID=ad0768aa-5233-4b19-8b01-14a96751beee /boot xfs defaults 0 0/dev/mapper/centos-swap swap swap defaults 0 0/dev/sdb1 /data xfs defaults 0 0 6.测试挂载文件是否有问题，这个非常重要，如果有问题，会导致无法启动，一定要测试mount -a 1234567891011[root@master /]# mount -a[root@master /]# df -h文件系统 容量 已用 可用 已用% 挂载点devtmpfs 1.9G 0 1.9G 0% /devtmpfs 1.9G 0 1.9G 0% /dev/shmtmpfs 1.9G 8.7M 1.9G 1% /runtmpfs 1.9G 0 1.9G 0% /sys/fs/cgroup/dev/mapper/centos-root 26G 1.5G 25G 6% //dev/sda1 1014M 153M 862M 16% /boottmpfs 379M 0 379M 0% /run/user/0/dev/sdb1 3.0G 33M 3.0G 2% /data","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"14-Docker容器的数据持久化","slug":"运维/docker/基础/14-Docker容器的数据持久化","date":"2021-08-13T02:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/13/运维/docker/基础/14-Docker容器的数据持久化/","link":"","permalink":"https://dbbruce.github.io/2021/08/13/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/14-Docker%E5%AE%B9%E5%99%A8%E7%9A%84%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96/","excerpt":"Docker容器的数据持久化及容器互联一、Docker容器的数据管理Docker容器的数据卷123456789什么是数据卷？数据卷是经过特殊设计的目录，可以绕过联合文件系统（UFS），为一个或者多个容器提供访问，数据卷设计的目的，在于数据的永久存储，它完全独立于容器的生存周期，因此，docker不会在容器删除时删除其挂载的数据卷，也不会存在类似的垃圾收集机制，对容器引用的数据卷进行处理，同一个数据卷可以只支持多个容器的访问。数据卷的特点：1.数据卷在容器启动时初始化，如果容器使用的镜像在挂载点包含了数据，这些数据会被拷贝到新初始化的数据卷中2.数据卷可以在容器之间共享和重用3.可以对数据卷里的内容直接进行修改4.数据卷的变化不会影像镜像的更新5.卷会一直存在，即使挂载数据卷的容器已经被删除","text":"Docker容器的数据持久化及容器互联一、Docker容器的数据管理Docker容器的数据卷123456789什么是数据卷？数据卷是经过特殊设计的目录，可以绕过联合文件系统（UFS），为一个或者多个容器提供访问，数据卷设计的目的，在于数据的永久存储，它完全独立于容器的生存周期，因此，docker不会在容器删除时删除其挂载的数据卷，也不会存在类似的垃圾收集机制，对容器引用的数据卷进行处理，同一个数据卷可以只支持多个容器的访问。数据卷的特点：1.数据卷在容器启动时初始化，如果容器使用的镜像在挂载点包含了数据，这些数据会被拷贝到新初始化的数据卷中2.数据卷可以在容器之间共享和重用3.可以对数据卷里的内容直接进行修改4.数据卷的变化不会影像镜像的更新5.卷会一直存在，即使挂载数据卷的容器已经被删除 数据卷的使用 为容器添加数据卷，-v 宿主机目录：容器目录1docker run -v /datavolume:/data -it centos /bin/bash ~&#x2F;datavolume为宿主机目录，&#x2F;data为docker启动的volume容器的里的目录，这样在宿主机的&#x2F;datavolume目录下创建的数据就会同步到容器的&#x2F;data目录下1docker run --name volume -v ~/datavolume:/data -itd centos /bin/bash 为数据卷添加访问权限，添加只读权限之后在docker容器的&#x2F;data目录下就不能在创建文件了，为只读权限；在宿主机下的&#x2F;datavolume1下可以创建东西1docker run --name volume1 -v ~/datavolume1:/data:ro -itd centos /bin/bash 使用dockerfile构建包含数据卷的镜像，volume[“&#x2F;data1”， “&#x2F;data2”]，在容器里创建2个数据卷123FROM centosVOLUME [&quot;/datavolume3&quot;,&quot;/datavolume6&quot;]CMD /bin/bash source里是宿主机目录 123456789101112131415161718192021222324[root@centos07-12 volumetest]# docker inspect 94ea546e98ae &quot;Mounts&quot;: [ &#123; &quot;Type&quot;: &quot;volume&quot;, &quot;Name&quot;: &quot;b4012ea6926e26b374c44a006da38701504bfcda62fb597fd8b0eef6ece73e93&quot;, &quot;Source&quot;: &quot;/var/lib/docker/volumes/b4012ea6926e26b374c44a006da38701504bfcda62fb597fd8b0eef6ece73e93/_data&quot;, &quot;Destination&quot;: &quot;/datavolume3&quot;, &quot;Driver&quot;: &quot;local&quot;, &quot;Mode&quot;: &quot;&quot;, &quot;RW&quot;: true, &quot;Propagation&quot;: &quot;&quot; &#125;, &#123; &quot;Type&quot;: &quot;volume&quot;, &quot;Name&quot;: &quot;8ca5886212fa3809b5d4e56cf10f0c537512ff9e63f795d959821ee19de32934&quot;, &quot;Source&quot;: &quot;/var/lib/docker/volumes/8ca5886212fa3809b5d4e56cf10f0c537512ff9e63f795d959821ee19de32934/_data&quot;, &quot;Destination&quot;: &quot;/datavolume6&quot;, &quot;Driver&quot;: &quot;local&quot;, &quot;Mode&quot;: &quot;&quot;, &quot;RW&quot;: true, &quot;Propagation&quot;: &quot;&quot; &#125; ], 1[root@centos07-12 volumetest]# docker build -t=&quot;volume2:v1&quot; . 1[root@centos07-12 volumetest]# docker run --name volume2test666 -itd volume2:v1 二、Docker的数据卷容器什么是数据卷容器1命名的容器挂载数据卷，其他容器通过挂载这个容器实现数据共享，挂载数据卷的容器，就叫做数据卷容器 挂载数据卷容器的方法 挂载数据卷容器的方法：docker run –volumes-from [container name], –volumes-from 其他容器名称 创建一个数据卷容器123456789# 运行一个容器，作为数据卷容器[root@centos07-12 volumetest]# docker run --name data-volume -itd volumeb29cd10b738e3666320ade814ede20a28d65d634a51b7f3cddf85db3eed00b9b# 进入容器，可以看到有2个数据卷[root@centos07-12 volumetest]# docker exec -it data-volume /bin/bash[root@b29cd10b738e /]# ls /bin boot datavolume3 datavolume6 dev etc home lib lib64 lost+found media mnt opt proc root run sbin srv sys tmp usr var 创建一个新容器挂载刚才data-volume这个容器创建的数据卷，后启动的容器也会有2个数据卷，后期的容器使用centos镜像12345678# 关注其他容器卷[root@centos07-12 volumetest]# docker run --volumes-from data-volume -itd centos# 进入容器，也有2个卷[root@centos07-12 volumetest]# docker exec -it frosty_neumann /bin/bash[root@125c5f2754c1 /]# ls /bin boot datavolume3 datavolume6 dev etc home lib lib64 lost+found media mnt opt proc root run sbin srv sys tmp usr var docker数据卷的备份和还原 数据备份方法：docker run –volumes-from [container name] -v $(pwd):&#x2F;backup centos tar czvf &#x2F;backup&#x2F;backup.tar [container data volume] 备份注意项：备份不会运行新容器，新容器是停止的，使用docker ps -a查看;备份的容器不会创建备份目录12345678910[root@centos07-12 volumetest]# docker run --volumes-from data-volume -v /root/backup:/backup --name datavolume-copy centos tar zcvf /backup/data-volume6.tar.gz /datavolume6/# 宿主机[root@centos07-12 volumetest]# ll /root/backup/总用量 4-rw-r--r--. 1 root root 163 11月 23 19:00 data-volume6.tar.gz# 备份的容器：data-volume，不会有备份目录[root@b29cd10b738e /]# ls /backupls: cannot access &#x27;/backup&#x27;: No such file or directory 数据还原方法：docker run –volumes-from [container name] -v $(pwd):&#x2F;backup centos tar xzvf &#x2F;backup&#x2F;backup.tar.gz [container data volume]123456789101112# 删除文件[root@b29cd10b738e /]# rm -fr datavolume6/6.txt# 还原[root@centos07-12 volumetest]# docker run --volumes-from data-volume -v /root/backup/:/backup centos tar xzvf /backup/data-volume6.tar.gz -C /datavolume6datavolume6/datavolume6/6.txt# 文件恢复[root@centos07-12 volumetest]# docker exec -it data-volume bash[root@b29cd10b738e /]# ls /datavolume6/*6.txt","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"docker","slug":"运维/docker","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/"},{"name":"基础","slug":"运维/docker/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"13-把python代码基于dockerfile做成镜像","slug":"运维/docker/基础/13-把python代码基于dockerfile做成镜像","date":"2021-08-12T12:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/12/运维/docker/基础/13-把python代码基于dockerfile做成镜像/","link":"","permalink":"https://dbbruce.github.io/2021/08/12/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/13-%E6%8A%8Apython%E4%BB%A3%E7%A0%81%E5%9F%BA%E4%BA%8Edockerfile%E5%81%9A%E6%88%90%E9%95%9C%E5%83%8F/","excerpt":"把python代码基于dockerfile做成镜像获取镜像1[root@centos07-22 ~]# docker pull python:3.7 main.py123456789from flask import Flaskapp = Flask(__name__)@app.route(&quot;/&quot;)def hello(): return &quot;Hello from Python!&quot;if __name__ == &quot;__main__&quot;: app.run(host=&#x27;0.0.0.0&#x27;)","text":"把python代码基于dockerfile做成镜像获取镜像1[root@centos07-22 ~]# docker pull python:3.7 main.py123456789from flask import Flaskapp = Flask(__name__)@app.route(&quot;/&quot;)def hello(): return &quot;Hello from Python!&quot;if __name__ == &quot;__main__&quot;: app.run(host=&#x27;0.0.0.0&#x27;) dockerfile123456789FROM python:3.7MAINTAINER dbbruceRUN mkdir /appWORKDIR /appADD . /app/ # 把dockerfile目录所在的文件全部传到app目录RUN /usr/local/bin/python -m pip install --upgrade pipRUN pip install -r requirements.txtEXPOSE 5000CMD [&quot;python&quot;,&quot;/app/main.py&quot;] 构建镜像1[root@centos07-22 pythontest]# docker build -t pytest:v1 . 基于镜像运行python代码1[root@centos07-22 pythontest]# docker run -d --name python -p 30050:5000 pytest:v1 访问12[root@centos07-22 pythontest]# curl http://192.168.1.22:30050/Hello from Python!","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"docker","slug":"运维/docker","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/"},{"name":"基础","slug":"运维/docker/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"12-把Go代码基于dockerfile做成镜像","slug":"运维/docker/基础/12-把Go代码基于dockerfile做成镜像","date":"2021-08-12T05:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2021/08/12/运维/docker/基础/12-把Go代码基于dockerfile做成镜像/","link":"","permalink":"https://dbbruce.github.io/2021/08/12/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/12-%E6%8A%8AGo%E4%BB%A3%E7%A0%81%E5%9F%BA%E4%BA%8Edockerfile%E5%81%9A%E6%88%90%E9%95%9C%E5%83%8F/","excerpt":"把Go代码基于dockerfile做成镜像main.go123456789101112131415161718192021222324252627[root@centos07-22 ~]# mkdir test[root@centos07-22 ~]# cd test/[root@centos07-22 gotest]# cat main.go package mainimport ( &quot;net/http&quot; &quot;github.com/gin-gonic/gin&quot;)func statusOKHandler(c *gin.Context) &#123; c.JSON(http.StatusOK, gin.H&#123;&quot;status&quot;: &quot;success~welcome to study&quot;&#125;)&#125;func versionHandler(c *gin.Context) &#123; c.JSON(http.StatusOK, gin.H&#123;&quot;version&quot;: &quot;v1.1版本&quot;&#125;)&#125;func main() &#123; router := gin.New() router.Use(gin.Recovery()) router.GET(&quot;/&quot;, statusOKHandler) router.GET(&quot;/version&quot;, versionHandler) router.Run(&quot;:8080&quot;)&#125;","text":"把Go代码基于dockerfile做成镜像main.go123456789101112131415161718192021222324252627[root@centos07-22 ~]# mkdir test[root@centos07-22 ~]# cd test/[root@centos07-22 gotest]# cat main.go package mainimport ( &quot;net/http&quot; &quot;github.com/gin-gonic/gin&quot;)func statusOKHandler(c *gin.Context) &#123; c.JSON(http.StatusOK, gin.H&#123;&quot;status&quot;: &quot;success~welcome to study&quot;&#125;)&#125;func versionHandler(c *gin.Context) &#123; c.JSON(http.StatusOK, gin.H&#123;&quot;version&quot;: &quot;v1.1版本&quot;&#125;)&#125;func main() &#123; router := gin.New() router.Use(gin.Recovery()) router.GET(&quot;/&quot;, statusOKHandler) router.GET(&quot;/version&quot;, versionHandler) router.Run(&quot;:8080&quot;)&#125; Go mod初始化项目12345678910111213[root@centos07-22 gotest]# go mod init test#设置代理,直接拉包比较慢[root@centos07-22 gotest]# go env -w GOPROXY=https://goproxy.cn,direct[root@centos07-22 gotest]# go mod tidy#构建源码[root@centos07-22 gotest]# CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o k8s-demo main.go[root@centos07-22 gotest]# lltotal 21944-rw-r--r-- 1 dbbruce staff 1291 11 22 23:35 go.mod-rw-r--r-- 1 dbbruce staff 7701 11 22 23:35 go.sum-rwxr-xr-x 1 dbbruce staff 11217153 11 23 14:11 k8s-demo-rw-r--r-- 1 dbbruce staff 433 11 22 23:33 main.go 编写dockerfile文件123456[root@centos07-22 gotest]# cat Dockerfile FROM alpineWORKDIR /data/appADD k8s-demo /data/app/CMD [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;./k8s-demo&quot;] 构建镜像123[root@centos07-22 gotest]# docker pull alpine[root@centos07-22 gotest]# docker build -t dbbruce/k8sdemo:v1 . 运行镜像1[root@centos07-22 gotest]# docker run -d --name gotest -p 30180:8080 dbbruce/k8sdemo:v1 访问go容器123[root@centos07-22 gotest]# curl http://192.168.1.22:30180/&#123;&quot;status&quot;:&quot;success~welcome to study&quot;&#125;","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"docker","slug":"运维/docker","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/"},{"name":"基础","slug":"运维/docker/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"12-软件包管理","slug":"运维/Linux云计算教程/12-软件包管理","date":"2021-08-12T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/12/运维/Linux云计算教程/12-软件包管理/","link":"","permalink":"https://dbbruce.github.io/2021/08/12/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/12-%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%AE%A1%E7%90%86/","excerpt":"1.wget1wget 软件路径 -O /目录/新文件名","text":"1.wget1wget 软件路径 -O /目录/新文件名 2.RPM-q 包名 ：查找-ivh 包名 ：安装-e 包名 ：卸载 3.YUM 软件包仓库，自动解决依赖问题指定服务端的位置：&#x2F;etc&#x2F;yum.repos.d&#x2F;.repo注意：这些.repo文件，只要有一个错误的，其他的都不能用 123456789[dong@master t1]$ ll /etc/yum.repos.d/*.repo-rw-r--r--. 1 root root 1664 10月 23 2020 /etc/yum.repos.d/CentOS-Base.repo-rw-r--r--. 1 root root 1309 10月 23 2020 /etc/yum.repos.d/CentOS-CR.repo-rw-r--r--. 1 root root 649 10月 23 2020 /etc/yum.repos.d/CentOS-Debuginfo.repo-rw-r--r--. 1 root root 314 10月 23 2020 /etc/yum.repos.d/CentOS-fasttrack.repo-rw-r--r--. 1 root root 630 10月 23 2020 /etc/yum.repos.d/CentOS-Media.repo-rw-r--r--. 1 root root 1331 10月 23 2020 /etc/yum.repos.d/CentOS-Sources.repo-rw-r--r--. 1 root root 8515 10月 23 2020 /etc/yum.repos.d/CentOS-Vault.repo-rw-r--r--. 1 root root 616 10月 23 2020 /etc/yum.repos.d/CentOS-x86_64-kernel.repo 4.添加YUM软件包仓库 创建文件vim &#x2F;etc&#x2F;yum.repos.d&#x2F;dong.repo 写入内容12345[dvd] #仓库名字，英文，不要有中文和特殊符号name=redhat7test #描述信息baseurl=http://xxxxxxxxx #指定服务位置enable=1 # 开启 0禁用gpgcheck=0 #检测包的签名认证，不检测 5.yum常用命令yum repolist 列出仓库信息yum -y install httpd 安装软件yum -q httpd 查看软件安装列表yum remove httpd 卸载软件yum clean all 清空缓存，yum源文件修改后，清理缓存后，会立即生效","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"11-Dockerfile构建生产环境Tomcat镜像","slug":"运维/docker/基础/11-dockerfile构建生产环境Tomcat镜像","date":"2021-08-11T05:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/11/运维/docker/基础/11-dockerfile构建生产环境Tomcat镜像/","link":"","permalink":"https://dbbruce.github.io/2021/08/11/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/11-dockerfile%E6%9E%84%E5%BB%BA%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83Tomcat%E9%95%9C%E5%83%8F/","excerpt":"构建生产环境Tomcat镜像dockerfile1234567891011FROM centos:latestMAINTAINER dbbruceRUN rm -fr /etc/yum.repos.d/*COPY Centos-vault-8.5.2111.repo /etc/yum.repos.d/RUN yum -y install wgetADD jdk-8u92-linux-x64.rpm /usr/local/ADD apache-tomcat-8.0.26.tar.gz /usr/local/RUN cd /usr/local &amp;&amp; rpm -ivh jdk-8u92-linux-x64.rpm RUN mv /usr/local/apache-tomcat-8.0.26 /usr/local/tomcat8ENTRYPOINT /usr/local/tomcat8/bin/startup.sh &amp;&amp; tail -F /usr/local/tomcat8/logs/catalina.outEXPOSE 8080","text":"构建生产环境Tomcat镜像dockerfile1234567891011FROM centos:latestMAINTAINER dbbruceRUN rm -fr /etc/yum.repos.d/*COPY Centos-vault-8.5.2111.repo /etc/yum.repos.d/RUN yum -y install wgetADD jdk-8u92-linux-x64.rpm /usr/local/ADD apache-tomcat-8.0.26.tar.gz /usr/local/RUN cd /usr/local &amp;&amp; rpm -ivh jdk-8u92-linux-x64.rpm RUN mv /usr/local/apache-tomcat-8.0.26 /usr/local/tomcat8ENTRYPOINT /usr/local/tomcat8/bin/startup.sh &amp;&amp; tail -F /usr/local/tomcat8/logs/catalina.outEXPOSE 8080 Centos-vault-8.5.2111.repo1234[root@centos07-22 nginxdockerfile]# curl -o Centos-vault-8.5.2111.repo https://mirrors.aliyun.com/repo/Centos-vault-8.5.2111.repo % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed100 2495 100 2495 0 0 5798 0 --:--:-- --:--:-- --:--:-- 5802 其他文件1234-rw-r--r-- 1 root root 8.7M 11月 22 19:44 apache-tomcat-8.0.26.tar.gz-rw-r--r-- 1 root root 2.5K 11月 22 19:41 Centos-vault-8.5.2111.repo-rw-r--r-- 1 root root 441 11月 22 19:42 dockerfile1-rw-r--r-- 1 root root 159M 11月 22 19:44 jdk-8u92-linux-x64.rpm 构建镜像1[root@centos07-22 tomcatdockerfile]# docker build -f dockerfile1 -t tomcat:v1 . 查看镜像是否构建成功：12[root@centos07-22 tomcatdockerfile]# docker images |grep tomcattomcat v1 fa8b78d69382 5 minutes ago 818MB 启动容器1[root@centos07-22 tomcatdockerfile]# docker run -d -p 8080:8080 --name tomcat8 tomcat:v1 测试1[root@centos07-22 tomcatdockerfile]# curl 192.168.1.22:8080","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"docker","slug":"运维/docker","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/"},{"name":"基础","slug":"运维/docker/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"11-权限管理","slug":"运维/Linux云计算教程/11-权限管理","date":"2021-08-11T03:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2021/08/11/运维/Linux云计算教程/11-权限管理/","link":"","permalink":"https://dbbruce.github.io/2021/08/11/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/11-%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/","excerpt":"1. 访问方式x 执行 shell脚本r 读取 vim , &gt;, &gt;&gt;w 写入 cat , head ,less","text":"1. 访问方式x 执行 shell脚本r 读取 vim , &gt;, &gt;&gt;w 写入 cat , head ,less 2. 权限适用对象 rw- — —. 1 root root 1455 8月 14 15:10 anaconda-ks.cfg 文件 所有者， 所属组， 其他用户 u, g, o 123chmod u=rwx,g=rwx,o=rw /home/dong1chmod ugo=rwx /home/dong1chmod o-w /home/dong1 2. chown1chown work.work /etc/1.txt 1234[root@master opt]# chown dong:dong t1[root@master opt]# ll总用量 0drwxr-xr-x. 2 dong dong 6 8月 17 18:52 t1 3. 特殊权限 set GID：设置目录下，新增的文件自动设置与父目录相同的所属组 12345678[dong@master t1]$ chmod g+s 1.txt[dong@master t1]$ ll总用量 0-rw-rwsr--. 1 dong dong 0 8月 17 18:53 1.txt[dong@master t1]$ chmod g-s 1.txt[dong@master t1]$ ll总用量 0-rw-rwxr--. 1 dong dong 0 8月 17 18:53 1.txt set UID :可以让使用者具有属主的身份和部分权限 3. ACL权限个别用户，个别组设置独立的权限setfacl -m u:用户名：rx &#x2F;test1setfacl -m g:组名：rx &#x2F;test1 4.查看ACL权限1234567[dong@master t1]$ getfacl 1.txt# file: 1.txt# owner: dong# group: donguser::rw-group::rwxother::r-- 5.权限的数值表示权限的数值化基本权限：r &#x3D; 4,w &#x3D; 2,x &#x3D; 1 12chmod 777 /work","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"10-Dockerfile构建企业级nginx网站服务","slug":"运维/docker/基础/10-dockerfile构建企业级nginx网站服务","date":"2021-08-10T05:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2021/08/10/运维/docker/基础/10-dockerfile构建企业级nginx网站服务/","link":"","permalink":"https://dbbruce.github.io/2021/08/10/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/10-dockerfile%E6%9E%84%E5%BB%BA%E4%BC%81%E4%B8%9A%E7%BA%A7nginx%E7%BD%91%E7%AB%99%E6%9C%8D%E5%8A%A1/","excerpt":"构建企业级nginx网站服务dockerfile123456789FROM centos:latestMAINTAINER dbbruceRUN rm -fr /etc/yum.repos.d/*COPY Centos-vault-8.5.2111.repo /etc/yum.repos.d/RUN yum -y install wgetRUN yum -y install nginxCOPY index.html /usr/share/nginx/html/EXPOSE 80ENTRYPOINT [&quot;/usr/sbin/nginx&quot;,&quot;-g&quot;,&quot;daemon off;&quot;]","text":"构建企业级nginx网站服务dockerfile123456789FROM centos:latestMAINTAINER dbbruceRUN rm -fr /etc/yum.repos.d/*COPY Centos-vault-8.5.2111.repo /etc/yum.repos.d/RUN yum -y install wgetRUN yum -y install nginxCOPY index.html /usr/share/nginx/html/EXPOSE 80ENTRYPOINT [&quot;/usr/sbin/nginx&quot;,&quot;-g&quot;,&quot;daemon off;&quot;] Centos-vault-8.5.2111.repo1234[root@centos07-22 nginxdockerfile]# curl -o Centos-vault-8.5.2111.repo https://mirrors.aliyun.com/repo/Centos-vault-8.5.2111.repo % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed100 2495 100 2495 0 0 5798 0 --:--:-- --:--:-- --:--:-- 5802 index.html12345678&lt;html&gt; &lt;head&gt; &lt;title&gt;nginx in docker&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;h1&gt;hello,My Name is dbbruce&lt;/h1&gt; &lt;/body&gt;&lt;/html&gt; 构建镜像1[root@centos07-22 nginxdockerfile]# docker build -t nginx:v1 . 查看镜像是否构建成功：12[root@centos07-22 nginxdockerfile]# docker images | grep nginxnginx v1 4467175532d6 20 seconds ago 357MB 启动容器1[root@centos07-22 nginxdockerfile]# docker run -d -p 81:80 --name html3 nginx:v1 测试12345678910[root@centos07-22 nginxdockerfile]# curl 192.168.1.22:81&lt;html&gt; &lt;head&gt; &lt;title&gt;nginx in docker&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;h1&gt;hello,My Name is dbbruce&lt;/h1&gt; &lt;/body&gt;&lt;/html&gt;","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"docker","slug":"运维/docker","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/"},{"name":"基础","slug":"运维/docker/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"10-计划任务","slug":"运维/Linux云计算教程/10-计划任务","date":"2021-08-10T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/10/运维/Linux云计算教程/10-计划任务/","link":"","permalink":"https://dbbruce.github.io/2021/08/10/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/10-%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1/","excerpt":"1. 计划任务日志1[root@master home]# less /var/log/cron","text":"1. 计划任务日志1[root@master home]# less /var/log/cron 2. crontab-e 编辑-l 查看-r 清除 全部删除 时间格式分 时 日 月 周 30 8 * * * # 每天早上8:30执行30 8 * * 5 # 每周5早上8:30执行30 8 * * 1-5 # 每周1到周5早上8:30执行30 8 * * 1,3,5 # 每周1周3周5早上8:30执行 *&#x2F;2 * * * # 每隔2小时执行*&#x2F;3 * * * * # 每隔3分钟执行","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"09-Docker端口映射","slug":"运维/docker/基础/09-docker端口映射","date":"2021-08-09T05:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/09/运维/docker/基础/09-docker端口映射/","link":"","permalink":"https://dbbruce.github.io/2021/08/09/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/09-docker%E7%AB%AF%E5%8F%A3%E6%98%A0%E5%B0%84/","excerpt":"","text":"docker端口映射客户端访问容器内的资源 默认容器可以访问外网 但外部网络的主机不可以访问容器内的资源 容器的特征是可以把宿主机变成对应的服务 我们可以使用 -p 参数把容器端口和宿主机端口绑定 -p 宿主机端口:容器端口1docker run -itd -p 80:80 d65a9db55148","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"docker","slug":"运维/docker","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/"},{"name":"基础","slug":"运维/docker/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"09-tar备份和恢复","slug":"运维/Linux云计算教程/09-tar命令","date":"2021-08-09T03:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2021/08/09/运维/Linux云计算教程/09-tar命令/","link":"","permalink":"https://dbbruce.github.io/2021/08/09/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/09-tar%E5%91%BD%E4%BB%A4/","excerpt":"1. tar命令合集打包tar 选项 压缩名 原始目录解包tar 选项 压缩包 释放的目录 c 创建归档 x 释放归档 f 指定归档文件名 z -j -J 调用 .gz .bz2 .xz 格式的工具进行处理 t 显示归档中的文件清单 C 指定释放目录","text":"1. tar命令合集打包tar 选项 压缩名 原始目录解包tar 选项 压缩包 释放的目录 c 创建归档 x 释放归档 f 指定归档文件名 z -j -J 调用 .gz .bz2 .xz 格式的工具进行处理 t 显示归档中的文件清单 C 指定释放目录 2. 设置时间data -s ‘年-月-日 时：分：秒：’","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"08-Docker网桥","slug":"运维/docker/基础/08-docker网桥","date":"2021-08-08T05:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/08/运维/docker/基础/08-docker网桥/","link":"","permalink":"https://dbbruce.github.io/2021/08/08/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/08-docker%E7%BD%91%E6%A1%A5/","excerpt":"docker网桥docker支持网络的3中模式bridge 桥接host 仅主机none 无网络 123456[root@centos07-22 busybox]# docker network lsNETWORK ID NAME DRIVER SCOPE89bf40092a24 bridge bridge local989ab8118c88 host host localb90220e38931 none null local","text":"docker网桥docker支持网络的3中模式bridge 桥接host 仅主机none 无网络 123456[root@centos07-22 busybox]# docker network lsNETWORK ID NAME DRIVER SCOPE89bf40092a24 bridge bridge local989ab8118c88 host host localb90220e38931 none null local 默认使用docker0，所有的容器连接docker012345678910[root@centos07-22 busybox]# ifconfigdocker0: flags=4099&lt;UP,BROADCAST,MULTICAST&gt; mtu 1500 inet 172.17.0.1 netmask 255.255.0.0 broadcast 172.17.255.255 inet6 fe80::42:42ff:fed0:dba0 prefixlen 64 scopeid 0x20&lt;link&gt; ether 02:42:42:d0:db:a0 txqueuelen 0 (Ethernet) RX packets 34 bytes 1924 (1.8 KiB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 39 bytes 3630 (3.5 KiB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 新建docker网络模型 创建一个新docker网络： docker network create –subnet&#x3D;10.10.10.0&#x2F;24 docker1 12[root@centos07-22 busybox]# docker network create --subnet=10.10.10.0/24 docker158644461ac6e7724791583bb8abe025cf370e310d7e2cc83d3ccabbc2a5d3244 123456789# 下面的br-58...，就是新创建成功的docker网络，ifconfig名字不显示docker1[root@centos07-22 busybox]# ifconfigbr-58644461ac6e: flags=4099&lt;UP,BROADCAST,MULTICAST&gt; mtu 1500 inet 10.10.10.1 netmask 255.255.255.0 broadcast 10.10.10.255 ether 02:42:a1:f0:fd:bb txqueuelen 0 (Ethernet) RX packets 105588 bytes 10561939 (10.0 MiB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 6074 bytes 1017895 (994.0 KiB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 1234567# 使用docker 命令，可以查看docker1[root@centos07-22 busybox]# docker network lsNETWORK ID NAME DRIVER SCOPE89bf40092a24 bridge bridge local58644461ac6e docker1 bridge local989ab8118c88 host host localb90220e38931 none null local 1234567891011121314151617181920212223242526# 使用：ip a s查看[root@centos07-22 busybox]# ip a s1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever inet6 ::1/128 scope host valid_lft forever preferred_lft forever2: enp0s3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 08:00:27:ab:32:79 brd ff:ff:ff:ff:ff:ff inet 192.168.1.22/24 brd 192.168.1.255 scope global noprefixroute enp0s3 valid_lft forever preferred_lft forever inet6 2409:8a00:6035:e890:1bf:c9d7:671d:fdd8/64 scope global noprefixroute dynamic valid_lft 258815sec preferred_lft 172415sec inet6 fe80::885:90eb:3a46:25fa/64 scope link noprefixroute valid_lft forever preferred_lft forever3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default link/ether 02:42:42:d0:db:a0 brd ff:ff:ff:ff:ff:ff inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0 valid_lft forever preferred_lft forever inet6 fe80::42:42ff:fed0:dba0/64 scope link valid_lft forever preferred_lft forever8: br-58644461ac6e: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default link/ether 02:42:a1:f0:fd:bb brd ff:ff:ff:ff:ff:ff inet 10.10.10.1/24 brd 10.10.10.255 scope global br-58644461ac6e valid_lft forever preferred_lft forever 123456789101112131415161718192021222324252627282930[root@centos07-22 busybox]# docker network inspect docker1[ &#123; &quot;Name&quot;: &quot;docker1&quot;, &quot;Id&quot;: &quot;58644461ac6e7724791583bb8abe025cf370e310d7e2cc83d3ccabbc2a5d3244&quot;, &quot;Created&quot;: &quot;2023-11-15T17:21:18.627128402+08:00&quot;, &quot;Scope&quot;: &quot;local&quot;, &quot;Driver&quot;: &quot;bridge&quot;, &quot;EnableIPv6&quot;: false, &quot;IPAM&quot;: &#123; &quot;Driver&quot;: &quot;default&quot;, &quot;Options&quot;: &#123;&#125;, &quot;Config&quot;: [ &#123; &quot;Subnet&quot;: &quot;10.10.10.0/24&quot; &#125; ] &#125;, &quot;Internal&quot;: false, &quot;Attachable&quot;: false, &quot;Ingress&quot;: false, &quot;ConfigFrom&quot;: &#123; &quot;Network&quot;: &quot;&quot; &#125;, &quot;ConfigOnly&quot;: false, &quot;Containers&quot;: &#123;&#125;, &quot;Options&quot;: &#123;&#125;, &quot;Labels&quot;: &#123;&#125; &#125;] 使用docker1启动容器–network 指定交换机 1[root@centos07-22 busybox]# docker run -it --network=docker1 centos:latest","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"docker","slug":"运维/docker","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/"},{"name":"基础","slug":"运维/docker/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"08-用户管理","slug":"运维/Linux云计算教程/08-用户管理","date":"2021-08-08T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/08/运维/Linux云计算教程/08-用户管理/","link":"","permalink":"https://dbbruce.github.io/2021/08/08/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/08-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/","excerpt":"1. 唯一标识UID 用户IDGID 组ID","text":"1. 唯一标识UID 用户IDGID 组ID 2. 组账号基本组 （私有组）：系统创建，系统添加的，基本与用户同名的组附件组 （从属族）：用户自己创建的组 3.一个用户至少属于一个组默认，创建一个用户就会创建一个组例如：useradd user1 ，默认创建一个user1组 4.useradd-u 用户id-d 家目录-s 登录解释器-G 附件组 5.查看用户信息id + 用户名 12[dong@master ~]$ id donguid=1000(dong) gid=1000(dong) 组=1000(dong) 6.用户文件123[dong@master ~]$ cat /etc/passwdroot:x:0:0:root:/root:/bin/bash用户名：密码占位符：UID：基本组GID：用户描述信息：家目录：解释器 7.创建组groupadd group1 8.解释器1234567[dong@master ~]$ cat /etc/shells/bin/sh/bin/bash/usr/bin/sh/usr/bin/bash/bin/tcsh/bin/csh 禁止用户登录系统，即使密码正确也不能登录&#x2F;sbin&#x2F;nologin 创建一个不能登录的用户 1useradd -s /sbin/nologin user2 9.passwd 用户123[root@master dong]# passwd dong更改用户 dong 的密码 。新的 密码： echo “密码” | passwd – stdin 用户 10.密码文件格式：用户名：加密密码字符串：上次修改密码时间：密码最短使用时间：密码使用时间：提前几天通知：后面2个字段为空代表永远有效 1234567[root@master ~]# ll /etc/shadow----------. 1 root root 848 8月 17 10:25 /etc/shadow[root@master ~]# cat /etc/shadowroot:$61231231231adafdsaf12321dafsfasdf.adsfasdfasdfasdfasdfasdf/::0:99999:7:::bin:*:18353:0:99999:7:::dong:$12123123123123.:19586:0:99999:7:::dbus:!!:19583:::::: # 这种是禁用的，不能登录 11.修改用户属性usermod-u 用户id-d 家目录-s 登录解释器-G 附件组 12.删除用户userdel-r 删除家目录，建议不要带-r 建议一般保留3天家目录，删除用户后的可以恢复，操作如下 123456789101112[root@master home]# userdel dong2[root@master home]# id dong2id: dong2: no such user[root@master home]# ls -ld /home/dong2drwx------. 2 1001 1001 62 8月 17 15:41 /home/dong2[root@master home]# useradd -u 1001 dong2useradd：警告：此主目录已经存在。不从 skel 目录里向其中复制任何文件。正在创建信箱文件: 文件已存在[root@master home]# id dong2uid=1001(dong2) gid=1001(dong2) 组=1001(dong2)[root@master home]# 13.创建组groupadd-g 指定组 14.查看组文件组名：密码占位符：组id：组成员列表 123456[root@master home]# head -5 /etc/grouproot:x:0:bin:x:1:daemon:x:2:sys:x:3:adm:x:4: 15.用户加组和用户删除组gpasswd用户加组：-a 用户名 组名用户减组：-d 用户名 组名 16.删除组groupdel 组名","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"07-Docker持久化存储","slug":"运维/docker/基础/07-docker持久化存储","date":"2021-08-07T05:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/07/运维/docker/基础/07-docker持久化存储/","link":"","permalink":"https://dbbruce.github.io/2021/08/07/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/07-docker%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8/","excerpt":"docker持久化存储卷的概念 docker容器不保持任何数据 重要数据请使用外部卷存储( 数据持久化 容器可以挂载真实机目录或共享存储为卷","text":"docker持久化存储卷的概念 docker容器不保持任何数据 重要数据请使用外部卷存储( 数据持久化 容器可以挂载真实机目录或共享存储为卷 主机卷的映射 将真实机目录挂载到容器中提供持久化存储目录不存在就自动创建目录存在就直接覆盖掉docker run -itd -v 真机路径:容器内路径 centos &#x2F;bin&#x2F;bash 123docker run -itd -v /Users/dbbruce/workspace/dockertest/test1:/data centos:latest /bin/bash5902e98ceee8334c7b93654bc88694de8bda4f64022d2cd19d274b8ec8565813","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"docker","slug":"运维/docker","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/"},{"name":"基础","slug":"运维/docker/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"07-管道","slug":"运维/Linux云计算教程/07-管道","date":"2021-08-07T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/07/运维/Linux云计算教程/07-管道/","link":"","permalink":"https://dbbruce.github.io/2021/08/07/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/07-%E7%AE%A1%E9%81%93/","excerpt":"","text":"1.管道 |将前面命令的输出，交由后面命令处理，作为后面命令的参数取passwd的8到12行 123456[dong@master ~]$ head -12 /etc/passwd | tail -5halt:x:7:0:halt:/sbin:/sbin/haltmail:x:8:12:mail:/var/spool/mail:/sbin/nologinoperator:x:11:0:operator:/root:/sbin/nologingames:x:12:100:games:/usr/games:/sbin/nologinftp:x:14:50:FTP User:/var/ftp:/sbin/nologin","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"06-docker自定义镜像仓库-简单实例","slug":"运维/docker/基础/06-docker自定义镜像仓库-简单实例","date":"2021-08-06T05:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/06/运维/docker/基础/06-docker自定义镜像仓库-简单实例/","link":"","permalink":"https://dbbruce.github.io/2021/08/06/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/06-docker%E8%87%AA%E5%AE%9A%E4%B9%89%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93-%E7%AE%80%E5%8D%95%E5%AE%9E%E4%BE%8B/","excerpt":"Docker自定义镜像仓库-简单实例安装私有仓库(服务端)1yum -y install docker-distribution 启动私有仓库，并设置开机自启动1systemctl start docker-distribution 1systemctl enable docker-distribution","text":"Docker自定义镜像仓库-简单实例安装私有仓库(服务端)1yum -y install docker-distribution 启动私有仓库，并设置开机自启动1systemctl start docker-distribution 1systemctl enable docker-distribution 仓库配置文件数据存储路径12345678910111213/etc/docker-distribution/registry/config.ymlversion: 0.1log: fields: service: registrystorage: cache: layerinfo: inmemory filesystem: rootdirectory: /var/lib/registry # 数据存储路径 http: addr: :5000 # 端口 数据存储路径1/var/lib/registry 浏览器访问：http://192.168.1.22:5000/v2/_catalog 客户端配置 修改配置文件, 允许非加密方式访问仓库 123456vim /etc/docker/daemon.json&#123; &quot;registry-mirrors&quot;: [&quot;http://192.168.1.22:5000&quot;], # 注意这里有个逗号 &quot;insecure-registries&quot;: [&quot;192.168.1.22:5000&quot;]&#125; 重启docker，先停止运行的docker 12345docker stop $(docker ps -q)systemctl daemon-reloadsystemctl restart docker 上传镜像docker push 不支持指定仓库地址的功能，通过修改镜像名称，添加地址，达到指定仓库地址的功能 12345678910[root@centos07-22 ~]# docker imagesREPOSITORY TAG IMAGE ID CREATED SIZEbusybox latest a416a98b71e2 3 months ago 4.26MB[root@centos07-22 ~]# docker tag busybox:latest 192.168.1.22:5000/busybox:latest[root@centos07-22 ~]# docker imagesREPOSITORY TAG IMAGE ID CREATED SIZE192.168.1.22:5000/busybox latest a416a98b71e2 3 months ago 4.26MBbusybox latest a416a98b71e2 3 months ago 4.26MB 上传 12345[root@centos07-22 ~]# docker push 192.168.1.22:5000/busybox:latestThe push refers to repository [192.168.1.22:5000/busybox]3d24ee258efc: Pushedlatest: digest: sha256:023917ec6a886d0e8e15f28fb543515a5fcd8d938edb091e8147db4efed388ee size: 528 查看私有镜像仓库中的镜像名称http://192.168.1.22:5000/v2/_catalog 查看某一仓库的标签curl http://docker1:5000/v2/&#x2F;tags&#x2F;listcurl http://192.168.1.22:5000/v2/busybox/tags/list","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"docker","slug":"运维/docker","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/"},{"name":"基础","slug":"运维/docker/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"06-重定向","slug":"运维/Linux云计算教程/06-重定向","date":"2021-08-06T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/06/运维/Linux云计算教程/06-重定向/","link":"","permalink":"https://dbbruce.github.io/2021/08/06/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/06-%E9%87%8D%E5%AE%9A%E5%90%91/","excerpt":"1.重定向输出覆盖重定向 &gt;追加重定向 &gt;&gt; 12ls --help &gt; 1.txtls --help &gt;&gt; 1.txt","text":"1.重定向输出覆盖重定向 &gt;追加重定向 &gt;&gt; 12ls --help &gt; 1.txtls --help &gt;&gt; 1.txt 2.区别&gt;: 只收集前面命令的正确输出 2&gt;: 只收集前面命令的错误输出 &amp;&gt;: 收集前面命令的正确与错误输出 只收集正确信息 1234567891011[dong@master ~]$ ls1.sh[dong@master ~]$ cat 1.sh 100.sh^C&gt; 4.txt[dong@master ~]$ ls1.sh[dong@master ~]$ cat 1.sh 2.txt &gt; 1.txtcat: 2.txt: 没有那个文件或目录[dong@master ~]$ cat 1.txt#! /bin/bashifconfig | head -2 只收集错误信息 123456[dong@master ~]$ cat 1.sh 2.txt 2&gt; 1.txt#! /bin/bashifconfig | head -2[dong@master ~]$ cat 1.txtcat: 2.txt: 没有那个文件或目录 只收集正确，错误信息全收集 1234567[dong@master ~]$ cat 1.sh 2.txt &amp;&gt; 1.txt[dong@master ~]$ cat 1.txt#! /bin/bashifconfig | head -2cat: 2.txt: 没有那个文件或目录[dong@master ~]$","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"05-Dockerfile","slug":"运维/docker/基础/05-dockerfile","date":"2021-08-05T05:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2021/08/05/运维/docker/基础/05-dockerfile/","link":"","permalink":"https://dbbruce.github.io/2021/08/05/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/05-dockerfile/","excerpt":"DockerfileDockerfile 是一个用于定义 Docker 镜像的文本文件。它包含了一系列的指令和参数，用于指示 Docker 在构建镜像时应该执行哪些操作，例如基于哪个基础镜像、复制哪些文件到镜像中、运行哪些命令等等。通过 Dockerfile，开发人员可以将应用程序和其所有依赖项打包在一起，创建出一个可移植的 Docker 镜像，使得这个应用程序可以在任何 Docker环境中都能够快速部署和运行。 Dockerfile语法格式 FROM:基础镜像 MAINTAINER:镜像创建者信息 EXPOSE:开放的端口,一个或多个 ENV:设置变量 ENV key value;ENV key&#x3D;value ONBUILD:用于延迟命令的执行。简单的说，就是 Dockerfile 里用 ONBUILD 指定的命令，在本次构建镜像的过程中不会执行（假设镜像为 test-build）。当有新的 Dockerfile 使用了之前构建的镜像 FROM test-build ，这时执行新镜像的 Dockerfile 构建时候，会执行 test-build 的 Dockerfile 里的 ONBUILD 指定的命令。:ONBUILD &lt;其它指令&gt;， onbuild copy USER:用于指定执行后续命令的用户和用户组，这边只是切换后续命令执行的用户（用户和用户组必须提前已经存在）:USER &lt;用户名&gt;[:&lt;用户组&gt;] VOLUME:定义匿名数据卷，存数据。容器里的一个目录会和物理机的一个目录映射，在这个目录添加文件，物理机目录也会有文件； 在启动容器时忘记挂载数据卷，会自动挂载到匿名卷：VOLUME [“&lt;路径1&gt;”, “&lt;路径2&gt;”…]，VOLUME &lt;路径&gt;：VOLUME [“&#x2F;data”] 作用： 1、避免重要的数据，因容器重启而丢失，这是非常致命的。 2、避免容器不断变大。 在启动容器 docker run 的时候，我们可以通过 -v 参数修改挂载点。 ADD:复制文件到镜像；本地文件拷贝到容器里；ADD的优点是拷贝文件为压缩文件：tar,gzip,bzip2等，会自动复制并解压文件； COPY:复制文件到镜像；本地文件拷贝到容器里；COPY不论文件格式，原样拷贝； RUN:制作镜像时执行的命令，可以有多个；在容器里执行的命令； 包含两种模式： 1、shell模式，最常用的模式： run yum install -y wget 2、exec模式，先指定shell再执行命令；run [“&#x2F;bin&#x2F;bash”, “-c”, “yum install -y wget”] WORKDIR:定义容器默认工作目录，定义当前家目录；登录容器后默认的目录； CMD:容器启动时执行的命令，仅可以有一条CMD ；必须是中括号+双引号，命令用逗号分隔：[“命令”,”参数1”,”参数2”]；cmd提供的命令，都是进程id：1，所有的父进程；多条cmd时，最后一条生效； 包含两种模式： 1、shell模式：cmd command 2、exec模式：cmd [“param1”, “param2”] ENTERYPOINT:启动服务的命令，镜像创建好后执行的命令;多条entrypoint时，最后一条生效； 1、ENTRYPOINT 的目的和 CMD 一样，都是在指定容器启动程序及参数。ENTRYPOINT 在运行时也可以替代，不过比 CMD 要略显繁琐，需要通过 docker run 的参数 –entrypoint 来指定。 2、当指定了 ENTRYPOINT 后，CMD 的含义就发生了改变，不再是直接的运行其命令，而是将 CMD 的内容作为参数传给 ENTRYPOINT 指令，换句话说实际执行时，将变为： ““","text":"DockerfileDockerfile 是一个用于定义 Docker 镜像的文本文件。它包含了一系列的指令和参数，用于指示 Docker 在构建镜像时应该执行哪些操作，例如基于哪个基础镜像、复制哪些文件到镜像中、运行哪些命令等等。通过 Dockerfile，开发人员可以将应用程序和其所有依赖项打包在一起，创建出一个可移植的 Docker 镜像，使得这个应用程序可以在任何 Docker环境中都能够快速部署和运行。 Dockerfile语法格式 FROM:基础镜像 MAINTAINER:镜像创建者信息 EXPOSE:开放的端口,一个或多个 ENV:设置变量 ENV key value;ENV key&#x3D;value ONBUILD:用于延迟命令的执行。简单的说，就是 Dockerfile 里用 ONBUILD 指定的命令，在本次构建镜像的过程中不会执行（假设镜像为 test-build）。当有新的 Dockerfile 使用了之前构建的镜像 FROM test-build ，这时执行新镜像的 Dockerfile 构建时候，会执行 test-build 的 Dockerfile 里的 ONBUILD 指定的命令。:ONBUILD &lt;其它指令&gt;， onbuild copy USER:用于指定执行后续命令的用户和用户组，这边只是切换后续命令执行的用户（用户和用户组必须提前已经存在）:USER &lt;用户名&gt;[:&lt;用户组&gt;] VOLUME:定义匿名数据卷，存数据。容器里的一个目录会和物理机的一个目录映射，在这个目录添加文件，物理机目录也会有文件； 在启动容器时忘记挂载数据卷，会自动挂载到匿名卷：VOLUME [“&lt;路径1&gt;”, “&lt;路径2&gt;”…]，VOLUME &lt;路径&gt;：VOLUME [“&#x2F;data”] 作用： 1、避免重要的数据，因容器重启而丢失，这是非常致命的。 2、避免容器不断变大。 在启动容器 docker run 的时候，我们可以通过 -v 参数修改挂载点。 ADD:复制文件到镜像；本地文件拷贝到容器里；ADD的优点是拷贝文件为压缩文件：tar,gzip,bzip2等，会自动复制并解压文件； COPY:复制文件到镜像；本地文件拷贝到容器里；COPY不论文件格式，原样拷贝； RUN:制作镜像时执行的命令，可以有多个；在容器里执行的命令； 包含两种模式： 1、shell模式，最常用的模式： run yum install -y wget 2、exec模式，先指定shell再执行命令；run [“&#x2F;bin&#x2F;bash”, “-c”, “yum install -y wget”] WORKDIR:定义容器默认工作目录，定义当前家目录；登录容器后默认的目录； CMD:容器启动时执行的命令，仅可以有一条CMD ；必须是中括号+双引号，命令用逗号分隔：[“命令”,”参数1”,”参数2”]；cmd提供的命令，都是进程id：1，所有的父进程；多条cmd时，最后一条生效； 包含两种模式： 1、shell模式：cmd command 2、exec模式：cmd [“param1”, “param2”] ENTERYPOINT:启动服务的命令，镜像创建好后执行的命令;多条entrypoint时，最后一条生效； 1、ENTRYPOINT 的目的和 CMD 一样，都是在指定容器启动程序及参数。ENTRYPOINT 在运行时也可以替代，不过比 CMD 要略显繁琐，需要通过 docker run 的参数 –entrypoint 来指定。 2、当指定了 ENTRYPOINT 后，CMD 的含义就发生了改变，不再是直接的运行其命令，而是将 CMD 的内容作为参数传给 ENTRYPOINT 指令，换句话说实际执行时，将变为： ““ 使用dockerfile创建一个容器 文件名比较为：Dockerfile；vim Dockerfile 123456FROM centos:latestRUN cd /etc/yum.repos.d/RUN sed -i &#x27;s/mirrorlist/#mirrorlist/g&#x27; /etc/yum.repos.d/CentOS-*RUN sed -i &#x27;s|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g&#x27; /etc/yum.repos.d/CentOS-*RUN yum update -yRUN yum -y install vim net-tools psmisc iproute 生成新镜像-t指定名称-注意后面有个点，必须加，指定dockerfile的位置1docker build -t mycentos2:latest . 查看123dbbruce@dbburce test1 % docker imagesREPOSITORY TAG IMAGE ID CREATED SIZEmycentos2 latest 1fa309554f03 About a minute ago 602MB Dockerfile默认启动命令docker run -itd centos:latest &#x2F;bin&#x2F;bash,容器启动时的默认命令就是:&#x2F;bin&#x2F;bashDockerfile通过CMD可以指定，容器的启动命令 Dockerfile123456789101112FROM centos:latestRUN cd /etc/yum.repos.d/RUN sed -i &#x27;s/mirrorlist/#mirrorlist/g&#x27; /etc/yum.repos.d/CentOS-*RUN sed -i &#x27;s|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g&#x27; /etc/yum.repos.d/CentOS-*RUN yum update -yRUN yum -y install vim net-tools psmisc iproute openssh-server passwd initscriptsRUN ssh-keygen -A -t rsa -N &#x27;&#x27; -f /root/.ssh/id_rsa -qRUN echo &quot;a&quot; |passwd --stdin rootENV EnvironmentFile=/etc/crypto-policies/back-ends/opensshserver.configENV EnvironmentFile=/etc/sysconfig/sshdEXPOSE 22CMD [&quot;/usr/sbin/sshd&quot;, &quot;-D&quot;, &quot;$OPTIONS&quot;, &quot;$CRYPTO_POLICY&quot;] 生成镜像12345678910111213141516171819202122232425262728293031323334dbbruce@dbburce test1 % docker build -t myssh:ssh .[+] Building 26.6s (12/12) FINISHED docker:desktop-linux =&gt; [internal] load build definition from Dockerfile 0.0s =&gt; =&gt; transferring dockerfile: 625B 0.0s =&gt; [internal] load .dockerignore 0.0s =&gt; =&gt; transferring context: 2B 0.0s =&gt; [internal] load metadata for docker.io/library/centos:latest 0.0s =&gt; [1/8] FROM docker.io/library/centos:latest 0.0s =&gt; CACHED [2/8] RUN cd /etc/yum.repos.d/ 0.0s =&gt; CACHED [3/8] RUN sed -i &#x27;s/mirrorlist/#mirrorlist/g&#x27; /etc/yum.repos.d/CentOS-* 0.0s =&gt; CACHED [4/8] RUN sed -i &#x27;s|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g&#x27; /etc/yum.repos.d/CentOS-* 0.0s =&gt; CACHED [5/8] RUN yum update -y 0.0s =&gt; [6/8] RUN yum -y install vim net-tools psmisc iproute openssh-server passwd initscripts 24.5s =&gt; [7/8] RUN ssh-keygen -t rsa -N &#x27;&#x27; -f /root/.ssh/id_rsa -q 0.9s =&gt; [8/8] RUN echo &quot;a&quot; |passwd --stdin root 0.3s =&gt; exporting to image 0.8s =&gt; =&gt; exporting layers 0.8s =&gt; =&gt; writing image sha256:df1c4fc673919f9efc4290bcde40715e34fa16f6c2806b39eb9bb4ff134bc529 0.0s =&gt; =&gt; naming to docker.io/library/myssh:ssh 0.0sWhat&#x27;s Next? View a summary of image vulnerabilities and recommendations → docker scout quickview dbbruce@dbburce test1 % docker imagesREPOSITORY TAG IMAGE ID CREATED SIZEmyssh ssh df1c4fc67391 21 seconds ago 606MBmycentos7 latest 26934b5d7364 26 hours ago 533MBredis latest 7f27d60cb8e0 12 days ago 138MBnginx latest c20060033e06 13 days ago 187MBubuntu latest e4c58958181a 5 weeks ago 77.8MBbusybox latest a416a98b71e2 3 months ago 4.26MBcentos latest 5d0da3dc9764 2 years ago 231MB 运行镜像，生成容器123456dbbruce@dbburce test1 % docker run -itd myssh:sshce913c77a30314b6709f9e58512f59b82854a1039fd2e9eebd729322265e22e4dbbruce@dbburce test1 % docker psCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES9efb52df130f mycentos7 &quot;/bin/bash&quot; 16 minutes ago Up 16 minutes wonderful_pasteur 查看容器信息，ssh服务，看下容器ip123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201dbbruce@dbburce test1 % docker inspect 9efb52df130f[ &#123; &quot;Id&quot;: &quot;9efb52df130fb5077cc8acdfc55e99efb0327bf2db08a3a3860c70a6f38637d4&quot;, &quot;Created&quot;: &quot;2023-11-14T10:34:12.867433191Z&quot;, &quot;Path&quot;: &quot;/bin/bash&quot;, &quot;Args&quot;: [], &quot;State&quot;: &#123; &quot;Status&quot;: &quot;running&quot;, &quot;Running&quot;: true, &quot;Paused&quot;: false, &quot;Restarting&quot;: false, &quot;OOMKilled&quot;: false, &quot;Dead&quot;: false, &quot;Pid&quot;: 3765, &quot;ExitCode&quot;: 0, &quot;Error&quot;: &quot;&quot;, &quot;StartedAt&quot;: &quot;2023-11-14T10:34:13.076332207Z&quot;, &quot;FinishedAt&quot;: &quot;0001-01-01T00:00:00Z&quot; &#125;, &quot;Image&quot;: &quot;sha256:26934b5d7364ae8915e6d32c55a375f588b474b1ae852f92b88fa531349d102f&quot;, &quot;ResolvConfPath&quot;: &quot;/var/lib/docker/containers/9efb52df130fb5077cc8acdfc55e99efb0327bf2db08a3a3860c70a6f38637d4/resolv.conf&quot;, &quot;HostnamePath&quot;: &quot;/var/lib/docker/containers/9efb52df130fb5077cc8acdfc55e99efb0327bf2db08a3a3860c70a6f38637d4/hostname&quot;, &quot;HostsPath&quot;: &quot;/var/lib/docker/containers/9efb52df130fb5077cc8acdfc55e99efb0327bf2db08a3a3860c70a6f38637d4/hosts&quot;, &quot;LogPath&quot;: &quot;/var/lib/docker/containers/9efb52df130fb5077cc8acdfc55e99efb0327bf2db08a3a3860c70a6f38637d4/9efb52df130fb5077cc8acdfc55e99efb0327bf2db08a3a3860c70a6f38637d4-json.log&quot;, &quot;Name&quot;: &quot;/wonderful_pasteur&quot;, &quot;RestartCount&quot;: 0, &quot;Driver&quot;: &quot;overlay2&quot;, &quot;Platform&quot;: &quot;linux&quot;, &quot;MountLabel&quot;: &quot;&quot;, &quot;ProcessLabel&quot;: &quot;&quot;, &quot;AppArmorProfile&quot;: &quot;&quot;, &quot;ExecIDs&quot;: null, &quot;HostConfig&quot;: &#123; &quot;Binds&quot;: null, &quot;ContainerIDFile&quot;: &quot;&quot;, &quot;LogConfig&quot;: &#123; &quot;Type&quot;: &quot;json-file&quot;, &quot;Config&quot;: &#123;&#125; &#125;, &quot;NetworkMode&quot;: &quot;default&quot;, &quot;PortBindings&quot;: &#123;&#125;, &quot;RestartPolicy&quot;: &#123; &quot;Name&quot;: &quot;no&quot;, &quot;MaximumRetryCount&quot;: 0 &#125;, &quot;AutoRemove&quot;: false, &quot;VolumeDriver&quot;: &quot;&quot;, &quot;VolumesFrom&quot;: null, &quot;ConsoleSize&quot;: [ 45, 191 ], &quot;CapAdd&quot;: null, &quot;CapDrop&quot;: null, &quot;CgroupnsMode&quot;: &quot;private&quot;, &quot;Dns&quot;: [], &quot;DnsOptions&quot;: [], &quot;DnsSearch&quot;: [], &quot;ExtraHosts&quot;: null, &quot;GroupAdd&quot;: null, &quot;IpcMode&quot;: &quot;private&quot;, &quot;Cgroup&quot;: &quot;&quot;, &quot;Links&quot;: null, &quot;OomScoreAdj&quot;: 0, &quot;PidMode&quot;: &quot;&quot;, &quot;Privileged&quot;: false, &quot;PublishAllPorts&quot;: false, &quot;ReadonlyRootfs&quot;: false, &quot;SecurityOpt&quot;: null, &quot;UTSMode&quot;: &quot;&quot;, &quot;UsernsMode&quot;: &quot;&quot;, &quot;ShmSize&quot;: 67108864, &quot;Runtime&quot;: &quot;runc&quot;, &quot;Isolation&quot;: &quot;&quot;, &quot;CpuShares&quot;: 0, &quot;Memory&quot;: 0, &quot;NanoCpus&quot;: 0, &quot;CgroupParent&quot;: &quot;&quot;, &quot;BlkioWeight&quot;: 0, &quot;BlkioWeightDevice&quot;: [], &quot;BlkioDeviceReadBps&quot;: [], &quot;BlkioDeviceWriteBps&quot;: [], &quot;BlkioDeviceReadIOps&quot;: [], &quot;BlkioDeviceWriteIOps&quot;: [], &quot;CpuPeriod&quot;: 0, &quot;CpuQuota&quot;: 0, &quot;CpuRealtimePeriod&quot;: 0, &quot;CpuRealtimeRuntime&quot;: 0, &quot;CpusetCpus&quot;: &quot;&quot;, &quot;CpusetMems&quot;: &quot;&quot;, &quot;Devices&quot;: [], &quot;DeviceCgroupRules&quot;: null, &quot;DeviceRequests&quot;: null, &quot;MemoryReservation&quot;: 0, &quot;MemorySwap&quot;: 0, &quot;MemorySwappiness&quot;: null, &quot;OomKillDisable&quot;: null, &quot;PidsLimit&quot;: null, &quot;Ulimits&quot;: null, &quot;CpuCount&quot;: 0, &quot;CpuPercent&quot;: 0, &quot;IOMaximumIOps&quot;: 0, &quot;IOMaximumBandwidth&quot;: 0, &quot;MaskedPaths&quot;: [ &quot;/proc/asound&quot;, &quot;/proc/acpi&quot;, &quot;/proc/kcore&quot;, &quot;/proc/keys&quot;, &quot;/proc/latency_stats&quot;, &quot;/proc/timer_list&quot;, &quot;/proc/timer_stats&quot;, &quot;/proc/sched_debug&quot;, &quot;/proc/scsi&quot;, &quot;/sys/firmware&quot; ], &quot;ReadonlyPaths&quot;: [ &quot;/proc/bus&quot;, &quot;/proc/fs&quot;, &quot;/proc/irq&quot;, &quot;/proc/sys&quot;, &quot;/proc/sysrq-trigger&quot; ] &#125;, &quot;GraphDriver&quot;: &#123; &quot;Data&quot;: &#123; &quot;LowerDir&quot;: &quot;/var/lib/docker/overlay2/afcd21081c009bedf7d11a338e6af8792d4ad4dd847b815c9596c0387b690dba-init/diff:/var/lib/docker/overlay2/e6c84d6f7a45a1d33590f25cfb29bb900a61686c26269a09a592b19d12a1867b/diff:/var/lib/docker/overlay2/6b9b31271a46d6db4762be4f0168a13ae450c9cac17d0bd3ea1de96783e8a7de/diff&quot;, &quot;MergedDir&quot;: &quot;/var/lib/docker/overlay2/afcd21081c009bedf7d11a338e6af8792d4ad4dd847b815c9596c0387b690dba/merged&quot;, &quot;UpperDir&quot;: &quot;/var/lib/docker/overlay2/afcd21081c009bedf7d11a338e6af8792d4ad4dd847b815c9596c0387b690dba/diff&quot;, &quot;WorkDir&quot;: &quot;/var/lib/docker/overlay2/afcd21081c009bedf7d11a338e6af8792d4ad4dd847b815c9596c0387b690dba/work&quot; &#125;, &quot;Name&quot;: &quot;overlay2&quot; &#125;, &quot;Mounts&quot;: [], &quot;Config&quot;: &#123; &quot;Hostname&quot;: &quot;9efb52df130f&quot;, &quot;Domainname&quot;: &quot;&quot;, &quot;User&quot;: &quot;&quot;, &quot;AttachStdin&quot;: true, &quot;AttachStdout&quot;: true, &quot;AttachStderr&quot;: true, &quot;Tty&quot;: true, &quot;OpenStdin&quot;: true, &quot;StdinOnce&quot;: true, &quot;Env&quot;: [ &quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot; ], &quot;Cmd&quot;: [ &quot;/bin/bash&quot; ], &quot;Image&quot;: &quot;mycentos7&quot;, &quot;Volumes&quot;: null, &quot;WorkingDir&quot;: &quot;&quot;, &quot;Entrypoint&quot;: null, &quot;OnBuild&quot;: null, &quot;Labels&quot;: &#123; &quot;org.label-schema.build-date&quot;: &quot;20210915&quot;, &quot;org.label-schema.license&quot;: &quot;GPLv2&quot;, &quot;org.label-schema.name&quot;: &quot;CentOS Base Image&quot;, &quot;org.label-schema.schema-version&quot;: &quot;1.0&quot;, &quot;org.label-schema.vendor&quot;: &quot;CentOS&quot; &#125; &#125;, &quot;NetworkSettings&quot;: &#123; &quot;Bridge&quot;: &quot;&quot;, &quot;SandboxID&quot;: &quot;a33388bd347efefb732e61806734d59ad71f2a10397f63718b99c1b5b1731835&quot;, &quot;HairpinMode&quot;: false, &quot;LinkLocalIPv6Address&quot;: &quot;&quot;, &quot;LinkLocalIPv6PrefixLen&quot;: 0, &quot;Ports&quot;: &#123;&#125;, &quot;SandboxKey&quot;: &quot;/var/run/docker/netns/a33388bd347e&quot;, &quot;SecondaryIPAddresses&quot;: null, &quot;SecondaryIPv6Addresses&quot;: null, &quot;EndpointID&quot;: &quot;ffe9142d9430ea741c13211eacb9f38c48edab057a3431b3aba999e7abd25ee2&quot;, &quot;Gateway&quot;: &quot;172.17.0.1&quot;, &quot;GlobalIPv6Address&quot;: &quot;&quot;, &quot;GlobalIPv6PrefixLen&quot;: 0, &quot;IPAddress&quot;: &quot;172.17.0.2&quot;, &quot;IPPrefixLen&quot;: 16, &quot;IPv6Gateway&quot;: &quot;&quot;, &quot;MacAddress&quot;: &quot;02:42:ac:11:00:02&quot;, &quot;Networks&quot;: &#123; &quot;bridge&quot;: &#123; &quot;IPAMConfig&quot;: null, &quot;Links&quot;: null, &quot;Aliases&quot;: null, &quot;NetworkID&quot;: &quot;bfa2b7985bbc21913dde6c107757d174509a3d2efd16bb4f8cbbb27207ded3c8&quot;, &quot;EndpointID&quot;: &quot;ffe9142d9430ea741c13211eacb9f38c48edab057a3431b3aba999e7abd25ee2&quot;, &quot;Gateway&quot;: &quot;172.17.0.1&quot;, &quot;IPAddress&quot;: &quot;172.17.0.2&quot;, &quot;IPPrefixLen&quot;: 16, &quot;IPv6Gateway&quot;: &quot;&quot;, &quot;GlobalIPv6Address&quot;: &quot;&quot;, &quot;GlobalIPv6PrefixLen&quot;: 0, &quot;MacAddress&quot;: &quot;02:42:ac:11:00:02&quot;, &quot;DriverOpts&quot;: null &#125; &#125; &#125; &#125;] ssh连接1dbbruce@dbburce test1 % ssh root@172.17.0.2 WORKDIR用法12345678910111213FROM centos:latestRUN cd /etc/yum.repos.d/RUN sed -i &#x27;s/mirrorlist/#mirrorlist/g&#x27; /etc/yum.repos.d/CentOS-*RUN sed -i &#x27;s|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g&#x27; /etc/yum.repos.d/CentOS-*RUN yum update -yMAINTAINER Jacob redhat@163.comRUN yum -y install httpdENV EnvironmetFile=/etc/sysconfig/httpdWORKDIR /var/www/html/ADD index.html index.htmlEXPOSE 80EXPOSE 443CMD [&quot;httpd&quot;, &quot;-DFOREGROUND&quot;] 测试 123456789101112[root@5b09e1aecba1 html]# curl http://172.17.0.2:80/&lt;!DOCTYPE html&gt;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;title&gt;this is docker&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Welcome the docker world !&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt; cmd和entrypoint混合使用ENTRYPOINT 相当于定参：CMD 相当于变参：nginx 可以使用不同的配置文件启动 123456789101112[root@centos07-22 test]# cat dockerfileFROM centos:latestMAINTAINER dongmianRUN rm -fr /etc/yum.repos.d/*COPY Centos-vault-8.5.2111.repo /etc/yum.repos.d/RUN yum install wget -yRUN yum install nginx -yCOPY index.html /usr/share/nginx/html/EXPOSE 80ENTRYPOINT [&quot;/usr/sbin/nginx&quot;,&quot;-c&quot;]CMD [&quot;/etc/nginx/nginx.conf&quot;] volume实例 dockerfile12345678910from centos:latestmaintainer dbbrucerun rm -fr /etc/yum.repos.d/*copy Centos-vault-8.5.2111.repo /etc/yum.repos.d/run yum install wget -yrun yum install nginx -ycopy index.html /usr/share/nginx/html/expose 80volum3 [&quot;/data&quot;]cmd [&quot;/usr/sbin/nginx&quot;,&quot;-g&quot;,&quot;daemon off;&quot;] 1234567[root@centos07-22 test]# docker build -t volumncentos:v1 .[root@centos07-22 test]# docker imagesREPOSITORY TAG IMAGE ID CREATED SIZEvolumncentos v1 71a7325a46bb 5 seconds ago 357MB[root@centos07-22 test]# docker run -itd -P volumncentos:v1 容器里会有一个&#x2F;data的目录，映射到物理机的某个目录1234567[root@centos07-22 test]# docker exec -it 99d20bdec5e6 /bin/bash[root@99d20bdec5e6 /]# cd /data/[root@99d20bdec5e6 data]# ls[root@99d20bdec5e6 data]# touch 1.txt[root@99d20bdec5e6 data]# echo &quot;AAAAA&quot; &gt; 1.txt[root@99d20bdec5e6 data]# cat 1.txtAAAAA 试验inspect查看容器映射的物理机目录在哪里， source里是物理机目录，物理机里也能看到容器创建的文件 1234567891011121314[root@centos07-22 test]# docker inspect 99d20bdec5e6 &quot;Mounts&quot;: [ &#123; &quot;Type&quot;: &quot;volume&quot;, &quot;Name&quot;: &quot;f8b4971750b78e4abfbd5aefadb60907604b33dcd068fe11df3c8c7271baa306&quot;, &quot;Source&quot;: &quot;/var/lib/docker/volumes/f8b4971750b78e4abfbd5aefadb60907604b33dcd068fe11df3c8c7271baa306/_data&quot;, &quot;Destination&quot;: &quot;/data&quot;, &quot;Driver&quot;: &quot;local&quot;, &quot;Mode&quot;: &quot;&quot;, &quot;RW&quot;: true, &quot;Propagation&quot;: &quot;&quot; &#125; ], 12345[root@centos07-22 test]# cd /var/lib/docker/volumes/f8b4971750b78e4abfbd5aefadb60907604b33dcd068fe11df3c8c7271baa306/_data[root@centos07-22 _data]# ls1.txt[root@centos07-22 _data]# cat 1.txtAAAAA 简单的挂载方法:dockerfile中不写volume，在运行容器时使用-v，指定挂载目录1[root@centos07-22 ~]# docker run -itd -v /data1:/data2 -P cenginx:v1 ONBUILD，用于延迟执行说明；基于ONBUILD指令的镜像作为基础镜像，在构建镜像，会触发ONBUILD后面的COPY命令运行","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"docker","slug":"运维/docker","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/"},{"name":"基础","slug":"运维/docker/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"05-命令的别名","slug":"运维/Linux云计算教程/05-别名使用","date":"2021-08-05T03:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2021/08/05/运维/Linux云计算教程/05-别名使用/","link":"","permalink":"https://dbbruce.github.io/2021/08/05/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/05-%E5%88%AB%E5%90%8D%E4%BD%BF%E7%94%A8/","excerpt":"1. 别名的定义alias hn &#x3D; ‘hostname’mount 设备路径 挂载点目录 123[dong@master /]$ alias hn=&#x27;hostname&#x27;[dong@master /]$ hnmaster","text":"1. 别名的定义alias hn &#x3D; ‘hostname’mount 设备路径 挂载点目录 123[dong@master /]$ alias hn=&#x27;hostname&#x27;[dong@master /]$ hnmaster 2. 查看有效别名alias 1234567891011[dong@master /]$ aliasalias egrep=&#x27;egrep --color=auto&#x27;alias fgrep=&#x27;fgrep --color=auto&#x27;alias grep=&#x27;grep --color=auto&#x27;alias hn=&#x27;hostname&#x27;alias l.=&#x27;ls -d .* --color=auto&#x27;alias ll=&#x27;ls -l --color=auto&#x27;alias ls=&#x27;ls --color=auto&#x27;alias vi=&#x27;vim&#x27;alias which=&#x27;alias | /usr/bin/which --tty-only --read-alias --show-dot --show-tilde&#x27;[dong@master /]$ 3. 删除别名unalias hn 4. 永久别名1234[root@master ~]# vim ~/.bashrcalias rm=&#x27;rm -i&#x27;alias cp=&#x27;cp -i&#x27;alias mv=&#x27;mv -i&#x27;","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"04-mount命令","slug":"运维/Linux云计算教程/04-mount","date":"2021-08-04T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/04/运维/Linux云计算教程/04-mount/","link":"","permalink":"https://dbbruce.github.io/2021/08/04/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/04-mount/","excerpt":"1. mountmount 设备路径 挂载点目录 12[root@master /]# mount /dev/cdrom /dvdmount: /dev/sr0 写保护，将以只读方式挂载","text":"1. mountmount 设备路径 挂载点目录 12[root@master /]# mount /dev/cdrom /dvdmount: /dev/sr0 写保护，将以只读方式挂载 2.umount1[root@master /]# umount /dvd 3.千万不要挂载到&#x2F;下，挂载后，只能重启才能umount","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"04-Docker自定义镜像（手工人肉）","slug":"运维/docker/基础/04-docker自定义镜像（手工人肉）","date":"2021-08-04T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/04/运维/docker/基础/04-docker自定义镜像（手工人肉）/","link":"","permalink":"https://dbbruce.github.io/2021/08/04/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/04-docker%E8%87%AA%E5%AE%9A%E4%B9%89%E9%95%9C%E5%83%8F%EF%BC%88%E6%89%8B%E5%B7%A5%E4%BA%BA%E8%82%89%EF%BC%89/","excerpt":"docker自定义镜像自作镜像（手工人肉） 1 使用centos官方镜像，产生容器1234567891011docker imagesREPOSITORY TAG IMAGE ID CREATED SIZEmycentos7 latest 26934b5d7364 About an hour ago 533MBredis latest 7f27d60cb8e0 11 days ago 138MBnginx latest c20060033e06 12 days ago 187MBubuntu latest e4c58958181a 5 weeks ago 77.8MBbusybox latest a416a98b71e2 3 months ago 4.26MBcentos latest 5d0da3dc9764 2 years ago 231MBdocker run -itd centos","text":"docker自定义镜像自作镜像（手工人肉） 1 使用centos官方镜像，产生容器1234567891011docker imagesREPOSITORY TAG IMAGE ID CREATED SIZEmycentos7 latest 26934b5d7364 About an hour ago 533MBredis latest 7f27d60cb8e0 11 days ago 138MBnginx latest c20060033e06 12 days ago 187MBubuntu latest e4c58958181a 5 weeks ago 77.8MBbusybox latest a416a98b71e2 3 months ago 4.26MBcentos latest 5d0da3dc9764 2 years ago 231MBdocker run -itd centos 2 在容器里安装，ifconfig，vim等包123docker exec -it 889c5b9d5955 /bin/bashyum -y install vim psmisc net-tool 3 停止容器1docker stop 889c5b9d5955 4 产生新镜像1docker commit 889c5b9d5955 mycentos7:latest 5 导出新镜像1docker save mycentos7:latest -o mycentos7.tar","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"docker","slug":"运维/docker","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/"},{"name":"基础","slug":"运维/docker/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"03-Docker命令","slug":"运维/docker/基础/03-docker命令","date":"2021-08-03T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/03/运维/docker/基础/03-docker命令/","link":"","permalink":"https://dbbruce.github.io/2021/08/03/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/03-docker%E5%91%BD%E4%BB%A4/","excerpt":"docker命令镜像命令 docker images &#x2F;&#x2F;查看镜像列表 1234567[root@centos07-01 /]# docker imagesREPOSITORY TAG IMAGE ID CREATED SIZEredis latest 7f27d60cb8e0 5 days ago 138MBnginx latest c20060033e06 6 days ago 187MBubuntu latest e4c58958181a 4 weeks ago 77.8MBbusybox latest a416a98b71e2 3 months ago 4.26MBcentos latest 5d0da3dc9764 2 years ago 231MB docker history 镜像名:版本 &#x2F;&#x2F;查看镜像制作历史，主要看几层 12345# 2层，第一次添加文件，第二层 添加一个默认命名[root@centos07-01 /]# docker history busybox:latestIMAGE CREATED CREATED BY SIZE COMMENTa416a98b71e2 3 months ago /bin/sh -c #(nop) CMD [&quot;sh&quot;] 0B&lt;missing&gt; 3 months ago /bin/sh -c #(nop) ADD file:7e9002edaafd4e457… 4.26MB","text":"docker命令镜像命令 docker images &#x2F;&#x2F;查看镜像列表 1234567[root@centos07-01 /]# docker imagesREPOSITORY TAG IMAGE ID CREATED SIZEredis latest 7f27d60cb8e0 5 days ago 138MBnginx latest c20060033e06 6 days ago 187MBubuntu latest e4c58958181a 4 weeks ago 77.8MBbusybox latest a416a98b71e2 3 months ago 4.26MBcentos latest 5d0da3dc9764 2 years ago 231MB docker history 镜像名:版本 &#x2F;&#x2F;查看镜像制作历史，主要看几层 12345# 2层，第一次添加文件，第二层 添加一个默认命名[root@centos07-01 /]# docker history busybox:latestIMAGE CREATED CREATED BY SIZE COMMENTa416a98b71e2 3 months ago /bin/sh -c #(nop) CMD [&quot;sh&quot;] 0B&lt;missing&gt; 3 months ago /bin/sh -c #(nop) ADD file:7e9002edaafd4e457… 4.26MB docker inspect 镜像&#x2F;容器&#x2F;网络交换机 &#x2F;&#x2F;查看镜像底层信息，后面跟镜像就查看镜像信息，后面跟容器就查看容器信息 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120# CMD：完整启动命令# Env: 设置环境变量的[root@centos07-01 /]# docker inspect nginx:latest[ &#123; &quot;Id&quot;: &quot;sha256:c20060033e06f882b0fbe2db7d974d72e0887a3be5e554efdb0dcf8d53512647&quot;, &quot;RepoTags&quot;: [ &quot;nginx:latest&quot; ], &quot;RepoDigests&quot;: [], &quot;Parent&quot;: &quot;&quot;, &quot;Comment&quot;: &quot;&quot;, &quot;Created&quot;: &quot;2023-11-01T05:12:14.305489502Z&quot;, &quot;Container&quot;: &quot;22d7d657198f5b244b6263948a9fbb121dfeac76df31a9769da4586fb5115071&quot;, &quot;ContainerConfig&quot;: &#123; &quot;Hostname&quot;: &quot;22d7d657198f&quot;, &quot;Domainname&quot;: &quot;&quot;, &quot;User&quot;: &quot;&quot;, &quot;AttachStdin&quot;: false, &quot;AttachStdout&quot;: false, &quot;AttachStderr&quot;: false, &quot;ExposedPorts&quot;: &#123; &quot;80/tcp&quot;: &#123;&#125; &#125;, &quot;Tty&quot;: false, &quot;OpenStdin&quot;: false, &quot;StdinOnce&quot;: false, &quot;Env&quot;: [ &quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;, &quot;NGINX_VERSION=1.25.3&quot;, &quot;NJS_VERSION=0.8.2&quot;, &quot;PKG_RELEASE=1~bookworm&quot; ], &quot;Cmd&quot;: [ &quot;/bin/sh&quot;, &quot;-c&quot;, &quot;#(nop) &quot;, &quot;CMD [\\&quot;nginx\\&quot; \\&quot;-g\\&quot; \\&quot;daemon off;\\&quot;]&quot; ], &quot;Image&quot;: &quot;sha256:68099835596e7e1043c4c8bbbc1961c727080f9ebb5c0b2c54387c794eb0f621&quot;, &quot;Volumes&quot;: null, &quot;WorkingDir&quot;: &quot;&quot;, &quot;Entrypoint&quot;: [ &quot;/docker-entrypoint.sh&quot; ], &quot;OnBuild&quot;: null, &quot;Labels&quot;: &#123; &quot;maintainer&quot;: &quot;NGINX Docker Maintainers &lt;docker-maint@nginx.com&gt;&quot; &#125;, &quot;StopSignal&quot;: &quot;SIGQUIT&quot; &#125;, &quot;DockerVersion&quot;: &quot;20.10.23&quot;, &quot;Author&quot;: &quot;&quot;, &quot;Config&quot;: &#123; &quot;Hostname&quot;: &quot;&quot;, &quot;Domainname&quot;: &quot;&quot;, &quot;User&quot;: &quot;&quot;, &quot;AttachStdin&quot;: false, &quot;AttachStdout&quot;: false, &quot;AttachStderr&quot;: false, &quot;ExposedPorts&quot;: &#123; &quot;80/tcp&quot;: &#123;&#125; &#125;, &quot;Tty&quot;: false, &quot;OpenStdin&quot;: false, &quot;StdinOnce&quot;: false, &quot;Env&quot;: [ &quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;, &quot;NGINX_VERSION=1.25.3&quot;, &quot;NJS_VERSION=0.8.2&quot;, &quot;PKG_RELEASE=1~bookworm&quot; ], &quot;Cmd&quot;: [ &quot;nginx&quot;, &quot;-g&quot;, &quot;daemon off;&quot; ], &quot;Image&quot;: &quot;sha256:68099835596e7e1043c4c8bbbc1961c727080f9ebb5c0b2c54387c794eb0f621&quot;, &quot;Volumes&quot;: null, &quot;WorkingDir&quot;: &quot;&quot;, &quot;Entrypoint&quot;: [ &quot;/docker-entrypoint.sh&quot; ], &quot;OnBuild&quot;: null, &quot;Labels&quot;: &#123; &quot;maintainer&quot;: &quot;NGINX Docker Maintainers &lt;docker-maint@nginx.com&gt;&quot; &#125;, &quot;StopSignal&quot;: &quot;SIGQUIT&quot; &#125;, &quot;Architecture&quot;: &quot;amd64&quot;, &quot;Os&quot;: &quot;linux&quot;, &quot;Size&quot;: 186779301, &quot;VirtualSize&quot;: 186779301, &quot;GraphDriver&quot;: &#123; &quot;Data&quot;: &#123; &quot;LowerDir&quot;: &quot;/var/lib/docker/overlay2/319cd04b5f5cf6fd8a499571c8f903efa6bdf7357598658724d54d056a370102/diff:/var/lib/docker/overlay2/ac7a9b1a3dd341effd42f0b3455283646a70d36ca3725383c318f2f237a71d74/diff:/var/lib/docker/overlay2/bc61dfed137b909a339aa210029ba8febdc3e431af3df02577e4349373e9b096/diff:/var/lib/docker/overlay2/b5ad1eeaec2817d3e5ddb8037613e59d13c5e1d1d1588b1f03ab6c0403513394/diff:/var/lib/docker/overlay2/039c82ff0e5f91e6abe5409f971c572f325c7ab4d010ff4c45bfc16aa9ba26db/diff:/var/lib/docker/overlay2/486579cb2ab855ffd1a75a8260b155b06b2b7a7ea883dc89269ace4756fb6f3d/diff&quot;, &quot;MergedDir&quot;: &quot;/var/lib/docker/overlay2/b07a1fe6bec03eb2a321991a72ffd105b61f04d6bdeb842bfbd795bc810645b3/merged&quot;, &quot;UpperDir&quot;: &quot;/var/lib/docker/overlay2/b07a1fe6bec03eb2a321991a72ffd105b61f04d6bdeb842bfbd795bc810645b3/diff&quot;, &quot;WorkDir&quot;: &quot;/var/lib/docker/overlay2/b07a1fe6bec03eb2a321991a72ffd105b61f04d6bdeb842bfbd795bc810645b3/work&quot; &#125;, &quot;Name&quot;: &quot;overlay2&quot; &#125;, &quot;RootFS&quot;: &#123; &quot;Type&quot;: &quot;layers&quot;, &quot;Layers&quot;: [ &quot;sha256:ec983b16636050e69677eb81537e955ab927757c23aaf73971ecf5f71fcc262a&quot;, &quot;sha256:609f2a18d224cf695a954a6fe2785101828954829417021d1f7c3fa4d31e0753&quot;, &quot;sha256:e503754c9a26543a728b7c3641e617c2a69ca599617ce783eeb81bc12a88df95&quot;, &quot;sha256:715b32fa0f1206db2a1b8855eb8a5f90392d4c30e622fced07baf73b0711d31b&quot;, &quot;sha256:768e28a222fdcbea7962af44913d7ccba7e9d03e1aa089e428103caa87d89eb8&quot;, &quot;sha256:9920f1ebf52b217bf9e7a40a88cf4c609450692fc5b2b112347a1b05fbb8ae57&quot;, &quot;sha256:505f49f13fbe9f5ff9e965e1ef1280f4fd776153cab92f152bd572926eed8830&quot; ] &#125;, &quot;Metadata&quot;: &#123; &quot;LastTagTime&quot;: &quot;0001-01-01T00:00:00Z&quot; &#125; &#125;] 跟容器 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206[root@centos07-01 ~]# docker psCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES8814b50dbfe9 centos:latest &quot;/bin/bash&quot; About a minute ago Up 57 seconds pedantic_ptolemy[root@centos07-01 ~]# docker inspect 8814b50dbfe9[ &#123; &quot;Id&quot;: &quot;8814b50dbfe96c656bc38a9d28f83745339fd5810c1229ae4a9748416226510a&quot;, &quot;Created&quot;: &quot;2023-11-07T10:15:18.44658441Z&quot;, &quot;Path&quot;: &quot;/bin/bash&quot;, &quot;Args&quot;: [], &quot;State&quot;: &#123; &quot;Status&quot;: &quot;running&quot;, &quot;Running&quot;: true, &quot;Paused&quot;: false, &quot;Restarting&quot;: false, &quot;OOMKilled&quot;: false, &quot;Dead&quot;: false, &quot;Pid&quot;: 4933, &quot;ExitCode&quot;: 0, &quot;Error&quot;: &quot;&quot;, &quot;StartedAt&quot;: &quot;2023-11-07T10:15:21.671927901Z&quot;, &quot;FinishedAt&quot;: &quot;0001-01-01T00:00:00Z&quot; &#125;, &quot;Image&quot;: &quot;sha256:5d0da3dc976460b72c77d94c8a1ad043720b0416bfc16c52c45d4847e53fadb6&quot;, &quot;ResolvConfPath&quot;: &quot;/var/lib/docker/containers/8814b50dbfe96c656bc38a9d28f83745339fd5810c1229ae4a9748416226510a/resolv.conf&quot;, &quot;HostnamePath&quot;: &quot;/var/lib/docker/containers/8814b50dbfe96c656bc38a9d28f83745339fd5810c1229ae4a9748416226510a/hostname&quot;, &quot;HostsPath&quot;: &quot;/var/lib/docker/containers/8814b50dbfe96c656bc38a9d28f83745339fd5810c1229ae4a9748416226510a/hosts&quot;, &quot;LogPath&quot;: &quot;/var/lib/docker/containers/8814b50dbfe96c656bc38a9d28f83745339fd5810c1229ae4a9748416226510a/8814b50dbfe96c656bc38a9d28f83745339fd5810c1229ae4a9748416226510a-json.log&quot;, &quot;Name&quot;: &quot;/pedantic_ptolemy&quot;, &quot;RestartCount&quot;: 0, &quot;Driver&quot;: &quot;overlay2&quot;, &quot;Platform&quot;: &quot;linux&quot;, &quot;MountLabel&quot;: &quot;&quot;, &quot;ProcessLabel&quot;: &quot;&quot;, &quot;AppArmorProfile&quot;: &quot;&quot;, &quot;ExecIDs&quot;: null, &quot;HostConfig&quot;: &#123; &quot;Binds&quot;: null, &quot;ContainerIDFile&quot;: &quot;&quot;, &quot;LogConfig&quot;: &#123; &quot;Type&quot;: &quot;json-file&quot;, &quot;Config&quot;: &#123;&#125; &#125;, &quot;NetworkMode&quot;: &quot;default&quot;, &quot;PortBindings&quot;: &#123;&#125;, &quot;RestartPolicy&quot;: &#123; &quot;Name&quot;: &quot;no&quot;, &quot;MaximumRetryCount&quot;: 0 &#125;, &quot;AutoRemove&quot;: false, &quot;VolumeDriver&quot;: &quot;&quot;, &quot;VolumesFrom&quot;: null, &quot;ConsoleSize&quot;: [ 45, 191 ], &quot;CapAdd&quot;: null, &quot;CapDrop&quot;: null, &quot;CgroupnsMode&quot;: &quot;host&quot;, &quot;Dns&quot;: [], &quot;DnsOptions&quot;: [], &quot;DnsSearch&quot;: [], &quot;ExtraHosts&quot;: null, &quot;GroupAdd&quot;: null, &quot;IpcMode&quot;: &quot;private&quot;, &quot;Cgroup&quot;: &quot;&quot;, &quot;Links&quot;: null, &quot;OomScoreAdj&quot;: 0, &quot;PidMode&quot;: &quot;&quot;, &quot;Privileged&quot;: false, &quot;PublishAllPorts&quot;: false, &quot;ReadonlyRootfs&quot;: false, &quot;SecurityOpt&quot;: null, &quot;UTSMode&quot;: &quot;&quot;, &quot;UsernsMode&quot;: &quot;&quot;, &quot;ShmSize&quot;: 67108864, &quot;Runtime&quot;: &quot;runc&quot;, &quot;Isolation&quot;: &quot;&quot;, &quot;CpuShares&quot;: 0, &quot;Memory&quot;: 0, &quot;NanoCpus&quot;: 0, &quot;CgroupParent&quot;: &quot;&quot;, &quot;BlkioWeight&quot;: 0, &quot;BlkioWeightDevice&quot;: [], &quot;BlkioDeviceReadBps&quot;: [], &quot;BlkioDeviceWriteBps&quot;: [], &quot;BlkioDeviceReadIOps&quot;: [], &quot;BlkioDeviceWriteIOps&quot;: [], &quot;CpuPeriod&quot;: 0, &quot;CpuQuota&quot;: 0, &quot;CpuRealtimePeriod&quot;: 0, &quot;CpuRealtimeRuntime&quot;: 0, &quot;CpusetCpus&quot;: &quot;&quot;, &quot;CpusetMems&quot;: &quot;&quot;, &quot;Devices&quot;: [], &quot;DeviceCgroupRules&quot;: null, &quot;DeviceRequests&quot;: null, &quot;MemoryReservation&quot;: 0, &quot;MemorySwap&quot;: 0, &quot;MemorySwappiness&quot;: null, &quot;OomKillDisable&quot;: false, &quot;PidsLimit&quot;: null, &quot;Ulimits&quot;: null, &quot;CpuCount&quot;: 0, &quot;CpuPercent&quot;: 0, &quot;IOMaximumIOps&quot;: 0, &quot;IOMaximumBandwidth&quot;: 0, &quot;MaskedPaths&quot;: [ &quot;/proc/asound&quot;, &quot;/proc/acpi&quot;, &quot;/proc/kcore&quot;, &quot;/proc/keys&quot;, &quot;/proc/latency_stats&quot;, &quot;/proc/timer_list&quot;, &quot;/proc/timer_stats&quot;, &quot;/proc/sched_debug&quot;, &quot;/proc/scsi&quot;, &quot;/sys/firmware&quot;, &quot;/sys/devices/virtual/powercap&quot; ], &quot;ReadonlyPaths&quot;: [ &quot;/proc/bus&quot;, &quot;/proc/fs&quot;, &quot;/proc/irq&quot;, &quot;/proc/sys&quot;, &quot;/proc/sysrq-trigger&quot; ] &#125;, &quot;GraphDriver&quot;: &#123; &quot;Data&quot;: &#123; &quot;LowerDir&quot;: &quot;/var/lib/docker/overlay2/831dd4146195cdf5c53fd67878781a1a66513043afd5dd3f366a8cb17a10fe8f-init/diff:/var/lib/docker/overlay2/38298b0d622f2d26eaba10b460b2f46f2ecc2e61cbc2b6bea15df7d41183ec60/diff&quot;, &quot;MergedDir&quot;: &quot;/var/lib/docker/overlay2/831dd4146195cdf5c53fd67878781a1a66513043afd5dd3f366a8cb17a10fe8f/merged&quot;, &quot;UpperDir&quot;: &quot;/var/lib/docker/overlay2/831dd4146195cdf5c53fd67878781a1a66513043afd5dd3f366a8cb17a10fe8f/diff&quot;, &quot;WorkDir&quot;: &quot;/var/lib/docker/overlay2/831dd4146195cdf5c53fd67878781a1a66513043afd5dd3f366a8cb17a10fe8f/work&quot; &#125;, &quot;Name&quot;: &quot;overlay2&quot; &#125;, &quot;Mounts&quot;: [], &quot;Config&quot;: &#123; &quot;Hostname&quot;: &quot;8814b50dbfe9&quot;, &quot;Domainname&quot;: &quot;&quot;, &quot;User&quot;: &quot;&quot;, &quot;AttachStdin&quot;: true, &quot;AttachStdout&quot;: true, &quot;AttachStderr&quot;: true, &quot;Tty&quot;: true, &quot;OpenStdin&quot;: true, &quot;StdinOnce&quot;: true, &quot;Env&quot;: [ &quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot; ], &quot;Cmd&quot;: [ &quot;/bin/bash&quot; ], &quot;Image&quot;: &quot;centos:latest&quot;, &quot;Volumes&quot;: null, &quot;WorkingDir&quot;: &quot;&quot;, &quot;Entrypoint&quot;: null, &quot;OnBuild&quot;: null, &quot;Labels&quot;: &#123; &quot;org.label-schema.build-date&quot;: &quot;20210915&quot;, &quot;org.label-schema.license&quot;: &quot;GPLv2&quot;, &quot;org.label-schema.name&quot;: &quot;CentOS Base Image&quot;, &quot;org.label-schema.schema-version&quot;: &quot;1.0&quot;, &quot;org.label-schema.vendor&quot;: &quot;CentOS&quot; &#125; &#125;, &quot;NetworkSettings&quot;: &#123; &quot;Bridge&quot;: &quot;&quot;, &quot;SandboxID&quot;: &quot;e5560453998b5c03355f73e559c34cf6da1a5805ea82f5ed4b536720e508c302&quot;, &quot;HairpinMode&quot;: false, &quot;LinkLocalIPv6Address&quot;: &quot;&quot;, &quot;LinkLocalIPv6PrefixLen&quot;: 0, &quot;Ports&quot;: &#123;&#125;, &quot;SandboxKey&quot;: &quot;/var/run/docker/netns/e5560453998b&quot;, &quot;SecondaryIPAddresses&quot;: null, &quot;SecondaryIPv6Addresses&quot;: null, &quot;EndpointID&quot;: &quot;381337c0333a01d592abedf1af472ef4d3c80b3749b03ea8bb81322769f82dd9&quot;, &quot;Gateway&quot;: &quot;172.17.0.1&quot;, &quot;GlobalIPv6Address&quot;: &quot;&quot;, &quot;GlobalIPv6PrefixLen&quot;: 0, &quot;IPAddress&quot;: &quot;172.17.0.2&quot;, &quot;IPPrefixLen&quot;: 16, &quot;IPv6Gateway&quot;: &quot;&quot;, &quot;MacAddress&quot;: &quot;02:42:ac:11:00:02&quot;, &quot;Networks&quot;: &#123; &quot;bridge&quot;: &#123; &quot;IPAMConfig&quot;: null, &quot;Links&quot;: null, &quot;Aliases&quot;: null, &quot;NetworkID&quot;: &quot;201e92c1d4322444ce93efc669ecff48837116155f66505a0a2154de32586449&quot;, &quot;EndpointID&quot;: &quot;381337c0333a01d592abedf1af472ef4d3c80b3749b03ea8bb81322769f82dd9&quot;, &quot;Gateway&quot;: &quot;172.17.0.1&quot;, &quot;IPAddress&quot;: &quot;172.17.0.2&quot;, &quot;IPPrefixLen&quot;: 16, &quot;IPv6Gateway&quot;: &quot;&quot;, &quot;GlobalIPv6Address&quot;: &quot;&quot;, &quot;GlobalIPv6PrefixLen&quot;: 0, &quot;MacAddress&quot;: &quot;02:42:ac:11:00:02&quot;, &quot;DriverOpts&quot;: null &#125; &#125; &#125; &#125;] docker pull 镜像:版本 &#x2F;&#x2F;下载镜像 1[root@centos07-01 /]# docker pull busybox docker push [OPTIONS] NAME[:TAG] &#x2F;&#x2F;上传镜像 docker rmi id&#x2F;名称:版本 &#x2F;&#x2F;删除本地镜像，删除镜像，必须删除使用过这个镜像的容器，容器运行和停止的都要先删除images id唯一时，可以使用id删除-f 强制删除 123456789[root@centos07-01 ~]# docker rmi nginx:latestUntagged: nginx:latestDeleted: sha256:c20060033e06f882b0fbe2db7d974d72e0887a3be5e554efdb0dcf8d53512647Deleted: sha256:32cf0b3c70998330104acfc1a02f6aae2f8a728bc6ad91c2415fda501593fa81Deleted: sha256:79cae367d5d42d54224c249db6a06234d077ea32168bed4261141c1016469623Deleted: sha256:32b31b2b0563a28eb36f90bcd835540ead275b63cf48ed85e998a8df0b1845ffDeleted: sha256:203226d708244adf6c392a28e22e3a7e276270da43094205137c404fc9949691Deleted: sha256:9969d65d0618198425e0be29ec6194be71b36c856ce9fe2142dd54163aef6eaeDeleted: sha256:e9c1515f88f6e5652bde5583f0d1ddb7dd4097380aa66d90b722c53fbea3ebab docker save &#x2F;&#x2F;镜像另存为tar包docker save 名称:标签 -o xxx.tar 12345[root@centos07-01 ~]# docker imagesREPOSITORY TAG IMAGE ID CREATED SIZEbusybox latest a416a98b71e2 3 months ago 4.26MB[root@centos07-01 ~]# docker save busybox:latest -o busybox.tar docker load &#x2F;&#x2F;使用tar包导入镜像docker load -i 本地镜像包 12345678910[root@centos07-22 ~]# docker imagesREPOSITORY TAG IMAGE ID CREATED SIZE[root@centos07-22 ~]# docker load -i busybox.tar3d24ee258efc: Loading layer [==================================================&gt;] 4.492MB/4.492MBLoaded image: busybox:latest[root@centos07-22 ~]# docker imagesREPOSITORY TAG IMAGE ID CREATED SIZEbusybox latest a416a98b71e2 3 months ago 4.26MB docker search &#x2F;&#x2F;搜索镜像name 镜像名称，下载时需要使用这个名称OFFICIAL 带有ok的是官网镜像，没有ok的就是用户自己做的 1234567[root@centos07-01 /]# docker search busyboxNAME DESCRIPTION STARS OFFICIAL AUTOMATEDbusybox Busybox base image. 3131 [OK]rancher/busybox 0openebs/busybox-client 1antrea/busybox 1hugegraph/busybox test image 2 docker tag 原名称:版本 新名称：新版本 &#x2F;&#x2F;修改镜像名称和标签，相当于创建一个软连接，既可以改名称，也可以改标签，或者全改修改的名称和标签，不能与别的镜像一样；修改后的image id，会相同 123456789101112[root@centos07-01 ~]# docker tag busybox:latest busybox:abc[root@centos07-01 ~]# docker tag busybox:latest bsb:abc[root@centos07-01 ~]# docker imagesREPOSITORY TAG IMAGE ID CREATED SIZEredis latest 7f27d60cb8e0 5 days ago 138MBnginx latest c20060033e06 6 days ago 187MBubuntu latest e4c58958181a 4 weeks ago 77.8MBbsb abc a416a98b71e2 3 months ago 4.26MB # 修改的busybox abc a416a98b71e2 3 months ago 4.26MB # 修改的busybox latest a416a98b71e2 3 months ago 4.26MB # 原centos latest 5d0da3dc9764 2 years ago 231MB 容器命令 docker ps -a &#x2F;&#x2F; 查看容器进程信息，加 -a查看全部容器，包括停止和运行的；不加-a查看正在运行的docker-a 全部显示-q 简略显示，只显示id-aq 简略显示，显示全部id CONTAINER ID 容器idIMAGE 镜像COMMAND 容器里执行的命令CREATED 创建的时间STATUS 状态PORTSNAMES 名字，不指定随机名称 123[root@centos07-01 ~]# docker psCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMEScdd06403bd6d centos:latest &quot;/bin/bash&quot; About a minute ago Up About a minute agitated_sammet docker run &#x2F;&#x2F; 启动镜像，生成容器run-i 交互式 -it 打开一个交互式终端-t 终端-d 容器后台运行run-p(小写) 指定端口映射，格式：主机(宿主)端口:容器端口-P(大写) 随机端口映射，容器内部端口随机映射到主机的端口（49153起始 49153到65535）–name –name&#x3D;centosrun 指定容器名称-v 指定容器和物理机的映射目录:docker run -itd -v &#x2F;data1:&#x2F;data2 -P cenginx:v1 : -v 物理机目录：容器目录12[root@centos07-01 /]# docker run -itd centos:latest /bin/bash62068dcc95798d5dfe8316a5448e84d4ea8b00269c9dff86f5135870a7dd8e7b 注意每运行一个容器，宿主机上就会多一个veth***开头的网卡，veth作用就是流量转发1234567891011121314151617181920212223242526272829303132333435[root@centos07-22 ~]# ifconfigdocker0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500 inet 172.17.0.1 netmask 255.255.0.0 broadcast 172.17.255.255 inet6 fe80::42:63ff:feab:cca9 prefixlen 64 scopeid 0x20&lt;link&gt; ether 02:42:63:ab:cc:a9 txqueuelen 0 (Ethernet) RX packets 13093 bytes 565907 (552.6 KiB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 22262 bytes 61974363 (59.1 MiB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0enp0s3: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500 inet 192.168.1.22 netmask 255.255.255.0 broadcast 192.168.1.255 inet6 fe80::885:90eb:3a46:25fa prefixlen 64 scopeid 0x20&lt;link&gt; inet6 2409:8a00:6035:e890:1bf:c9d7:671d:fdd8 prefixlen 64 scopeid 0x0&lt;global&gt; ether 08:00:27:ab:32:79 txqueuelen 1000 (Ethernet) RX packets 4119 bytes 328339 (320.6 KiB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 2038 bytes 821631 (802.3 KiB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0veth10d2c58: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500 inet6 fe80::d435:56ff:feac:3fc6 prefixlen 64 scopeid 0x20&lt;link&gt; ether d6:35:56:ac:3f:c6 txqueuelen 0 (Ethernet) RX packets 13093 bytes 749209 (731.6 KiB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 22270 bytes 61975019 (59.1 MiB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0veth972cb64: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500 inet6 fe80::9833:67ff:feac:4309 prefixlen 64 scopeid 0x20&lt;link&gt; ether 9a:33:67:ac:43:09 txqueuelen 0 (Ethernet) RX packets 0 bytes 0 (0.0 B) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 7 bytes 586 (586.0 B) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 docker stop 容器id &#x2F;&#x2F; 停止容器 12[root@centos07-01 ~]# docker stop 62068dcc957962068dcc9579 docker start 容器id &#x2F;&#x2F; 启动容器 12[root@centos07-01 ~]# docker start 62068dcc957962068dcc9579 docker restart 容器id &#x2F;&#x2F; 重新启动容器 12[root@centos07-01 ~]# docker restart 62068dcc957962068dcc9579 docker attach 容器id &#x2F;&#x2F;进入容器，attach退出容器，容器会被关闭；特殊情况使用；只能看交互的，非交互的看不了；attach 进入的进程id是1，也就是所有的父进程，这时退出的话，父进程id1退出，所有进程就会退出，容器就关闭了； 123[root@centos07-01 ~]# docker attach af7830aec077[root@af7830aec077 /]# echo $$1 误进入想要保留容器，使用下面命令退出，保留容器；1先按ctrl+p,再按ctrl+q docker exec -it 容器id 命令 &#x2F;&#x2F;进入容器，退出，容器不会关闭，99%使用这个进入容器； 123[root@centos07-01 ~]# docker exec -it af7830aec077 /bin/bash[root@af7830aec077 /]# exitexit docker inspect 容器id &#x2F;&#x2F;查看容器底层信息 1[root@centos07-01 ~]# docker inspect 644c0a990634 docker top 容器id &#x2F;&#x2F;查看容器进程列表，docker外部查看docker内部进程123[root@centos07-01 ~]# docker top 644c0a990634UID PID PPID C STIME TTY TIME CMDroot 6902 6881 0 20:56 pts/0 00:00:00 /bin/bash docker rm &#x2F;&#x2F;删除容器, docker运行的不能删除，必须停止12[root@centos07-01 ~]# docker rm $(docker stop 644c0a990634)644c0a990634 删除全部容器 123456[root@centos07-01 ~]# docker rm $(docker ps -qa)62068dcc9579cdd06403bd6d8814b50dbfe991c03c0cbd51dff0c5a833cc docker commit 容器id 新镜像名:新镜像版本使用镜像启动容器，在该容器基础上修改另存为一个新镜像 1docker commit 889c5b9d5955 mycentos7:latest docker build 从 Dockerfile 和上下文构建镜像-f 指定dockerfile路径 1docker build -t ubuntu-nginx:v1 . -t 指定构建的镜像名和tag 12docker build -t shykes/myapp:1.0.2 -t shykes/myapp:latest .","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"docker","slug":"运维/docker","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/"},{"name":"基础","slug":"运维/docker/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"03-常用快捷键","slug":"运维/Linux云计算教程/03-常用快捷键","date":"2021-08-03T02:02:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/03/运维/Linux云计算教程/03-常用快捷键/","link":"","permalink":"https://dbbruce.github.io/2021/08/03/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/03-%E5%B8%B8%E7%94%A8%E5%BF%AB%E6%8D%B7%E9%94%AE/","excerpt":"1. 执行历史中匹配输入的内容[root@master ~]# ctrl + r(reverse-i-search)&#96;w’: whoami","text":"1. 执行历史中匹配输入的内容[root@master ~]# ctrl + r(reverse-i-search)&#96;w’: whoami 2.将上一条命令的参数 复制赞贴下来 (mac 先按esc，再按点，好用)按alt不能松手再按)，esc+.(按完esc后松手再按.)，可以把上个命令的参数直接粘贴上来 3.清屏crtl + l 4.清空到行首ctrl + u 5.往回删除一个单词，空格分隔ctrl + w","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"02-基础命令","slug":"运维/Linux云计算教程/02-基础命令","date":"2021-08-02T03:00:52.000Z","updated":"2024-09-03T01:39:09.000Z","comments":true,"path":"2021/08/02/运维/Linux云计算教程/02-基础命令/","link":"","permalink":"https://dbbruce.github.io/2021/08/02/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/02-%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4/","excerpt":"1.磁盘&#x2F;dev&#x2F;sda sd代表磁盘类型，a代表第几块磁盘&#x2F;dev&#x2F;hdahd表示IDE设备，老设备，传输慢sd表示scsi设备，新设备，传输快","text":"1.磁盘&#x2F;dev&#x2F;sda sd代表磁盘类型，a代表第几块磁盘&#x2F;dev&#x2F;hdahd表示IDE设备，老设备，传输慢sd表示scsi设备，新设备，传输快 2.命令行表示[用户@主机名 工作目录]$ 3.cat查看系统版本cat &#x2F;etc&#x2F;redhat-releaseCentOS Linux release 7.9.2009 (Core) 4.CPUlscpu 5.内存[root@localhost ~]# cat &#x2F;proc&#x2F;meminfo 6.hostname临时修改[root@localhost ~]# hostname master永久修改[root@localhost ~]# vim &#x2F;etc&#x2F;hostname 7.ifconfig网卡信息enp0s3: flags&#x3D;4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500 inet 192.168.1.12 netmask 255.255.255.0 broadcast 192.168.1.255 inet6 2409:8a00:6037:3410:a579:ef16:4b1f:3b31 prefixlen 64 scopeid 0x0 inet6 fe80::f1a3:a1af:6006:3ae6 prefixlen 64 scopeid 0x20 ether 08:00:27:79:a3:b8 txqueuelen 1000 (Ethernet) RX packets 1114 bytes 81591 (79.6 KiB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 406 bytes 73419 (71.6 KiB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 lo: 回环测试接口，ip用于为：127.0.0.1 ，代表自己，用于访问自己 8.touch创建空文件touch 1.txt 9.分屏阅读 lessless &#x2F;etc&#x2F;passwd翻页 ：b 前&#x2F;f 后搜索 ： &#x2F;root搜索前后匹配： n 后&#x2F;N 前退出：q 10.head &#x2F; tail查看头5行head -n 5 anaconda-ks.cfg 简写 head -5 anaconda-ks.cfg尾部5行tail -n 5 anaconda-ks.cfg 简写 tail -5 anaconda-ks.cfgtail -f anaconda-ks.cfg 11.grep 输出包含指定字符串的内容[root@localhost ~]# grep ‘root’ &#x2F;etc&#x2F;passwdroot:x:0:0:root:&#x2F;root:&#x2F;bin&#x2F;bashoperator:x:11:0:operator:&#x2F;root:&#x2F;sbin&#x2F;nologin 12.nmtui图形配置网络 13.vim命名模式，插入模式，末行模式 命 — i — 插入模式 — ESC 退出令模式 — : — 末行模式 — wq&#x2F;!wq — ESC 退出 14.关机、重启poweroff &#x2F; reboot 15. “家目录”~ 表示 “家目录”&#x2F;root 表示 管理员”家目录”&#x2F;home 表示 普通”家目录” 16. 添加用户useradd tom1 17. lsls -h 显示单位ls -a 显示隐藏文件ls -l 长格式，显示全部信息 18.匹配符*：任意个？：一个 1ls /dev/tty?? [a-z]:多个字符中的一个，若无忽略， 注意：不识别9以上 12dong@master /]$ ls /dev/tty[1-3]/dev/tty1 /dev/tty2 /dev/tty3 {a, min, xy}: 多组不同的字符串，全匹配 12[dong@master /]$ ls /dev/tty&#123;2,4,6,8&#125;/dev/tty2 /dev/tty4 /dev/tty6 /dev/tty8 19.mkdir -p &#x2F;test&#x2F;test2&#x2F;test3创建父目录和子目录 20. -R 递归，显示所有子目录和子目录下的所有ls -R &#x2F;home 12345[dong@master /]$ ls -R /home/home:dong/home/dong: 21. 删除 (危险命令)rm-r 递归删除-f 强制删除-i 提示是否删除删除文件一定加i 22.grep 过滤-i : 忽略大小写-v : 取反^root :以什么开头root$ :以什么结尾 1grep -i root /etc/passwd 23.cp 复制复制目录，-r 递归cp -r &#x2F;1 &#x2F;2 24.内核版本12[dong@master t1]$ uname -r3.10.0-1160.el7.x86_64 25.黑洞设备：&#x2F;dev&#x2F;null不想收集的信息直接给黑洞设备，直接丢弃信息，不占用磁盘和内存； 26.创建多个文件1touch test&#123;20..30&#125;.txt 27.selinun管理内部安全SELinux的运行模式 enforcing(强制)、 permissive(宽松) disabled(彻底禁用)任何模式切换到disabled(彻底禁用)都必须经历重启系统查看 12[dong@master ~]$ getenforceEnforcing 28.调整历史命令的数量[rootasvr7 ~]# vim &#x2F;etc&#x2F;profileHISTSIZE&#x3D;1000#默认记录1000条 29.管理&#x2F;调用曾经执行过的命令history:查看历史命令列表history -c:清空历史命令!n:执行命令历史中的第n条命令!str:执行最近一次以str开头的历史命令 30.du,统计文件的占用空间du [选项]…[目录或文件]…-s:只统计每个参数所占用的总空间大小-h:提供易读容量单位(K、M等) 12[root@master ~]# du -sh /root304K /root 31.date,查看&#x2F;调整系统日期时间date +%F、date +%Rdate +”%Y-%m-%d %H:%M:%Sdate -s “yyyy-mm-dd HH:MM:SS’date +%F #显示年-月-日date +%Y #显示年date +%m #显示月date +%d #显示日期date +%H #显示时date +%M #显示分date +%S #显示秒 32.制作快捷方式ln -s &#x2F;路径&#x2F;源数据路径 &#x2F;快捷方式名a字 创建软连接ln -s 原始文件或目录 软连接文件若原始文件或目录被删除，连接文件将失效软连接可存放在不同分区&#x2F;文件系统 ln 原始文件 硬连接文件若原始文件被删除，连接文件仍可用硬连接与原始文件必须在同一分区&#x2F;文件系统 33.具备很多的软件包,将toolstar.gz上传到虚拟机A的&#x2F;root下]$ scp&#x3D;ssh+cp真机:]$ scp&#x2F;本地路径&#x2F;源数据 root@对方IP地址:&#x2F;对方的路径]$ ls &#x2F;linux-soft&#x2F;01]$ scp &#x2F;linux-soft&#x2F;01&#x2F;tools.tar.gz &#114;&#111;&#111;&#116;&#x40;&#49;&#x39;&#50;&#x2e;&#x31;&#x36;&#56;&#46;&#52;&#46;&#x37;:root&#x2F; 34.域名的解析1234567891011[root@master ~]# nslookup www.baidu.comServer: fe80::1%2Address: fe80::1%2#53Non-authoritative answer:www.baidu.com canonical name = www.a.shifen.com.Name: www.a.shifen.comAddress: 39.156.66.18Name: www.a.shifen.comAddress: 39.156.66.14 35.umask值:权限掩码与用户创建的目录默认权限有关7777-022 &#x3D; 755,创建的文件默认权限就是755 12dbbruce@dbburce ~ % umask022 36.过滤已经安装的包yum list installed | grep vsftpd 37.查看进程的启动端口1netstat - ntulp | grep nginx 38。netstat命令可以查看系统中启动的端口信息，该命令常用选项如下-n 以数字格式显示端口号-t 显示TCP连接的端口-u 显示UDP连接的端口-l 显示服务正在监听的端口信息，如httpd启动后，会一直监听80端口-p 显示监听端口的服务名称是什么 (也就是程序名称) 39.o+wchmod 修改文件或目录的访问权限。o表示other 其他组w表示写，+表示增加权限。整个命令的意思是给其他组的成员增加写权限 40.vima 在光标后插入i 在光标前插入c 替换行，整行删除，在行头插入 41.yum查看包名123456789# 1.查询仓库中所有的rpm包yum list可以配合|grep过滤出想要的rpm包# 2.查看仓库中所有安装包的详细信息yum infoyum info tree# 3.根据命令或文件查找该命令属于哪个rpm包yum provides 命令 42.密码错误日志&#x2F;var&#x2F;log&#x2F;secure 43.sort 文本排序&#x2F;&#x2F;sort排序 默认升序,-r降序 123456789101112131415161718[root@master ~]# cat txtroot:x:0:0:root:/root:/bin/bashbin:x:1:1:bin:/bin:/sbin/nologindaemon:x:2:2:daemon:/sbin:/sbin/nologinadm:x:3:4:adm:/var/adm:/sbin/nologinlp:x:4:7:lp:/var/spool/lpd:/sbin/nologin[root@master ~]# sort txtadm:x:3:4:adm:/var/adm:/sbin/nologinbin:x:1:1:bin:/bin:/sbin/nologindaemon:x:2:2:daemon:/sbin:/sbin/nologinlp:x:4:7:lp:/var/spool/lpd:/sbin/nologinroot:x:0:0:root:/root:/bin/bash[root@master ~]# sort -r txtroot:x:0:0:root:/root:/bin/bashlp:x:4:7:lp:/var/spool/lpd:/sbin/nologindaemon:x:2:2:daemon:/sbin:/sbin/nologinbin:x:1:1:bin:/bin:/sbin/nologinadm:x:3:4:adm:/var/adm:/sbin/nologin 44.netstat命令可以查看系统中启动的端口信息，该命令常用选项123456-a 显示所有端口的信息-n 以数字格式显示端口号-t 显示TCP连接的端口-u 显示UDP连接的端-l 显示服务正在监听的端口信息，如httpd启动后，会监听80端口-p 显示监听端口的服务名称是什么 (也就是程序名称) 45.关闭防火墙123451、命令行界面输入命令“systemctl status firewalld.service”并按下回车键。2、然后在下方可度以查看得到“active（running）”，此时说明防火墙已经被打开了。3、在命令行中输入systemctl stop firewalld.service命令，进行关闭防火墙。4、然后再使用命令systemctl status firewalld.service，在下方出现disavtive（dead），这样就说明防火墙已经关闭。5、再在命令行中输入命令“systemctl disable firewalld.service”命令，即可永久关闭防火墙。 46.less 查看，显示行号12345678910[root@master nginx]# less -N /usr/local/nginx/conf/nginx.conf12 #user nobody;3 worker_processes 1;45 #error_log logs/error.log;6 #error_log logs/error.log notice;7 #error_log logs/error.log info;89 #pid logs/nginx.pid; 47.vim 替换12:86,95s/#//;将86到95行#号替换为空 48.lscpu1234567891011121314151617181920212223242526[root@master conf]# lscpuArchitecture: x86_64CPU op-mode(s): 32-bit, 64-bitByte Order: Little EndianCPU(s): 2On-line CPU(s) list: 0,1Thread(s) per core: 1Core(s) per socket: 2座： 1NUMA 节点： 1厂商 ID： GenuineIntelCPU 系列： 6型号： 70型号名称： Intel(R) Core(TM) i7-4770HQ CPU @ 2.20GHz步进： 1CPU MHz： 2199.776BogoMIPS： 4399.55超管理器厂商： KVM虚拟化类型： 完全L1d 缓存： 32KL1i 缓存： 32KL2 缓存： 256KL3 缓存： 6144KL4 缓存： 131072KNUMA 节点0 CPU： 0,1Flags: fpu vme de 49.kill 不仅仅是杀死进程，也可以暂停和其他， kill 默认就是 15kill -9 &#x3D;&#x3D; kill -killkill -USR1 &#x3D;&#x3D; kill -10kill PID &#x3D; kill -15 PID &#x3D;&#x3D; kill -TERM PID 1234567891011121314[root@master ~]# kill -l 1) SIGHUP 2) SIGINT 3) SIGQUIT 4) SIGILL 5) SIGTRAP 6) SIGABRT 7) SIGBUS 8) SIGFPE 9) SIGKILL 10) SIGUSR111) SIGSEGV 12) SIGUSR2 13) SIGPIPE 14) SIGALRM 15) SIGTERM16) SIGSTKFLT 17) SIGCHLD 18) SIGCONT 19) SIGSTOP 20) SIGTSTP21) SIGTTIN 22) SIGTTOU 23) SIGURG 24) SIGXCPU 25) SIGXFSZ26) SIGVTALRM 27) SIGPROF 28) SIGWINCH 29) SIGIO 30) SIGPWR31) SIGSYS 34) SIGRTMIN 35) SIGRTMIN+1 36) SIGRTMIN+2 37) SIGRTMIN+338) SIGRTMIN+4 39) SIGRTMIN+5 40) SIGRTMIN+6 41) SIGRTMIN+7 42) SIGRTMIN+843) SIGRTMIN+9 44) SIGRTMIN+10 45) SIGRTMIN+11 46) SIGRTMIN+12 47) SIGRTMIN+1348) SIGRTMIN+14 49) SIGRTMIN+15 50) SIGRTMAX-14 51) SIGRTMAX-13 52) SIGRTMAX-1253) SIGRTMAX-11 54) SIGRTMAX-10 55) SIGRTMAX-9 56) SIGRTMAX-8 57) SIGRTMAX-758) SIGRTMAX-6 59) SIGRTMAX-5 60) SIGRTMAX-4 61) SIGRTMAX-3 62) SIGRTMAX-263) SIGRTMAX-1 64) SIGRTMAX 50.yun安装的包，一定可以使用systemctl 管理12345[root@master ~]# cd /usr/lib/systemd/system/[root@master system]# lsabrt-ccpp.service lvm2-lvmpolld.service -.sliceabrtd.service lvm2-lvmpolld.socket slices.targetabrt-oops.service lvm2-monitor.service smartcard.target 12345678910111213141516171819[root@master system]# cat sshd.service[Unit]Description=OpenSSH server daemonDocumentation=man:sshd(8) man:sshd_config(5)After=network.target sshd-keygen.serviceWants=sshd-keygen.service[Service]Type=notifyEnvironmentFile=/etc/sysconfig/sshdExecStart=/usr/sbin/sshd -D $OPTIONSExecReload=/bin/kill -HUP $MAINPIDKillMode=processRestart=on-failureRestartSec=42s[Install]WantedBy=multi-user.target[root@master system]# 51.统计文件行数1[root@master ~]# cat /usr/local/tomcat/conf/server.xml |wc -l 52.# 打开文件，并到第11行去1[root@master ~]# vim +11 /etc/gitweb.conf rpm 命令rpm -ql chrony 显示全部文件 多rpm -qc chrony 显示配置文件 少 123456789101112131415161718192021222324252627[root@master logs]# rpm -ql chrony/etc/NetworkManager/dispatcher.d/20-chrony/etc/chrony.conf/etc/chrony.keys/etc/dhcp/dhclient.d/chrony.sh/etc/logrotate.d/chrony/etc/sysconfig/chronyd/usr/bin/chronyc/usr/lib/systemd/ntp-units.d/50-chronyd.list/usr/lib/systemd/system/chrony-dnssrv@.service/usr/lib/systemd/system/chrony-dnssrv@.timer/usr/lib/systemd/system/chrony-wait.service/usr/lib/systemd/system/chronyd.service/usr/libexec/chrony-helper/usr/sbin/chronyd/usr/share/doc/chrony-3.4/usr/share/doc/chrony-3.4/COPYING/usr/share/doc/chrony-3.4/FAQ/usr/share/doc/chrony-3.4/NEWS/usr/share/doc/chrony-3.4/README/usr/share/man/man1/chronyc.1.gz/usr/share/man/man5/chrony.conf.5.gz/usr/share/man/man8/chronyd.8.gz/var/lib/chrony/var/lib/chrony/drift/var/lib/chrony/rtc/var/log/chrony 12345[root@master logs]# rpm -qc chrony/etc/chrony.conf/etc/chrony.keys/etc/logrotate.d/chrony/etc/sysconfig/chronyd 51.sshkey-免密登录生成 1ssh-keygen 第一种传key方式： 123ssh-copy-id -i /Users/dbbruce/.ssh/id_rsa.pub root@192.168.1.12或者ssh-copy-id -i 192.168.1.12 第二种传key方式：复制 id_rsa.pub 12[root@master .ssh]# cat id_rsa.pubssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQee16pHAr+0R5QGQd9ZRjNWbXTunIWIhzUCFNw1xcAGlSmXIowtkbLwJWCn0QdyA72ZGoW3IdjO06I8Uxk8mg33QZbsCEsNOBG/MFXahH0YNPDYhUDGPUHQOPxRNrYG6lycsgJm0kXy85Q2FVEH3iif5gYHAFQ8f7W8X12amdavN07ER+NBt root@centos-01 把公钥复制到别的机器 12[root@localhost .ssh]# vim authorized_keysssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQee16pHAr+0R5QGQd9ZRjNWbXTunIWIhzUCFNw1xcAGlSmXIowtkbLwJWCn0QdyA72ZGoW3IdjO06I8Uxk8mg33QZbsCEsNOBG/MFXahH0YNPDYhUDGPUHQOPxRNrYG6lycsgJm0kXy85Q2FVEH3iif5gYHAFQ8f7W8X12amdavN07ER+NBt root@centos-01 52.设置主机名1hostnamectl set-hostname centos-01 53.系统命令 ps 进程 uptime cpu 负载 free 内存 ps 交换分区 df -h 磁盘空间 ping 网卡 netstat 或则 ss 端口 ping 通信 traceroute 路由跟踪 iostat 磁盘读写状态 54.查看rpm包内容,已经安装位置 rpm -ql zabbix-release 55.查看包的真名1234[root@master ~]# which mail/usr/bin/mail[root@master ~]# rpm -qf /usr/bin/mailmailx-12.5-19.el7.x86_64 56.端口状态12345678910[root@master ~]# nmap -p 22 192.168.1.22Starting Nmap 6.40 ( http://nmap.org ) at 2023-09-15 03:29 CSTNmap scan report for centos07-22 (192.168.1.22)Host is up (0.00098s latency).PORT STATE SERVICE22/tcp open sshMAC Address: 08:00:27:AB:32:79 (Cadmus Computer Systems)Nmap done: 1 IP address (1 host up) scanned in 2.93 seconds 57.scp传输1scp /etc/zabbix/zabbix_agent2.d/userparameter_login.conf root@192.168.1.32:/etc/zabbix/zabbix_agent2.d/ 58.包大小12[root@master ~]# du -sh php-7.1.1.tar.gz20M php-7.1.1.tar.gz 59.scp传目录1scp -r 2023-09-23_15-16-20 root@192.168.1.22:~^C 60.查看文件唯一id12[root@centos07-01 ~]# ls -i anaconda-ks.cfg33581122 anaconda-ks.cfg 61.yum仓库中查找某个文件属于哪个软件包,yum provides 软件名12345678910111213[root@centos07-01 /]# yum provides telnet已加载插件：fastestmirror, langpacksLoading mirror speeds from cached hostfile * base: mirror.lzu.edu.cn * extras: ftp.sjtu.edu.cn * updates: ftp.sjtu.edu.cn1:telnet-0.17-65.el7_8.x86_64 : The client program for the Telnet remote login protocol源 ：base1:telnet-0.17-66.el7.x86_64 : The client program for the Telnet remote login protocol源 ：updates 62.linux 命令重入，命令2 $(命令1)1234[root@centos07-01 sysctl.d]# ll $(ls *.conf)-rw-r--r--. 1 root root 293 10月 13 2020 00-system.conf-rw-r--r--. 1 root root 1810 10月 2 2020 10-default-yama-scope.conf-rw-r--r--. 1 root root 1285 10月 2 2020 50-default.conf 63.linux 进程pid：echo $$12[root@centos07-01 /]# echo $$1868 64.pstree查看进程关系： pstree -p 显示进程id1234567891011[root@centos07-01 /]# pstree -psystemd(1)─┬─NetworkManager(728)─┬─&#123;NetworkManager&#125;(732) │ └─&#123;NetworkManager&#125;(735) ├─abrt-watch-log(686) ├─abrtd(684) ├─atd(704) ├─auditd(649)───&#123;auditd&#125;(650) ├─containerd(2343)─┬─&#123;containerd&#125;(2345) │ ├─&#123;containerd&#125;(2346) │ ├─&#123;containerd&#125;(2347) │ ├─&#123;containerd&#125;(2348) 65.linux2大派系的区别，redhat(centos)与debian(ubuntu) redhat debian 包扩展名 .rpm .deb yum apt-get rpm dpkg 66.linux版本查看：cat &#x2F;etc&#x2F;redhat-release12[root@centos07-01 ~]# cat /etc/redhat-releaseCentOS Linux release 7.9.2009 (Core) 67.查看软件安装目录：rpm -ql 包名12345678910111213141516/etc/pam.d/sshd/etc/ssh/sshd_config/etc/sysconfig/sshd/usr/lib/systemd/system/sshd-keygen.service/usr/lib/systemd/system/sshd.service/usr/lib/systemd/system/sshd.socket/usr/lib/systemd/system/sshd@.service/usr/lib64/fipscheck/sshd.hmac/usr/libexec/openssh/sftp-server/usr/sbin/sshd/usr/sbin/sshd-keygen/usr/share/man/man5/moduli.5.gz/usr/share/man/man5/sshd_config.5.gz/usr/share/man/man8/sftp-server.8.gz/usr/share/man/man8/sshd.8.gz/var/empty/sshd 68.非交互式修改密码，root下修改1234[root@centos07-12 ~]# echo &quot;a&quot; |passwd --stdin dong1 更改用户 dong1 的密码 。passwd：所有的身份验证令牌已经成功更新 69.linux登录系统显示的名称：ps1\\u 用户名\\h hostname\\w 目录 12[root@0385a0216446 yum.repos.d]# set |grep -i ps1PS1=&#x27;[\\u@\\h \\W]\\$ &#x27; 70. yum启动服务目录：&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;xxx.service1/usr/lib/systemd/system/docker-distribution.service. 71.查看网络配置信息：ip a s1234567891011121314151617181920212223242526[root@centos07-22 busybox]# ip a s1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever inet6 ::1/128 scope host valid_lft forever preferred_lft forever2: enp0s3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 08:00:27:ab:32:79 brd ff:ff:ff:ff:ff:ff inet 192.168.1.22/24 brd 192.168.1.255 scope global noprefixroute enp0s3 valid_lft forever preferred_lft forever inet6 2409:8a00:6035:e890:1bf:c9d7:671d:fdd8/64 scope global noprefixroute dynamic valid_lft 258815sec preferred_lft 172415sec inet6 fe80::885:90eb:3a46:25fa/64 scope link noprefixroute valid_lft forever preferred_lft forever3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default link/ether 02:42:42:d0:db:a0 brd ff:ff:ff:ff:ff:ff inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0 valid_lft forever preferred_lft forever inet6 fe80::42:42ff:fed0:dba0/64 scope link valid_lft forever preferred_lft forever8: br-58644461ac6e: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default link/ether 02:42:a1:f0:fd:bb brd ff:ff:ff:ff:ff:ff inet 10.10.10.1/24 brd 10.10.10.255 scope global br-58644461ac6e valid_lft forever preferred_lft forever 72.Linux lsmod（英文全拼：list modules）命令用于显示已载入系统的模块。模块名称模块的大小（Size）此模块是否被其他模块使用（Used by 123456[root@centos07-22 ~]# lsmodModule Size Used byxt_conntrack 12760 1ipt_MASQUERADE 12678 1nf_nat_masquerade_ipv4 13463 1 ipt_MASQUERADE 73.cat显示行号：cat -n daemon.json74.ls显示单位1234以适当方式显示文件大小，自动转为相关的单位： ls -lh以byte显示文件大小： ls -l以M显示文件大小： ls -l --block-size=m以G显示文件大小： ls -l --block-size=G 75.统计目录文件：du-s参数表示只显示总大小，-h参数表示以人类可读的方式显示大小 1du -sh $(ls) |sort -hr # 查看每个目录的大小，排序从大到小 76.crontab格式表示任何时候都匹配“a,b,c” 表示a 或者 b 或者c 执行命令“a-b” 表示a到b 之间 执行命令“&#x2F;a” 表示每 a分钟(小时等) 执行一次 格式 说明 *&#x2F;1 * * * * service httpd restart 每一分钟 重启httpd服务 0 *&#x2F;1 * * * service httpd restart 每一小时 重启httpd服务 30 21 * * * service httpd restart 每天 21：30 分 重启httpd服务 26 4 1,5,23,28 * * service httpd restart 每月的1号，5号 23 号 28 号 的4点26分，重启httpd服务 26 4 1-21 * * service httpd restart 每月的1号到21号 的4点26分，重启httpd服务 *&#x2F;2 * * * * service httpd restart 每隔两分钟 执行，偶数分钟 重启httpd服务 1-59&#x2F;2 * * * * service httpd restart 每隔两分钟 执行，奇数 重启httpd服务 0 23-7&#x2F;1 * * * service httpd restart 每天的晚上11点到早上7点 每隔一个小时 重启httpd服务 0,30 18-23 * * * service httpd restart 每天18点到23点 每隔30分钟 重启httpd服务 0-59&#x2F;30 18-23 * * * service httpd restart 每天18点到23点 每隔30分钟 重启httpd服务 59 1 1-7 4 * test ‘date +%w’ -eq 0 &amp;&amp; &#x2F;root&#x2F;a.sh 四月的第一个星期日 01:59 分运行脚本 &#x2F;root&#x2F;a.sh ，命令中的 test是判断，%w是数字的星期几 77.centos时区设置1231)date -R #查看时区2)timedatectl list-timezones #列出所有时区3)timedatectl set-timezone Asia/Shanghai #设置系统时区为安徽 78.yum卸载包：yum remove 包名1 包名2 -y1yum remove kubectl kubeadm kubelet -y 78.vim 粘贴模式，能保持文本格式 :set paste + 回车按 i ，进入 （粘贴插入）模式 79、ip个数计算方法192.168.40.0&#x2F;24 &#x3D; 2^(32-24)-2 &#x3D; 254个192.168.0.0&#x2F;16 &#x3D; 2^(32-16)-2 &#x3D; 65534个192.168.0.0&#x2F;12 &#x3D; 2^(32-12)-2 &#x3D; 1048574个 80.查看自动启动 - systemctl list-unit-files12345678[root@centos07-12 ~]# systemctl list-unit-files |grep enabledabrt-ccpp.service enabledabrt-oops.service enabledabrt-vmcore.service enabledabrt-xorg.service enabledabrtd.service enabledatd.service enabledauditd.service enabled 81.linux的tree命令等代1find . -print | sed -e &#x27;s;[^/]*/;|____;g;s;____|; |;g&#x27;","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"02-Docker命名空间","slug":"运维/docker/基础/02-docker命名空间","date":"2021-08-02T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/02/运维/docker/基础/02-docker命名空间/","link":"","permalink":"https://dbbruce.github.io/2021/08/02/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/02-docker%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4/","excerpt":"docker命名空间6大命名空间1234567891011121. Mount (mnt) 这种命名空间隔离的是挂载点。通过这个空间，我们可以在容器中挂载文件系统，而不会影响到主机系统的挂载点，实现了文件系统的隔离。2. Process ID (pid) 这种命名空间隔离了进程 ID。使用这种空间可以将容器内部的进程 ID 隔离开来，从而避免与宿主机的进程 ID 冲突。3. Network (net) 这种命名空间隔离的是网络配置。通过这个空间，我们可以自定义容器的网络配置，而不会影响到宿主机或其他容器的网络配置，实现了网络的隔离。4. Interprocess Communication (ipc) 这种命名空间隔离的是进程间通信。使用这个空间，可以将容器内部的进程间通信隔离，避免与宿主机或其他容器的进程间通信冲突。5. User ID (user) 这种命名空间隔离的是用户 ID。使用这种命名空间可以让容器内部的用户 ID 和宿主机上的用户 ID 隔离开来，从而避免权限问题。6. UTS Namespace (uts) 这种命名空间隔离的是主机的主机名和域名。使用这种空间可以让容器内部有独立的主机名和域名，而不会影响到宿主机的主机名和域名。","text":"docker命名空间6大命名空间1234567891011121. Mount (mnt) 这种命名空间隔离的是挂载点。通过这个空间，我们可以在容器中挂载文件系统，而不会影响到主机系统的挂载点，实现了文件系统的隔离。2. Process ID (pid) 这种命名空间隔离了进程 ID。使用这种空间可以将容器内部的进程 ID 隔离开来，从而避免与宿主机的进程 ID 冲突。3. Network (net) 这种命名空间隔离的是网络配置。通过这个空间，我们可以自定义容器的网络配置，而不会影响到宿主机或其他容器的网络配置，实现了网络的隔离。4. Interprocess Communication (ipc) 这种命名空间隔离的是进程间通信。使用这个空间，可以将容器内部的进程间通信隔离，避免与宿主机或其他容器的进程间通信冲突。5. User ID (user) 这种命名空间隔离的是用户 ID。使用这种命名空间可以让容器内部的用户 ID 和宿主机上的用户 ID 隔离开来，从而避免权限问题。6. UTS Namespace (uts) 这种命名空间隔离的是主机的主机名和域名。使用这种空间可以让容器内部有独立的主机名和域名，而不会影响到宿主机的主机名和域名。","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"docker","slug":"运维/docker","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/"},{"name":"基础","slug":"运维/docker/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"01-tcp、ip协议","slug":"运维/Linux云计算教程/01-tcp、ip协议","date":"2021-08-01T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/01/运维/Linux云计算教程/01-tcp、ip协议/","link":"","permalink":"https://dbbruce.github.io/2021/08/01/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/01-tcp%E3%80%81ip%E5%8D%8F%E8%AE%AE/","excerpt":"1.主机与主机通信三个要素IP地址 ip address ，32位二进制，255.255.255.255 二进制 11111111 &#x3D;&gt; 十进制 255子网掩码 subnet maskIP路由 ip router","text":"1.主机与主机通信三个要素IP地址 ip address ，32位二进制，255.255.255.255 二进制 11111111 &#x3D;&gt; 十进制 255子网掩码 subnet maskIP路由 ip router 2.IP地址分类看第一个就可以，比如192.168.11.1 C类 2.1用于一般计算机网络 A类：1~127 网 + 主 + 主 + 主 B类：128~191 网 + 网 + 主 + 主 C类：192~223 网 + 网 + 网 + 主 2.2组网及科研专业 D类：224~239 组网 E类：240~254 科研 3.IP地址组成：网络位+主机位组成网络位相等于地址，比如010 北京，主机位相当于号码 4.子网掩码标识IP地址的网络位与主机位利用二进制的1标志：网络位利用二进制的0标志：主机位比如： 192.168.1.1 网络位 + 网 + 网 + 主二进制 8个1 + 8个1 + 8个1 + 8个0十进制 255.255.255.0 子网掩码 192.168.1.1 255.255.255.0 &#x3D; 192.168.1.1&#x2F;24 这里24指24个1，也就是 8个1 + 8个1 + 8个1 + 8个0 5.网关地址一个网络到另一个网络的关口（不同网络通信） 6.DNS服务器将域名解析为对应IP地址","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"01-Docker基础","slug":"运维/docker/基础/01-docker基础","date":"2021-08-01T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/01/运维/docker/基础/01-docker基础/","link":"","permalink":"https://dbbruce.github.io/2021/08/01/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/01-docker%E5%9F%BA%E7%A1%80/","excerpt":"docker基础什么是容器 容器技术已经成为应用程序封装和交付的核心技术 容器技术的核心有以下几个内核技术组成Cgroups ( Control Groups )-资源管理，资源限制NameSpace-进程隔离SELinux-安全 由于是在物理机上实施隔离，启动一个容器，可以像启动一个进程一样快速 Docker缺点 容器的隔离性没有虚拟化强 共用Linux内核，安全性有先天缺陷 SELinux难以驾驭 监控容器和容器排错是挑战","text":"docker基础什么是容器 容器技术已经成为应用程序封装和交付的核心技术 容器技术的核心有以下几个内核技术组成Cgroups ( Control Groups )-资源管理，资源限制NameSpace-进程隔离SELinux-安全 由于是在物理机上实施隔离，启动一个容器，可以像启动一个进程一样快速 Docker缺点 容器的隔离性没有虚拟化强 共用Linux内核，安全性有先天缺陷 SELinux难以驾驭 监控容器和容器排错是挑战 Docker安装前准备 需要64位操作系统 至少RHEL6.5以上的版本，强烈推荐RHEL7 关闭防火墙 Docker 包括三个基本概念镜像(image)容器(Container)仓库 (Repository)理解了这三个概念，就理解了 Docker 的整个生命周期 镜像 Docker 把应用程序及其依赖，打包在 image 文件里面。只有通过这个文件才能生成 Docker 容器 image 文件可以看作是容器的模板，除了提供容器运行时所需的程序、库、资还包含了一些为运行时准备的一些配置参数 (如匿名卷源、配置等文件外，环境变量、用户等) Docker 根据 image 文件生成容器的实例。同一个 image 文件，可以生成多个同时运行的容器实例。 镜像不包含任何动态数据，其内容在构建之后也不会被改变 image 是二进制文件。实际开发中，一个 image 文件往往通过继承另一个文件，加上一些个性化设置而生成。举例来说，你可以在 Ubuntu 的image image 基础上，往里面加入 Apache 服务器，形成你的 image。 image 文件是通用的，一台机 器的 image 文件拷贝到另一台机器，照样可以使用。一般来说，为了节省时间，我们应该尽量使用别人制作好的 image 文件而不是自己制作。即使要定制，也应该基于别人的 image 文件进行加工，而不是从零开始制作. 为了方便共享，image 文件制作完成后，可以上传到网上的仓库。Docker 的官方仓库 Docker Hub 是最重要、最常用的 image 仓库。此外，出售自己制作的 image 文件也是可以的。 仓库 镜像构建完成后，可以很容易的在当前宿主机上运行，但是，如果需要在其它服务器上使用这个镜像，我们就需要一个集中的存储、分发镜像的服务Docker Registry 就是这样的服务 一个 Docker Registry 中可以包含多个仓库 (Repository) ; 每个仓库可以包含多个 标签 (Tag);每个标签对应一个镜像 通常，一个仓库会包含同一个软件不同版本的镜像，而标签就常用于对应该软件的冬个版本。我们可以通过&lt;仓库名&gt;:&lt;标签&gt;的格式来指定具体是这个软件哪个版本的镜像。如果不给出标签，将以 latest 作为默认标签 以 Ubuntu 镜像 为例，ubuntu 是仓库的名字，其内包含有不同的版本标签如，16.04,18.04。我们可以通过 ubuntu:16.04，或者 ubuntu:18.04 来具体指定所需哪个版本的镜像。如果忽略了标签，比如 ubuntu，那将视为ubuntu:latest. DockerHub: DockerHub是一个Docker镜像的托管平台。这样的平台称为Docker Registry. 国内也有类似于DockerHub 的公开服务，比如 网易云镜像服务、阿里云镜像库等。 容器 镜像 (image) 和容器 (Container)的关系，就像是面向对象程序设计中的类 和 实例 一样，镜像是静态的定义，容器是镜像运行时的实体。 简单的说，容器是独立运行的一个或一组应用，以及它们的运行态环境，容器可以被创建、启动、停止、删除、暂停等。 容器的实质是进程，但与直接在宿主执行的进程不同，容器进程运行于属于自己的独立的命名空间。因此容器可以拥有自己的 root 文件系统、自己的网络配置、自己的进程空间，甚至自己的用户 ID 空间。 容器内的进程是运行在一个隔离的环境里，使用起来，就好像是在一个独立于宿主的系统下操作一样。这种特性使得容器封装的应用比直接在宿主运行更加安全。 Docker命令 帮助，help或者mandocker help 命令 1docker help search man docker-命令，使用docker-连接命令 1man docker-search 搜索命令，查找镜像docker search mysqlname 镜像名称，下载时需要使用这个名称OFFICIAL 带有ok的是官网镜像，没有ok的就是用户自己做的 1234567[root@centos07-01 /]# docker search busyboxNAME DESCRIPTION STARS OFFICIAL AUTOMATEDbusybox Busybox base image. 3131 [OK]rancher/busybox 0openebs/busybox-client 1antrea/busybox 1hugegraph/busybox test image 2 下载镜像docker pull [OPTIONS] NAME[:TAG|@DIGEST] 1[root@centos07-01 /]# docker pull busybox 查看镜像， REPOSITORY+TAG是唯一镜像docker imagesREPOSITORY 镜像名称TAG 镜像版本 123[root@centos07-01 /]# docker imagesREPOSITORY TAG IMAGE ID CREATED SIZEbusybox latest a416a98b71e2 3 months ago 4.26MB 导出镜像( 将本地镜像导出为tar文件)，备份出来的文件是tar包docker save 名称:标签 -o xxx.tar 12345[root@centos07-01 ~]# docker imagesREPOSITORY TAG IMAGE ID CREATED SIZEbusybox latest a416a98b71e2 3 months ago 4.26MB[root@centos07-01 ~]# docker save busybox:latest -o busybox.tar 导入镜像( 通过tar包文件导入镜像)docker load -i 本地镜像包 12345678910[root@centos07-22 ~]# docker imagesREPOSITORY TAG IMAGE ID CREATED SIZE[root@centos07-22 ~]# docker load -i busybox.tar3d24ee258efc: Loading layer [==================================================&gt;] 4.492MB/4.492MBLoaded image: busybox:latest[root@centos07-22 ~]# docker imagesREPOSITORY TAG IMAGE ID CREATED SIZEbusybox latest a416a98b71e2 3 months ago 4.26MB 启动镜像，生成容器rundocker run -it 名称:版本 [启动的命令] 123456789[root@centos07-22 ~]# docker imagesREPOSITORY TAG IMAGE ID CREATED SIZEredis latest 7f27d60cb8e0 5 days ago 138MBnginx latest c20060033e06 5 days ago 187MBubuntu latest e4c58958181a 4 weeks ago 77.8MBbusybox latest a416a98b71e2 3 months ago 4.26MBcentos latest 5d0da3dc9764 2 years ago 231MB[root@centos07-22 ~]# docker run -it centos:latest /bin/bash 查看容器信息docker ps 123[root@centos07-01 ~]# docker psCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMESb6ebc21363bf nginx:latest &quot;/docker-entrypoint.…&quot; 5 seconds ago Up 4 seconds 80/tcp wizardly_dirac 上传镜像docker push [OPTIONS] NAME[:TAG] 1[root@centos07-22 ~]# docker push busybox:latest 远程启动镜像docker run -it [ docker1:5000 ]&#x2F;镜像名称:镜像版本 1[root@centos07-22 ~]# docker run -it 192.168.1.22:5000/busybox:latest","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"docker","slug":"运维/docker","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/"},{"name":"基础","slug":"运维/docker/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"00-linux目录简介","slug":"运维/Linux云计算教程/00-linux目录简介","date":"2021-08-01T02:00:00.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/01/运维/Linux云计算教程/00-linux目录简介/","link":"","permalink":"https://dbbruce.github.io/2021/08/01/%E8%BF%90%E7%BB%B4/Linux%E4%BA%91%E8%AE%A1%E7%AE%97%E6%95%99%E7%A8%8B/00-linux%E7%9B%AE%E5%BD%95%E7%AE%80%E4%BB%8B/","excerpt":"1.linux&#x2F;boot 存放系统引导必男的文件,包括内核、启动配置&#x2F;bin、&#x2F;sbin 存放各种命令程序&#x2F;dev 存放硬盘、键盘、鼠标、光驱等各种设备文件&#x2F;etc 存放Linux系统及各种程序的配置文件","text":"1.linux&#x2F;boot 存放系统引导必男的文件,包括内核、启动配置&#x2F;bin、&#x2F;sbin 存放各种命令程序&#x2F;dev 存放硬盘、键盘、鼠标、光驱等各种设备文件&#x2F;etc 存放Linux系统及各种程序的配置文件 &#x2F;root、&#x2F;home&#x2F;用户名 分别是管理员root、普通用户的默认家目录&#x2F;var 存放日志文件、邮箱目录等经常变化的文件&#x2F;proc 存放内存中的映射数据,不占用磁盘&#x2F;tmp 存系统运行过程中使用的一些临时文件","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"}],"tags":[]},{"title":"00-Docker开启包转发功能和修改内核参数","slug":"运维/docker/基础/00-docker开启包转发功能和修改内核参数","date":"2021-07-31T18:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/01/运维/docker/基础/00-docker开启包转发功能和修改内核参数/","link":"","permalink":"https://dbbruce.github.io/2021/08/01/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/00-docker%E5%BC%80%E5%90%AF%E5%8C%85%E8%BD%AC%E5%8F%91%E5%8A%9F%E8%83%BD%E5%92%8C%E4%BF%AE%E6%94%B9%E5%86%85%E6%A0%B8%E5%8F%82%E6%95%B0/","excerpt":"docker开启包转发功能和修改内核参数内核参数修改: br_netfilter模块用于将桥接流量转发至 iptables 链，br_netfilter内核参数需要开启转发允许 iptables检查桥接流量为了让你的 Linux 节点上的 iptables 能够正确地查看桥接流量，你需要确保在你的 sysctl 配置中将 net.bridge.bridge-nf-call-iptables 设置为 1; 加载br-netfilter模块1modprobe br_netfilter","text":"docker开启包转发功能和修改内核参数内核参数修改: br_netfilter模块用于将桥接流量转发至 iptables 链，br_netfilter内核参数需要开启转发允许 iptables检查桥接流量为了让你的 Linux 节点上的 iptables 能够正确地查看桥接流量，你需要确保在你的 sysctl 配置中将 net.bridge.bridge-nf-call-iptables 设置为 1; 加载br-netfilter模块1modprobe br_netfilter 查看加载是否成功1234[root@centos07-22 ~]# lsmod | grep br_netfilterbr_netfilter 22256 0bridge 151336 1 br_netfilter 启用IP路由转发功能：12345[root@centos07-22 ~]# cat &gt; /etc/sysctl.d/docker.conf &lt;&lt; EOFnet.bridge.bridge-nf-call-ip6tables = 1net.bridge.bridge-nf-call-iptables = 1net.ipv4.ip_forward=1 EOF 重新加载系统参数1sysctl -p /etc/sysctl.d/docker.conf 查看是否修改成功，如果返回为“net.ipv4.ip_forward &#x3D; 1”则表示成功了12[root@centos07-22 ~]# sysctl net.ipv4.ip_forwardnet.ipv4.ip_forward = 1 重启后加载的br_netfilter模块后失效，开机自动加载模块脚本12345[root@centos07-22 ~]# vim /etc/rc.sysinit#!/bin/bashfor file in /etc/sysconfig/modules/*.modules;do[ -x $file ] &amp;&amp; $filedone 12[root@centos07-22 ~]# vim /etc/sysconfig/modules/br_netfilter.modulesmodprobe br_netfilter 1[root@centos07-22 ~]# chmod 755 /etc/sysconfig/modules/br_netfilter.modules 1systemctl restart docker 配置bridge解决：Docker安装后出错：WARNING:bridge-nf-call-iptables is disabled12net.bridge.bridge-nf-call-ip6tables = 1net.bridge.bridge-nf-call-iptables = 1 配置ip_forward解决的问题：123将Linux系统作为路由或者VPN服务就必须要开启IP转发功能。当linux主机有多个网卡时，一个网卡收到的信息是否能够传递给其他的网卡，如果设置成1的话，可以进行数据包转发，可以实现VxLAN等功能。不开启会导致docker部署应用无法访问。","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"docker","slug":"运维/docker","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/"},{"name":"基础","slug":"运维/docker/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"01-kubernetes注意项","slug":"运维/K8S/错误/01-kubernetes注意项","date":"2021-07-31T16:00:52.000Z","updated":"2023-12-06T01:51:15.000Z","comments":true,"path":"2021/08/01/运维/K8S/错误/01-kubernetes注意项/","link":"","permalink":"https://dbbruce.github.io/2021/08/01/%E8%BF%90%E7%BB%B4/K8S/%E9%94%99%E8%AF%AF/01-kubernetes%E6%B3%A8%E6%84%8F%E9%A1%B9/","excerpt":"","text":"Kubernetes简介1、主机名，不要用带下划线的，有时K8S不能识别带下划线的主机名；2、node有污点，导致pod在各个node上无法创建报错信息：1Warning FailedScheduling 22s default-scheduler 0/3 nodes are available: 1 node(s) had untolerated taint &#123;node-role.kubernetes.io/control-plane: &#125;, 1 node(s) had untolerated taint &#123;node-type: dev&#125;, 1 node(s) had untolerated taint &#123;node-type: prduction&#125;. preemption: 0/3 nodes are available: 3 Preemption is not helpful for scheduling.. 3、有亲和性策略，pod调度不到node上报错信息：1Warning FailedScheduling 4m49s (x3 over 15m) default-scheduler 0/3 nodes are available: 1 node(s) had untolerated taint &#123;node-role.kubernetes.io/control-plane: &#125;, 2 node(s) didn&#x27;t match pod anti-affinity rules. preemption: 0/3 nodes are available: 1 Preemption is not helpful for scheduling, 2 No preemption victims found for incoming pod.. 4、pod存在，由于污点pending状态，再起一个相同pod名的pod，报错信息1The Pod &quot;myapp-deploy&quot; is invalid: spec.tolerations: Forbidden: existing toleration can not be modified except its tolerationSeconds","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"错误","slug":"运维/K8S/错误","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E9%94%99%E8%AF%AF/"}],"tags":[]},{"title":"00-Docker安装","slug":"运维/docker/基础/00-docker安装","date":"2021-07-31T16:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2021/08/01/运维/docker/基础/00-docker安装/","link":"","permalink":"https://dbbruce.github.io/2021/08/01/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/00-docker%E5%AE%89%E8%A3%85/","excerpt":"docker安装镜像仓库1Docker Hub：https://registry.hub.docker.com/ docker官方docker有社区版和企业版两个版本，社区版是免费的，企业版是收费的。其实社区版就够用了 1https://docs.docker.com/ 时间同步服务开启关闭selinux1234567# 修改文件vim /etc/selinux/configSELINUX=disabled# 查看getenforceDisabled","text":"docker安装镜像仓库1Docker Hub：https://registry.hub.docker.com/ docker官方docker有社区版和企业版两个版本，社区版是免费的，企业版是收费的。其实社区版就够用了 1https://docs.docker.com/ 时间同步服务开启关闭selinux1234567# 修改文件vim /etc/selinux/configSELINUX=disabled# 查看getenforceDisabled 关闭防火墙123systemctl stop firewalld.servicesystemctl disable firewalld.service Uninstall old versions（卸载旧版本docker）12345678yum remove docker \\ docker-client \\ docker-client-latest \\ docker-common \\ docker-latest \\ docker-latest-logrotate \\ docker-logrotate \\ docker-engine 安装依赖的包1yum install -y yum-utils device-mapper-persistent-data lvm2 添加阿里软件源信息1yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo 更新yum缓存1yum makecache fast 安装docker-ce1yum -y install docker-ce docker版本123docker -vDocker version 24.0.7, build afdd53b docker开机启动12345 systemctl start docker systemctl enable dockerCreated symlink from /etc/systemd/system/multi-user.target.wants/docker.service to /usr/lib/systemd/system/docker.service. 设置docker国内阿里云加速阿里云地址：https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors 1234567891011 mkdir -p /etc/docker tee /etc/docker/daemon.json &lt;&lt;-&#x27;EOF&#x27;&#123; &quot;registry-mirrors&quot;: [&quot;https://这里填写你的镜像地址.aliyuncs.com&quot;,&quot;https://registry.docker-cn.com&quot;,&quot;https://docker.mirrors.ustc.edu.cn&quot;,&quot;https://dockerhub.azk8s.cn&quot;,&quot;http://hub-mirror.c.163.com&quot;,&quot;http://qtid6917.mirror.aliyuncs.com&quot;,&quot;https://rncxm540.mirror.aliyuncs.com&quot;,&quot;https://e9yneuy4.mirror.aliyuncs.com&quot;]&#125;EOF systemctl daemon-reload systemctl restart docker 其他源： 解释说明：NAME: 镜像仓库源的名称DESCRIPTION: 镜像的描述OFFICIAL: 是否 docker 官方发布stars: 类似 Github 里面的 star，表示点赞、喜欢的意思。AUTOMATED: 自动构建。","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"docker","slug":"运维/docker","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/"},{"name":"基础","slug":"运维/docker/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/"}],"tags":[]},{"title":"监控功能服务器脚本，达到阈值告警","slug":"运维/工作问题处理/监控功能服务器脚本，达到阈值告警","date":"2020-05-05T04:00:52.000Z","updated":"2024-02-18T10:17:08.000Z","comments":true,"path":"2020/05/05/运维/工作问题处理/监控功能服务器脚本，达到阈值告警/","link":"","permalink":"https://dbbruce.github.io/2020/05/05/%E8%BF%90%E7%BB%B4/%E5%B7%A5%E4%BD%9C%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/%E7%9B%91%E6%8E%A7%E5%8A%9F%E8%83%BD%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%84%9A%E6%9C%AC%EF%BC%8C%E8%BE%BE%E5%88%B0%E9%98%88%E5%80%BC%E5%91%8A%E8%AD%A6/","excerpt":"","text":"1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495#!/bin/bashsource /etc/profile#磁盘告警上限值disklimit=85#内存告警上限值memlimit=90#cpu告警上限值cpulimit=95tokenurl=&quot;http://xxx/token&quot;mailurl=&quot;http://xxxx/sendEmail&quot;service=&quot;&quot;arr=(xx@163.com)# 获取系统版本sys_os=`cat /etc/redhat-release|awk &#x27;&#123;print $1 &quot;_&quot;$4&#125;&#x27;`echo &quot;系统版本：&quot;$sys_os# 获取系统内核sys_version=`uname -r`echo &quot;Linux内核版本：&quot;$sys_version # 获取要监控的本地服务器IP地址IP=`ifconfig | grep inet | grep -vE &#x27;inet6|127.0.0.1&#x27; | awk &#x27;&#123;print $2&#125;&#x27;`echo &quot;IP地址：&quot;$IP # 获取cpu总核数cpu_num=`grep -c &quot;model name&quot; /proc/cpuinfo`echo &quot;cpu总核数：&quot;$cpu_num # 获取占用CPU百分比cpu_use=`top -b -n 1 | grep Cpu | awk &#x27;&#123;print $2&#125;&#x27; | cut -f 1 -d &quot;%&quot;`echo &quot;CPU使用百分比：&quot;$cpu_use# 获取空闲CPU百分比cpu_idle=`top -b -n 1 | grep Cpu | awk &#x27;&#123;print $8&#125;&#x27; | cut -f 1 -d &quot;%&quot;`echo &quot;空闲CPU百分比：&quot;$cpu_idlecpuradio=$(awk &#x27;BEGIN&#123;printf &quot;%.2f\\n&quot;,100-&#x27;$cpu_idle&#x27;&#125;&#x27;)echo &quot;CPU使用率:&quot;$cpuradio&quot; %&quot;# 获取物理内存总量mem_total=`free | grep Mem | awk &#x27;&#123;print $2&#125;&#x27;`mem_total_g=$(printf &quot;%.4f&quot; `echo &quot;scale=4;($mem_total/1024/1024)&quot;|bc`)echo &quot;物理内存总量：&quot;$mem_total # 获取操作系统已使用内存总量mem_used=`free | grep Mem | awk &#x27;&#123;print $3&#125;&#x27;`echo &quot;已使用内存总量(操作系统)：&quot;$mem_used# 获取操作系统未使用内存总量mem_free=`free | grep Mem | awk &#x27;&#123;print $4&#125;&#x27;`echo &quot;剩余内存总量(操作系统)：&quot;$mem_freemem_available=`free | grep Mem | awk &#x27;&#123;print $7&#125;&#x27;`echo &quot;可用内存:&quot;$mem_availablememradio=$(printf &quot;%.4f&quot; `echo &quot;scale=4;($mem_used/$mem_total)&quot;|bc`)memradio=$(awk &#x27;BEGIN&#123;printf &quot;%.2f\\n&quot;,&#x27;$memradio&#x27;*100&#125;&#x27;)echo &quot;内存使用率:&quot;$memradio&quot; %&quot;#disk_total=`df / | grep &#x27;/&#x27; | awk &#x27;&#123;print $2&#125;&#x27; `#echo &quot;磁盘总数:&quot;$disk_total#disk_use=`df / | grep &#x27;/&#x27; | awk &#x27;&#123;print $3&#125;&#x27; `#echo &quot;磁盘已使用:&quot;$disk_use#disk_use_rate=`df / | grep &#x27;/&#x27; | awk &#x27;&#123;print $5&#125;&#x27; `#echo &quot;磁盘使用率:&quot;$disk_use_rate DEV=`df -Ph | grep &#x27;^/dev/*&#x27; | cut -d&#x27; &#x27; -f1 | sort`disk_total=0disk_used=0for I in $DEV do dev=`df -h | grep $I | awk &#x27;&#123;print $1&#125;&#x27;` size=`df | grep $I | awk &#x27;&#123;print $2&#125;&#x27;` use=`df |grep $I |awk &#x27;&#123;print $3&#125;&#x27;` disk_total=$(($disk_total+$size)) disk_used=$(($disk_used+$use)) #echo $disk_used #echo -e &quot;$I:\\tsize:$size\\tuse:$use&quot;doneecho &quot;磁盘总数:&quot;$disk_totaldisk_total_g=$(printf &quot;%.4f&quot; `echo &quot;scale=4;($disk_total/1024/1024)&quot;|bc`)echo &quot;磁盘使用量:&quot;$disk_useddsikradio=$(printf &quot;%.4f&quot; `echo &quot;scale=4;($disk_used/$disk_total)&quot;|bc`)dsikradio=$(awk &#x27;BEGIN&#123;printf &quot;%.2f\\n&quot;,&#x27;$dsikradio&#x27;*100&#125;&#x27;)echo &quot;磁盘使用率:&quot;$dsikradio&quot; %&quot;#邮件告警#磁盘告警上限if [ `echo &quot;$dsikradio &gt; $disklimit&quot;|bc` -eq 1 ] || [ `echo &quot;$memradio &gt; $memlimit&quot;|bc` -eq 1 ]thenaddr=`ip a|grep -w &#x27;inet&#x27;|grep &#x27;global&#x27;|sed &#x27;s/^.*inet //g&#x27;|sed &#x27;s/\\/[0-9][0-9].*$//g&#x27;` for i in &quot;$&#123;arr[@]&#125;&quot;; do params=&#x27;&#123;&quot;email&quot;:&quot;&#x27;$i&#x27;&quot;,&quot;theme&quot;:&quot;服务器监控告警异常&quot;,&quot;content&quot;:服务器&#x27;$IP&#x27;磁盘使用率: &#x27;$dsikradio&#x27; %，内存使用率: &#x27;$memradio&#x27; %，cpu使用率: &#x27;$cpuradio&#x27; %,请检查服务是否正常.服务器配置如下：\\n cpu总核数：&#x27;$cpu_num&#x27; 核 \\n 物理内存总量：&#x27;$mem_total_g&#x27; g \\n 磁盘总数: &#x27;$disk_total_g&#x27; g \\n &quot;&#125;&#x27; echo &quot;$params&quot; result=`curl -s -H &quot;Content-Type: application/json&quot; -XPOST -d &#x27;&#123;&quot;client_id&quot;: &quot;imas-monitoryt&quot;, &quot;client_secret&quot;: &quot;rUHib0bAqUOBtPsu&quot;, &quot;grant_type&quot;: &quot;client_credentials&quot;&#125;&#x27; $tokenurl` echo $result &gt; requestresult.txt token=$(cat requestresult.txt | sed &#x27;s/,/\\n/g&#x27; | grep &quot;access_token&quot; | sed &#x27;s/:/\\n/g&#x27; | sed &#x27;1d&#x27; |sed &#x27;1d&#x27; | sed &#x27;s/&#125;//g&#x27; | sed &#x27;s/&quot;//g&#x27; ) curl -XPOST -H &quot;Content-Type: application/json&quot; -H &quot;Authorization: Bearer $&#123;token&#125;&quot; $&#123;mailurl&#125; -d &quot;$params&quot; rm -f requestresult.txt doneelse echo &quot;$IP服务器指标正常&quot;fi","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"问题处理","slug":"运维/问题处理","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/"}],"tags":[]},{"title":"监控流量","slug":"运维/工作问题处理/监控流量","date":"2020-05-05T03:00:52.000Z","updated":"2024-02-18T10:15:39.000Z","comments":true,"path":"2020/05/05/运维/工作问题处理/监控流量/","link":"","permalink":"https://dbbruce.github.io/2020/05/05/%E8%BF%90%E7%BB%B4/%E5%B7%A5%E4%BD%9C%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/%E7%9B%91%E6%8E%A7%E6%B5%81%E9%87%8F/","excerpt":"","text":"123456789101112131415#!/bin/bashTIME=$(date +%s)# 获取接收流量和发送流量RX=$(cat /proc/net/dev | grep eth0 | awk &#x27;&#123;print $2&#125;&#x27;)TX=$(cat /proc/net/dev | grep eth0 | awk &#x27;&#123;print $10&#125;&#x27;)# 计算并转化流量单位为 MbpsRX_MBPS=$(echo &quot;scale=2; $RX/$TIME/1048576*8&quot; | bc)TX_MBPS=$(echo &quot;scale=2; $TX/$TIME/1048576*8&quot; | bc)# 输出流量信息echo &quot;RX: $RX_MBPS Mbps&quot;echo &quot;TX: $TX_MBPS Mbps&quot; 12345678910111213141516171819202122232425262728293031323334353637383940#!/bin/bash# Set variablesTIME=$(date +&quot;%Y-%m-%d %H:%M:%S&quot;)CPU=$(top -bn1 | grep %Cpu | awk &#x27;&#123;print $2&#125;&#x27;)MEMORY=$(free | awk &#x27;/Mem/&#123;printf &quot;%dMB/%dMB(%.2f%%)\\n&quot;, $3/1024,$2/1024,$3/$2*100.0&#125;&#x27;)AVAILABLE_MEMORY=$(free -h | grep Mem: | awk &#x27;&#123;print $7&#125;&#x27;)CURR_ESTAB=$(netstat -an | grep ESTABLISHED | wc -l)TCP_TW=$(netstat -an | grep TIME_WAIT | wc -l)SOCKETS_USED=$(netstat -an | grep -v -e TIME_WAIT -e LISTEN | wc -l)UDP_INUSE=$(netstat -anu | grep -v -e TIME_WAIT | wc -l)TCP_ALLOC=$(cat /proc/sys/net/ipv4/tcp_max_orphans)TCP_INSEGS=$(cat /proc/net/snmp | grep TcpInSegs | awk &#x27;&#123;print $2&#125;&#x27;)TCP_OUTSEGS=$(cat /proc/net/snmp | grep TcpOutSegs | awk &#x27;&#123;print $2&#125;&#x27;)TCP_RETRANSSEGS=$(cat /proc/net/snmp | grep TcpRetransSegs | awk &#x27;&#123;print $2&#125;&#x27;)ONE_UPLOAD=$(uptime | awk &#x27;&#123;print $10&#125;&#x27; | awk -F&#x27;,&#x27; &#x27;&#123;print $1&#125;&#x27;)WU_UPLOAD=$(uptime | awk -F&#x27;,&#x27; &#x27;&#123;print $5&#125;&#x27;)SHIWU_UPLOAD=$(uptime | awk -F&#x27;,&#x27; &#x27;&#123;print $6&#125;&#x27;)# Send message to WeChat robotcurl &#x27;https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=7c39d97e-23b5-4a6f-999d-b594beb14c20&#x27; \\-H &#x27;Content-Type: application/json&#x27; \\-d &quot;&#123; \\&quot;msgtype\\&quot;: \\&quot;text\\&quot;, \\&quot;text\\&quot;: &#123; \\&quot;content\\&quot;: \\&quot;neo4j服务器资源使用情况如下：- 当前时间: $TIME- CPU使用量: $&#123;CPU&#125;%- 内存使用量: $MEMORY- 可用内存为: $AVAILABLE_MEMORY- ESTABLISHED的TCP连接数: $CURR_ESTAB- TIME_WAIT的TCP连接数: $TCP_TW- 当前使用的Socket数: $SOCKETS_USED- 当前使用的UDP连接数: $UDP_INUSE- 系统1分钟负载：$ONE_UPLOAD- 系统5分钟负载：$WU_UPLOAD- 系统15分钟负载：$SHIWU_UPLOAD\\&quot; &#125;&#125;&quot;","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"问题处理","slug":"运维/问题处理","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/"}],"tags":[]},{"title":"日志切割脚本","slug":"运维/工作问题处理/日志切割脚本","date":"2020-05-05T02:00:52.000Z","updated":"2024-02-18T08:41:40.000Z","comments":true,"path":"2020/05/05/运维/工作问题处理/日志切割脚本/","link":"","permalink":"https://dbbruce.github.io/2020/05/05/%E8%BF%90%E7%BB%B4/%E5%B7%A5%E4%BD%9C%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/%E6%97%A5%E5%BF%97%E5%88%87%E5%89%B2%E8%84%9A%E6%9C%AC/","excerpt":"","text":"1234567891011121314151617181920#!/bin/bashLOGFILE=/var/log/app.logBACKUP_DIR=/var/log/backupBACKUP_NUM=10if [ ! -d &quot;$BACKUP_DIR&quot; ]; then mkdir -p &quot;$BACKUP_DIR&quot;fi timestamp=$(date +&quot;%Y%m%d%H%M%S&quot;)backup_file=&quot;$BACKUP_DIR/app_$timestamp.log&quot;mv &quot;$LOGFILE&quot; &quot;$backup_file&quot;touch &quot;$LOGFILE&quot;gzip -f &quot;$backup_file&quot;# 删除旧的备份文件ls -t &quot;$BACKUP_DIR&quot;/*.gz | tail -n +$((BACKUP_NUM + 1)) | | xargs rm -f","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"问题处理","slug":"运维/问题处理","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/"}],"tags":[]},{"title":"备份脚本","slug":"运维/工作问题处理/备份脚本","date":"2020-05-01T03:00:52.000Z","updated":"2024-02-18T08:34:04.000Z","comments":true,"path":"2020/05/01/运维/工作问题处理/备份脚本/","link":"","permalink":"https://dbbruce.github.io/2020/05/01/%E8%BF%90%E7%BB%B4/%E5%B7%A5%E4%BD%9C%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/%E5%A4%87%E4%BB%BD%E8%84%9A%E6%9C%AC/","excerpt":"","text":"1234567891011121314#!/bin/bash# 设置备份目录和文件名backup_dir=&quot;/backup&quot;backup_file=&quot;backup_$(date +%Y%m%d).tar.gz&quot;# 创建备份目录mkdir -p $backup_dir# 执行备份tar -czvf $backup_dir/$backup_file /path/to/backup/files# 输出备份完成信息echo &quot;Backup completed：$backup_dir/$backup_file&quot;","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"问题处理","slug":"运维/问题处理","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/"}],"tags":[]},{"title":"mac安装virtualbox不能上网的问题","slug":"运维/工作问题处理/mac安装virtualbox不能上网的问题","date":"2020-01-10T03:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2020/01/10/运维/工作问题处理/mac安装virtualbox不能上网的问题/","link":"","permalink":"https://dbbruce.github.io/2020/01/10/%E8%BF%90%E7%BB%B4/%E5%B7%A5%E4%BD%9C%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/mac%E5%AE%89%E8%A3%85virtualbox%E4%B8%8D%E8%83%BD%E4%B8%8A%E7%BD%91%E7%9A%84%E9%97%AE%E9%A2%98/","excerpt":"","text":"场景：mac安装virtualbox，windows连外网正常，CentOS不能连外网。解决办法： 1.打开设置 2.将连接方式设置为网络地址转换(NAT) 3.将高级-控制芯片-设置为准虚拟化网络","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"问题处理","slug":"运维/问题处理","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/"}],"tags":[]},{"title":"stress进行压力测试","slug":"运维/常用工具/stress进行压力测试","date":"2020-01-02T03:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2020/01/02/运维/常用工具/stress进行压力测试/","link":"","permalink":"https://dbbruce.github.io/2020/01/02/%E8%BF%90%E7%BB%B4/%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/stress%E8%BF%9B%E8%A1%8C%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/","excerpt":"","text":"stressstress可以用来产生负载，对系统的CPU、内存、磁盘I&#x2F;O等进行压力测试。 安装12[root@centos07-12 ~]# yum install -y epel-release[root@centos07-12 ~]# yum -y install stress 参数 -c, –cpu N 产生 N 个进程，每个进程都反复不停的计算随机数的平方根-i, –io N 产生 N 个进程，每个进程反复调用 sync() 将内存上的内容写到硬盘上-m, –vm N 产生 N 个进程，每个进程不断分配和释放内存–vm-bytes B 指定分配内存的大小–vm-stride B 不断的给部分内存赋值，让 COW(Copy On Write)发生–vm-hang N 指示每个消耗内存的进程在分配到内存后转入睡眠状态 N 秒，然后释放内存，一直重复执行这个过程–vm-keep 一直占用内存，区别于不断的释放和重新分配(默认是不断释放并重新分配内存)-d, –hadd N 产生 N 个不断执行 write 和 unlink 函数的进程(创建文件，写入内容，删除文件)–hadd-bytes B 指定文件大小-t, –timeout N 在 N 秒后结束程序–backoff N 等待N微妙后开始运行-q, –quiet 程序在运行的过程中不输出信息-n, –dry-run 输出程序会做什么而并不实际执行相关的操作–version 显示版本号-v, –verbose 显示详细的信息 CPU测试：并发四个进程持续100秒。增加4个cpu进程，处理sqrt()函数函数，以提高系统CPU负荷 12stress -c 4 -t 100s stress -c 4 -t 2m 内存测试：新增4个io进程，10个内存分配进程，每次分配大小1G，分配后不释放，测试100S1stress -i 4 -vm 10 -vm-bytes 1G -vm-hang 100 -timeout 100s 磁盘I&#x2F;O测试:新增1个写进程，每次写3G文件块1stress -d 1 --hdd-bytes 3G 硬盘测试（不删除）:新增1个IO进程，10个写进程，每次写入3G文件块，且不清除，会逐步将硬盘耗尽。1stress -i 1 -d 10 --hdd-bytes 3G -hdd-noclean 同时进行CPU和内存测试并发14个进程，8个CPU负载，2个内存负载（128M*2），持续10秒。 1stress --cpu 8 --vm 2 --vm-bytes 128M --timeout 10s","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"常用工具","slug":"运维/常用工具","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/"}],"tags":[]},{"title":"ab压力测试","slug":"运维/常用工具/ab压力测试","date":"2020-01-01T03:00:52.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2020/01/01/运维/常用工具/ab压力测试/","link":"","permalink":"https://dbbruce.github.io/2020/01/01/%E8%BF%90%E7%BB%B4/%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/ab%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/","excerpt":"ab 压力测试工具 -c 模拟人数， -c 100，100人访问 -n 模拟总请求数， -c 10 -n 100 ,总请求数100，10个人，每人请求10次","text":"ab 压力测试工具 -c 模拟人数， -c 100，100人访问 -n 模拟总请求数， -c 10 -n 100 ,总请求数100，10个人，每人请求10次 1234567891011121314151617181920212223242526272829303132333435363738394041424344dbbruce@dbburce githubblog % ab -c 10 -n 100 http://192.168.1.12/This is ApacheBench, Version 2.3 &lt;$Revision: 1903618 $&gt;Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/Licensed to The Apache Software Foundation, http://www.apache.org/Benchmarking 192.168.1.12 (be patient).....doneServer Software: nginx/1.22.1Server Hostname: 192.168.1.12Server Port: 80Document Path: /Document Length: 13 bytesConcurrency Level: 10Time taken for tests: 1.437 secondsComplete requests: 100Failed requests: 0Total transferred: 26300 bytesHTML transferred: 1300 bytesRequests per second: 69.61 [#/sec] (mean)Time per request: 143.663 [ms] (mean)Time per request: 14.366 [ms] (mean, across all concurrent requests)Transfer rate: 17.88 [Kbytes/sec] receivedConnection Times (ms) min mean[+/-sd] median maxConnect: 0 8 15.4 2 94Processing: 9 116 69.2 103 346Waiting: 9 114 69.9 100 346Total: 13 124 67.7 107 347Percentage of the requests served within a certain time (ms) 50% 107 66% 154 75% 159 80% 192 90% 202 95% 248 98% 301 99% 347 100% 347 (longest request)dbbruce@dbburce githubblog %","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"常用工具","slug":"运维/常用工具","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/"}],"tags":[]},{"title":"redis数据类型","slug":"redis/06-redis数据类型","date":"2018-02-14T12:30:58.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2018/02/14/redis/06-redis数据类型/","link":"","permalink":"https://dbbruce.github.io/2018/02/14/redis/06-redis%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/","excerpt":"redis数据类型查看1234192.168.1.12:6379&gt; type l2list192.168.1.12:6379&gt; type astring String字符串 set key yalue [ex seconds] [px milliseconds] [nx| xx]设置key及值过期时间可以使用秒或毫秒为单位 数字前是ex时间单位秒，px时间单位是毫秒 1234567# 过期时间10秒 192.168.1.12:6379&gt; set a 10 ex 10OK# 过期时间1000毫秒 192.168.1.12:6379&gt; set b 20 px 1000OK","text":"redis数据类型查看1234192.168.1.12:6379&gt; type l2list192.168.1.12:6379&gt; type astring String字符串 set key yalue [ex seconds] [px milliseconds] [nx| xx]设置key及值过期时间可以使用秒或毫秒为单位 数字前是ex时间单位秒，px时间单位是毫秒 1234567# 过期时间10秒 192.168.1.12:6379&gt; set a 10 ex 10OK# 过期时间1000毫秒 192.168.1.12:6379&gt; set b 20 px 1000OK nx key不存在时，设置值；key存在了，不操作xx key存在修改值；key不存在，不操作 1234567// gg不存在，不操作，返回nil192.168.1.12:6379&gt; set gg 20 xx (nil)// a存在，更新值 192.168.1.12:6379&gt; set a 20 xx OK setrange key offset value从偏移量开始复写key的特定位的值，从offset+1开始替换，字符串第一个位置是0，返回字符串长度 123456789&quot;dongxbinin&quot;192.168.1.12:6379&gt; set name dongxuebinOK192.168.1.12:6379&gt; get name&quot;dongxuebin&quot;192.168.1.12:6379&gt; setrange name 6 &quot;bin&quot;(integer) 10192.168.1.12:6379&gt; get name&quot;dongxubinn&quot; strlen key，统计字串长度1234192.168.1.12:6379&gt; strlen a(integer) 2192.168.1.12:6379&gt; get a&quot;20&quot; append key value存在，则追加；不存在，则创建key及value，返回key长度 123456192.168.1.12:6379&gt; get a&quot;305&quot;192.168.1.12:6379&gt; APPEND a 6(integer) 4192.168.1.12:6379&gt; get a&quot;3056&quot; setbit key offset value位存储：1K&#x3D;1024Byte(字节)；1Byte&#x3D;8bit(位)对key所存储字串，设置或清除特定偏移量上的位(bit)value值可以为1或0，offset为0~2^32之间key不存在，则创建新key123456789//设置bit第0位为1setbit a 0 1//设置bit第1位为1 setbit a 1 1// 统计位存储中1的数量192.168.1.12:6379&gt; bitcount a(integer) 2 decr key将key中的值减1，key不存在则先初始化为0，再减1 12345678192.168.1.12:6379&gt; decr n(integer) -1192.168.1.12:6379&gt; get n&quot;-1&quot;192.168.1.12:6379&gt; decr n(integer) -2192.168.1.12:6379&gt; get n&quot;-2&quot; decrby key decrement将key中的值，减去decrement 123456192.168.1.12:6379&gt; set count 100OK192.168.1.12:6379&gt; decrby count 99(integer) 1192.168.1.12:6379&gt; get count&quot;1&quot; get key返回key存储的字符串值，若key不存在则返回null若key的值不是字串，则返回错误，get只能处理字串 1234192.168.1.12:6379&gt; set a 123OK192.168.1.12:6379&gt; get a&quot;123&quot; getrange key start end返回字串值中的子字串，截取范围为start和end负数偏移量表示从末尾开始计数，-1表示最后一个字符，-2表示倒数第二个字符12345678192.168.1.12:6379&gt; set name dongxuebinOK192.168.1.12:6379&gt; get name&quot;dongxuebin&quot;192.168.1.12:6379&gt; getrange name 4 6&quot;xue&quot;192.168.1.12:6379&gt; getrange name -2 -1&quot;in&quot; incr key将key的值加1，如果key不存在，则初始为0后再加1主要应用为计数器 123456192.168.1.12:6379&gt; set a 100OK192.168.1.12:6379&gt; incr a(integer) 101192.168.1.12:6379&gt; incr a(integer) 102 incrby key increment将key的值增加increment 123456192.168.1.12:6379&gt; set a 10OK192.168.1.12:6379&gt; incrby a 2(integer) 12192.168.1.12:6379&gt; get a&quot;12&quot; mset key1 v1 key2 v2同时给多个key赋值 12192.168.1.12:6379&gt; mset a 1 b 2OK mget key1 key2获取多个key的值 123192.168.1.12:6379&gt; mget a b1) &quot;1&quot;2) &quot;2&quot; List列表 lpush key value [value…]将一个或多个值value插入到列表key的表头Key不存在，则创建key先写入的数据，后出 12192.168.1.12:6379&gt; lpush l2 1 2 3 4 5 6(integer) 6 lrange key start stop从开始位置读取key的值到stop结束先写入的数据，后出 1234567192.168.1.12:6379&gt; lrange l2 0 -11) &quot;6&quot;2) &quot;5&quot;3) &quot;4&quot;4) &quot;3&quot;5) &quot;2&quot;6) &quot;1&quot; lpop key移除并返回列表头元素数据，key不存在则返回nil 12192.168.1.12:6379&gt; lpop l2&quot;6&quot; llen key返回列表key的长度 123456192.168.1.12:6379&gt; llen l2(integer) 3192.168.1.12:6379&gt; lrange l2 0 -11) &quot;3&quot;2) &quot;2&quot;3) &quot;1&quot; lindex key index返回列表中第index个值 123456789101112192.168.1.12:6379&gt; lrange l2 0 -11) &quot;3&quot;2) &quot;2&quot;3) &quot;1&quot;192.168.1.12:6379&gt; lindex l2 0&quot;3&quot;192.168.1.12:6379&gt; lindex l2 1&quot;2&quot;192.168.1.12:6379&gt; lindex l2 2&quot;1&quot;192.168.1.12:6379&gt; lindex l2 12(nil) lset key index value将key中index位置的值修改为value 12192.168.1.12:6379&gt; lset l2 2 4OK rpush key value [value…]将value插入到key的末尾1234567192.168.1.12:6379&gt; rpush l2 4(integer) 4192.168.1.12:6379&gt; lrange l2 0 -11) &quot;3&quot;2) &quot;2&quot;3) &quot;2&quot;4) &quot;4&quot; rpop key删除并返回key末尾的值 1234567891011192.168.1.12:6379&gt; lrange l2 0 -11) &quot;3&quot;2) &quot;2&quot;3) &quot;2&quot;4) &quot;4&quot;192.168.1.12:6379&gt; rpop l2&quot;4&quot;192.168.1.12:6379&gt; lrange l2 0 -11) &quot;3&quot;2) &quot;2&quot;3) &quot;2&quot; Hash表 Hash表简介Redis hash是一个string类型的field和value的映射表- 一个key可对应多个field，一个field对应一个value将一个对象存储为hash类型，较于每个字段都存储成string类型更能节省内存 hset key field value将hash表中field值设置为value 1234192.168.1.12:6379&gt; hset dict1 name dong(integer) 1192.168.1.12:6379&gt; hset dict1 age 22(integer) 1 hget key filed获取hash表中field的值 1234192.168.1.12:6379&gt; hget dict1 name&quot;dong&quot;192.168.1.12:6379&gt; hget dict1 age&quot;22&quot; hmset key field value [field value…]同时给hash表中的多个field赋值 12192.168.1.12:6379&gt; hmset dict1 fname dong sname xuebinOK hmget key field [field…]返回hash装中多个field的值 12345192.168.1.12:6379&gt; hmget dict1 fname sname age name1) &quot;dong&quot;2) &quot;xuebin&quot;3) &quot;22&quot;4) &quot;dong&quot; hkeys key返回hash表中所有field名称 12345192.168.1.12:6379&gt; hkeys dict11) &quot;name&quot;2) &quot;age&quot;3) &quot;fname&quot;4) &quot;sname&quot; hvals key返回hash表中所有filed的值 12345192.168.1.12:6379&gt; hvals dict11) &quot;dong&quot;2) &quot;22&quot;3) &quot;dong&quot;4) &quot;xuebin&quot; hgetall key返回hash表中所有field的值 12345678910192.168.1.12:6379&gt; hgetall dict11) &quot;name&quot;2) &quot;dong&quot;3) &quot;age&quot;4) &quot;22&quot;5) &quot;fname&quot;6) &quot;dong&quot;7) &quot;sname&quot;8) &quot;xuebin&quot;192.168.1.12:6379&gt; hdel key field [field…]删除hash表中多个field的值，不存在则忽略123456789101112131415161718192.168.1.12:6379&gt; hgetall dict11) &quot;name&quot;2) &quot;dong&quot;3) &quot;age&quot;4) &quot;22&quot;5) &quot;fname&quot;6) &quot;dong&quot;7) &quot;sname&quot;8) &quot;xuebin&quot;192.168.1.12:6379&gt; hdel dict1 name(integer) 1192.168.1.12:6379&gt; hgetall dict11) &quot;age&quot;2) &quot;22&quot;3) &quot;fname&quot;4) &quot;dong&quot;5) &quot;sname&quot;6) &quot;xuebin&quot; hexists key field1判断hash表中是否存在field1，0 存在，1不存在1234192.168.1.12:6379&gt; hexists dict1 fname(integer) 1192.168.1.12:6379&gt; hexists dict1 fname2(integer) 0","categories":[{"name":"redis","slug":"redis","permalink":"https://dbbruce.github.io/categories/redis/"}],"tags":[]},{"title":"redis数据持久化","slug":"redis/05-数据持久化","date":"2018-02-13T12:30:58.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2018/02/13/redis/05-数据持久化/","link":"","permalink":"https://dbbruce.github.io/2018/02/13/redis/05-%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96/","excerpt":"注意aof和rdb同时开启时，aof优先1、rdb持久化 Redis数据库文件，全称 Redis DataBase 数据持久化方式之一 数据持久化默认方式 按照指定时间间隔，将内存中的数据集快照写入硬盘 快照术语叫Snapshot 恢复时，将快照文件直接读入内存 定义RDB文件名 - dbfilename “dump.rdb’","text":"注意aof和rdb同时开启时，aof优先1、rdb持久化 Redis数据库文件，全称 Redis DataBase 数据持久化方式之一 数据持久化默认方式 按照指定时间间隔，将内存中的数据集快照写入硬盘 快照术语叫Snapshot 恢复时，将快照文件直接读入内存 定义RDB文件名 - dbfilename “dump.rdb’ 优化设置 数据从内存保存到硬盘的频率123save 900 1 //15分钟且有1个key改变save 300 10 //5分钟且有10个key改变save 60 10000 //1分钟且有10000个key改变 12345[root@centos07-12 ~]# vim /etc/redis.confsave 3600 1save 300 100save 60 10000 手动存盘12- save //阻塞写存盘- bgsave //不阻塞写存盘 数据文件12[root@centos07-12 ~]# ll /root/dump.rdb-rw-r--r--. 1 root root 137 11月 2 23:29 /root/dump.rdb 使用数据文件恢复 停止redis服务123192.168.1.12:6379&gt; keys *(empty array)192.168.1.12:6379&gt; shutdown 将有数据的dump.rdb，放在redis服务的数据目录12[root@centos07-12 ~]# rm -fr dump.rdb[root@centos07-12 ~]# mv dump.rdb2 dump.rdb 启动redis文件，数据恢复123456789[root@centos07-12 ~]# /usr/local/redis/bin/redis-server /etc/redis.conf[root@centos07-12 ~]# /usr/local/redis/bin/redis-cli -h 192.168.1.12 -p 6379192.168.1.12:6379&gt; keys *1) &quot;x&quot;2) &quot;dong&quot;3) &quot;bin&quot;4) &quot;y&quot;5) &quot;xue&quot;6) &quot;z&quot; RDB优点与缺点 RDB优点高性能的持久化实现-创建一个子进程来执行持久化，先将数据写入临时文件，持久化过程结束后，再用这个临时文件替换上次持久化好的文件，过程中主进程不做任何IO操作比较适合大规模数据恢复，且对数据完整性要求不是非常高的场合 RDB的缺点意外宕机时，丢失最后一次持久化的所有数据 2、aof持久化 Append Only File 追加方式记录写操作的文件记录 redis服务所有写操作 不断的将新的写操作，追加到文件的末尾 默认没有启用 使用cat命令可以查看文件内容 启用AOF 启用后，会有一个appendonly.aof文件config set appendonly yes &#x2F;&#x2F;启用 -临时config rewrite &#x2F;&#x2F;写进配置文件 写入配置文件 123456192.168.1.12:6379&gt; config set appendonly yesOK192.168.1.12:6379&gt; config rewriteOK192.168.1.12:6379&gt; mset a 1 b 2 c 3OK 12[root@centos07-12 ~]# ll appendonly.aof-rw-r--r--. 1 root root 234 11月 2 23:52 appendonly.aof 使用aof文件恢复数据 关闭redis123192.168.1.12:6379&gt; keys *(empty array)192.168.1.12:6379&gt; shutdown 复制aof文件1[root@centos07-12 ~]# mv appendonly.aofbak appendonly.aof 启动redis，数据恢复12345[root@centos07-12 ~]# /usr/local/redis/bin/redis-cli -h 192.168.1.12 -p 6379192.168.1.12:6379&gt; keys *1) &quot;a&quot;2) &quot;b&quot;3) &quot;c&quot; 优化配置 定义文件名appendonly yes &#x2F;&#x2F;启用aof ，默认noappendfilename “appendonly.aof” &#x2F;&#x2F;指定文件名 AOF文件记录写操作的方式appendfsync always &#x2F;&#x2F;时时记录，并完成磁盘同步appendfsync everysec &#x2F;&#x2F;每秒记录一次，并完成磁盘同步 # 默认appendfsync no &#x2F;&#x2F;写入aof，不执行磁盘同步 日志文件会不断增大，何时触发日志重写，移除重复auto-aof-rewrite-min-size 64mb &#x2F;&#x2F;首次重写触发值auto-aof-rewrite-percentage 100 &#x2F;&#x2F;再次重写，增长百分比 ，100% 修复AOF文件aof文件有自己的格式，文件改写坏了，把文件恢复到最后一次的正确操作 文件损坏后的报错信息1234567891011[root@centos07-12 ~]# vim appendonly.aof$1^M3^Mdadfad #后加dfadfasdfsd # 后加[root@centos07-12 ~]# /usr/local/redis/bin/redis-server /etc/redis.conf# 连接报错[root@centos07-12 ~]# /usr/local/redis/bin/redis-cli -h 192.168.1.12 -p 6379Could not connect to Redis at 192.168.1.12:6379: Connection refusednot connected&gt; 修复命令:redis-check-aof 123456789101112131415161718192021[root@centos07-12 ~]# /usr/local/redis/bin/redis-check-aof --fix appendonly.aofThe AOF appears to start with an RDB preamble.Checking the RDB preamble to start:[offset 0] Checking RDB file --fix[offset 27] AUX FIELD redis-ver = &#x27;6.2.14&#x27;[offset 41] AUX FIELD redis-bits = &#x27;64&#x27;[offset 53] AUX FIELD ctime = &#x27;1698940251&#x27;[offset 68] AUX FIELD used-mem = &#x27;874248&#x27;[offset 84] AUX FIELD aof-preamble = &#x27;1&#x27;[offset 86] Selecting DB ID 0[offset 137] Checksum OK[offset 137] \\o/ RDB looks OK! \\o/[info] 6 keys read[info] 0 expires[info] 0 already expiredRDB preamble is OK, proceeding with AOF tail...0x ea: Expected prefix &#x27;*&#x27;, got: &#x27;d&#x27;AOF analyzed: size=253, ok_up_to=234, ok_up_to_line=24, diff=19This will shrink the AOF from 253 bytes, with 19 bytes, to 234 bytesContinue? [y/N]: ySuccessfully truncated AOF 修复成功123456[root@centos07-12 ~]# /usr/local/redis/bin/redis-server /etc/redis.conf[root@centos07-12 ~]# /usr/local/redis/bin/redis-cli -h 192.168.1.12 -p 6379192.168.1.12:6379&gt; keys *1) &quot;c&quot;2) &quot;b&quot;3) &quot;a&quot; AOF优点与缺点 AOF优点可以灵活设置持久化方式出现意外宕机时，仅可能丢失1秒的数据 AOF缺点持久化文件的体积通常会大于RDB方式执行fsync策略时的速度可能会比RDB方式慢","categories":[{"name":"redis","slug":"redis","permalink":"https://dbbruce.github.io/categories/redis/"}],"tags":[]},{"title":"redis哨兵服务","slug":"redis/04-redis哨兵服务","date":"2018-02-12T12:30:58.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2018/02/12/redis/04-redis哨兵服务/","link":"","permalink":"https://dbbruce.github.io/2018/02/12/redis/04-redis%E5%93%A8%E5%85%B5%E6%9C%8D%E5%8A%A1/","excerpt":"哨兵服务 redis服务器高可用：哨兵服务 + redis结构：主从从（主 → 从 → 从），实现主服务宕机，自动切换主服务 任何redis结构可以用哨兵，只是主从从更合理写 哨兵服务介绍 监视master服务器 发现master宿机后，将从服务器升级为主服务器 主配置文件 sentinel.conf 模板文件:redis-4.0.8&#x2F;sentinel.conf","text":"哨兵服务 redis服务器高可用：哨兵服务 + redis结构：主从从（主 → 从 → 从），实现主服务宕机，自动切换主服务 任何redis结构可以用哨兵，只是主从从更合理写 哨兵服务介绍 监视master服务器 发现master宿机后，将从服务器升级为主服务器 主配置文件 sentinel.conf 模板文件:redis-4.0.8&#x2F;sentinel.conf 使用结构主 → 从 → 从192.168.1.12 redis主：master192.168.1.22 redis从：12的slave，32的master192.168.1.32 redis从：22的slave192.168.1.42 哨兵服务 12主服务器：无需配置 查看信息123456789101112131415192.168.1.12:6379&gt; info replication# Replicationrole:masterconnected_slaves:1 # 一个slaveslave0:ip=192.168.1.22,port=6379,state=online,offset=561,lag=5 # slave信息master_failover_state:no-failovermaster_replid:f89f55ed5cf8ec74b59d1281224559270600e55emaster_replid2:0000000000000000000000000000000000000000master_repl_offset:561second_repl_offset:-1repl_backlog_active:1repl_backlog_size:1048576repl_backlog_first_byte_offset:1repl_backlog_histlen:561 22从服务器：12的从服务器，32的主服务器 修改配置文件123[root@centos07-22 ~]# vim /etc/redis.confreplicaof 192.168.1.12 6379 重启服务12[root@centos07-22 ~]# /usr/local/redis/bin/redis-cli -h 192.168.1.22 -p 6379 shutdown[root@centos07-22 ~]# /usr/local/redis/bin/redis-server /etc/redis.conf 查看信息123456789101112131415161718192021222324192.168.1.22:6379&gt; info replication# Replicationrole:slavemaster_host:192.168.1.12 # 主服务器信息master_port:6379master_link_status:up # 状态master_last_io_seconds_ago:13master_sync_in_progress:0slave_read_repl_offset:561slave_repl_offset:561slave_priority:100slave_read_only:1replica_announced:1connected_slaves:1 # 有个从服务slave0:ip=192.168.1.32,port=6379,state=online,offset=561,lag=9 # 从服务信息master_failover_state:no-failovermaster_replid:f89f55ed5cf8ec74b59d1281224559270600e55emaster_replid2:0000000000000000000000000000000000000000master_repl_offset:561second_repl_offset:-1repl_backlog_active:1repl_backlog_size:1048576repl_backlog_first_byte_offset:212repl_backlog_histlen:350 32从服务器：22的从服务器 修改配置文件123[root@centos07-32 ~]# vim /etc/redis.confreplicaof 192.168.1.22 6379 重启服务12[root@centos07-32 ~]# /usr/local/redis/bin/redis-cli -h 192.168.1.32 -p 6379 shutdown[root@centos07-32 ~]# /usr/local/redis/bin/redis-server /etc/redis.conf 查看信息1234567891011121314151617181920212223192.168.1.32:6379&gt; info replication# Replicationrole:slavemaster_host:192.168.1.22 # 主服务master_port:6379master_link_status:up # 状态master_last_io_seconds_ago:17master_sync_in_progress:0slave_read_repl_offset:589slave_repl_offset:589slave_priority:100slave_read_only:1replica_announced:1connected_slaves:0master_failover_state:no-failovermaster_replid:f89f55ed5cf8ec74b59d1281224559270600e55emaster_replid2:0000000000000000000000000000000000000000master_repl_offset:589second_repl_offset:-1repl_backlog_active:1repl_backlog_size:1048576repl_backlog_first_byte_offset:324repl_backlog_histlen:266 配置哨兵服务器42 安装redis软件, 参考以前”搭配redis单服务器” 修改哨兵服务的主配置文件语法：sentinel monitor 这里quorummaster-name 监视的主服务器起一个名，只对哨兵配置文件有效quorum 票数，几台哨兵服务器发现，主服务器连不上了，进行切换，我们的试验是1，只有一个哨兵服务 如果有密码，需要修改这里： 1# sentinel auth-pass &lt;master-name&gt; &lt;password&gt; #master-name 我们自己起的名称，后面是密码 创建一个配置文件：&#x2F;etc&#x2F;sentinel.confbind 0.0.0.0port 26379sentinel monitor redis54 192.168.1.12 6354 1 123456# 编辑文件[root@centos7-04 redis-6.2.14]# vim /etc/sentinel.confbind 0.0.0.0port 26379sentinel monitor redis12 192.168.1.12 6379 1 启动哨兵服务1[root@centos7-04 redis-6.2.14]# /usr/local/redis/bin/redis-sentinel /etc/sentinel.conf","categories":[{"name":"redis","slug":"redis","permalink":"https://dbbruce.github.io/categories/redis/"}],"tags":[]},{"title":"redis主从复制","slug":"redis/03-redis主从复制","date":"2018-02-12T10:30:58.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2018/02/12/redis/03-redis主从复制/","link":"","permalink":"https://dbbruce.github.io/2018/02/12/redis/03-redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/","excerpt":"redis主从复制 结构模式一主一从、一主多从、主从从 一主一从、一主多从，从只能读redis默认就是主库，不需要配置 查看复制信息role: &#x2F;&#x2F;角色master_link_status: &#x2F;&#x2F;与主库连接状态master_host: &#x2F;&#x2F;主库ip地址master_port: &#x2F;&#x2F;主库端口号","text":"redis主从复制 结构模式一主一从、一主多从、主从从 一主一从、一主多从，从只能读redis默认就是主库，不需要配置 查看复制信息role: &#x2F;&#x2F;角色master_link_status: &#x2F;&#x2F;与主库连接状态master_host: &#x2F;&#x2F;主库ip地址master_port: &#x2F;&#x2F;主库端口号 1234567891011121314[root@centos07-22 ~]# /usr/local/redis/bin/redis-cli -h 192.168.1.22 -p 6379192.168.1.22:6379&gt; info replication# Replicationrole:master # 主服务connected_slaves:0 # 连接这个master的slave个数master_failover_state:no-failovermaster_replid:95ded4f08b6cdefe1c47759754d524988d4909f1master_replid2:0000000000000000000000000000000000000000master_repl_offset:0second_repl_offset:-1repl_backlog_active:0repl_backlog_size:1048576repl_backlog_first_byte_offset:0repl_backlog_histlen:0 配置从数据库，临时配置，命令行，重启失效 slaveof ip 端口 查看 info replication1234567891011121314151617181920212223242526272829303132[root@centos07-22 ~]# /usr/local/redis/bin/redis-cli -h 192.168.1.22 -p 6379192.168.1.22:6379&gt; slaveof 192.168.1.12 6379OK192.168.1.22:6379&gt; info replication# Replicationrole:slavemaster_host:192.168.1.12master_port:6379master_link_status:down # 这里是down，没有连上，正常应该是upmaster_last_io_seconds_ago:-1master_sync_in_progress:1slave_read_repl_offset:1slave_repl_offset:1master_sync_total_bytes:-1master_sync_read_bytes:0master_sync_left_bytes:-1master_sync_perc:-0.00master_sync_last_io_seconds_ago:8master_link_down_since_seconds:-1slave_priority:100slave_read_only:1replica_announced:1connected_slaves:0master_failover_state:no-failovermaster_replid:95ded4f08b6cdefe1c47759754d524988d4909f1master_replid2:0000000000000000000000000000000000000000master_repl_offset:0second_repl_offset:-1repl_backlog_active:0repl_backlog_size:1048576repl_backlog_first_byte_offset:0repl_backlog_histlen:0 主服务器操作 读1234192.168.1.12:6379&gt; keys *1) &quot;z&quot;2) &quot;y&quot;3) &quot;x&quot; 写12192.168.1.12:6379&gt; mset x 100 y 200 z 300OK 从服务器操作 读1234192.168.1.22:6379&gt; keys *1) &quot;z&quot;2) &quot;y&quot;3) &quot;x&quot; 写12192.168.1.22:6379&gt; mset a 100 b 200(error) READONLY You can&#x27;t write against a read only replica. 配置从数据库，永久配置 修改配置文件,根据版本不同，有的是slaveof，有的是replicaof，自己注意123[root@centos07-22 ~]# vim /etc/redis.confreplicaof 192.168.1.12 6379 重启服务12[root@centos07-22 ~]# /usr/local/redis/bin/redis-cli -h 192.168.1.22 -p 6379 shutdown[root@centos07-22 ~]# /usr/local/redis/bin/redis-server /etc/redis.conf 带验证的一主一从 主服务器设置连接密码1234requirepass 123456[root@centos07-12 ~]# /usr/local/redis/bin/redis-cli -h 192.168.1.12 -p 6379 shutdown[root@centos07-12 ~]# /usr/local/redis/bin/redis-server /etc/redis.conf 从服务器指定连接密码1234[root@centos07-22 ~]# vim /etc/redis.confreplicaof 192.168.1.12 6379 # 主服务masterauth 123456 # 主服务密码 解除临时主从主机1slaveof no one redis主从复制工作原理 slave向master发送sync命令 master启动后台存盘进程，并收集所有修改数据命令 master完成后台存盘后，传送整个数据文件到slave slave接收数据文件，加载到内存中完成首次完全同步 后续有新数据产生时，master继续收集数据修改命令依次传给slave，完成同步","categories":[{"name":"redis","slug":"redis","permalink":"https://dbbruce.github.io/categories/redis/"}],"tags":[]},{"title":"redis集群","slug":"redis/02-redis集群","date":"2018-02-11T12:30:58.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2018/02/11/redis/02-redis集群/","link":"","permalink":"https://dbbruce.github.io/2018/02/11/redis/02-redis%E9%9B%86%E7%BE%A4/","excerpt":"redis分布式存储工作原理set x 123x根据crc16算法获取到一个值，在对16383取余数，余数根据node的数值范围，存入不同的node，注意redis集群会对node分配数字的范围，余数根据数字的范围，就可以存储到特定的node上了","text":"redis分布式存储工作原理set x 123x根据crc16算法获取到一个值，在对16383取余数，余数根据node的数值范围，存入不同的node，注意redis集群会对node分配数字的范围，余数根据数字的范围，就可以存储到特定的node上了 试验配置192.168.1.12 redis192.168.1.22 redis192.168.1.32 redis 特别注意集群，数据必须清空,nodes-6379.conf文件必须删除，重启redis，不做的话redis搭建集群会失败12345[root@centos07-12 ~]# redis-cli -h 192.168.1.12 -p 6379 192.168.1.12:6379&gt; flushdbOK192.168.1.12:6379&gt; keys *(empty array) 123[root@centos07-12 ~]# find / -name nodes-6379.conf/root/nodes-6379.conf[root@centos07-12 ~]# rm -fr /root/nodes-6379.conf redis开启集群功能 ：12，22，32 三台redis 查看是否开启 123456[root@centos07-12 ~]# redis-cli -h 192.168.1.12 -p 6379# disable 没有开启192.168.1.12:6379&gt; cluster infoERR This instance has cluster support disabled192.168.1.12:6379&gt; 开启集群功能 cluster-enabled yes &#x2F;&#x2F;启用集群功能 cluster-config-file nodes-6379.conf &#x2F;&#x2F;存储集群信息文件 cluster-node-timeout 5000 &#x2F;&#x2F;连接超时时间单位毫秒 12345[root@centos07-12 ~]# vim /etc/redis.confcluster-enabled yescluster-config-file nodes-6379.confcluster-node-timeout 5000 # 别设置太长 12345678910111213141516171819[root@centos07-12 ~]# redis-cli -h 192.168.1.12 -p 6379 shutdown[root@centos07-12 ~]# /usr/local/redis/bin/redis-server /etc/redis.confstarting Redis server...[root@centos07-12 ~]# redis-cli -h 192.168.1.12 -p 6379192.168.1.12:6379&gt; cluster infocluster_state:fail # 这里fail是指还没有组建集群cluster_slots_assigned:0cluster_slots_ok:0cluster_slots_pfail:0cluster_slots_fail:0cluster_known_nodes:1cluster_size:0cluster_current_epoch:0cluster_my_epoch:0cluster_stats_messages_sent:0cluster_stats_messages_received:0192.168.1.12:6379&gt; 开启成功会有2个端口123[root@localhost bin]# netstat -lnput |grep redis-servertcp 0 0 192.168.1.22:16379 0.0.0.0:* LISTEN 1608/redis-server 1tcp 0 0 192.168.1.22:6379 0.0.0.0:* LISTEN 1608/redis-server 1 创建集群 创建一个集群1234567891011121314151617181920212223242526272829[root@centos07-12 ~]# redis-cli --cluster create 192.168.1.12:6379 192.168.1.22:6379 192.168.1.32:6379&gt;&gt;&gt; Performing hash slots allocation on 3 nodes...Master[0] -&gt; Slots 0 - 5460Master[1] -&gt; Slots 5461 - 10922Master[2] -&gt; Slots 10923 - 16383M: 395e575ae03b04401936f408276074769837dccf 192.168.1.12:6379 slots:[0-5460] (5461 slots) masterM: 3464e9b15322426431e30f60019c2bdb0d86470a 192.168.1.22:6379 slots:[5461-10922] (5462 slots) masterM: 1f0b0c2fe812f2267ba0d79da3034585cde43243 192.168.1.32:6379 slots:[10923-16383] (5461 slots) masterCan I set the above configuration? (type &#x27;yes&#x27; to accept): yes&gt;&gt;&gt; Nodes configuration updated&gt;&gt;&gt; Assign a different config epoch to each node&gt;&gt;&gt; Sending CLUSTER MEET messages to join the clusterWaiting for the cluster to join.....&gt;&gt;&gt; Performing Cluster Check (using node 192.168.1.12:6379)M: 395e575ae03b04401936f408276074769837dccf 192.168.1.12:6379 slots:[0-5460] (5461 slots) masterM: 1f0b0c2fe812f2267ba0d79da3034585cde43243 192.168.1.32:6379 slots:[10923-16383] (5461 slots) masterM: 3464e9b15322426431e30f60019c2bdb0d86470a 192.168.1.22:6379 slots:[5461-10922] (5462 slots) master[OK] All nodes agree about slots configuration.&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered. 查看集群信息123456[root@centos07-12 ~]# redis-cli --cluster info 192.168.1.12:6379192.168.1.12:6379 (395e575a...) -&gt; 0 keys | 5461 slots | 0 slaves.192.168.1.32:6379 (1f0b0c2f...) -&gt; 0 keys | 5461 slots | 0 slaves.192.168.1.22:6379 (3464e9b1...) -&gt; 0 keys | 5462 slots | 0 slaves.[OK] 0 keys in 3 masters.0.00 keys per slot on average. 查看主redis的从服务是哪个1[root@centos07-12 ~]# redis-cli --cluster check 192.168.1.12:6379 命令行查看123456[root@centos07-12 ~]# redis-cli -h 192.168.1.12 -p 6379192.168.1.12:6379&gt; cluster nodes1f0b0c2fe812f2267ba0d79da3034585cde43243 192.168.1.32:6379@16379 master - 0 1698634711791 3 connected 10923-163833464e9b15322426431e30f60019c2bdb0d86470a 192.168.1.22:6379@16379 master - 0 1698634711793 2 connected 5461-10922395e575ae03b04401936f408276074769837dccf 192.168.1.12:6379@16379 myself,master - 0 0 1 connected 0-5460192.168.1.12:6379&gt; 在客户端访问集群，存取数据 -c代表访问集群: redis-cli -c -h 192.168.1.12 -p 63791234567891011# 通过1.12连接集群，写入数据可能不在1.12，下面的例子写入了1.22dbbruce@dbburce Downloads % redis-cli -c -h 192.168.1.12 -p 6379# 存数据192.168.1.12:6379&gt; set 1 1-&gt; Redirected to slot [9842] located at 192.168.1.22:6379OK# 取数据192.168.1.22:6379&gt; get 1&quot;1&quot; 添加master到集群 添加master主机，不指定角色为master12345678910111213141516# 添加master, 后面的192.168.1.12:6379是现有集群中的任意一台主机就可以[root@centos7-04 ~]# /usr/local/redis/bin/redis-cli --cluster add-node 192.168.1.42:6379 192.168.1.12:6379&gt;&gt;&gt; Adding node 192.168.1.42:6379 to cluster 192.168.1.12:6379&gt;&gt;&gt; Performing Cluster Check (using node 192.168.1.12:6379)M: 395e575ae03b04401936f408276074769837dccf 192.168.1.12:6379 slots:[0-5460] (5461 slots) masterM: 1f0b0c2fe812f2267ba0d79da3034585cde43243 192.168.1.32:6379 slots:[10923-16383] (5461 slots) masterM: 3464e9b15322426431e30f60019c2bdb0d86470a 192.168.1.22:6379 slots:[5461-10922] (5462 slots) master[OK] All nodes agree about slots configuration.&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered.&gt;&gt;&gt; Send CLUSTER MEET to node 192.168.1.42:6379 to make it join the cluster.[OK] New node added correctly. 1234567[root@centos07-12 ~]# redis-cli --cluster info 192.168.1.12:6379192.168.1.12:6379 (395e575a...) -&gt; 0 keys | 5461 slots | 0 slaves.192.168.1.32:6379 (1f0b0c2f...) -&gt; 0 keys | 5461 slots | 0 slaves.192.168.1.22:6379 (3464e9b1...) -&gt; 1 keys | 5462 slots | 0 slaves.192.168.1.42:6379 (0731da4d...) -&gt; 0 keys | 0 slots | 0 slaves. # 新添加的主机没有槽[OK] 1 keys in 4 masters.0.00 keys per slot on average. 需要手动分slots（槽） -移出slots数 ,16384&#x2F;4 &#x3D; 4096 -接收slots的主机 ,写入id，是新加入master主机的id -移出slots的主机，all，全部的主机都移出部分slots1234567891011121314151617181920[root@centos07-12 ~]# redis-cli --cluster reshard 192.168.1.42:6379&gt;&gt;&gt; Performing Cluster Check (using node 192.168.1.42:6379)M: 0731da4d08b31db56641aad0a09792713259ed77 192.168.1.42:6379 slots: (0 slots) masterM: 1f0b0c2fe812f2267ba0d79da3034585cde43243 192.168.1.32:6379 slots:[10923-16383] (5461 slots) masterM: 3464e9b15322426431e30f60019c2bdb0d86470a 192.168.1.22:6379 slots:[5461-10922] (5462 slots) masterM: 395e575ae03b04401936f408276074769837dccf 192.168.1.12:6379 slots:[0-5460] (5461 slots) master[OK] All nodes agree about slots configuration.&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered.How many slots do you want to move (from 1 to 16384)? 4096 # 4096个slotsWhat is the receiving node ID? 0731da4d08b31db56641aad0a09792713259ed77 # master idPlease enter all the source node IDs. Type &#x27;all&#x27; to use all the nodes as source nodes for the hash slots. Type &#x27;done&#x27; once you entered all the source nodes IDs.Source node #1: all # 每个master都让出一些槽 每个master都变成4096了1234567[root@centos07-12 ~]# redis-cli --cluster info 192.168.1.12:6379192.168.1.12:6379 (395e575a...) -&gt; 0 keys | 4096 slots | 0 slaves.192.168.1.32:6379 (1f0b0c2f...) -&gt; 0 keys | 4096 slots | 0 slaves.192.168.1.22:6379 (3464e9b1...) -&gt; 1 keys | 4096 slots | 0 slaves.192.168.1.42:6379 (0731da4d...) -&gt; 0 keys | 4096 slots | 0 slaves.[OK] 1 keys in 4 masters.0.00 keys per slot on average. 添加slave到集群 不指定master服务，slave会自动分配给，slave最少的master12345678910111213141516171819[root@centos7-04 ~]# /usr/local/redis/bin/redis-cli --cluster add-node --cluster-slave 192.168.1.42:6379 192.168.1.12:6379&gt;&gt;&gt; Adding node 192.168.1.42:6379 to cluster 192.168.1.12:6379&gt;&gt;&gt; Performing Cluster Check (using node 192.168.1.12:6379)M: 395e575ae03b04401936f408276074769837dccf 192.168.1.12:6379 slots:[0-5461] (5462 slots) masterM: 1f0b0c2fe812f2267ba0d79da3034585cde43243 192.168.1.32:6379 slots:[10923-16383] (5461 slots) masterM: 3464e9b15322426431e30f60019c2bdb0d86470a 192.168.1.22:6379 slots:[5462-10922] (5461 slots) master[OK] All nodes agree about slots configuration.&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered.Automatically selected master 192.168.1.12:6379&gt;&gt;&gt; Send CLUSTER MEET to node 192.168.1.42:6379 to make it join the cluster.Waiting for the cluster to join.&gt;&gt;&gt; Configure node as replica of 192.168.1.12:6379.[OK] New node added correctly. 123456[root@centos7-04 ~]# /usr/local/redis/bin/redis-cli --cluster info 192.168.1.12:6379192.168.1.12:6379 (395e575a...) -&gt; 0 keys | 5462 slots | 1 slaves.192.168.1.32:6379 (1f0b0c2f...) -&gt; 0 keys | 5461 slots | 0 slaves.192.168.1.22:6379 (3464e9b1...) -&gt; 1 keys | 5461 slots | 0 slaves.[OK] 1 keys in 3 masters.0.00 keys per slot on average. 指定master服务， –master-id id值123456789101112131415161718[root@centos7-04 ~]# /usr/local/redis/bin/redis-cli --cluster add-node --cluster-slave --cluster-master-id 1f0b0c2fe812f2267ba0d79da3034585cde43243 192.168.1.42:6379 192.168.1.12:6379&gt;&gt;&gt; Adding node 192.168.1.42:6379 to cluster 192.168.1.12:6379&gt;&gt;&gt; Performing Cluster Check (using node 192.168.1.12:6379)M: 395e575ae03b04401936f408276074769837dccf 192.168.1.12:6379 slots:[0-5461] (5462 slots) masterM: 1f0b0c2fe812f2267ba0d79da3034585cde43243 192.168.1.32:6379 slots:[10923-16383] (5461 slots) masterM: 3464e9b15322426431e30f60019c2bdb0d86470a 192.168.1.22:6379 slots:[5462-10922] (5461 slots) master[OK] All nodes agree about slots configuration.&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered.&gt;&gt;&gt; Send CLUSTER MEET to node 192.168.1.42:6379 to make it join the cluster.Waiting for the cluster to join.&gt;&gt;&gt; Configure node as replica of 192.168.1.32:6379.[OK] New node added correctly. 123456[root@centos7-04 ~]# /usr/local/redis/bin/redis-cli --cluster info 192.168.1.12:6379192.168.1.12:6379 (395e575a...) -&gt; 0 keys | 5462 slots | 0 slaves.192.168.1.32:6379 (1f0b0c2f...) -&gt; 0 keys | 5461 slots | 1 slaves.192.168.1.22:6379 (3464e9b1...) -&gt; 1 keys | 5461 slots | 0 slaves.[OK] 1 keys in 3 masters.0.00 keys per slot on average. 移出slave 查看slave id123456789101112131415161718192021[root@centos7-04 ~]# /usr/local/redis/bin/redis-cli --cluster check 192.168.1.12:6379192.168.1.12:6379 (395e575a...) -&gt; 0 keys | 5462 slots | 1 slaves.192.168.1.32:6379 (1f0b0c2f...) -&gt; 0 keys | 5461 slots | 0 slaves.192.168.1.22:6379 (3464e9b1...) -&gt; 1 keys | 5461 slots | 0 slaves.[OK] 1 keys in 3 masters.0.00 keys per slot on average.&gt;&gt;&gt; Performing Cluster Check (using node 192.168.1.12:6379)M: 395e575ae03b04401936f408276074769837dccf 192.168.1.12:6379 slots:[0-5461] (5462 slots) master 1 additional replica(s)M: 1f0b0c2fe812f2267ba0d79da3034585cde43243 192.168.1.32:6379 slots:[10923-16383] (5461 slots) masterM: 3464e9b15322426431e30f60019c2bdb0d86470a 192.168.1.22:6379 slots:[5462-10922] (5461 slots) masterS: 0731da4d08b31db56641aad0a09792713259ed77 192.168.1.42:6379 # id slots: (0 slots) slave replicates 395e575ae03b04401936f408276074769837dccf[OK] All nodes agree about slots configuration.&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered. 需要指定移出的集群和要移出的slave id1234567891011[root@centos7-04 ~]# /usr/local/redis/bin/redis-cli --cluster del-node 192.168.1.12:6379 0731da4d08b31db56641aad0a09792713259ed77&gt;&gt;&gt; Removing node 0731da4d08b31db56641aad0a09792713259ed77 from cluster 192.168.1.12:6379&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...&gt;&gt;&gt; Sending CLUSTER RESET SOFT to the deleted node.``````commandline[root@centos7-04 ~]# /usr/local/redis/bin/redis-cli --cluster info 192.168.1.12:6379192.168.1.12:6379 (395e575a...) -&gt; 0 keys | 5462 slots | 0 slaves.192.168.1.32:6379 (1f0b0c2f...) -&gt; 0 keys | 5461 slots | 0 slaves.192.168.1.22:6379 (3464e9b1...) -&gt; 1 keys | 5461 slots | 0 slaves.[OK] 1 keys in 3 masters.0.00 keys per slot on average. 移出master 释放占用的slots123456789101112131415161718192021[root@centos07-12 ~]# redis-cli --cluster reshard 192.168.1.42:6379&gt;&gt;&gt; Performing Cluster Check (using node 192.168.1.42:6379)M: 0731da4d08b31db56641aad0a09792713259ed77 192.168.1.42:6379 slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) masterM: 1f0b0c2fe812f2267ba0d79da3034585cde43243 192.168.1.32:6379 slots:[12288-16383] (4096 slots) masterM: 3464e9b15322426431e30f60019c2bdb0d86470a 192.168.1.22:6379 slots:[6827-10922] (4096 slots) masterM: 395e575ae03b04401936f408276074769837dccf 192.168.1.12:6379 slots:[1365-5460] (4096 slots) master[OK] All nodes agree about slots configuration.&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered.How many slots do you want to move (from 1 to 16384)? 4096 # 移出多少个slotsWhat is the receiving node ID? 1f0b0c2fe812f2267ba0d79da3034585cde43243 # 移给哪个masterPlease enter all the source node IDs. Type &#x27;all&#x27; to use all the nodes as source nodes for the hash slots. Type &#x27;done&#x27; once you entered all the source nodes IDs.Source node #1: 0731da4d08b31db56641aad0a09792713259ed77 # 移出slots的master idSource node #2: done # 其他的没有了 1.42 master的slots清空了1234567[root@centos07-12 ~]# redis-cli --cluster info 192.168.1.12:6379192.168.1.12:6379 (395e575a...) -&gt; 0 keys | 4096 slots | 0 slaves.192.168.1.32:6379 (1f0b0c2f...) -&gt; 0 keys | 8192 slots | 0 slaves.192.168.1.22:6379 (3464e9b1...) -&gt; 1 keys | 4096 slots | 0 slaves.192.168.1.42:6379 (0731da4d...) -&gt; 0 keys | 0 slots | 0 slaves.[OK] 1 keys in 4 masters.0.00 keys per slot on average. 删除master1234[root@centos07-12 ~]# /usr/local/redis/bin/redis-cli --cluster del-node 192.168.1.12:6379 0731da4d08b31db56641aad0a09792713259ed77&gt;&gt;&gt; Removing node 0731da4d08b31db56641aad0a09792713259ed77 from cluster 192.168.1.12:6379&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...&gt;&gt;&gt; Sending CLUSTER RESET SOFT to the deleted node. 123456[root@centos07-12 ~]# redis-cli --cluster info 192.168.1.12:6379192.168.1.12:6379 (395e575a...) -&gt; 0 keys | 4096 slots | 0 slaves.192.168.1.32:6379 (1f0b0c2f...) -&gt; 0 keys | 8192 slots | 0 slaves.192.168.1.22:6379 (3464e9b1...) -&gt; 1 keys | 4096 slots | 0 slaves.[OK] 1 keys in 3 masters.0.00 keys per slot on average. 平均slots个数12345678[root@centos07-12 ~]# redis-cli --cluster rebalance 192.168.1.12:6379&gt;&gt;&gt; Performing Cluster Check (using node 192.168.1.12:6379)[OK] All nodes agree about slots configuration.&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered.&gt;&gt;&gt; Rebalancing across 3 nodes. Total weight = 3.00Moving 1366 slots from 192.168.1.32:6379 to 192.168.1.12:6379 查看结果，slots平均了 123456[root@centos07-12 ~]# redis-cli --cluster info 192.168.1.12:6379192.168.1.12:6379 (395e575a...) -&gt; 0 keys | 5462 slots | 0 slaves.192.168.1.32:6379 (1f0b0c2f...) -&gt; 0 keys | 5461 slots | 0 slaves.192.168.1.22:6379 (3464e9b1...) -&gt; 1 keys | 5461 slots | 0 slaves.[OK] 1 keys in 3 masters.0.00 keys per slot on average. 把移出的redis服务器添加到集群里 查看文件，因为有集群消息导致无法添加12345[root@centos07-42 ~]# cat /root/nodes-6379.conf1f0b0c2fe812f2267ba0d79da3034585cde43243 192.168.1.32:6379@16379 master - 0 1698643776968 5 connected 10923-163833464e9b15322426431e30f60019c2bdb0d86470a 192.168.1.22:6379@16379 master - 0 1698643778255 7 connected 5462-10922395e575ae03b04401936f408276074769837dccf 192.168.1.42:6379@16379 myself,master - 0 0 6 connected 0-5461vars currentEpoch 7 lastVoteEpoch 0 移除集群信息文件，reset集群123456789101112131415161718192021[root@centos7-04 ~]# /usr/local/redis/bin/redis-cli -h 192.168.1.42 -p 6379192.168.1.42:6379&gt; cluster resetOK192.168.1.42:6379&gt; cluster infocluster_state:failcluster_slots_assigned:0cluster_slots_ok:0cluster_slots_pfail:0cluster_slots_fail:0cluster_known_nodes:1cluster_size:0cluster_current_epoch:7cluster_my_epoch:4cluster_stats_messages_ping_sent:3164cluster_stats_messages_pong_sent:14822cluster_stats_messages_meet_sent:3cluster_stats_messages_update_sent:45cluster_stats_messages_sent:18034cluster_stats_messages_ping_received:2534cluster_stats_messages_pong_received:7263cluster_stats_messages_received:9797 再查看文件，没有集群信息了123[root@centos07-42 ~]# cat /root/nodes-6379.conf395e575ae03b04401936f408276074769837dccf 192.168.1.42:6379@16379 myself,master - 0 0 6 connected 0-5461vars currentEpoch 7 lastVoteEpoch 0 查看是否有数据，有数据的话，清空数据， flushall 添加master或者slave，与上面相同 集群解散，还原为单例redis服务器 删除数据123[root@centos07-12 ~]# find / -name nodes-6379.conf/root/nodes-6379.conf[root@centos07-12 ~]# rm -fr /root/nodes-6379.conf 停止服务1/usr/local/redis/bin/redis-cli -h 192.168.1.12 -p 6379 shutdown 禁用集群功能，注释掉配置文件12345[root@centos07-12 ~]# vim /etc/redis.conf#cluster-enabled yes#cluster-config-file nodes-6379.conf#cluster-node-timeout 5000 启动服务1234567[root@centos07-12 ~]# /usr/local/redis/bin/redis-server /etc/redis.conf# 数据清空了[root@centos07-12 ~]# /usr/local/redis/bin/redis-cli -h 192.168.1.12 -p 6379192.168.1.12:6379&gt; keys *(empty array)192.168.1.12:6379&gt; 连接服务，查看集群信息，不支持为成功解除12192.168.1.12:6379&gt; cluster infoERR This instance has cluster support disabled","categories":[{"name":"redis","slug":"redis","permalink":"https://dbbruce.github.io/categories/redis/"}],"tags":[]},{"title":"搭建redis","slug":"redis/01-搭建redis单服务器","date":"2018-02-10T10:30:58.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2018/02/10/redis/01-搭建redis单服务器/","link":"","permalink":"https://dbbruce.github.io/2018/02/10/redis/01-%E6%90%AD%E5%BB%BAredis%E5%8D%95%E6%9C%8D%E5%8A%A1%E5%99%A8/","excerpt":"1.RDBMS-关系数据库管理系统-Relational Database Management System 按照预先设置的组织结构，将数据存储在物理介质上 数据之间可以做关联操作","text":"1.RDBMS-关系数据库管理系统-Relational Database Management System 按照预先设置的组织结构，将数据存储在物理介质上 数据之间可以做关联操作 2.NoSQL( NoSQL &#x3D; Not Only SQL) 意思是“不仅仅是SQL 泛指非关系型数据库 不需要预先定义数据存储结构 每条记录可以有不同的数据类型和字段个数 3.源码编译安装1234567891011[root@master ~]# rpm -q|grep gcc || yum -y install gcc[root@master ~]# tar xvf redis-6.2.14.tar.gz[root@master ~]# cd /root/redis-6.2.14[root@master redis-6.2.14]# make[root@master redis-6.2.14]# make install PREFIX=/usr/local/redis# 将源码包中的conf文件复制到/etc下[root@master redis-6.2.14]# cp redis.conf /etc/redis.conf# 配置文件中daemonize yes， yes执行下面命令后台执行，no时前台执行[root@master redis-6.2.14]# /usr/local/redis/bin/redis-server /etc/redis.conf# 停止[root@centos07-12 ~]# redis-cli shutdown 4.初始配置 源码包里初始化脚本 &#x2F;root&#x2F;redis-6.2.14&#x2F;utils&#x2F;install_server.sh123456端口 6379主配置文件 /etc/redis/6379.conf日志文件 /var/log/redis/6379.log数据库目录 /var/lib/redis/6379服务启动程序 /usr/local/bin/redis-server命令行连接命令 /usr/local/bin/redis-cli 5.执行1[root@master redis]# ./src/redis-server &amp; redis-cliredis-cli默认连接本机的redis服务 12345678[root@master redis]# redis-cli127.0.0.1:6379&gt; pingPONG127.0.0.1:6379&gt; set name bob //存数据OK127.0.0.1:6379&gt; get name //取数据&quot;bob&quot;127.0.0.1:6379&gt; exit //断开连接 redis数据文件dump.rdb 常用命令 set key名 key值 &#x2F;&#x2F;存储1个key值 mset key名列表 &#x2F;&#x2F;存储多个key值 get key名 &#x2F;&#x2F;获取key值 mget &#x2F;&#x2F;获取多个key值 select 数据库编号0-15 &#x2F;&#x2F;切换库 keys * &#x2F;&#x2F;显示所有key名 keys a? &#x2F;&#x2F;显示指定key名 exists key名 &#x2F;&#x2F;测试key名是否存在 ttl key名 &#x2F;&#x2F;查看key生存时间, -1 永不过期 ， -2 已经过期 type key名 &#x2F;&#x2F;查看key类型 move key名 库编号 &#x2F;&#x2F;移动key到指定库 expire key名 数字 &#x2F;&#x2F;设置key有效时间 del key名 &#x2F;&#x2F;删除指定的key flushall &#x2F;&#x2F;删除内存里所有key flushdb &#x2F;&#x2F;删除所在库的所有key save &#x2F;&#x2F;保存所有key到硬盘 shutdown &#x2F;&#x2F;停止服务 配置文件 配置分类 名称 说明 NETWORK 网络 GENERAL 常规 SNAPSHOTTING 快照 REPLICATIONSECURITYCLIENIs 复制 MEMORY MANAGEMENT 安全 数据单位kb和k是有区别的：1k &#x3D;&gt; 10 bytes1kb &#x3D;&gt; 1024 bytes1m &#x3D;&gt; 10001000 bytes1mb &#x3D;&gt; 10241024 bytes1g &#x3D;&gt; 100010001000 bytes1gb &#x3D;&gt; 102410241024 bytes 内存管理 常用配置 port 6379 &#x2F;&#x2F;端口 bing 127.0.0.1 &#x2F;&#x2F;IP地址 daemonize yes &#x2F;&#x2F;守护进程方式运行 databases 16 &#x2F;&#x2F;数据库个数 logfile &#x2F;var&#x2F;log&#x2F;redis 6379.log &#x2F;&#x2F;日志文件 maxclients 10000 &#x2F;&#x2F;并发连接数量 dir &#x2F;var&#x2F;lib&#x2F;redis&#x2F;6379 &#x2F;&#x2F;数据库目录 内存清除策略 volatile-lru &#x2F;&#x2F;最近最少使用 (针对设置了TTL的key) allkeys-lru &#x2F;&#x2F;删除最少使用的key(针对所有的key) allkeys-lfu &#x2F;&#x2F;从所有key中清除使用频率最少的key volatile-lfu &#x2F;&#x2F;从所有配置了过期时间的key中清除使用频率最少的 volatile-random &#x2F;&#x2F;在设置了TTL的key里随机移除 allkeys-random &#x2F;&#x2F;随机移除key volatile-ttl (minor TTL) &#x2F;&#x2F;移除最近过期的key noeviction &#x2F;&#x2F;不删除，写满时报错 优化设置 maxmemory &#x2F;&#x2F;最大内存 maxmemory-policy &#x2F;&#x2F;定义使用策略 maxmemory-samples &#x2F;&#x2F;选取key模板的个数(针对Iru 和 ttl策略 密码连接 远程连接123[root@centos07-12 ~]# vim /etc/redis.confbind 192.168.1.12 12[root@centos07-12 ~]# redis-cli shutdown[root@centos07-12 ~]# redis-cli shutdown 1redis-cli -h 192.168.1.12 -p 6379 设置密码, 设置密码123456123[root@centos07-12 ~]# vim /etc/redis.confrequirepass 123456 交互里输入密码12345678910[root@centos07-12 ~]# redis-cli -h 192.168.1.12 -p 6379 shutdown[root@centos07-12 ~]# redis-server /etc/redis.conf[root@centos07-12 ~]# redis-cli -h 192.168.1.12 -p 6379192.168.1.12:6379&gt; ping(error) NOAUTH Authentication required.192.168.1.12:6379&gt; auth 123456OK192.168.1.12:6379&gt; pingPONG192.168.1.12:6379&gt; exit 使用-a输入密码1234[root@centos07-12 ~]# redis-cli -h 192.168.1.12 -p 6379 -a 123456Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.192.168.1.12:6379&gt; pingPONG 编写一个管理脚本12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152#!/usr/bin/env bashEXEC=/usr/local/redis/bin/redis-serverCLIEXEC=/usr/local/redis/bin/redis-cliPIDFILE=/var/run/redis_6379.pidCONF=/etc/redis.confREDISPORT=6379case &quot;$1&quot; in start) if [ -f $PIDFILE ] then echo &quot;$PIDFILE exists, process is already running or crashed&quot; else echo &quot;starting Redis server...&quot; $EXEC $CONF fi ;; stop) if [ ! -f $PIDFILE ] then echo &quot;$PIDFILE does not exist, process is not running!&quot; else PID=$( cat $PIDFILE) echo &quot;stopping ...&quot; $CLIEXEC -h 192.168.1.12 -p $REDISPORT -a 123456 shutdown while [ -x /proc/$&#123;PID&#125; ] do echo &quot;Waiting for Redis to shutdown ...&quot; sleep 1 done echo &quot;Redis stoppedecho&quot; fi ;; status) PID=$( cat $PIDFILE) if [ ! -x /proc/$&#123;PID&#125; ] then echo &quot;Redis is not running&quot; else echo &quot;Redis is running ($PID)&quot; fi ;; restart) $0 stop $0 start ;; *) echo &quot;please use start, stop, restart or status as first argument&quot; ;;esac","categories":[{"name":"redis","slug":"redis","permalink":"https://dbbruce.github.io/categories/redis/"}],"tags":[]},{"title":"存储引擎","slug":"mysql/存储引擎","date":"2017-02-14T13:00:00.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2017/02/14/mysql/存储引擎/","link":"","permalink":"https://dbbruce.github.io/2017/02/14/mysql/%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/","excerpt":"存储引擎MySQL中的数据用各种不同的技术存储在文件(或者内存)中。每一种技术都使用不同的存储机制、索引技巧、锁定水平并且最终提供广泛的不同的功能和能力。通过选择不同的技术，你能够获得额外的速度或者功能，从而改善你的应用的整体功能。例如，如果你在研究大量的临时数据，你也许需要使用内存MySQL存储引擎。内存存储引擎能够在内存中存储所有的表格数据。又或者，你也许需要一个支持事务处理的数据库(以确保事务处理不成功时数据的回退能力)。 1234567891011121314mysql&gt; show engines;+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+| Engine | Support | Comment | Transactions | XA | Savepoints |+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+| InnoDB | DEFAULT | Supports transactions, row-level locking, and foreign keys | YES | YES | YES || MRG_MYISAM | YES | Collection of identical MyISAM tables | NO | NO | NO || MEMORY | YES | Hash based, stored in memory, useful for temporary tables | NO | NO | NO || BLACKHOLE | YES | /dev/null storage engine (anything you write to it disappears) | NO | NO | NO || MyISAM | YES | MyISAM storage engine | NO | NO | NO || CSV | YES | CSV storage engine | NO | NO | NO || ARCHIVE | YES | Archive storage engine | NO | NO | NO || PERFORMANCE_SCHEMA | YES | Performance Schema | NO | NO | NO || FEDERATED | NO | Federated MySQL storage engine | NULL | NULL | NULL |+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+","text":"存储引擎MySQL中的数据用各种不同的技术存储在文件(或者内存)中。每一种技术都使用不同的存储机制、索引技巧、锁定水平并且最终提供广泛的不同的功能和能力。通过选择不同的技术，你能够获得额外的速度或者功能，从而改善你的应用的整体功能。例如，如果你在研究大量的临时数据，你也许需要使用内存MySQL存储引擎。内存存储引擎能够在内存中存储所有的表格数据。又或者，你也许需要一个支持事务处理的数据库(以确保事务处理不成功时数据的回退能力)。 1234567891011121314mysql&gt; show engines;+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+| Engine | Support | Comment | Transactions | XA | Savepoints |+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+| InnoDB | DEFAULT | Supports transactions, row-level locking, and foreign keys | YES | YES | YES || MRG_MYISAM | YES | Collection of identical MyISAM tables | NO | NO | NO || MEMORY | YES | Hash based, stored in memory, useful for temporary tables | NO | NO | NO || BLACKHOLE | YES | /dev/null storage engine (anything you write to it disappears) | NO | NO | NO || MyISAM | YES | MyISAM storage engine | NO | NO | NO || CSV | YES | CSV storage engine | NO | NO | NO || ARCHIVE | YES | Archive storage engine | NO | NO | NO || PERFORMANCE_SCHEMA | YES | Performance Schema | NO | NO | NO || FEDERATED | NO | Federated MySQL storage engine | NULL | NULL | NULL |+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+ 修改存储引擎1234[root@centos07-12 ~]# vim /etc/my.cnf[mysqld]default-storage-engine= myisam 123456789mysql&gt; show engines;+--------------------+---------+| Engine | Support |+--------------------+---------+| InnoDB | YES || MRG_MYISAM | YES || MEMORY | YES || BLACKHOLE | YES || MyISAM | DEFAULT | 12345678910111213141516171819202122232425mysql&gt; show create table a;+-------+-------------------------------------------------------------------------------------+| Table | Create Table |+-------+-------------------------------------------------------------------------------------+| a | CREATE TABLE `a` ( `id` int(11) DEFAULT NULL) ENGINE=InnoDB DEFAULT CHARSET=utf8 |+-------+-------------------------------------------------------------------------------------+# innodb2个文件mysql&gt; system ls /var/lib/mysql/db9/a*/var/lib/mysql/db9/a.frm /var/lib/mysql/db9/a.ibdmysql&gt; show create table c;+-------+-------------------------------------------------------------------------------------+| Table | Create Table |+-------+-------------------------------------------------------------------------------------+| c | CREATE TABLE `c` ( `id` int(11) DEFAULT NULL) ENGINE=MyISAM DEFAULT CHARSET=utf8 |+-------+-------------------------------------------------------------------------------------+# myisam3个文件mysql&gt; system ls /var/lib/mysql/db9/c*/var/lib/mysql/db9/c.frm /var/lib/mysql/db9/c.MYD /var/lib/mysql/db9/c.MYI myisam存储引擎支持表级锁不支持事务、事务回滚、外键 表文件表名.frm &#x2F;&#x2F;表结构表名.MYI &#x2F;&#x2F;索引表名.MYD &#x2F;&#x2F;数据 innodb存储引擎支持行级锁定支持事务、事务回滚、外键 表文件表名.frm &#x2F;&#x2F;表结构表名.ibd &#x2F;&#x2F;索引+数据 事务日志文件, 记录SQLibdata1ib_logfile0ib_logfile1 MySQL锁机制 锁粒度-表级锁:对整张表加锁-行级锁:仅对被访问的行分别加锁 锁类型-读锁( 共享锁 ): 支持并发读-写锁( 互斥锁、排它锁 ) : 是独占锁，上锁期间其他线程不能读表或写表 查看当前表有没有锁状态 12mysql&gt; show status like &quot;table lock%&quot;;Empty set (0.49 sec) 事务特性(ACID ) Atomic : 原子性事务的整个操作是一个整体，不可分割，要么全部成功，要么全部失败 Consistency :一致性事务操作的前后，表中的记录没有变化 lsolation : 隔离性事务操作是相互隔离不受影响的 Durability :持久性数据一旦提交，不可改变，永久改变表数据 相关命令&#x2F;&#x2F;查看提交状态123456mysql&gt; show variables like &quot;autocommit&quot;;+---------------+-------+| Variable_name | Value |+---------------+-------+| autocommit | ON |+---------------+-------+ &#x2F;&#x2F;关闭自动提交，关闭自动提交需要手动提交，commit12345678910mysql&gt; set autocommit=off;mysql&gt; show variables like &quot;autocommit&quot;;+---------------+-------+| Variable_name | Value |+---------------+-------+| autocommit | OFF |+---------------+-------+mysql&gt; set autocommit=on; &#x2F;&#x2F;数据回滚1mysql&gt; rollback; &#x2F;&#x2F;提交数据1mysql&gt; commit; 模拟事务试验12345678910111213141516171819202122232425262728293031323334353637383940414243444546# 关闭自动提交mysql&gt; set autocommit=off;# insert数据mysql&gt; insert into a values(888);# 插入的终端查询mysql&gt; select * from a;+------+| id |+------+| 1 || 2 || 888 |+------+# 非插入终端查询mysql&gt; select * from db9.a;+------+| id |+------+| 1 || 2 |+------+# 回滚下，插入的终端查询mysql&gt; rollback;mysql&gt; select * from a;+------+| id |+------+| 1 || 2 |+------+# 提交,插入的终端提交，非插入终端查询mysql&gt; insert into a values(888);mysql&gt; commit;mysql&gt; select * from a;+------+| id |+------+| 1 || 2 || 888 |+------+","categories":[{"name":"mysql","slug":"mysql","permalink":"https://dbbruce.github.io/categories/mysql/"}],"tags":[]},{"title":"PXC集群","slug":"mysql/PXC集群","date":"2017-02-13T13:00:00.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2017/02/13/mysql/PXC集群/","link":"","permalink":"https://dbbruce.github.io/2017/02/13/mysql/PXC%E9%9B%86%E7%BE%A4/","excerpt":"PXC(不太稳定)Percona XtraDB Cluster ( 简称PXC )-是基于Galera的mysql高可用集群解决方案-Galera Cluster是Codership公司开发的一套免费开源的高可用方案-PXC集群主要由两部分组成: Percona Server withXtraDB和Write Set Replication patches ( 同步、多主复制插件 )-官网http://galeracluster.com PXC特点数据强一致性、无同步延迟没有主从切换操作，无需使用虚拟IP支持InnoDB存储引擎多线程复制部署使用简单支持节点自动加入，无需手动拷贝数据","text":"PXC(不太稳定)Percona XtraDB Cluster ( 简称PXC )-是基于Galera的mysql高可用集群解决方案-Galera Cluster是Codership公司开发的一套免费开源的高可用方案-PXC集群主要由两部分组成: Percona Server withXtraDB和Write Set Replication patches ( 同步、多主复制插件 )-官网http://galeracluster.com PXC特点数据强一致性、无同步延迟没有主从切换操作，无需使用虚拟IP支持InnoDB存储引擎多线程复制部署使用简单支持节点自动加入，无需手动拷贝数据 PXC的缺点：1）只支持InnoDB引擎；2）写入效率取决于节点中最弱的一台，因为PXC集群采用的是强一致性原则，一个更改操作在所有节点都成功才算执行成功。4）所有表都要有主键；5）不支持LOCK TABLE等显式锁操作；6）锁冲突、死锁问题相对更多； 服务端口 端口 服务 3306 数据库服务端口 4444 SST端口 4567 集群通信端口 4568 IST端口 SST State Snapshot Transfer 全量同步 IST Incremental State Transfer 增量同步 试验配置，不做主从，都是单独的3台服务192.168.1.12 mysql192.168.1.22 mysql192.168.1.32 mysql pxc使用主机名，先配置主机名解析12345vim /etc/hosts192.168.1.12 centos07-12 192.168.1.22 centos07-22 192.168.1.32 centos07-32 PXC是多个软件percona-xtrabackup-24-2.4.131.ei7.x85 64.rpm 在线热备程序qpress-1.1-14.11.x86 64.rpm 递归压缩程序Percona-XtraDB-Cluster-server-57-5.7.25-31.35.1.el7.x86 64.rpm 集群服务程序","categories":[{"name":"mysql","slug":"mysql","permalink":"https://dbbruce.github.io/categories/mysql/"}],"tags":[]},{"title":"MHA集群","slug":"mysql/MHA集群","date":"2017-02-12T13:00:00.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2017/02/12/mysql/MHA集群/","link":"","permalink":"https://dbbruce.github.io/2017/02/12/mysql/MHA%E9%9B%86%E7%BE%A4/","excerpt":"1.MHA ( Master High Availability)1234由日本DeNA公司youshimaton开发是一套优秀的实现MySQL高可用的解决方案数据库的自动故障切换操作能做到在0~30秒之内完成MHA能确保在故障切换过程中最大限度保证数据的一致性，以达到真正意义上的高可用 MHA Manager ( 管理节点 )123管理所有数据库服务器可以单独部署在一台独立的机器上也可以部署在某台数据库服务器上 MHA Node ( 数据节点)12存储数据的MySQL服务器运行在每台MySQL服务器上","text":"1.MHA ( Master High Availability)1234由日本DeNA公司youshimaton开发是一套优秀的实现MySQL高可用的解决方案数据库的自动故障切换操作能做到在0~30秒之内完成MHA能确保在故障切换过程中最大限度保证数据的一致性，以达到真正意义上的高可用 MHA Manager ( 管理节点 )123管理所有数据库服务器可以单独部署在一台独立的机器上也可以部署在某台数据库服务器上 MHA Node ( 数据节点)12存储数据的MySQL服务器运行在每台MySQL服务器上 MHA工作过程12由Manager定时探测集群中的master节点当master故障时，Manager自动将拥有最新数据的slave提升为新的master 试验配置192.168.1.12 mysql 主192.168.1.22 mysql 从192.168.1.32 mysql 从192.168.1.12 MHA管理主机,注意：这里主服务和manger是一台机器，那么ssh-copy-id时，要把公钥给自己下，也就是：ssh-copy-id &#114;&#111;&#x6f;&#x74;&#64;&#x31;&#x39;&#x32;&#46;&#x31;&#54;&#56;&#46;&#x31;&#46;&#x31;&#50;192.168.1.10 客户端192.168.1.100 VIP 2.部署MHA集群 安装perl相关软件1yum -y install perl-* 安装依赖包-perl依赖包下载perl依赖包,可以用下面的地址：1http://www.rpmfind.net/linux/rpm2html/search.php?query=perl-mail-send&amp;submit=Search+…&amp;system=&amp;arch= 依赖的包,依次下载安装1234567perl-Email-Date-Format-1.002-15.el7.noarch.rpmperl-MIME-Types-1.38-2.el7.noarch.rpmperl-MIME-Lite-3.030-1.el7.noarch.rpmperl-Mail-Sendmail-0.79-21.el7.noarch.rpmperl-Mail-Sender-0.8.23-1.el7.noarch.rpmperl-Log-Dispatch-2.41-1.el7.1.noarch.rpmperl-Parallel-ForkManager-1.18-2.el7.noarch.rpm 共享了，在百度云盘1链接:https://pan.baidu.com/s/17lZGPbJDRpedEZ5O0XEHMw 密码:sbau 配置ssh密码对认证登录：1、管理主机可以无密码连接所有数据库；2、数据库之间可以无密码互相连接；12[root@centos07-12 .ssh]# ssh-keygen[root@centos07-12 .ssh]# ssh-copy-id root@192.168.1.22 配置一主多从，192.168.1.12 主，192.168.1.22 从，192.168.1.32 从1参考：https://dbbruce.github.io/2017/02/10/mysql/%E4%B8%80%E4%B8%BB%E5%A4%9A%E4%BB%8E/ 配置管理主机57，既要manager包，也要装node包，必须先装node 安装node1rpm -ivh mha4mysql-node-0.58-0.el7.centos.noarch.rpm 安装manger 下面是缺少依赖，会有missing的显示12345678910[root@centos07-12 mha4mysql-manager-0.58]# perl Makefile.PL*** Module::AutoInstall version 1.06*** Checking for Perl dependencies...[Core Features]- DBI ...loaded. (1.627)- DBD::mysql ...loaded. (4.023)- Time::HiRes ...loaded. (1.9725)- Config::Tiny ...loaded. (2.14)- Log::Dispatch ...missing.- Parallel::ForkManager ...missing. 成功，没有缺少依赖的显示123456789101112131415161718[root@centos07-12 ~]# tar xvf mha4mysql-manager-0.58.tar.gz[root@centos07-12 mha4mysql-manager-0.58]# which perl/usr/bin/perl# 使用perl安装[root@centos07-12 mha4mysql-manager-0.58]# perl Makefile.PL*** Module::AutoInstall version 1.06*** Checking for Perl dependencies...[Core Features]- DBI ...loaded. (1.627) # 注意下面这loaded，如果有miss就是缺少依赖，看上面有安装依赖的方法- DBD::mysql ...loaded. (4.023)- Time::HiRes ...loaded. (1.9725)- Config::Tiny ...loaded. (2.14)- Log::Dispatch ...loaded. (2.41)- Parallel::ForkManager ...loaded. (1.18)- MHA::NodeConst ...loaded. (0.58)*** Module::AutoInstall configuration finished.Writing Makefile for mha4mysql::managerWriting MYMETA.yml and MYMETA.json 12[root@centos07-12 mha4mysql-manager-0.58]# make[root@centos07-12 mha4mysql-manager-0.58]# make install 验证，有下面的命令，说明安装成功123[root@centos07-12 mha4mysql-manager-0.58]# masterha_masterha_check_repl masterha_check_status masterha_manager masterha_master_switch masterha_stopmasterha_check_ssh masterha_conf_host masterha_master_monitor masterha_secondary_check 3.编辑主配置文件 主文件配置模板在源码包里1[root@centos07-12 ~]# cat /root/mha4mysql-manager-0.58/samples/conf/app1.cnf 故障切换的模板1[root@centos07-12 ~]# cat /root/mha4mysql-manager-0.58/samples/scripts/master_ip_failover 添加配置文件123456[root@centos07-12 ~]# mkdir /etc/mha# 拷贝配置文件[root@centos07-12 ~]# cp /root/mha4mysql-manager-0.58/samples/conf/app1.cnf /etc/mha/# 拷贝故障脚本，给执行权限[root@centos07-12 ~]# cp /root/mha4mysql-manager-0.58/samples/scripts/master_ip_failover /etc/mha/[root@centos07-12 ~]# chmod +x /etc/mha/master_ip_failover 123456789101112131415161718192021222324252627282930313233[root@centos07-12 ~]# vim /etc/mha/app1.cnf# 管理端配置[server default]manager_workdir=/etc/mha/manager_log=/etc/mha/manager.log# 故障切换的脚步,自己添加master_ip_failover_script=/etc/mha/master_ip_failover# 下面6行需要自己添加ssh_user=rootssh_port=22repl_user=repluserrepl_password=654321user=root # 这里的root要在所有的主从服务器上都有，必须有全部权限，如果没有使用下面sql授权password=123456# 数据库配置[server1]hostname=192.168.1.12 port=3306 #默认是3306可以不写candidate_master=1 # 1表示，如果master坏了，参加master竞选[server2]hostname=192.168.1.22port=3306candidate_master=1[server3]hostname=192.168.1.32port=3306candidate_master=1 授权，主，从服务器都要123456789mysql&gt; grant all on *.* to root@&quot;%&quot; identified by &quot;123456&quot;;mysql&gt; select user,host from mysql.user;+----------------+-----------+| user | host |+----------------+-----------+| root | % | # 远程权限| root | localhost |+----------------+-----------+ 从服务，添加同步用户，用户主机挂了，从服务变成主服务后需要同步用户12345678910mysql&gt; grant replication slave on *.* to repluser@&quot;%&quot; identified by &quot;654321&quot;;mysql&gt; select user,host from mysql.user;+----------------+-----------+| user | host |+----------------+-----------+| repluser | % || root | % || root | localhost |+----------------+-----------+ 从服务，开启binlog日志文件，禁止自动删除中继文件123456[mysqld]server-id=288# 开启binloglog-bin=master22-dongbinlog_format=mixed 所有服务上，禁止自动删除中继文件1234567[mysqld]server-id=88log-bin=master-dongbinlog_format=mixed# 禁止自动删除中继日志relay_log_purge=0 所有服务上，启用半同步复制123plugin-load=&quot;rpl_semi_sync_master=semisync_master.so;rpl_semi_sync_slave=semisync_slave.so;&quot;rpl_semi_sync_master_enabled=1rpl_semi_sync_slave_enabled=1 最终修改后的样子123456789101112[mysqld]server-id=288log-bin=master22-dongbinlog_format=mixedrelay_log_purge=0validate_password_length=6validate_password_policy=0plugin-load=&quot;rpl_semi_sync_master=semisync_master.so;rpl_semi_sync_slave=semisync_slave.so;&quot;rpl_semi_sync_master_enabled=1rpl_semi_sync_slave_enabled=1 配置修改后重启mysql1[root@centos07-32 mycat]# systemctl restart mysqld 查看主从同步是否正常123456789101112131415161718192021222324# 主服务mysql&gt; show master status \\G;*************************** 1. row *************************** File: master-dong.000007 Position: 154 Binlog_Do_DB: Binlog_Ignore_DB:Executed_Gtid_Set: # 从服务mysql&gt; show slave status \\G;*************************** 1. row *************************** Slave_IO_State: Waiting for master to send event Master_Host: 192.168.1.12 Master_User: repluser Master_Port: 3306 Connect_Retry: 60 Master_Log_File: master-dong.000007 Read_Master_Log_Pos: 154 Relay_Log_File: centos07-22-relay-bin.000008 Relay_Log_Pos: 371 Relay_Master_Log_File: master-dong.000007 Slave_IO_Running: Yes Slave_SQL_Running: Yes 修改故障切换脚本，指定vip地址， 1.100是虚拟IP12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182[root@centos07-12 mha4mysql-manager-0.58]# cat /etc/mha/master_ip_failover#!/usr/bin/env perluse strict;use warnings FATAL =&gt; &#x27;all&#x27;;use Getopt::Long;my ( $command, $ssh_user, $orig_master_host, $orig_master_ip, $orig_master_port, $new_master_host, $new_master_ip, $new_master_port);my $vip = &#x27;192.168.1.100/24&#x27;;my $key = &quot;1&quot;;my $ssh_start_vip = &quot;/sbin/ifconfig enp0s3:$key $vip&quot;;my $ssh_stop_vip = &quot;/sbin/ifconfig enp0s3:$key down&quot;;GetOptions( &#x27;command=s&#x27; =&gt; \\$command, &#x27;ssh_user=s&#x27; =&gt; \\$ssh_user, &#x27;orig_master_host=s&#x27; =&gt; \\$orig_master_host, &#x27;orig_master_ip=s&#x27; =&gt; \\$orig_master_ip, &#x27;orig_master_port=i&#x27; =&gt; \\$orig_master_port, &#x27;new_master_host=s&#x27; =&gt; \\$new_master_host, &#x27;new_master_ip=s&#x27; =&gt; \\$new_master_ip, &#x27;new_master_port=i&#x27; =&gt; \\$new_master_port,);exit &amp;main();sub main &#123; print &quot;\\n\\nIN SCRIPT TEST====$ssh_stop_vip==$ssh_start_vip===\\n\\n&quot;; if ( $command eq &quot;stop&quot; || $command eq &quot;stopssh&quot; ) &#123; my $exit_code = 1; eval &#123; print &quot;Disabling the VIP on old master: $orig_master_host \\n&quot;; &amp;stop_vip(); $exit_code = 0; &#125;; if ($@) &#123; warn &quot;Got Error: $@\\n&quot;; exit $exit_code; &#125; exit $exit_code; &#125; elsif ( $command eq &quot;start&quot; ) &#123; my $exit_code = 10; eval &#123; print &quot;Enabling the VIP - $vip on the new master - $new_master_host \\n&quot;; &amp;start_vip(); $exit_code = 0; &#125;; if ($@) &#123; warn $@; exit $exit_code; &#125; exit $exit_code; &#125; elsif ( $command eq &quot;status&quot; ) &#123; print &quot;Checking the Status of the script.. OK \\n&quot;; `ssh $ssh_user\\@$orig_master_host \\&quot; $ssh_start_vip \\&quot;`; exit 0; &#125; else &#123; &amp;usage(); exit 1; &#125;&#125;sub start_vip() &#123; `ssh $ssh_user\\@$new_master_host \\&quot; $ssh_start_vip \\&quot;`;&#125;sub stop_vip() &#123; `ssh $ssh_user\\@$orig_master_host \\&quot; $ssh_stop_vip \\&quot;`;&#125;sub usage &#123; print &quot;Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\\n&quot;;&#125; 配置主数据vip，192.168.1.100， enp0s3 网卡配置多个ip查看原IP12345678910[root@centos07-12 ~]# ifconfig enp0s3enp0s3: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500 inet 192.168.1.12 netmask 255.255.255.0 broadcast 192.168.1.255 inet6 2409:8a00:603d:4af0:b5bd:a13a:e695:d5a3 prefixlen 64 scopeid 0x0&lt;global&gt; inet6 fe80::f1a3:a1af:6006:3ae6 prefixlen 64 scopeid 0x20&lt;link&gt; ether 08:00:27:79:a3:b8 txqueuelen 1000 (Ethernet) RX packets 238358 bytes 170560391 (162.6 MiB) RX errors 0 dropped 85 overruns 0 frame 0 TX packets 132313 bytes 46270535 (44.1 MiB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 多加一个IP123456789101112131415161718[root@centos07-12 ~]# ifconfig enp0s3:1 192.168.1.100/24[root@centos07-12 ~]# ifconfig enp0s3enp0s3: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500 inet 192.168.1.12 netmask 255.255.255.0 broadcast 192.168.1.255 inet6 2409:8a00:603d:4af0:b5bd:a13a:e695:d5a3 prefixlen 64 scopeid 0x0&lt;global&gt; inet6 fe80::f1a3:a1af:6006:3ae6 prefixlen 64 scopeid 0x20&lt;link&gt; ether 08:00:27:79:a3:b8 txqueuelen 1000 (Ethernet) RX packets 238602 bytes 170579151 (162.6 MiB) RX errors 0 dropped 85 overruns 0 frame 0 TX packets 132464 bytes 46353023 (44.2 MiB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0[root@centos07-12 ~]# ifconfig enp0s3:1enp0s3:1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500 inet 192.168.1.100 netmask 255.255.255.0 broadcast 192.168.1.255 ether 08:00:27:79:a3:b8 txqueuelen 1000 (Ethernet)[root@centos07-12 ~]# 所有的数据库服务上，安装node1234[root@centos07-32 ~]# rpm -ivh mha4mysql-node-0.58-0.el7.centos.noarch.rpm准备中... ################################# [100%]正在升级/安装... 1:mha4mysql-node-0.58-0.el7.centos ################################# [100%] 3.验证 验证ssh，masterha_check_ssh –conf&#x3D;&#x2F;etc&#x2F;mha&#x2F;app1.cnf123456789101112131415161718192021[root@centos07-12 mha4mysql-manager-0.58]# masterha_check_ssh --conf=/etc/mha/app1.cnfThu Oct 26 10:22:08 2023 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.Thu Oct 26 10:22:08 2023 - [info] Reading application default configuration from /etc/mha/app1.cnf..Thu Oct 26 10:22:08 2023 - [info] Reading server configuration from /etc/mha/app1.cnf..Thu Oct 26 10:22:08 2023 - [info] Starting SSH connection tests..Thu Oct 26 10:23:01 2023 - [debug]Thu Oct 26 10:22:20 2023 - [debug] Connecting via SSH from root@192.168.1.32(192.168.1.32:22) to root@192.168.1.12(192.168.1.12:22)..Thu Oct 26 10:22:39 2023 - [debug] ok.Thu Oct 26 10:22:39 2023 - [debug] Connecting via SSH from root@192.168.1.32(192.168.1.32:22) to root@192.168.1.22(192.168.1.22:22)..Thu Oct 26 10:23:00 2023 - [debug] ok.Thu Oct 26 10:23:11 2023 - [debug]Thu Oct 26 10:22:10 2023 - [debug] Connecting via SSH from root@192.168.1.22(192.168.1.22:22) to root@192.168.1.12(192.168.1.12:22)..Thu Oct 26 10:22:40 2023 - [debug] ok.Thu Oct 26 10:22:40 2023 - [debug] Connecting via SSH from root@192.168.1.22(192.168.1.22:22) to root@192.168.1.32(192.168.1.32:22)..Thu Oct 26 10:23:01 2023 - [debug] ok.Thu Oct 26 10:27:44 2023 - [debug]Thu Oct 26 10:22:08 2023 - [debug] Connecting via SSH from root@192.168.1.12(192.168.1.12:22) to root@192.168.1.22(192.168.1.22:22)..Thu Oct 26 10:23:45 2023 - [debug] ok.Thu Oct 26 10:23:45 2023 - [debug] Connecting via SSH from root@192.168.1.12(192.168.1.12:22) to root@192.168.1.32(192.168.1.32:22)..Thu Oct 26 10:27:13 2023 - [debug] ok.Thu Oct 26 10:27:44 2023 - [info] All SSH connection tests passed successfully. 验证数据库是否是，一主多从，masterha_check_repl –conf&#x3D;&#x2F;etc&#x2F;mha&#x2F;app1.cnf1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374[root@centos07-12 mha4mysql-manager-0.58]# masterha_check_repl --conf=/etc/mha/app1.cnfThu Oct 26 12:52:25 2023 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.Thu Oct 26 12:52:25 2023 - [info] Reading application default configuration from /etc/mha/app1.cnf..Thu Oct 26 12:52:25 2023 - [info] Reading server configuration from /etc/mha/app1.cnf..Thu Oct 26 12:52:25 2023 - [info] MHA::MasterMonitor version 0.58.Thu Oct 26 12:52:36 2023 - [info] GTID failover mode = 0Thu Oct 26 12:52:36 2023 - [info] Dead Servers:Thu Oct 26 12:52:36 2023 - [info] Alive Servers:Thu Oct 26 12:52:36 2023 - [info] 192.168.1.12(192.168.1.12:3306)Thu Oct 26 12:52:36 2023 - [info] 192.168.1.22(192.168.1.22:3306)Thu Oct 26 12:52:36 2023 - [info] 192.168.1.32(192.168.1.32:3306)Thu Oct 26 12:52:36 2023 - [info] Alive Slaves:Thu Oct 26 12:52:36 2023 - [info] 192.168.1.22(192.168.1.22:3306) Version=5.7.43-log (oldest major version between slaves) log-bin:enabledThu Oct 26 12:52:36 2023 - [info] Replicating from 192.168.1.12(192.168.1.12:3306)Thu Oct 26 12:52:36 2023 - [info] Primary candidate for the new Master (candidate_master is set)Thu Oct 26 12:52:36 2023 - [info] 192.168.1.32(192.168.1.32:3306) Version=5.7.43-log (oldest major version between slaves) log-bin:enabledThu Oct 26 12:52:36 2023 - [info] Replicating from 192.168.1.12(192.168.1.12:3306)Thu Oct 26 12:52:36 2023 - [info] Primary candidate for the new Master (candidate_master is set)Thu Oct 26 12:52:36 2023 - [info] Current Alive Master: 192.168.1.12(192.168.1.12:3306)Thu Oct 26 12:52:36 2023 - [info] Checking slave configurations..Thu Oct 26 12:52:36 2023 - [info] read_only=1 is not set on slave 192.168.1.22(192.168.1.22:3306).Thu Oct 26 12:52:36 2023 - [info] read_only=1 is not set on slave 192.168.1.32(192.168.1.32:3306).Thu Oct 26 12:52:36 2023 - [info] Checking replication filtering settings..Thu Oct 26 12:52:36 2023 - [info] binlog_do_db= , binlog_ignore_db=Thu Oct 26 12:52:36 2023 - [info] Replication filtering check ok.Thu Oct 26 12:52:36 2023 - [info] GTID (with auto-pos) is not supportedThu Oct 26 12:52:36 2023 - [info] Starting SSH connection tests..Thu Oct 26 12:55:29 2023 - [info] All SSH connection tests passed successfully.Thu Oct 26 12:55:29 2023 - [info] Checking MHA Node version..Thu Oct 26 12:55:58 2023 - [info] Version check ok.Thu Oct 26 12:55:58 2023 - [info] Checking SSH publickey authentication settings on the current master..Thu Oct 26 12:56:28 2023 - [warning] HealthCheck: Got timeout on checking SSH connection to 192.168.1.12! at /root/perl5/lib/perl5/MHA/HealthCheck.pm line 343.Thu Oct 26 12:56:28 2023 - [info] Checking SSH publickey authentication and checking recovery script configurations on all alive slave servers..Thu Oct 26 12:56:28 2023 - [info] Executing command : apply_diff_relay_logs --command=test --slave_user=&#x27;root&#x27; --slave_host=192.168.1.22 --slave_ip=192.168.1.22 --slave_port=3306 --workdir=/var/tmp --target_version=5.7.43-log --manager_version=0.58 --relay_log_info=/var/lib/mysql/relay-log.info --relay_dir=/var/lib/mysql/ --slave_pass=xxxThu Oct 26 12:56:28 2023 - [info] Connecting to root@192.168.1.22(192.168.1.22:22).. Checking slave recovery environment settings.. Opening /var/lib/mysql/relay-log.info ... ok. Relay log found at /var/lib/mysql, up to centos07-22-relay-bin.000034 Temporary relay log file is /var/lib/mysql/centos07-22-relay-bin.000034 Checking if super_read_only is defined and turned on.. not present or turned off, ignoring. Testing mysql connection and privileges..mysql: [Warning] Using a password on the command line interface can be insecure. done. Testing mysqlbinlog output.. done. Cleaning up test file(s).. done.Thu Oct 26 12:56:39 2023 - [info] Executing command : apply_diff_relay_logs --command=test --slave_user=&#x27;root&#x27; --slave_host=192.168.1.32 --slave_ip=192.168.1.32 --slave_port=3306 --workdir=/var/tmp --target_version=5.7.43-log --manager_version=0.58 --relay_log_info=/var/lib/mysql/relay-log.info --relay_dir=/var/lib/mysql/ --slave_pass=xxxThu Oct 26 12:56:39 2023 - [info] Connecting to root@192.168.1.32(192.168.1.32:22).. Checking slave recovery environment settings.. Opening /var/lib/mysql/relay-log.info ... ok. Relay log found at /var/lib/mysql, up to centos07-32-relay-bin.000038 Temporary relay log file is /var/lib/mysql/centos07-32-relay-bin.000038 Checking if super_read_only is defined and turned on.. not present or turned off, ignoring. Testing mysql connection and privileges..mysql: [Warning] Using a password on the command line interface can be insecure. done. Testing mysqlbinlog output.. done. Cleaning up test file(s).. done.Thu Oct 26 12:56:50 2023 - [info] Slaves settings check done.Thu Oct 26 12:56:50 2023 - [info]192.168.1.12(192.168.1.12:3306) (current master) +--192.168.1.22(192.168.1.22:3306) +--192.168.1.32(192.168.1.32:3306)Thu Oct 26 12:56:50 2023 - [info] Checking replication health on 192.168.1.22..Thu Oct 26 12:56:50 2023 - [info] ok.Thu Oct 26 12:56:50 2023 - [info] Checking replication health on 192.168.1.32..Thu Oct 26 12:56:50 2023 - [info] ok.Thu Oct 26 12:56:50 2023 - [info] Checking master_ip_failover_script status:Thu Oct 26 12:56:50 2023 - [info] /etc/mha/master_ip_failover --command=status --ssh_user=root --orig_master_host=192.168.1.12 --orig_master_ip=192.168.1.12 --orig_master_port=3306IN SCRIPT TEST====/sbin/ifconfig enp0s3:1 down==/sbin/ifconfig enp0s3:1 192.168.1.100/24===Checking the Status of the script.. OKThu Oct 26 12:57:35 2023 - [info] OK.Thu Oct 26 12:57:35 2023 - [warning] shutdown_script is not defined.Thu Oct 26 12:57:35 2023 - [info] Got exit code 0 (Not master dead).MySQL Replication Health is OK. 4.启动管理服务 使用 masterha_manager 命令 –remove_dead_master_conf &#x2F;&#x2F;删除宕机主库的配置 –ignore_last_failover &#x2F;&#x2F;忽略xxx.health文件12345[root@centos07-12 ~]# masterha_manager --conf=/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failoverThu Oct 26 13:05:33 2023 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.Thu Oct 26 13:05:33 2023 - [info] Reading application default configuration from /etc/mha/app1.cnf..Thu Oct 26 13:05:33 2023 - [info] Reading server configuration from /etc/mha/app1.cnf.. 查看启动状态12[root@centos07-12 ~]# masterha_check_status --conf=/etc/mha/app1.cnfapp1 (pid:7136) is running(0:PING_OK), master:192.168.1.12 5.测试集群高可用功能 在主库，创建库，表，用户12345678910111213mysql&gt; create database db9;mysql&gt; create table db9.a(id int);mysql&gt; grant select,insert on db9.* to jjyy88@&quot;%&quot; identified by &quot;123456&quot;;mysql&gt; show grants for jjyy88@&quot;%&quot;;+-------------------------------------------------+| Grants for jjyy88@% |+-------------------------------------------------+| GRANT USAGE ON *.* TO &#x27;jjyy88&#x27;@&#x27;%&#x27; || GRANT SELECT, INSERT ON `db9`.* TO &#x27;jjyy88&#x27;@&#x27;%&#x27; |+-------------------------------------------------+ 使用vip访问数据，使用jjyy88连接数据库12345678910111213141516171819202122dbbruce@dbburce Downloads % mysql -h192.168.1.100 -ujjyy88 -p123456mysql&gt; use db9;mysql&gt; show tables;+---------------+| Tables_in_db9 |+---------------+| a |+---------------+mysql&gt; select * from a;Empty set (0.00 sec)mysql&gt; insert into a values(1);mysql&gt; insert into a values(2);mysql&gt; select * from a;+------+| id |+------+| 1 || 2 |+------+ 6.模拟故障，停止主服务，从服务自动变为主，自动拷贝故障脚本 从服务上，先查看主服务1234mysql&gt; show slave status \\G;*************************** 1. row *************************** Slave_IO_State: Waiting for master to send event Master_Host: 192.168.1.12 # 主服务 会自动修改&#x2F;etc&#x2F;mha&#x2F;app1.cnf，会删除主服务的配置； 主服务启动后，就是一台新的服务了 需要同步数据，配置为从服务， 修改mha服务的配置文件，添加新的从服务配置 特点1234MHA必要条件必须是 一主多从结构客户端访问必须连接vip地址且vip地址必须在主数据库服务器上把坏掉的数据库服务器添加到集群里时，必须手动配置数据一致、把服务器添加为当前主服务器的从库、添加到集群里","categories":[{"name":"mysql","slug":"mysql","permalink":"https://dbbruce.github.io/categories/mysql/"}],"tags":[]},{"title":"分库分表","slug":"mysql/mycat分库分表","date":"2017-02-10T13:00:00.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2017/02/10/mysql/mycat分库分表/","link":"","permalink":"https://dbbruce.github.io/2017/02/10/mysql/mycat%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/","excerpt":"1.分库分表 概念将存放在一台数据库服务器中的数据，按照持定方式进行拆分，分散存放到多台数据库服务器中，以达到了分散单台服务器负载的效果 纵向切分将单个数据库的多个表按业务类型分类，分散存储到不同的数据库中 横向切分按照表中指定字段的分片规则，将表记录按行切分分散存储到多个数据库中 试验配置12345192.168.1.12 db1192.168.1.22 db2192.168.1.32 db3192.168.1.32 分片服务器192.168.1.10 客户端 至少需要三个db，否则会报错1INFO | jvm 1 | 2023/10/26 01:37:03 | 2023-10-26 01:37:03,634 [WARN ][WrapperSimpleAppMain] table conf : table [ EMPLOYEE ] rule function [ hash-int ] partition size : 2 &lt; table datanode size : 3 , this cause some datanode to be redundant (io.mycat.config.loader.xml.XMLSchemaLoader:XMLSchemaLoader.java:571)","text":"1.分库分表 概念将存放在一台数据库服务器中的数据，按照持定方式进行拆分，分散存放到多台数据库服务器中，以达到了分散单台服务器负载的效果 纵向切分将单个数据库的多个表按业务类型分类，分散存储到不同的数据库中 横向切分按照表中指定字段的分片规则，将表记录按行切分分散存储到多个数据库中 试验配置12345192.168.1.12 db1192.168.1.22 db2192.168.1.32 db3192.168.1.32 分片服务器192.168.1.10 客户端 至少需要三个db，否则会报错1INFO | jvm 1 | 2023/10/26 01:37:03 | 2023-10-26 01:37:03,634 [WARN ][WrapperSimpleAppMain] table conf : table [ EMPLOYEE ] rule function [ hash-int ] partition size : 2 &lt; table datanode size : 3 , this cause some datanode to be redundant (io.mycat.config.loader.xml.XMLSchemaLoader:XMLSchemaLoader.java:571) 2.mycatmycat 是基于Java的分布式数据库系统中间件，为高并发环境的分布式存储提供解决方案 12345适合数据大量写入的存储需求支持MySQL、Orcle、Sglserver、Mongodb等提供数据读写分离服务提供数据分片服务基于阿里巴巴Cobar进行研发的开源软件 3.工作过程当mycat收到一个SQL命令时 1234解析SQL命令涉及到的表然后看对表的配置，如果有分片规则，则获取SQL命令里分片字段的值，并匹配分片函数，获得分片列表然后将SQL命令发往对应的分片服务器去执行最后收集和处理所有分片结果数据，并返回到客户端 4.mycat支持提供10种分片规则123456789101 枚举法 sharding-by-intfile2 固定分片 rule13 范围约定 auto-sharding-long4 求模法 mod-long5 日期列分区法 sharding-by-date6 通配取模 sharding-by-pattern7 ASCII码求模通配 sharding-by-prefixpattern8 编程指定 sharding-by-substring9 字符串拆分hash解析 sharding-by-stringhash10 一致性hash sharding-by-murmur 5.拓扑结构 6.配置mycat服务器 下载路径1http://dl.mycat.org.cn/1.6-RELEASE/Mycat-server-1.6-RELEASE-20161028204710-linux.tar.gz 安装依赖，java12345yum -y install java-1.8.0-openjdkjava -versionopenjdk version &quot;1.8.0_382&quot;OpenJDK Runtime Environment (build 1.8.0_382-b05)OpenJDK 64-Bit Server VM (build 25.382-b05, mixed mode) 安装12345678910tar xvf Mycat-server-1.6-RELEASE-20161028204710-linux.tar.gzmv mycat/ /usr/local/mycatll /usr/local/mycat总用量 12drwxr-xr-x. 2 root root 190 10月 25 23:50 bin # 命令drwxrwxrwx. 2 root root 6 10月 22 2019 catlet # 其他软件一起工作的目录drwxrwxrwx. 4 root root 4096 10月 25 23:50 conf # 配置文件drwxr-xr-x. 2 root root 4096 10月 25 23:50 lib # 库文件drwxrwxrwx. 2 root root 6 1月 5 2020 logs # 日志文件 -rwxrwxrwx. 1 root root 227 1月 5 2020 version.txt 重要配置文件说明 ，&#x2F;usr&#x2F;local&#x2F;mycat&#x2F;conf&#x2F;*1234server.xml 设置连接账号及逻辑库schema.xml 配置数据分片rule.xml 分片规则其他文件 函数调用文件 修改配置文件定义连接库和逻辑库名1234name 定义了用户名password 密码schemas 数据库readOnly 只能查询 12345678910111213141516171819202122232425vim /usr/local/mycat/conf/server.xml108 &lt;user name=&quot;root&quot; defaultAccount=&quot;true&quot;&gt;109 &lt;property name=&quot;password&quot;&gt;123456&lt;/property&gt;110 &lt;property name=&quot;schemas&quot;&gt;TESTDB&lt;/property&gt;111 &lt;property name=&quot;defaultSchema&quot;&gt;TESTDB&lt;/property&gt;112 &lt;!--No MyCAT Database selected 错误前会尝试使用该schema作为schema，不设置则为null,报错 --&gt;113114 &lt;!-- 表级 DML 权限设置 --&gt;115 &lt;!--116 &lt;privileges check=&quot;false&quot;&gt;117 &lt;schema name=&quot;TESTDB&quot; dml=&quot;0110&quot; &gt;118 &lt;table name=&quot;tb01&quot; dml=&quot;0000&quot;&gt;&lt;/table&gt;119 &lt;table name=&quot;tb02&quot; dml=&quot;1111&quot;&gt;&lt;/table&gt;120 &lt;/schema&gt;121 &lt;/privileges&gt;122 --&gt;123 &lt;/user&gt;124125 &lt;user name=&quot;user&quot;&gt;126 &lt;property name=&quot;password&quot;&gt;user&lt;/property&gt;127 &lt;property name=&quot;schemas&quot;&gt;TESTDB&lt;/property&gt;128 &lt;property name=&quot;readOnly&quot;&gt;true&lt;/property&gt;129 &lt;property name=&quot;defaultSchema&quot;&gt;TESTDB&lt;/property&gt;130 &lt;/user&gt; 定义分片配置1234567定义分片的表&lt;/schema&gt; //定义分片信息&lt;schema&gt;&lt;/table&gt; //定义表&lt;table&gt;name //逻辑库名或逻辑表名dataNode //指定数据节点名rule //指定使用的分片规则type=global //数据不分片存储 注意：1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556vim /usr/local/mycat/conf/schema.xml&lt;?xml version=&quot;1.0&quot;?&gt;&lt;!DOCTYPE mycat:schema SYSTEM &quot;schema.dtd&quot;&gt;&lt;mycat:schema xmlns:mycat=&quot;http://io.mycat/&quot;&gt; &lt;schema name=&quot;TESTDB&quot; checkSQLschema=&quot;false&quot; sqlMaxLimit=&quot;100&quot;&gt; &lt;table name=&quot;travelrecord&quot; dataNode=&quot;dn1,dn2,dn3&quot; rule=&quot;auto-sharding-long&quot; /&gt; &lt;table name=&quot;company&quot; primaryKey=&quot;ID&quot; type=&quot;global&quot; dataNode=&quot;dn1,dn2,dn3&quot; /&gt; &lt;table name=&quot;goods&quot; primaryKey=&quot;ID&quot; type=&quot;global&quot; dataNode=&quot;dn1,dn2,dn3&quot; /&gt; &lt;table name=&quot;hotnews&quot; primaryKey=&quot;ID&quot; autoIncrement=&quot;true&quot; dataNode=&quot;dn1,dn2,dn3&quot; rule=&quot;mod-long&quot; /&gt; &lt;table name=&quot;employee&quot; primaryKey=&quot;ID&quot; dataNode=&quot;dn1,dn2,dn3&quot; rule=&quot;sharding-by-intfile&quot; /&gt; &lt;table name=&quot;customer&quot; primaryKey=&quot;ID&quot; dataNode=&quot;dn1,dn2,dn3&quot; rule=&quot;sharding-by-intfile&quot;&gt; &lt;childTable name=&quot;orders&quot; primaryKey=&quot;ID&quot; joinKey=&quot;customer_id&quot; parentKey=&quot;id&quot;&gt; &lt;childTable name=&quot;order_items&quot; joinKey=&quot;order_id&quot; parentKey=&quot;id&quot; /&gt; &lt;/childTable&gt; &lt;childTable name=&quot;customer_addr&quot; primaryKey=&quot;ID&quot; joinKey=&quot;customer_id&quot; parentKey=&quot;id&quot; /&gt; &lt;/table&gt; &lt;/schema&gt; &lt;dataNode name=&quot;dn1&quot; dataHost=&quot;localhost12&quot; database=&quot;db1&quot; /&gt; &lt;dataNode name=&quot;dn2&quot; dataHost=&quot;localhost22&quot; database=&quot;db2&quot; /&gt; &lt;dataNode name=&quot;dn3&quot; dataHost=&quot;localhost32&quot; database=&quot;db3&quot; /&gt; &lt;dataHost name=&quot;localhost12&quot; maxCon=&quot;1000&quot; minCon=&quot;10&quot; balance=&quot;0&quot; writeType=&quot;0&quot; dbType=&quot;mysql&quot; dbDriver=&quot;native&quot; switchType=&quot;1&quot; slaveThreshold=&quot;100&quot;&gt; &lt;heartbeat&gt;select user()&lt;/heartbeat&gt; &lt;writeHost host=&quot;hostM1&quot; url=&quot;192.168.1.12:3306&quot; user=&quot;root&quot; password=&quot;123456&quot;&gt; &lt;/writeHost&gt; &lt;/dataHost&gt; &lt;dataHost name=&quot;localhost22&quot; maxCon=&quot;1000&quot; minCon=&quot;10&quot; balance=&quot;0&quot; writeType=&quot;0&quot; dbType=&quot;mysql&quot; dbDriver=&quot;native&quot; switchType=&quot;1&quot; slaveThreshold=&quot;100&quot;&gt; &lt;heartbeat&gt;select user()&lt;/heartbeat&gt; &lt;writeHost host=&quot;hostM1&quot; url=&quot;192.168.1.22:3306&quot; user=&quot;root&quot; password=&quot;123456&quot;&gt; &lt;/writeHost&gt; &lt;/dataHost&gt; &lt;dataHost name=&quot;localhost32&quot; maxCon=&quot;1000&quot; minCon=&quot;10&quot; balance=&quot;0&quot; writeType=&quot;0&quot; dbType=&quot;mysql&quot; dbDriver=&quot;native&quot; switchType=&quot;1&quot; slaveThreshold=&quot;100&quot;&gt; &lt;heartbeat&gt;select user()&lt;/heartbeat&gt; &lt;writeHost host=&quot;hostM1&quot; url=&quot;192.168.1.32:3306&quot; user=&quot;root&quot; password=&quot;123456&quot;&gt; &lt;/writeHost&gt; &lt;/dataHost&gt;&lt;/mycat:schema&gt; 创建数据库123456# 192.168.1.12 create database db1;# 192.168.1.32 create database db2;# 192.168.1.32 create database db3; 启动服务1/usr/local/mycat/bin/mycat start 查看服务状态12/usr/local/mycat/bin/mycat statusMycat-server is running (10393). 12[root@centos07-32 mycat]# netstat -lnput|grep 8066tcp6 0 0 :::8066 :::* LISTEN 10397/java 查看日志1234567891011[root@centos07-32 mycat]# tail -10f /usr/local/mycat/logs/wrapper.logINFO | jvm 1 | 2023/10/26 03:13:05 | 2023-10-26 03:13:05,655 [INFO ][$_NIOREACTOR-1-RW] no ilde connection in pool,create new connection for hostM1 of schema db3 (io.mycat.backend.datasource.PhysicalDatasource:PhysicalDatasource.java:413)INFO | jvm 1 | 2023/10/26 03:13:05 | 2023-10-26 03:13:05,655 [INFO ][$_NIOREACTOR-1-RW] close connection,reason:stream closed ,MySQLConnection [id=1827, lastTime=1698261185648, user=root, schema=db3, old shema=db3, borrowed=false, fromSlaveDB=false, threadId=1810, charset=latin1, txIsolation=3, autocommit=true, attachment=null, respHandler=null, host=192.168.1.32, port=3306, statusSync=null, writeQueue=0, modifiedSQLExecuted=false] (io.mycat.net.AbstractConnection:AbstractConnection.java:508)INFO | jvm 1 | 2023/10/26 03:13:05 | 2023-10-26 03:13:05,656 [WARN ][$_NIOREACTOR-0-RW] can&#x27;t connect to mysql server ,errmsg:Unknown database &#x27;db3&#x27; MySQLConnection [id=1828, lastTime=1698261185648, user=root, schema=db3, old shema=db3, borrowed=false, fromSlaveDB=false, threadId=1811, charset=latin1, txIsolation=3, autocommit=true, attachment=null, respHandler=null, host=192.168.1.32, port=3306, statusSync=null, writeQueue=0, modifiedSQLExecuted=false] (io.mycat.backend.mysql.nio.MySQLConnectionAuthenticator:MySQLConnectionAuthenticator.java:91)INFO | jvm 1 | 2023/10/26 03:13:05 | 2023-10-26 03:13:05,656 [INFO ][$_NIOREACTOR-0-RW] can&#x27;t get connection for sql :select user() (io.mycat.sqlengine.SQLJob:SQLJob.java:114)INFO | jvm 1 | 2023/10/26 03:13:05 | 2023-10-26 03:13:05,656 [INFO ][$_NIOREACTOR-0-RW] no ilde connection in pool,create new connection for hostM1 of schema db3 (io.mycat.backend.datasource.PhysicalDatasource:PhysicalDatasource.java:413)INFO | jvm 1 | 2023/10/26 03:13:05 | 2023-10-26 03:13:05,657 [INFO ][$_NIOREACTOR-0-RW] close connection,reason:stream closed ,MySQLConnection [id=1828, lastTime=1698261185648, user=root, schema=db3, old shema=db3, borrowed=false, fromSlaveDB=false, threadId=1811, charset=latin1, txIsolation=3, autocommit=true, attachment=null, respHandler=null, host=192.168.1.32, port=3306, statusSync=null, writeQueue=0, modifiedSQLExecuted=false] (io.mycat.net.AbstractConnection:AbstractConnection.java:508)INFO | jvm 1 | 2023/10/26 03:13:05 | 2023-10-26 03:13:05,674 [WARN ][$_NIOREACTOR-1-RW] can&#x27;t connect to mysql server ,errmsg:Unknown database &#x27;db3&#x27; MySQLConnection [id=1829, lastTime=1698261185656, user=root, schema=db3, old shema=db3, borrowed=false, fromSlaveDB=false, threadId=1812, charset=latin1, txIsolation=3, autocommit=true, attachment=null, respHandler=null, host=192.168.1.32, port=3306, statusSync=null, writeQueue=0, modifiedSQLExecuted=false] (io.mycat.backend.mysql.nio.MySQLConnectionAuthenticator:MySQLConnectionAuthenticator.java:91)INFO | jvm 1 | 2023/10/26 03:13:05 | 2023-10-26 03:13:05,675 [INFO ][$_NIOREACTOR-1-RW] can&#x27;t get connection for sql :select user() (io.mycat.sqlengine.SQLJob:SQLJob.java:114)INFO | jvm 1 | 2023/10/26 03:13:05 | 2023-10-26 03:13:05,675 [INFO ][$_NIOREACTOR-1-RW] close connection,reason:stream closed ,MySQLConnection [id=1829, lastTime=1698261185656, user=root, schema=db3, old shema=db3, borrowed=false, fromSlaveDB=false, threadId=1812, charset=latin1, txIsolation=3, autocommit=true, attachment=null, respHandler=null, host=192.168.1.32, port=3306, statusSync=null, writeQueue=0, modifiedSQLExecuted=false] (io.mycat.net.AbstractConnection:AbstractConnection.java:508)INFO | jvm 1 | 2023/10/26 03:13:16 | 2023-10-26 03:13:16,064 [INFO ][Timer1] no ilde connection in pool,create new connection for hostM1 of schema db3 (io.mycat.backend.datasource.PhysicalDatasource:PhysicalDatasource.java:413) 测试配置，通过mycat连接数据库12345678910111213141516171819202122232425# 端口使用8066[root@centos07-32 mycat]# mysql -h192.168.1.32 -P8066 -uroot -p123456# 数据库是假名，是mycat中配置的mysql&gt; show databases;+----------+| DATABASE |+----------+| TESTDB |+----------+mysql&gt; use TESTDB# 表也是假表，mycat定义的mysql&gt; show tables;+------------------+| Tables in TESTDB |+------------------+| company || customer || customer_addr || employee || goods || hotnews || orders || order_items || travelrecord |+------------------+ 分片规则-枚举法 sharding-by-intfile，字段值必须在列举范围内选择查看哪个表使用sharding-by-intfile规则,表 employee，必须有主键 id字段12[root@centos07-32 mycat]# vim conf/schema.xml &lt;table name=&quot;employee&quot; primaryKey=&quot;ID&quot; dataNode=&quot;dn1,dn2,dn3&quot; rule=&quot;sharding-by-intfile&quot; /&gt; 查看分库规则使用哪个文件1234567891011121314vim conf/rule.xml# sharding-by-intfile，根据字段 sharding_id进行计算, 算法是hash-int，表必须要有 sharding_id字段 &lt;tableRule name=&quot;sharding-by-intfile&quot;&gt; &lt;rule&gt; &lt;columns&gt;sharding_id&lt;/columns&gt; &lt;algorithm&gt;hash-int&lt;/algorithm&gt; &lt;/rule&gt; &lt;/tableRule&gt;# 根据hash-int，查找规则文件, partition-hash-int.txt &lt;function name=&quot;hash-int&quot; class=&quot;io.mycat.route.function.PartitionByFileMap&quot;&gt; &lt;property name=&quot;mapFile&quot;&gt;partition-hash-int.txt&lt;/property&gt; &lt;/function&gt; 添加规则，partition-hash-int.txt，sharding_id&#x3D;10000的写入第一台数据库，sharding_id&#x3D;10010的写入第二台数据库，sharding_id&#x3D;10020的写入第三台数据库1234[root@centos07-32 mycat]# vim conf/partition-hash-int.txt10000=010010=110020=2 重启，规则生效12345678910[root@centos07-32 mycat]# bin/mycat stopStopping Mycat-server...Waiting for Mycat-server to exit...Stopped Mycat-server.[root@centos07-32 mycat]# bin/mycat startStarting Mycat-server...[root@centos07-32 mycat]# bin/mycat statusMycat-server is running (12910).[root@centos07-32 mycat]# netstat -lnput|grep 8066tcp6 0 0 :::8066 :::* LISTEN 12913/java 创建表，必须有主键id，sharding_id, 通过mycat创建表，会自动在db1，db2，db3上创建表123456789101112mysql&gt; create table employee(id int primary key auto_increment, sharding_id int, name char(15), home char(50), sex enum(&quot;man&quot;,&quot;woman&quot;));mysql&gt; desc employee;+-------------+---------------------+------+-----+---------+----------------+| Field | Type | Null | Key | Default | Extra |+-------------+---------------------+------+-----+---------+----------------+| id | int(11) | NO | PRI | NULL | auto_increment || sharding_id | int(11) | YES | | NULL | || name | char(15) | YES | | NULL | || home | char(50) | YES | | NULL | || sex | enum(&#x27;man&#x27;,&#x27;woman&#x27;) | YES | | NULL | |+-------------+---------------------+------+-----+---------+----------------+ 插入数据123456789101112# 错误演示，sharding_id没有10030，写入报错mysql&gt; insert into employee(sharding_id, name,home,sex) values (10030, &quot;dong&quot;, &quot;TJ&quot;, &quot;man&quot;);ERROR 1064 (HY000): can&#x27;t find any valid datanode :EMPLOYEE -&gt; SHARDING_ID -&gt; 10030&#x27;# db1 写入数据mysql&gt; insert into employee(sharding_id, name,home,sex) values (10000, &quot;dong&quot;, &quot;db1&quot;, &quot;man&quot;);# db2 写入mysql&gt; insert into employee(sharding_id, name,home,sex) values (10010, &quot;dong&quot;, &quot;db2&quot;, &quot;man&quot;);# db3 写入mysql&gt; insert into employee(sharding_id, name,home,sex) values (10020, &quot;dong&quot;, &quot;db3&quot;, &quot;man&quot;); 分片规则-求模法 mod-long ，根据字段值与设定的数字求模结果存储数据,查看哪个表使用mod-long规则,表 hotnews，删除primaryKey&#x3D;”ID” autoIncrement&#x3D;”true”12345[root@centos07-32 mycat]# vim conf/schema.xml# 修改前 &lt;table name=&quot;hotnews&quot; primaryKey=&quot;ID&quot; autoIncrement=&quot;true&quot; dataNode=&quot;dn1,dn2,dn3&quot; rule=&quot;mod-long&quot; /&gt;# 修改后 &lt;table name=&quot;hotnews&quot; dataNode=&quot;dn1,dn2,dn3&quot; rule=&quot;mod-long&quot; /&gt; 查看分库规则使用哪个文件 1234567891011121314vim conf/rule.xml# 算法是mod-long，表必须要有id字段 &lt;tableRule name=&quot;mod-long&quot;&gt; &lt;rule&gt; &lt;columns&gt;id&lt;/columns&gt; &lt;algorithm&gt;mod-long&lt;/algorithm&gt; &lt;/rule&gt; &lt;/tableRule&gt;# 根据mod-long，id字段对3取余数, 这里的3是根据数据库来到，有3个数据库就是3，余数是0，1，2 &lt;function name=&quot;mod-long&quot; class=&quot;io.mycat.route.function.PartitionByMod&quot;&gt; &lt;!-- how many data nodes --&gt; &lt;property name=&quot;count&quot;&gt;3&lt;/property&gt; &lt;/function&gt; 重启，规则生效 12345678910[root@centos07-32 mycat]# bin/mycat stopStopping Mycat-server...Waiting for Mycat-server to exit...Stopped Mycat-server.[root@centos07-32 mycat]# bin/mycat startStarting Mycat-server...[root@centos07-32 mycat]# bin/mycat statusMycat-server is running (12910).[root@centos07-32 mycat]# netstat -lnput|grep 8066tcp6 0 0 :::8066 :::* LISTEN 12913/java 创建表，必须有主键id，sharding_id, 通过mycat创建表，会自动在db1，db2，db3上创建表 123456789101112mysql&gt; create table hotnews(id int , title char(50), comment char(100), worker char(20), up_time datetime);mysql&gt; desc hotnews;+---------+-----------+------+-----+---------+-------+| Field | Type | Null | Key | Default | Extra |+---------+-----------+------+-----+---------+-------+| id | int(11) | YES | | NULL | || title | char(50) | YES | | NULL | || comment | char(100) | YES | | NULL | || worker | char(20) | YES | | NULL | || up_time | datetime | YES | | NULL | |+---------+-----------+------+-----+---------+-------+ 插入数据 12345678# db1 写入数据mysql&gt; insert into hotnews(id,title,comment,worker,up_time) values (9, &quot;dong&quot;, &quot;db1&quot;, &quot;man&quot;, now());# db2 写入mysql&gt; insert into hotnews(id,title,comment,worker,up_time) values (7, &quot;dong&quot;, &quot;db2&quot;, &quot;man&quot;, now());# db3 写入mysql&gt; insert into hotnews(id,title,comment,worker,up_time) values (8, &quot;dong&quot;, &quot;db3&quot;, &quot;man&quot;, now()); 查询 123456789101112131415161718192021222324252627282930313233 # 12-db1 上查询mysql&gt; select * from db1.hotnews;+------+-------+---------+--------+---------------------+| id | title | comment | worker | up_time |+------+-------+---------+--------+---------------------+| 9 | dong | db1 | man | 2023-10-26 04:39:42 |+------+-------+---------+--------+---------------------+ # 22-db2 上查询mysql&gt; select * from db2.hotnews;+------+-------+---------+--------+---------------------+| id | title | comment | worker | up_time |+------+-------+---------+--------+---------------------+| 7 | dong | db2 | man | 2023-10-26 04:38:08 |+------+-------+---------+--------+---------------------+ # 32-db3 上查询mysql&gt; select * from db3.hotnews;+------+-------+---------+--------+---------------------+| id | title | comment | worker | up_time |+------+-------+---------+--------+---------------------+| 8 | dong | db3 | man | 2023-10-26 04:38:48 |+------+-------+---------+--------+---------------------+ # 通过mycat查询，全部数据mysql&gt; select * from TESTDB.hotnews;+------+-------+---------+--------+---------------------+| id | title | comment | worker | up_time |+------+-------+---------+--------+---------------------+| 9 | dong | db1 | man | 2023-10-26 04:39:42 || 7 | dong | db2 | man | 2023-10-26 04:38:08 || 8 | dong | db3 | man | 2023-10-26 04:38:48 |+------+-------+---------+--------+---------------------+ 分片规则-不分片存储，type&#x3D;global，每个数据库存储全部数据查看哪个表不分片存储,表 company，primaryKey&#x3D;”ID” type&#x3D;”global” 12[root@centos07-32 mycat]# vim conf/schema.xml &lt;table name=&quot;company&quot; primaryKey=&quot;ID&quot; type=&quot;global&quot; dataNode=&quot;dn1,dn2,dn3&quot; /&gt; 创建表，必须有主键id12345678910mysql&gt; create table company(id int primary key auto_increment, name char(50), addr char(100));mysql&gt; desc company;+-------+-----------+------+-----+---------+----------------+| Field | Type | Null | Key | Default | Extra |+-------+-----------+------+-----+---------+----------------+| id | int(11) | NO | PRI | NULL | auto_increment || name | char(50) | YES | | NULL | || addr | char(100) | YES | | NULL | |+-------+-----------+------+-----+---------+----------------+ 插入数据123mysql&gt; insert into company(name,addr) values (&quot;dong&quot;, &quot;BJ&quot;);mysql&gt; insert into company(name,addr) values (&quot;dong2&quot;, &quot;BJ2&quot;);mysql&gt; insert into company(name,addr) values (&quot;dong3&quot;, &quot;BJ3&quot;); 查询,所有的数据库上的数据一样123456789101112131415161718192021222324252627282930313233343536373839 # 12-db1 上查询mysql&gt; select * from db1.company;+----+-------+------+| id | name | addr |+----+-------+------+| 1 | dong | BJ || 2 | dong2 | BJ2 || 3 | dong3 | BJ3 |+----+-------+------+ # 22-db2 上查询mysql&gt; select * from db2.company;+----+-------+------+| id | name | addr |+----+-------+------+| 1 | dong | BJ || 2 | dong2 | BJ2 || 3 | dong3 | BJ3 |+----+-------+------+ # 32-db3 上查询mysql&gt; select * from db3.company;+----+-------+------+| id | name | addr |+----+-------+------+| 1 | dong | BJ || 2 | dong2 | BJ2 || 3 | dong3 | BJ3 |+----+-------+------+ # 通过mycat查询，全部数据mysql&gt; select * from TESTDB.company;+----+-------+------+| id | name | addr |+----+-------+------+| 1 | dong | BJ || 2 | dong2 | BJ2 || 3 | dong3 | BJ3 |+----+-------+------+ mycat 添加新库新表添加新库123456789101112[root@centos07-32 mycat]# vim conf/server.xml &lt;user name=&quot;root&quot;&gt; &lt;property name=&quot;password&quot;&gt;123456&lt;/property&gt; &lt;property name=&quot;schemas&quot;&gt;新库1，新库2&lt;/property&gt; &lt;/user&gt; &lt;user name=&quot;user&quot;&gt; &lt;property name=&quot;password&quot;&gt;user&lt;/property&gt; &lt;property name=&quot;schemas&quot;&gt;新库1，新库2&lt;/property&gt; &lt;property name=&quot;readOnly&quot;&gt;true&lt;/property&gt; &lt;/user&gt; 添加新表123456[root@centos07-32 mycat]# vim conf/schema.xml &lt;schema name=&quot;新库1&quot; checkSQLschema=&quot;false&quot; sqlMaxLimit=&quot;100&quot;&gt; &lt;table name=&quot;新表1&quot; dataNode=&quot;dn1,dn2,dn3&quot; rule=&quot;auto-sharding-long&quot; /&gt; &lt;table name=&quot;新表2&quot; dataNode=&quot;dn1,dn2,dn3&quot; rule=&quot;auto-sharding-long&quot; /&gt; &lt;/schema&gt;","categories":[{"name":"mysql","slug":"mysql","permalink":"https://dbbruce.github.io/categories/mysql/"}],"tags":[]},{"title":"多实例","slug":"mysql/多实例","date":"2017-02-10T12:30:00.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2017/02/10/mysql/多实例/","link":"","permalink":"https://dbbruce.github.io/2017/02/10/mysql/%E5%A4%9A%E5%AE%9E%E4%BE%8B/","excerpt":"1.多实例在一个主机上运行多个数据库服务优点：节约成本提高硬件利用率 2.安装过单实例机器，mysql清理的一些步骤12345rpm -qa | grep -i mysqlnetstat -utnlp | grep ：3306systemctl stop mysqldsystemctl disable mysqldmv /etc/my.cnf /root/","text":"1.多实例在一个主机上运行多个数据库服务优点：节约成本提高硬件利用率 2.安装过单实例机器，mysql清理的一些步骤12345rpm -qa | grep -i mysqlnetstat -utnlp | grep ：3306systemctl stop mysqldsystemctl disable mysqldmv /etc/my.cnf /root/ 3.安装 下载：https://downloads.mysql.com/archives/community/ 安装123456789101112131415161718192021222324252627282930313233343536373839# 解压tar xvf mysql-5.7.43-linux-glibc2.12-x86_64.tar.gz# 移动解压文件到目录mv mysql-5.7.43-linux-glibc2.12-x86_64 /usr/local/mysql/[root@centos07-32 mysql]# ll总用量 272drwxr-xr-x. 2 root root 4096 10月 25 21:58 bin # 命令drwxr-xr-x. 2 root root 73 10月 25 21:58 docs #帮助文档drwxr-xr-x. 3 root root 4096 10月 25 21:58 include #库文件，头文件drwxr-xr-x. 5 root root 230 10月 25 21:58 lib #库文件-rw-r--r--. 1 7161 31415 260986 6月 21 21:02 LICENSEdrwxr-xr-x. 4 root root 30 10月 25 21:58 man #手册-rw-r--r--. 1 7161 31415 566 6月 21 21:02 README drwxr-xr-x. 28 root root 4096 10月 25 21:58 share # 手册drwxr-xr-x. 2 root root 90 10月 25 21:58 support-files #配置文件模板# 创建配置文件mkdir -p /mysqlmul/mysqld&#123;1,2&#125;vim /etc/my.cnf[mysqld_multi]mysqld=/usr/local/mysql/bin/mysqld_safemysqladmin=/usr/local/mysql/bin/mysqladminuser=root[mysqld1]datadir=/mysqlmul/mysqld1port=3306log-error=/mysqlmul/mysqld1/mysqld1.errpid-file=/mysqlmul/mysqld1/mysqld1.pidsocket=/mysqlmul/mysqld1/mysqld1.sock[mysqld2]datadir=/mysqlmul/mysqld2port=3307log-error=/mysqlmul/mysqld2/mysqld2.errpid-file=/mysqlmul/mysqld2/mysqld2.pidsocket=/mysqlmul/mysqld2/mysqld2.sock 4.管理多实例 启动mysqld multi start 实例编号 &#x2F;&#x2F;启动服务启动第1个实例123/usr/local/mysql/bin/mysqld_multi start 1# 静候启动完成，记录最后一行产生的密码2023-10-25T14:47:29.571443Z 1 [Note] A temporary password is generated for root@localhost: fEc8%,ku=&amp;Tj 启动第2个实例1/usr/local/mysql/bin/mysqld_multi start 2 通过本机socket连接数据库并修改密码12mysql -uroot -p&#x27;fEc8%,ku=&amp;Tj&#x27; -S /mysqlmul/mysqld1/mysqld1.sockalter user root@&#x27;localhost&#x27; identified by &#x27;123456&#x27;; 查看123[root@centos07-32 /]# netstat -nlput|grep mysqltcp6 0 0 :::3306 :::* LISTEN 4931/mysqldtcp6 0 0 :::3307 :::* LISTEN 5265/mysqld 停止1/usr/local/mysql/bin/mysqld_multi --user root --password 123456 stop 1","categories":[{"name":"mysql","slug":"mysql","permalink":"https://dbbruce.github.io/categories/mysql/"}],"tags":[]},{"title":"数据读写分离-maxscale","slug":"mysql/数据读写分离","date":"2017-02-10T12:00:00.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2017/02/10/mysql/数据读写分离/","link":"","permalink":"https://dbbruce.github.io/2017/02/10/mysql/%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/","excerpt":"1.读写分离案例图1234master： 192.168.1.12slave： 192.168.1.22代理： 192.168.1.32客户端： 192.168.1.10 -mac","text":"1.读写分离案例图1234master： 192.168.1.12slave： 192.168.1.22代理： 192.168.1.32客户端： 192.168.1.10 -mac 2.数据读写分离把客户端访问数据的读(select)请求和写(insert update delete)请求分别分配给不同的数据库服务器处理。 程序实现，强制走不同的数据库； 配置服务实现，配置一个服务器用来做读写分离的功能；中间件(架设在服务器和客户端之间的)：mysql-proxy, mycat, maxscale 3.maxscale安装 百度云盘 - maxscale文件下载12链接:https://pan.baidu.com/s/1zs19iUiDQ-ZPNZVy1qPJ9A 密码:yfwa 安装 – 有依赖1[root@centos07-32 ~]# yum localinstall -y maxscale-2.5.28-1.rhel.7.x86_64.rpm 查看软件安装路径123456[root@centos07-32 ~]# rpm -ql maxscale/etc/maxscale.cnf.template/etc/prelink.conf.d/etc/prelink.conf.d/maxscale.conf/usr/bin/cdc.py/usr/bin/cdc_kafka_producer.py maxscale 修改配置文件， 先备份，后修改123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263[root@centos07-32 ~]# cp /etc/maxscale.cnf /etc/maxscale.cnfbak[root@centos07-32 ~]# vim /etc/maxscale.cnf# 线程数 9 [maxscale] 10 threads=auto # 线程数，根据核数，创建线程数# 服务器配置 - 有几个mysql配置几个，这里不分主从 18 [server1] 19 type=server 20 address=192.168.1.12 21 port=3306 22 protocol=MariaDBBackend 23 24 25 [server2] 26 type=server 27 address=192.168.1.22 28 port=3306 29 protocol=MariaDBBackend # 监控 37 [MariaDB-Monitor] 38 type=monitor 39 module=mariadbmon 40 servers=server1， server2 #server1， server2 41 user=maxscalemon # 监控用户，连接server1，server2的用户，密码 ,稍后，在mysql创建用户和密码 42 password=123456 # 连接server1，server2的用户，密码 43 monitor_interval=2000 # 毫秒，监控的频率# 只读服务，希望既能读又能写，注释掉 #54 [Read-Only-Service] #55 type=service #56 router=readconnroute #57 servers=server1 #58 user=myuser #59 password=mypwd #60 router_options=slave# 读写服务 65 [Read-Write-Service] 66 type=service 67 router=readwritesplit 68 servers=server1， server2 69 user=maxscalerouter # 路由用户，稍后在mysql创建用户和密码 70 password=123456# 注释只读监控的端口 78 #[Read-Only-Listener] 79 #type=listener 80 #service=Read-Only-Service 81 #protocol=MariaDBClient 82 #port=4008 # 读写分离的监听端口 84 [Read-Write-Listener] 85 type=listener 86 service=Read-Write-Service 87 protocol=MariaDBClient 88 port=4006 数据库上添加监控用户和路由用户，在1.12上和1.22上创建，2台数据库上都要创建 主从服务器，上在主服务器上创建后，从服务器自动创建 12345# 创建监控用户grant replication slave, replication client on *.* to maxscalemon@&#x27;%&#x27; identified by &#x27;123456&#x27;;# 创建路由用户grant select on mysql.* to maxscalerouter@&#x27;%&#x27; identified by &#x27;123456&#x27;; 1234567mysql&gt; select host,user from mysql.user ;+-----------+----------------+| host | user |+-----------+----------------+| % | dong2 || % | maxscalemon || % | maxscalerouter | 启动maxscale服务1maxscale -f /etc/maxscale.cnf -U root 123456789[root@centos07-32 ~]# ps -axf|grep maxscale 1985 pts/0 S+ 0:00 \\_ grep --color=auto maxscale 1971 ? Ssl 0:01 maxscale -f /etc/maxscale.cnf -U root [root@centos07-32 ~]# netstat -anput |grep maxscaletcp 0 0 127.0.0.1:8989 0.0.0.0:* LISTEN 1971/maxscaletcp 0 0 192.168.1.32:60156 192.168.1.22:3306 ESTABLISHED 1971/maxscaletcp 0 0 192.168.1.32:58652 192.168.1.12:3306 ESTABLISHED 1971/maxscaletcp6 0 0 :::4006 :::* LISTEN 1971/maxscale maxscale 日志文件1[root@centos07-32 ~]# tailf -1000 /var/log/maxscale/maxscale.log 验证12345678[root@centos07-32 ~]# maxctrl list servers┌─────────┬──────────────┬──────┬─────────────┬─────────────────┬──────┐│ Server │ Address │ Port │ Connections │ State │ GTID │├─────────┼──────────────┼──────┼─────────────┼─────────────────┼──────┤│ server1 │ 192.168.1.12 │ 3306 │ 0 │ Master, Running │ │├─────────┼──────────────┼──────┼─────────────┼─────────────────┼──────┤│ server2 │ 192.168.1.22 │ 3306 │ 0 │ Slave, Running │ │└─────────┴──────────────┴──────┴─────────────┴─────────────────┴──────┘ 4.客户端通过代理服务器访问数据库 主服务器添加访问数据连接用户, 12服务器上创建12345678mysql&gt; create database db7;Query OK, 1 row affected (11.29 sec)mysql&gt; create table db7.a(id int);Query OK, 0 rows affected (0.10 sec)mysql&gt; grant select , insert on db7.* to jim@&quot;%&quot; identified by &quot;123456&quot;;Query OK, 0 rows affected, 1 warning (0.01 sec) 客户端连接数据库，192.168.1.10123456789101112131415# 通过代理连接dbbruce@dbburce ~ % mysql -h192.168.1.32 -P4006 -ujim -p123456# 写入、读取mysql&gt; insert into db7.a values(110);mysql&gt; insert into db7.a values(120);mysql&gt; insert into db7.a values(119);mysql&gt; select * from db7.a;+------+| id |+------+| 110 || 120 || 119 |+------+","categories":[{"name":"mysql","slug":"mysql","permalink":"https://dbbruce.github.io/categories/mysql/"}],"tags":[]},{"title":"主主(互为主从)","slug":"mysql/主主(互为主从)","date":"2017-02-10T11:30:58.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2017/02/10/mysql/主主(互为主从)/","link":"","permalink":"https://dbbruce.github.io/2017/02/10/mysql/%E4%B8%BB%E4%B8%BB(%E4%BA%92%E4%B8%BA%E4%B8%BB%E4%BB%8E)/","excerpt":"1.主主(互为主从)主：主+从，既做主服务器，也做从服务器主：主+从， 既做主服务器，也做从服务器","text":"1.主主(互为主从)主：主+从，既做主服务器，也做从服务器主：主+从， 既做主服务器，也做从服务器","categories":[{"name":"mysql","slug":"mysql","permalink":"https://dbbruce.github.io/categories/mysql/"}],"tags":[]},{"title":"主从同步复制模式","slug":"mysql/主从同步复制模式","date":"2017-02-10T11:30:58.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2017/02/10/mysql/主从同步复制模式/","link":"","permalink":"https://dbbruce.github.io/2017/02/10/mysql/%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6%E6%A8%A1%E5%BC%8F/","excerpt":"1.主从同步复制模式异步复制模式（默认）全同步复制模式半同步复制模式","text":"1.主从同步复制模式异步复制模式（默认）全同步复制模式半同步复制模式 2.复制模式介绍 异步复制( Asynchronous replication 主库执行完一次事务后，立即将结果返给客户端，并不关心从库是否已经接收并处理。 全同步复制( Fully synchronous replication ) 当主库执行完一次事务，且所有从库都执行了该事务后才将结果返回给客户端 半同步复制( Semisynchronous replication 介于异步复制和全同步复制之间， 主库在执行完一次事务后，等待至少一个从库接收到并写到relay log中才将结果返回给客户端。 3.查看是否允许动态加载模块 (主、从) 默认允许123456mysql&gt; show variables like &#x27;have_dynamic_loading&#x27;;+----------------------+-------+| Variable_name | Value |+----------------------+-------+| have_dynamic_loading | YES |+----------------------+-------+ 4.命令行加载插件 使用数据库管理员root用户访问服务 主服务器123456789mysql&gt; install plugin rpl_semi_sync_master SONAME &quot;semisync_master.so&quot;;# 查看mysql&gt; select plugin_name, plugin_status from information_schema.plugins where plugin_name like &#x27;%semi%&#x27;;+----------------------+---------------+| plugin_name | plugin_status |+----------------------+---------------+| rpl_semi_sync_master | ACTIVE |+----------------------+---------------+ 从服务器12345678mysql&gt; install plugin rpl_semi_sync_slave SONAME &quot;semisync_slave.so&quot;;mysql&gt; select plugin_name, plugin_status from information_schema.plugins where plugin_name like &#x27;%semi%&#x27;;+---------------------+---------------+| plugin_name | plugin_status |+---------------------+---------------+| rpl_semi_sync_slave | ACTIVE |+---------------------+---------------+ 5.命令行加载插件 半同步复制，默认是关闭的 主服务器执行123456789mysql&gt; set global rpl_semi_sync_master_enabled=1;# 查看mysql&gt; show variables like &quot;rpl_semi_sync_%_enabled&quot;;+------------------------------+-------+| Variable_name | Value |+------------------------------+-------+| rpl_semi_sync_master_enabled | ON |+------------------------------+-------+ 从服务器执行123456789mysql&gt; set global rpl_semi_sync_slave_enabled=1;# 查看mysql&gt; show variables like &quot;rpl_semi_sync_%_enabled&quot;;+-----------------------------+-------+| Variable_name | Value |+-----------------------------+-------+| rpl_semi_sync_slave_enabled | ON |+-----------------------------+-------+ 6.永久启用半同步复制 修改主配置文件 &#x2F;etc&#x2F;my.cnf 在[mysqld])下方添加 主服务器 12plugin-load=&quot;rpl_semi_sync_master=semisync_master.so&quot;rpl_semi_sync_master_enabled=1 从服务器 12plugin-load=&quot;rpl_semi_sync_slave=semisync_slave.so&quot;rpl_semi_sync_slave_enabled=1 1[root@centos07-12 ~]# systemctl restart mysqld 查看 12345678910111213mysql&gt; select plugin_name, plugin_status from information_schema.plugins where plugin_name like &#x27;%semi%&#x27;;+----------------------+---------------+| plugin_name | plugin_status |+----------------------+---------------+| rpl_semi_sync_master | ACTIVE |+----------------------+---------------+mysql&gt; show variables like &quot;rpl_semi_sync_%_enabled&quot;;+------------------------------+-------+| Variable_name | Value |+------------------------------+-------+| rpl_semi_sync_master_enabled | ON |+------------------------------+-------+","categories":[{"name":"mysql","slug":"mysql","permalink":"https://dbbruce.github.io/categories/mysql/"}],"tags":[]},{"title":"主从从(链式复制)","slug":"mysql/主从从(链式复制)","date":"2017-02-10T11:00:58.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2017/02/10/mysql/主从从(链式复制)/","link":"","permalink":"https://dbbruce.github.io/2017/02/10/mysql/%E4%B8%BB%E4%BB%8E%E4%BB%8E(%E9%93%BE%E5%BC%8F%E5%A4%8D%E5%88%B6)/","excerpt":"1.主从从(链式复制)主：主服务器中间从：主服务器+从服务器，配置：log_slave_updates &#x2F;&#x2F; 允许级联复制从：从服务器","text":"1.主从从(链式复制)主：主服务器中间从：主服务器+从服务器，配置：log_slave_updates &#x2F;&#x2F; 允许级联复制从：从服务器 2.把从服务器还原成独立服务器删除4中文件 123456[root@centos07-32 mysql]# ll master.info *relay*-rw-r-----. 1 mysql mysql 213 9月 26 17:33 centos07-32-relay-bin.000001 #中继文件-rw-r-----. 1 mysql mysql 2370 9月 26 17:37 centos07-32-relay-bin.000002-rw-r-----. 1 mysql mysql 62 9月 26 17:33 centos07-32-relay-bin.index #中继索引文件-rw-r-----. 1 mysql mysql 132 9月 26 17:41 master.info # master文件-rw-r-----. 1 mysql mysql 69 9月 26 17:37 relay-log.info #中继日志文件 12[root@centos07-32 mysql]# cd /var/lib/mysql[root@centos07-32 mysql]# rm -fr master.info *relay* 1[root@centos07-32 mysql]# systemctl restart mysqld 12345mysql&gt; show slave status \\G;Empty set (0.00 sec)ERROR:No query specified 4.主 修改配置文件12345[root@centos07-12 ~]# vim /etc/my.cnf[mysqld]server-id=88 # *** 设置idlog-bin=master-dong # *** 开启binlogbinlog_format=mixed # *** binlog日志格式设置为混合 重启服务器1[root@centos07-12 ~]# systemctl restart mysqld 创建同步用户1mysql&gt; grant replication slave on *.* to repluser@&quot;%&quot; identified by &quot;654321&quot;; 导出数据，如果是新库，不需要到数据，直接使用下面的文件和位置1[root@centos07-12 ~]# mysqldump -uroot -p123456 --master-data db5 &gt; /root/db5.sql 查看主机的binlog日志和位置123456mysql&gt; show master status; # 从154开始 ,如果下面不需要同步数据，slave命令里的文件和位置就用这个信息+--------------------+----------+--------------+------------------+-------------------+| File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |+--------------------+----------+--------------+------------------+-------------------+| master-dong.000001 | 154 | | | |+--------------------+----------+--------------+------------------+-------------------+ 5.中间从 &#x3D; 主 + 从, 中间的从服务器，既是主服务器，又是从服务器核心：log_slave_updates 1234[mysqld]server-id=388log-bin=master-32log_slave_updates 主服务器的部分 重启服务器1[root@centos07-12 ~]# systemctl restart mysqld 创建同步用户1mysql&gt; grant replication slave on *.* to repluser@&quot;%&quot; identified by &quot;654321&quot;; 从服务器的部分 修改从服务器配置信息1mysql&gt; change master to master_host=&quot;192.168.1.12&quot;, master_user= &quot;repluser&quot;, master_password=&quot;654321&quot;, master_log_file=&quot;master-dong.000001&quot;, master_log_pos=441; 重启slave1mysql&gt; start slave; 6.从 修改配置文件123[root@centos07-22 ~]# vim /etc/my.cnf[mysqld]server-id=288 # *** 设置id，不要与master一样 重启1systemctl restart mysqld 导入数据1[root@centos07-22 ~]# mysql -uroot -p123456 db5 &lt; /root/db5.sql 查看主服务器导入数据的位置123[root@centos07-22 ~]# grep master-dong /root/db5.sql CHANGE MASTER TO MASTER_LOG_FILE=&#x27;master-dong.000001&#x27;, MASTER_LOG_POS=441; # 数据备份到master-dong.000001， 从数据库会从master-dong.000001开始同步 修改从服务器配置信息1mysql&gt; change master to master_host=&quot;192.168.1.12&quot;, master_user= &quot;repluser&quot;, master_password=&quot;654321&quot;, master_log_file=&quot;master-dong.000001&quot;, master_log_pos=441; 重启slave1mysql&gt; start slave;","categories":[{"name":"mysql","slug":"mysql","permalink":"https://dbbruce.github.io/categories/mysql/"}],"tags":[]},{"title":"一主多从","slug":"mysql/一主多从","date":"2017-02-10T10:30:58.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2017/02/10/mysql/一主多从/","link":"","permalink":"https://dbbruce.github.io/2017/02/10/mysql/%E4%B8%80%E4%B8%BB%E5%A4%9A%E4%BB%8E/","excerpt":"1.一主多从","text":"1.一主多从 2.主机配置 修改配置文件12345[root@centos07-12 ~]# vim /etc/my.cnf[mysqld]server-id=88 # *** 设置idlog-bin=master-dong # *** 开启binlogbinlog_format=mixed # *** binlog日志格式设置为混合 重启服务器1[root@centos07-12 ~]# systemctl restart mysqld 创建同步用户1mysql&gt; grant replication slave on *.* to repluser@&quot;%&quot; identified by &quot;654321&quot;; 导出数据，如果是新库，不需要到数据，直接使用下面的文件和位置1[root@centos07-12 ~]# mysqldump -uroot -p123456 --master-data db5 &gt; /root/db5.sql 查看主机的binlog日志和位置123456mysql&gt; show master status; # 从154开始 ,如果下面不需要同步数据，slave命令里的文件和位置就用这个信息+--------------------+----------+--------------+------------------+-------------------+| File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |+--------------------+----------+--------------+------------------+-------------------+| master-dong.000001 | 154 | | | |+--------------------+----------+--------------+------------------+-------------------+ 3.从1配置 修改配置文件123[root@centos07-22 ~]# vim /etc/my.cnf[mysqld]server-id=288 # *** 设置id，不要与master一样 重启1systemctl restart mysqld 导入数据1[root@centos07-22 ~]# mysql -uroot -p123456 db5 &lt; /root/db5.sql 查看主服务器导入数据的位置123[root@centos07-22 ~]# grep master-dong /root/db5.sql CHANGE MASTER TO MASTER_LOG_FILE=&#x27;master-dong.000001&#x27;, MASTER_LOG_POS=441; # 数据备份到master-dong.000001， 从数据库会从master-dong.000001开始同步 修改从服务器配置信息1mysql&gt; change master to master_host=&quot;192.168.1.12&quot;, master_user= &quot;repluser&quot;, master_password=&quot;654321&quot;, master_log_file=&quot;master-dong.000001&quot;, master_log_pos=441; 重启slave1mysql&gt; start slave; 4.从2配置 修改配置文件123[root@centos07-32 ~]# vim /etc/my.cnf[mysqld]server-id=388 # *** 设置id，不要与master一样 重启1systemctl restart mysqld 导入数据1[root@centos07-22 ~]# mysql -uroot -p123456 db5 &lt; /root/db5.sql 查看主服务器导入数据的位置123[root@centos07-22 ~]# grep master-dong /root/db5.sql CHANGE MASTER TO MASTER_LOG_FILE=&#x27;master-dong.000001&#x27;, MASTER_LOG_POS=441; # 数据备份到master-dong.000001， 从数据库会从master-dong.000001开始同步 修改从服务器配置信息1mysql&gt; change master to master_host=&quot;192.168.1.12&quot;, master_user= &quot;repluser&quot;, master_password=&quot;654321&quot;, master_log_file=&quot;master-dong.000001&quot;, master_log_pos=441; 重启slave1mysql&gt; start slave; 查看状态1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859mysql&gt; show slave status \\G;*************************** 1. row *************************** Slave_IO_State: Waiting for master to send event Master_Host: 192.168.1.12 Master_User: repluser Master_Port: 3306 Connect_Retry: 60 Master_Log_File: master-dong.000001 Read_Master_Log_Pos: 2217 Relay_Log_File: centos07-32-relay-bin.000002 Relay_Log_Pos: 2098 Relay_Master_Log_File: master-dong.000001 Slave_IO_Running: Yes Slave_SQL_Running: Yes Replicate_Do_DB: Replicate_Ignore_DB: Replicate_Do_Table: Replicate_Ignore_Table: Replicate_Wild_Do_Table: Replicate_Wild_Ignore_Table: Last_Errno: 0 Last_Error: Skip_Counter: 0 Exec_Master_Log_Pos: 2217 Relay_Log_Space: 2311 Until_Condition: None Until_Log_File: Until_Log_Pos: 0 Master_SSL_Allowed: No Master_SSL_CA_File: Master_SSL_CA_Path: Master_SSL_Cert: Master_SSL_Cipher: Master_SSL_Key: Seconds_Behind_Master: 0Master_SSL_Verify_Server_Cert: No Last_IO_Errno: 0 Last_IO_Error: Last_SQL_Errno: 0 Last_SQL_Error: Replicate_Ignore_Server_Ids: Master_Server_Id: 88 Master_UUID: 914f8389-595a-11ee-b0fa-08002779a3b8 Master_Info_File: /var/lib/mysql/master.info SQL_Delay: 0 SQL_Remaining_Delay: NULL Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates Master_Retry_Count: 86400 Master_Bind: Last_IO_Error_Timestamp: Last_SQL_Error_Timestamp: Master_SSL_Crl: Master_SSL_Crlpath: Retrieved_Gtid_Set: Executed_Gtid_Set: Auto_Position: 0 Replicate_Rewrite_DB: Channel_Name: Master_TLS_Version:","categories":[{"name":"mysql","slug":"mysql","permalink":"https://dbbruce.github.io/categories/mysql/"}],"tags":[]},{"title":"主从拆分","slug":"mysql/主从拆分","date":"2017-02-10T10:10:59.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2017/02/10/mysql/主从拆分/","link":"","permalink":"https://dbbruce.github.io/2017/02/10/mysql/%E4%B8%BB%E4%BB%8E%E6%8B%86%E5%88%86/","excerpt":"1.拆分主从结构 进入从库，mysql目录1234567cd /var/lib/-rw-r----- 1 mysql mysql 381 10月 25 21:57 centos07-22-relay-bin.000108-rw-r----- 1 mysql mysql 322 10月 25 21:57 centos07-22-relay-bin.000109 # 中继日志文件-rw-r----- 1 mysql mysql 62 10月 25 21:57 centos07-22-relay-bin.index # 中继日志文件索引-rw-r-----. 1 mysql mysql 132 10月 25 23:11 master.info # 主信息-rw-r-----. 1 mysql mysql 69 10月 25 21:57 relay-log.info # 同步信息-rw-r-----. 1 mysql mysql 69 10月 25 21:57 relay-log.info","text":"1.拆分主从结构 进入从库，mysql目录1234567cd /var/lib/-rw-r----- 1 mysql mysql 381 10月 25 21:57 centos07-22-relay-bin.000108-rw-r----- 1 mysql mysql 322 10月 25 21:57 centos07-22-relay-bin.000109 # 中继日志文件-rw-r----- 1 mysql mysql 62 10月 25 21:57 centos07-22-relay-bin.index # 中继日志文件索引-rw-r-----. 1 mysql mysql 132 10月 25 23:11 master.info # 主信息-rw-r-----. 1 mysql mysql 69 10月 25 21:57 relay-log.info # 同步信息-rw-r-----. 1 mysql mysql 69 10月 25 21:57 relay-log.info 删除4种类型文件1rm -fr master.info relay-log.info centos07-22-relay-bin.* 重启服务1systemctl restart mysqld 查看从库状态，slave状态为空，就是解除了12mysql -uroot -p123456 -e &quot;show slave status;&quot;mysql: [Warning] Using a password on the command line interface can be insecure.","categories":[{"name":"mysql","slug":"mysql","permalink":"https://dbbruce.github.io/categories/mysql/"}],"tags":[]},{"title":"主从同步","slug":"mysql/主从同步","date":"2017-02-10T10:00:58.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2017/02/10/mysql/主从同步/","link":"","permalink":"https://dbbruce.github.io/2017/02/10/mysql/%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5/","excerpt":"1.主从同步介绍 123实现数据自动同步的服务结构主服务器:接受客户端访问连接从服务器:自动同步主服务器数据","text":"1.主从同步介绍 123实现数据自动同步的服务结构主服务器:接受客户端访问连接从服务器:自动同步主服务器数据 2.从服务器 123IO thread： IO线程: 从主服务binlog，复制sql命令，放在中继日志文件；SQL thread：sql线程: Relay log：中继日志: 存放主服务器SQL语句； 3. 主从同步原理12345Master启用binlog日志SlaveSlave io: 复制master主机 binlog日志文件里的SQL命令到本机的relay-log文件里slave SQL: 执行本机relay-log文件里的SQL语句实现与Master数据一致。 4.构建思路 配置主服务器-启用binlog日志、授权用户、查看binlog日志信息 启用binlog日志12345[root@centos07-12 ~]# vim /etc/my.cnf[mysqld]server-id=88 # *** 设置idlog-bin=master-dong # *** 开启binlogbinlog_format=mixed # *** binlog日志格式设置为混合 123[root@centos07-12 ~]# systemctl restart mysqld[root@centos07-12 ~]# netstat -anput|grep 3306tcp6 0 0 :::3306 :::* LISTEN 2076/mysqld 1234567[root@centos07-12 ~]# mysql -uroot -p123456mysql&gt; show master status; # 从154开始 ,如果下面不需要同步数据，slave命令里的文件和位置就用这个信息+--------------------+----------+--------------+------------------+-------------------+| File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |+--------------------+----------+--------------+------------------+-------------------+| master-dong.000001 | 154 | | | |+--------------------+----------+--------------+------------------+-------------------+ 授权用户123456789mysql&gt; grant replication slave on *.* to repluser@&quot;%&quot; identified by &quot;654321&quot;;Query OK, 0 rows affected, 1 warning (0.02 sec)mysql&gt; show grants for repluser@&quot;%&quot;;+--------------------------------------------------+| Grants for repluser@% |+--------------------------------------------------+| GRANT REPLICATION SLAVE ON *.* TO &#x27;repluser&#x27;@&#x27;%&#x27; |+--------------------------------------------------+ 配置从服务器 设置server id123[root@centos07-22 ~]# vim /etc/my.cnf[mysqld]server-id=288 # *** 设置id，不要与master一样 1systemctl restart mysqld 确保与主服务器数据一致–master-date:记录备份的日志信息，日志名和偏移量，解决数据一致时，有差异的情况，从服务会从记录的日志信息开始同步 主服务数据导出 1[root@centos07-12 ~]# mysqldump -uroot -p123456 --master-data db5 &gt; /root/db5.sql 从服务器数据导入 1[root@centos07-22 ~]# mysql -uroot -p123456 db5 &lt; /root/db5.sql 查询，数据导入 12345678910从服务器mysql&gt; use db5;mysql&gt; show tables;+---------------+| Tables_in_db5 |+---------------+| a || b || c |+---------------+ 查看主服务器数据备份到的标识 123[root@centos07-22 ~]# grep master-dong /root/db5.sqlCHANGE MASTER TO MASTER_LOG_FILE=&#x27;master-dong.000001&#x27;, MASTER_LOG_POS=441; # 数据备份到master-dong.000001， 从数据库会从master-dong.000001开始同步 指定主库信息 显示当前服务器从库信息，如果不是从库，没有信息 12mysql&gt; show slave status;Empty set (0.00 sec) 1mysql&gt; change master to master_host=&quot;192.168.1.12&quot;, master_user= &quot;repluser&quot;, master_password=&quot;654321&quot;, master_log_file=&quot;master-dong.000001&quot;, master_log_pos=441; 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859mysql&gt; show slave status \\G;*************************** 1. row *************************** Slave_IO_State: Master_Host: 192.168.12 Master_User: repluser Master_Port: 3306 Connect_Retry: 60 Master_Log_File: master-dong.000001 Read_Master_Log_Pos: 441 Relay_Log_File: centos07-22-relay-bin.000001 Relay_Log_Pos: 4 Relay_Master_Log_File: master-dong.000001 Slave_IO_Running: No Slave_SQL_Running: No Replicate_Do_DB: Replicate_Ignore_DB: Replicate_Do_Table: Replicate_Ignore_Table: Replicate_Wild_Do_Table: Replicate_Wild_Ignore_Table: Last_Errno: 0 Last_Error: Skip_Counter: 0 Exec_Master_Log_Pos: 441 Relay_Log_Space: 154 Until_Condition: None Until_Log_File: Until_Log_Pos: 0 Master_SSL_Allowed: No Master_SSL_CA_File: Master_SSL_CA_Path: Master_SSL_Cert: Master_SSL_Cipher: Master_SSL_Key: Seconds_Behind_Master: NULLMaster_SSL_Verify_Server_Cert: No Last_IO_Errno: 0 Last_IO_Error: Last_SQL_Errno: 0 Last_SQL_Error: Replicate_Ignore_Server_Ids: Master_Server_Id: 0 Master_UUID: Master_Info_File: /var/lib/mysql/master.info SQL_Delay: 0 SQL_Remaining_Delay: NULL Slave_SQL_Running_State: Master_Retry_Count: 86400 Master_Bind: Last_IO_Error_Timestamp: Last_SQL_Error_Timestamp: Master_SSL_Crl: Master_SSL_Crlpath: Retrieved_Gtid_Set: Executed_Gtid_Set: Auto_Position: 0 Replicate_Rewrite_DB: Channel_Name: Master_TLS_Version: 配置错误后，从新配置123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566mysql&gt; stop slave;mysql&gt; change master to master_host=&quot;192.168.1.12&quot;, master_user= &quot;repluser&quot;, master_password=&quot;654321&quot;, master_log_file=&quot;master-dong.000001&quot;, master_log_pos=441;mysql&gt; start slave;mysql&gt; show slave status \\G;*************************** 1. row *************************** Slave_IO_State: Waiting for master to send event Master_Host: 192.168.1.12 Master_User: repluser Master_Port: 3306 Connect_Retry: 60 Master_Log_File: master-dong.000001 Read_Master_Log_Pos: 441 Relay_Log_File: centos07-22-relay-bin.000002 Relay_Log_Pos: 322 Relay_Master_Log_File: master-dong.000001 Slave_IO_Running: Yes Slave_SQL_Running: Yes Replicate_Do_DB: Replicate_Ignore_DB: Replicate_Do_Table: Replicate_Ignore_Table: Replicate_Wild_Do_Table: Replicate_Wild_Ignore_Table: Last_Errno: 0 Last_Error: Skip_Counter: 0 Exec_Master_Log_Pos: 441 Relay_Log_Space: 535 Until_Condition: None Until_Log_File: Until_Log_Pos: 0 Master_SSL_Allowed: No Master_SSL_CA_File: Master_SSL_CA_Path: Master_SSL_Cert: Master_SSL_Cipher: Master_SSL_Key: Seconds_Behind_Master: 0Master_SSL_Verify_Server_Cert: No Last_IO_Errno: 0 Last_IO_Error: Last_SQL_Errno: 0 Last_SQL_Error: Replicate_Ignore_Server_Ids: Master_Server_Id: 88 Master_UUID: 914f8389-595a-11ee-b0fa-08002779a3b8 Master_Info_File: /var/lib/mysql/master.info SQL_Delay: 0 SQL_Remaining_Delay: NULL Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates Master_Retry_Count: 86400 Master_Bind: Last_IO_Error_Timestamp: Last_SQL_Error_Timestamp: Master_SSL_Crl: Master_SSL_Crlpath: Retrieved_Gtid_Set: Executed_Gtid_Set: Auto_Position: 0 Replicate_Rewrite_DB: Channel_Name: Master_TLS_Version:1 row in set (0.00 sec) 启动slave进程 1mysql&gt; start slave; –注意这两项：Slave_IO_Running: Yes yes是正常，其他的是有问题， 有问题看：Last_IO_ErrorSlave_SQL_Running: Yes yes是正常，其他的是有问题， 有问题看：Last_SQL_Error 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859mysql&gt; show slave status \\G;*************************** 1. row *************************** Slave_IO_State: Connecting to master Master_Host: 192.168.12 Master_User: repluser Master_Port: 3306 Connect_Retry: 60 Master_Log_File: master-dong.000001 Read_Master_Log_Pos: 441 Relay_Log_File: centos07-22-relay-bin.000001 Relay_Log_Pos: 4 Relay_Master_Log_File: master-dong.000001 Slave_IO_Running: Connecting Slave_SQL_Running: Yes Replicate_Do_DB: Replicate_Ignore_DB: Replicate_Do_Table: Replicate_Ignore_Table: Replicate_Wild_Do_Table: Replicate_Wild_Ignore_Table: Last_Errno: 0 Last_Error: Skip_Counter: 0 Exec_Master_Log_Pos: 441 Relay_Log_Space: 154 Until_Condition: None Until_Log_File: Until_Log_Pos: 0 Master_SSL_Allowed: No Master_SSL_CA_File: Master_SSL_CA_Path: Master_SSL_Cert: Master_SSL_Cipher: Master_SSL_Key: Seconds_Behind_Master: NULLMaster_SSL_Verify_Server_Cert: No Last_IO_Errno: 2003 Last_IO_Error: error connecting to master &#x27;repluser@192.168.12:3306&#x27; - retry-time: 60 retries: 1 Last_SQL_Errno: 0 Last_SQL_Error: Replicate_Ignore_Server_Ids: Master_Server_Id: 0 Master_UUID: Master_Info_File: /var/lib/mysql/master.info SQL_Delay: 0 SQL_Remaining_Delay: NULL Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates Master_Retry_Count: 86400 Master_Bind: Last_IO_Error_Timestamp: 230925 03:34:27 Last_SQL_Error_Timestamp: Master_SSL_Crl: Master_SSL_Crlpath: Retrieved_Gtid_Set: Executed_Gtid_Set: Auto_Position: 0 Replicate_Rewrite_DB: Channel_Name: Master_TLS_Version:","categories":[{"name":"mysql","slug":"mysql","permalink":"https://dbbruce.github.io/categories/mysql/"}],"tags":[]},{"title":"Percona软件备份与恢复","slug":"mysql/Percona软件备份与恢复","date":"2017-02-10T09:30:58.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2017/02/10/mysql/Percona软件备份与恢复/","link":"","permalink":"https://dbbruce.github.io/2017/02/10/mysql/Percona%E8%BD%AF%E4%BB%B6%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/","excerpt":"0.MySQL备份工具的缺点 物理备份缺点12跨平台性差备份时间长、几余备份、浪费存储空间 mysqldump备份缺点12效率较低、备份和还原速度慢、锁表备份过程中，数据插入和更新操作被阻塞","text":"0.MySQL备份工具的缺点 物理备份缺点12跨平台性差备份时间长、几余备份、浪费存储空间 mysqldump备份缺点12效率较低、备份和还原速度慢、锁表备份过程中，数据插入和更新操作被阻塞 1.XtraBackup工具 一款强大的在线热备份工具12备份过程中不锁库表，适合生产环境由专业组织Percona提供(改进MySQL分支 主要含两个组件12xtrabackup: C程序，支持InnoDB/XtraDBinnobackupex:以Perl脚本封装xtrabackup还支持MyISAM 2.安装 percona-xtrabackup-241https://downloads.percona.com/downloads/Percona-XtraBackup-2.4/Percona-XtraBackup-2.4.28/binary/redhat/7/x86_64/percona-xtrabackup-24-2.4.28-1.el7.x86_64.rpm 百度网盘分享： 1链接:https://pan.baidu.com/s/14y-abW8iODC3UUQAtAmq_A 密码:ag2d 1yum localinstall percona-xtrabackup-24-2.4.28-1.el7.x86_64.rpm 123456789101112131415rpm -ql percona-xtrabackup-24/usr/bin/innobackupex/usr/bin/xbcloud/usr/bin/xbcloud_osenv/usr/bin/xbcrypt/usr/bin/xbstream/usr/bin/xtrabackup/usr/lib64/xtrabackup/plugin/keyring_file.so/usr/lib64/xtrabackup/plugin/keyring_vault.so/usr/share/doc/percona-xtrabackup-24-2.4.28/usr/share/doc/percona-xtrabackup-24-2.4.28/LICENSE/usr/share/man/man1/innobackupex.1.gz/usr/share/man/man1/xbcrypt.1.gz/usr/share/man/man1/xbstream.1.gz/usr/share/man/man1/xtrabackup.1.gz 3.常用选项1234567891011121314--host 主机名--user 用户名--port 端口号--password 密 码--databases 1个库--databases=&quot;库名&quot;|多个库--databases=&quot;库1 库2&quot;|1张表--databases=&quot;库1.表&quot;--no-timestamp 不用日期命名备份文件存储的子目录名--redo-only 日志合并--apply-log 准备恢复数据--copy-back 拷贝数据--incremental-目录名 增量备份--incremental-basedir=目录名 增量备份时，指定上一次备份数据存储的目录名--incremental-dir=目录名 准备恢复数据时，指定增量备份数据存储的目录名--export 导出表信息import 导入表空间 4.完全备份 语法 innobackupex –user 用户名 –password 密码 备份目录名 –no-timestamp 备份步骤123innobackupex --user root --password 123456 /allbak innobackupex --user root --password 123456 --databases=&quot;db5 db2&quot; /allbak innobackupex --user root --password 123456 --databases=&quot;db5.a&quot; /allbak 5.完全恢复 语法 innobackupex –apply-log 目录名 &#x2F;&#x2F;准备恢复数据 innobackupex –copy-back 目录名 &#x2F;&#x2F;恢复数据 恢复步骤 1 停止数据库服务器 1systemctl stop mysqld 2 清空数据库目录 1rm -fr /var/lib/mysql/* 3 准备恢复数据 1innobackupex --apply-log /root/2023-09-23_15-16-20/ 4 拷贝数据 1innobackupex --copy-back /root/2023-09-23_15-16-20/ 5 修改数据库目录的所有者和组用户为mysql 1chown -R mysql:mysql /var/lib/mysql 6 启动服务 1234systemctl start mysqldnetstat -anput|grep 3306tcp6 0 0 :::3306 :::* LISTEN 3259/mysqld 7 管理员登陆查看数据 123456789mysql -uroot -p123456mysql&gt; use db5;mysql&gt; show tables;+---------------+| Tables_in_db5 |+---------------+| a || b |+---------------+ 6.关于innodb只有innodb，才是差异备份，其他的也是全量备份 1234567891011121314mysql&gt; show engines;+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+| Engine | Support | Comment | Transactions | XA | Savepoints |+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+| InnoDB | DEFAULT | Supports transactions, row-level locking, and foreign keys | YES | YES | YES || MRG_MYISAM | YES | Collection of identical MyISAM tables | NO | NO | NO || MEMORY | YES | Hash based, stored in memory, useful for temporary tables | NO | NO | NO || BLACKHOLE | YES | /dev/null storage engine (anything you write to it disappears) | NO | NO | NO || MyISAM | YES | MyISAM storage engine | NO | NO | NO || CSV | YES | CSV storage engine | NO | NO | NO || ARCHIVE | YES | Archive storage engine | NO | NO | NO || PERFORMANCE_SCHEMA | YES | Performance Schema | NO | NO | NO || FEDERATED | NO | Federated MySQL storage engine | NULL | NULL | NULL |+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+ 7.完全备份文件，恢复单张表说明：表存储的文件路径，frm表结构，ibd表空间 12345/var/lib/mysql/db5（数据库）[root@centos07-12 db5]# ll总用量 220-rw-r-----. 1 mysql mysql 8556 9月 23 15:01 a.frm # 表结构-rw-r-----. 1 mysql mysql 98304 9月 23 15:09 a.ibd # 表空间，存储数据的空间文件 删除表空间alter table 库名.表名 discard tablespace;12345678mysql&gt; delete from b;mysql&gt; alter table db5.b discard tablespace; # 删除表空间，查询数据会报错，但是 desc查看表结构会正常显示# b.ibd 被删除[root@centos07-12 db5]# ll-rw-r-----. 1 mysql mysql 8556 9月 23 15:01 a.frm-rw-r-----. 1 mysql mysql 98304 9月 23 15:09 a.ibd-rw-r-----. 1 mysql mysql 8560 9月 23 15:08 b.frm 导出表信息innobackupex –apply-log –export 数据完全备份目录1innobackupex --apply-log --export /root/2023-09-23_15-16-20 拷贝表信息文件到数据库目录下1cp /root/2023-09-23_15-16-20/db5/b.&#123;cfg,exp,ibd&#125; /var/lib/mysql/db5/ 修改表信息文件的所有者及组用户为mysql1chown -R mysql:mysql /var/lib/mysql/db5/b.* 导入表空间alter table 库名.表名 import tablespace; &#x2F;&#x2F;导入表空间1mysql&gt; alter table db5.b import tablespace; 删除数据库目录下的表信息文件12345678910111213ll /var/lib/mysql/db5/b.*-rw-r--r--. 1 mysql mysql 369 9月 24 21:40 /var/lib/mysql/db5/b.cfg-rw-r-----. 1 mysql mysql 16384 9月 24 21:40 /var/lib/mysql/db5/b.exp-rw-r-----. 1 mysql mysql 8560 9月 24 20:50 /var/lib/mysql/db5/b.frm-rw-r-----. 1 mysql mysql 98304 9月 24 21:40 /var/lib/mysql/db5/b.ibdrm -fr /var/lib/mysql/db5/b.&#123;cfg,exp&#125;ll /var/lib/mysql/db5/b.*-rw-r-----. 1 mysql mysql 8560 9月 24 20:50 /var/lib/mysql/db5/b.frm-rw-r-----. 1 mysql mysql 98304 9月 24 21:42 /var/lib/mysql/db5/b.ibd 查看表记录123456789101112mysql&gt; select * from b;+------+| name |+------+| dong || dong || dong || dong || dong || dong || dong |+------+ 8.查看备份类型123456789cat /allbak/2023-09-23_16-25-10/xtrabackup_checkpointsbackup_type = full-backuped #1.full-backuped全量备份 / 2.incremental 增量备份from_lsn = 0 # lsn日志编号-开始to_lsn = 3122874 #lsn日志编号-结束last_lsn = 3122883compact = 0recover_binlog_info = 0flushed_lsn = 3122883 9.增量备份 innobackupex –user 用户名 –password 密码 –incremental 新增量目录 –incremental-basedir&#x3D;上一次备份目录 –no-timestamp123456789101112131415161718192021222324252627innobackupex --user root --password 123456 --incremental /newdir1 --incremental-basedir=/allbak2 --no-timestamp# 增量备份完成-查看root@centos07-12 /]# ll /newdir1/总用量 136-rw-r-----. 1 root root 488 9月 23 16:38 backup-my.cnfdrwxr-x---. 2 root root 170 9月 23 16:38 db5-rw-r-----. 1 root root 425 9月 23 16:38 ib_buffer_pool-rw-r-----. 1 root root 81920 9月 23 16:38 ibdata1.delta-rw-r-----. 1 root root 60 9月 23 16:38 ibdata1.metadrwxr-x---. 2 root root 4096 9月 23 16:38 mysqldrwxr-x---. 2 root root 8192 9月 23 16:38 performance_schemadrwxr-x---. 2 root root 8192 9月 23 16:38 sys-rw-r-----. 1 root root 29 9月 23 16:38 xtrabackup_binlog_info-rw-r-----. 1 root root 139 9月 23 16:38 xtrabackup_checkpoints-rw-r-----. 1 root root 547 9月 23 16:38 xtrabackup_info-rw-r-----. 1 root root 2560 9月 23 16:38 xtrabackup_logfile``` #### 10.增量恢复- innobackupex --redo-only --apply-log 目录名 --incremental-dir=目录名 //准备恢复数据- innobackupex --copy-back 目录名 //恢复数据- 准备备份文件```shellroot@centos07-22 ~]# ls -ld newdir* allbak2*drwxr-x---. 6 root root 234 9月 24 22:17 allbak2 # 全量备份文件drwxr-x---. 6 root root 260 9月 24 22:18 newdir1 # 差异备份1drwxr-x---. 6 root root 260 9月 24 22:19 newdir2 # 差异备份2 准备恢复-全量1innobackupex --redo-only --apply-log /root/allbak2/ backup_type会变 12345678[root@centos07-22 ~]# cat /root/allbak2/xtrabackup_checkpointsbackup_type = log-applied #full-backuped 变为 log-applied，日志追加from_lsn = 0to_lsn = 3167183last_lsn = 3167192compact = 0recover_binlog_info = 0flushed_lsn = 3167192 合并日志，合并第一次增量的日志，注意&#x2F;root&#x2F;allbak2是日志追加目录，&#x2F;root&#x2F;newdir1是第一个增量的路径1innobackupex --redo-only --apply-log /root/allbak2 --incremental-dir=/root/newdir1 12345678[root@centos07-22 ~]# cat /root/allbak2/xtrabackup_checkpointsbackup_type = log-appliedfrom_lsn = 0to_lsn = 3167183last_lsn = 3167192compact = 0recover_binlog_info = 0flushed_lsn = 3167192 合并日志，合并第二次增量的日志，注意&#x2F;root&#x2F;allbak2是日志追加目录，&#x2F;root&#x2F;newdir1是第二个增量的路径1innobackupex --redo-only --apply-log /root/allbak2 --incremental-dir=/root/newdir2 12345678[root@centos07-22 ~]# cat /root/allbak2/xtrabackup_checkpointsbackup_type = log-appliedfrom_lsn = 0to_lsn = 3172054last_lsn = 3172063compact = 0recover_binlog_info = 0flushed_lsn = 3172063 停服务1systemctl stop mysqld 删除数据，必须删除，否则报错1rm -fr /var/lib/mysql/* 拷贝1innobackupex --copy-back /root/allbak2 修改权限1chown -R mysql:mysql /var/lib/mysql/* 启动服务1systemctl start mysqld 1netstat -anput|grep 3306 数据库查询12345678910mysql&gt; select * from b;+------+| name |+------+| dong || dong || dong || xue || xue || xue |","categories":[{"name":"mysql","slug":"mysql","permalink":"https://dbbruce.github.io/categories/mysql/"}],"tags":[]},{"title":"数据增量备份","slug":"mysql/数据增量备份","date":"2017-02-10T09:00:58.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2017/02/10/mysql/数据增量备份/","link":"","permalink":"https://dbbruce.github.io/2017/02/10/mysql/%E6%95%B0%E6%8D%AE%E5%A2%9E%E9%87%8F%E5%A4%87%E4%BB%BD/","excerpt":"1.数据增量备份(使用mysql服务的binlog日志实现数据的增量备份与恢复)2.binlog日志也称做二进制日志MvSQL服务日志文件的一种记录除查询之外的所有SQL命令可用于数据备份和恢复配置mysql主从同步的必要条件","text":"1.数据增量备份(使用mysql服务的binlog日志实现数据的增量备份与恢复)2.binlog日志也称做二进制日志MvSQL服务日志文件的一种记录除查询之外的所有SQL命令可用于数据备份和恢复配置mysql主从同步的必要条件 3.启动binlog日志server id&#x3D;数字 #指定id值(1-255)log-bin[&#x3D;目录名&#x2F;文件名] #启用binlog日志max_binlog_size&#x3D;数值m #指定日志文件容量，默认1G,文件到1G，生成新文件 修改配置1234vim /etc/my.cnf[mysqld]server_id=88 # 新增log-bin # 新增 1systemctl restart mysqld 查看master状态123456mysql&gt; show master status;+------------------------+----------+--------------+------------------+-------------------+| File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |+------------------------+----------+--------------+------------------+-------------------+| centos07-12-bin.000001 | 154 | | | |+------------------------+----------+--------------+------------------+-------------------+ 日志存放路径123ls /var/lib/mysqlcentos07-12-bin.index # 索引文件centos07-12-bin.000001 #第一个二进制日志 1234[root@centos07-12 mybak]# cat /var/lib/mysql/centos07-12-bin.index./centos07-12-bin.000001./centos07-12-bin.000002./centos07-12-bin.000003 指定binlog日志目录123456789mkdir /mysqlbinlogs/ chown -R mysql:mysql /mysqlbinlogs/vim /etc/my.cnf[mysqld]server_id=88 # 新增log-bin=/mysqlbinlogs/ # 新增 , 日志目录必须自己创建systemctl restart mysqld 手动生成新的日志文件的方法 重启服务1systemctl restart mysqld # 重启服务，生成新日志 登录状态，刷新日志1mysql&gt; flush logs; 命令行下执行SQL1mysql -uroot -p123456 -e &quot;flush logs&quot; 数据备份后，刷新日志1mysqldump -uroot -p123456 --all-databases &gt; /mybak/alldb.sql --flush-logss 清理日志删除指定编号之前的binlog日志文件purge master logs to “binlog文件名”1purge master logs to &quot;centos07-12-bin.000003&quot;; 删除所有binlog日志，重建新日志1reset master; 查看binlog Position, 有数据变化后，position的值变化12345678910111213141516171819202122mysql&gt; show master status;+------------------------+----------+--------------+------------------+-------------------+| File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |+------------------------+----------+--------------+------------------+-------------------+| centos07-12-bin.000001 | 154 | | | |+------------------------+----------+--------------+------------------+-------------------+mysql&gt; insert into db3.user(username,uid,gid) values(&quot;dong88&quot;, 108,108);Query OK, 1 row affected (0.02 sec)mysql&gt; insert into db3.user(username,uid,gid) values(&quot;dong99&quot;, 109,109);Query OK, 1 row affected (0.01 sec)mysql&gt; insert into db3.user(username,uid,gid) values(&quot;dong77&quot;, 107,107);Query OK, 1 row affected (0.01 sec)mysql&gt; show master status;+------------------------+----------+--------------+------------------+-------------------+| File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |+------------------------+----------+--------------+------------------+-------------------+| centos07-12-bin.000001 | 1000 | | | |+------------------------+----------+--------------+------------------+-------------------+ 查看 binlog 日志1mysqlbinlog --no-defaults /var/lib/mysql/centos07-12-bin.000001 使用binlog日志恢复数据命令格式：mysqlbinlog centos07-12-bin.000001 |mysql -uroot -p12345612345# 将binlog传给要恢复的主机, 主机：12scp /var/lib/mysql/centos07-12-bin.000001 root@192.168.1.22:~# 恢复数据的主机，主机22mysqlbinlog --no-defaults centos07-12-bin.000001 |mysql -uroot -p123456 恢复指定的binlog日志内容1234命令格式：mysqlbinlog 选项 centos07-12-bin.000001 |mysql -uroot -p123456选项：偏移量 、 时间点、不加从头读到尾偏移量：--start-position=1054 --stop-position=2098时间点：--start-datetime=&quot;yyyy-mm-dd hh:mm:ss” --stop-datetime=&quot;yyyy-mm-dd hh:mm:ss&quot; 1 修改日志格式日志格式类型：1231、报表模式-statement 2、row-模式 3、混合模式-mixed 默认日志格式：binlog_format - 行模式123456789101112131415161718192021222324252627mysql&gt; show variables like &#x27;%binlog%&#x27;;+--------------------------------------------+----------------------+| Variable_name | Value |+--------------------------------------------+----------------------+| binlog_cache_size | 32768 || binlog_checksum | CRC32 || binlog_direct_non_transactional_updates | OFF || binlog_error_action | ABORT_SERVER || binlog_format | ROW || binlog_group_commit_sync_delay | 0 || binlog_group_commit_sync_no_delay_count | 0 || binlog_gtid_simple_recovery | ON || binlog_max_flush_queue_time | 0 || binlog_order_commits | ON || binlog_row_image | FULL || binlog_rows_query_log_events | OFF || binlog_stmt_cache_size | 32768 || binlog_transaction_dependency_history_size | 25000 || binlog_transaction_dependency_tracking | COMMIT_ORDER || innodb_api_enable_binlog | OFF || innodb_locks_unsafe_for_binlog | OFF || log_statements_unsafe_for_binlog | ON || max_binlog_cache_size | 18446744073709547520 || max_binlog_size | 1073741824 || max_binlog_stmt_cache_size | 18446744073709547520 || sync_binlog | 1 |+--------------------------------------------+----------------------+ 修改binlog模式1234567891011121314151617181920212223# 修改模式vim /etc/my.cnf[mysqld]binlog_format=mixed#重启systemctl restart mysqld#查看修改是否成show variables like &#x27;binlog_format&#x27;;+---------------+-------+| Variable_name | Value |+---------------+-------+| binlog_format | MIXED |+---------------+-------+# 插入4条数据insert into db3.user(username,uid,gid) values(&quot;dong66&quot;, 106,106)insert into db3.user(username,uid,gid) values(&quot;dong66&quot;, 106,106)insert into db3.user(username,uid,gid) values(&quot;dong66&quot;, 106,106)insert into db3.user(username,uid,gid) values(&quot;dong66&quot;, 106,106)#新生成binlog 123456#现在binlog中能看到sql语句了mysqlbinlog --no-defaults /var/lib/mysql/centos07-12-bin.000002 |grep insertinsert into db3.user(username,uid,gid) values(&quot;dong66&quot;, 106,106)insert into db3.user(username,uid,gid) values(&quot;dong66&quot;, 106,106)insert into db3.user(username,uid,gid) values(&quot;dong66&quot;, 106,106)insert into db3.user(username,uid,gid) values(&quot;dong66&quot;, 106,106) 恢复delete前的数据12mysqlbinlog --no-defaults /var/lib/mysql/centos07-12-bin.000002 |grep deletedelete from db3.user where uid=106 查找偏移量 \\查找时间1mysqlbinlog --no-defaults /var/lib/mysql/centos07-12-bin.000002 使用位置或者时间，恢复数据 123mysqlbinlog --no-defaults --start-position=325 --stop-position=489 centos07-12-bin.000001 |mysql -uroot -p123456mysqlbinlog --no-defaults --start-datetime=&quot;2023-09-13 13:07:31&quot; --stop-datetime=&quot;2023-09-13 13:07:32&quot; centos07-12-bin.000001 |mysql -uroot -p123456","categories":[{"name":"mysql","slug":"mysql","permalink":"https://dbbruce.github.io/categories/mysql/"}],"tags":[]},{"title":"数据完全备份","slug":"mysql/数据完全备份","date":"2017-02-10T08:30:58.000Z","updated":"2023-12-05T03:17:02.000Z","comments":true,"path":"2017/02/10/mysql/数据完全备份/","link":"","permalink":"https://dbbruce.github.io/2017/02/10/mysql/%E6%95%B0%E6%8D%AE%E5%AE%8C%E5%85%A8%E5%A4%87%E4%BB%BD/","excerpt":"数据备份方式1.物理备份和恢复 冷备: cp、tar123cp -r /var/lib/mysql /mysql.bak或者tar -zcvf /root/mysql.tar.gz /var/lib/mysql/*","text":"数据备份方式1.物理备份和恢复 冷备: cp、tar123cp -r /var/lib/mysql /mysql.bak或者tar -zcvf /root/mysql.tar.gz /var/lib/mysql/* 停止服务12345systemctl stop mysqld``` - 清空 /var/lib/mysql目录```shellrm -fr /var/lib/mysql 将备份的文件恢复到&#x2F;var&#x2F;lib&#x2F;mysql1cp -r mysql /var/lib/mysql 修改为mysql 权限1chown -R mysql:mysql /var/lib/mysql 启动mysql1systemctl start mysqld 2.逻辑备份和恢复 备份 - mysqldump命令格式：1mysqldump -uroot -p密码 库名 &gt; 目录/xxx.sql 12345备份时库名表示方式- --all-databases 或-A //所有库- 数据库名 //单个库- 数据库名 表名 //单张表-B 数据库1 数据库2 //多个库 1234mysqldump -uroot -p123456 --all-databases &gt; /mybak/alldb.sqlmysqldump -uroot -p123456 db1 &gt; /mybak/db1.sqlmysqldump -uroot -p123456 db1 user &gt; /mybak/db1_user.sqlmysqldump -uroot -p123456 -B db1 db2 &gt; /mybak/db1_2.sql 恢复 - 命令格式：1mysql -uroot -p密码 [库名] &lt; 目录/xxx.sql 123create database db3 default charset=utf8;mysql -uroot -p123456 db3 &lt; db3.sql 数据备份策略 完全备份 - 备份所有数据 增量备份 - 备份上次备份后，所有新产生的数振 差异备份 - 备份完全备份后，所有新产生的数据","categories":[{"name":"mysql","slug":"mysql","permalink":"https://dbbruce.github.io/categories/mysql/"}],"tags":[]},{"title":"用户授权","slug":"mysql/用户授权","date":"2017-02-10T08:00:58.000Z","updated":"2023-12-05T03:07:40.000Z","comments":true,"path":"2017/02/10/mysql/用户授权/","link":"","permalink":"https://dbbruce.github.io/2017/02/10/mysql/%E7%94%A8%E6%88%B7%E6%8E%88%E6%9D%83/","excerpt":"1.grant授权 格式123grant 权限列表 on 库名 to 用户名@&quot;客户端地址&quot; identified by &quot;密码&quot; //授权用户密码 with grant option; //有授权权限,可选项 权限列表：12345all //所有权限usage //无权限select , update, insert //个别权限select, update(字段1,....,字段N) //指定字段grant //授权权限 库名123\\*.\\* //所有库所有表库名.* // 一个库库名.表名 //一张表 用户名12授权时自定义 要有标识性存储在mysql库的user表里 客户端地址1234% // 所有主机192.168.4.% // 网段内的所有主机192.168.4.1 // 1台主机localhost // 数据库服务器本 12grant all on db3.* to dong1@&quot;%&quot; identified by &quot;123456&quot;;grant select,insert, update(password, uid) on db3.user to dong2@&quot;%&quot; identified by &quot;123456&quot;;","text":"1.grant授权 格式123grant 权限列表 on 库名 to 用户名@&quot;客户端地址&quot; identified by &quot;密码&quot; //授权用户密码 with grant option; //有授权权限,可选项 权限列表：12345all //所有权限usage //无权限select , update, insert //个别权限select, update(字段1,....,字段N) //指定字段grant //授权权限 库名123\\*.\\* //所有库所有表库名.* // 一个库库名.表名 //一张表 用户名12授权时自定义 要有标识性存储在mysql库的user表里 客户端地址1234% // 所有主机192.168.4.% // 网段内的所有主机192.168.4.1 // 1台主机localhost // 数据库服务器本 12grant all on db3.* to dong1@&quot;%&quot; identified by &quot;123456&quot;;grant select,insert, update(password, uid) on db3.user to dong2@&quot;%&quot; identified by &quot;123456&quot;; 2.相关命令 登录用户使用 命令 作用 select user(); 显示登录用户名及客户端地址 show grants; 用户显示自身访问权限 show grants for 用户@”客户端地址”; 管理员查看已有授权用户权限 set password&#x3D;password(“密码”); 授权用户连接后修改连接密码 set password for 用户名@”客户端地址”&#x3D;password(“密码”); 管理员重置授权用户连接密码 drop user 用户@”客户端地址”; 删除授权用户(必须有管理员权限) 3.授权库mysql user表 记录已有的授权用户及权限1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950mysql&gt; desc user;+------------------------+-----------------------------------+------+-----+-----------------------+-------+| Field | Type | Null | Key | Default | Extra |+------------------------+-----------------------------------+------+-----+-----------------------+-------+| Host | char(60) | NO | PRI | | || User | char(32) | NO | PRI | | || Select_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Insert_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Update_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Delete_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Create_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Drop_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Reload_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Shutdown_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Process_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || File_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Grant_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || References_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Index_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Alter_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Show_db_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Super_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Create_tmp_table_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Lock_tables_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Execute_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Repl_slave_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Repl_client_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Create_view_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Show_view_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Create_routine_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Alter_routine_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Create_user_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Event_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Trigger_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Create_tablespace_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || ssl_type | enum(&#x27;&#x27;,&#x27;ANY&#x27;,&#x27;X509&#x27;,&#x27;SPECIFIED&#x27;) | NO | | | || ssl_cipher | blob | NO | | NULL | || x509_issuer | blob | NO | | NULL | || x509_subject | blob | NO | | NULL | || max_questions | int(11) unsigned | NO | | 0 | || max_updates | int(11) unsigned | NO | | 0 | || max_connections | int(11) unsigned | NO | | 0 | || max_user_connections | int(11) unsigned | NO | | 0 | || plugin | char(64) | NO | | mysql_native_password | || authentication_string | text | YES | | NULL | || password_expired | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || password_last_changed | timestamp | YES | | NULL | || password_lifetime | smallint(5) unsigned | YES | | NULL | || account_locked | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | |+------------------------+-----------------------------------+------+-----+-----------------------+-------+ db表 记录已有授权用户对数据库的访向权限123456789101112131415161718192021222324252627mysql&gt; desc db;+-----------------------+---------------+------+-----+---------+-------+| Field | Type | Null | Key | Default | Extra |+-----------------------+---------------+------+-----+---------+-------+| Host | char(60) | NO | PRI | | || Db | char(64) | NO | PRI | | || User | char(32) | NO | PRI | | || Select_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Insert_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Update_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Delete_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Create_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Drop_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Grant_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || References_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Index_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Alter_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Create_tmp_table_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Lock_tables_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Create_view_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Show_view_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Create_routine_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Alter_routine_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Execute_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Event_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | || Trigger_priv | enum(&#x27;N&#x27;,&#x27;Y&#x27;) | NO | | N | |+-----------------------+---------------+------+-----+---------+-------+ tables_priv表 记录已有授权用户对表的访问权限12345678910111213mysql&gt; desc tables_priv;+-------------+-----------------------------------------------------------------------------------------------------------------------------------+------+-----+-------------------+-----------------------------+| Field | Type | Null | Key | Default | Extra |+-------------+-----------------------------------------------------------------------------------------------------------------------------------+------+-----+-------------------+-----------------------------+| Host | char(60) | NO | PRI | | || Db | char(64) | NO | PRI | | || User | char(32) | NO | PRI | | || Table_name | char(64) | NO | PRI | | || Grantor | char(93) | NO | MUL | | || Timestamp | timestamp | NO | | CURRENT_TIMESTAMP | on update CURRENT_TIMESTAMP || Table_priv | set(&#x27;Select&#x27;,&#x27;Insert&#x27;,&#x27;Update&#x27;,&#x27;Delete&#x27;,&#x27;Create&#x27;,&#x27;Drop&#x27;,&#x27;Grant&#x27;,&#x27;References&#x27;,&#x27;Index&#x27;,&#x27;Alter&#x27;,&#x27;Create View&#x27;,&#x27;Show view&#x27;,&#x27;Trigger&#x27;) | NO | | | || Column_priv | set(&#x27;Select&#x27;,&#x27;Insert&#x27;,&#x27;Update&#x27;,&#x27;References&#x27;) | NO | | | |+-------------+-----------------------------------------------------------------------------------------------------------------------------------+------+-----+-------------------+-----------------------------+ columns_priv表 记录已有授权用户对字段的访问权限123456789101112mysql&gt; desc columns_priv;+-------------+----------------------------------------------+------+-----+-------------------+-----------------------------+| Field | Type | Null | Key | Default | Extra |+-------------+----------------------------------------------+------+-----+-------------------+-----------------------------+| Host | char(60) | NO | PRI | | || Db | char(64) | NO | PRI | | || User | char(32) | NO | PRI | | || Table_name | char(64) | NO | PRI | | || Column_name | char(64) | NO | PRI | | || Timestamp | timestamp | NO | | CURRENT_TIMESTAMP | on update CURRENT_TIMESTAMP || Column_priv | set(&#x27;Select&#x27;,&#x27;Insert&#x27;,&#x27;Update&#x27;,&#x27;References&#x27;) | NO | | | |+-------------+----------------------------------------------+------+-----+-------------------+-----------------------------+ 4.撤销权限，删除用户权限1revoke 权限列表 on 库名 from 用户名@&quot;客户端地址&quot;; 1234567891011121314151617181920mysql&gt; select host,user from user;+-----------+---------------+| host | user |+-----------+---------------+| % | dong1 || % | dong2 || % | root || localhost | mysql.session || localhost | mysql.sys || localhost | root |+-----------+---------------+6 rows in set (0.00 sec)mysql&gt; show grants for dong1@&quot;%&quot;;+------------------------------------------------+| Grants for dong1@% |+------------------------------------------------+| GRANT USAGE ON *.* TO &#x27;dong1&#x27;@&#x27;%&#x27; || GRANT ALL PRIVILEGES ON `db3`.* TO &#x27;dong1&#x27;@&#x27;%&#x27; |+------------------------------------------------+ 12345678revoke grant ON `db3`.* TO &#x27;dong1&#x27;@&#x27;%&#x27;;mysql&gt; show grants for dong1@&#x27;%&#x27;;+-----------------------------------+| Grants for dong1@% |+-----------------------------------+| GRANT USAGE ON *.* TO &#x27;dong1&#x27;@&#x27;%&#x27; | #没有权限，但是存在用户+-----------------------------------+ 5.删除授权用户drop user dong1@”%”; 123456789101112mysql&gt; drop user dong1@&quot;%&quot;;mysql&gt; select host,user from user;+-----------+---------------+| host | user |+-----------+---------------+| % | dong2 || % | root || localhost | mysql.session || localhost | mysql.sys || localhost | root |+-----------+---------------+ 6.管理root密码 恢复密码(忘记密码) 注意：必须要用linux的管理才能重置密码 ，root 停止MySQL服务程序1systemctl stop mysqld 跳过授权表启动MySQL服务程序12345678vim /etc/my.cnf[mysqld]skip-grant-tables # 添加这一行# 注释下面2行，不注释，服务启动报错。#validate_password_policy=0# validate_password length=6 启动mysql服务1systemctl start mysqld 修改root密码直接mysql不需要要密码，就能进去。12345678910111213141516# 查询密码select host,user, authentication_string from mysql.user;+-----------+---------------+-------------------------------------------+| host | user | authentication_string |+-----------+---------------+-------------------------------------------+| localhost | root | *6BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 || localhost | mysql.session | *THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE || localhost | mysql.sys | *THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE || % | root | *8D16F6057F98A5BA2D5DFBA37B71DF1DF38A9969 || % | dong2 | *6BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 |+-----------+---------------+-------------------------------------------+update mysql.user set authentication_string=password(&quot;123456&quot;) where user=&quot;root&quot;;flush privileges; 以正常方式重启MySQL服务程序1234567[mysqld]#skip-grant-tablessecure_file_priv=/mysqldatafilesvalidate_password_length=6validate_password_policy=0 1systemctl restart mysqld 修改密码(重密码) 注意：必须要用linux的管理才能重置密码 ，root 12345mysqladmin -hlocalhost -uroot -p password &quot;123456&quot;Enter password: # 输入旧密码# 下面是提示信息，表示不安全，但是不影响你修改密码mysqladmin: [Warning] Using a password on the command line interface can be insecure.Warning: Since password will be sent to server in plain text, use ssl connection to ensure password safety.","categories":[{"name":"mysql","slug":"mysql","permalink":"https://dbbruce.github.io/categories/mysql/"}],"tags":[]},{"title":"管理表记录","slug":"mysql/管理表记录","date":"2017-02-10T07:04:52.000Z","updated":"2023-12-05T03:07:39.000Z","comments":true,"path":"2017/02/10/mysql/管理表记录/","link":"","permalink":"https://dbbruce.github.io/2017/02/10/mysql/%E7%AE%A1%E7%90%86%E8%A1%A8%E8%AE%B0%E5%BD%95/","excerpt":"1.insert添加1条记录给所有列赋值insert into 表名 values (字段值列表) ; 添加多条记录给所有列赋值insert into表名 values (字段值列表),(字段值列表),(字段值列表) ; 添加1条记录给指定的列赋值insert into 表名(字段名列表) values (字段值列表); 添加多条记录给指定的列赋值insert 表名(字段名列表) values (字段值列表),(字段值列表);into","text":"1.insert添加1条记录给所有列赋值insert into 表名 values (字段值列表) ; 添加多条记录给所有列赋值insert into表名 values (字段值列表),(字段值列表),(字段值列表) ; 添加1条记录给指定的列赋值insert into 表名(字段名列表) values (字段值列表); 添加多条记录给指定的列赋值insert 表名(字段名列表) values (字段值列表),(字段值列表);into 2.updateupdate 库.表 set 字段名&#x3D;值 ，字段名&#x3D;值 [ where 条件 ]; 3.deletedelete from 库.表 [ where 条件 ] 4.范围匹配innot inbetween 数字 and 数字distinct 字段名 1234select username from db3.user where username in ( &quot;sync&quot;,&quot;daemon&quot;);select username , shell from db3.user where shell not in (&quot;/bin/bash&quot;,&quot;/sbin/nologin&quot;);select id , username , uid from db3.user where id between 10 and 20;select distinct gid from db3.user; 5.null匹配空( null) is null匹配非空(不是nul) is not null 12select username,uid from db3.user where username is not null ;select username,uid from db3.user where username is null; 6.逻辑匹配 or 逻辑或 多个匹配条件，某一个条件成立即可 and 逻辑与 多个匹配条件，必须同时成立 !或not 逻辑非 取反 !&#x3D; not in is not null 12select username,uid from db3.user where db3. user where username=&quot;root&quot; and uid=1;select username,uid from db3.user where db3. user where username=&quot;root&quot; or uid=1; 7.高级匹配条件模糊查询 Likewhere 字段名 like 表达式 _(下划线) 表示1个字符 %(百分号) 表示O~n个字符 1234select username from db3.user where username like &#x27;____&#x27;; # 包含4个字符select username from db3.user where username like &#x27;__&#x27;; # 包含2个字符select username from db3.user where username like &#x27;%a%&#x27;; #包含aselect username from db3.user where username like &#x27;__%__&#x27;; #至少4个字符 8.正则匹配 regexpwhere 字段名 regexp 正则表达式; 1select username from db3.user where username regexp &#x27;^a|^t&#x27;; 9.四则运算 &#x2F;12345# 2019减去age，新字段命名为startselect username, 2019 - age start from db3.user where username=&quot;root&quot;; # uid 小于5都加1update db3.user set uid=uid+1 where uid &lt; 5; 10.操作查询结果(对查询后的数据做处理 )聚集函数(mysql服务内置的对数据做统计的命令)avg(字段名) &#x2F;&#x2F;统计字段平均值sum(字段名) &#x2F;&#x2F;统计字段之和min(字段名) &#x2F;&#x2F;统计字段最小值max(字段名) &#x2F;&#x2F;统计字段最大值count(字段名) &#x2F;&#x2F;统计字段值个数 1234select avg(id) from user;select max(id) from user;select sum(id) from user;select count(id) from user; 11.查询结果排序order by 字段名 asc | desc; 12.查询结果分组group by 字段名 13.查询结果过滤 having先查出shell字段包含nologin的记录，再过滤查询的结果中uid小于20的记录； 1select * from user where shell like &quot;%nologin&quot; having uid&lt;20; 14.限制查询结果显示行数 limit123select * from user where shell like &quot;%nologin&quot; limit 1;select * from user where shell like &quot;%nologin&quot; limit 2, 5;","categories":[{"name":"mysql","slug":"mysql","permalink":"https://dbbruce.github.io/categories/mysql/"}],"tags":[]},{"title":"数据导入导出-","slug":"mysql/数据导入导出","date":"2017-02-10T06:04:52.000Z","updated":"2023-12-05T03:07:40.000Z","comments":true,"path":"2017/02/10/mysql/数据导入导出/","link":"","permalink":"https://dbbruce.github.io/2017/02/10/mysql/%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA/","excerpt":"0.这个很重要，导入导出需要先关闭，selinux,否则会报各种权限问题错误：(Errcode: 13 - Permission denied) 12mysql&gt; select * from db3.user limit 1 into outfile &quot;/mysqldatafiles/user1.txt&quot;;ERROR 1 (HY000): Can&#x27;t create/write to file &#x27;/mysqldatafiles/user1.txt&#x27; (Errcode: 13 - Permission denied) 解决： 123setenforce 0vim /etc/selinux/configSELINUX=disabled 1.数据导入与导出默认检索路径 查看默认导入导出路径默认路径：secure_file_priv - &#x2F;var&#x2F;lib&#x2F;mysql-files&#x2F; 1234567891011121314151617181920212223242526272829303132333435mysql&gt; show variables like &#x27;%file%&#x27;;+---------------------------------------+-------------------------------------+| Variable_name | Value |+---------------------------------------+-------------------------------------+| character_set_filesystem | binary || core_file | OFF || ft_stopword_file | (built-in) || general_log_file | /var/lib/mysql/centos07-12.log || init_file | || innodb_buffer_pool_filename | ib_buffer_pool || innodb_data_file_path | ibdata1:12M:autoextend || innodb_disable_sort_file_cache | OFF || innodb_file_format | Barracuda || innodb_file_format_check | ON || innodb_file_format_max | Barracuda || innodb_file_per_table | ON || innodb_log_file_size | 50331648 || innodb_log_files_in_group | 2 || innodb_open_files | 2000 || innodb_temp_data_file_path | ibtmp1:12M:autoextend || keep_files_on_create | OFF || large_files_support | ON || local_infile | ON || lower_case_file_system | OFF || myisam_max_sort_file_size | 9223372036853727232 || open_files_limit | 5000 || performance_schema_max_file_classes | 80 || performance_schema_max_file_handles | 32768 || performance_schema_max_file_instances | -1 || pid_file | /var/run/mysqld/mysqld.pid || relay_log_info_file | relay-log.info || secure_file_priv | /var/lib/mysql-files/ || slow_query_log_file | /var/lib/mysql/centos07-12-slow.log || validate_password_dictionary_file | |+---------------------------------------+-------------------------------------+","text":"0.这个很重要，导入导出需要先关闭，selinux,否则会报各种权限问题错误：(Errcode: 13 - Permission denied) 12mysql&gt; select * from db3.user limit 1 into outfile &quot;/mysqldatafiles/user1.txt&quot;;ERROR 1 (HY000): Can&#x27;t create/write to file &#x27;/mysqldatafiles/user1.txt&#x27; (Errcode: 13 - Permission denied) 解决： 123setenforce 0vim /etc/selinux/configSELINUX=disabled 1.数据导入与导出默认检索路径 查看默认导入导出路径默认路径：secure_file_priv - &#x2F;var&#x2F;lib&#x2F;mysql-files&#x2F; 1234567891011121314151617181920212223242526272829303132333435mysql&gt; show variables like &#x27;%file%&#x27;;+---------------------------------------+-------------------------------------+| Variable_name | Value |+---------------------------------------+-------------------------------------+| character_set_filesystem | binary || core_file | OFF || ft_stopword_file | (built-in) || general_log_file | /var/lib/mysql/centos07-12.log || init_file | || innodb_buffer_pool_filename | ib_buffer_pool || innodb_data_file_path | ibdata1:12M:autoextend || innodb_disable_sort_file_cache | OFF || innodb_file_format | Barracuda || innodb_file_format_check | ON || innodb_file_format_max | Barracuda || innodb_file_per_table | ON || innodb_log_file_size | 50331648 || innodb_log_files_in_group | 2 || innodb_open_files | 2000 || innodb_temp_data_file_path | ibtmp1:12M:autoextend || keep_files_on_create | OFF || large_files_support | ON || local_infile | ON || lower_case_file_system | OFF || myisam_max_sort_file_size | 9223372036853727232 || open_files_limit | 5000 || performance_schema_max_file_classes | 80 || performance_schema_max_file_handles | 32768 || performance_schema_max_file_instances | -1 || pid_file | /var/run/mysqld/mysqld.pid || relay_log_info_file | relay-log.info || secure_file_priv | /var/lib/mysql-files/ || slow_query_log_file | /var/lib/mysql/centos07-12-slow.log || validate_password_dictionary_file | |+---------------------------------------+-------------------------------------+ 修改12mkdir /mysqldatafileschown mysql /mysqldatafiles 1234vim /etc/my.cnfsecure_file_priv=/mysqldatafiles systemctl restart mysqld mysql中执行linux命令123456mysql&gt; system ls -l /var/总用量 8drwxr-xr-x. 2 root root 19 8月 14 15:00 accountdrwxr-xr-x. 2 root root 6 4月 11 2018 admdrwxr-xr-x. 7 root root 72 8月 14 15:00 cachedrwxr-xr-x. 2 root root 6 10月 2 2020 crash 重新登录下123456mysql&gt; show variables like &#x27;%secure_file_priv%&#x27;;+------------------+------------------+| Variable_name | Value |+------------------+------------------+| secure_file_priv | /mysqldatafiles/ |+------------------+------------------+ 2.数据导入 命令格式 infile “目录名&#x2F;文件名” # 指定导入的文件目录； fields terminated by “分隔符” # 列分隔符； lines terminated by “\\n”; #行分隔符，一般都\\n； 1load data infile &quot;目录名/文件名&quot; into table 库名.表名 fields terminated by &quot;分隔符&quot; lines terminated by &quot;\\n&quot;; 数据导入步骤 建库 建表(表结构根据文件内容创建) 把文件拷贝到检索目录下 导入数据 例子1234567891011create table db3.user( username char(50), password char(1), uid int, gid int, comment varchar(150), homedir char(150) , shell char( 50));load data infile &quot;/mysqldatafiles/passwd2&quot; into table db3.user fields terminated by &quot;:&quot; lines terminated by &quot;\\n&quot;; 如果导入报错，提示权限问题，加local错误提示：12mysql&gt; load data infile &quot;/mysqldatafiles/passwd2&quot; into table db3.user fields terminated by &quot;:&quot; lines terminated by &quot;\\n&quot;;ERROR 13 (HY000): Can&#x27;t get stat of &#x27;/mysqldatafiles/passwd2&#x27; (Errcode: 13 - Permission denied) 解决方式：1load data local infile &quot;/mysqldatafiles/passwd2&quot; into table db3.user fields terminated by &quot;:&quot; lines terminated by &quot;\\n&quot;; 3.数据导出 命令格式导出目录只要存在就可以 select 查询命令 into outfile”目录&#x2F;文件名”; select 查询命令 into outfile”目录&#x2F;文件名” fields terminated by”符号” select 查询命今 into outfile”目录&#x2F;文件名” fields terminated by “符号” lines terminated by “符号”; 例子123mysql&gt; select * from db3.user limit 2 into outfile &quot;/mysqldatafiles/user1.txt&quot;;mysql&gt; select * from db3.user limit 2 into outfile &quot;/mysqldatafiles/user2.txt&quot; fields terminated by &quot;###&quot; lines terminated by &quot;||||&quot;; 1234567[root@centos07-12 mysqldatafiles]# cat user1.txtroot x 0 0 root /root /bin/bashbin x 1 1 bin /bin /sbin/nologin [root@centos07-12 mysqldatafiles]# cat user2.txtroot###x###0###0###root###/root###/bin/bash||||bin###x###1###1###bin###/bin###/sbin/nologin||||","categories":[{"name":"mysql","slug":"mysql","permalink":"https://dbbruce.github.io/categories/mysql/"}],"tags":[]},{"title":"MySQL键值(索引)","slug":"mysql/MySQL键值(索引)","date":"2017-02-10T05:14:52.000Z","updated":"2023-12-05T03:07:40.000Z","comments":true,"path":"2017/02/10/mysql/MySQL键值(索引)/","link":"","permalink":"https://dbbruce.github.io/2017/02/10/mysql/MySQL%E9%94%AE%E5%80%BC(%E7%B4%A2%E5%BC%95)/","excerpt":"1.索引 类似于书的目录，排序的方式 对表中字段值进行排序 索引类型包括:Btree、B+tree 、hash，默认Btre（二叉树） 索引优点 通过创建唯一性索引，可以保证数据库表中每一行数据的唯一性 可以加快数据的查询速度 索引缺点 当对表中的数据进行增加、删除和修改的时候，索引也要动态的调整，降低了数据的维护速度 索引需要占物理空间","text":"1.索引 类似于书的目录，排序的方式 对表中字段值进行排序 索引类型包括:Btree、B+tree 、hash，默认Btre（二叉树） 索引优点 通过创建唯一性索引，可以保证数据库表中每一行数据的唯一性 可以加快数据的查询速度 索引缺点 当对表中的数据进行增加、删除和修改的时候，索引也要动态的调整，降低了数据的维护速度 索引需要占物理空间 2.普通索引 index 使用规则 1.一个表中可以有多个index字段 2.字段的值允许重复，且可以赋NULL值 3.通常把做为查询条件的字段设置为index字段 4.index字段标志是 MUL 创建索引建表时创建索引 index(字段名) 12345678910111213141516create table db1.t9( name1 char(5), name2 char(5), name3 char(5), index(name1), index(name2))mysql&gt; desc t9;+-------+---------+------+-----+---------+-------+| Field | Type | Null | Key | Default | Extra |+-------+---------+------+-----+---------+-------+| name1 | char(5) | YES | MUL | NULL | || name2 | char(5) | YES | MUL | NULL | || name3 | char(5) | YES | | NULL | |+-------+---------+------+-----+---------+-------+ 已有表创建索引 create index 索引名 on 表名(字段名); 1create index idx_name3 t9(name3); 查看所有字段 show index from 表名 \\G; 123456789101112131415mysql&gt; show index from t9 \\G;*************************** 1. row *************************** Table: t9 Non_unique: 1 Key_name: name1 Seq_in_index: 1 Column_name: name1 Collation: A Cardinality: 0 Sub_part: NULL Packed: NULL Null: YES Index_type: BTREE Comment:Index_comment: 删除索引 drop index 索引名 on 库名.表名; 1mysql&gt; drop index name1 on t9; 3.唯一索引 unique12CREATE UNIQUE INDEX index_name ON table_name (index_column1, index_column2,...); 1234567CREATE TABLE table_name( col1 col_definition, col2 col_definition, ... [CONSTRAINT constraint_name] UNIQUE Key (column_name(s)) ); 1DROP INDEX idx_username ON user; 4.全文索引 fulltext1234567891011CREATE TABLE articles ( id INT UNSIGNED AUTO_INCREMENT NOT NULL PRIMARY KEY, title VARCHAR (200), body TEXT, FULLTEXT (title, body) WITH PARSER ngram) ENGINE = INNODB DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;文章表&#x27;;INSERT INTO articles (title, body) VALUES (&#x27;弘扬正能量&#x27;, &#x27;贯彻党的18大精神&#x27;);INSERT INTO articles (title, body) VALUES (&#x27;北京冬奥会&#x27;, &#x27;2022年北京冬奥会于2022年2月20日闭幕啦&#x27;);INSERT INTO articles (title, body) VALUES (&#x27;MySQL Tutorial&#x27;, &#x27;DBMS stands for Database&#x27;);INSERT INTO articles (title, body) VALUES (&#x27;IBM History&#x27;, &#x27;DB2 history for IBM&#x27;); 1ALTER TABLE articles ADD FULLTEXT INDEX title_body_index (title,body) WITH PARSER ngram; 直接删除全文索引 1DROP INDEX full_idx_name ON db_name.table_name; 使用 alter table 删除全文索引 1ALTER TABLE db_name.table_name DROP INDEX full_idx_name; 5.主键 primary key 使用规则 字段值不允许重复，且不允许赋NULL值 一个表中只能有一个primary key字段 多个字段都作为主键，称为复合主键，必须一起创建 主键字段的标志是PRI 主键通常与 auto increment 连用 通常把表中唯一标识记录的字段设置为主键 创建索引建表时创建主键 primary key 123456789101112create table db1.t10( name1 char(5) primary key, name2 char(5), name3 char(5));create table db1.t10( name1 char(5), name2 char(5), name3 char(5), primary key(name1)); 已有表创建主键 alter table 库.表 add primary key(字段名); 12alter table db1.t8 add primary key(name1);alter table db1.t8 add primary key(name1, name2, name3); 12345678mysql&gt; desc t8;+-------+-----------------------------------+------+-----+---------+-------+| Field | Type | Null | Key | Default | Extra |+-------+-----------------------------------+------+-----+---------+-------+| name1 | char(5) | NO | PRI | dong | || sex | enum(&#x27;man&#x27;,&#x27;girl&#x27;) | YES | | NULL | || aihao | set(&#x27;eat&#x27;,&#x27;game&#x27;,&#x27;music&#x27;,&#x27;money&#x27;) | YES | | NULL | |+-------+-----------------------------------+------+-----+---------+-------+ 复合主键 123456789101112131415mysql&gt; create table db1.t11( -&gt; name1 char(5), -&gt; name2 char(5), -&gt; name3 char(5), -&gt; primary key(name1, name2, name3) -&gt; );mysql&gt; desc t11;+-------+---------+------+-----+---------+-------+| Field | Type | Null | Key | Default | Extra |+-------+---------+------+-----+---------+-------+| name1 | char(5) | NO | PRI | NULL | || name2 | char(5) | NO | PRI | NULL | || name3 | char(5) | NO | PRI | NULL | |+-------+---------+------+-----+---------+-------+ 删除主键 1alter table db1.t11 drop primary key; 与auto_increment连用，自增 1234567891011121314151617181920212223create table t12( age int primary key auto_increment, name char(5), sec_name char(5));mysql&gt; insert into t12(name, sec_name) values(&quot;dong&quot;, &quot;xb&quot;);mysql&gt; select * from t12;+-----+------+----------+| age | name | sec_name |+-----+------+----------+| 1 | dong | xb |+-----+------+----------+``` 从100开始自增```mysqlcreate table t13( age int primary key auto_increment, name char(5), sec_name char(5))auto_increment = 100; 6.外键 foreign key-外键功能 插入记录时，字段值在另一个表字段值范围内选择 使用规则 表存储引擎必须是innodb 字段类型要一致 被参照字段必须要是索引类型的 种(primary key) 创建索引建表时创建主键 references 另一个表(字段名) 限制方式； 限制方式：1、同步更新 &#x3D; on update cascade ; 2、同步删除 &#x3D; on delete cascade; 12345678910111213141516create table ygb( yg_id int primary key auto_increment, name char(20), sex enum(&quot;boy&quot;, &quot;girl&quot;))engine =innodb;insert into ygb(name, sex) values(&quot;dong1&quot;,&quot;boy&quot;),(&quot;dong2&quot;,&quot;boy&quot;); # 注意字段名一定不要加引号create table gzb( gz_id int, pay float(7,2), foreign key(gz_id) references ygb(yg_id) on update cascade on delete cascade )engine=innodb;insert into gzb values(2, 20000);insert into gzb values(1, 10000); 验证同步更新，on update cascade123456789101112131415161718192021222324252627282930313233343536373839mysql&gt; select * from ygb;+-------+-------+------+| yg_id | name | sex |+-------+-------+------+| 1 | dong1 | boy || 2 | dong2 | boy |+-------+-------+------+mysql&gt; select * from gzb;+-------+----------+| gz_id | pay |+-------+----------+| 2 | 20000.00 || 2 | 20000.00 || 2 | 20000.00 |+-------+----------+# 更改ygb的id， 看下gzb的的id是否跟着变动mysql&gt; update ygb set yg_id=8 where yg_id=1;Query OK, 1 row affected (0.01 sec)Rows matched: 1 Changed: 1 Warnings: 0mysql&gt; select * from ygb;+-------+-------+------+| yg_id | name | sex |+-------+-------+------+| 2 | dong2 | boy || 8 | dong1 | boy |+-------+-------+------+mysql&gt; select * from gzb;+-------+----------+| gz_id | pay |+-------+----------+| 2 | 20000.00 || 2 | 20000.00 || 2 | 20000.00 || 8 | 10000.00 |+-------+----------+ 验证同步删除，on delete cascade12345678910111213141516171819202122232425262728293031323334353637383940mysql&gt; select * from ygb;+-------+-------+------+| yg_id | name | sex |+-------+-------+------+| 2 | dong2 | boy || 8 | dong1 | boy |+-------+-------+------+2 rows in set (0.20 sec)mysql&gt; select * from gzb;+-------+----------+| gz_id | pay |+-------+----------+| 2 | 20000.00 || 2 | 20000.00 || 2 | 20000.00 || 8 | 10000.00 |+-------+----------+4 rows in set (0.00 sec)# 删除ygb的id， 看下gzb的的id是否跟着变动mysql&gt; delete from ygb where yg_id=8;Query OK, 1 row affected (0.25 sec)mysql&gt; select * from ygb;+-------+-------+------+| yg_id | name | sex |+-------+-------+------+| 2 | dong2 | boy |+-------+-------+------+ mysql&gt; select * from gzb;+-------+----------+| gz_id | pay |+-------+----------+| 2 | 20000.00 || 2 | 20000.00 || 2 | 20000.00 |+-------+----------+3 rows in set (0.00 sec) 删除外键 使用外键名，删除外键，foreign key 前面就是外键名称 show create table 表名；foreign key 前面就是外键名称 alter table 表名 drop foreign key 外键名 12345678910111213mysql&gt; show create table gzb;+-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+| Table | Create Table |+-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+| gzb | CREATE TABLE `gzb` ( `gz_id` int(11) DEFAULT NULL, `pay` float(7,2) DEFAULT NULL, KEY `gz_id` (`gz_id`), CONSTRAINT `gzb_ibfk_1` FOREIGN KEY (`gz_id`) REFERENCES `ygb` (`yg_id`) ON DELETE CASCADE ON UPDATE CASCADE) ENGINE=InnoDB DEFAULT CHARSET=utf8 |+-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+mysql&gt; alter table gzb drop foreign key gzb_ibfk_1;","categories":[{"name":"mysql","slug":"mysql","permalink":"https://dbbruce.github.io/categories/mysql/"}],"tags":[]},{"title":"修改表结构(对表的修改)","slug":"mysql/修改表结构(对表的修改)","date":"2017-02-10T04:14:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2017/02/10/mysql/修改表结构(对表的修改)/","link":"","permalink":"https://dbbruce.github.io/2017/02/10/mysql/%E4%BF%AE%E6%94%B9%E8%A1%A8%E7%BB%93%E6%9E%84(%E5%AF%B9%E8%A1%A8%E7%9A%84%E4%BF%AE%E6%94%B9)/","excerpt":"1.修改表结构 格式： alter table 库名.表名 执行动作； 执行动作： 添加新字段： add 字段名 类型 [约束条件]; add 字段名 类型 [约束条件] after 字段名; add 字段名 类型 [约束条件] first; 1alter table db1.t8 add secondname varchar(5) first;","text":"1.修改表结构 格式： alter table 库名.表名 执行动作； 执行动作： 添加新字段： add 字段名 类型 [约束条件]; add 字段名 类型 [约束条件] after 字段名; add 字段名 类型 [约束条件] first; 1alter table db1.t8 add secondname varchar(5) first; 修改字段类型 修改的字段类型不能与已存储的数据冲突，比如字段已经存储字符串了，就不能改成整数了； modify 字段名 类型(宽度) [约束条件]; modify 字段名 类型(宽度) [约束条件] after 字段名; modify 字段名 类型(宽度) [约束条件] first; 1alter table db1.t8 modify secondname char(5) after name1; 修改字段名 change 源字段名 新字段名 类型(宽度) 约束条件; 1alter table db1.t8 change name name1 char(5) not NULL default &quot;dong&quot; ; 删除字段 drop 字段名; 1alter table db1.t8 drop secondname; 修改表名 rename 新表名; 1alter table db1.t8 rename t88;","categories":[{"name":"mysql","slug":"mysql","permalink":"https://dbbruce.github.io/categories/mysql/"}],"tags":[]},{"title":"mysql基础知识","slug":"mysql/mysql基础知识","date":"2017-02-10T03:14:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2017/02/10/mysql/mysql基础知识/","link":"","permalink":"https://dbbruce.github.io/2017/02/10/mysql/mysql%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/","excerpt":"1.常用的SQL命令分类 管理数据库使用SQL( 结构化查询语言 ) DDL数据定义语言 如:create、alter、 drop DML数据操作语言 如:insert、update、 delete DCL数据控制语言如 : grant、revoke DTL数据事物语言 如:commit、rollback、savepoint","text":"1.常用的SQL命令分类 管理数据库使用SQL( 结构化查询语言 ) DDL数据定义语言 如:create、alter、 drop DML数据操作语言 如:insert、update、 delete DCL数据控制语言如 : grant、revoke DTL数据事物语言 如:commit、rollback、savepoint 2.库管理命令show databases &#x2F;&#x2F;显示已有的库select user( ): &#x2F;&#x2F;显示连接用户use 库名 &#x2F;&#x2F;切换库select database( ): &#x2F;&#x2F;显示当前所在的库create database 库名 &#x2F;&#x2F;创建新库show tables &#x2F;&#x2F;显示已有的表drop database 库名 ; &#x2F;&#x2F;删除库 3.建表 语法12345```mysqlcreate table 库名.表名( 字段1 类型(宽度), 字段1 类型(宽度)) DEFAULT CHARSET=utf8; 实例1mysql&gt; create table db1.stuinfo(name char(15), homeaddr char(20)); linux上查看相关的库和表的文件 所有库存放的目录：&#x2F;var&#x2F;lib&#x2F;mysql 数据库db1，库文件：&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;db1 stuinfo表文件： 1234567[root@centos07-12 db1]# cd /var/lib/mysql/db1/[root@centos07-12 db1]# ll总用量 112-rw-r-----. 1 mysql mysql 61 9月 23 00:48 db.opt-rw-r-----. 1 mysql mysql 8598 9月 23 00:49 stuinfo.frm 表文件-rw-r-----. 1 mysql mysql 98304 9月 23 00:49 stuinfo.ibd 表文件[root@centos07-12 db1]# 4.记录（表）管理命令 select * from 库名.表名 &#x2F;&#x2F;查看表记录 insert into 库名.表名 values(值1，值2),(值1，值2); insert into 库名.表名 (字段名1，字段名2) values(值1，值2),(值1，值2); &#x2F;&#x2F;插入表记录,注意字段名一定不要加引号 update 库名.表名 set 字段&#x3D;值 where xxxx; &#x2F;&#x2F;修改表记录 delete from 表名; &#x2F;&#x2F;删除表记录,清空 drom table 表名; &#x2F;&#x2F;删除表 5.整数类型 6.浮点数单精度 存的少 float(总位数，小数位数) ，比如 999.99， 总位数5位，小数2位，float(5,2)双精度 存的多 double(总位数，小数位数),同上 1234create table t5 (name varchar(5), gz float(7,2)）defualt charset=utf8;mysql&gt; insert into t5 values(&quot;dong&quot;, 123456.78),(&quot;dong2&quot;, 999.99); # 8位提示错误ERROR 1264 (22003): Out of range value for column &#x27;gz&#x27; at row 1 7.日期时间类型 datetime - 时间范围大 范围：1000-01-01 00:00:00~9999-12-31 23:59:59格式：yyyymmddhhmmss timestamp - 时间范围小 范围：1970-01-01 00:00:00 ~ 2038-01-19 00:00:00格式：yyyymmddhhmmss 日期 date 范围:0001-01-01 ~ 9999-12-31格式:yyyymmdd 年 year 范围:1901~2155格式 :yyyy 时间 time 格式 : HHMMSS 实例12345678910111213141516171819mysql&gt; create table t7( -&gt; name char(10), -&gt; your_start year, -&gt; up_time time, -&gt; birthday date, -&gt; party datetime -&gt; );Query OK, 0 rows affected (0.10 sec)mysql&gt; insert into t7 values(&quot;dong&quot;, 1990, 083000,20191120,20190707213045); #位数够，会自动按照格式切分Query OK, 1 row affected (0.04 sec)mysql&gt; select * from t7;+------+------------+----------+------------+---------------------+| name | your_start | up_time | birthday | party |+------+------------+----------+------------+---------------------+| dong | 1990 | 08:30:00 | 2019-11-20 | 2019-07-07 21:30:45 |+------+------------+----------+------------+---------------------+1 row in set (0.01 sec) 使用函数赋值1234567891011121314151617181920212223mysql&gt; select curdate();+------------+| curdate() |+------------+| 2023-09-23 |+------------+1 row in set (0.00 sec)mysql&gt; select curtime();+-----------+| curtime() |+-----------+| 02:13:57 |+-----------+1 row in set (0.00 sec)mysql&gt; select now();+---------------------+| now() |+---------------------+| 2023-09-23 02:14:07 |+---------------------+1 row in set (0.00 sec) 1234567891011mysql&gt; insert into t7 values(&quot;bin&quot;, 2000, curtime(), curdate(), now());Query OK, 1 row affected (0.01 sec)mysql&gt; select * from t7;+------+------------+----------+------------+---------------------+| name | your_start | up_time | birthday | party |+------+------------+----------+------------+---------------------+| dong | 1990 | 08:30:00 | 2019-11-20 | 2019-07-07 21:30:45 || bin | 2000 | 02:15:58 | 2023-09-23 | 2023-09-23 02:15:58 |+------+------------+----------+------------+---------------------+2 rows in set (0.00 sec) 123456mysql&gt; select now(), year(now()), month(now()), day(now());+---------------------+-------------+--------------+------------+| now() | year(now()) | month(now()) | day(now()) |+---------------------+-------------+--------------+------------+| 2023-09-23 02:19:39 | 2023 | 9 | 23 |+---------------------+-------------+--------------+------------+ 8.枚举类型值只能在列举的范围里选择enum 单选set 多选 1234567891011121314151617181920mysql&gt; create table t8( -&gt; name char(5), -&gt; sex enum(&quot;man&quot;, &quot;girl&quot;), -&gt; aihao set(&quot;eat&quot;, &quot;game&quot;, &quot;music&quot;, &quot;money&quot;) -&gt; ) default charset=utf8;Query OK, 0 rows affected (0.84 sec)mysql&gt; insert into t8 values(&quot;dong&quot;, &quot;man&quot;, &quot;money,girl&quot;); # girl没有在爱好里，选了报错。 哈哈ERROR 1265 (01000): Data truncated for column &#x27;aihao&#x27; at row 1 mysql&gt; insert into t8 values(&quot;dong&quot;, &quot;man&quot;, &quot;money,music&quot;);Query OK, 1 row affected (0.01 sec)mysql&gt; select * from t8;+------+------+-------------+| name | sex | aihao |+------+------+-------------+| dong | man | music,money |+------+------+-------------+1 row in set (0.00 sec) 9.约束条件NULL yes&#x2F;noKey 索引信息default 默认值extra 注释 123456789mysql&gt; desc t8;+-------+-----------------------------------+------+-----+---------+-------+| Field | Type | Null | Key | Default | Extra |+-------+-----------------------------------+------+-----+---------+-------+| name | char(5) | YES | | NULL | || sex | enum(&#x27;man&#x27;,&#x27;girl&#x27;) | YES | | NULL | || aihao | set(&#x27;eat&#x27;,&#x27;game&#x27;,&#x27;music&#x27;,&#x27;money&#x27;) | YES | | NULL | |+-------+-----------------------------------+------+-----+---------+-------+3 rows in set (0.00 sec)","categories":[{"name":"mysql","slug":"mysql","permalink":"https://dbbruce.github.io/categories/mysql/"}],"tags":[]},{"title":"修改密码策略","slug":"mysql/修改密码策略","date":"2017-01-11T03:14:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2017/01/11/mysql/修改密码策略/","link":"","permalink":"https://dbbruce.github.io/2017/01/11/mysql/%E4%BF%AE%E6%94%B9%E5%AF%86%E7%A0%81%E7%AD%96%E7%95%A5/","excerpt":"密码策略 值 简述 0 or LOW 长度要求 1 or MEDIUM 长度；数字；大小写；特殊字符 2 or STRONG 长度；数字；大小写；特殊字符；字典文件","text":"密码策略 值 简述 0 or LOW 长度要求 1 or MEDIUM 长度；数字；大小写；特殊字符 2 or STRONG 长度；数字；大小写；特殊字符；字典文件 查看validate_password_length 密码长度validate_password_policy 密码策略 1234567891011121314151617181920212223mysql&gt; show variables like &quot;%password%&quot;;+----------------------------------------+-----------------+| Variable_name | Value |+----------------------------------------+-----------------+| default_password_lifetime | 0 || disconnect_on_expired_password | ON || log_builtin_as_identified_by_password | OFF || mysql_native_password_proxy_users | OFF || old_passwords | 0 || report_password | || sha256_password_auto_generate_rsa_keys | ON || sha256_password_private_key_path | private_key.pem || sha256_password_proxy_users | OFF || sha256_password_public_key_path | public_key.pem || validate_password_check_user_name | OFF || validate_password_dictionary_file | || validate_password_length | 8 || validate_password_mixed_case_count | 1 || validate_password_number_count | 1 || validate_password_policy | MEDIUM || validate_password_special_char_count | 1 |+----------------------------------------+-----------------+17 rows in set (0.00 sec) 修改策略 命令行，临时生效12set global validate_password_length=6;set global validate_password_policy=0; 修改下密码，测试下12alter user root@&quot;%&quot; identified by &quot;123456&quot;;alter user root@&quot;localhost&quot; identified by &quot;123456&quot;; 永久生效 在mysqld下新增下面2行 1234vim /etc/my.cnf[mysqld]validate_password_length=6validate_password_policy=0","categories":[{"name":"mysql","slug":"mysql","permalink":"https://dbbruce.github.io/categories/mysql/"}],"tags":[]},{"title":"CentOS7安装MySQL","slug":"mysql/CentOS7安装MySQL","date":"2017-01-10T03:14:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2017/01/10/mysql/CentOS7安装MySQL/","link":"","permalink":"https://dbbruce.github.io/2017/01/10/mysql/CentOS7%E5%AE%89%E8%A3%85MySQL/","excerpt":"1. 现在mysql源1wget -i -c http://dev.mysql.com/get/mysql57-community-release-el7-10.noarch.rpm","text":"1. 现在mysql源1wget -i -c http://dev.mysql.com/get/mysql57-community-release-el7-10.noarch.rpm 2.yum安装源1yum -y install mysql57-community-release-el7-10.noarch.rpm 3.安装mysql1yum -y install mysql-community-server 4.导入key1rpm --import https://repo.mysql.com/RPM-GPG-KEY-mysql-2022 不导入，可能报错 123456789101112导入 GPG key 0x5072E1F5: 用户ID : &quot;MySQL Release Engineering &lt;mysql-build@oss.oracle.com&gt;&quot; 指纹 : a4a9 4068 76fc bd3c 4567 70c8 8c71 8d3b 5072 e1f5 软件包 : mysql57-community-release-el7-10.noarch (@/mysql57-community-release-el7-10.noarch) 来自 : /etc/pki/rpm-gpg/RPM-GPG-KEY-mysqlmysql-community-common-5.7.43-1.el7.x86_64.rpm 的公钥尚未安装 失败的软件包是：mysql-community-common-5.7.43-1.el7.x86_64 GPG 密钥配置为：file:///etc/pki/rpm-gpg/RPM-GPG-KEY-mysql 5.启动MySQL12systemctl start mysqld.servicesystemctl enable mysqld.service 查看运行状态 1systemctl status mysqld.service 6.查看安装mysql时，初始密码12grep &quot;password&quot; /var/log/mysqld.log2023-09-22T15:12:52.363569Z 1 [Note] A temporary password is generated for root@localhost: d)RaWyi%i2d6 7.进入数据库，密码使用单引号，密码中的特殊字符无效1mysql -uroot -p&#x27;d)RaWyi%i2d6&#x27; 8.修改密码1ALTER USER &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;Dong@123456&#x27;; 9.开启mysql的远程访问12grant all privileges on *.* to &#x27;root&#x27;@&#x27;%&#x27; identified by &#x27;Dong@123456&#x27; with grant option;flush privileges; 10.为firewalld添加开放端口12firewall-cmd --zone=public --add-port=3306/tcp --permanentfirewall-cmd --reload 11.更改mysql的语言首先重新登录mysql，然后输入status： 12345678910111213141516171819202122mysql&gt; status;--------------mysql Ver 14.14 Distrib 5.7.43, for Linux (x86_64) using EditLine wrapperConnection id: 5Current database:Current user: root@localhostSSL: Not in useCurrent pager: stdoutUsing outfile: &#x27;&#x27;Using delimiter: ;Server version: 5.7.43 MySQL Community Server (GPL)Protocol version: 10Connection: Localhost via UNIX socketServer characterset: latin1 # 这里部署utf8Db characterset: latin1 Client characterset: utf8Conn. characterset: utf8UNIX socket: /var/lib/mysql/mysql.sockUptime: 30 min 18 secThreads: 1 Questions: 14 Slow queries: 0 Opens: 113 Flush tables: 1 Open tables: 106 Queries per second avg: 0.007 进入文件后，新增四行代码： 123456vim /etc/my.cnf[client]default-character-set=utf8character-set-server=utf8collation-server=utf8_general_ci 保存更改后的my.cnf文件后，重启下mysql，然后输入status再次查看 1systemctl restart mysqld.service 1234567891011121314151617181920212223mysql&gt; status--------------mysql Ver 14.14 Distrib 5.7.43, for Linux (x86_64) using EditLine wrapperConnection id: 2Current database:Current user: root@localhostSSL: Not in useCurrent pager: stdoutUsing outfile: &#x27;&#x27;Using delimiter: ;Server version: 5.7.43 MySQL Community Server (GPL)Protocol version: 10Connection: Localhost via UNIX socketServer characterset: utf8Db characterset: utf8Client characterset: utf8Conn. characterset: utf8UNIX socket: /var/lib/mysql/mysql.sockUptime: 10 secThreads: 1 Questions: 5 Slow queries: 0 Opens: 106 Flush tables: 1 Open tables: 99 Queries per second avg: 0.500--------------","categories":[{"name":"mysql","slug":"mysql","permalink":"https://dbbruce.github.io/categories/mysql/"}],"tags":[]},{"title":"01-运维的一些小知识点","slug":"运维/运维的一些小知识点/01-运维的一些小知识点","date":"2000-12-30T04:00:52.000Z","updated":"2023-12-05T03:17:01.000Z","comments":true,"path":"2000/12/30/运维/运维的一些小知识点/01-运维的一些小知识点/","link":"","permalink":"https://dbbruce.github.io/2000/12/30/%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E7%9F%A5%E8%AF%86%E7%82%B9/01-%E8%BF%90%E7%BB%B4%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E7%9F%A5%E8%AF%86%E7%82%B9/","excerpt":"","text":"运维一些技巧和常识查询你的公开的IPhttps://zh-hans.ipshu.com/ 云服务的一些优惠的信息https://abcvps.cn/","categories":[{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"运维一些技巧和常识","slug":"运维/运维一些技巧和常识","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E4%B8%80%E4%BA%9B%E6%8A%80%E5%B7%A7%E5%92%8C%E5%B8%B8%E8%AF%86/"}],"tags":[]}],"categories":[{"name":"项目","slug":"项目","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/"},{"name":"HCM教程","slug":"项目/HCM教程","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/HCM%E6%95%99%E7%A8%8B/"},{"name":"每月概要","slug":"每月概要","permalink":"https://dbbruce.github.io/categories/%E6%AF%8F%E6%9C%88%E6%A6%82%E8%A6%81/"},{"name":"2025","slug":"每月概要/2025","permalink":"https://dbbruce.github.io/categories/%E6%AF%8F%E6%9C%88%E6%A6%82%E8%A6%81/2025/"},{"name":"读书笔记","slug":"读书笔记","permalink":"https://dbbruce.github.io/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"},{"name":"爬虫类","slug":"爬虫类","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/"},{"name":"基础","slug":"爬虫类/基础","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E5%9F%BA%E7%A1%80/"},{"name":"2023","slug":"每月概要/2023","permalink":"https://dbbruce.github.io/categories/%E6%AF%8F%E6%9C%88%E6%A6%82%E8%A6%81/2023/"},{"name":"Python基础","slug":"Python基础","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/"},{"name":"基础","slug":"Python基础/基础","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/%E5%9F%BA%E7%A1%80/"},{"name":"odoo","slug":"odoo","permalink":"https://dbbruce.github.io/categories/odoo/"},{"name":"基础","slug":"odoo/基础","permalink":"https://dbbruce.github.io/categories/odoo/%E5%9F%BA%E7%A1%80/"},{"name":"医药公司ERP","slug":"项目/医药公司ERP","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/"},{"name":"业务","slug":"项目/医药公司ERP/业务","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/%E4%B8%9A%E5%8A%A1/"},{"name":"基础","slug":"项目/医药公司ERP/基础","permalink":"https://dbbruce.github.io/categories/%E9%A1%B9%E7%9B%AE/%E5%8C%BB%E8%8D%AF%E5%85%AC%E5%8F%B8ERP/%E5%9F%BA%E7%A1%80/"},{"name":"异步编程","slug":"Python基础/异步编程","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/"},{"name":"网络","slug":"网络","permalink":"https://dbbruce.github.io/categories/%E7%BD%91%E7%BB%9C/"},{"name":"异常","slug":"网络/异常","permalink":"https://dbbruce.github.io/categories/%E7%BD%91%E7%BB%9C/%E5%BC%82%E5%B8%B8/"},{"name":"包方法","slug":"Python基础/包方法","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/%E5%8C%85%E6%96%B9%E6%B3%95/"},{"name":"反爬","slug":"爬虫类/反爬","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E5%8F%8D%E7%88%AC/"},{"name":"编码","slug":"爬虫类/编码","permalink":"https://dbbruce.github.io/categories/%E7%88%AC%E8%99%AB%E7%B1%BB/%E7%BC%96%E7%A0%81/"},{"name":"面试","slug":"面试","permalink":"https://dbbruce.github.io/categories/%E9%9D%A2%E8%AF%95/"},{"name":"题","slug":"面试/题","permalink":"https://dbbruce.github.io/categories/%E9%9D%A2%E8%AF%95/%E9%A2%98/"},{"name":"运维","slug":"运维","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"K8S","slug":"运维/K8S","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/"},{"name":"项目汇总","slug":"运维/K8S/项目汇总","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E9%A1%B9%E7%9B%AE%E6%B1%87%E6%80%BB/"},{"name":"基础","slug":"运维/K8S/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E5%9F%BA%E7%A1%80/"},{"name":"zabbix","slug":"运维/zabbix","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/"},{"name":"5.0LTS","slug":"运维/zabbix/5-0LTS","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/zabbix/5-0LTS/"},{"name":"抓包工具","slug":"运维/抓包工具","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/%E6%8A%93%E5%8C%85%E5%B7%A5%E5%85%B7/"},{"name":"git","slug":"git","permalink":"https://dbbruce.github.io/categories/git/"},{"name":"基础","slug":"git/基础","permalink":"https://dbbruce.github.io/categories/git/%E5%9F%BA%E7%A1%80/"},{"name":"GO语言","slug":"GO语言","permalink":"https://dbbruce.github.io/categories/GO%E8%AF%AD%E8%A8%80/"},{"name":"基础","slug":"GO语言/基础","permalink":"https://dbbruce.github.io/categories/GO%E8%AF%AD%E8%A8%80/%E5%9F%BA%E7%A1%80/"},{"name":"Java生态","slug":"运维/Java生态","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/Java%E7%94%9F%E6%80%81/"},{"name":"Git","slug":"运维/Git","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/Git/"},{"name":"memcached","slug":"运维/memcached","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/memcached/"},{"name":"docker","slug":"运维/docker","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/"},{"name":"错误集锦","slug":"运维/docker/错误集锦","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/%E9%94%99%E8%AF%AF%E9%9B%86%E9%94%A6/"},{"name":"Django","slug":"Python基础/Django","permalink":"https://dbbruce.github.io/categories/Python%E5%9F%BA%E7%A1%80/Django/"},{"name":"grafana","slug":"运维/grafana","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/grafana/"},{"name":"mysql","slug":"mysql","permalink":"https://dbbruce.github.io/categories/mysql/"},{"name":"linux云计算基础教程","slug":"运维/linux云计算基础教程","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/linux%E4%BA%91%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"},{"name":"nginx","slug":"运维/nginx","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/nginx/"},{"name":"基础","slug":"运维/docker/基础","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/docker/%E5%9F%BA%E7%A1%80/"},{"name":"错误","slug":"运维/K8S/错误","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/K8S/%E9%94%99%E8%AF%AF/"},{"name":"问题处理","slug":"运维/问题处理","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/"},{"name":"常用工具","slug":"运维/常用工具","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/"},{"name":"redis","slug":"redis","permalink":"https://dbbruce.github.io/categories/redis/"},{"name":"运维一些技巧和常识","slug":"运维/运维一些技巧和常识","permalink":"https://dbbruce.github.io/categories/%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E4%B8%80%E4%BA%9B%E6%8A%80%E5%B7%A7%E5%92%8C%E5%B8%B8%E8%AF%86/"}],"tags":[]}